<!DOCTYPE html>
<html lang="th">

<head>
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HENG MONEY - เฮงมันนี่ 4289</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css"
        integrity="sha512-MQXduO8IQnJVq1qmySpN87QQkiR1bZHtorbJBD0tzy7/0U9+YIC93QWHeGTEoojMVHWWNkoCp8V6OzVSYrX0oQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/themes/dark.min.css"
        integrity="sha512-9j8LE+fuBZgXOsSyiXCw0LmM4LSLIo94AYem4pQzyqlbw5wC4qK2ytHjOLy9pGH3DbvoXawLPuiVfr8gXOKXWw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.datatables.net/v/bs5/moment-2.29.4/dt-2.3.2/date-1.5.6/r-3.0.5/datatables.min.css"
        rel="stylesheet" integrity="sha384-g0oloLK74xcQRricIumqtIsduu+rbd99qhw8i5tH9wmlmVs+qbGMfVvC/ry8OrG0"
        crossorigin="anonymous">
    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif !important;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .gold-title {
            color: #d4af37;
            letter-spacing: 2px;
            /* text-shadow: 0 2px 8px #000; */
            font-family: 'Merriweather', 'Noto Sans Thai', sans-serif !important;
        }

        body {
            background: #f8f9fa;
            min-height: 100vh;
        }

        .gold-form-card {
            background: #fff;
            border: 2px solid #d4af37;
            color: #232526;
        }

        .logo-img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 16px;
            box-shadow: 0 4px 16px #d4af3744;
            background: #fff;
            padding: 12px;
        }

        .gold-btn {
            background: linear-gradient(90deg, #d4af37 0%, #fff 100%);
            color: #232526;
            border: none;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px #d4af3744;
            transition: background 0.3s;
        }

        .gold-btn:hover {
            background: linear-gradient(90deg, #fff 0%, #d4af37 100%);
            color: #d4af37;
        }

        label.form-label {
            color: #d4af37;
            font-weight: 500;
        }

        .form-control,
        .form-select {
            border: 1.5px solid #d4af37;
            background: #fff;
            color: #232526;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #d4af37;
            box-shadow: 0 0 0 2px #d4af3722;
            background: #fff;
            color: #232526;
        }

        /* SweetAlert2 gold/dark custom styles */
        .swal2-gold-popup {
            border: 2px solid #d4af37 !important;
            border-radius: 18px !important;
            font-family: 'Noto Sans Thai', 'Merriweather', sans-serif !important;
            box-shadow: 0 4px 16px #d4af3744 !important;
            background: #fff !important;
            color: #232526 !important;
        }

        .swal2-gold-title {
            color: #d4af37 !important;
            font-family: 'Merriweather', 'Noto Sans Thai', sans-serif !important;
            text-shadow: 0 2px 8px #fff !important;
        }

        .swal2-gold-confirm {
            background: linear-gradient(90deg, #d4af37 0%, #fff 100%) !important;
            color: #232526 !important;
            border: none !important;
            font-weight: bold !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 8px #d4af3744 !important;
        }

        .swal2-gold-confirm:hover {
            background: linear-gradient(90deg, #fff 0%, #d4af37 100%) !important;
            color: #d4af37 !important;
        }

        .swal2-gold-cancel {
            background: #fff !important;
            color: #d4af37 !important;
            border: 1.5px solid #d4af37 !important;
            border-radius: 8px !important;
        }

        .swal2-gold-html {
            color: #232526 !important;
        }

        .swal2-gold-input {
            background: #fff !important;
            color: #232526 !important;
            border: 1.5px solid #d4af37 !important;
            border-radius: 8px !important;
        }
    </style>
</head>

<body>
    <div class="text-center my-4">
        <img src="https://img5.pic.in.th/file/secure-sv1/b6ea3192-e74b-4483-a7a5-ac5f86a81191.png" alt="โลโก้"
            class="logo-img mb-2">
        <h2 class="fw-bold gold-title mt-3">HENG MONEY 4289</h2>
    </div>
    <section id="main-sec" class="container-fluid my-4">
        <div class="row">
            <div class="col-12">
                <!-- กรุณาคลิกที่สถานะ เพื่อยกเลิก -->
                <p class="mb-3">คลิกที่ปุ่ม "สำเร็จ" เพื่อยกเลิกข้อมูลการซื้อ</p>
            </div>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="goldTable" class="table table-striped table-bordered table-hover" style="width: 100%;">
                    </table>
                </div>
            </div>
        </div>
    </section>
    <!-- Modal for gold table -->
    <div class="modal fade" id="addSellDataModal" tabindex="-1" aria-labelledby="addSellDataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content gold-form-card" style="background: #fff; border: 2px solid #d4af37; color: #232526;">
                <div class="modal-header border-0 bg-light">
                    <h3 class="modal-title gold-title w-100 text-center" id="addSellDataModalLabel">บันทึกซื้อ</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background: #fff; color: #232526;">
                    <form id="goldForm" onsubmit="submitForm(event)">
                        <div class="mb-3">
                            <label for="date" class="form-label text-dark">วันที่ซื้อ</label>
                            <!-- <div class="input-group">
                                <input type="text" class="form-control" id="date" name="date" placeholder="เลือกวันที่"
                                    required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                <button class="btn gold-btn" type="button" id="calendarBtn">
                                    <i class="bi bi-calendar"></i>
                                </button>
                            </div> -->
                            <input type="text" class="form-control bg-primary-subtle" id="date" name="date" placeholder="เลือกวันที่"
                                required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;" readonly>
                        </div>

                        <div class="mb-3">
                            <label for="category" class="form-label text-dark">หมวดหมู่</label>
                            <select class="form-select" id="category" name="category" required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                <option value="" disabled selected></option>
                                <? lists.category.forEach(function (item) { ?>
                                <option value="<?= item ?>">
                                    <?= item ?>
                                </option>
                                <? }) ?>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="product" class="form-label text-dark">สินค้า (คีย์%)</label>
                            <input type="number" class="form-control" id="product" name="product" placeholder="เช่น ทอง71"
                                required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;" min="0" max="100" step="0.1" onkeyup="handlePercentage(this)">
                        </div>
                        <div class="mb-3">
                            <label for="weight" class="form-label text-dark">น้ำหนัก (กรัม)</label>
                            <input type="number" class="form-control" id="weight" name="weight" min="0" step="0.01"
                                required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <div class="mb-3">
                            <label for="price" class="form-label text-dark">ยอดซื้อ (บาท)</label>
                            <input type="number" class="form-control" id="price" name="price" min="0" step="0.01"
                                required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <div class="mb-3">
                            <label for="bank" class="form-label text-dark">ธนาคาร</label>
                            <select class="form-select" id="bank" name="bank" required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                <option value="" disabled selected></option>
                                <? lists.bank.forEach(function (item) { ?>
                                <option value="<?= item ?>">
                                    <?= item ?>
                                </option>
                                <? }) ?>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="staff" class="form-label text-dark">พนักงาน</label>
                            <select class="form-select" id="staff" name="staff" required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                <option value="" disabled selected></option>
                                <? lists.staff.forEach(function (item) { ?>
                                <option value="<?= item ?>">
                                    <?= item ?>
                                </option>
                                <? }) ?>
                            </select>
                        </div>
                        <button type="submit" class="btn gold-btn w-100 py-2 fw-bold">บันทึกข้อมูล</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            moment.locale('th');
            // flatpickr("#date", {
            //     locale: "th",
            //     dateFormat: "Y-m-d",
            //     theme: "light",
            //     allowInput: true,
            //     altFormat: "d/m/Y",
            //     altInput: true,
            // });
            // $("#calendarBtn").on("click", function () {
            //     $("#date").flatpickr().open();
            // });
            $('#date').val(moment().format('DD/MM/YYYY')).data('date', moment().format('YYYY-MM-DD'));
            initDataTable();
            $('#addSellDataModal').on('hidden.bs.modal', function () {
                $('#goldForm')[0].reset();
                $('#date').val(moment().format('DD/MM/YYYY')).data('date', moment().format('YYYY-MM-DD'));
            });
        });

        function handlePercentage(input) {
            let value = parseFloat(input.value);
            if(value > 100){
                value = (value / 10).toFixed(1);
                input.value = value;
            }
        }
        function initDataTable() {
            $('#goldTable').DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                scrollX: true,
                dom: "<'row justify-content-between'<'col-md-auto buttons-sec'><'col-md-auto'f>>" +
                    "<'row mt-2'<'col-12't>>" +
                    "<'row justify-content-between mt-2'<'col-md-auto'i><'col-md-auto'p>>",
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/Thai.json'
                },
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/th.json'
                },
                pageLength: 30,
                ajax: function (data, callback, settings) {
                    NProgress.start();
                    try {
                        google.script.run.withSuccessHandler(function (response) {
                            response = JSON.parse(response);
                            console.log(response);
                            NProgress.done();
                            callback({
                                data: response,
                                recordsTotal: response.length,
                                recordsFiltered: response.length
                            });
                        }).withFailureHandler(function (error) {
                            NProgress.done();
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: error.message || error,
                            });
                        }).getSellData();
                    } catch {
                        NProgress.done();
                        callback({
                            data: [],
                            recordsTotal: 0,
                            recordsFiltered: 0
                        })
                    }

                },
                columns: [
                    {
                        data: null,
                        title: '#',
                        orderable: false,
                        searchable: false,
                        className: 'text-center text-nowrap',
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        data: 'date',
                        title: 'วันที่',
                        render: function (data) {
                            return moment(data).format('DD/MM/YYYY');
                        }
                    },
                    {
                        data: 'date',
                        title: 'เวลา',
                        render: function (data) {
                            return moment(data).format('HH:mm');
                        }
                    },
                    {
                        data: 'category',
                        title: 'หมวดหมู่',
                        visible: false,
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'product',
                        title: 'สินค้า (คีย์%)',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'weight',
                        title: 'น้ำหนัก (กรัม)',
                        render: function (data) {
                            return data ? parseFloat(data).toFixed(2) : '0.00';
                        }
                    },
                    {
                        data: 'price',
                        title: 'ยอดซื้อ (บาท)',
                        render: function (data) {
                            return data ? parseInt(data).toLocaleString('th-TH') : '0';
                        }
                    },
                    {
                        data: 'bank',
                        title: 'ธนาคาร',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'seller',
                        title: 'พนักงาน',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'status',
                        title: 'สถานะ',
                        render: function (data) {
                            if (data === 'ยกเลิก') {
                                return `<button type="button" class="w-100 btn btn-sm btn-secondary text-nowrap" style="pointer-events: none;">
                                            <i class="bi bi-x-circle-fill"></i> ยกเลิก
                                        </button>`;
                            } else if (data === 'เสร็จสิ้น') {
                                return '<button type="button" class="w-100 btn btn-sm btn-success text-nowrap" onclick="cancelRow(this);"><i class="bi bi-check-circle-fill"></i> สำเร็จ</button>';
                            } else {
                                return '<button type="button" class="w-100 btn btn-sm btn-secondary text-nowrap" style="pointer-events: none;"><i class="bi bi-question-circle-fill"></i> ไม่ระบุ</button>';
                            }
                        }
                    },
                    {
                        data: 'billNo',
                        title: 'หมายเลขบิล',
                        visible: false,
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'monthYear',
                        title: 'เดือน/ปี',
                        visible: false,
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'uuid',
                        title: 'เลขอ้างอิง',
                        className: 'text-nowrap none text-black-50',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    }

                ],
                createdRow: function (row, data, dataIndex) {
                    $(row).addClass('text-nowrap');
                    if (data.status === 'ยกเลิก') {
                        $(row).find('td').css('font-weight', 300).css('color', '#ff0000');
                    }
                },
                initComplete: function (settings, json) {
                    NProgress.done();
                    $('.buttons-sec').html(`
                        <button class="btn gold-btn btn-sm w-100" data-bs-toggle="modal" data-bs-target="#addSellDataModal">
                            <i class="bi bi-plus-circle-fill"></i> เพิ่มข้อมูลการซื้อ
                        </button>
                    `);
                },
                columnDefs: [
                    {
                        targets: '_all',
                        className: 'dt-head-center dt-head-nowrap text-center dt-body-center all',
                    }
                ]
            });
        }

        function submitForm(e) {
            e.preventDefault();
            const form = document.getElementById('goldForm');
            const data = {
                date: $('#date').data('date') || moment().format('YYYY-MM-DD'),
                category: form.category.value,
                product: form.product.value,
                weight: form.weight.value,
                price: form.price.value,
                bank: form.bank.value,
                seller: form.staff.value
            };
            NProgress.start();
            goldSwal({
                title: 'กำลังบันทึกข้อมูล...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            google.script.run.withSuccessHandler(function () {
                NProgress.done();
                reloadTable();
                goldSwal({
                    icon: 'success',
                    title: 'บันทึกข้อมูลสำเร็จ',
                    showConfirmButton: false,
                    timer: 1500
                });
                $('#addSellDataModal').modal('hide');
            }).withFailureHandler(function (error) {
                NProgress.done();
                goldSwal({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    html: error.message || error,
                });
            }).saveSellData(data);
        }

        function cancelRow(button) {
            const row = $(button).closest('tr');
            const data = $('#goldTable').DataTable().row(row).data();
            if (!data) return;

            goldSwal({
                title: 'ยืนยันการยกเลิก',
                html: `
                    <div class="container-fluid">
                        <p>คุณต้องการยกเลิกข้อมูลนี้ใช่หรือไม่?</p>
                        <table class="table table-bordered table-sm mb-4 table-light" style="border-color:#d4af37;">
                            <tbody>
                                <tr>
                                    <th style="width:120px;color:#d4af37;">วันที่</th>
                                    <td>${moment(data.date).format('DD/MM/YYYY')}</td>
                                </tr>
                                <tr>
                                    <th style="color:#d4af37;">สินค้า</th>
                                    <td>${data.product}</td>
                                </tr>
                                <tr>
                                    <th style="color:#d4af37;">น้ำหนัก</th>
                                    <td>${parseFloat(data.weight).toFixed(2)} กรัม</td>
                                </tr>
                                <tr>
                                    <th style="color:#d4af37;">ยอดซื้อ</th>
                                    <td>${parseInt(data.price).toLocaleString('th-TH')} บาท</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="form-group">
                            <label for="cancelStaff" class="form-label">กรุณากรอกชื่อพนักงานที่ยกเลิก</label>
                            <select id="cancelStaff" class="form-select text-center bg-light text-dark" required>
                                <option value="" disabled selected>เลือกชื่อพนักงานที่ยกเลิก</option>
                                <? lists.staff.forEach(function (item) { ?>
                                    <option value="<?!= item ?>"><?!= item ?></option>
                                <? }) ?>
                            </select>
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ปิด',
                showLoadingOnConfirm: true,
                preConfirm: () => {
                    const staff = Swal.getPopup().querySelector('#cancelStaff').value;
                    if (!staff) {
                        Swal.showValidationMessage('กรุณากรอกชื่อพนักงานที่ยกเลิก');
                    }
                    return staff;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    NProgress.start();
                    goldSwal({
                        title: 'กำลังยกเลิกข้อมูล...',
                        text: 'กรุณารอสักครู่',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    google.script.run.withSuccessHandler(function (res) {
                        NProgress.done();
                        res = JSON.parse(res);
                        if (!res.success) {
                            goldSwal({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                html: res.message || 'ไม่สามารถยกเลิกข้อมูลได้',
                            });
                            return;
                        }
                        reloadTable();
                        goldSwal({
                            icon: 'success',
                            title: 'ยกเลิกข้อมูลสำเร็จ',
                            title: res.message || 'ข้อมูลถูกยกเลิกเรียบร้อยแล้ว',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    }).withFailureHandler(function (error) {
                        NProgress.done();
                        goldSwal({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            html: error.message || error,
                        });
                    }).cancelSellData(data.uuid, result.value);
                }
            });
        }

        function reloadTable() {
            if (DataTable.isDataTable('#goldTable')) {
                $('#goldTable').DataTable().ajax.reload();
            } else {
                initDataTable();
            }
        }

    </script>
    <script>
        // Helper for gold-styled SweetAlert2
        const goldSwalOptions = {
            background: '#fff',
            color: '#232526',
            customClass: {
                popup: 'swal2-gold-popup',
                confirmButton: 'swal2-gold-confirm',
                cancelButton: 'swal2-gold-cancel',
                title: 'swal2-gold-title',
                htmlContainer: 'swal2-gold-html',
                input: 'swal2-gold-input',
            },
        };
        function goldSwal(options) {
            return Swal.fire(Object.assign({}, goldSwalOptions, options));
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/locale/th.js"></script>
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"
        integrity="sha512-K/oyQtMXpxI4+K0W7H25UopjM8pzq0yrVdFdG21Fh5dBe91I40pDd9A4lzNlHPHBIP2cwZuoxaUSX0GJSObvGA=="
        crossorigin=" anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.11/l10n/th.min.js"
        integrity="sha512-0XU8EDwsRqhnSukLw3KIQoRvFJs3SGlsoLpX1RpRAjmYrc7w56F6J5pwJ0p0p+v23qg14VPRQe9OhPRfbhVzdw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.datatables.net/v/bs5/moment-2.29.4/dt-2.3.2/date-1.5.6/r-3.0.5/datatables.min.js"
        integrity="sha384-F3T/anccpuD+tGZ5UGTEAOJtJLvpPX297Nw0Hdszm40Bf3AxlRa135uEORYCRHpv"
        crossorigin="anonymous"></script>
    <script>
        AOS.init();
        document.addEventListener("DOMContentLoaded", function () {
            NProgress.start();
            NProgress.inc()
        });
        window.addEventListener("load", function () {
            NProgress.done();
        });

    </script>

</body>

</html>