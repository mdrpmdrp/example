<!DOCTYPE html>
<html lang="th">

<head>
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HENG MONEY - เฮงมันนี่ 4289</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css"
        integrity="sha512-MQXduO8IQnJVq1qmySpN87QQkiR1bZHtorbJBD0tzy7/0U9+YIC93QWHeGTEoojMVHWWNkoCp8V6OzVSYrX0oQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/themes/dark.min.css"
        integrity="sha512-9j8LE+fuBZgXOsSyiXCw0LmM4LSLIo94AYem4pQzyqlbw5wC4qK2ytHjOLy9pGH3DbvoXawLPuiVfr8gXOKXWw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link
        href="https://cdn.datatables.net/v/bs5/moment-2.29.4/jszip-3.10.1/dt-2.3.2/b-3.2.4/b-html5-3.2.4/b-print-3.2.4/date-1.5.6/fh-4.0.3/r-3.0.5/sl-3.0.1/datatables.min.css"
        rel="stylesheet" integrity="sha384-XcE5dWMyuiPqvfsce+3Zmw+ioxmDKgsQcuGaKM5Uq907HUoW7g+JefVqJFyJep9X"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif !important;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .gold-title {
            color: #d4af37;
            letter-spacing: 2px;
            /* text-shadow: 0 2px 8px #000; */
            font-family: 'Merriweather', 'Noto Sans Thai', sans-serif !important;
        }

        body {
            background: #f8f9fa;
            min-height: 100vh;
        }

        .gold-form-card {
            background: #fff;
            border: 2px solid #d4af37;
            color: #232526;
        }

        .logo-img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 16px;
            box-shadow: 0 4px 16px #d4af3744;
            background: #fff;
            padding: 12px;
        }

        .gold-btn {
            background: linear-gradient(90deg, #d4af37 0%, #fff 100%);
            color: #232526;
            border: none;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px #d4af3744;
            transition: background 0.3s;
        }

        .gold-btn:hover {
            background: linear-gradient(90deg, #fff 0%, #d4af37 100%);
            color: #d4af37;
        }

        label.form-label {
            color: #d4af37;
            font-weight: 500;
        }

        .form-control,
        .form-select {
            border: 1.5px solid #d4af37;
            background: #fff;
            color: #232526;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #d4af37;
            box-shadow: 0 0 0 2px #d4af3722;
            background: #fff;
            color: #232526;
        }

        /* SweetAlert2 gold/dark custom styles */
        .swal2-gold-popup {
            border: 2px solid #d4af37 !important;
            border-radius: 18px !important;
            font-family: 'Noto Sans Thai', 'Merriweather', sans-serif !important;
            box-shadow: 0 4px 16px #d4af3744 !important;
            background: #fff !important;
            color: #232526 !important;
        }

        .swal2-gold-title {
            color: #d4af37 !important;
            font-family: 'Merriweather', 'Noto Sans Thai', sans-serif !important;
            text-shadow: 0 2px 8px #fff !important;
        }

        .swal2-gold-confirm {
            background: linear-gradient(90deg, #d4af37 0%, #fff 100%) !important;
            color: #232526 !important;
            border: none !important;
            font-weight: bold !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 8px #d4af3744 !important;
        }

        .swal2-gold-confirm:hover {
            background: linear-gradient(90deg, #fff 0%, #d4af37 100%) !important;
            color: #d4af37 !important;
        }

        .swal2-gold-cancel {
            background: #fff !important;
            color: #d4af37 !important;
            border: 1.5px solid #d4af37 !important;
            border-radius: 8px !important;
        }

        .swal2-gold-html {
            color: #232526 !important;
        }

        .swal2-gold-input {
            background: #fff !important;
            color: #232526 !important;
            border: 1.5px solid #d4af37 !important;
            border-radius: 8px !important;
        }

        .simple-popout {
            border-radius: 6px;
            font-size: 1.05rem;
        }

        .simple-popout:hover,
        .simple-popout:focus {

            color: #b8860b !important;
            text-decoration: none !important;
            transform: scale(1.05);
        }

        table.datatable {

            td,
            th {
                vertical-align: middle;
            }
        }

        .nav-link.active {
            background: rgba(212, 175, 55, 0) !important;
            color: #b8860b !important;
        }

        .dropdown-item.active {
            background: rgba(212, 175, 55, 0) !important;
            color: #b8860b !important;
        }

        /* Dashboard Cards Styles */
        .dashboard-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: 2px solid #d4af37;
            border-radius: 16px;
            box-shadow: 0 4px 16px #d4af3722;
            transition: all 0.3s ease;
            height: 100%;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px #d4af3744;
        }

        .dashboard-card .card-body {
            padding: 1.5rem;
        }

        .dashboard-card-icon {
            font-size: 2.5rem;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }

        .dashboard-card-title {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .dashboard-card-value {
            color: #232526;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0;
        }

        .dashboard-card-change {
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .dashboard-card-positive {
            color: #28a745;
        }

        .dashboard-card-negative {
            color: #dc3545;
        }

        .dashboard-card-neutral {
            color: #6c757d;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #printArea,
            #printArea * {
                visibility: visible;
            }

            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .table {
                page-break-inside: auto;
            }

            .table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            .account-balance-report {
                page-break-before: auto;
                page-break-after: auto;
                margin-bottom: 30px !important;
            }

            .gold-table-report,
            .transaction-income-report,
            .transaction-expense-report {
                page-break-before: auto;
                page-break-after: auto;
                margin-bottom: 30px !important;
            }

            /* Only show tfoot on the last page when printing */
            tfoot {
                display: table-footer-group;
            }

            @media print {
                tfoot {
                    display: table-footer-group;
                }
            }

            th {
                background-color: #f8f9fa !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .bg-primary {
                background-color: #0d6efd !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .text-white {
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .text-success {
                color: #198754 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .text-danger {
                color: #dc3545 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .text-warning {
                color: #fd7e14 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        /* Hide checkbox when icon is present */
        td.select-checkbox:has(.bi-ban-fill)::before,
        td.select-checkbox:has(.bi-ban-fill)::after {
            display: none !important;
        }
    </style>

</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm mb-3">
            <div class="container-fluid">
                <a class="navbar-brand gold-title fw-bold" href="#">HENG MONEY</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#goldNavbar"
                    aria-controls="goldNavbar" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="goldNavbar">
                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0 gap-2 d-none">
                        <li class="nav-item">
                            <button class="nav-link px-3 fw-semibold text-secondary simple-popout active"
                                id="showSellSectionBtn">
                                บันทึกซื้อ
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link px-3 fw-semibold text-secondary simple-popout"
                                id="showTransactionSectionBtn">
                                บันทึกรับจ่าย
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link px-3 fw-semibold text-secondary simple-popout"
                                id="showMeltSectionBtn">
                                รายการบิลหลอม
                            </button>
                        </li>
                        <i class="nav-item admin-only d-none">
                            <button class="nav-link px-3 fw-semibold text-secondary simple-popout"
                                id="showSellBillSectionBtn">
                                รายการบิลขาย
                            </button>
                        </i>
                        <li class="nav-item dropdown">
                            <button class="nav-link px-3 fw-semibold text-secondary simple-popout dropdown-toggle"
                                id="reportsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                รายงาน
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="reportsDropdown">
                                <li>
                                    <button class="dropdown-item nav-link px-3 fw-semibold text-secondary simple-popout"
                                        id="createSummaryReportBtn">
                                        <i class="bi bi-file-text me-2"></i>สรุปรายงานประจำวัน
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item nav-link px-3 fw-semibold text-secondary simple-popout"
                                        id="showBuySummarySectionBtn">
                                        <i class="bi bi-graph-up me-2"></i>สรุปจำนวนบิลซื้อ
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item nav-link px-3 fw-semibold text-secondary simple-popout"
                                        id="createSummaryMeltBtn">
                                        <i class="bi bi-fire me-2"></i>สรุปสต็อกในร้าน
                                    </button>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item d-none" id="logoutNavItem">
                            <button class="nav-link px-3 fw-semibold text-secondary simple-popout" id="logoutBtn">
                                ออกจากระบบ
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container-fluid my-4" id="dashboard-section" style="display: none;">
            <div class="row">
                <!-- Dashboard Cards -->
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="gold-title mb-0">สรุปยอดเงิน</h5>
                        <button class="btn btn-outline-warning btn-sm" onclick="refreshDashboard()"
                            title="รีเฟรชข้อมูล">
                            <i class="bi bi-arrow-clockwise"></i> รีเฟรช
                        </button>
                    </div>
                    <div class="row g-3" id="dashboard-cards">
                        <!-- Loading state -->
                        <div class="col-12 text-center">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">กำลังโหลด...</span>
                            </div>
                            <p class="mt-2 text-muted">กำลังโหลดข้อมูล Dashboard...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <section id="login-section" class="container my-5" style="max-width: 400px;">
        <div class="card gold-form-card shadow  rounded-4">
            <div class="card-body">
                <h3 class="gold-title text-center mb-4">เข้าสู่ระบบ</h3>
                <form id="loginForm" autocomplete="off">
                    <div class="mb-3">
                        <label for="loginUser" class="form-label text-dark">ชื่อผู้ใช้</label>
                        <input type="text" class="form-control" id="loginUser" name="loginUser" required autofocus>
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label text-dark">รหัสผ่าน</label>
                        <input type="password" class="form-control" id="loginPassword" name="loginPassword" required>
                    </div>
                    <button type="submit" class="btn gold-btn w-100 py-2 fw-bold border">เข้าสู่ระบบ</button>
                </form>
            </div>
        </div>
    </section>
    <section id="main-sec" class="container-fluid my-4" style="display: none;">
        <div class="row">
            <div class="col-md-6 text-start">
                <!-- User Info Display -->
                <div id="userInfo" class="mb-3">
                    <span class="fw-bold text-dark">
                        <i class="bi bi-person-circle me-1"></i>
                        <span class="userName"></span>
                    </span>
                    <span class="mx-2 text-secondary">|</span>
                    <span class="fw-semibold text-primary">
                        <i class="bi bi-shop me-1"></i>
                        <span class="userBranch"></span>
                    </span>
                    <span class="mx-2 text-secondary">|</span>
                    <span class="fw-semibold text-warning">
                        <i class="bi bi-award me-1"></i>
                        <span class="userRole"></span>
                    </span>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <!-- กรุณาคลิกที่สถานะ เพื่อยกเลิก -->
                <p class="mb-3">คลิกที่ปุ่ม "สำเร็จ" เพื่อยกเลิกข้อมูลการซื้อ</p>
            </div>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="goldTable" class="table table-striped table-bordered table-hover" style="width: 100%;">
                    </table>
                </div>
            </div>
        </div>
    </section>
    <section id="transaction-sec" class="container-fluid my-4" style="display: none;">
        <div class="row">
            <div class="col-md-6 text-start">
                <!-- User Info Display -->
                <div id="userInfo" class="mb-3">
                    <span class="fw-bold text-dark">
                        <i class="bi bi-person-circle me-1"></i>
                        <span class="userName"></span>
                    </span>
                    <span class="mx-2 text-secondary">|</span>
                    <span class="fw-semibold text-primary">
                        <i class="bi bi-shop me-1"></i>
                        <span class="userBranch"></span>
                    </span>
                    <span class="mx-2 text-secondary">|</span>
                    <span class="fw-semibold text-warning">
                        <i class="bi bi-award me-1"></i>
                        <span class="userRole"></span>
                    </span>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <!-- กรุณาคลิกที่สถานะ เพื่อยกเลิก -->
                <p class="mb-3">คลิกที่ปุ่ม "สำเร็จ" เพื่อยกเลิกข้อมูลการซื้อ</p>
            </div>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="transactionTable" class="table table-striped table-bordered table-hover"
                        style="width: 100%;">
                    </table>
                </div>
            </div>
        </div>
    </section>
    <section id="melt-sec" class="container-fluid my-4" style="display: none;">
        <div class="row">
            <div class="col-md-6 text-start">
                <!-- User Info Display -->
                <div id="userInfo" class="mb-3">
                    <span class="fw-bold text-dark">
                        <i class="bi bi-person-circle me-1"></i>
                        <span class="userName"></span>
                    </span>
                    <span class="mx-2 text-secondary">|</span>
                    <span class="fw-semibold text-primary">
                        <i class="bi bi-shop me-1"></i>
                        <span class="userBranch"></span>
                    </span>
                    <span class="mx-2 text-secondary">|</span>
                    <span class="fw-semibold text-warning">
                        <i class="bi bi-award me-1"></i>
                        <span class="userRole"></span>
                    </span>
                </div>
            </div>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="meltTable" class="table table-striped table-bordered table-hover" style="width: 100%;">
                    </table>
                </div>
            </div>
        </div>
    </section>
    <section id="sell-bill-sec" class="container-fluid my-4" style="display: none;">
        <div class="row">
            <div class="col-md-6 text-start">
                <!-- User Info Display -->
                <div id="userInfo" class="mb-3">
                    <span class="fw-bold text-dark">
                        <i class="bi bi-person-circle me-1"></i>
                        <span class="userName"></span>
                    </span>
                    <span class="mx-2 text-secondary">|</span>
                    <span class="fw-semibold text-primary">
                        <i class="bi bi-shop me-1"></i>
                        <span class="userBranch"></span>
                    </span>
                    <span class="mx-2 text-secondary">|</span>
                    <span class="fw-semibold text-warning">
                        <i class="bi bi-award me-1"></i>
                        <span class="userRole"></span>
                    </span>
                </div>
            </div>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="sellBillTable" class="table table-striped table-bordered table-hover"
                        style="width: 100%;">
                    </table>
                </div>
            </div>
        </div>
    </section>
    <section id="buy-summary-sec" class="container-fluid my-4" style="display: none;">
        <div class="row">
            <div class="col-12">
                <h3 class="gold-title text-center mb-4">สรุปจำนวนบิลซื้อ <span id="bill-branch"></span></h3>
                <div class="table-responsive">
                    <table id="buySummaryTable" class="table table-striped table-bordered table-hover"
                        style="width: 100%;">
                        <thead>
                            <!-- Data will be inserted here -->
                        </thead>
                        <tbody id="buySummaryTableBody">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
    <!-- Modal for gold table -->
    <div class="modal fade" id="addSellDataModal" tabindex="-1" aria-labelledby="addSellDataModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content gold-form-card"
                style="background: #fff; border: 2px solid #d4af37; color: #232526;">
                <div class="modal-header border-0 bg-light">
                    <h3 class="modal-title gold-title w-100 text-center" id="addSellDataModalLabel">บันทึกซื้อ</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background: #fff; color: #232526;">
                    <form id="goldForm" onsubmit="submitForm(event)">
                        <div class="mb-3">
                            <label for="date" class="form-label text-dark">วันที่ซื้อ</label>
                            <!-- <div class="input-group">
                                <input type="text" class="form-control" id="date" name="date" placeholder="เลือกวันที่"
                                    required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                <button class="btn gold-btn" type="button" id="calendarBtn">
                                    <i class="bi bi-calendar"></i>
                                </button>
                            </div> -->
                            <input type="text" class="form-control bg-primary-subtle" id="date" name="date"
                                placeholder="เลือกวันที่" required
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;" readonly>
                        </div>

                        <div class="mb-3">
                            <label for="category" class="form-label text-dark">หมวดหมู่</label>
                            <select class="form-select" id="category" name="category" required
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                <option value="" disabled selected></option>
                                <? lists.category.forEach(function (item) { ?>
                                <option value="<?= item ?>">
                                    <?= item ?>
                                </option>
                                <? }) ?>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="product" class="form-label text-dark">สินค้า (คีย์%)</label>
                            <input type="number" class="form-control" id="product" name="product"
                                placeholder="เช่น ทอง71" required
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;" min="0" max="100"
                                step="0.1" onkeyup="handlePercentage(this)">
                        </div>
                        <div class="mb-3">
                            <label for="weight" class="form-label text-dark">น้ำหนัก (กรัม)</label>
                            <input type="number" class="form-control" id="weight" name="weight" min="0" step="0.01"
                                required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <div class="mb-3">
                            <label for="price" class="form-label text-dark">ยอดซื้อ (บาท)</label>
                            <input type="number" class="form-control" id="price" name="price" min="0" step="0.01"
                                required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <div class="mb-3">
                            <label for="bank" class="form-label text-dark">ธนาคาร</label>
                            <select class="form-select" id="bank" name="bank" required
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                <option value="" disabled selected></option>
                            </select>
                        </div>
                        <!--  -->

                        <button type="submit" class="btn gold-btn w-100 py-2 fw-bold">บันทึกข้อมูล</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Melt Bill -->
    <div class="modal fade" id="meltBillModal" tabindex="-1" aria-labelledby="meltBillModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content gold-form-card">
                <div class="modal-header border-0 bg-light">
                    <h3 class="modal-title gold-title w-100 text-center" id="meltBillModalLabel">สร้างบิลหลอม</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
                </div>
                <div class="modal-body" style="background: #fff; color: #232526;">
                    <div class="mb-4">
                        <!-- Table for selected data -->
                        <div class="mb-4">
                            <h6 class="gold-title mb-2">รายการที่เลือก</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm table-light" id="selectedRowsTable">
                                    <thead>
                                        <tr>
                                            <th>สินค้า (คีย์%)</th>
                                            <th>น้ำหนัก (กรัม)</th>
                                            <th>ยอดซื้อ (บาท)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Filled by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <h5 class="gold-title mb-3">สรุปข้อมูล</h5>
                        <div class="row">
                            <div class="col-6">
                                <div class="border rounded p-2 mb-2 bg-light text-center">
                                    <span class="fw-semibold text-dark">จำนวนรายการที่เลือก:</span>
                                    <span id="summaryCount" class="fw-bold text-secondary">0</span> <span
                                        class="text-secondary">รายการ</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2 mb-2 bg-light text-center">
                                    <span class="fw-semibold text-dark">ประเภท:</span>
                                    <span id="meltType" class="fw-bold text-warning">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="border rounded p-2 mb-2 bg-light text-center">
                                    <span class="fw-semibold text-dark">% คำนวณ:</span>
                                    <span id="meltPercentCalc" class="fw-bold text-secondary">0.00</span> <span
                                        class="text-secondary">%</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-2 mb-2 bg-light text-center">
                                    <span class="fw-semibold text-dark">น้ำหนักก่อนหลอม:</span>
                                    <span id="summaryWeight" class="fw-bold text-primary">0.00</span> <span
                                        class="text-secondary">กรัม</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-2 mb-2 bg-light text-center">
                                    <span class="fw-semibold text-dark">ยอดซื้อ:</span>
                                    <span id="summaryPrice" class="fw-bold text-success">0</span> <span
                                        class="text-secondary">บาท</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <form id="meltBillForm">
                        <div class="mb-3">
                            <label for="meltWeight" class="form-label text-dark">น้ำหนักหลังหลอม (กรัม)
                                (ไม่บังคับ)</label>
                            <input type="number" class="form-control" id="meltWeight" name="meltWeight"
                                placeholder="กรอกน้ำหนักหลังหลอม" min="0" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="meltPercentAfterMelt" class="form-label text-dark">% ที่ได้ (ไม่บังคับ)</label>
                            <input type="number" class="form-control" id="meltPercentAfterMelt"
                                name="meltPercentAfterMelt" placeholder="กรอกเปอร์เซ็นต์หลังหลอม" min="0" step="0.01">
                        </div>
                        <!-- <div class="mb-3">
                            <label for="meltSellPrice" class="form-label text-dark">ยอดขาย (บาท) (ไม่บังคับ)</label>
                            <input type="number" class="form-control" id="meltSellPrice" name="meltSellPrice"
                                placeholder="กรอกยอดขายหลังหลอม" min="0" step="0.01">
                        </div> -->
                        <button type="submit" class="btn gold-btn w-100 py-2 fw-bold">บันทึกบิลหลอม</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Sell Bill -->
    <div class="modal fade" id="sellBillModal" tabindex="-1" aria-labelledby="sellBillModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content gold-form-card">
                <div class="modal-header border-0 bg-light">
                    <h3 class="modal-title gold-title w-100 text-center" id="sellBillModalLabel">สร้างบิลขาย</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
                </div>
                <div class="modal-body" style="background: #fff; color: #232526;">
                    <div class="mb-4">
                        <!-- Table for selected data -->
                        <div class="mb-4">
                            <h6 class="gold-title mb-2">รายการที่เลือก</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm table-light" id="sellBillSelectedRowsTable">
                                    <thead>
                                        <tr>
                                            <th>เลขบิลหลอม</th>
                                            <th>หมวดหมู่</th>
                                            <th>นน. ก่อนหลอม (กรัม)</th>
                                            <th>นน. หลังหลอม (กรัม)</th>
                                            <th>% ที่ได้</th>
                                            <th>ยอดซื้อ (บาท)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Filled by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <h5 class="gold-title mb-3">สรุปข้อมูล</h5>
                        <div class="row">
                            <div class="col-6">
                                <div class="border rounded p-2 mb-2 bg-light text-center">
                                    <span class="fw-semibold text-dark">จำนวนรายการที่เลือก:</span>
                                    <span id="sellSummaryCount" class="fw-bold text-secondary">0</span> <span
                                        class="text-secondary">รายการ</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="border rounded p-2 mb-2 bg-light text-center">
                                    <span class="fw-semibold text-dark">ยอดซื้อ:</span>
                                    <span id="sellSummaryPrice" class="fw-bold text-success">0</span> <span
                                        class="text-secondary">บาท</span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="border rounded p-2 mb-2 bg-light text-center">
                                    <span class="fw-semibold text-dark">นน. ก่อนหลอม:</span>
                                    <span id="sellSummaryWeightBefore" class="fw-bold text-primary">0.00</span> <span
                                        class="text-secondary">กรัม</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="border rounded p-2 mb-2 bg-light text-center">
                                    <span class="fw-semibold text-dark">นน. หลังหลอม:</span>
                                    <span id="sellSummaryWeightAfter" class="fw-bold text-primary">0.00</span> <span
                                        class="text-secondary">กรัม</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <form id="sellBillForm">
                        <!-- <div class="mb-3">
                            <label for="sellSummaryWeightAfter" class="form-label text-dark">น้ำหนักหลังหลอม (กรัม)
                                (ไม่บังคับ)</label>
                            <input type="number" class="form-control" id="sellSummaryWeightAfter" name="sellSummaryWeightAfter"
                                placeholder="กรอกน้ำหนักหลังหลอม" min="0" step="0.01">
                        </div> -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sellBillDate" class="form-label text-dark">วันที่</label>
                                    <input type="text" class="form-control" id="sellBillDate" name="sellBillDate"
                                        placeholder="เลือกวันที่" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sellPercentAfterMelt" class="form-label text-dark">% ที่ได้
                                        (ไม่บังคับ)</label>
                                    <input type="number" class="form-control" id="sellPercentAfterMelt"
                                        name="sellPercentAfterMelt" placeholder="กรอก % ที่ได้" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sellPrice" class="form-label text-dark">ยอดขาย (บาท)</label>
                                    <input type="number" class="form-control" id="sellPrice" name="sellPrice"
                                        placeholder="กรอกยอดขายหลังหลอม" min="0" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sellBillStatus" class="form-label text-dark">สถานะบิลขาย</label>
                                    <select class="form-select" id="sellBillStatus" name="sellBillStatus" required
                                        style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                        <option value="" disabled selected></option>
                                        <option value="หลอมรวม">หลอมรวม</option>
                                        <option value="สกัด">สกัด</option>
                                        <option value="ส่งขาย">ส่งขาย</option>
                                        <option value="ขายแล้ว">ขายแล้ว</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sellBillBank" class="form-label text-dark">ธนาคาร</label>
                                    <select class="form-select" id="sellBillBank" name="sellBillBank" required
                                        style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                        <option value="" disabled selected></option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="sellBillNote" class="form-label text-dark">หมายเหตุ</label>
                                    <textarea type="text" class="form-control" id="sellBillNote" name="sellBillNote"
                                        rows="3" placeholder="กรอกหมายเหตุ (ถ้ามี)"></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn gold-btn w-100 py-2 fw-bold">บันทึกบิลขาย</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Transaction Form -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content gold-form-card">
                <div class="modal-header border-0 bg-light">
                    <h3 class="modal-title gold-title w-100 text-center" id="addTransactionModalLabel">
                        เพิ่มข้อมูลรับจ่าย</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
                </div>
                <div class="modal-body" style="background: #fff; color: #232526;">
                    <form id="transactionForm" onsubmit="submitTransactionForm(event)">
                        <div class="mb-3">
                            <label for="transactionDate" class="form-label text-dark">วันที่</label>
                            <input type="text" class="form-control bg-primary-subtle" id="transactionDate"
                                name="transactionDate" placeholder="เลือกวันที่" required
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="transactionType" class="form-label text-dark">ประเภท</label>
                            <select class="form-select" id="transactionType" name="transactionType" required
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                <option value="" disabled selected></option>
                                <option value="รับ">รับ</option>
                                <option value="จ่าย">จ่าย</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="transactionItem" class="form-label text-dark">รายการ</label>
                            <textarea type="text" class="form-control" id="transactionItem" name="transactionItem"
                                rows="3" placeholder="กรอกรายการ" required
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="transactionBank" class="form-label text-dark">ธนาคาร</label>
                            <select class="form-select" id="transactionBank" name="transactionBank" required
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                <option value="" disabled selected></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="transactionAmount" class="form-label text-dark">ยอดเงิน</label>
                            <input type="number" class="form-control" id="transactionAmount" name="transactionAmount"
                                placeholder="กรอกยอดเงิน" min="0" step="0.01" required
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <div class="mb-3">
                            <label for="transactionNote" class="form-label text-dark">หมายเหตุ</label>
                            <input type="text" class="form-control" id="transactionNote" name="transactionNote"
                                placeholder="หมายเหตุ (ถ้ามี)"
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <button type="submit" class="btn gold-btn w-100 py-2 fw-bold">บันทึกข้อมูล</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Edit Melt Bill -->
    <div class="modal fade" id="editMeltBillModal" tabindex="-1" aria-labelledby="editMeltBillModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content gold-form-card">
                <div class="modal-header border-0 bg-light">
                    <h3 class="modal-title gold-title w-100 text-center" id="editMeltBillModalLabel">
                        แก้ไขข้อมูลบิลหลอม</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
                </div>
                <div class="modal-body" style="background: #fff; color: #232526;">
                    <form id="editMeltBillForm" onsubmit="submitEditMeltBillForm(event)">
                        <div class="mb-3">
                            <label for="editBillNo" class="form-label text-dark">หมายเลขบิล</label>
                            <input type="text" class="form-control bg-secondary-subtle" id="editBillNo"
                                name="editBillNo" readonly
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <div class="mb-3">
                            <label for="editBeforeWeight" class="form-label text-dark">น้ำหนักก่อนหลอม (กรัม)</label>
                            <input type="number" class="form-control bg-secondary-subtle" id="editBeforeWeight"
                                name="editBeforeWeight" readonly
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="editAfterWeight" class="form-label text-dark">น้ำหนักหลังหลอม (กรัม)</label>
                            <input type="number" class="form-control" id="editAfterWeight" name="editAfterWeight"
                                placeholder="กรอกน้ำหนักหลังหลอม" min="0" step="0.01"
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <div class="mb-3">
                            <label for="editPercentAfterMelt" class="form-label text-dark">% ที่ได้</label>
                            <input type="number" class="form-control" id="editPercentAfterMelt"
                                name="editPercentAfterMelt" placeholder="กรอกเปอร์เซ็นต์หลังหลอม" min="0" step="0.01"
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <div class="mb-3">
                            <label for="editSellPrice" class="form-label text-dark">ยอดขาย (บาท)</label>
                            <input type="number" class="form-control" id="editSellPrice" name="editSellPrice"
                                placeholder="กรอกยอดขาย" min="0" step="0.01"
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <button type="submit" class="btn gold-btn w-100 py-2 fw-bold">บันทึกการแก้ไข</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Edit Sell Bill -->
    <div class="modal fade" id="editSellBillModal" tabindex="-1" aria-labelledby="editSellBillModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content gold-form-card">
                <div class="modal-header border-0 bg-light">
                    <h3 class="modal-title gold-title w-100 text-center" id="editSellBillModalLabel">
                        แก้ไขข้อมูลบิลขาย</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
                </div>
                <div class="modal-body" style="background: #fff; color: #232526;">
                    <form id="editSellBillForm" onsubmit="submitEditSellBillForm(event)">
                        <div class="mb-3">
                            <label for="editSellBillNo" class="form-label text-dark">หมายเลขบิลขาย</label>
                            <input type="text" class="form-control bg-secondary-subtle" id="editSellBillNo"
                                name="editSellBillNo" readonly
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <div class="mb-3">
                            <label for="editSellBillDate" class="form-label text-dark">วันที่</label>
                            <input type="text" class="form-control" id="editSellBillDate" name="editSellBillDate"
                                placeholder="เลือกวันที่" required
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editSellPercentAfterMelt" class="form-label text-dark">% ที่ได้</label>
                                    <input type="number" class="form-control" id="editSellPercentAfterMelt"
                                        name="editSellPercentAfterMelt" placeholder="กรอก % ที่ได้" min="0" step="0.01"
                                        style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editSellBillPrice" class="form-label text-dark">ยอดขาย (บาท)</label>
                                    <input type="number" class="form-control" id="editSellBillPrice"
                                        name="editSellBillPrice" placeholder="กรอกยอดขาย" min="0" step="0.01" required
                                        style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editSellBillStatus" class="form-label text-dark">สถานะบิลขาย</label>
                                    <select class="form-select" id="editSellBillStatus" name="editSellBillStatus"
                                        required style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                        <option value="" disabled selected></option>
                                        <option value="หลอมรวม">หลอมรวม</option>
                                        <option value="สกัด">สกัด</option>
                                        <option value="ส่งขาย">ส่งขาย</option>
                                        <option value="ขายแล้ว">ขายแล้ว</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editSellBillBank" class="form-label text-dark">ธนาคาร</label>
                                    <select class="form-select" id="editSellBillBank" name="editSellBillBank" required
                                        style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                                        <option value="" disabled selected></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editSellBillNote" class="form-label text-dark">หมายเหตุ</label>
                            <textarea class="form-control" id="editSellBillNote" name="editSellBillNote" rows="3"
                                placeholder="กรอกหมายเหตุ (ถ้ามี)"
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;"></textarea>
                        </div>
                        <button type="submit" class="btn gold-btn w-100 py-2 fw-bold">บันทึกการแก้ไข</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Melt Summary Date Range Selection -->
    <div class="modal fade" id="meltSummaryModal" tabindex="-1" aria-labelledby="meltSummaryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content gold-form-card">
                <div class="modal-header border-0 bg-light">
                    <h3 class="modal-title gold-title w-100 text-center" id="meltSummaryModalLabel">
                        รายงานสรุปสต็อกในร้าน</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
                </div>
                <div class="modal-body" style="background: #fff; color: #232526;">
                    <form id="meltSummaryForm" onsubmit="submitMeltSummaryForm(event)">
                        <div class="mb-3">
                            <label for="meltDateRange" class="form-label text-dark">
                                <i class="bi bi-calendar-range me-2"></i>เลือกช่วงวันที่
                            </label>
                            <input type="text" class="form-control" id="meltDateRange" name="meltDateRange"
                                placeholder="เลือกช่วงวันที่สำหรับรายงาน" required readonly
                                style="border: 1.5px solid #d4af37; background: #fff; color: #232526;">
                            <small class="text-muted">คลิกเพื่อเลือกช่วงวันที่ที่ต้องการสร้างรายงาน</small>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn gold-btn py-2 fw-bold">
                                <i class="bi bi-file-earmark-text me-2"></i>สร้างรายงาน
                            </button>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle me-2"></i>ยกเลิก
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- template for reports -->
    <template id="goldTableReport_template">
        <div class="gold-table-report">
            <!-- <h3 class="gold-title text-center mb-4">รายงานการซื้อทอง</h3> -->
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th colspan="6" class="text-center" id="goldTableReportTitle"></th>
                    </tr>
                    <tr>
                        <th class="text-center">#</th>
                        <th class="text-center">สินค้า (คีย์%)</th>
                        <th class="text-center">น้ำหนัก (กรัม)</th>
                        <th class="text-center">ยอดซื้อ (บาท)</th>
                        <th class="text-center">พนักงาน</th>
                        <th class="text-center">สาขา</th>
                        <th class="text-center">ธนาคาร</th>
                    </tr>
                </thead>
                <tbody id="goldTableReportBody"></tbody>
            </table>
        </div>
    </template>
    <template id="transactionReport_template">
        <div class="transaction-combined-report mt-3">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th colspan="8" class="text-center" id="transactionCombinedReportTitle"></th>
                    </tr>
                    <tr>
                        <th class="text-center">#</th>
                        <th class="text-center">เวลา</th>
                        <th class="text-center">ประเภท</th>
                        <th class="text-center">รายการ</th>
                        <th class="text-center">ยอดเงิน (บาท)</th>
                        <th class="text-center">ธนาคาร</th>
                        <th class="text-center">พนักงาน</th>
                        <th class="text-center">สาขา</th>
                        <th class="text-center">หมายเหตุ</th>
                    </tr>
                </thead>
                <tbody id="transactionCombinedReportBody">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>
    </template>
    <template id="accountsRemainingReport_template">
        <div class="accounts-remaining-report my-3">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th colspan="4" class="text-center" id="accountsRemainingReportTitle"></th>
                    </tr>
                    <tr>
                        <th class="text-center">#</th>
                        <th class="text-center">ธนาคาร</th>
                        <th class="text-center">ยอดเงิน (บาท)</th>
                    </tr>
                </thead>
                <tbody id="accountsRemainingReportBody">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>
    </template>
    <div id="printArea" style="display: none;"></div>


    <script>

        function submitTransactionForm(e) {
            e.preventDefault();
            const form = document.getElementById('transactionForm');
            const data = {
                date: $('#transactionDate').data('date') || moment().format('YYYY-MM-DD'),
                type: form.transactionType.value,
                item: form.transactionItem.value,
                bank: form.transactionBank.value,
                amount: form.transactionAmount.value,
                note: form.transactionNote.value,
                staff: window.user.name,
                branch: window.user.branch,
            };
            NProgress.start();
            goldSwal({
                title: 'กำลังบันทึกข้อมูล...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            google.script.run.withSuccessHandler(function () {
                NProgress.done();
                reloadTable('#transactionTable');
                refreshDashboard(); // อัปเดต Dashboard
                goldSwal({
                    icon: 'success',
                    title: 'บันทึกข้อมูลสำเร็จ',
                    showConfirmButton: false,
                    timer: 1500
                });
                $('#addTransactionModal').modal('hide');
            }).withFailureHandler(function (error) {
                NProgress.done();
                goldSwal({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    html: error.message || error,
                });
            }).saveTransactionData(data);
        }

        // Show modal when addTransaction is called
        function addTransaction() {
            $('#addTransactionModal').modal('show');
        }

        // Function to handle melt summary form submission
        function submitMeltSummaryForm(e) {
            e.preventDefault();
            const form = document.getElementById('meltSummaryForm');
            const dateRange = $('#meltDateRange').val().split('ถึง').map(d => d.trim())
            console.log('Selected date range:', dateRange);
            if (!dateRange.length || dateRange.length !== 2) {
                goldSwal({
                    icon: 'warning',
                    title: 'กรุณาเลือกช่วงวันที่',
                    text: 'กรุณาเลือกช่วงวันที่สำหรับสร้างรายงาน'
                });
                return;
            }

            const reportOptions = {
                startDate: dateRange[0],
                endDate: dateRange[1],
                branch: window.user.branch
            };

            console.log('Generating melt summary report with options:', reportOptions);

            NProgress.start();
            goldSwal({
                title: 'กำลังสร้างรายงาน...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Call backend function to generate report
            google.script.run.withSuccessHandler(function (response) {
                NProgress.done();
                try {
                    const result = JSON.parse(response);
                    console.log('Melt summary report result:', result);
                    if (result.success) {
                        $('#meltSummaryModal').modal('hide');
                        generateMeltSummaryReport(result, reportOptions);
                    } else {
                        goldSwal({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: result.message || 'ไม่สามารถสร้างรายงานได้'
                        });
                    }
                } catch (error) {
                    goldSwal({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ข้อมูลที่ได้รับไม่ถูกต้อง'
                    });
                }
            }).withFailureHandler(function (error) {
                NProgress.done();
                goldSwal({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message || error
                });
            }).getMeltSummaryReport(reportOptions);
        }

        // Function to generate and display melt summary report
        function generateMeltSummaryReport(result, options) {
            const data = result.data;
            const rawData = result.rawData || data; // Use rawData for table display
            const summarizedBuyData = result.summarizedBuyData || [];
            const summary = result.summary;

            let reportHtml = `
                <div class="text-start">
                    <h5 class="text-center mb-3 text-dark">รายงานสรุปสต็อคในร้าน</h5>
                    <p class="mb-2"><strong>ช่วงวันที่:</strong> ${moment(options.startDate, 'YYYY-MM-DD').format('DD/MM/YYYY')} - ${moment(options.endDate, 'YYYY-MM-DD').format('DD/MM/YYYY')}</p>
                    <p class="mb-2"><strong>สาขา:</strong> ${options.branch === 'all' ? 'ทุกสาขา' : options.branch}</p>
                    <hr class="my-3">
                    <div class="mb-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <strong>จำนวนบิล:</strong> ${summary.totalBills || 0} บิล
                            </div>
                            
                        </div>
                        <div class="row g-2 mt-1">
                            <div class="col-6">
                                <strong>น้ำหนักก่อนหลอม:</strong> ${(summary.totalBeforeWeight || 0).toFixed(2)} กรัม
                            </div>
                            <div class="col-6">
                                <strong>น้ำหนักหลังหลอม:</strong> ${(summary.totalAfterWeight || 0).toFixed(2)} กรัม
                            </div>
                        </div>
                        <div class="row g-2 mt-1">
                            <div class="col-6">
                                <strong>ยอดซื้อรวม:</strong> ${(summary.totalBuyPrice || 0).toLocaleString('th-TH')} บาท
                            </div>
                            <div class="col-6 ${window.user.role === 'admin' ? '' : 'd-none'}">
                                <strong>ยอดขายรวม:</strong> ${(summary.totalSellPrice || 0).toLocaleString('th-TH')} บาท
                            </div>
                        </div>
                        <div class="row g-2 mt-1">
                            <div class="col-6">
                                <strong>รายการยังไม่หลอม:</strong> ${summarizedBuyData.length} รายการ (${(summary.totalUnmeltedWeight || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} กรัม)
                            </div>
                        </div>
                    </div>
                    ${rawData.length > 0 ? `
                    <hr class="my-3">
                    <h6 class="text-center mb-3 text-dark">รายการบิลหลอมทั้งหมด</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th class="text-center" style="width: 40px;">#</th>
                                    <th class="text-center" style="width: 100px;">วันที่</th>
                                    <th class="text-center" style="width: 120px;">เลขบิล</th>
                                    <th class="text-center" style="width: 80px;">น้ำหนักก่อน</th>
                                    <th class="text-center" style="width: 80px;">น้ำหนักหลัง</th>
                                    <th class="text-center" style="width: 100px;">% หลังหลอม</th>
                                    <th class="text-center" style="width: 100px;">% คำนวณ</th>
                                    <th class="text-center" style="width: 100px;">ยอดซื้อ</th>
                                    <th class="text-center" style="width: 100px;">ผู้บันทึก</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rawData.map((item, index) => `
                                    <tr>
                                        <td class="text-center">${index + 1}</td>
                                        <td class="text-center">${moment(item.date).format('DD/MM/YY')}</td>
                                        <td class="text-center">${item.billNo}</td>
                                        <td class="text-end">${(item.beforeWeight || 0).toFixed(2)}</td>
                                        <td class="text-end">${(item.afterWeight || 0).toFixed(2)}</td>
                                        <td class="text-end">${(item.percentAfterMelt || 0).toFixed(2)}</td>
                                        <td class="text-end">${(item.percentCalc || 0).toFixed(2)}</td>
                                        <td class="text-end">${(item.buyPrice || 0).toLocaleString('th-TH')}</td>
                                        <td class="text-center">${item.recorder || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : `
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        ไม่มีข้อมูลบิลหลอมในช่วงเวลานี้
                    </div>
                    `}
                    ${summarizedBuyData.length > 0 ? `
                    <hr class="mt-5 my-3">
                    <h6 class="text-center mb-3 text-dark">รายการยังไม่หลอม</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th class="text-center" style="width: 120px;">#</th>
                                    <th class="text-center">วันที่</th>
                                    <th class="text-center">หมวดหมู่</th>
                                    <th class="text-center">จำนวน (รายการ)</th>
                                    <th class="text-center">น้ำหนักรวม (กรัม)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${summarizedBuyData.map((item, index) => `
                                    <tr>
                                        <td class="text-center">${index + 1}</td>
                                        <td class="text-center">${moment(item.date).format('DD/MM/YY')}</td>
                                        <td class="text-center">${item.category || '-'}</td>
                                        <td class="text-end">${item.count || 0}</td>
                                        <td class="text-end">${(item.totalWeight || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    </tr>
                                `).join('')}
                                <tr class="table-light fw-bold">
                                    <td colspan="3" class="text-end">รวมทั้งหมด</td>
                                    <td class="text-end">${summarizedBuyData.reduce((sum, item) => sum + (item.count || 0), 0)}</td>
                                    <td class="text-end">${summarizedBuyData.reduce((sum, item) => sum + (item.totalWeight || 0), 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                            </tbody>
                        </table>
                    ` : `
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            ไม่มีรายการซื้อที่ยังไม่หลอมในช่วงเวลานี้
                        </div>
                    `}
                </div>
            `;

            goldSwal({
                title: 'รายงานสรุปสต็อคในร้าน',
                html: reportHtml,
                width: '800px',
                showCancelButton: true,
                confirmButtonText: '<i class="bi bi-printer me-2"></i>พิมพ์รายงาน',
                cancelButtonText: '<i class="bi bi-x-circle me-2"></i>ปิด',
                confirmButtonColor: '#d4af37',
            }).then((result) => {
                if (result.isConfirmed) {
                    printMeltSummaryReport(rawData, options, summary, summarizedBuyData);
                }
            });
        }

        // Function to print melt summary report
        function printMeltSummaryReport(data, options, summary, summarizedBuyData) {
            const printContent = `
                <div class="container-fluid">
                    <div class="text-center mb-4">
                        <h4 class="fw-bold">รายงานสรุปสต็อคในร้าน</h4>
                        <p class="mb-0">สาขา: ${options.branch === 'all' ? 'ทุกสาขา' : options.branch}</p>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <td>จำนวนบิลหลอม</td>
                                        <td class="text-end">${(summary.totalBills || 0).toLocaleString('th-TH')}</td>
                                        <td class="text-center">บิล</td>
                                    </tr>
                                    <tr>
                                        <td>น้ำหนักก่อนหลอม</td>
                                        <td class="text-end">${(summary.totalBeforeWeight || 0).toFixed(2)}</td>
                                        <td class="text-center">กรัม</td>
                                    </tr>
                                    <tr>
                                        <td>น้ำหนักหลังหลอม</td>
                                        <td class="text-end">${(summary.totalAfterWeight || 0).toFixed(2)}</td>
                                        <td class="text-center">กรัม</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ${data.length > 0 ? `
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="mb-3">รายการบิลหลอมทั้งหมด</h5>
                            <table class="table table-bordered table-sm">
                                <thead class="table-info">
                                    <tr>
                                        <th class="text-center text-wrap">#</th>
                                        <th class="text-center text-wrap">วันที่</th>
                                        <th class="text-center text-wrap">เลขบิล</th>
                                        <th class="text-center text-wrap">นน.ก่อน (ก.)</th>
                                        <th class="text-center text-wrap">นน.หลัง (ก.)</th>
                                        <th class="text-center text-wrap">% หลังหลอม</th>
                                        <th class="text-center text-wrap">% คำนวณ</th>
                                        <th class="text-center text-wrap">ยอดซื้อ (บาท)</th>
                                        <th class="text-center text-wrap">ผู้บันทึก</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map((item, index) => `
                                        <tr>
                                            <td class="text-center">${index + 1}</td>
                                            <td class="text-center">${moment(item.date).format('DD/MM/YYYY')}</td>
                                            <td class="text-center">${item.billNo}</td>
                                            <td class="text-end">${(item.beforeWeight || 0).toFixed(2)}</td>
                                            <td class="text-end">${(item.afterWeight || 0).toFixed(2)}</td>
                                            <td class="text-end">${(item.meltPercentAfterMelt || 0).toFixed(2)}</td>
                                            <td class="text-end">${(item.percentCalc || 0).toFixed(2)}</td>
                                            <td class="text-end">${(item.buyPrice || 0).toLocaleString('th-TH')}</td>
                                            <td class="text-center">${item.recorder || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                    ${summarizedBuyData.length > 0 ? `
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="mb-3">รายการยังไม่หลอม</h5>
                            <table class="table table-bordered table-sm">
                                <thead class="table-info">
                                    <tr>
                                        <th class="text-center text-wrap">#</th>
                                        <th class="text-center text-wrap">วันที่</th>
                                        <th class="text-center text-wrap">หมวดหมู่</th>
                                        <th class="text-center text-wrap">จำนวน (รายการ)</th>
                                        <th class="text-center text-wrap">นน.รวม (กรัม)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${summarizedBuyData.map((item, index) => `
                                        <tr>
                                            <td class="text-center">${index + 1}</td>
                                            <td class="text-center">${moment(item.date).format('DD/MM/YYYY')}</td>
                                            <td class="text-center">${item.category || '-'}</td>
                                            <td class="text-end">${item.count || 0}</td>
                                            <td class="text-end">${(item.totalWeight || 0).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            // Create print window
            $('#printArea').html(printContent);

            // Use browser print functionality
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>รายงานสรุปการหลอม</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        @media print {
                            @page { margin: 1cm; }
                            body { font-family: 'Noto Sans Thai', sans-serif; }
                        }
                        body { font-family: 'Noto Sans Thai', sans-serif; }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();

            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }
    </script>

    <script>
        $(document).ready(function () {
            moment.locale('th');
            $('#date').val(moment().format('DD/MM/YYYY')).data('date', moment().format('YYYY-MM-DD'));
            $('#transactionDate').val(moment().format('DD/MM/YYYY')).data('date', moment().format('YYYY-MM-DD'));
            // initDataTable('#goldTable');
            $('#addSellDataModal').on('hidden.bs.modal', function () {
                $('#goldForm')[0].reset();
                $('#date').val(moment().format('DD/MM/YYYY')).data('date', moment().format('YYYY-MM-DD'));
            });
            $('#addTransactionModal').on('hidden.bs.modal', function () {
                $('#transactionForm')[0].reset();
                $('#transactionDate').val(moment().format('DD/MM/YYYY')).data('date', moment().format('YYYY-MM-DD'));
            });

            $('#editMeltBillModal').on('hidden.bs.modal', function () {
                $('#editMeltBillForm')[0].reset();
                $('#editMeltBillForm').removeData('currentData');
            });

            $('#editSellBillModal').on('hidden.bs.modal', function () {
                $('#editSellBillForm')[0].reset();
                $('#editSellBillForm').removeData('currentData');
                $('#editSellBillDate')[0]._flatpickr.destroy();
            });

            $('#category').change(function () {
                if ($(this).val() === 'ค่าบริการ') {
                    $('#product, #weight').val("").removeAttr('required').parent('.mb-3').hide()
                } else {
                    $('#product, #weight').attr('required', true).parent('.mb-3').show();
                }
            })

            $('#showSellSectionBtn').on('click', function () {
                $('.nav-link').removeClass('active');
                if (DataTable.isDataTable('#goldTable')) {
                    datatable.rows({ selected: true }).deselect();
                    datatable.column(1).visible(false);
                }
                showTableButtons('add')
                $('#showSellSectionBtn').addClass('active');
                if (!$('#main-sec').is(':visible')) {
                    let currentShow = $('section:visible');
                    currentShow.addClass('animate__animated animate__fadeOut animate__faster');
                    setTimeout(function () {
                        $('#main-sec').addClass('animate__animated animate__fadeIn animate__faster').show();
                        currentShow.hide().removeClass('animate__fadeOut animate__fadeIn animate__faster');
                        setTimeout(function () {
                            $('#main-sec').removeClass('animate__fadeIn');
                        }, 500);
                        reloadTable('#goldTable');
                    }, 500);
                } else {
                    reloadTable('#goldTable');
                }
            });
            $('#showTransactionSectionBtn').on('click', function () {
                $('.nav-link').removeClass('active');
                $('#showTransactionSectionBtn').addClass('active');
                if (!$('#transaction-sec').is(':visible')) {
                    let currentShow = $('section:visible');
                    currentShow.addClass('animate__animated animate__fadeOut animate__faster');
                    setTimeout(function () {
                        $('#transaction-sec').addClass('animate__animated animate__fadeIn animate__faster').show();
                        currentShow.hide().removeClass('animate__fadeOut animate__fadeIn animate__faster');
                        setTimeout(function () {
                            $('#transaction-sec').removeClass('animate__fadeIn animate__faster');
                        }, 500);
                        reloadTable('#transactionTable');
                    }, 500);
                } else {
                    reloadTable('#transactionTable');
                }
            });
            $('#showBuySummarySectionBtn').on('click', function () {
                $('.nav-link').removeClass('active');
                $('#showBuySummarySectionBtn').addClass('active');
                if (!$('#buy-summary-sec').is(':visible')) {
                    let currentShow = $('section:visible');
                    currentShow.addClass('animate__animated animate__fadeOut animate__faster');
                    setTimeout(function () {
                        $('#buy-summary-sec').addClass('animate__animated animate__fadeIn animate__faster').show();
                        currentShow.hide().removeClass('animate__fadeOut animate__fadeIn animate__faster');
                        setTimeout(function () {
                            $('#buy-summary-sec').removeClass('animate__fadeIn animate__faster');
                        }, 500);
                        reloadTable('#buySummaryTable');
                    }, 500);
                } else {
                    reloadTable('#buySummaryTable');
                }
            });
            $('#showMeltSectionBtn').on('click', function () {
                if (DataTable.isDataTable('#meltTable')) {
                    meltTable.rows({ selected: true }).deselect();
                    meltTable.column(1).visible(false);
                }
                showTableButtons('addSellBill')
                $('.nav-link').removeClass('active');
                $('#showMeltSectionBtn').addClass('active');
                if (!$('#melt-sec').is(':visible')) {
                    let currentShow = $('section:visible');
                    currentShow.addClass('animate__animated animate__fadeOut animate__faster');
                    setTimeout(function () {
                        $('#melt-sec').addClass('animate__animated animate__fadeIn animate__faster').show();
                        currentShow.hide().removeClass('animate__fadeOut animate__fadeIn animate__faster');
                        setTimeout(function () {
                            $('#melt-sec').removeClass('animate__fadeIn animate__faster');
                        }, 500);
                        reloadTable('#meltTable');
                    }, 500);
                } else {
                    reloadTable('#meltTable');
                }
            });

            $('#showSellBillSectionBtn').on('click', function () {
                if (DataTable.isDataTable('#sellBillTable')) {
                    sellBillTable.rows({ selected: true }).deselect();
                    sellBillTable.column(1).visible(false);
                }
                showTableButtons('addSellBill')
                $('.nav-link').removeClass('active');
                $('#showSellBillSectionBtn').addClass('active');
                if (!$('#sell-bill-sec').is(':visible')) {
                    let currentShow = $('section:visible');
                    currentShow.addClass('animate__animated animate__fadeOut animate__faster');
                    setTimeout(function () {
                        $('#sell-bill-sec').addClass('animate__animated animate__fadeIn animate__faster').show();
                        currentShow.hide().removeClass('animate__fadeOut animate__fadeIn animate__faster');
                        setTimeout(function () {
                            $('#sell-bill-sec').removeClass('animate__fadeIn animate__faster');
                        }, 500);
                        reloadTable('#sellBillTable');
                    }, 500);
                } else {
                    reloadTable('#sellBillTable');
                }
            });
            $('#createSummaryReportBtn').on('click', function () {
                $('.nav-link').removeClass('active');
                $('#createSummaryReportBtn').addClass('active');
                const bankList = $('#transactionBank option').toArray().map(x => x.innerHTML.trim()).filter(x => x != "")
                goldSwal({
                    title: 'เลือกรายงานที่ต้องการสรุป',
                    html: `
                        <div class="text-start">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="summaryBuyTable" checked>
                                <label class="form-check-label" for="summaryBuyTable">รายงานซื้อเข้า</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="summaryTransactionTable" checked>
                                <label class="form-check-label" for="summaryTransactionTable">รายงานรับ-จ่าย</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="summaryAccount" checked>
                                <label class="form-check-label" for="summaryAccount">รายงานสรุปยอดบัญชี</label>
                            </div>
                            <div id="bankCheckboxes" class="ps-4 mt-2">
                                ${window.user.allowAccounts
                            .filter(bank => !bank.includes('เฮียเจี๋ย'))
                            .map(bank => `
                                    <div class="form-check mb-1">
                                        <input class="form-check-input" type="checkbox" value="${bank}" checked>
                                        <label class="form-check-label">${bank}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'สร้างรายงาน',
                    cancelButtonText: 'ยกเลิก',
                    didOpen: () => {
                        $('#summaryAccount').on('change', function () {
                            const checked = $(this).is(':checked');
                            $('#bankCheckboxes input[type="checkbox"]').prop('checked', checked);
                        });
                    },
                    preConfirm: () => {
                        return {
                            buy: $('#summaryBuyTable').is(':checked'),
                            trans: $('#summaryTransactionTable').is(':checked'),
                            acc: $('#summaryAccount').is(':checked'),
                            banks: $('#bankCheckboxes input[type="checkbox"]:checked').map(function () { return this.value; }).get()
                        };
                    }
                }).then(result => {
                    if (result.isConfirmed && result.value) {
                        generateSummaryReport(result.value)
                    }
                });
            });
            $('#createSummaryMeltBtn').on('click', function () {
                $('.nav-link').removeClass('active');
                $('#createSummaryMeltBtn').addClass('active');
                $('#meltSummaryModal').modal('show');
            });

            // Initialize Flatpickr for melt summary date range
            $('#meltSummaryModal').on('shown.bs.modal', function () {
                if (!$('#meltDateRange').data('flatpickr')) {
                    flatpickr("#meltDateRange", {
                        mode: "range",
                        locale: "th",
                        dateFormat: "Y-m-d",
                        altInput: true,
                        altFormat: "d/m/Y",
                        // from monday to sunday
                        defaultDate: (moment().day() === 0) ? [ // Sunday
                            moment().subtract(6, 'days').format('YYYY-MM-DD'), // Previous Monday
                            moment().format('YYYY-MM-DD') // today (Sunday)
                        ] : [
                            moment().startOf('week').add(1, 'day').format('YYYY-MM-DD'), // Adjusting to start from Monday
                            moment().endOf('week').add(1, 'day').format('YYYY-MM-DD') // Next Sunday
                        ],
                        onReady: function (selectedDates, dateStr, instance) {
                            // Style the input with gold theme
                            instance.altInput.style.borderColor = '#d4af37';
                            instance.altInput.style.background = '#fff';
                            instance.altInput.style.color = '#232526';
                        }
                    });
                }
            });

            // Reset form when modal is hidden
            $('#meltSummaryModal').on('hidden.bs.modal', function () {
                $('#meltSummaryForm')[0].reset();
                // Reset flatpickr to default dates
                const fp = $('#meltDateRange').data('flatpickr');
                if (fp) {
                    if (moment().day() === 0) { // Sunday
                        fp.setDate([
                            moment().subtract(6, 'days').format('YYYY-MM-DD'), // Previous Monday
                            moment().subtract(1, 'days').format('YYYY-MM-DD') // Previous Saturday
                        ]);
                    } else {
                        fp.setDate([
                            moment().startOf('week').add(1, 'day').format('YYYY-MM-DD'), // Adjusting to start from Monday
                            moment().endOf('week').format('YYYY-MM-DD') // Saturday
                        ]);
                    }
                }
            });
        });

        function handlePercentage(input) {
            let value = parseFloat(input.value);
            if (value > 100) {
                value = (value / 10).toFixed(1);
                input.value = value;
            }
        }

        let datatable, transactionTable, meltTable, sellBillTable;
        async function initDataTable(selector) {
            switch (selector) {
                case '#goldTable':
                    initGoldTable(selector);
                    break;
                case '#transactionTable':
                    initTransactionTable(selector);
                    break;
                case '#buySummaryTable':
                    initBuySummaryTable(selector);
                    break;
                case '#meltTable':
                    initMeltTable(selector);
                    break;
                case '#sellBillTable':
                    initSellBillTable(selector);
                    break;
            }
        }

        async function initGoldTable(selector) {
            datatable = $(selector).DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                scrollX: true,
                dom: "<'row justify-content-between'<'col-md-auto buttons-sec1'><'col-md-auto filter-sec1'>>" +
                    "<'row mt-2'<'col-12't>>" +
                    "<'row justify-content-between mt-2'<'col-md-auto'i><'col-md-auto'p>>",
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/th.json',
                    emptyTable: "ยังไม่มีข้อมูลของวันที่ <b>" + moment().format('DD/MM/YYYY') + "</b> กรุณาเพิ่มข้อมูลการซื้อ",
                    processing: 'กำลังโหลดข้อมูล...',
                },
                select: {
                    style: 'multi+shift',
                    selector: 'td:nth-child(2)'
                },
                pageLength: 30,
                ajax: function (data, callback, settings) {
                    NProgress.start();
                    try {
                        console.log('Fetching buy data for branch:', window.user.branch);
                        google.script.run.withSuccessHandler(function (response) {
                            response = JSON.parse(response);
                            NProgress.done();
                            isLoadAll = false
                            console.log('Response:', response);
                            callback({
                                data: response,
                                recordsTotal: response.length,
                                recordsFiltered: response.length
                            });
                        }).withFailureHandler(function (error) {
                            NProgress.done();
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: error.message || error,
                            });
                        }).getBuyData(isLoadAll, false, window.user.branch);
                    } catch {
                        NProgress.done();
                        callback({
                            data: [],
                            recordsTotal: 0,
                            recordsFiltered: 0
                        })
                    }

                },
                columns: [
                    {
                        data: null,
                        title: '#',
                        orderable: false,
                        searchable: false,
                        className: 'text-center text-nowrap',
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        data: null,
                        title: 'เลือก <input type="checkbox" id="selectAllRows" />',
                        visible: false,
                        orderable: false,
                        searchable: false,
                        className: 'text-center text-nowrap select-checkbox all',
                        render: function (data, type, row) {
                            // If billNo exists (already melted), show disabled icon instead of checkbox
                            if (row.billNo && row.billNo.trim() !== '') {
                                return '<i class="bi bi-ban-fill text-danger" title="รายการนี้ถูกหลอมแล้ว"></i>';
                            }
                            // Return empty string to let DataTables render checkbox
                            return '';
                        }
                    },
                    {
                        data: 'date',
                        title: 'วันที่',
                        render: function (data) {
                            return moment(data).format('DD/MM/YYYY');
                        }
                    },
                    {
                        data: 'date',
                        title: 'เวลา',
                        render: function (data) {
                            return moment(data).format('HH:mm');
                        }
                    },
                    {
                        data: 'category',
                        title: 'หมวดหมู่',
                        visible: false,
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'product',
                        title: 'สินค้า (คีย์%)',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'weight',
                        title: 'น้ำหนัก (กรัม)',
                        render: function (data) {
                            return data ? parseFloat(data).toFixed(2) : '0.00';
                        }
                    },
                    {
                        data: 'price',
                        title: 'ยอดซื้อ (บาท)',
                        render: function (data) {
                            return data ? parseInt(data).toLocaleString('th-TH') : '0';
                        }
                    },
                    {
                        data: 'bank',
                        title: 'ธนาคาร',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'seller',
                        title: 'พนักงาน',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'branch',
                        title: 'สาขา',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'status',
                        title: 'สถานะ',
                        render: function (data, type, row) {
                            if (data === 'ยกเลิก') {
                                return `<button type="button" class="w-100 btn btn-sm text-black-50 text-nowrap" style="pointer-events: none;">
                            <i class="bi bi-x-circle-fill"></i> ยกเลิก
                        </button>`;
                            }
                            else if (data === 'เสร็จสิ้น') {
                                if (row.enableEdit) return '<button type="button" class="w-100 btn btn-sm btn-success text-nowrap" onclick="cancelRow(this);"><i class="bi bi-check-circle-fill"></i> สำเร็จ</button>';
                                return '<button type="button" class="w-100 btn btn-sm btn-secondary text-nowrap" style="cursor: not-allowed; pointer-events: none;"><i class="bi bi-check-circle-fill"></i> สำเร็จ</button>';
                            }
                            else if (data === 'หลอมแล้ว') {
                                return '<button type="button" class="w-100 btn btn-sm btn-primary text-nowrap"><i class="bi bi-fire" style="cursor: not-allowed; pointer-events: none;"></i> หลอมแล้ว</button>';
                            }
                            else {
                                return '<button type="button" class="w-100 btn btn-sm bg-secondary-subtle text-dark text-nowrap" style="cursor: not-allowed; pointer-events: none;"><i class="bi bi-question-circle-fill"></i> ไม่ระบุ</button>';
                            }
                        }
                    },
                    {
                        data: 'billNo',
                        title: 'เลขบิลหลอม',
                        visible: false,
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'monthYear',
                        title: 'เดือน/ปี',
                        visible: false,
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'uuid',
                        title: 'เลขอ้างอิง',
                        className: 'text-nowrap none text-black-50',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    }

                ],
                createdRow: function (row, data, dataIndex) {
                    $(row).addClass('text-nowrap');
                    if (data.status === 'ยกเลิก') {
                        $(row).find('td').css('font-weight', 300).css('color', '#ff0000');
                    }
                    // Disable selection for rows with billNo
                    if (data.billNo && data.billNo.trim() !== '') {
                        $(row).addClass('not-selectable');
                    }
                },
                initComplete: function (settings, json) {
                    NProgress.done();
                    $('.buttons-sec1').html(`
                <div class="d-flex flex-wrap gap-2 w-100 mb-2 align-items-center" id="addSellDataActions" role="group">
                    <button class="btn btn-warning flex-fill text-nowrap d-flex align-items-center justify-content-center" data-bs-toggle="modal" data-bs-target="#addSellDataModal" id="addSellDataBtn">
                    <i class="bi bi-plus-circle-fill me-2"></i> เพิ่มข้อมูลการซื้อ
                    </button>
                    <button class="btn btn-warning flex-fill text-nowrap d-flex align-items-center justify-content-center" id="createMeltBillBtn">
                    <i class="bi bi-file-earmark-plus-fill me-2"></i> บันทึกบิลหลอม
                    </button>
                </div>
                <div class="d-none flex-wrap gap-2 w-100 mb-2 align-items-center" id="meltBillActions" role="group">
                    <button class="btn btn-primary flex-fill text-nowrap d-flex align-items-center justify-content-center" id="createMeltBillBtn" data-bs-toggle="modal" data-bs-target="#meltBillModal">
                    <i class="bi bi-file-earmark-plus-fill me-2"></i> สร้างบิลหลอม
                    </button>
                    <button class="btn btn-outline-secondary flex-fill text-nowrap d-flex align-items-center justify-content-center" id="cancelMeltBillSelectionBtn" onclick="datatable.rows({ selected: true }).deselect(); showTableButtons('add');datatable.column(1).visible(false);reloadTable('#goldTable');">
                    <i class="bi bi-x-circle me-2"></i> ยกเลิกการเลือก
                    </button>
                </div>
                `);
                    $('.filter-sec1').html(`
                <div class="d-flex flex-wrap gap-2 w-100 mb-2 align-items-center justify-content-center" id="filterActions" role="group">
                    <div class="input-group">
                    <select class="form-select rounded-3" id="filterCategory">
                        <option value="" selected>หมวดหมู่ทั้งหมด</option>
                        ${[...new Set(json.data.map(item => item.category).filter(cat => cat && cat.trim() !== ''))].map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                    <input type="search" class="form-control rounded-3 ms-2" id="searchText" placeholder="ค้นหาข้อมูล...">
                    </div>
                </div>
                `);
                    $('#createMeltBillBtn').on('click', function () {
                        createMeltBillBtn();
                    });
                    $('#filterCategory').on('change', function () {
                        const searchValue = this.value;
                        if (searchValue === '') {
                            datatable.column(4).search('').draw();
                        } else {
                            // Use exact match with word boundaries
                            datatable.column(4).search('^' + searchValue + '$', true, false).draw();
                        }
                    });
                    $('#searchText').on('input', function () {
                        datatable.search(this.value).draw();
                    });

                },
                columnDefs: [
                    {
                        targets: '_all',
                        className: 'dt-head-center dt-head-nowrap text-center dt-body-center all',
                    }
                ]
            });

            datatable.on('select', function (e, dt, type, indexes) {
                let selectedRows = datatable.rows({ selected: true }).count()
                if (type === 'row') {
                    indexes.forEach(function (idx) {
                        const rowData = datatable.row(idx).data();
                        // Prevent selection if cancelled or already melted
                        if (rowData && (rowData.status === 'ยกเลิก' || (rowData.billNo && rowData.billNo.trim() !== ''))) {
                            datatable.row(idx).deselect();
                        }
                    });
                }
            })
            // Use event delegation for select all checkbox since it's dynamically created
            $(document).on('change', '#selectAllRows', function () {
                console.log('Select All Rows checkbox changed:', this.checked);
                if (this.checked) {
                    // Select all visible/filtered rows that are not cancelled and not melted
                    datatable.rows({ search: 'applied' }).every(function () {
                        const rowData = this.data();
                        // Only select if not cancelled and no billNo (not melted)
                        if (rowData.status !== 'ยกเลิก' && (!rowData.billNo || rowData.billNo.trim() === '')) {
                            this.select();
                        }
                    });
                } else {
                    datatable.rows().deselect();
                }
            });
        }

        async function initTransactionTable(selector) {
            transactionTable = $(selector).DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                scrollX: true,
                dom: "<'row justify-content-between'<'col-md-auto buttons-sec2'><'col-md-auto'f>>" +
                    "<'row mt-2'<'col-12't>>" +
                    "<'row justify-content-between mt-2'<'col-md-auto'i><'col-md-auto'p>>",
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/th.json',
                    emptyTable: "ยังไม่มีข้อมูลของวันที่ <b>" + moment().format('DD/MM/YYYY') + "</b> กรุณาเพิ่มข้อมูลการรับจ่าย",
                    processing: 'กำลังโหลดข้อมูล...',
                },
                pageLength: 30,
                ajax: function (data, callback, settings) {
                    NProgress.start();
                    try {
                        google.script.run.withSuccessHandler(function (response) {
                            response = JSON.parse(response);
                            console.log(response);
                            NProgress.done();
                            callback({
                                data: response,
                                recordsTotal: response.length,
                                recordsFiltered: response.length
                            });
                        }).withFailureHandler(function (error) {
                            NProgress.done();
                            isLoadAll = false;
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: error.message || error,
                            });
                        }).getTransactionData(isLoadAll, window.user.branch);
                    } catch {
                        NProgress.done();
                        callback({
                            data: [],
                            recordsTotal: 0,
                            recordsFiltered: 0
                        })
                    }

                },
                columns: [
                    {
                        data: null,
                        title: '#',
                        orderable: false,
                        searchable: false,
                        className: 'text-center text-nowrap',
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        data: 'date',
                        title: 'วันที่',
                        render: function (data) {
                            return moment(data).format('DD/MM/YYYY');
                        }
                    },
                    {
                        data: 'date',
                        title: 'เวลา',
                        render: function (data) {
                            return moment(data).format('HH:mm');
                        }
                    },
                    {
                        data: 'type',
                        title: 'ประเภท',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'item',
                        title: 'รายการ',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'bank',
                        title: 'ธนาคาร',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'amount',
                        title: 'ยอดเงิน',
                        render: function (data) {
                            return data ? parseFloat(data).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
                        }
                    },
                    {
                        data: 'note',
                        title: 'หมายเหตุ',
                        render: function (data) {
                            return data || '';
                        }
                    },
                    {
                        data: 'staff',
                        title: 'พนักงานบันทึก',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'branch',
                        title: 'สาขา',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'status',
                        title: 'สถานะ',
                        render: function (data, type, row) {
                            if (data === 'ยกเลิก') {
                                return `<button type="button" class="w-100 btn btn-sm text-blexk-50 text-nowrap" style="pointer-events: none;">
                                                <i class="bi bi-x-circle-fill"></i> ยกเลิก
                                            </button>`;
                            } else {
                                if (row.enableEdit) {
                                    return `<button type="button" class="w-100 btn btn-sm btn-success text-nowrap" onclick="cancelRow(this);">
                                                <i class="bi bi-check-circle-fill"></i> เสร็จสิ้น
                                            </button>`;
                                }
                                return `<button type="button" class="w-100 btn btn-sm btn-secondary text-nowrap" style="cursor: not-allowed; pointer-events: none;">
                                                <i class="bi bi-check-circle-fill"></i> เสร็จสิ้น
                                            </button>`;
                            }
                        }
                    }
                ],
                createdRow: function (row, data, dataIndex) {
                    $(row).addClass('text-nowrap');
                    if (data.status === 'ยกเลิก') {
                        $(row).find('td').css('font-weight', 300).css('color', '#ff0000');
                    }
                },
                initComplete: function (settings, json) {
                    NProgress.done();
                    $('.buttons-sec2').html(`
                        <div class="d-flex flex-wrap gap-2 w-100 mb-2 align-items-center" id="addSellDataActions" role="group">
                            <button class="btn btn-warning flex-fill text-nowrap d-flex align-items-center justify-content-center" data-bs-toggle="modal" data-bs-target="#addTransactionModal" id="addTransactionBtn">
                                <i class="bi bi-plus-circle-fill me-2"></i> เพิ่มข้อมูลการรับจ่าย
                            </button>
                        </div>
                    `);
                    $('#addTransactionBtn').on('click', function () {
                        addTransaction();
                    });
                },
                columnDefs: [
                    {
                        targets: '_all',
                        className: 'dt-head-center dt-head-nowrap text-center dt-body-center all',
                    }
                ]
            });

        }

        async function initBuySummaryTable(selector) {
            let table = $(selector)
            let tbody = table.find('tbody')
            let thead = table.find('thead')
            tbody.empty()
            thead.empty()
            goldSwal({
                icon: 'info',
                title: 'กำลังโหลดข้อมูล...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            });
            let data = await new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getBuySummaryData(true, window.user.branch);
            });
            data = JSON.parse(data);
            console.log('Buy Summary Data:', data);
            let { buyData, allSellers } = data;
            allSellers = allSellers.map(seller => seller || 'ไม่ระบุ').sort((a, b) => a.localeCompare(b, 'th', { sensitivity: 'base' }));
            thead.append($('<tr><th class="text-center">#</th><th class="text-center">เดือน/ปี</th></tr>').append(
                allSellers.map(seller => `<th class="text-center">${seller}</th>`).join('') + `<th class="text-end">รวม</th>`
            ));
            thead
            tbody.append(
                buyData.length === 0
                    ? $('<tr>').append($('<td colspan="' + (allSellers.length + 3) + '" class="text-center">ไม่มีข้อมูล</td>'))
                    : buyData.map((item, index) => {
                        return $('<tr>').append(
                            `<td class="text-center">${index + 1}</td>`,
                            `<td class="text-center">${item.monthYear}</td>`,
                            allSellers.map(seller => {
                                let value = item.sellers[seller] || 0;
                                return `<td class="text-end">${parseInt(value)}</td>`;
                            }).join(''),
                            `<td class="text-end">${parseInt(Object.values(item.sellers || {}).reduce((a, b) => a + b, 0))}</td>`
                        );
                    })
            );
            Swal.close();
        }

        async function initMeltTable(selector) {
            meltTable = $(selector).DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                scrollX: true,
                dom: "<'row justify-content-between'<'col-md-auto buttons-sec3'><'col-md-auto filter-sec3'>>" +
                    "<'row mt-2'<'col-12't>>" +
                    "<'row justify-content-between mt-2'<'col-md-auto'i><'col-md-auto'p>>",
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/th.json',
                    emptyTable: "ยังไม่มีข้อมูลบิลหลอม",
                    processing: 'กำลังโหลดข้อมูล...',
                },
                select: {
                    style: 'multi+shift',
                    selector: 'td:nth-child(2)'
                },
                pageLength: 30,
                ajax: function (data, callback, settings) {
                    NProgress.start();
                    try {
                        google.script.run.withSuccessHandler(function (response) {
                            response = JSON.parse(response);
                            console.log('Melt Data:', response);
                            NProgress.done();
                            callback({
                                data: response,
                                recordsTotal: response.length,
                                recordsFiltered: response.length
                            });
                        }).withFailureHandler(function (error) {
                            NProgress.done();
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: error.message || error,
                            });
                        }).getMeltData(window.user.branch);
                    } catch {
                        NProgress.done();
                        callback({
                            data: [],
                            recordsTotal: 0,
                            recordsFiltered: 0
                        })
                    }
                },
                columns: [
                    {
                        data: null,
                        title: '#',
                        orderable: false,
                        searchable: false,
                        className: 'text-center text-nowrap all',
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        data: null,
                        title: 'เลือก <input type="checkbox" id="selectAllMeltRows" />',
                        visible: false,
                        orderable: false,
                        searchable: false,
                        className: 'text-center text-nowrap select-checkbox all',
                        render: function (data, type, row) {
                            return '';
                        }
                    },
                    {
                        data: 'date',
                        title: 'วันที่',
                        render: function (data) {
                            return moment(data).format('DD/MM/YYYY');
                        }
                    },
                    {
                        data: 'date',
                        title: 'เวลา',
                        render: function (data) {
                            return moment(data).format('HH:mm');
                        }
                    },
                    {
                        data: 'billNo',
                        title: 'หมายเลขบิล',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'meltType',
                        title: 'หมวดหมู่',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'beforeWeight',
                        title: 'น้ำหนักก่อนหลอม (กรัม)',
                        render: function (data) {
                            return data ? parseFloat(data).toFixed(2) : '0.00';
                        }
                    },
                    {
                        data: 'buyPrice',
                        title: 'ยอดซื้อ (บาท)',
                        render: function (data) {
                            return data ? parseInt(data).toLocaleString('th-TH') : '0';
                        }
                    },
                    {
                        data: 'afterWeight',
                        title: 'น้ำหนักหลังหลอม (กรัม)',
                        render: function (data) {
                            return data ? parseFloat(data).toFixed(2) : '-';
                        }
                    },
                    {
                        data: 'percentAfterMelt',
                        title: '% ที่ได้',
                        render: function (data) {
                            return data ? parseFloat(data).toFixed(1) + '%' : '-';
                        }
                    },
                    {
                        data: 'percentCalc',
                        title: '% คำนวณ',
                        render: function (data) {
                            return data ? parseFloat(data).toFixed(1) + '%' : '-';
                        }
                    },
                    {
                        data: 'sellPrice',
                        title: 'ยอดขาย (บาท)',
                        visible: window.user.role === 'admin',
                        render: function (data) {
                            return data ? parseInt(data).toLocaleString('th-TH') : '-';
                        }
                    },
                    {
                        data: 'recorder',
                        title: 'ผู้บันทึก',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'branch',
                        title: 'สาขา',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'sellBillNo',
                        title: 'บิลขายที่สร้าง',
                        visible: false,
                    },
                    {
                        data: null,
                        title: 'การดำเนินการ',
                        orderable: false,
                        searchable: false,
                        render: function (data, type, row) {
                            let buttons = '';

                            // แก้ไขข้อมูล - ทุกคนสามารถแก้ไขได้ (แต่สิทธิ์จะแตกต่างกัน)
                            if (row.enableEdit) {
                                buttons += '<button type="button" class="btn btn-sm btn-warning me-1 mb-1" onclick="editMeltBill(this);">' +
                                    '<i class="bi bi-pencil-square"></i> แก้ไข</button>';
                            }

                            // ยกเลิกบิล - เฉพาะ admin
                            if (window.user.role === 'admin' && row.status !== 'ยกเลิก') {
                                buttons += '<button type="button" class="btn btn-sm btn-danger mb-1" onclick="cancelMeltBill(this);">' +
                                    '<i class="bi bi-x-circle"></i> ยกเลิก</button>';
                            }

                            return buttons || '<span class="text-muted">-</span>';
                        }
                    }
                ],
                createdRow: function (row, data, dataIndex) {
                    $(row).addClass('text-nowrap');
                    if (data.status === 'ยกเลิก') {
                        $(row).find('td').css('font-weight', 300).css('color', '#ff0000');
                    }
                },
                initComplete: function (settings, json) {
                    NProgress.done();
                    $('.buttons-sec3').html(`
                        <div class="d-flex flex-wrap gap-2 w-100 mb-2 align-items-center" id="addSellBill" role="group">
                            <button class="btn btn-warning flex-fill text-nowrap d-flex align-items-center justify-content-center" id="createSellBillBtn">
                                <i class="bi bi-file-earmark-plus-fill me-2"></i> บันทึกบิลขาย
                            </button>
                        </div>
                        <div class="d-none flex-wrap gap-2 w-100 mb-2 align-items-center" id="sellBillActions" role="group">
                            <button class="btn btn-primary flex-fill text-nowrap d-flex align-items-center justify-content-center" id="createSellBillBtn" data-bs-toggle="modal" data-bs-target="#sellBillModal">
                                <i class="bi bi-file-earmark-plus-fill me-2"></i> สร้างบิลขาย
                            </button>
                            <button class="btn btn-outline-secondary flex-fill text-nowrap d-flex align-items-center justify-content-center" id="cancelSellBillSelectionBtn" onclick="meltTable.rows({ selected: true }).deselect(); showTableButtons('addSellBill');meltTable.column(1).visible(false);meltTable.column(14).search('').draw();reloadTable('#meltTable');">
                                <i class="bi bi-x-circle me-2"></i> ยกเลิกการเลือก
                            </button>
                        </div>
                    `);

                    $('.filter-sec3').html(`
                        <div class="d-flex flex-wrap gap-2 w-100 mb-2 align-items-center" id="filterMeltActions" role="group">
                            <input type="search" class="form-control rounded-3" id="searchMeltText" placeholder="ค้นหาข้อมูลบิลหลอม...">
                        </div>
                    `);
                    $('#createSellBillBtn').on('click', function () {
                        createSellBillBtn();
                    });
                    $('#searchMeltText').on('input', function () {
                        meltTable.search(this.value).draw();
                    });
                },
                columnDefs: [
                    {
                        targets: '_all',
                        className: 'dt-head-center dt-head-nowrap text-center dt-body-center all',
                    }
                ]
            });

            $(document).on('change', '#selectAllMeltRows', function () {
                console.log('Select All Melt Rows checkbox changed:', this.checked);
                if (this.checked) {
                    // Select all visible/filtered rows
                    meltTable.rows({ search: 'applied' }).select();
                } else {
                    meltTable.rows().deselect();
                }
            });

        }

        async function initSellBillTable(selector) {
            sellBillTable = $(selector).DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                scrollX: true,
                dom: "<'row justify-content-between'<'col-md-auto buttons-sec4'><'col-md-auto filter-sec4'>>" +
                    "<'row mt-2'<'col-12't>>" +
                    "<'row justify-content-between mt-2'<'col-md-auto'i><'col-md-auto'p>>",
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/2.3.2/i18n/th.json',
                    emptyTable: "ยังไม่มีข้อมูลบิลขาย",
                    processing: 'กำลังโหลดข้อมูล...',
                },
                // select: {
                //     style: 'multi+shift',
                //     selector: 'td:nth-child(2)'
                // },
                pageLength: 30,
                ajax: function (data, callback, settings) {
                    NProgress.start();
                    try {
                        google.script.run.withSuccessHandler(function (response) {
                            response = JSON.parse(response);
                            console.log('Sell Bill Data:', response);
                            NProgress.done();
                            callback({
                                data: response,
                                recordsTotal: response.length,
                                recordsFiltered: response.length
                            });
                        }).withFailureHandler(function (error) {
                            NProgress.done();
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: error.message || error,
                            });
                        }).getSellBillData(window.user.branch);
                    } catch {
                        NProgress.done();
                        callback({
                            data: [],
                            recordsTotal: 0,
                            recordsFiltered: 0
                        })
                    }
                },
                columns: [
                    {
                        data: null,
                        title: '#',
                        orderable: false,
                        searchable: false,
                        className: 'text-center text-nowrap all',
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    // {
                    //     data: null,
                    //     title: 'เลือก <input type="checkbox" id="selectAllMeltRows" />',
                    //     visible: false,
                    //     orderable: false,
                    //     searchable: false,
                    //     className: 'text-center text-nowrap select-checkbox all',
                    //     render: function (data, type, row) {
                    //         return '';
                    //     }
                    // },
                    {
                        data: 'date',
                        title: 'วันที่',
                        render: function (data) {
                            return moment(data).format('DD/MM/YYYY');
                        }
                    },
                    {
                        data: 'date',
                        title: 'เวลา',
                        render: function (data) {
                            return moment(data).format('HH:mm');
                        }
                    },
                    {
                        data: 'summaryWeightBefore',
                        title: 'นน.รวมก่อนหลอม',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'summaryWeightAfter',
                        title: 'นน.รวมหลังหลอม',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'percentCalc',
                        title: '% คำนวณ',
                        render: function (data) {
                            return data ? parseFloat(data).toFixed(2) : '0.00';
                        }
                    },
                    {
                        data: 'summaryPrice',
                        title: 'ยอดซื้อรวม (บาท)',
                        render: function (data) {
                            return data ? parseInt(data).toLocaleString('th-TH') : '0';
                        }
                    },
                    {
                        data: 'sellPercentAfterMelt',
                        title: '% ที่ได้',
                        render: function (data) {
                            return data ? parseFloat(data).toFixed(1) + '%' : '-';
                        }
                    },
                    {
                        data: 'sellPrice',
                        title: 'ยอดขาย (บาท)',
                        visible: window.user.role === 'admin',
                        render: function (data) {
                            return data ? parseInt(data).toLocaleString('th-TH') : '-';
                        }
                    },
                    {
                        data: 'sellBillBank',
                        title: 'ธนาคาร',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'sellBillNote',
                        title: 'หมายเหตุ',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: 'recorder',
                        title: 'ผู้บันทึก',
                        render: function (data) {
                            return data || 'ไม่ระบุ';
                        }
                    },
                    {
                        data: null,
                        title: 'การดำเนินการ',
                        orderable: false,
                        searchable: false,
                        render: function (data, type, row) {
                            let buttons = '';
                            buttons += '<button type="button" class="btn btn-sm btn-warning me-1 mb-1" onclick="editSellBill(this);">' +
                                '<i class="bi bi-pencil-square"></i> แก้ไข</button>';
                            buttons += '<button type="button" class="btn btn-sm btn-danger mb-1" onclick="cancelSellBill(this);">' +
                                '<i class="bi bi-x-circle"></i> ยกเลิก</button>';
                            return buttons || '<span class="text-muted">-</span>';
                        }
                    }
                ],
                createdRow: function (row, data, dataIndex) {
                    $(row).addClass('text-nowrap');
                    if (data.status === 'ยกเลิก') {
                        $(row).find('td').css('font-weight', 300).css('color', '#ff0000');
                    }
                },
                initComplete: function (settings, json) {
                    NProgress.done();
                    // $('.buttons-sec3').html(`
                    //     <div class="d-flex flex-wrap gap-2 w-100 mb-2 align-items-center" id="addSellBill" role="group">
                    //         <button class="btn btn-warning flex-fill text-nowrap d-flex align-items-center justify-content-center" id="createSellBillBtn">
                    //             <i class="bi bi-file-earmark-plus-fill me-2"></i> บันทึกบิลขาย
                    //         </button>
                    //     </div>
                    //     <div class="d-none flex-wrap gap-2 w-100 mb-2 align-items-center" id="sellBillActions" role="group">
                    //         <button class="btn btn-primary flex-fill text-nowrap d-flex align-items-center justify-content-center" id="createSellBillBtn" data-bs-toggle="modal" data-bs-target="#sellBillModal">
                    //             <i class="bi bi-file-earmark-plus-fill me-2"></i> สร้างบิลขาย
                    //         </button>
                    //         <button class="btn btn-outline-secondary flex-fill text-nowrap d-flex align-items-center justify-content-center" id="cancelSellBillSelectionBtn" onclick="meltTable.rows({ selected: true }).deselect(); showTableButtons('addSellBill');meltTable.column(1).visible(false);reloadTable('#meltTable');">
                    //             <i class="bi bi-x-circle me-2"></i> ยกเลิกการเลือก
                    //         </button>
                    //     </div>
                    // `);

                    $('.filter-sec4').html(`
                        <div class="d-flex flex-wrap gap-2 w-100 mb-2 align-items-center" id="filterSellActions" role="group">
                            <input type="search" class="form-control rounded-3" id="searchSellText" placeholder="ค้นหาข้อมูลบิลขาย...">
                        </div>
                    `);
                    $('#createSellBillBtn').on('click', function () {
                        createSellBillBtn();
                    });
                    $('#searchSellText').on('input', function () {
                        meltTable.search(this.value).draw();
                    });
                },
                columnDefs: [
                    {
                        targets: '_all',
                        className: 'dt-head-center dt-head-nowrap text-center dt-body-center all',
                    }
                ]
            });

            $(document).on('change', '#selectAllMeltRows', function () {
                console.log('Select All Melt Rows checkbox changed:', this.checked);
                if (this.checked) {
                    // Select all visible/filtered rows
                    meltTable.rows({ search: 'applied' }).select();
                } else {
                    meltTable.rows().deselect();
                }
            });

        }



        function createSellBillBtn() {
            meltTable.column(14).search('^$', true, false).draw();
            meltTable.column(1).visible(true);
            showTableButtons('sell');
        }


        function showTableButtons(buttonsToShow) {
            const buttons = {
                add: $('#addSellDataActions'),
                melt: $('#meltBillActions'),
                sell: $('#sellBillActions'),
                addSellBill: $('#addSellBill')
            };

            // Hide all buttons first
            Object.values(buttons).forEach(btn => btn.removeClass('d-flex').addClass('d-none'));

            // Show specific buttons based on the parameter
            switch (buttonsToShow) {
                case 'add':
                    buttons.add.addClass('d-flex').removeClass('d-none');
                    break;
                case 'melt':
                    buttons.melt.addClass('d-flex').removeClass('d-none');
                    break;
                case 'both':
                    buttons.add.addClass('d-flex').removeClass('d-none');
                    buttons.melt.addClass('d-flex').removeClass('d-none');
                    break;
                case 'sell':
                    buttons.sell.addClass('d-flex').removeClass('d-none');
                    break;
                case 'addSellBill':
                    buttons.addSellBill.addClass('d-flex').removeClass('d-none');
                    break;
            }
        }

        function submitForm(e) {
            e.preventDefault();
            const form = document.getElementById('goldForm');
            const data = {
                date: $('#date').data('date') || moment().format('YYYY-MM-DD'),
                category: form.category.value,
                product: form.product.value,
                weight: form.weight.value,
                price: form.price.value,
                bank: form.bank.value,
                seller: window.user.name,
                branch: window.user.branch || 'สาขาหลัก',
            };
            console.log('Submitting form data:', data);
            NProgress.start();
            goldSwal({
                title: 'กำลังบันทึกข้อมูล...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            google.script.run.withSuccessHandler(function () {
                NProgress.done();
                reloadTable('#goldTable', false);
                refreshDashboard(); // อัปเดต Dashboard
                goldSwal({
                    icon: 'success',
                    title: 'บันทึกข้อมูลสำเร็จ',
                    showConfirmButton: false,
                    timer: 1500
                });
                $('#addSellDataModal').modal('hide');

            }).withFailureHandler(function (error) {
                NProgress.done();
                goldSwal({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    html: error.message || error,
                });
            }).saveSellData(data);
        }

        function cancelRow(button) {
            const row = $(button).closest('tr');
            let table = $(button).closest('table');
            let table_id = table.attr('id')
            const data = table.DataTable().row(row).data();
            console.log('Cancelling row data:', data);
            if (!data) return;
            let html
            if (table_id === 'goldTable') {
                html = `
                    <div class="container-fluid">
                        <p>คุณต้องการยกเลิกข้อมูลนี้ใช่หรือไม่?</p>
                        <table class="table table-bordered table-sm mb-4 table-light" style="border-color:#d4af37;">
                            <tbody>
                                <tr>
                                    <th style="width:120px;color:#d4af37;">วันที่</th>
                                    <td>${moment(data.date).format('DD/MM/YYYY')}</td>
                                </tr>
                                <tr>
                                    <th style="color:#d4af37;">สินค้า</th>
                                    <td>${data.product}</td>
                                </tr>
                                <tr>
                                    <th style="color:#d4af37;">น้ำหนัก</th>
                                    <td>${parseFloat(data.weight).toFixed(2)} กรัม</td>
                                </tr>
                                <tr>
                                    <th style="color:#d4af37;">ยอดซื้อ</th>
                                    <td>${parseInt(data.price).toLocaleString('th-TH')} บาท</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `
            } else if (table_id === 'transactionTable') {
                html = `
                    <div class="container-fluid">
                        <p>คุณต้องการยกเลิกข้อมูลนี้ใช่หรือไม่?</p>
                        <table class="table table-bordered table-sm mb-4 table-light" style="border-color:#d4af37;">
                            <tbody>
                                <tr>
                                    <th style="width:120px;color:#d4af37;">วันที่</th>
                                    <td>${moment(data.date).format('DD/MM/YYYY')}</td>
                                </tr>
                                <tr>
                                    <th style="color:#d4af37;">ประเภท</th>
                                    <td>${data.type || ''}</td>
                                </tr>
                                <tr>
                                    <th style="color:#d4af37;">รายการ</th>
                                    <td>${data.item || ''}</td>
                                </tr>
                                <tr>
                                    <th style="color:#d4af37;">ยอดเงิน</th>
                                    <td>
                                        ${data.type === 'รับ'
                        ? '+'
                        : data.type === 'จ่าย'
                            ? '-'
                            : ''
                    }
                                        ${data.amount ? parseFloat(data.amount).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00'} บาท
                                    </td>
                                </tr>
                                <tr>
                                    <th style="color:#d4af37;">หมายเหตุ</th>
                                    <td>${data.note || ''}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `

            }

            goldSwal({
                title: 'ยืนยันการยกเลิก',
                html: html,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ปิด',
                showLoadingOnConfirm: true,
            }).then((result) => {
                if (result.isConfirmed) {
                    NProgress.start();
                    goldSwal({
                        title: 'กำลังยกเลิกข้อมูล...',
                        text: 'กรุณารอสักครู่',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    google.script.run.withSuccessHandler(function (res) {
                        NProgress.done();
                        res = JSON.parse(res);
                        if (!res.success) {
                            goldSwal({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                html: res.message || 'ไม่สามารถยกเลิกข้อมูลได้',
                            });
                            return;
                        }
                        reloadTable('#' + table_id);
                        refreshDashboard(); // อัปเดต Dashboard
                        goldSwal({
                            icon: 'success',
                            title: 'ยกเลิกข้อมูลสำเร็จ',
                            title: res.message || 'ข้อมูลถูกยกเลิกเรียบร้อยแล้ว',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    }).withFailureHandler(function (error) {
                        NProgress.done();
                        goldSwal({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            html: error.message || error,
                        });
                    })[table_id === 'goldTable' ? 'cancelSellData' : 'cancelTransaction'](data.uuid, window.user.name);
                }
            });
        }
        let isLoadAll = false;
        function reloadTable(selector, isAll = false) {
            isLoadAll = isAll || false;
            if (DataTable.isDataTable(selector)) {
                // clear the table before reloading
                $(selector).DataTable().clear().draw();
                $(selector).DataTable().ajax.reload();
            } else {
                initDataTable(selector);
            }
        }

        // Functions for Melt Bill Management
        function editMeltBill(button) {
            const row = $(button).closest('tr');
            const data = meltTable.row(row).data();

            if (!data) return;

            // Fill modal with current data
            $('#editBillNo').val(data.billNo);
            $('#editBeforeWeight').val(data.beforeWeight);
            $('#editAfterWeight').val(data.afterWeight || '');
            $('#editPercentAfterMelt').val(data.percentAfterMelt || '');
            $('#editSellPrice').val(data.sellPrice || '').parent().css('display', window.user.role === 'admin' ? 'block' : 'none');

            // Store current data for form submission
            $('#editMeltBillForm').data('currentData', data);

            $('#editMeltBillModal').modal('show');
        }

        function editSellBill(button) {
            const row = $(button).closest('tr');
            const data = sellBillTable.row(row).data(); // Assuming sell bills are displayed in melt table or similar

            if (!data) return;

            // Fill modal with current data
            $('#editSellBillNo').val(data.sellBillNo || data.billNo);
            // $('#editSellBillDate')._flatpickr.setDate(data.date || moment().format('YYYY-MM-DD'));
            $('#editSellPercentAfterMelt').val(data.sellPercentAfterMelt || data.percentAfterMelt || '');
            $('#editSellBillPrice').val(data.sellPrice || '');
            $('#editSellBillStatus').val(data.sellBillStatus || '');
            $('#editSellBillBank').val(data.sellBillBank || '');
            $('#editSellBillNote').val(data.sellBillNote || '');
            flatpickr('#editSellBillDate', {
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'd/m/Y',
                defaultDate: data.date || moment().format('YYYY-MM-DD'),
                locale: 'th'
            });

            // Store current data for form submission
            $('#editSellBillForm').data('currentData', data);

            $('#editSellBillModal').modal('show');
        }

        function submitEditSellBillForm(e) {
            e.preventDefault();
            const form = document.getElementById('editSellBillForm');
            const currentData = $('#editSellBillForm').data('currentData');

            const updateData = {
                sellBillDate: $('#editSellBillDate').data('date') || moment().format('YYYY-MM-DD'),
                sellPercentAfterMelt: form.editSellPercentAfterMelt.value,
                sellPrice: form.editSellBillPrice.value,
                sellBillStatus: form.editSellBillStatus.value,
                sellBillBank: form.editSellBillBank.value,
                sellBillNote: form.editSellBillNote.value
            };

            NProgress.start();
            goldSwal({
                title: 'กำลังบันทึกการแก้ไข...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            google.script.run.withSuccessHandler(function (response) {
                NProgress.done();
                const result = JSON.parse(response);

                if (result.success) {
                    goldSwal({
                        icon: 'success',
                        title: 'แก้ไขข้อมูลสำเร็จ',
                        text: result.message,
                        showConfirmButton: false,
                        timer: 1500
                    });
                    $('#editSellBillModal').modal('hide');
                    reloadTable('#sellBillTable'); // Reload the appropriate table
                    refreshDashboard(); // อัปเดต Dashboard
                } else {
                    goldSwal({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: result.message
                    });
                }
            }).withFailureHandler(function (error) {
                NProgress.done();
                goldSwal({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message || error
                });
            }).updateSellBill(currentData.sellBillNo || currentData.billNo, updateData, window.user.name);
        }

        function submitEditMeltBillForm(e) {
            e.preventDefault();
            const form = document.getElementById('editMeltBillForm');
            const currentData = $('#editMeltBillForm').data('currentData');

            const updateData = {
                afterWeight: form.editAfterWeight.value,
                sellPrice: form.editSellPrice.value,
                percentAfterMelt: form.editPercentAfterMelt.value
            };

            NProgress.start();
            goldSwal({
                title: 'กำลังบันทึกการแก้ไข...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            google.script.run.withSuccessHandler(function (response) {
                NProgress.done();
                const result = JSON.parse(response);

                if (result.success) {
                    goldSwal({
                        icon: 'success',
                        title: 'แก้ไขข้อมูลสำเร็จ',
                        text: result.message,
                        showConfirmButton: false,
                        timer: 1500
                    });
                    $('#editMeltBillModal').modal('hide');
                    reloadTable('#meltTable');
                    refreshDashboard(); // อัปเดต Dashboard
                } else {
                    goldSwal({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: result.message
                    });
                }
            }).withFailureHandler(function (error) {
                NProgress.done();
                goldSwal({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message || error
                });
            }).updateMeltBill(currentData.billNo, updateData, window.user.name);
        }

        function cancelMeltBill(button) {
            const row = $(button).closest('tr');
            const data = meltTable.row(row).data();

            if (!data) return;

            goldSwal({
                title: 'ยืนยันการยกเลิกบิลหลอม',
                html: `
                    <div class="container-fluid">
                        <p>คุณต้องการยกเลิกบิลหลอมนี้ใช่หรือไม่?</p>
                        <table class="table table-bordered table-sm mb-4 table-light" style="border-color:#d4af37;">
                            <tbody>
                                <tr><td class="fw-bold">หมายเลขบิล:</td><td>${data.billNo}</td></tr>
                                <tr><td class="fw-bold">น้ำหนักก่อนหลอม:</td><td>${data.beforeWeight ? parseFloat(data.beforeWeight).toFixed(2) : '0.00'} กรัม</td></tr>
                                <tr><td class="fw-bold">น้ำหนักหลังหลอม:</td><td>${data.afterWeight ? parseFloat(data.afterWeight).toFixed(2) : '-'} กรัม</td></tr>
                                <tr><td class="fw-bold">ยอดขาย:</td><td>${data.sellPrice ? parseInt(data.sellPrice).toLocaleString('th-TH') : '-'} บาท</td></tr>
                                <tr><td class="fw-bold">ผู้บันทึก:</td><td>${data.recorder}</td></tr>
                            </tbody>
                        </table>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>คำเตือน:</strong> การยกเลิกบิลหลอมจะทำให้ข้อมูลการซื้อที่เกี่ยวข้องกลับสู่สถานะ "รอหลอม" และไม่สามารถย้อนกลับได้
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ยืนยันยกเลิก',
                cancelButtonText: 'ปิด',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    NProgress.start();
                    goldSwal({
                        title: 'กำลังยกเลิกบิลหลอม...',
                        text: 'กรุณารอสักครู่',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    google.script.run.withSuccessHandler(function (response) {
                        NProgress.done();
                        const result = JSON.parse(response);

                        if (result.success) {
                            goldSwal({
                                icon: 'success',
                                title: 'ยกเลิกบิลหลอมสำเร็จ',
                                text: result.message,
                                showConfirmButton: false,
                                timer: 1500
                            });
                            reloadTable('#meltTable');
                            refreshDashboard(); // อัปเดต Dashboard
                        } else {
                            goldSwal({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: result.message
                            });
                        }
                    }).withFailureHandler(function (error) {
                        NProgress.done();
                        goldSwal({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: error.message || error
                        });
                    }).cancelMeltBill(data.billNo, window.user.name);
                }
            });
        }

        function cancelSellBill(button) {
            const row = $(button).closest('tr');
            const data = sellBillTable.row(row).data();

            if (!data) return;

            goldSwal({
                title: 'ยืนยันการยกเลิกบิลขาย',
                html: `
                    <div class="container-fluid">
                        <p>คุณต้องการยกเลิกบิลขายนี้ใช่หรือไม่?</p>
                        <table class="table table-bordered table-sm mb-4 table-light" style="border-color:#d4af37;">
                            <tbody>
                                <tr><td class="fw-bold">หมายเลขบิล:</td><td>${data.sellBillNo || data.billNo}</td></tr>
                                <tr><td class="fw-bold">ยอดขาย:</td><td>${data.sellPrice ? parseInt(data.sellPrice).toLocaleString('th-TH') : '-'} บาท</td></tr>
                                <tr><td class="fw-bold">ผู้บันทึก:</td><td>${data.recorder}</td></tr>
                            </tbody>
                        </table>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ยืนยันยกเลิก',
                cancelButtonText: 'ปิด',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    NProgress.start();
                    goldSwal({
                        title: 'กำลังยกเลิกบิลขาย...',
                        text: 'กรุณารอสักครู่',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    google.script.run.withSuccessHandler(function (response) {
                        NProgress.done();
                        const result = JSON.parse(response);

                        if (result.success) {
                            goldSwal({
                                icon: 'success',
                                title: 'ยกเลิกบิลขายสำเร็จ',
                                text: result.message,
                                showConfirmButton: false,
                                timer: 1500
                            });
                            reloadTable('#sellBillTable');
                            refreshDashboard(); // อัปเดต Dashboard
                        } else {
                            goldSwal({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: result.message
                            });
                        }
                    }).withFailureHandler(function (error) {
                        NProgress.done();
                        goldSwal({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: error.message || error
                        });
                    }).cancelSellBill(data.sellBillNo || data.billNo, window.user.name);
                }
            });
        }

    </script>
    <script>
        function createMeltBillBtn() {
            // goldSwal({
            //     title: 'กรุณาใส่รหัสผ่าน',
            //     input: 'password',
            //     inputPlaceholder: 'รหัสผ่าน',
            //     showCancelButton: true,
            //     confirmButtonText: 'ยืนยัน',
            //     cancelButtonText: 'ยกเลิก',
            //     preConfirm: async (password) => {
            //         if (!password) {
            //             Swal.showValidationMessage('กรุณากรอกรหัสผ่าน');
            //         }
            //         Swal.showLoading();
            //         let validPassword = await new Promise((resolve, reject) => {
            //             google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).validatePassword(password);
            //         });
            //         if (!validPassword) {
            //             Swal.showValidationMessage('รหัสผ่านไม่ถูกต้อง');
            //             return false;
            //         }
            //         return true;
            //     }
            // }).then((result) => {
            //     if (result.isConfirmed && result.value) {
            reloadTable('#goldTable', true);
            datatable.column(1).visible(true);
            showTableButtons('melt');
            //     }
            // });
        }

        // Fill selected rows table when modal is shown
        $('#meltBillModal').on('shown.bs.modal', function () {
            let selectedRows = datatable ? datatable.rows({ selected: true }).data().toArray() : [];
            console.log('selectedRows', selectedRows);
            let isSameType = selectedRows.every(row => row.category === selectedRows[0].category);
            if (!isSameType) {
                goldSwal({
                    icon: 'warning',
                    title: 'ข้อมูลไม่ถูกต้อง',
                    html: 'กรุณาเลือกแถวที่มีประเภทสินค้าเดียวกันเท่านั้น',
                });
                $('#meltBillModal').modal('hide');
                return;
            }
            if (selectedRows.length === 0) {
                goldSwal({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูลที่เลือก',
                    text: 'กรุณาเลือกแถวที่ต้องการสร้างบิลหลอมก่อน',
                });
                $('#meltBillModal').modal('hide');
                return;
            }
            let $tbody = $('#selectedRowsTable tbody');
            let tbodyHtml = ''
            selectedRows.forEach(row => {
                console.log('row', row);
                tbodyHtml += `
                                <tr>
                                    <td>${row.product || ''}</td>
                                    <td>${row.weight ? parseFloat(row.weight).toFixed(2) : '0.00'}</td>
                                    <td>${row.price ? parseInt(row.price).toLocaleString('th-TH') : '0'}</td>
                                </tr>
                            `;
            });
            $tbody.html(tbodyHtml);
            // Update summary
            let totalWeight = 0, totalPrice = 0, sumPercentWeight = 0;
            selectedRows.forEach(row => {
                console.log('Calculating row', row);
                totalWeight += parseFloat(row.weight) || 0;
                totalPrice += parseFloat(row.price) || 0;
                sumPercentWeight += parseFloat(row.percentWeight) || 0;
            });
            let percentCalc = (sumPercentWeight/totalWeight) || '-';
            $('#summaryWeight').text(totalWeight.toFixed(2));
            $('#summaryPrice').text(totalPrice.toLocaleString('th-TH', { maximumFractionDigits: 2 }));
            $('#meltSellPrice').parent().css('display', window.user.role === 'admin' ? 'block' : 'none');
            $('#summaryCount').text(selectedRows.length);
            $('#meltType').text(selectedRows[0].category || 'ไม่ระบุ');
            $('#meltPercentCalc').text(percentCalc.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
        })
            .on('hidden.bs.modal', function () {
                $('#selectedRowsTable tbody').empty();
                $('#summaryWeight').text('0.00');
                $('#summaryPrice').text('0');
            });

        $('#sellBillModal').on('shown.bs.modal', function () {
            let selectedRows = meltTable.rows({ selected: true }).data().toArray();
            console.log('selectedRows for Sell Bill', selectedRows);
            if (selectedRows.length === 0) {
                goldSwal({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูลที่เลือก',
                    text: 'กรุณาเลือกแถวที่ต้องการสร้างบิลขายก่อน',
                });
                $('#sellBillModal').modal('hide');
                return;
            }
            let $tbody = $('#sellBillSelectedRowsTable tbody');
            let tbodyHtml = '';
            selectedRows.forEach(row => {
                tbodyHtml += `
                                <tr>
                                    <td>${row.billNo || ''}</td>
                                    <td>${row.meltType || ''}</td>
                                    <td>${row.beforeWeight ? parseFloat(row.beforeWeight).toFixed(2) : '0.00'}</td>
                                    <td>${row.afterWeight ? parseFloat(row.afterWeight).toFixed(2) : '0.00'}</td>
                                    <td>${row.percentAfterMelt ? parseFloat(row.percentAfterMelt).toFixed(1) + '%' : '0.0%'}</td>
                                    <td>${row.buyPrice ? parseInt(row.buyPrice).toLocaleString('th-TH') : '0'}</td>
                                </tr>
                            `;
            });
            $tbody.html(tbodyHtml);
            // Update summary
            let totalWeightBefore = 0, totalWeightAfter = 0, totalPrice = 0;
            selectedRows.forEach(row => {
                totalWeightBefore += parseFloat(row.beforeWeight) || 0;
                totalWeightAfter += parseFloat(row.afterWeight) || 0;
                totalPrice += parseFloat(row.buyPrice) || 0;
            });
            $('#sellSummaryWeightBefore').text(totalWeightBefore.toFixed(2));
            $('#sellSummaryWeightAfter').text(totalWeightAfter.toFixed(2));
            $('#sellSummaryPrice').text(totalPrice.toLocaleString('th-TH', { maximumFractionDigits: 2 }));
            $('#sellSummaryCount').text(selectedRows.length);
            console.log(moment().format('YYYY-MM-DD'));
            flatpickr("#sellBillDate", {
                locale: "th",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d/m/Y",
                defaultDate: moment().format('YYYY-MM-DD'),
                onReady: function (selectedDates, dateStr, instance) {
                    // Style the input with gold theme
                    instance.altInput.style.borderColor = '#d4af37';
                    instance.altInput.style.background = '#fff';
                    instance.altInput.style.color = '#232526';
                }
            });

            flatpickr("#editSellBillDate", {
                locale: "th",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d/m/Y",
                onReady: function (selectedDates, dateStr, instance) {
                    // Style the input with gold theme
                    instance.altInput.style.borderColor = '#d4af37';
                    instance.altInput.style.background = '#fff';
                    instance.altInput.style.color = '#232526';
                },
                onChange: function (selectedDates, dateStr, instance) {
                    // Update the data attribute when date changes
                    $('#editSellBillDate').data('date', dateStr);
                }
            });

        })
            .on('hidden.bs.modal', function () {
                $('#sellBillSelectedRowsTable tbody').empty();
                $('#sellSummaryWeightBefore').text('0.00');
                $('#sellSummaryWeightAfter').text('0.00');
                $('#sellSummaryPrice').text('0');
                $('#sellBillDate')[0]._flatpickr.destroy();
            });

        $('#meltBillForm').on('submit', function (e) {
            e.preventDefault();
            const form = $(this);
            const meltData = {
                meltWeight: form.find('#meltWeight').val(),
                beforeMeltWeight: parseFloat($('#summaryWeight').text()),
                buyPrice: parseFloat($('#summaryPrice').text().replace(/,/g, '')),
                meltSellPrice: form.find('#meltSellPrice').val(),
                recorder: window.user.name,
                branch: window.user.branch || 'สาขาหลัก',
                meltType: $('#meltType').text().trim(),
                percentAfterMelt: form.find('#meltPercentAfterMelt').val(),
                selectedRows: datatable ? datatable.rows({ selected: true }).data().toArray().map(row => row.uuid) : []
            };
            if (meltData.selectedRows.length === 0) {
                goldSwal({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูลที่เลือก',
                    text: 'กรุณาเลือกแถวที่ต้องการสร้างบิลหลอมก่อน',
                });
                return;
            }
            NProgress.start();
            goldSwal({
                title: 'กำลังบันทึกบิลหลอม...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            console.log('meltData', meltData);
            google.script.run.withSuccessHandler(function (res) {
                NProgress.done();
                res = JSON.parse(res);
                if (!res.success) {
                    goldSwal({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        html: res.message || 'ไม่สามารถบันทึกบิลหลอมได้',
                    });
                    return;
                }
                reloadTable();
                goldSwal({
                    icon: 'success',
                    title: 'บันทึกบิลหลอมสำเร็จ',
                    html: (res.message || 'บิลหลอมถูกบันทึกเรียบร้อยแล้ว') +
                        `<br> <span class="text-danger">หากต้องการแก้ไขข้อมูลกรณาติด่อผู้ดูแลระบบ</span>`,
                    confirmButtonText: 'ตกลง',
                });
                $('#meltBillModal').modal('hide');
                reloadTable('#goldTable', true);
                refreshDashboard(); // อัปเดต Dashboard
            }).withFailureHandler(function (error) {
                NProgress.done();
                goldSwal({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    html: error.message || error,
                });
            }).saveMeltBill(meltData);
        });

        $('#sellBillForm').on('submit', function (e) {
            e.preventDefault();
            const form = $(this);
            let selectedRows = meltTable.rows({ selected: true }).data().toArray();
            const sellData = {
                recorder: window.user.name,
                branch: window.user.branch || 'สาขาหลัก',
                selectedRows: selectedRows.map(row => row.billNo),
                sellPrice: selectedRows.reduce((acc, row) => acc + (parseFloat(row.sellPrice) || 0), 0),
                sellPercentAfterMelt: form.find('#sellPercentAfterMelt').val(),
                percentCalc: selectedRows.reduce((acc, row) => acc + (parseFloat(row.percentCalc) || 0), 0) / selectedRows.length,
                date: form.find('#sellBillDate').val(),
                summaryWeightBefore: parseFloat($('#sellSummaryWeightBefore').text().replace(/,/g, '')),
                summaryWeightAfter: parseFloat($('#sellSummaryWeightAfter').text().replace(/,/g, '')),
                summaryPrice: parseFloat($('#sellSummaryPrice').text().replace(/,/g, '')),
                sellBillStatus: $('#sellBillStatus').val(),
                sellBillBank: $('#sellBillBank').val(),
                sellBillNote: $('#sellBillNote').val()
            };
            if (sellData.selectedRows.length === 0) {
                goldSwal({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูลที่เลือก',
                    text: 'กรุณาเลือกแถวที่ต้องการสร้างบิลขายก่อน',
                });
                return;
            }
            NProgress.start();
            goldSwal({
                title: 'กำลังบันทึกบิลขาย...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            console.log('sellData', sellData);
            google.script.run.withSuccessHandler(function (res) {
                NProgress.done();
                res = JSON.parse(res);
                if (!res.success) {
                    goldSwal({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        html: res.message || 'ไม่สามารถบันทึกบิลขายได้',
                    });
                    return;
                }
                goldSwal({
                    icon: 'success',
                    title: 'บันทึกบิลขายสำเร็จ',
                    html: (res.message || 'บิลขายถูกบันทึกเรียบร้อยแล้ว'),
                    confirmButtonText: 'ตกลง',
                });
                $('#sellBillModal').modal('hide');
                meltTable.rows({ selected: true }).deselect();
                reloadTable('#meltTable');
                refreshDashboard(); // อัปเดต Dashboard
            }).withFailureHandler(function (error) {
                NProgress.done();
                goldSwal({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    html: error.message || error,
                });
            }).saveSellBill(sellData);
        });
    </script>
    <script>
        async function generateSummaryReport(reports) {
            console.log('reports', reports);
            goldSwal({
                icon: 'info',
                title: 'กำลังสร้างรายงาน...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            })
            let summaryData = await new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(e => {
                    resolve(JSON.parse(e));
                }).withFailureHandler(reject).getSummaryData(reports, window.user.branch);
            });
            console.log('summaryData', summaryData);
            // Clear print area
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = '';

            let reportContent = '';

            // Generate Gold Purchase Report
            if (reports.buy && summaryData.buy && summaryData.buy.length > 0) {
                reportContent += generateGoldTableReport(summaryData.buy);
            }

            // Generate Transaction Reports
            if (reports.trans && summaryData.trans && summaryData.trans.length > 0) {
                const incomeTransactions = summaryData.trans.filter(t => t.type === 'รับ');
                const expenseTransactions = summaryData.trans.filter(t => t.type === 'จ่าย');

                if (incomeTransactions.length > 0 || expenseTransactions.length > 0) {
                    reportContent += generateTransactionReport(summaryData.trans);
                }

            }

            // Generate Account Balance Reports
            if (reports.acc && summaryData.acc && reports.banks && reports.banks.length > 0) {
                reportContent += generateAccountBalanceReports(summaryData.acc, reports.banks);
            }

            // Add all reports to print area
            printArea.innerHTML = reportContent;

            Swal.close();

            // Print the content of the print area
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write('<html><head><title>รายงานประจำวันที่ ' + moment().format('DD/MM/YYYY') + '</title>');
            printWindow.document.write('<meta charset="UTF-8">');
            printWindow.document.write('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">');
            printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">');
            printWindow.document.write('<style>body{font-family:"Noto Sans Thai",sans-serif;} .container, .account-balance-report, .gold-table-report, .transaction-income-report, .transaction-expense-report { margin: 24px auto; padding: 16px; } table { margin-bottom: 24px !important; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printArea.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.onload = function () {
                printWindow.print();
                // printWindow.close();
            };
        }

        function generateGoldTableReport(buyData) {
            buyData = buyData.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
            const template = document.getElementById('goldTableReport_template');
            const clone = template.content.cloneNode(true);

            // Set title
            const today = moment().format('ddddที่ DD/MM/YYYY');

            const tbody = clone.getElementById('goldTableReportBody');
            $(clone).find('#goldTableReportTitle').text(`รายงานการซื้อทอง ประจำวัน${today}`);
            let totalWeight = 0;

            buyData.forEach((item, index) => {
                const row = document.createElement('tr');
                const weight = parseFloat(item.weight) || 0;
                const price = parseInt(item.price) || 0;

                totalWeight += weight;

                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${item.product || 'ไม่ระบุ'}</td>
                    <td class="text-end">${weight.toFixed(2)}</td>
                    <td class="text-end">
                        ${price > 0 ? '-' : '+'} ${price.toLocaleString('th-TH')}</td>
                    <td class="text-center">${item.seller || 'ไม่ระบุ'}</td>
                    <td class="text-center">${item.bank || 'ไม่ระบุ'}</td>
                `;
                tbody.appendChild(row);
            });

            $(tbody).append('<tr><td colspan="2" class="text-end fw-bold">รวมน้ำหนัก</td><td id="goldTableReportTotalWeight" class="text-end fw-bold text-primary">0.00</td><td colspan="3"></td></tr>');
            $(tbody).find('#goldTableReportTotalWeight').text(totalWeight.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));

            return clone.firstElementChild.outerHTML;
        }

        function generateTransactionReport(transactionData) {
            transactionData = transactionData.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
            const template = document.getElementById('transactionReport_template');
            const clone = template.content.cloneNode(true);

            // Set title
            const today = moment().format('ddddที่ DD/MM/YYYY');
            clone.getElementById('transactionCombinedReportTitle').textContent = `รายงานการรับจ่าย ประจำวัน ${today}`;
            const tbody = clone.getElementById('transactionCombinedReportBody');
            let totalIncome = 0, totalExpense = 0;
            transactionData.forEach((item, index) => {
                const row = document.createElement('tr');
                const amount = parseFloat(item.amount) || 0;
                if (item.type === 'รับ') {
                    totalIncome += amount;
                } else if (item.type === 'จ่าย') {
                    totalExpense += amount;
                }
                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${moment(item.date).format('HH:mm')}</td>
                    <td>${item.type || 'ไม่ระบุ'}</td>
                    <td>${item.item || 'ไม่ระบุ'}</td>
                    <td>${item.bank || 'ไม่ระบุ'}</td>
                    <td class="text-end ${item.type == 'รับ' ? '' : 'text-danger'}">${amount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>${item.staff || 'ไม่ระบุ'}</td>
                    <td>${item.note || ''}</td>
                `;
                tbody.appendChild(row);
            });
            // Add summary row
            const summaryRow = document.createElement('tr');
            summaryRow.innerHTML = `
                <td colspan="5" class="text-end fw-bold">รวมรับ</td>
                <td class="text-end fw-bold text-success">+${totalIncome.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td colspan="2"></td>
            `;
            tbody.appendChild(summaryRow);
            // Add expense summary row
            const expenseRow = document.createElement('tr');
            expenseRow.innerHTML = `
                <td colspan="5" class="text-end fw-bold">รวมจ่าย</td>
                <td class="text-end fw-bold text-danger">${totalExpense.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td colspan="2"></td>
            `;
            tbody.appendChild(expenseRow);
            return clone.firstElementChild.outerHTML;
        }

        function generateAccountBalanceReports(accountData, selectedBanks) {
            Object.keys(accountData).forEach(bank => {
                const bankData = accountData[bank];
                if (bankData.in.length === 0 && bankData.out.length === 0 && bankData.buy.length === 0) {
                    delete accountData[bank];
                }
                let summary = {
                    income: bankData.in.reduce((a, b) => {
                        a += b.amount;
                        return a;
                    }, 0),
                    expense: bankData.out.reduce((a, b) => {
                        a += b.amount;
                        return a;
                    }, 0),
                    buy: bankData.buy.reduce((a, b) => {
                        a += b.price;
                        return a;
                    }, 0),
                };
                bankData.summary = summary
            });
            console.log('accountData', accountData);
            const template = document.getElementById('accountsRemainingReport_template');
            const clone = template.content.cloneNode(true);

            const today = moment().format('DD/MM/YYYY');
            clone.getElementById('accountsRemainingReportTitle').textContent = `รายงานสรุปยอดบัญชี ประจำวันที่ ${today}`;

            const tbody = clone.getElementById('accountsRemainingReportBody');
            let totalBalance = 0;
            Object.keys(accountData).forEach((bank, idx) => {
                // Find account data for this bank
                const acc = accountData[bank] || {};
                const income = parseFloat(acc.summary.income) || 0;
                const expense = parseFloat(acc.summary.expense) || 0;
                const buy = parseFloat(acc.summary.buy) || 0;
                const balance = income - (expense < 0 ? -expense : expense) - buy
                totalBalance += balance;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-center">${idx + 1}</td>
                    <td>${bank}</td>
                    <td class="text-end fw-bold ${balance < 0 ? 'text-danger' : ''}">${balance.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                `;
                tbody.appendChild(row);
            });

            // selectedBanks.forEach((bank, idx) => {
            //     // Find account data for this bank
            //     const acc = accountData.find(a => a.bank === bank) || {};
            //     const income = parseFloat(acc.income) || 0;
            //     const expense = parseFloat(acc.expense) || 0;
            //     const buy = parseFloat(acc.buy) || 0;
            //     const balance = income - expense - buy;
            //     totalBalance += balance;

            //     const row = document.createElement('tr');
            //     row.innerHTML = `
            //         <td class="text-center">${idx + 1}</td>
            //         <td>${bank}</td>
            //         <td class="text-end fw-bold">${balance.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            //     `;
            //     tbody.appendChild(row);
            // });


            return clone.firstElementChild.outerHTML;
        }
    </script>
    <script>
        // Helper for gold-styled SweetAlert2
        const goldSwalOptions = {
            background: '#fff',
            color: '#232526',
            customClass: {
                popup: 'swal2-gold-popup',
                confirmButton: 'swal2-gold-confirm',
                cancelButton: 'swal2-gold-cancel',
                title: 'swal2-gold-title',
                htmlContainer: 'swal2-gold-html',
                input: 'swal2-gold-input',
            },
        };
        function goldSwal(options) {
            return Swal.fire(Object.assign({}, goldSwalOptions, options));
        }
    </script>
    <script>
        $(function () {
            const setUserData = (user) => {
                console.log('Setting user data:', user);
                if (!user) return;
                window.user = user;
                if (user.role === 'admin') user.branch = 'all';
                $('#logoutNavItem').removeClass('d-none')
                $('.userBranch').text(user.branch || '-');
                $('.userRole').text(user.role || '-');
                $('.userName').text(user.name || '-');
                $('#goldNavbar .navbar-nav').removeClass('d-none');
                $('#bank, #transactionBank').empty().append(new Option('เลือกบัญชี', '', true, true));
                $('#bill-branch').text(user.branch || '-');
                user.allowAccounts.forEach(bank => {
                    $('#bank, #transactionBank, #sellBillBank, #editSellBillBank').append(new Option(bank, bank));
                });
                if (user.role === 'staff') {
                    $('.admin-only').remove();
                } else {
                    $('.admin-only').removeClass('d-none');
                }

                // โหลด Dashboard
                loadDashboard();

                localStorage.setItem('goldshop_userV3', JSON.stringify(Object.assign({}, user, {
                    expires: Date.now() + 4 * 60 * 60 * 1000  // 4 hours expiration
                })));
                if (user.role === 'admin') {
                    let branches = <?!= JSON.stringify(getBranch()) ?>;
                    $('.userBranch')
                        .html(user.branch + ' <i class="bi bi-pencil-square ms-2"></i>')
                        .css('cursor', 'pointer').attr('title', 'คลิกเพื่อเปลี่ยนสาขา').off('click').on('click', function () {
                            goldSwal({
                                title: 'เลือกสาขา',
                                input: 'select',
                                inputOptions: branches.reduce((obj, branch) => {
                                    obj[branch] = branch;
                                    return obj;
                                }, {}),
                                inputValue: user.branch || branches[0],
                                showCancelButton: true,
                                confirmButtonText: 'ยืนยัน',
                                cancelButtonText: 'ยกเลิก',
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    const newBranch = result.value;
                                    window.user.branch = newBranch;
                                    $('#bill-branch').text(newBranch);
                                    $('.userBranch').html(newBranch + ' <i class="bi bi-pencil-square ms-2"></i>');
                                    localStorage.setItem('goldshop_userV3', JSON.stringify(Object.assign({}, window.user, {
                                        expires: Date.now() + 4 * 60 * 60 * 1000  // 4 hours expiration
                                    })));
                                    reloadTable($('#goldTable').is(':visible') ? '#goldTable' : '#transactionTable');
                                    loadDashboard();
                                }
                            });
                        });
                    // console.log('branches', branches);
                    // $('.userBranch').replaceWith($('<select class="form-select form-select-sm userBranch" id="userBranchSelect" aria-label="สาขา"></select>'))
                    branches.forEach(branch => {
                        $('#userBranchSelect').append(new Option(branch, branch));
                    });
                    $('#userBranchSelect').val(user.branch).on('change', function () {
                        const newBranch = $(this).val();
                        window.user.branch = newBranch;
                        localStorage.setItem('goldshop_userV3', JSON.stringify(Object.assign({}, window.user, {
                            expires: Date.now() + 4 * 60 * 60 * 1000  // 4 hours expiration
                        })));
                    });
                }
            };

            // ฟังก์ชันโหลด Dashboard
            const loadDashboard = () => {
                const dashboardCards = document.getElementById('dashboard-cards');
                $('#dashboard-section').show();
                if (!dashboardCards) return;

                // แสดง loading state
                dashboardCards.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">กำลังโหลด...</span>
                        </div>
                        <p class="mt-2 text-muted">กำลังโหลดข้อมูล Dashboard...</p>
                    </div>
                `;

                // เรียกข้อมูล Dashboard
                google.script.run
                    .withSuccessHandler((response) => {
                        const result = JSON.parse(response);
                        if (result.success) {
                            renderDashboard(result.accountBalance);
                        } else {
                            showDashboardError(result.message);
                        }
                    })
                    .withFailureHandler((error) => {
                        showDashboardError(error.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
                    })
                    .getAccountBalance(window.user.branch);
            };

            // ฟังก์ชันแสดงผล Dashboard
            const renderDashboard = (data) => {
                const dashboardCards = document.getElementById('dashboard-cards');
                if (!dashboardCards) return;

                const cards = [
                    {
                        title: 'เงินสดเหลือในร้าน',
                        value: data.summary,
                        icon: 'bi-wallet2',
                        format: 'currency',
                        change: null,
                        color: data.summary >= 0 ? 'positive' : 'negative'
                    },
                    {
                        title: 'เงินสดซื้อเข้าวันนี้',
                        value: Math.abs(data.todaybuy),
                        icon: 'bi-cart-plus',
                        format: 'currency',
                        change: null,
                        color: 'negative'
                    },
                    {
                        title: 'รับจ่ายสดวันนี้',
                        value: data.todaytrans,
                        icon: 'bi-cash-coin',
                        format: 'currency',
                        change: null,
                        color: data.todaytrans >= 0 ? 'positive' : 'negative'
                    }
                ];

                const cardsHTML = cards.map(card => {
                    const formattedValue = card.format === 'currency'
                        ? `${card.value
                            .toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                        : card.value;

                    return `
                        <div class="col-md-4 mb-4">
                            <div class="card dashboard-card h-100">
                                <div class="card-body text-center">
                                    <div class="dashboard-card-icon">
                                        <i class="${card.icon}"></i>
                                    </div>
                                    <div class="dashboard-card-title">${card.title}</div>
                                    <div class="dashboard-card-value dashboard-card-${card.color}">
                                        ${formattedValue}
                                    </div>
                                    ${card.change ? `<div class="dashboard-card-change dashboard-card-${card.color}">${card.change}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                dashboardCards.innerHTML = cardsHTML;
            };

            // ฟังก์ชันแสดงข้อผิดพลาด Dashboard
            const showDashboardError = (message) => {
                const dashboardCards = document.getElementById('dashboard-cards');
                if (!dashboardCards) return;
                dashboardCards.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            ไม่สามารถโหลดข้อมูล Dashboard ได้: ${message}
                        </div>
                    </div>
                `;
            };

            // ฟังก์ชันรีเฟรช Dashboard (เรียกใช้เมื่อต้องการอัปเดตข้อมูล)
            window.refreshDashboard = () => {
                if (window.user && document.getElementById('dashboard-cards')) {
                    loadDashboard();
                }
            };
            // Check if user is already logged in
            const storedUser = localStorage.getItem('goldshop_userV3');
            if (storedUser) {
                const user = JSON.parse(storedUser);
                if (user && user.expires && user.expires > Date.now()) {
                    $('#login-section').hide();
                    $('#main-sec').show();
                    reloadTable('#goldTable');
                    // Set user info in local storage
                    setUserData(user);
                } else {
                    localStorage.removeItem('goldshop_userV3');
                }
            }
            $('#loginForm').on('submit', function (e) {
                e.preventDefault();
                const username = $('#loginUser').val().trim();
                const password = $('#loginPassword').val();
                if (!username || !password) return;

                NProgress.start();
                goldSwal({
                    title: 'กำลังเข้าสู่ระบบ...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                google.script.run
                    .withSuccessHandler(function (res) {
                        NProgress.done();
                        res = JSON.parse(res);
                        if (res.success) {
                            $('#login-section').hide();
                            $('#loginForm')[0].reset();
                            $('#main-sec').show();
                            setUserData(res.user);
                            goldSwal({
                                icon: 'success',
                                title: 'เข้าสู่ระบบสำเร็จ',
                                showConfirmButton: false,
                                timer: 1200
                            });
                            reloadTable('#goldTable');
                        } else {
                            goldSwal({
                                icon: 'error',
                                title: 'เข้าสู่ระบบไม่สำเร็จ',
                                text: res && res.message ? res.message : 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง'
                            });
                        }
                    })
                    .withFailureHandler(function (err) {
                        NProgress.done();
                        goldSwal({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: err.message || err
                        });
                    })
                    .loginUser({ username, password });
            });

            $('#logoutBtn').on('click', function () {
                goldSwal({
                    title: 'คุณต้องการออกจากระบบใช่หรือไม่?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ออกจากระบบ',
                    cancelButtonText: 'ยกเลิก',
                }).then((result) => {
                    if (result.isConfirmed) {
                        showTableButtons('add')
                        $('.datatable').each(function () {
                            if (DataTable.isDataTable(this)) {
                                $(this).DataTable().destroy();
                                $(this).empty();
                            }
                        });
                        $('#main-sec, #transaction-sec, #melt-sec, #buy-summary-sec').hide();
                        goldSwal({
                            icon: 'info',
                            title: 'กำลังออกจากระบบ...',
                            didOpen: () => Swal.showLoading()
                        })
                        window.user = null;
                        localStorage.removeItem('goldshop_userV3');
                        window.open('<?= ScriptApp.getService().getUrl() ?>', '_top');
                    }
                });
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"
        integrity="sha512-K/oyQtMXpxI4+K0W7H25UopjM8pzq0yrVdFdG21Fh5dBe91I40pDd9A4lzNlHPHBIP2cwZuoxaUSX0GJSObvGA=="
        crossorigin=" anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.11/l10n/th.min.js"
        integrity="sha512-0XU8EDwsRqhnSukLw3KIQoRvFJs3SGlsoLpX1RpRAjmYrc7w56F6J5pwJ0p0p+v23qg14VPRQe9OhPRfbhVzdw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script
        src="https://cdn.datatables.net/v/bs5/moment-2.29.4/jszip-3.10.1/dt-2.3.2/b-3.2.4/b-html5-3.2.4/b-print-3.2.4/date-1.5.6/fh-4.0.3/r-3.0.5/sl-3.0.1/datatables.min.js"
        integrity="sha384-BvB5KPqUtYKoiQg8KOTVI81Manq4YXileOPV/+spSTqAuJ6g4b6sLjmOMJBCFuzk"
        crossorigin="anonymous"></script>
    <!-- jsPDF library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
    <!-- jsPDF AutoTable plugin for table formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <script>
        AOS.init();
        document.addEventListener("DOMContentLoaded", function () {
            NProgress.start();
            NProgress.inc()
        });
        window.addEventListener("load", function () {
            NProgress.done();
        });

    </script>

</body>

</html>