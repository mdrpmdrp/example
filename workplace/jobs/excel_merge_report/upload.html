<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Excel Files</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f3cc23',
                        secondary: '#008894'
                    }
                }
            }
        }
    </script>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .gradient-bg {
            background: #008894;
        }

        .gradient-accent {
            background: #f3cc23;
        }

        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 136, 148, 0.2);
        }

        .file-input-modern:focus-within {
            border-color: #f3cc23;
            box-shadow: 0 0 0 3px rgba(243, 204, 35, 0.1);
        }

        .custom-file-upload {
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .custom-file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
        }

        .file-drop-area {
            border: 3px dashed #d1d5db;
            border-radius: 1rem;
            padding: 2.5rem;
            text-align: center;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .file-drop-area:hover {
            border-color: #f3cc23;
            background: #fffef0;
            transform: translateY(-2px);
        }

        .file-drop-area.dragover {
            border-color: #008894;
            background: #f0f9fa;
            transform: scale(1.02);
        }

        .file-drop-area.has-files {
            border-color: #008894;
            border-style: solid;
            background: #e0f7fa;
        }

        .file-list-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .file-list-item:hover {
            background: #f9fafb;
            border-color: #008894;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            overflow: auto;
        }

        .modal.show {
            display: block;
        }

        .modal-content {
            background-color: #f9fafb;
            margin: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        .modal-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #008894;
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .close-modal {
            cursor: pointer;
            font-size: 2rem;
            font-weight: bold;
            line-height: 1;
            color: white;
            transition: transform 0.2s ease;
        }

        .close-modal:hover {
            transform: scale(1.2);
        }

        .table-header-nowrap {
            white-space: nowrap;
        }

        table th,
        table td {
            min-width: 120px;
        }

        .file-list-collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .file-list-collapsible.expanded {
            max-height: 500px;
            overflow-y: auto;
        }

        .collapse-toggle {
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header with Logo -->
        <div class="gradient-bg rounded-2xl shadow-2xl p-8 mb-8 hover-lift">
            <div class="flex items-center justify-center mb-6">
                <div class="bg-white rounded-xl p-4 shadow-lg">
                    <img id="logoImage" src="" alt="Logo" class="h-32">
                </div>
            </div>
            <h1 class="text-4xl font-bold text-center text-white mb-3">Upload Excel Files</h1>
            <!-- <p class="text-center text-white text-opacity-90 text-lg">Select and preview Excel files before uploading to Google Sheets</p> -->
            <div class="mt-6 flex items-center justify-center gap-3">
                <div class="h-1 w-20 gradient-accent rounded-full"></div>
                <div class="h-1 w-8 bg-white bg-opacity-50 rounded-full"></div>
                <div class="h-1 w-20 gradient-accent rounded-full"></div>
            </div>
        </div>

        <!-- File Upload Form -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 hover-lift border-2 border-gray-100">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-1 h-8 gradient-accent rounded-full"></div>
                <h2 class="text-2xl font-bold text-secondary">Select Files</h2>
            </div>

            <!-- File Input 1 -->
            <div class="mb-8">
                <label class="block text-secondary font-bold mb-3 flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold">üí∞</span>
                    Income Files
                </label>
                <div class="custom-file-upload">
                    <div class="file-drop-area" id="dropArea1">
                        <div class="flex flex-col items-center justify-center">
                            <div class="bg-green-500 p-4 rounded-2xl mb-4">
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <p class="text-lg font-bold text-secondary mb-2">Drag & Drop Income Excel files here</p>
                            <p class="text-sm text-gray-500 mb-4">or click to browse</p>
                            <div class="bg-secondary text-white px-6 py-2 rounded-full text-sm font-semibold shadow-md">
                                üìÅ Choose Files
                            </div>
                        </div>
                        <input type="file" id="fileInput1" multiple accept=".xlsx,.xls,.csv">
                    </div>
                </div>
                <div id="fileList1" class="mt-3"></div>
                <div class="mt-4">
                    <button id="previewBtn1" disabled
                        class="max-w-md mx-auto  gradient-bg text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Preview Income Files
                    </button>
                </div>
            </div>

            <!-- File Input 2 -->
            <div class="mb-8">
                <label class="block text-secondary font-bold mb-3 flex items-center gap-2">
                    <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold">üí≥</span>
                    Expense Files
                </label>
                <div class="custom-file-upload">
                    <div class="file-drop-area" id="dropArea2">
                        <div class="flex flex-col items-center justify-center">
                            <div class="bg-red-500 p-4 rounded-2xl mb-4">
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <p class="text-lg font-bold text-secondary mb-2">Drag & Drop Expense Excel files here</p>
                            <p class="text-sm text-gray-500 mb-4">or click to browse</p>
                            <div class="bg-secondary text-white px-6 py-2 rounded-full text-sm font-semibold shadow-md">
                                üìÅ Choose Files
                            </div>
                        </div>
                        <input type="file" id="fileInput2" multiple accept=".xlsx,.xls,.csv">
                    </div>
                </div>
                <div id="fileList2" class="mt-3"></div>
                <div class="mt-4">
                    <button id="previewBtn2" disabled
                        class="max-w-md mx-auto gradient-bg text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Preview Expense Files
                    </button>
                </div>
            </div>

            <!-- File Input 3 -->
            <div class="mb-8">
                <label class="block text-secondary font-bold mb-3 flex items-center gap-2">
                    <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-bold">üì¶</span>
                    Product List File
                </label>
                <div class="custom-file-upload">
                    <div class="file-drop-area" id="dropArea3">
                        <div class="flex flex-col items-center justify-center">
                            <div class="bg-purple-500 p-4 rounded-2xl mb-4">
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                </svg>
                            </div>
                            <p class="text-lg font-bold text-secondary mb-2">Drag & Drop Product List Excel file here
                            </p>
                            <p class="text-sm text-gray-500 mb-4">or click to browse</p>
                            <div class="bg-secondary text-white px-6 py-2 rounded-full text-sm font-semibold shadow-md">
                                üìÅ Choose Files
                            </div>
                        </div>
                        <input type="file" id="fileInput3" multiple accept=".xlsx,.xls,.csv">
                    </div>
                </div>
                <div id="fileList3" class="mt-3"></div>
                <div class="mt-4">
                    <button id="previewBtn3" disabled
                        class="max-w-md mx-auto  gradient-bg text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Preview Product List
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4 pt-4 justify-center">
                <button id="uploadBtn" disabled
                    class="w-2/3 gradient-accent text-gray-800 font-bold py-4 px-8 rounded-xl transition transform hover:scale-105 hover:shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Upload
                </button>
            </div>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" class="hidden">
            <!-- Preview content will be dynamically added here -->
        </div>
    </div>

    <!-- Fullscreen Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-2xl font-bold">Preview Data</h2>
                <span class="close-modal" onclick="closePreviewModal()">&times;</span>
            </div>
            <div id="modalPreviewContent" class="p-6">
                <!-- Modal preview content will be dynamically added here -->
            </div>
        </div>
    </div>

    <script>
        const logo = {
            horizontal_for_dark_bg: "https://lh3.googleusercontent.com/d/1DzVv43LvyMqATfAasNzYVi9jcuwLiLIJ",
            horizontal_for_light_bg: "https://lh3.googleusercontent.com/d/1ikTzT4LSsbwpdZJxd-h3zzpk798vHsvt",
            horizontal_black: 'https://lh3.googleusercontent.com/d/1yOt7i1RFnd37TzNSQFZ-1Tlz7uk-qooQ',
            horizontal_green: 'https://lh3.googleusercontent.com/d/174bSV3bSBsekE5AtPY7ewqVnqsjdxC80',
            horizontal_white: 'https://lh3.googleusercontent.com/d/1zQ_ivzbELCeI0QVJBFvIMcASVHiwqF0y',
            vertical_for_light_bg: "https://lh3.googleusercontent.com/d/1PxhO4Hs0-1Agwx53w6qf9104P7tLkC50",
            vertical_for_dark_bg: "https://lh3.googleusercontent.com/d/1srYa4g-W5bv26oJ5IxAsp9bMlD7tKuWJ",
            vertical_black: 'https://lh3.googleusercontent.com/d/1pEh7sDTG4qJUByxcDIjpvBiJ33NBKZqO',
            vertical_green: 'https://lh3.googleusercontent.com/d/1Et6WFjtSoShT3TeFHE8Q4Zw16aK_xB8Q',
            vertical_white: 'https://lh3.googleusercontent.com/d/1vbQZzcOedD08NPSJ0tUsYen26hktvYfy',
            no_text_black: 'https://lh3.googleusercontent.com/d/1HBcPImI-uPvb1A6nADAhxZA6aYse34LK',
            no_text_green: 'https://lh3.googleusercontent.com/d/1wBfYigrNKtQJTglvbS2MitRlFD_YhuWvk',
            no_text_white: 'https://lh3.googleusercontent.com/d/1AM7dfdvXTxOiln50LS-wB7G39D_lnrYK',
            no_text_yellow: 'https://lh3.googleusercontent.com/d/1WY0PyPJoRX-tAZAiaJJ4lIpkFNPBfyih'
        }

        // Set logo
        document.getElementById('logoImage').src = logo.vertical_for_light_bg;

        let parsedData = [];
        let fileDataStore = {
            fileInput1: [],
            fileInput2: [],
            fileInput3: []
        };

        // Initialize drag and drop for all file inputs
        function initDragAndDrop(inputId, dropAreaId, fileListId) {
            const fileInput = document.getElementById(inputId);
            const dropArea = document.getElementById(dropAreaId);
            const fileListDiv = document.getElementById(fileListId);

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.remove('dragover');
                }, false);
            });

            // Handle dropped files
            dropArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFileSelection(inputId, files, fileListDiv, dropArea);
                checkFilesSelected();
            }, false);

            // Handle file input change
            fileInput.addEventListener('change', function () {
                handleFileSelection(inputId, this.files, fileListDiv, dropArea);
                checkFilesSelected();
            });
        }

        function handleFileSelection(inputId, files, fileListDiv, dropArea) {
            fileDataStore[inputId] = Array.from(files);
            displayFileList(inputId, fileListDiv, dropArea);
        }

        function removeFile(inputId, fileIndex) {
            fileDataStore[inputId].splice(fileIndex, 1);

            // Update the file input
            const fileInput = document.getElementById(inputId);
            const dataTransfer = new DataTransfer();
            fileDataStore[inputId].forEach(file => {
                dataTransfer.items.add(file);
            });
            fileInput.files = dataTransfer.files;

            // Update display
            const fileListDiv = document.getElementById(`fileList${inputId.slice(-1)}`);
            const dropArea = document.getElementById(`dropArea${inputId.slice(-1)}`);
            displayFileList(inputId, fileListDiv, dropArea);
            checkFilesSelected();
        }

        function displayFileList(inputId, fileListDiv, dropArea) {
            fileListDiv.innerHTML = '';
            const files = fileDataStore[inputId];

            if (files.length > 0) {
                dropArea.classList.add('has-files');

                // Create collapsible container if more than 3 files
                if (files.length > 3) {
                    const toggleBtn = document.createElement('div');
                    toggleBtn.className = 'collapse-toggle bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg mb-2 text-center font-semibold text-secondary transition';
                    toggleBtn.innerHTML = `
                        <span id="toggle-text-${inputId}">‚ñº Show ${files.length} files</span>
                    `;
                    toggleBtn.onclick = () => toggleFileList(inputId);
                    fileListDiv.appendChild(toggleBtn);

                    const collapsibleDiv = document.createElement('div');
                    collapsibleDiv.id = `collapsible-${inputId}`;
                    collapsibleDiv.className = 'file-list-collapsible';
                    fileListDiv.appendChild(collapsibleDiv);

                    files.forEach((file, index) => {
                        collapsibleDiv.appendChild(createFileItem(file, index, inputId));
                    });
                } else {
                    files.forEach((file, index) => {
                        fileListDiv.appendChild(createFileItem(file, index, inputId));
                    });
                }

                // Add summary
                const summary = document.createElement('div');
                summary.className = 'mt-3 text-center';
                summary.innerHTML = `
                    <span class="bg-secondary text-white px-4 py-2 rounded-full text-sm font-semibold shadow-md">
                        üìä ${files.length} file${files.length > 1 ? 's' : ''} selected
                    </span>
                `;
                fileListDiv.appendChild(summary);
            } else {
                dropArea.classList.remove('has-files');
            }
        }

        function createFileItem(file, index, inputId) {
            const fileSize = (file.size / 1024).toFixed(2);
            const fileItem = document.createElement('div');
            fileItem.className = 'file-list-item';
            fileItem.innerHTML = `
                <div class="flex items-center gap-3 flex-1">
                    <div class="gradient-accent p-2 rounded-lg">
                        <svg class="w-5 h-5 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-secondary truncate">${file.name}</p>
                        <p class="text-xs text-gray-500">${fileSize} KB</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 text-xs px-3 py-1 rounded-full font-semibold">Ready</span>
                    <button onclick="removeFile('${inputId}', ${index})" class="bg-red-100 hover:bg-red-200 text-red-600 p-2 rounded-lg transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            `;
            return fileItem;
        }

        function toggleFileList(inputId) {
            const collapsible = document.getElementById(`collapsible-${inputId}`);
            const toggleText = document.getElementById(`toggle-text-${inputId}`);
            const fileCount = fileDataStore[inputId].length;

            if (collapsible.classList.contains('expanded')) {
                collapsible.classList.remove('expanded');
                toggleText.textContent = `‚ñº Show ${fileCount} files`;
            } else {
                collapsible.classList.add('expanded');
                toggleText.textContent = `‚ñ≤ Hide ${fileCount} files`;
            }
        }

        function checkFilesSelected() {
            // Check each file input and update corresponding preview button
            for (let i = 1; i <= 3; i++) {
                const inputId = `fileInput${i}`;
                const previewBtn = document.getElementById(`previewBtn${i}`);
                const hasFiles = fileDataStore[inputId].length > 0;

                if (previewBtn) {
                    previewBtn.disabled = !hasFiles;
                    if (hasFiles) {
                        previewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        previewBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            }

            // Enable upload button if any group has files
            const hasAnyFiles = fileDataStore.fileInput1.length > 0 ||
                fileDataStore.fileInput2.length > 0 ||
                fileDataStore.fileInput3.length > 0;

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = !hasAnyFiles;
            if (hasAnyFiles) {
                uploadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                uploadBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // Individual preview button handlers
        async function previewSingleGroup(inputId, groupName) {
            try {
                showLoading();
                const files = fileDataStore[inputId];

                if (files.length === 0) {
                    throw new Error('No files selected for this group');
                }

                const filesData = await Promise.all(
                    files.map(file => readExcelFile(file))
                );

                // Merge all sheets from this group
                const mergedData = [];
                filesData.forEach((fileData, fileIndex) => {
                    fileData.forEach(row => {
                        mergedData.push(row);
                    });
                });

                // Sort by Date column if this is Income Files group
                if (groupName === 'Income Files' && mergedData.length > 1) {
                    const header = mergedData[0];
                    const dateColIndex = 0;
                    // Parse dates in DD/MM/YYYY format
                    const parseDate = (dateStr, stringFormat, dateFormat) => {
                        if (!dateStr) return new Date(0);
                        let date =  moment(dateStr, stringFormat)
                        if(dateFormat){
                            return date.format(dateFormat);
                        }else{
                            return date.toDate();
                        }
                    };
                    if (dateColIndex !== -1) {
                        let headerRow = mergedData[0];
                        let dataRows = mergedData.slice(1);

                        dataRows.sort((a, b) => {
                            const dateA = a[dateColIndex];
                            const dateB = b[dateColIndex];
                            return parseDate(dateA, "DD/MM/YYYY") - parseDate(dateB, "DD/MM/YYYY");
                        });

                        headerRow[21] = 'Payout Date';
                        headerRow[22] = 'Bank Account Logic'
                        headerRow[23] = 'Bank Account'
                        // dataRows = dataRows.map((row,i) => {
                        //     row[21] = row[0] ? parseDate(row[0], "DD/MM/YYYY", "DD/MMM/YYYY") : '';
                        //     if(row[10] == '' || String(row[2]).startsWith("Resolution")){
                        //         if(row[10] == '' || dataRows[i-1][10] == ''){
                        //             row[22] = dataRows[i-1][22];
                        //         }else{
                        //             if(String(row[2]).toLowerCase().includes("Resolution")){
                        //                  row[22] = dataRows[i-1][22];
                        //             }else{
                        //                 row[22] = row[10]
                        //             }
                        //         }
                        //     }else{
                        //         row[22] = row[10];
                        //     }
                        //     row[23] = row[22]?.slice(12)
                        //     return row;
                        // });

                        for(let i=0; i<dataRows.length; i++){
                            let row = dataRows[i];
                            row[21] = row[0] ? parseDate(row[0], "DD/MM/YYYY", "DD/MMM/YYYY") : '';
                            if(row[10] == '' || String(row[2]).startsWith("Resolution")){
                                if(row[10] == '' || dataRows[i > 0? i-1 : 0][10] == ''){
                                    row[22] = dataRows[i > 0? i-1 : 0][22];
                                }else{
                                    if(String(row[2]).toLowerCase().includes("Resolution")){
                                         row[22] = dataRows[i > 0? i-1 : 0][22];
                                    }else{
                                        row[22] = row[10]
                                    }
                                }
                            }else{
                                row[22] = row[10];
                            }
                            row[23] = row[22]?.slice(12)
                        }

                        mergedData.length = 0;
                        mergedData.push(headerRow, ...dataRows);
                    }
                }

                // Create preview HTML for this single group
                const groupData = {
                    groupName: groupName,
                    data: mergedData,
                    fileCount: files.length
                };

                // Store in parsedData for viewAllRows to work
                parsedData = [groupData];

                const previewHTML = createGroupPreviewHTML(groupData, inputId, 0, false);

                displayPreview([{ inputId: inputId, name: groupName, html: previewHTML }]);
                hideLoading();
            } catch (error) {
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'Preview Error',
                    text: error.message,
                    confirmButtonColor: '#008894'
                });
            }
        }

        // Initialize all three file inputs
        initDragAndDrop('fileInput1', 'dropArea1', 'fileList1');
        initDragAndDrop('fileInput2', 'dropArea2', 'fileList2');
        initDragAndDrop('fileInput3', 'dropArea3', 'fileList3');

        // Preview button event listeners
        document.getElementById('previewBtn1').addEventListener('click', function () {
            previewSingleGroup('fileInput1', 'Income Files');
        });

        document.getElementById('previewBtn2').addEventListener('click', function () {
            previewSingleGroup('fileInput2', 'Expense Files');
        });

        document.getElementById('previewBtn3').addEventListener('click', function () {
            previewSingleGroup('fileInput3', 'Product List File');
        });

        // Upload button handler
        $('#uploadBtn').on('click', async function () {
            const hasAnyFiles = fileDataStore.fileInput1.length > 0 ||
                fileDataStore.fileInput2.length > 0 ||
                fileDataStore.fileInput3.length > 0;

            if (!hasAnyFiles) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Files Selected',
                    text: 'Please select at least one file to upload',
                    confirmButtonColor: '#008894'
                });
                return;
            }

            // Show processing dialog
            Swal.fire({
                title: 'Processing Files...',
                text: 'Please wait while we read and merge your files',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Process all file groups
                parsedData = [];
                await processFileGroup('fileInput1', 'Income Files');
                await processFileGroup('fileInput2', 'Expense Files');
                await processFileGroup('fileInput3', 'Product List File');

                if (parsedData.length === 0) {
                    throw new Error('No data to upload');
                }

                const totalRows = parsedData.reduce((sum, group) => sum + group.data.length - 1, 0);

                // Confirm upload
                Swal.fire({
                    title: 'Upload to Google Sheets?',
                    text: `You are about to upload ${totalRows} rows of data`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#008894',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, upload!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        uploadToGoogleSheets();
                    }
                });
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to process files: ' + error.message,
                    confirmButtonColor: '#008894'
                });
            }
        });

        async function processFileGroup(inputId, groupName) {
            const files = fileDataStore[inputId];
            if (files.length === 0) return;

            let mergedData = [];
            let headers = null;

            for (const file of files) {
                const data = await readExcelFile(file);
                if (data.length > 0) {
                    if (!headers) {
                        headers = data[0];
                        mergedData.push(headers);
                    }
                    // Add data rows (skip header)
                    mergedData.push(...data.slice(1));
                }
            }

            if (mergedData.length > 0) {
                // Sort by Date column if this is Income Files group
                if (groupName === 'Income Files' && mergedData.length > 1) {
                    const header = mergedData[0];
                    const dateColIndex = header.findIndex(h => h && (h.toLowerCase().includes('date') || h === 'Date'));

                    if (dateColIndex !== -1) {
                        const headerRow = mergedData[0];
                        const dataRows = mergedData.slice(1);

                        dataRows.sort((a, b) => {
                            const dateA = a[dateColIndex];
                            const dateB = b[dateColIndex];

                            // Parse dates in DD/MM/YYYY format
                            const parseDate = (dateStr) => {
                                if (!dateStr) return new Date(0);
                                const parts = String(dateStr).split('/');
                                if (parts.length === 3) {
                                    return new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                                return new Date(dateStr);
                            };

                            return parseDate(dateA) - parseDate(dateB);
                        });

                        mergedData.length = 0;
                        mergedData.push(headerRow, ...dataRows);
                    }
                }

                parsedData.push({
                    groupName: groupName,
                    fileCount: files.length,
                    data: mergedData
                });
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '', raw: false });
                        const header = jsonData[0];

                        // Convert Excel date numbers to readable dates
                        const dateHeaders = ['Date', 'Arriving by date', 'Booking date', 'Start date', 'End date'];
                        const processedData = jsonData.map((row, rowIndex) => {
                            return row.map((cell, i) => {
                                // Check if cell is date column
                                const isDateColumn = dateHeaders.includes(header[i]);
                                if (isDateColumn && cell && rowIndex > 0) {
                                    return moment(cell, 'MM/DD/YYYY').format('DD/MM/YYYY');
                                }
                                return cell;
                            });
                        });

                        resolve(processedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = function (error) {
                    reject(error);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function displayPreview(previewGroups = null) {
            const modalContent = $('#modalPreviewContent');
            modalContent.empty();

            // Use provided groups or fallback to parsedData
            const groupsToShow = previewGroups || parsedData.map((group, index) => ({
                inputId: `group-${index}`,
                name: group.groupName,
                html: createGroupPreviewHTML(group, `group-${index}`, index, false)
            }));

            groupsToShow.forEach((item) => {
                modalContent.append(item.html);
            });

            // Show modal
            document.getElementById('previewModal').classList.add('show');
        }

        function createGroupPreviewHTML(group, groupId, groupIndex, showAll = false) {
            const rowsToShow = showAll ? group.data.length - 1 : 10;
            const dataRows = group.data.slice(1, rowsToShow + 1);
            const hasMoreRows = group.data.length > 11;

            return `
                <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 hover-lift border-t-4 border-primary" id="group-container-${groupId}">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-secondary flex items-center gap-3">
                            <span class="gradient-accent px-4 py-2 rounded-lg text-gray-800 text-lg">${group.groupName}</span>
                        </h3>
                        <div class="flex gap-3">
                            <span class="bg-secondary text-white px-5 py-2 rounded-full font-semibold shadow-lg">
                                üìÑ ${group.fileCount} file(s)
                            </span>
                            <span class="bg-primary text-gray-800 px-5 py-2 rounded-full font-semibold shadow-lg">
                                üìä ${group.data.length - 1} rows
                            </span>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="gradient-bg text-white">
                                <tr>
                                    <th class="px-6 py-4 text-center text-sm font-bold uppercase tracking-wide table-header-nowrap">#</th>
                                    ${group.data[0].map(header => `<th class="px-6 py-4 text-left text-sm font-bold uppercase tracking-wide table-header-nowrap">${header || 'Column'}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="tbody-${groupId}">
                                ${dataRows.map((row, rowIndex) => `
                                    <tr class="${rowIndex % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-primary hover:bg-opacity-10 transition">
                                        <td class="px-6 py-4 text-sm text-gray-500 font-semibold text-center">${rowIndex + 1}</td>
                                        ${row.map(cell => `<td class="px-6 py-4 text-sm text-gray-700">${cell}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${hasMoreRows && !showAll ? `
                        <div class="mt-6 text-center flex gap-4 justify-center">
                            <span class="bg-secondary text-white px-6 py-2 rounded-full text-sm font-semibold shadow-md">
                                Showing first 10 rows of ${group.data.length - 1} total rows
                            </span>
                            <button onclick="viewAllRows('${groupId}', ${groupIndex})" class="bg-primary hover:bg-opacity-90 text-gray-800 font-bold px-6 py-2 rounded-full text-sm shadow-md transition transform hover:scale-105">
                                üìã View All Rows
                            </button>
                        </div>
                    ` : ''}
                    ${showAll ? `
                        <div class="mt-6 text-center">
                            <span class="bg-green-500 text-white px-6 py-2 rounded-full text-sm font-semibold shadow-md">
                                ‚úì Showing all ${group.data.length - 1} rows
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function showLoading() {
            Swal.fire({
                title: 'Processing Files...',
                text: 'Please wait while we read your files',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        function hideLoading() {
            Swal.close();
        }

        function viewAllRows(groupId, groupIndex) {
            // Find the group data - either from parsedData index or by matching groupId
            let group = parsedData[groupIndex];
            if (!group && parsedData.length === 1) {
                // Single group preview case
                group = parsedData[0];
            }

            if (!group) {
                console.error('Group not found:', groupIndex, groupId);
                return;
            }

            const newHTML = createGroupPreviewHTML(group, groupId, groupIndex, true);

            // Replace the group's HTML using the container ID
            $(`#group-container-${groupId}`).replaceWith(newHTML);
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.remove('show');
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('previewModal');
            if (event.target == modal) {
                closePreviewModal();
            }
        }

        // Close modal with ESC key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closePreviewModal();
            }
        });

        function uploadToGoogleSheets() {
            Swal.fire({
                title: 'Uploading...',
                text: 'Please wait while we upload your data to Google Sheets',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            google.script.run
                .withSuccessHandler(function (response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Upload Complete!',
                        text: response.message,
                        confirmButtonColor: '#008894'
                    }).then(() => {
                        // Reset form
                        $('#fileInput1, #fileInput2, #fileInput3').val('');
                        $('#previewSection').addClass('hidden').empty();
                        $('#uploadBtn').prop('disabled', true);
                        parsedData = [];
                    });
                })
                .withFailureHandler(function (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Upload Failed',
                        text: error.message,
                        confirmButtonColor: '#008894'
                    });
                })
                .uploadExcelData(parsedData);
        }
    </script>
</body>

</html>