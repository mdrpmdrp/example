<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search & Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f3cc23',
                        secondary: '#008894'
                    }
                }
            }
        }
    </script>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js for dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --brand-primary: #f3cc23;
            --brand-primary-rgb: 243, 204, 35;
            --brand-secondary: #008894;
            --brand-secondary-rgb: 0, 136, 148;
            --color-error: #ef4444;
            --color-error-rgb: 239, 68, 68;
            --color-warning: #f59e0b;
            --color-warning-rgb: 245, 158, 11;
            --color-info: #3b82f6;
            --color-info-rgb: 59, 130, 246;
            --color-question: #8b5cf6;
            --color-question-rgb: 139, 92, 246;
        }

        /* Fallback utility classes for runtime-generated Tailwind-like classes */
        .text-primary {
            color: var(--brand-primary) !important;
        }

        .bg-primary {
            background-color: var(--brand-primary) !important;
        }

        .border-primary {
            border-color: var(--brand-primary) !important;
        }

        .text-secondary {
            color: var(--brand-secondary) !important;
        }

        .bg-secondary {
            background-color: var(--brand-secondary) !important;
        }

        /* Error/Warning/Info utilities */
        .text-error {
            color: var(--color-error) !important;
        }

        .bg-error {
            background-color: var(--color-error) !important;
        }

        .border-error {
            border-color: var(--color-error) !important;
        }

        .text-warning {
            color: var(--color-warning) !important;
        }

        .bg-warning {
            background-color: var(--color-warning) !important;
        }

        .text-info {
            color: var(--color-info) !important;
        }

        .bg-info {
            background-color: var(--color-info) !important;
        }

        .text-question {
            color: var(--color-question) !important;
        }

        .bg-question {
            background-color: var(--color-question) !important;
        }

        .hover\:bg-primary:hover {
            background-color: rgba(var(--brand-primary-rgb), 0.08) !important;
        }

        /* Avoid reducing element opacity (which made text hard to read) */
        .hover\:bg-opacity-10:hover {
            background-color: rgba(var(--brand-primary-rgb), 0.10) !important;
        }

        .focus\:border-secondary:focus {
            border-color: var(--brand-secondary) !important;
        }

        .focus\:ring-secondary:focus {
            box-shadow: 0 0 0 4px rgba(var(--brand-secondary-rgb), 0.12) !important;
        }

        * {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .gradient-bg {
            background: var(--brand-secondary);
        }

        .gradient-accent {
            background: var(--brand-primary);
        }

        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(var(--brand-secondary-rgb), 0.25);
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        /* SweetAlert2 Tailwind Customization */
        .swal2-popup {
            font-family: 'Noto Sans Thai', sans-serif !important;
            border-radius: 1.5rem !important;
            padding: 2rem !important;
        }

        .swal2-title {
            font-size: 1.875rem !important;
            font-weight: 700 !important;
            color: var(--brand-secondary) !important;
            margin-bottom: 1rem !important;
        }

        .swal2-html-container {
            font-size: 1rem !important;
            color: #4b5563 !important;
            line-height: 1.5 !important;
        }

        .swal2-confirm {
            background-color: var(--brand-secondary) !important;
            color: white !important;
            font-weight: 600 !important;
            padding: 0.75rem 2rem !important;
            border-radius: 0.75rem !important;
            border: none !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 6px rgba(var(--brand-secondary-rgb), 0.3) !important;
        }

        .swal2-confirm:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 8px rgba(var(--brand-secondary-rgb), 0.4) !important;
        }

        .swal2-cancel {
            background-color: #ef4444 !important;
            color: white !important;
            font-weight: 600 !important;
            padding: 0.75rem 2rem !important;
            border-radius: 0.75rem !important;
            border: none !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3) !important;
        }

        .swal2-cancel:hover {
            background-color: #dc2626 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 8px rgba(239, 68, 68, 0.4) !important;
        }

        .swal2-icon {
            border-width: 4px !important;
            margin: 0 auto 1.5rem !important;
        }

        .swal2-icon.swal2-success {
            border-color: var(--brand-primary) !important;
        }

        .swal2-icon.swal2-success [class^='swal2-success-line'] {
            background-color: var(--brand-primary) !important;
        }

        .swal2-icon.swal2-success .swal2-success-ring {
            border-color: rgba(var(--brand-primary-rgb), 0.3) !important;
        }

        .swal2-icon.swal2-error {
            border-color: var(--color-error) !important;
        }

        .swal2-icon.swal2-error [class^='swal2-x-mark-line'] {
            background-color: var(--color-error) !important;
        }

        .swal2-icon.swal2-warning {
            border-color: var(--color-warning) !important;
            color: var(--color-warning) !important;
        }

        .swal2-icon.swal2-info {
            border-color: var(--color-info) !important;
            color: var(--color-info) !important;
        }

        .swal2-icon.swal2-question {
            border-color: var(--color-question) !important;
            color: var(--color-question) !important;
        }

        .swal2-loader {
            border-color: var(--brand-secondary) transparent var(--brand-secondary) transparent !important;
        }

        .swal2-actions {
            gap: 1rem !important;
            margin-top: 2rem !important;
        }

        /* Layout and UI utilities */
        .container-card {
            background: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
            padding: 1rem;
        }

        .btn-primary {
            background: var(--brand-primary);
            color: #0b0b0b;
            padding: 0.5rem 0.9rem;
            border-radius: 0.6rem;
            font-weight: 600;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(var(--brand-primary-rgb), 0.12);
        }

        .btn-secondary {
            background: var(--brand-secondary);
            color: #ffffff;
            padding: 0.5rem 0.9rem;
            border-radius: 0.6rem;
            font-weight: 600;
            border: none;
        }

        .btn-outline {
            background: transparent;
            color: var(--brand-secondary);
            padding: 0.45rem 0.8rem;
            border-radius: 0.6rem;
            border: 2px solid rgba(var(--brand-secondary-rgb), 0.12);
            font-weight: 600;
        }

        /* Improve table header visibility */
        table.min-w-full thead th {
            background: linear-gradient(90deg, rgba(var(--brand-secondary-rgb), 0.95), rgba(var(--brand-secondary-rgb), 0.85));
            color: #fff;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-white rounded-3xl shadow-2xl p-10 max-w-md w-full hover-lift border-t-4 border-primary">
            <div class="text-center mb-8">
                <div class="bg-secondary rounded-2xl p-4 inline-block mb-6 shadow-xl">
                    <img id="logoImage" src="" alt="Logo" class="h-24 mx-auto bg-secondary">
                </div>
                <p class="text-gray-600 text-lg">
                    ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                </p>
            </div>

            <div class="space-y-4">
                <div class="space-y-3">
                    <div>
                        <label for="emailInput" class="block text-sm font-semibold text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" id="emailInput" placeholder="Enter your email"
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-secondary focus:ring-2 focus:ring-secondary focus:ring-opacity-20 transition outline-none">
                    </div>
                    <div>
                        <label for="passwordInput"
                            class="block text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="passwordInput" placeholder="Enter your password"
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:border-secondary focus:ring-2 focus:ring-secondary focus:ring-opacity-20 transition outline-none">
                    </div>
                </div>

                <button id="loginBtn" class="btn-primary w-full flex items-center justify-center gap-3 py-4">
                    <i class="fas fa-sign-in-alt text-lg"></i>
                    ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ
                </button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden max-w-10xl mx-auto px-2 sm:px-4 md:px-6">
        <!-- Header Section - Responsive -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between px-2 sm:px-4 py-3 gap-3">
            <div class="flex items-center gap-2 sm:gap-3">
                <img id="headerLogo" src="" alt="Logo" class="h-12 sm:h-14 md:h-18 bg-secondary rounded-xl p-1">
                <div class="flex-1 min-w-0">
                    <div id="userEmail" class="text-xs sm:text-sm text-gray-700 truncate"></div>
                </div>
            </div>
            <div class="flex justify-end sm:justify-start">
                <button id="logoutBtn" class="btn-secondary text-sm sm:text-base px-4 py-2">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="mb-4">
            <div class="bg-white rounded-xl shadow-sm p-2">
                <div class="flex gap-2">
                    <button id="incomeTab" class="flex-1 px-4 py-3 rounded-lg font-semibold transition-all duration-200 bg-primary text-gray-900">
                        <i class="fas fa-money-bill-wave mr-2"></i>
                        ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
                    </button>
                    <button id="expenseTab" class="flex-1 px-4 py-3 rounded-lg font-semibold transition-all duration-200 bg-gray-100 text-gray-600 hover:bg-gray-200">
                        <i class="fas fa-credit-card mr-2"></i>
                        ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
                    </button>
                </div>
            </div>
        </div>

        <!-- Global Filters (apply to all sections) - Responsive -->
        <div class="mb-4">
            <div class="bg-white rounded-xl shadow-sm p-3 md:p-3">
                <div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4">
                    <!-- Filter Label -->
                    <div class="flex items-center text-sm font-semibold text-gray-700 md:border-r md:pr-4 border-b md:border-b-0 pb-2 md:pb-0">
                        <i class="fas fa-filter mr-2 text-secondary"></i>
                        <span class="whitespace-nowrap">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</span>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div class="flex flex-col sm:flex-row gap-3 md:gap-3 flex-1">
                        <!-- Month Filter -->
                        <div class="flex-1 md:flex-none md:w-auto">
                            <label for="monthFilter" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 md:hidden">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                            <div class="flex items-center gap-2">
                                <label for="monthFilter" class="hidden md:block text-sm font-semibold text-gray-700 whitespace-nowrap">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                                <select id="monthFilter" class="w-full md:w-auto px-3 py-2 md:py-1.5 rounded-lg border-2 border-gray-300 focus:border-secondary focus:ring-2 focus:ring-secondary focus:ring-opacity-20 transition outline-none text-sm">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                    <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                    <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                    <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                    <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                    <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                    <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Year Filter -->
                        <div class="flex-1 md:flex-none md:w-auto">
                            <label for="yearFilter" class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 md:hidden">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ:</label>
                            <div class="flex items-center gap-2">
                                <label for="yearFilter" class="hidden md:block text-sm font-semibold text-gray-700 whitespace-nowrap">‡∏õ‡∏µ:</label>
                                <select id="yearFilter" class="w-full md:w-auto px-3 py-2 md:py-1.5 rounded-lg border-2 border-gray-300 focus:border-secondary focus:ring-2 focus:ring-secondary focus:ring-opacity-20 transition outline-none text-sm">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Clear Button -->
                        <div class="flex items-end md:items-center">
                            <button id="clearFilterBtn" class="btn-outline text-base w-full sm:w-auto px-6 md:px-4 py-2 md:py-1.5 whitespace-nowrap">
                                <i class="fas fa-redo mr-1"></i>
                                ‡∏•‡πâ‡∏≤‡∏á
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- income summary -->
        <div id="incomeSection" class="bg-white rounded-2xl shadow-xl p-4 md:p-8 mb-8 border-t-4 border-primary">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 gap-4">
                <h2 class="text-xl md:text-2xl font-bold text-secondary">
                    <i class="fas fa-money-bill-wave mr-2 text-primary"></i>
                    ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2>
                <button id="exportIncomeBtn" class="btn-primary flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV
                </button>
            </div>
            <div class="-mx-4 md:mx-0" style="max-height: 900px; overflow-y: auto; overflow-x: auto;">
                <table class="min-w-full divide-y divide-gray-200" id="incomeSummaryTable"></table>
            </div>
        </div>

        <!-- expense summary -->
        <div id="expenseSection" class="bg-white rounded-2xl shadow-xl p-4 md:p-8 mb-8 border-t-4 border-primary hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 gap-4">
                <h2 class="text-xl md:text-2xl font-bold text-secondary">
                    <i class="fas fa-credit-card mr-2 text-primary"></i>
                    ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h2>
                <button id="exportExpenseBtn" class="btn-primary flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV
                </button>
            </div>
            <div class="-mx-4 md:mx-0" style="max-height: 900px; overflow-y: auto; overflow-x: auto;">
                <table class="min-w-full divide-y divide-gray-200" id="expenseSummaryTable"></table>
            </div>
        </div>
    </div>

    <script>
        const logo = {
            horizontal_for_dark_bg: "https://lh3.googleusercontent.com/d/1DzVv43LvyMqATfAasNzYVi9jcuwLiLIJ",
            horizontal_for_light_bg: "https://lh3.googleusercontent.com/d/1ikTzT4LSsbwpdZJxd-h3zzpk798vHsvt",
            horizontal_black: 'https://lh3.googleusercontent.com/d/1yOt7i1RFnd37TzNSQFZ-1Tlz7uk-qooQ',
            horizontal_green: 'https://lh3.googleusercontent.com/d/174bSV3bSBsekE5AtPY7ewqVnqsjdxC80',
            horizontal_white: 'https://lh3.googleusercontent.com/d/1zQ_ivzbELCeI0QVJBFvIMcASVHiwqF0y',
            vertical_for_light_bg: "https://lh3.googleusercontent.com/d/1PxhO4Hs0-1Agwx53w6qf9104P7tLkC50",
            vertical_for_dark_bg: "https://lh3.googleusercontent.com/d/1srYa4g-W5bv26oJ5IxAsp9bMlD7tKuWJ",
            vertical_black: 'https://lh3.googleusercontent.com/d/1pEh7sDTG4qJUByxcDIjpvBiJ33NBKZqO',
            vertical_green: 'https://lh3.googleusercontent.com/d/1Et6WFjtSoShT3TeFHE8Q4Zw16aK_xB8Q',
            vertical_white: 'https://lh3.googleusercontent.com/d/1vbQZzcOedD08NPSJ0tUsYen26hktvYfy',
            no_text_black: 'https://lh3.googleusercontent.com/d/1HBcPImI-uPvb1A6nADAhxZA6aYse34LK',
            no_text_green: 'https://lh3.googleusercontent.com/d/1wBfYigrNKtQJTglvbS2MitRlFD_YhuWvk',
            no_text_white: 'https://lh3.googleusercontent.com/d/1AM7dfdvXTxOiln50LS-wB7G39D_lnrYK',
            no_text_yellow: 'https://lh3.googleusercontent.com/d/1WY0PyPJoRX-tAZAiaJJ4lIpkFNPBfyih'
        }

        // Set logos (login + header)
        const loginLogoEl = document.getElementById('logoImage');
        if (loginLogoEl) loginLogoEl.src = logo.vertical_for_dark_bg;
        const headerLogoEl = document.getElementById('headerLogo');
        if (headerLogoEl) headerLogoEl.src = logo.vertical_for_dark_bg;

        let userData = [];
        let filteredData = [];
        let incomeExpenseChart = null;
        let monthlyTrendChart = null;
        let sessionKey = localStorage.getItem('sabairentSessionKey');
        if (sessionKey) {
            try {
                const sessionData = JSON.parse(sessionKey);
                if (sessionData.expires > Date.now() && sessionData.email) {
                    $('#userEmail').text(sessionData.email);
                    $('#loginScreen').addClass('hidden');
                    $('#mainDashboard').removeClass('hidden');
                    sessionData.expires = Date.now() + 2 * 60 * 60 * 1000; // Extend session by 2 hours
                    localStorage.setItem('sabairentSessionKey', JSON.stringify(sessionData));
                    loadUserData(sessionData.email);
                } else {
                    localStorage.removeItem('sabairentSessionKey');
                }
            } catch (e) {
                localStorage.removeItem('sabairentSessionKey');
            }
        }
        // Login handler
        $('#loginBtn').on('click', function () {
            const email = $('#emailInput').val().trim();
            const password = $('#passwordInput').val().trim();

            // Validation
            if (!email || !password) {
                Swal.fire({
                    iconHtml: '<i class="fas fa-exclamation-triangle" style="font-size: 5rem; color: #f59e0b;"></i>',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    customClass: {
                        icon: 'border-none'
                    }
                });
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                Swal.fire({
                    iconHtml: '<i class="fas fa-exclamation-triangle" style="font-size: 5rem; color: #f59e0b;"></i>',
                    title: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    customClass: {
                        icon: 'border-none'
                    }
                });
                return;
            }

            Swal.fire({
                iconHtml: '<i class="fas fa-spinner fa-spin" style="font-size: 5rem; color: #008894;"></i>',
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ...',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                customClass: {
                    icon: 'border-none'
                },
                allowOutsideClick: false,
                showConfirmButton: false
            });

            google.script.run
                .withSuccessHandler(function (response) {
                    response = JSON.parse(response);
                    Swal.close();
                    if (response.success) {
                        $('#userEmail').text(response.email);
                        $('#loginScreen').addClass('hidden');
                        $('#mainDashboard').removeClass('hidden');
                        $('#emailInput').val('');
                        $('#passwordInput').val('');
                        localStorage.setItem('sabairentSessionKey', JSON.stringify({ email: response.email, name: response.name, expires: Date.now() + 6 * 60 * 60 * 1000 })); // 6 hours
                        loadUserData(response.email);
                    } else {
                        Swal.fire({
                            iconHtml: '<i class="fas fa-times-circle" style="font-size: 5rem; color: #ef4444;"></i>',
                            title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
                            text: response.message,
                            customClass: {
                                icon: 'border-none'
                            }
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    Swal.fire({
                        iconHtml: '<i class="fas fa-times-circle" style="font-size: 5rem; color: #ef4444;"></i>',
                        title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: error.message,
                        customClass: {
                            icon: 'border-none'
                        }
                    });
                })
                .loginWithEmailPassword(email, password);
        });

        // Enter key press on password field
        $('#passwordInput').on('keypress', function (e) {
            if (e.which === 13) {
                $('#loginBtn').click();
            }
        });

        // Logout handler
        $('#logoutBtn').on('click', function () {
            Swal.fire({
                title: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
                iconHtml: '<i class="fas fa-question-circle" style="font-size: 5rem; color: #8b5cf6;"></i>',
                customClass: {
                    icon: 'border-none'
                },
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#mainDashboard').addClass('hidden');
                    $('#mainDashboard').addClass('hidden');
                    $('#loginScreen').removeClass('hidden');
                    userData = [];
                    filteredData = [];
                    localStorage.removeItem('sabairentSessionKey');
                }
            })
        });

        // Tab handlers
        $('#incomeTab').on('click', function () {
            $('#incomeTab').removeClass('bg-gray-100 text-gray-600 hover:bg-gray-200').addClass('bg-primary text-gray-900');
            $('#expenseTab').removeClass('bg-primary text-gray-900').addClass('bg-gray-100 text-gray-600 hover:bg-gray-200');
            $('#incomeSection').removeClass('hidden');
            $('#expenseSection').addClass('hidden');
        });

        $('#expenseTab').on('click', function () {
            $('#expenseTab').removeClass('bg-gray-100 text-gray-600 hover:bg-gray-200').addClass('bg-primary text-gray-900');
            $('#incomeTab').removeClass('bg-primary text-gray-900').addClass('bg-gray-100 text-gray-600 hover:bg-gray-200');
            $('#expenseSection').removeClass('hidden');
            $('#incomeSection').addClass('hidden');
        });

        // Search handlers
        $('#searchBtn').on('click', performSearch);
        $('#searchInput').on('keypress', function (e) {
            if (e.which === 13) {
                performSearch();
            }
        });
        $('#clearBtn').on('click', function () {
            $('#searchInput').val('');
            filteredData = userData;
            updateSummary();
        });

        function loadUserData(email) {
            console.log("üöÄ ~ loadUserData ~ email:", email)
            Swal.fire({
                iconHtml: '<i class="fas fa-spinner fa-spin" style="font-size: 5rem; color: #008894;"></i>',
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                customClass: {
                    icon: 'border-none'
                },
                allowOutsideClick: false,
                showConfirmButton: false
            });

            google.script.run
                .withSuccessHandler(function (data) {
                    data = JSON.parse(data);
                    console.log("üöÄ ~ loadUserData ~ data:", data)
                    Swal.close();
                    userData = data.data || {};
                    filteredData = data.data || {};
                    let thisMonth = new Date().getMonth() + 1;
                    let thisYear = new Date().getFullYear();
                    populateYearFilter()
                    $('#monthFilter').val(thisMonth);
                    $('#yearFilter').val(thisYear);
                    updateSummary()
                })
                .withFailureHandler(function (error) {
                    Swal.fire({
                        iconHtml: '<i class="fas fa-times-circle" style="font-size: 5rem; color: #ef4444;"></i>',
                        title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message,
                        customClass: {
                            icon: 'border-none'
                        }
                    });
                })
                .getUserData(email);
        }

        function populateYearFilter() {
            const yearFilter = $('#yearFilter');
            const currentYear = new Date().getFullYear();
            const startYear = currentYear - 5; // Adjust based on your data range

            for (let year = currentYear; year >= startYear; year--) {
                yearFilter.append(`<option value="${year}">${year}</option>`);
            }
        }
        // Filter button handlers
        $(document).on('click', '#applyFilterBtn', function () {
            updateSummary();
        });

        $(document).on('click', '#clearFilterBtn', function () {
            $('#monthFilter').val('');
            $('#yearFilter').val('');
            updateSummary();
        });

        $(document).on('change', '#monthFilter, #yearFilter', function () {
            updateSummary();
        });

        function performSearch() {
            const searchTerm = $('#searchInput').val().toLowerCase().trim();
            if (!searchTerm) {
                filteredData = userData;
            } else {
                filteredData = userData.filter(item => {
                    return (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                        (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                        (item.amount && item.amount.toString().includes(searchTerm));
                });
            }
            updateSummary();
        }

        function updateSummary() {
            const incomeData = userData.income || [];
            const expenseData = userData.expense || [];

            // Apply filters
            const filteredIncome = filterDataByMonthYear(incomeData);
            const filteredExpense = filterDataByMonthYear(expenseData);

            // Transform data - optimized
            const incomeGroupByListing = {};

            for (const item of filteredIncome) {
                const listing_name = item.listing_name || 'Uncategorized';
                const listing = item.listing || 'Uncategorized';
                const date = item.payout_date || 'Uncategorized';
                const type = item.type || 'Uncategorized';
                const amount = parseFloat(item.amount) || 0;
                const bankAccount = item.bank_account || '-';

                // Initialize nested objects only when needed
                if (!incomeGroupByListing[listing_name]) {
                    incomeGroupByListing[listing_name] = {};
                }

                if (!incomeGroupByListing[listing_name][date]) {
                    incomeGroupByListing[listing_name][date] = {
                        bankAccount,
                        listing,
                        types: {}
                    };
                }

                const dateTypes = incomeGroupByListing[listing_name][date].types;
                dateTypes[type] = (dateTypes[type] || 0) + amount;
                if (type === 'Co-Host payout') {
                    console.log("üöÄ ~ updateSummary ~ Co-Host payout amount:", amount);
                }
            }

            console.log("üöÄ ~ updateSummary ~ incomeGroupByListing:", incomeGroupByListing);
            renderIncomeSummary(incomeGroupByListing, filteredIncome);
            renderExpenseSummary(filteredExpense);
        }

        function filterDataByMonthYear(data) {
            const selectedMonth = $('#monthFilter').val();
            const selectedYear = $('#yearFilter').val();

            if (!selectedMonth && !selectedYear) {
                return data;
            }

            return data.filter(item => {
                const date = item.payout_date || item.date;
                if (!date || date === 'Uncategorized') return false;

                const itemDate = new Date(date);
                if (isNaN(itemDate.getTime())) return false;

                const itemMonth = itemDate.getMonth() + 1; // 1-12
                const itemYear = itemDate.getFullYear();

                let matchMonth = true;
                let matchYear = true;

                if (selectedMonth) {
                    matchMonth = itemMonth === parseInt(selectedMonth);
                }

                if (selectedYear) {
                    matchYear = itemYear === parseInt(selectedYear);
                }

                return matchMonth && matchYear;
            });
        }

        function renderIncomeSummary(incomeGroupByListing, incomeData) {
            // Get all unique types for dynamic columns
            const allTypes = new Set();
            incomeData.forEach(item => {
                if (item.type) {
                    allTypes.add(item.type);
                }
            });
            const typeColumns = Array.from(allTypes).sort();

            // Build table HTML
            let tableHeader = `
                        <thead class="bg-secondary sticky top-0 z-10">
                        <tr>
                            <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs font-bold text-white uppercase tracking-wider  bg-secondary z-20 min-w-[150px]">Listing Name</th>
                            <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs font-bold text-white uppercase tracking-wider min-w-[220px]">Listing</th>   
                            <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs font-bold text-white uppercase tracking-wider min-w-[120px]">Payout Date</th>
                            <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs font-bold text-white uppercase tracking-wider min-w-[120px]">Bank Account</th>
            `;

            // Add dynamic type columns
            typeColumns.forEach(type => {
                tableHeader += `
                            <th class="px-3 md:px-6 py-3 md:py-4 text-right text-xs font-bold text-white uppercase tracking-wider whitespace-nowrap min-w-[100px]">${type}</th>
                `;
            });

            tableHeader += `
                            <th class="px-3 md:px-6 py-3 md:py-4 text-right text-xs font-bold text-white uppercase tracking-wider whitespace-nowrap min-w-[100px]">Total</th>
                            </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;

            $('#incomeSummaryTable').html(tableHeader);
            let tableHTML = '<tbody class="bg-white divide-y divide-gray-200">';
            // Build table rows with rowspan logic
            let rowIndex = 0;
            const listingNames = Object.keys(incomeGroupByListing).sort();

            // Calculate grand totals for each type
            const grandTotals = {};
            let overallGrandTotal = 0;
            typeColumns.forEach(type => {
                grandTotals[type] = 0;
            });

            if (listingNames.length === 0) {
                tableHTML += `
                    <tr>
                        <td colspan="${4 + typeColumns.length + 1}" class="px-3 md:px-6 py-4 text-sm md:text-base text-center text-gray-500">No data available for the selected filters.</td>
                    </tr>
                `;
            }

            listingNames.forEach(listing_name => {
                const dates = incomeGroupByListing[listing_name];
                const sortedDates = Object.keys(dates).sort();
                const listingRowspan = sortedDates.length;

                // Calculate subtotals for this listing
                const listingSubtotals = {};
                let listingTotal = 0;
                typeColumns.forEach(type => {
                    listingSubtotals[type] = 0;
                });

                sortedDates.forEach((date, dateIndex) => {
                    const dateData = dates[date];
                    const bankAccount = dateData.bankAccount;
                    const types = dateData.types;
                    const listing = dateData.listing;
                    const room_link = dateData.room_link

                    let rowTotal = 0;
                    const rowClass = rowIndex % 2 === 0 ? 'bg-gray-50' : 'bg-white';

                    tableHTML += `<tr class="${rowClass} hover:bg-primary hover:bg-opacity-10 transition">`;

                    // Only add listing_name and listing cells for first row of each listing_name group
                    if (dateIndex === 0) {
                        tableHTML += `
                        <td rowspan="${listingRowspan}" class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-700 whitespace-nowrap align-top  bg-white z-10">${listing_name}</td>
                        <td rowspan="${listingRowspan}" class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-900 font-semibold whitespace-nowrap align-top bg-white">${listing}</td>
                `;
                    }

                    tableHTML += `
                        <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-700 whitespace-nowrap">${formatDate(date)}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-700 whitespace-nowrap">${bankAccount}</td>
                `;

                    // Add type amounts
                    typeColumns.forEach(type => {
                        const amount = types[type] || 0;
                        rowTotal += amount;
                        grandTotals[type] += amount;
                        listingSubtotals[type] += amount;
                        const formattedAmount = amount == 0 ? '-' : `${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                        tableHTML += `
                            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-900 text-right whitespace-nowrap">${formattedAmount}</td>
                `;
                    });

                    overallGrandTotal += rowTotal;
                    listingTotal += rowTotal;

                    // Add row total
                    tableHTML += `
                        <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm font-bold text-right whitespace-nowrap text-gray-900">${rowTotal === 0 ? '-' : `${rowTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`}</td>
                    </tr>
                `;

                    rowIndex++;
                });

                // Add subtotal row for this listing
                tableHTML += `
                    <tr class="bg-blue-50 border-t-2 border-blue-200 font-semibold">
                        <td colspan="4" class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-right text-blue-900">Total - ${listing_name}</td>
                `;
                
                typeColumns.forEach(type => {
                    const subtotal = listingSubtotals[type];
                    tableHTML += `
                        <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-right whitespace-nowrap text-blue-900">${subtotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    `;
                });

                tableHTML += `
                        <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm font-bold text-right whitespace-nowrap text-blue-900">${listingTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                `;
                rowIndex++;
            });

            // Add Grand Total Row
            tableHTML += `
                <tr class="bg-secondary text-white font-bold border-t-2 border-gray-300">
                    <td colspan="4" class="px-3 md:px-6 py-4 text-sm md:text-base text-right uppercase">Grand Total</td>
            `;

            typeColumns.forEach(type => {
                const total = grandTotals[type];
                tableHTML += `
                    <td class="px-3 md:px-6 py-4 text-xs md:text-sm text-right whitespace-nowrap">${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                `;
            });

            tableHTML += `
                    <td class="px-3 md:px-6 py-4 text-sm md:text-base text-right whitespace-nowrap">${overallGrandTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>
            `;

            tableHTML += `
                        </tbody>
            `;

            // Insert table into mainDashboard
            $('#mainDashboard table').append(tableHTML);
        }

        function renderExpenseSummary(expenseData) {
            // Sort by listing_name first, then by date
            expenseData = expenseData.sort((a, b) => {
                const listingCompare = (a.listing_name || 'Uncategorized').localeCompare(b.listing_name || 'Uncategorized');
                if (listingCompare !== 0) return listingCompare;
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateA - dateB;
            });
            let tableHeader = `
                        <thead class="bg-secondary sticky top-0 z-10">
                        <tr>
                            <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs font-bold text-white uppercase tracking-wider min-w-[200px]">Listing Name</th>
                            <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs font-bold text-white uppercase tracking-wider min-w-[150px]">Date</th>
                            <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs font-bold text-white uppercase tracking-wider min-w-[250px]">Description</th>
                            <th class="px-3 md:px-6 py-3 md:py-4 text-right text-xs font-bold text-white uppercase tracking-wider whitespace-nowrap min-w-[100px]">Amount</th>
                            <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs font-bold text-white uppercase tracking-wider min-w-[200px]">Category</th> 
                        </tr>
                        </thead>`
            $('#expenseSummaryTable').html(tableHeader);
            let tableHTML = '<tbody class="bg-white divide-y divide-gray-200">';
            let rowIndex = 0;
            let grandTotal = 0;
            if (expenseData.length === 0) {
                tableHTML += `
                    <tr>
                        <td colspan="5" class="px-3 md:px-6 py-4 text-sm md:text-base text-center text-gray-500">No data available for the selected filters.</td>
                    </tr>
                `;
            }
            
            // Group expenses by listing
            let currentListing = null;
            let listingSubtotal = 0;
            
            expenseData.forEach((item, index) => {
                const date = item.date || 'Uncategorized';
                const listing_name = item.listing_name || 'Uncategorized';
                const description = item.description || 'Uncategorized';
                const amount = parseFloat(item.amount) || 0;
                const category = item.category || 'Uncategorized';
                const formattedAmount = amount == 0 ? '-' : `${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                const textColorClass = amount < 0 ? 'text-error font-bold' : 'text-gray-900';

                // Check if we're starting a new listing group
                if (currentListing !== null && currentListing !== listing_name) {
                    // Add subtotal row for previous listing
                    tableHTML += `
                        <tr class="bg-blue-50 border-t-2 border-blue-200 font-semibold">
                            <td colspan="3" class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-right text-blue-900">Total - ${currentListing}</td>
                            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm font-bold text-right whitespace-nowrap text-blue-900">${listingSubtotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            <td></td>
                        </tr>
                    `;
                    listingSubtotal = 0;
                    rowIndex++;
                }
                
                currentListing = listing_name;
                listingSubtotal += amount;
                grandTotal += amount;
                const rowClass = rowIndex % 2 === 0 ? 'bg-gray-50' : 'bg-white';

                tableHTML += `
                    <tr class="${rowClass} hover:bg-primary hover:bg-opacity-10 transition">
                        <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-900 font-semibold whitespace-nowrap">${listing_name}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-700 whitespace-nowrap">${formatDate(date)}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-700">${description}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm font-bold text-right whitespace-nowrap text-gray-900">${formattedAmount}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-gray-700">${category}</td>
                    </tr>
                `;
                rowIndex++;
                
                // If this is the last item, add subtotal row
                if (index === expenseData.length - 1) {
                    tableHTML += `
                        <tr class="bg-blue-50 border-t-2 border-blue-200 font-semibold">
                            <td colspan="3" class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-right text-blue-900">Total - ${currentListing}</td>
                            <td class="px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm font-bold text-right whitespace-nowrap text-blue-900">${listingSubtotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            <td></td>
                        </tr>
                    `;
                    rowIndex++;
                }
            });
            // Add Grand Total Row
            tableHTML += `
                <tr class="bg-secondary text-white font-bold border-t-2 border-gray-300">
                    <td colspan="3" class="px-3 md:px-6 py-4 text-sm md:text-base text-right uppercase">Grand Total</td>
                    <td class="px-3 md:px-6 py-4 text-sm md:text-base text-right whitespace-nowrap ${grandTotal < 0 ? 'text-error font-bold' : 'text-white'}">${grandTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td></td>
                </tr>
            `;
            tableHTML += `
                        </tbody>`;
            // Insert table into mainDashboard
            $('#expenseSummaryTable').append(tableHTML);
        }


        function formatDate(dateString) {
            if (!dateString || dateString === 'Uncategorized') return dateString;
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch (e) {
                return dateString;
            }
        }

        // CSV Export Functions
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            return stringValue;
        }

        function downloadCSV(csvContent, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportIncomeToCSV() {
            const table = document.getElementById('incomeSummaryTable');
            if (!table) return;

            const headers = [];
            const headerCells = table.querySelectorAll('thead th');
            headerCells.forEach(cell => {
                headers.push(escapeCSV(cell.textContent.trim()));
            });
            const totalColumns = headers.length;

            // Get filter values
            const selectedMonth = $('#monthFilter').val();
            const selectedYear = $('#yearFilter').val();
            const monthNames = ['', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            
            let filterText = '‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á: ';
            if (selectedMonth && selectedYear) {
                filterText += `${monthNames[selectedMonth]} ${selectedYear}`;
            } else if (selectedMonth) {
                filterText += `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthNames[selectedMonth]}`;
            } else if (selectedYear) {
                filterText += `‡∏õ‡∏µ: ${selectedYear}`;
            } else {
                filterText += '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            }

            const rows = [];
            // Add filter information as first row
            rows.push(filterText);
            rows.push(''); // Empty row for spacing
            rows.push(headers.join(','));

            // Track values from merged cells (rowspan)
            let currentListingName = '';
            let currentListing = '';

            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;

                const rowData = [];
                
                // Check if this is the Grand Total row (has colspan)
                const firstCell = cells[0];
                if (firstCell && firstCell.hasAttribute('colspan')) {
                    // This is the Grand Total row
                    const colspanValue = parseInt(firstCell.getAttribute('colspan'));
                    const cellText = firstCell.textContent.trim();
                    
                    // Fill the colspan columns
                    for (let i = 0; i < colspanValue; i++) {
                        rowData.push(escapeCSV(i === colspanValue - 1 ? cellText : ''));
                    }
                    
                    // Add remaining cells
                    for (let i = 1; i < cells.length; i++) {
                        rowData.push(escapeCSV(cells[i].textContent.trim()));
                    }
                } else if (firstCell && firstCell.hasAttribute('rowspan')) {
                    // This row has the merged cells, extract and store them
                    currentListingName = firstCell.textContent.trim();
                    rowData.push(escapeCSV(currentListingName));

                    // Check for listing cell (second cell with rowspan)
                    const secondCell = cells[1];
                    if (secondCell && secondCell.hasAttribute('rowspan')) {
                        currentListing = secondCell.textContent.trim();
                        rowData.push(escapeCSV(currentListing));
                        
                        // Add remaining cells starting from index 2
                        for (let i = 2; i < cells.length; i++) {
                            rowData.push(escapeCSV(cells[i].textContent.trim()));
                        }
                    }
                } else {
                    // This row doesn't have the merged cells, use stored values
                    rowData.push(escapeCSV(currentListingName));
                    rowData.push(escapeCSV(currentListing));
                    
                    // Add remaining cells
                    for (let i = 0; i < cells.length; i++) {
                        rowData.push(escapeCSV(cells[i].textContent.trim()));
                    }
                }

                rows.push(rowData.join(','));
            });
            rows = rows.map(row =>{
                if(row.startsWith('Total')){
                    row = ",,"+ row; //shift total rows to match columns
                    return row;
                }
            })
            const csvContent = rows.join('\n');
            const timestamp = new Date().toISOString().slice(0, 10);
            downloadCSV(csvContent, `‡∏™‡∏£‡∏∏‡∏õ_‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö_${timestamp}.csv`);

            Swal.fire({
                iconHtml: '<i class="fas fa-check-circle" style="font-size: 5rem; color: #f3cc23;"></i>',
                title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡πÅ‡∏•‡πâ‡∏ß',
                timer: 2000,
                customClass: {
                    icon: 'border-none'
                },
                showConfirmButton: false
            });
        }

        function exportExpenseToCSV() {
            const table = document.getElementById('expenseSummaryTable');
            if (!table) return;

            const headers = [];
            const headerCells = table.querySelectorAll('thead th');
            headerCells.forEach(cell => {
                headers.push(escapeCSV(cell.textContent.trim()));
            });

            // Get filter values
            const selectedMonth = $('#monthFilter').val();
            const selectedYear = $('#yearFilter').val();
            const monthNames = ['', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            
            let filterText = '‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á: ';
            if (selectedMonth && selectedYear) {
                filterText += `${monthNames[selectedMonth]} ${selectedYear}`;
            } else if (selectedMonth) {
                filterText += `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthNames[selectedMonth]}`;
            } else if (selectedYear) {
                filterText += `‡∏õ‡∏µ: ${selectedYear}`;
            } else {
                filterText += '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            }

            const rows = [];
            // Add filter information as first row
            rows.push(filterText);
            rows.push(''); // Empty row for spacing
            rows.push(headers.join(','));

            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const rowData = [];
                    cells.forEach(cell => {
                        rowData.push(escapeCSV(cell.textContent.trim()));
                    });
                    rows.push(rowData.join(','));
                }
            });

            const csvContent = rows.join('\n');
            const timestamp = new Date().toISOString().slice(0, 10);
            downloadCSV(csvContent, `‡∏™‡∏£‡∏∏‡∏õ_‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢_${timestamp}.csv`);

            Swal.fire({
                iconHtml: '<i class="fas fa-check-circle" style="font-size: 5rem; color: #f3cc23;"></i>',
                title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡πÅ‡∏•‡πâ‡∏ß',
                timer: 2000,
                customClass: {
                    icon: 'border-none'
                },
                showConfirmButton: false
            });
        }

        // Export button event handlers
        $(document).on('click', '#exportIncomeBtn', exportIncomeToCSV);
        $(document).on('click', '#exportExpenseBtn', exportExpenseToCSV);

    </script>
</body>

</html>