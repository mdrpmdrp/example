<!DOCTYPE html>
<html lang="en">

<head>
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quick Deal Project</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@500&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <link
        href="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-2.3.3/b-3.2.4/b-html5-3.2.4/b-print-3.2.4/date-1.5.6/fh-4.0.3/r-3.0.6/rg-1.5.2/datatables.min.css"
        rel="stylesheet" integrity="sha384-kuwoa5wRG9jiSbQU8UlFSRVimYwMxMMr0PmWc4+qtixSKEMUjJea+yGNNJxgZHAt"
        crossorigin="anonymous" />
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/all.css" />
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/sharp-regular.css" />
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/sharp-solid.css" />
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/sharp-light.css" />
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/sharp-thin.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" />

    <script
        src="https://cdn.datatables.net/v/bs5/jszip-3.10.1/dt-2.3.3/b-3.2.4/b-html5-3.2.4/b-print-3.2.4/date-1.5.6/fh-4.0.3/r-3.0.6/rg-1.5.2/datatables.min.js"
        integrity="sha384-RypHhwssAIpm/FuQTXVEg72hEozAX/CHPHqJgOuPPTKtK8UR8LzghhaZ/YyPGuQx"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/rangePlugin.js"></script>

    <style>
        /* Custom modal theme */
        .modal-content {
            border-radius: 1rem;
        }

        .modal-header {
            background: var(--primary-color);
            color: #222;
        }

        .modal-title {
            color: #222;
        }

        .modal .btn-primary {
            background: var(--primary-color) !important;
            color: #222 !important;
        }

        .modal .btn-primary:hover {
            background: var(--primary-color-dark) !important;
            color: #fff !important;
        }

        .modal .btn-secondary {
            background: #eee !important;
            color: #222 !important;
        }

        * {
            font-family: "Noto Sans Thai", sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--grey);
        }

        :root {
            --primary-color: #d4bf9c;
            --primary-color-dark: #bfa76e;
            --primary-color-light: #e8d8b5;
            --grey: #f6f6f6;
        }

        .btn-primary,
        .primary-bg {
            background: var(--primary-color) !important;
            color: #222 !important;
            border-color: var(--primary-color-dark) !important;
        }

        .btn-primary:hover,
        .primary-bg:hover {
            background: var(--primary-color-dark) !important;
            color: #fff !important;
        }

        .primary-text,
        a,
        a:visited {
            color: var(--primary-color) !important;
        }

        a:hover {
            color: var(--primary-color-dark) !important;
        }

        .navbar,
        header,
        .main-card,
        .card,
        .panel {
            border-color: var(--primary-color) !important;
        }

        .form-control:focus,
        input:focus,
        textarea:focus {
            border-color: var(--primary-color-dark) !important;
            box-shadow: 0 0 0 2px var(--primary-color-light) !important;
        }

        ::selection {
            background: var(--primary-color-light);
        }

        /* Splash screen styles */
        #splash-screen {
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: #fffbe9ee;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        #splash-screen.hide {
            opacity: 0;
            pointer-events: none;
        }

        .splash-spinner {
            width: 3.5rem;
            height: 3.5rem;
            border: 6px solid #e0d3b2;
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        table.dataTable {

            thead,
            tbody {
                tr {

                    th,
                    td {
                        vertical-align: middle;
                        min-width: 100px;
                    }
                }

                tr.status-inactive {
                    td {
                        color: rgba(0, 0, 0, 0.4);
                    }

                    span.status-btn {
                        background-color: #ccc !important;
                        color: #666 !important;
                        border-color: #999 !important;
                        cursor: not-allowed !important;
                    }

                    button.edit-row-btn {
                        cursor: not-allowed !important;
                    }
                }
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div id="splash-screen">
            <div class="splash-spinner"></div>
        </div>
        <section id="login-sec" style="display: none">
            <div class="row justify-content-center align-items-start">
                <div class="col-12 col-sm-8 col-md-5 col-lg-4">
                    <div class="card shadow-lg border-0 rounded-4 my-5">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-center align-items-center h2">
                                <img src="https://www.samitivejchonburi.com/html/images/icon-cat-02.png" alt="Logo"
                                    class="img-fluid" />
                                <span class="fw-bold">เข้าสู่ระบบ</span>
                            </div>
                            <form id="loginForm" class="needs-validation" novalidate>
                                <div class="mb-3">
                                    <label for="loginUsername" class="form-label">ชื่อผู้ใช้</label>
                                    <input type="text" class="form-control rounded-3" id="loginUsername"
                                        placeholder="username" required />
                                    <div class="invalid-feedback">กรุณากรอกชื่อผู้ใช้</div>
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">รหัสผ่าน</label>
                                    <input type="password" class="form-control rounded-3" id="loginPassword"
                                        placeholder="••••••••" required />
                                    <div class="invalid-feedback">กรุณากรอกรหัสผ่าน</div>
                                </div>
                                <button type="submit" class="btn btn-primary border-0 w-100 rounded-3 fw-semibold py-2">
                                    เข้าสู่ระบบ
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="main-sec" style="display: none" class="mb-5">
            <div class="d-flex justify-content-between align-items-center p-3">
                <div class="d-flex align-items-center me-3 gap-1">
                    <img src="https://www.samitivejchonburi.com/html/images/icon-cat-02.png" alt="Logo"
                        style="height: 3rem" />
                    <span class="fw-bold primary-text" id="userName"></span>
                    <span class="badge" id="userRole"
                        style="background-color: var(--primary-color); color: #222"></span>
                </div>
                <div>
                    <button id="logoutBtn" class="btn btn-sm rounded-3 btn-outline-danger">
                        Logout
                        <i class="bi bi-door-open-fill ms-2"></i>
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <h3 class="fw-bold primary-text text-center mb-3">
                        <i class="bi bi-lightning-charge-fill me-2"></i>
                        Quick Deal Project
                    </h3>
                </div>
                <div class="col-12">
                    <div class="table-responsive">
                        <table id="mainTable" class="table table-striped table-bordered table-hover"
                            style="width: 100%">
                            <thead></thead>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <!-- Edit Data Modal -->
    <div class="modal fade" id="editDataModal" tabindex="-1" aria-labelledby="editDataModalLabel" aria-hidden="true"
        data-bs-backdrop="static  ">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title" id="editDataModalLabel">แก้ไขข้อมูล</h5>
                    <button type="button" class="btn-close dismiss-edit-modal" id="editModalCloseBtn" aria-label="Close"
                        data-bs-theme="dark"></button>
                </div>
                <div class="modal-body">
                    <form id="editDataForm" class="needs-validation mb-3" novalidate>
                        <input type="hidden" id="editKey" name="key" value="" />
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editHN" class="form-label">HN</label>
                                <input type="text" class="form-control rounded-3" id="editHN" name="hn" required />
                            </div>
                            <div class="col-md-6">
                                <label for="editCompany" class="form-label">บริษัท</label>
                                <input type="text" class="form-control rounded-3" id="editCompany" name="company" />
                            </div>
                            <div class="col-md-6">
                                <label for="editEmployeeId" class="form-label">รหัสพนักงาน</label>
                                <input type="text" class="form-control rounded-3" id="editEmployeeId"
                                    name="employeeId" />
                            </div>
                            <div class="col-md-6">
                                <label for="editPrefix" class="form-label">คำนำหน้า</label>
                                <input type="text" class="form-control rounded-3" id="editPrefix" name="prefix"
                                    list="prefixList" />
                                <datalist id="prefixList">
                                    <option value="นาย"></option>
                                    <option value="นาง"></option>
                                    <option value="นางสาว"></option>
                                    <option value="Mr."></option>
                                    <option value="Mrs."></option>
                                    <option value="Ms."></option>
                                </datalist>
                            </div>
                            <div class="col-md-6">
                                <label for="editFullName" class="form-label">ชื่อนามสกุล <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control rounded-3" id="editFullName" name="fullName"
                                    required />
                                <div class="invalid-feedback">กรุณากรอกชื่อนามสกุล</div>
                            </div>
                            <div class="col-md-6">
                                <label for="editBirthDate" class="form-label">วันเกิด <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control rounded-3" id="editBirthDate" name="birthDate"
                                    required />
                                <div class="invalid-feedback">กรุณากรอกวันเกิด</div>
                            </div>
                            <div class="col-md-6">
                                <label for="editCitizenId" class="form-label">เลขบัตรประชาชน <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control rounded-3" id="editCitizenId" name="citizenId"
                                    required inputmode="numeric" pattern="\d{13}" maxlength="13" />
                                <div class="invalid-feedback">กรุณากรอกเลขบัตรประชาชน</div>
                            </div>
                            <div class="col-md-6">
                                <label for="editPhoneNumber" class="form-label">เบอร์โทรศัพท์ <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control rounded-3" id="editPhoneNumber" name="phone"
                                    required inputmode="numeric" pattern="\d{10}" maxlength="10" />
                                <div class="invalid-feedback">กรุณากรอกเบอร์โทรศัพท์</div>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <label for="editCheckupProgram" class="form-label">โปรแกรมตรวจ</label>
                                    <button type="button" class="btn btn-sm" id="copyCheckupProgramBtn">
                                        <i class="bi bi-clipboard me-1"></i> คัดลอก
                                    </button>
                                </div>
                                <textarea class="form-control rounded-3" id="editCheckupProgram" name="checkupProgram"
                                    rows="5"></textarea>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <label for="editAdditionalCheckupProgram" class="form-label">โปรแกรมตรวจ
                                        เพิ่มเติม</label>
                                    <button type="button" class="btn btn-sm" id="copyAdditionalCheckupProgramBtn">
                                        <i class="bi bi-clipboard me-1"></i> คัดลอก
                                    </button>
                                </div>
                                <textarea class="form-control rounded-3" id="editAdditionalCheckupProgram"
                                    name="additionalCheckupProgram" rows="5"></textarea>
                            </div>
                            <div class="col-12">
                                <label for="editEntitlementDocument" class="form-label">เอกสารขอรับสิทธิ</label>
                                <input type="text" class="form-control rounded-3" id="editEntitlementDocument"
                                    name="entitlementDocument" />
                            </div>
                            <div class="col-md-6">
                                <label for="editStartDate" class="form-label">วันเริ่ม</label>
                                <input type="text" class="form-control rounded-3" id="editStartDate" name="startDate" />
                            </div>
                            <div class="col-md-6">
                                <label for="editEndDate" class="form-label">วันสิ้นสุด</label>
                                <input type="text" class="form-control rounded-3" id="editEndDate" name="endDate" />
                            </div>
                            <div class="col-md-6">
                                <label for="editServiceStatus" class="form-label">สถานะรับบริการ</label>
                                <select class="form-select rounded-3" id="editServiceStatus" name="serviceStatus">
                                    <option value="">-- เลือกสถานะ --</option>
                                    <? if (lists && lists.status && Array.isArray(lists.status)) { ?>
                                    <? lists.status.forEach(status =>
                    { ?>
                                    <option value="<?!= status ?>">
                                        <?!= status ?>
                                    </option>
                                    <? }) ?>
                                    <? } ?>
                                </select>
                            </div>
                            <div class="col-md-6 d-none" id="editServiceDateContainer">
                                <label for="editServiceDate" class="form-label">วันลงทะเบียน</label>
                                <input type="text" class="form-control rounded-3" id="editServiceDate"
                                    name="serviceDate" readonly />
                            </div>
                            <div class="col-12">
                                <label for="editRegisterNote" class="form-label">หมายเหตุ(แผนกRegister)</label>
                                <textarea class="form-control" id="editRegisterNote" name="registerNote"
                                    rows="5"></textarea>
                            </div>
                            <div class="col-12">
                                <label for="editOpdNote" class="form-label">หมายเหตุ(แผนกOPD)</label>
                                <textarea class="form-control" id="editOpdNote" name="opdNote" rows="5"></textarea>
                            </div>
                        </div>
                        <button type="submit" style="display: none"></button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border me-auto px-4 py-2 rounded-3 dismiss-edit-modal">
                        <i class="bi bi-x-circle me-1"></i> ยกเลิก
                    </button>
                    <button type="button" class="btn btn-primary px-4 py-2 rounded-3 fw-semibold" id="saveEditBtn">
                        <i class="bi bi-save me-1"></i> บันทึก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- update status modal -->
    <div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateStatusModalLabel">อัปเดตสถานะ</h5>
                    <button type="button" class="btn-close dismiss-update-modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title mb-2">ข้อมูลผู้ป่วย</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">HN:</small>
                                    <div id="briefHn" class="fw-semibold">-</div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">ชื่อ-นามสกุล:</small>
                                    <div id="briefFullName" class="fw-semibold">-</div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">บริษัท:</small>
                                    <div id="briefCompany" class="fw-semibold">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <form id="updateStatusForm">
                        <input type="hidden" id="statusHn" name="hn" value="" />
                        <div class="mb-3">
                            <label for="statusSelect" class="form-label">เลือกสถานะ</label>
                            <select class="form-select" id="statusSelect" name="status">
                                <option value="">-- เลือกสถานะ --</option>
                                <? if (lists && lists.status && Array.isArray(lists.status)) { ?>
                                <? lists.status.slice(1).forEach(status =>
                  { ?>
                                <option value="<?!= status ?>">
                                    <?!= status ?>
                                </option>
                                <? }) ?>
                                <? } ?>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="statusOpdNote" class="form-label">หมายเหตุ (แผนก OPD)</label>
                            <textarea class="form-control" id="statusOpdNote" name="opdNote" rows="6"
                                placeholder="กรอกหมายเหตุ (ถ้ามี)"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="text-danger">
                                <i class="bi bi-exclamation-circle me-1"></i>
                                กรุณาตรวจสอบข้อมูลให้ถูกต้องก่อนบันทึก
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border me-auto px-4 py-2 rounded-3 dismiss-update-modal">
                        <i class="bi bi-x-circle me-1"></i> ยกเลิก
                    </button>
                    <button type="button" class="btn btn-primary px-4 py-2 rounded-3 fw-semibold" id="saveStatusBtn">
                        <i class="bi bi-save me-1"></i> บันทึก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- select date range to export to excel modal -->
    <div class="modal fade" id="selectDateRangeModal" tabindex="-1" aria-labelledby="selectDateRangeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="selectDateRangeModalLabel">
                        เลือกช่วงวันที่
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dateRangeForm">
                        <!-- <div class="mb-3">
                            <label for="exportStartDate" class="form-label">วันที่เริ่มต้น</label>
                            <input type="date" class="form-control" id="exportStartDate" name="exportStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="exportEndDate" class="form-label">วันที่สิ้นสุด</label>
                            <input type="date" class="form-control" id="exportEndDate" name="exportEndDate" required>
                        </div> -->
                        <div class="row">
                            <div class="col-md-6">
                                <label for="exportStartDate" class="form-label">วันที่เริ่มต้น</label>
                                <input type="text" class="form-control" id="exportStartDate" name="exportStartDate"
                                    required />
                            </div>
                            <div class="col-md-6">
                                <label for="exportEndDate" class="form-label">วันที่สิ้นสุด</label>
                                <input type="text" class="form-control" id="exportEndDate" name="exportEndDate"
                                    required />
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border me-auto px-4 py-2 rounded-3"
                        data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> ยกเลิก
                    </button>
                    <button type="button" class="btn btn-primary px-4 py-2 rounded-3 fw-semibold"
                        id="confirmExportExcelBtn">
                        <i class="bi bi-file-earmark-excel-fill me-1"></i> Export Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const SwalCustomClasses = {
            popup: "rounded-4",
            confirmButton: "btn btn-primary border-0 rounded-3 px-4 py-2",
            cancelButton: "btn btn-danger border-0 rounded-3 px-4 py-2",
        };
        // Generate 10 distinct colors for status
        const statusColors = [
            // Each entry: [backgroundColor, textColor]
            ["#FFB300", "#222"], // 1 - Vivid Yellow
            ["#803E75", "#fff"], // 2 - Strong Purple
            ["#FF6800", "#fff"], // 3 - Vivid Orange
            ["#A6BDD7", "#222"], // 4 - Very Light Blue
            ["#C10020", "#fff"], // 5 - Vivid Red
            ["#CEA262", "#222"], // 6 - Grayish Yellow
            ["#817066", "#fff"], // 7 - Medium Gray
            ["#007D34", "#fff"], // 8 - Vivid Green
            ["#F6768E", "#222"], // 9 - Strong Purplish Pink
            ["#00538A", "#fff"], // 10 - Strong Blue
        ];
        $(document).ready(function () {
            checkLogin();
        });
        const getUser = () =>
            JSON.parse(localStorage.getItem("quickdealuser") || "{}");
        const setUser = (user) =>
            localStorage.setItem("quickdealuser", JSON.stringify(user));
        const clearUser = () => localStorage.removeItem("quickdealuser");
        const refreshUser = (user) => {
            user.expiry = new Date().getTime() + 3600000; // 1 hour
            setUser(user);
            // Update UI or perform any other necessary actions
        };

        function initApp() {
            // Initialize your app here
            console.log("App initialized");
            // Show placeholder while loading
            let statusOptions = $("#editServiceStatus option")
                .map(function () {
                    return $(this).val();
                })
                .get();
            console.log(statusOptions);
            const role = getUser().role?.toLowerCase();
            window.MainTable = $("#mainTable").DataTable({
                serverSide: false,
                processing: true,
                destroy: true,
                ajax: function (data, callback, settings) {
                    google.script.run
                        .withFailureHandler((e) => {
                            console.log(e);
                        })
                        .withSuccessHandler((response) => {
                            var data = JSON.parse(response);
                            if (!data || !data.success) {
                                Swal.fire({
                                    title: "เกิดข้อผิดพลาด",
                                    text: response.message || "ไม่สามารถโหลดข้อมูลได้ในขณะนี้",
                                    icon: "error",
                                    confirmButtonText: "ตกลง",
                                    customClass: SwalCustomClasses,
                                });
                                return;
                            }
                            data = data.data;

                            // Update the DataTable with the response data
                            callback({
                                recordsTotal: data.length, // Total records in the dataset
                                recordsFiltered: data.length, // Filtered records
                                data: data, // Data for the current page
                            });
                        })
                        .getContractData(role);
                },
                responsive: true,
                // scrollX: true,
                dom:
                    '<"container-fluid"<"row justify-content-between"<"col-auto d-flex custom-length"><"col-auto custom-filter">>' +
                    '<"row mt-2 mb-2 mb-md-0 justify-content-between"<"col-auto"B><"col-auto date-range-filter">>' +
                    '<"row"<"col-md-12 mt-2"t>>' +
                    '<"row justify-content-between mt-2"<"col-auto"i><"col-auto"p>>>',
                pagelength: 10,
                lengthMenu: [
                    [10, 25, 50, -1],
                    [10, 25, 50, "All"],
                ],
                columns: [
                    {
                        title: "#",
                        data: null,
                        orderable: false,
                        searchable: false,
                        className: "dt-body-center",
                        render: function (data, type, row, meta) {
                            if (type === "sort" || type === "type") {
                                return "";
                            }
                            return meta.row + 1 + meta.settings._iDisplayStart;
                        },
                    },
                    { title: "บริษัท", data: "company", className: "all" },
                    {
                        title: "HN",
                        data: "hn",
                        className: "dt-head-center dt-head-nowrap text-nowrap all",
                    },
                    {
                        title: "รหัสพนักงาน",
                        data: "employeeId",
                        className: "dt-head-center dt-head-nowrap text-nowrap all",
                    },
                    { title: "คำนำหน้า", data: "prefix" },
                    {
                        title: "ชื่อนามสกุล",
                        data: "fullName",
                        className: "dt-head-center dt-head-nowrap text-nowrap all",
                    },
                    {
                        title: "วันเกิด",
                        data: "birthDate",
                        className: "dt-head-center dt-head-nowrap text-nowrap",
                        render: function (data, type, row) {
                            if (type === "sort" || type === "type") {
                                return data ? moment(data).format("YYYYMMDD") : "";
                            }
                            return data ? moment(data).format("DD/MM/YYYY") : "";
                        },
                    },
                    {
                        title: "เลขบัตรประชาชน",
                        data: "citizenId",
                        className: "dt-head-center dt-head-nowrap text-nowrap all",
                        render: function (data, type, row) {
                            if (type === "sort" || type === "type") {
                                return data ? data : "";
                            }
                            return data
                                .toString()
                                .replace(
                                    /^(\d{1})(\d{4})(\d{5})(\d{2})(\d{1})$/,
                                    "$1-$2-$3-$4-$5"
                                );
                        },
                    },
                    {
                        title: "เบอร์โทรศัพท์",
                        data: "phone",
                        className: "dt-head-center dt-head-nowrap text-nowrap",
                    },
                    {
                        title: "โปรแกรมตรวจ",
                        data: "checkupProgram",
                        createdCell: function (td) {
                            $(td).css("min-width", "300px");
                        },
                    },
                    {
                        title: "โปรแกรมตรวจ เพิ่มเติม",
                        data: "additionalCheckupProgram",
                        createdCell: function (td) {
                            $(td).css("min-width", "300px");
                        },
                    },
                    { title: "เอกสารขอรับสิทธิ", data: "entitlementDocument" },
                    {
                        title: "วันเริ่ม",
                        data: "startDate",
                        className: "dt-head-center dt-head-nowrap text-nowrap",
                    },
                    {
                        title: "วันสิ้นสุด",
                        data: "endDate",
                        className: "dt-head-center dt-head-nowrap text-nowrap",
                    },
                    {
                        title: "สถานะรับบริการ",
                        data: "serviceStatus",
                        className:
                            "dt-body-center dt-head-center dt-head-nowrap text-nowrap all",
                        render: function (data, type, row) {
                            if (type === "sort" || type === "type") {
                                return data || "";
                            }
                            if (!data) return "";
                            // Use a map for faster lookup if statusOptions is large
                            const statusIdx = statusOptions.indexOf(data);
                            const [bg, fg] =
                                statusColors[
                                statusIdx >= 0 ? statusIdx % statusColors.length : 0
                                ];
                            const pointer = role === "เวชระเบียน" ? "default" : "pointer";
                            return `<span class="badge rounded-3 px-3 py-2 status-btn" style="background:${bg};color:${fg};cursor:${pointer};">${data}<i class="fa-solid fa-arrow-pointer ms-2"></i></span>`;
                        },
                    },
                    { title: "หมายเหตุ(แผนกRegister)", data: "registerNote" },
                    { title: "หมายเหตุ(แผนกOPD)", data: "opdNote" },
                    {
                        title: "วันลงทะเบียน",
                        data: "serviceDate",
                        className: "dt-head-center dt-head-nowrap text-nowrap all",
                        render: function (data, type, row) {
                            if (type === "sort" || type === "type") {
                                return data ? moment(data).format("YYYYMMDD") : "";
                            }
                            return data ? moment(data).format("DD/MM/YYYY") : "";
                        },
                    },
                    {
                        title: role === "เวชระเบียน" ? "ลงทะเบียน" : "แก้ไข",
                        data: null,
                        orderable: false,
                        searchable: false,
                        className:
                            "dt-body-center dt-head-nowrap dt-head-center text-nowrap all",
                        render: function (data, type, row, meta) {
                            if (type === "sort" || type === "type") {
                                return "";
                            }
                            const isRegistered =
                                statusOptions.indexOf(row.serviceStatus) > 0;
                            if (role === "เวชระเบียน") {
                                return isRegistered
                                    ? `<small class="text-black-50 btn text-decoration-underline" onclick="viewData(this)">ลงทะเบียนแล้ว</small>`
                                    : `<button class="btn btn-sm btn-success rounded-circle edit-row-btn" onclick="editData(this)" title="ลงทะเบียน">
                                                <i class="bi bi-person-plus-fill"></i>
                                           </button>`;
                            } else if (role === "admin") {
                                return `<button class="btn btn-sm btn-primary rounded-3 edit-row-btn" onclick="editData(this)" title="แก้ไข">
                                            <i class="bi bi-pencil-square"></i>
                                       </button>`;
                            } else {
                                return isRegistered
                                    ? `<button class="btn btn-sm btn-danger rounded-3 edit-row-btn" onclick="editData(this)">
                                                <i class="bi bi-pencil-square"></i>
                                           </button>`
                                    : `<small class="text-black-50">ยังไม่ลงทะเบียน</small>`;
                            }
                        },
                    },
                    {
                        title: "Active",
                        data: "dataStatus",
                        orderable: false,
                        searchable: false,
                        visible: role === "admin",
                        className:
                            "dt-body-center dt-head-nowrap dt-head-center text-nowrap text-center all",
                        render: function (data, type, row, meta) {
                            if (type === "sort" || type === "type") {
                                return "";
                            }
                            if (data == "Active") {
                                return `<div class="form-check form-switch d-flex justify-content-center align-items-center">
                                            <input class="form-check-input status-toggle" type="checkbox" role="switch" checked>
                                        </div>`;
                            } else if (data == "Inactive") {
                                return `<div class="form-check form-switch d-flex justify-content-center align-items-center">
                                            <input class="form-check-input status-toggle" type="checkbox" role="switch">
                                        </div>`;
                            } else if (data === "Locked") {
                                return '<i class="bi bi-lock-fill" style="font-size: 1.5rem; color: gray;" title="Locked"></i>';
                            } else if (!row.isLatest) {
                                return `<i class="bi bi-archive-fill" style="font-size: 1.5rem; color: gray;" title="Archived"></i>`;
                            }
                            return "";
                        },
                    },
                ],
                rowCallback: function (row, data) {
                    if (data.dataStatus === "Inactive" || !data.isLatest) {
                        $(row).addClass("status-inactive");
                    }
                },
                columnDefs: [
                    {
                        targets: "_all",
                        className: "dt-head-center dt-head-nowrap",
                    },
                ],
                initComplete: function () {
                    setTimeout(() => {
                        window.MainTable.draw();
                    }, 1000);
                    $(".date-range-filter").html(
                        '<div class="input-group rounded-3">' +
                        '<input type="text" class="form-control rounded-3 shadow-none" id="exportStartDate" placeholder="วันที่เริ่มต้น" />' +
                        '<span class="input-group-text border-0">ถึง</span>' +
                        '<input type="text" class="form-control rounded-3 shadow-none" id="exportEndDate" placeholder="วันที่สิ้นสุด" />' +
                        "</div>"
                    );
                    $(".custom-length").html(
                        '<button id="reloadTableBtn" class="btn btn-secondary rounded-3 me-2 text-nowrap">' +
                        '<i class="bi bi-arrow-clockwise"></i> รีโหลดข้อมูล</button>' +
                        '<select id="length" class="form-select rounded-3 shadow-none">' +
                        '<option value="10">แสดง 10 รายการ</option>' +
                        '<option value="25">แสดง 25 รายการ</option>' +
                        '<option value="50">แสดง 50 รายการ</option>' +
                        '<option value="-1">แสดงทั้งหมด</option>' +
                        "</select>"
                    );
                    $(".custom-filter").html(
                        '<input type="text" class="form-control rounded-3 shadow-none" id="search" placeholder="ค้นหา...">'
                    );
                    $("#length").change(function () {
                        $("#table").DataTable().page.len($(this).val()).draw();
                    });
                    $("#search").on("keyup", function () {
                        window.MainTable.search(this.value).draw();
                    });
                    $("#reloadTableBtn").on("click", function () {
                        reloadTableData();
                    });
                    flatpickr("#exportStartDate", {
                        locale: "th",
                        dateFormat: "Y-m-d",
                        altFormat: "j F Y",
                        altInput: true,
                        onChange: function (selectedDates, dateStr, instance) {
                            filterDateRange();
                        },
                    });

                    flatpickr("#exportEndDate", {
                        locale: "th",
                        dateFormat: "Y-m-d",
                        altFormat: "j F Y",
                        altInput: true,
                        onChange: function (selectedDates, dateStr, instance) {
                            filterDateRange();
                        },
                    });
                },
                buttons: [
                    {
                        text: '<i class="bi bi-file-earmark-excel-fill me-1"></i> Export Excel',
                        className: "btn btn-success rounded-3",
                        extend: "excelHtml5",
                        title: "Exported Data" + moment().format("YYYYMMDD_HHmmss"),
                        exportOptions: {
                            format: {
                                body: function (data, row, column, node) {
                                    // Remove HTML tags and decode HTML entities
                                    let text = $("<div>").html(data).text();
                                    return text.replace(/\s+/g, " ").trim();
                                },
                            },
                        },
                    },
                ],
            });

            $(document)
                .off("click", ".status-btn")
                .on("click", ".status-btn", function () {
                    if (role === "เวชระเบียน") {
                        return; // Do nothing if role is เวชระเบียน
                    }
                    let currentStatus = $(this).text();
                    if (currentStatus === "รับบริการแล้ว") {
                        return; // Do nothing if status is "รับบริการแล้ว"
                    }
                    let row = $(this).closest("tr");
                    if (row.hasClass("child")) {
                        row = row.prev(); // If it's a child row, get the parent row
                    }
                    const rowData = window.MainTable.row(row).data();
                    $("#briefHn").text(rowData.hn);
                    $("#briefFullName").text(rowData.fullName);
                    $("#briefCompany").text(rowData.company);
                    if(!rowData.isLatest) {
                        return;
                    }
                    if (
                        rowData.dataStatus === "Inactive" ||
                        rowData.dataStatus === "Locked"
                    ) {
                        Swal.fire({
                            icon: "warning",
                            title: "ไม่สามารถแก้ไขได้",
                            html: "ข้อมูลนี้ถูกระงับการใช้งานหรือถูกล็อกไว้<br>กรุณาติดต่อผู้ดูแลระบบ",
                            confirmButtonText: "ตกลง",
                            customClass: SwalCustomClasses,
                        });
                        return;
                    }
                    console.log("🚀 ~ editData ~ rowData:", rowData);
                    $("#statusHn").val(rowData.hn);
                    $("#statusSelect").val(rowData.serviceStatus);
                    $("#statusOpdNote").val(rowData.opdNote || "");
                    window._editModalOriginalData = {
                        status: rowData.serviceStatus,
                        opdNote: rowData.opdNote || "",
                    };
                    console.log(
                        "🚀 ~ editData ~ window._editModalOriginalData:",
                        window._editModalOriginalData
                    );
                    console.log($("#statusSelect").val(), rowData.serviceStatus);
                    console.log($("#statusOpdNote").val() || "", rowData.opdNote || "");
                    $("#updateStatusModal").modal("show");
                    $(document)
                        .off("click", "button.dismiss-update-modal")
                        .on("click", "button.dismiss-update-modal", function (e) {
                            e.preventDefault();
                            let change = false;
                            $('#updateStatusForm').find("input,textarea,select")
                                .each(function () {
                                    if (
                                        $(this).val() !==
                                        window._editModalOriginalData[$(this).attr("id")]
                                    ) {
                                        changed = true;
                                        return false;
                                    }
                                });

                            if (change) {
                                Swal.fire({
                                    title: "มีการแก้ไขข้อมูล",
                                    text: "คุณต้องการทิ้งการเปลี่ยนแปลงหรือไม่?",
                                    icon: "warning",
                                    showCancelButton: true,
                                    confirmButtonText: "ทิ้งการเปลี่ยนแปลง",
                                    cancelButtonText: "ยกเลิก",
                                    reverseButtons: true,
                                    customClass: SwalCustomClasses,
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        $("#updateStatusModal").modal("hide");
                                    }
                                });
                                return;
                            }
                            $("#updateStatusModal").modal("hide");
                        });
                });

            $(document)
                .off("change", ".status-toggle")
                .on("change", ".status-toggle", function (e) {
                    e.preventDefault();
                    let checkbox = $(this);
                    let isChecked = checkbox.is(":checked");
                    let row = $(this).closest("tr");
                    if (row.hasClass("child")) {
                        row = row.prev(); // If it's a child row, get the parent row
                    }
                    const rowData = window.MainTable.row(row).data();
                    console.log("🚀 ~ editData ~ rowData:", rowData);
                    // Update row appearance immediately
                    if (!isChecked) {
                        row.addClass("status-inactive");
                        rowData.dataStatus = "Inactive";
                        window.MainTable.row(row).data(rowData).draw(false);
                    } else {
                        row.removeClass("status-inactive");
                        rowData.dataStatus = "Active";
                        window.MainTable.row(row).data(rowData).draw(false);
                    }

                    // Make the API call
                    google.script.run
                        .withFailureHandler((e) => {
                            console.log(e);
                            checkbox.prop("checked", !isChecked); // Revert checkbox state
                            Swal.fire({
                                title: "เกิดข้อผิดพลาด",
                                text: e.message || "ไม่สามารถเปลี่ยนสถานะได้ในขณะนี้",
                                icon: "error",
                                confirmButtonText: "ตกลง",
                                customClass: SwalCustomClasses,
                            });
                        })
                    [isChecked ? "setDataActive" : "setDataInactive"](rowData.hn);
                });
            // Initialize flatpickr for date fields
            flatpickr("#editBirthDate", {
                locale: "th",
                dateFormat: "Y-m-d",
                altFormat: "j F Y",
                altInput: true,
            });

            $("#editDataModal").on("hidden.bs.modal", function () {
                // Reset form fields and remove readonly class
                let form = $("#editDataForm")[0];
                form.classList.remove("was-validated");
                form.reset();
                // Hide service date field
                $("#editServiceDateContainer").addClass("d-none");
                $('#briefHn').text('-');
                $('#briefFullName').text('-');
                $('#briefCompany').text('-');
                $("#editDataForm")
                    .find("input,textarea,select")
                    .each(function () {
                        $(this)
                            .removeClass("bg-success-subtle")
                            .removeAttr("readonly")
                            .css("cursor", "default");
                        if ($(this).hasClass("select-replacement")) {
                            $(this)
                                .replaceWith(`<select class="form-select rounded-3" id="${$(
                                    this
                                ).attr("id")}" name="${$(this).attr("name")}">
                            <option value="">-- เลือกสถานะ --</option>
                            <? if (lists && lists.status && Array.isArray(lists.status)) { ?>
                            <? lists.status.slice(1).forEach(status => { ?>
                            <option value="<?= status ?>">
                                <?= status ?>
                            </option>
                            <? }) ?>
                            <? } ?>
                        </select>`);
                        }
                    });
                $("#editDataModal").find(".modal-footer").show();
                flatpickr("#editBirthDate", {
                    locale: "th",
                    dateFormat: "Y-m-d",
                    altFormat: "j F Y",
                    altInput: true,
                });
            });

            $("#selectDateRangeModal").on("hidden.bs.modal", function () {
                // Reset date range fields
                $("#exportStartDate")[0]._flatpickr.clear();
                $("#exportEndDate")[0]._flatpickr.clear();
                filterDateRange(); // Reset filter
            });

            $("#editCitizenId").on("input", function () {
                this.value = this.value.replace(/\D/g, "").slice(0, 13);
            });

            $("#editPhoneNumber").on("input", function () {
                this.value = this.value.replace(/\D/g, "").slice(0, 10);
            });
        }

        $('#copyCheckupProgramBtn').on('click', function () {
            let checkupProgram = $("#editCheckupProgram").val();
            if (checkupProgram) {
                try {
                    navigator.clipboard.writeText(checkupProgram).then(
                        function () {
                            Swal.fire({
                                toast: true,
                                position: "top-end",
                                icon: "success",
                                title: "คัดลอกโปรแกรมตรวจเรียบร้อย",
                                showConfirmButton: false,
                                timer: 1500,
                                customClass: SwalCustomClasses,
                            });
                        },
                        function () {
                            Swal.fire({
                                toast: true,
                                position: "top-end",
                                icon: "error",
                                title: "ไม่สามารถคัดลอกโปรแกรมตรวจได้",
                                showConfirmButton: false,
                                timer: 1500,
                                customClass: SwalCustomClasses,
                            });
                        }
                    );
                } catch (err) {
                    console.error("Error copying text: ", err);
                }
            }
        });

        $('#copyAdditionalCheckupProgramBtn').on('click', function () {
            let additionalCheckupProgram = $(
                "#editAdditionalCheckupProgram"
            ).val();
            if (additionalCheckupProgram) {
                try {
                    navigator.clipboard.writeText(additionalCheckupProgram).then(
                        function () {
                            Swal.fire({
                                toast: true,
                                position: "top-end",
                                icon: "success",
                                title: "คัดลอกโปรแกรมตรวจเพิ่มเติมเรียบร้อย",
                                showConfirmButton: false,
                                timer: 1500,
                                customClass: SwalCustomClasses,
                            });
                        },
                        function () {
                            Swal.fire({
                                toast: true,
                                position: "top-end",
                                icon: "error",
                                title: "ไม่สามารถคัดลอกโปรแกรมตรวจเพิ่มเติมได้",
                                showConfirmButton: false,
                                timer: 1500,
                                customClass: SwalCustomClasses,
                            });
                        }
                    );
                } catch (err) {
                    console.error("Error copying text: ", err);
                }
            }
        })

        function filterDateRange() {
            let _start = $("#exportStartDate").val();
            let _end = $("#exportEndDate").val();
            let start =
                _start == "" ? new Date(0) : moment(_start, "YYYY-MM-DD").toDate();
            let end = _end == "" ? new Date() : moment(_end, "YYYY-MM-DD").toDate();
            end.setHours(23, 59, 59, 999);
            console.log("🚀 ~ filterDateRange ~ end:", _end);
            console.log("🚀 ~ filterDateRange ~ start:", _start);

            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                if (_start == "" && _end == "") return true; // No filter if both dates are empty
                let rowDate = data[17];
                if (rowDate == "") return false;
                console.log("🚀 ~ filterDateRange ~ data", data);
                rowDate = moment(rowDate, "DD/MM/YYYY").toDate();
                console.log("🚀 ~ filterDateRange ~ rowDate:", rowDate);
                if (rowDate >= start && rowDate <= end) {
                    return true;
                }
                return false;
            });
            window.MainTable.draw();
            $.fn.dataTable.ext.search.pop(); // Remove the filter after drawing
        }

        function reloadTableData() {
            if (window.MainTable) {
                // Show placeholder while loading
                $("#tablePlaceholder").show();
                window.MainTable.clear().draw(); // Clear existing data
                window.MainTable.ajax.reload();
            }
        }

        function viewData(button) {
            let row = $(button).closest("tr");
            if (row.hasClass("child")) {
                row = row.prev(); // If it's a child row, get the parent row
            }
            const rowData = window.MainTable.row(row).data();
            console.log(rowData);
            if ($("#editBirthDate")[0]._flatpickr) {
                $("#editBirthDate")[0]._flatpickr.destroy();
            }
            $("#editDataForm")
                .find("input,textarea,select")
                .each(function () {
                    let field_id = $(this).attr("id");
                    if ($(this).is("select")) {
                        let field_name = $(this).attr("name");
                        $(this).replaceWith(
                            `<input type="text" id="${field_id}" name="${field_name}" class="form-control rounded-3 select-replacement" />`
                        );
                    }
                    $("#" + field_id)
                        .prop("readonly", true)
                        .addClass("bg-success-subtle")
                        .css("cursor", "not-allowed");
                });
            $("#editDataModal").find(".modal-title").html("ข้อมูลลงทะเบียน");
            $("#editDataModal").find(".modal-footer").hide();
            $("#editServiceDateContainer").removeClass("d-none");
            // Populate modal fields
            $("#editKey").val(rowData.hn || "");
            $("#editHN").val(rowData.hn || "");
            $("#editCompany").val(rowData.company || "");
            $("#editEmployeeId").val(rowData.employeeId || "");
            $("#editPrefix").val(rowData.prefix || "");
            $("#editFullName").val(rowData.fullName || "");
            if (
                rowData.birthDate.match(
                    /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?Z$/
                )
            ) {
                rowData.birthDate = moment(
                    rowData.birthDate,
                    "YYYY-MM-DDTHH:mm:ssZ"
                ).format("DD/MM/YYYY");
            } else if (rowData.birthDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                rowData.birthDate = moment(rowData.birthDate, "DD/MM/YYYY").format(
                    "DD/MM/YYYY"
                );
            } else if (rowData.birthDate.match(/^\d{2}-[A-Za-z]{3}-\d{4}$/)) {
                rowData.birthDate = moment(rowData.birthDate, "DD-MMM-YYYY").format(
                    "DD/MM/YYYY"
                );
            } else {
                rowData.birthDate = "";
            }

            $("#editBirthDate").val(rowData.birthDate || "");
            $("#editCitizenId").val(rowData.citizenId || "");
            $("#editCheckupProgram").val(rowData.checkupProgram || "");
            $("#editAdditionalCheckupProgram").val(
                rowData.additionalCheckupProgram || ""
            );
            $("#editEntitlementDocument").val(rowData.entitlementDocument || "");
            $("#editStartDate").val(rowData.startDate || "");
            $("#editEndDate").val(rowData.endDate || "");
            $("#editServiceDate").val(rowData.serviceDate || "");
            $("#editRegisterNote").val(rowData.registerNote || "");
            $("#editOpdNote").val(rowData.opdNote || "");
            $("#editPhoneNumber").val(rowData.phone || "");
            $("#editDataModal").modal("show");
            $(document)
                .off("click", "button.dismiss-edit-modal")
                .on("click", "button.dismiss-edit-modal", function (e) {
                    e.preventDefault();
                    $("#editDataModal").modal("hide");
                });
        }

        function editData(button) {
            let row = $(button).closest("tr");
            if (row.hasClass("child")) {
                row = row.prev(); // If it's a child row, get the parent row
            }
            const rowData = window.MainTable.row(row).data();
            console.log("🚀 ~ editData ~ rowData:", rowData);
            const role = getUser().role?.toLowerCase();
            if(!rowData.isLatest) {
                Swal.fire({
                    icon: "warning",
                    title: "ไม่สามารถแก้ไขได้",
                    html: "ข้อมูลนี้เป็นข้อมูลเก่า<br>กรุณาติดต่อผู้ดูแลระบบ",
                    confirmButtonText: "ตกลง",
                    customClass: SwalCustomClasses,
                });
                return;
            }
            if ((role === "เวชระเบียน" && rowData.dataStatus === "Inactive") || (!["admin", "เวชระเบียน"].includes(role) && ['Inactive', 'Locked'].includes(rowData.dataStatus))) {
                Swal.fire({
                    icon: "warning",
                    title: "ไม่สามารถแก้ไขได้",
                    html:
                        "ข้อมูลนี้ถูกระงับการใช้งานหรือถูกล็อกไว้<br>" + role === "admin"
                            ? "กรุณาเปิดใช้งานข้อมูลก่อนทำการแก้ไข"
                            : "กรุณาติดต่อผู้ดูแลระบบ",
                    confirmButtonText: "ตกลง",
                    customClass: SwalCustomClasses,
                });
                return;
            }
            console.log("🚀 ~ editData ~ rowData:", rowData);
            if (
                rowData.birthDate.match(
                    /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?Z$/
                )
            ) {
                rowData.birthDate = moment(
                    rowData.birthDate,
                    "YYYY-MM-DDTHH:mm:ssZ"
                ).format("DD/MM/YYYY");
            } else if (rowData.birthDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                rowData.birthDate = moment(rowData.birthDate, "DD/MM/YYYY").format(
                    "DD/MM/YYYY"
                );
            } else if (rowData.birthDate.match(/^\d{2}-[A-Za-z]{3}-\d{4}$/)) {
                rowData.birthDate = moment(rowData.birthDate, "DD-MMM-YYYY").format(
                    "DD/MM/YYYY"
                );
            } else {
                rowData.birthDate = "";
            }
            console.log("🚀 ~ editData ~ role:", role);
            let readOnlyFields = [];
            if (role === "เวชระเบียน") {
                readOnlyFields.push(
                    "editServiceDate",
                    "editOpdNote",
                    "editServiceStatus"
                );
                $("#editDataModal").find(".modal-title").html("ข้อมูลลงทะเบียน");
                $("#saveEditBtn").html(
                    'ลงทะเบียน <i class="bi bi-person-plus-fill"></i>'
                );
                $("#editServiceDateContainer").addClass("d-none");
                if (!$("#editBirthDate")[0]._flatpickr) {
                    flatpickr("#editBirthDate", {
                        locale: "th",
                        dateFormat: "Y-m-d",
                        altFormat: "j F Y",
                        altInput: true,
                    });
                }
                $("#editBirthDate")[0]._flatpickr.setDate(
                    moment(rowData.birthDate, "DD/MM/YYYY").toDate() || ""
                );
            } else if (role === "admin") {
                readOnlyFields.push("editServiceDate");
                if (rowData.serviceStatus == "") {
                    $("#editDataModal").find(".modal-title").html("ข้อมูลลงทะเบียน");
                    $("#saveEditBtn").html(
                        'ลงทะเบียน <i class="bi bi-person-plus-fill"></i>'
                    );
                    $("#editServiceDateContainer").addClass("d-none");
                } else {
                    $("#editDataModal")
                        .find(".modal-title")
                        .html("แก้ไขข้อมูลลงทะเบียน");
                    $("#saveEditBtn").html(
                        '<i class="bi bi-check-circle"></i> บันทึกการแก้ไข'
                    );
                    $("#editServiceDateContainer").removeClass("d-none");
                }
            } else {
                readOnlyFields.push(
                    "editHN",
                    "editCompany",
                    "editEmployeeId",
                    "editPrefix",
                    "editFullName",
                    "editBirthDate",
                    "editCitizenId",
                    "editCheckupProgram",
                    "editAdditionalCheckupProgram",
                    "editEntitlementDocument",
                    "editStartDate",
                    "editEndDate",
                    "editServiceDate",
                    "editRegisterNote",
                    "editPhoneNumber"
                );
                $("#editDataModal").find(".modal-title").html("แก้ไขข้อมูลลงทะเบียน");
                $("#saveEditBtn").html(
                    '<i class="bi bi-check-circle"></i> บันทึกการแก้ไข'
                );
                $("#editServiceDateContainer").removeClass("d-none");
                if ($("#editBirthDate")[0]._flatpickr) {
                    $("#editBirthDate")[0]._flatpickr.destroy();
                    $("#editBirthDate").val(rowData.birthDate || "");
                }
            }
            readOnlyFields.forEach((field) => {
                console.log("🚀 ~ editData ~ field:", field);
                if ($(`#${field}`).is("select")) {
                    let field_name = $(`#${field}`).attr("name");
                    let field_id = $(`#${field}`).attr("id");
                    $(`#${field}`).replaceWith(
                        `<input type="text" id="${field_id}" name="${field_name}" class="form-control rounded-3 select-replacement" />`
                    );
                }
                $(`#${field}`)
                    .prop("readonly", true)
                    .addClass("bg-success-subtle")
                // .css("cursor", "not-allowed");
            });
            // Populate modal fields
            $("#editKey").val(rowData.hn || "");
            $("#editHN").val(rowData.hn || "");
            $("#editCompany").val(rowData.company || "");
            $("#editEmployeeId").val(rowData.employeeId || "");
            $("#editPrefix").val(rowData.prefix || "");
            $("#editFullName").val(rowData.fullName || "");
            // $('#editBirthDate')[0]._flatpickr ? $('#editBirthDate')[0]._flatpickr.setDate(rowData.birthDate || '') : $('#editBirthDate').val(rowData.birthDate || '');
            $("#editCitizenId").val(rowData.citizenId || "");
            $("#editCheckupProgram").val(rowData.checkupProgram || "");
            $("#editAdditionalCheckupProgram").val(
                rowData.additionalCheckupProgram || ""
            );
            $("#editEntitlementDocument").val(rowData.entitlementDocument || "");
            $("#editStartDate").val(rowData.startDate || "");
            $("#editEndDate").val(rowData.endDate || "");
            $("#editServiceStatus").val(rowData.serviceStatus || "");
            $("#editRegisterNote").val(rowData.registerNote || "");
            $("#editOpdNote").val(rowData.opdNote || "");
            $("#editServiceDate")
                .val(
                    rowData.serviceDate
                        ? moment(rowData.serviceDate).format("DD/MM/YYYY")
                        : ""
                )
                .attr("data-value", rowData.serviceDate || "");
            $("#editPhoneNumber").val(rowData.phone || "");
            // Store original data for change detection (all fields in the form)
            window._editModalOriginalData = {};
            $("#editDataForm")
                .find("input,textarea,select")
                .each(function () {
                    window._editModalOriginalData[$(this).attr("id")] = $(this).val();
                });
            // Show modal
            $("#editDataModal").modal("show");
            // Modal close with unsaved changes check
            $(document)
                .off("click", "button.dismiss-edit-modal")
                .on("click", "button.dismiss-edit-modal", function (e) {
                    if (window._editModalOriginalData) {
                        let changed = false;
                        $("#editDataForm")
                            .find("input,textarea,select")
                            .each(function () {
                                if (
                                    $(this).val() !==
                                    window._editModalOriginalData[$(this).attr("id")]
                                ) {
                                    changed = true;
                                    return false;
                                }
                            });
                        if (changed) {
                            Swal.fire({
                                title: "มีการแก้ไขข้อมูล",
                                text: "คุณต้องการทิ้งการเปลี่ยนแปลงหรือไม่?",
                                icon: "warning",
                                showCancelButton: true,
                                confirmButtonText: "ทิ้งการเปลี่ยนแปลง",
                                cancelButtonText: "ยกเลิก",
                                reverseButtons: true,
                                customClass: SwalCustomClasses,
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    $("#editDataModal").modal("hide");
                                }
                            });
                            return;
                        }
                    }
                    $("#editDataModal").modal("hide");
                });
        }

        $("#saveEditBtn").on("click", function () {
            $('#editDataForm button[type="submit"]').click();
        });

        $("#exportExcelBtn").on("click", function () {
            $("#selectDateRangeModal").modal("show");
        });

        $("#confirmExportExcelBtn").on("click", function () {
            const startDate = $("#exportStartDate").val()
                ? $("#exportStartDate").val()
                : new Date(0);
            const endDate = $("#exportEndDate").val()
                ? $("#exportEndDate").val()
                : new Date();

            // Call the export function
            window.MainTable.columns(15).search(`${startDate}|${endDate}`).draw();
            $("#selectDateRangeModal").modal("hide");
        });

        function handleUpdate() {
            let change = false;

            let formData = $("#editDataForm")
                .serializeArray()
                .reduce((obj, item) => {
                    obj[item.name] = item.value;
                    return obj;
                }, {});
            formData.serviceDate = $("#editServiceDate").attr("data-value") || "";
            const role = getUser().role?.toLowerCase();
            console.log("🚀 ~ formData:", formData);
            if (window._editModalOriginalData) {
                $("#editDataForm")
                    .find("input,textarea,select")
                    .each(function () {
                        if (
                            $(this).val() !==
                            window._editModalOriginalData[$(this).attr("id")]
                        ) {
                            change = true;
                            return false;
                        }
                    });
            }

            if (!change) {
                Swal.fire({
                    title: "ไม่มีการเปลี่ยนแปลงข้อมูล",
                    icon: "info",
                    confirmButtonText: "ตกลง",
                    customClass: SwalCustomClasses,
                });
                return;
            }
            if (
                role !== "เวชระเบียน" &&
                role !== "admin" &&
                (formData.serviceStatus === "" ||
                    formData.serviceStatus === "Register")
            ) {
                Swal.fire({
                    title: "กรุณาอัพเดตสถานะการให้บริการ",
                    icon: "warning",
                    confirmButtonText: "ตกลง",
                    customClass: SwalCustomClasses,
                    didDestroy: () => {
                        $("#editServiceStatus").focus();
                    },
                });
                return;
            }

            Swal.fire({
                title: "ยืนยันการบันทึกข้อมูล",
                html:
                    "คุณต้องการบันทึกข้อมูลนี้หรือไม่?<br>" +
                    '<span class="text-danger fw-semibold">* กรุณาตรวจสอบข้อมูลให้ถูกต้องก่อนบันทึกข้อมูล</span>',
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "บันทึก",
                cancelButtonText: "ยกเลิก",
                reverseButtons: true,
                customClass: SwalCustomClasses,
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        iconHtml: '<i class="bi bi-hourglass-split"></i>',
                        title: "กำลังบันทึกข้อมูล...",
                        text: "กรุณารอสักครู่",
                        allowOutsideClick: false,
                        customClass: Object.assign(
                            { icon: "border-0" },
                            SwalCustomClasses
                        ),
                        didOpen: () => {
                            Swal.showLoading();
                        },
                    });
                    let promises = [
                        new Promise((resolve) => {
                            google.script.run
                                .withSuccessHandler((res) => {
                                    resolve(JSON.parse(res));
                                })
                                .withFailureHandler((error) => {
                                    console.error("Error saving data:", error);
                                    Swal.fire({
                                        title: "เกิดข้อผิดพลาด",
                                        text: "ไม่สามารถบันทึกข้อมูลได้",
                                        icon: "error",
                                        confirmButtonText: "ตกลง",
                                        customClass: SwalCustomClasses,
                                    });
                                })
                                .saveUpdateData(formData);
                        }),
                    ];
                    // if(formData.serviceStatus === ''){
                    //     promises.push(new Promise((resolve) => {
                    //         google.script.run
                    //             .withSuccessHandler(resolve)
                    //             .withFailureHandler((error) => {
                    //                 console.error("Error saving data:", error);
                    //                 Swal.fire({
                    //                     title: 'เกิดข้อผิดพลาด',
                    //                     text: 'ไม่สามารถบันทึกข้อมูลได้',
                    //                     icon: 'error',
                    //                     confirmButtonText: 'ตกลง',
                    //                     customClass: SwalCustomClasses
                    //                 });
                    //             })
                    //             .registPatient(formData);
                    //     }));
                    // }
                    Promise.all(promises).then((results) => {
                        if (results.every((res) => res.success)) {
                            reloadTableData();
                            Swal.fire({
                                title: "บันทึกข้อมูลสำเร็จ",
                                icon: "success",
                                confirmButtonText: "ตกลง",
                                customClass: SwalCustomClasses,
                            }).then(() => {
                                $("#editDataModal").modal("hide");
                            });
                            return;
                        }
                        Swal.fire({
                            title: "เกิดข้อผิดพลาด",
                            html: results
                                .map(
                                    (res) =>
                                        '<i class="bi bi-x-circle me-2"></i> ' + res.message
                                )
                                .join("<br>"),
                            icon: "error",
                            confirmButtonText: "ตกลง",
                            customClass: SwalCustomClasses,
                        });
                    });
                }
            });
        }

        $("#saveStatusBtn").on("click", function () {
            let selectedStatus = $("#statusSelect").val();
            if (!selectedStatus) {
                Swal.fire({
                    title: "กรุณาเลือกสถานะ",
                    icon: "warning",
                    confirmButtonText: "ตกลง",
                    customClass: SwalCustomClasses,
                });
                return;
            }
            let change = false;

            if (window._editModalOriginalData.status !== selectedStatus) {
                change = true;
            }
            if (
                window._editModalOriginalData.opdNote !== $("#statusOpdNote").val()
            ) {
                change = true;
            }

            if (!change) {
                Swal.fire({
                    title: "ไม่มีการเปลี่ยนแปลงข้อมูล",
                    icon: "info",
                    confirmButtonText: "ตกลง",
                    customClass: SwalCustomClasses,
                });
                return;
            }

            let formData = {
                serviceStatus: selectedStatus,
                opdNote: $("#statusOpdNote").val(),
                hn: $("#statusHn").val(),
            };
            console.log("🚀 ~ formData:", formData);
            Swal.fire({
                title: "ยืนยันการเปลี่ยนแปลงข้อมูล",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "ตกลง",
                cancelButtonText: "ยกเลิก",
                reverseButtons: true,
                customClass: SwalCustomClasses,
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        iconHtml: '<i class="bi bi-hourglass-split"></i>',
                        title: "กำลังบันทึกข้อมูล...",
                        text: "กรุณารอสักครู่",
                        allowOutsideClick: false,
                        customClass: Object.assign(
                            { icon: "border-0" },
                            SwalCustomClasses
                        ),
                        didOpen: () => {
                            Swal.showLoading();
                        },
                    });
                    google.script.run
                        .withSuccessHandler((res) => {
                            res = JSON.parse(res);
                            if (res.success) {
                                reloadTableData();
                                $("#updateStatusModal").modal("hide");
                                Swal.fire({
                                    title: "บันทึกข้อมูลสำเร็จ",
                                    icon: "success",
                                    confirmButtonText: "ตกลง",
                                    customClass: SwalCustomClasses,
                                });
                            }
                        })
                        .withFailureHandler((error) => {
                            console.error("Error saving data:", error);
                            Swal.fire({
                                title: "เกิดข้อผิดพลาด",
                                text: "ไม่สามารถบันทึกข้อมูลได้",
                                icon: "error",
                                confirmButtonText: "ตกลง",
                                customClass: SwalCustomClasses,
                            });
                        })
                        .saveQuickUpdate(formData);
                }
            });
        });

        function checkLogin() {
            let user = getUser();
            console.log("🚀 ~ checkLogin ~ user:", user);
            $("#splash-screen").addClass("hide");
            $("#logoutBtn")
                .off("click")
                .on("click", function () {
                    clearUser();
                    $("#main-sec").hide();
                    $("#splash-screen").removeClass("hide").show();
                    setTimeout(() => {
                        $("#splash-screen").addClass("hide").hide();
                        $("#login-sec").show();
                        $("#loginForm").removeClass("was-validated");
                        $("#loginUsername").val("").focus();
                        $("#loginPassword").val("");
                        $('#loginForm button[type="submit"]')
                            .prop("disabled", false)
                            .html("เข้าสู่ระบบ");
                    }, 1000);
                });
            if (user && user.expiry && new Date(user.expiry) > new Date()) {
                refreshUser(user);
                $("#login-sec").hide();
                $("#main-sec").show();
                $("#userName").text(user.name);
                $("#userRole").text(user.role);
                initApp();
            } else {
                $("#login-sec").show();
                $("#main-sec").hide();
            }
        }
        function handleLogin() {
            $('#loginForm button[type="submit"]')
                .prop("disabled", true)
                .html(
                    '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>กำลังเข้าสู่ระบบ...'
                );
            google.script.run
                .withFailureHandler((e) => console.log(e))
                .withSuccessHandler((res) => {
                    res = JSON.parse(res);
                    console.log(res);
                    if (res.success) {
                        setUser(res.user);
                        Swal.fire({
                            title: "เข้าสู่ระบบสำเร็จ",
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1500,
                            customClass: SwalCustomClasses,
                        }).then(() => {
                            checkLogin();
                        });
                    } else {
                        Swal.fire({
                            title: "ชื่อผู้ใช้ หรือรหัสผ่านไม่ถูกต้อง",
                            text: "กรุณาตรวจสอบอีกครั้ง",
                            icon: "error",
                            confirmButtonText: "ตกลง",
                            customClass: SwalCustomClasses,
                        });
                        const $btn = $('#loginForm button[type="submit"]');
                        $btn.prop("disabled", false).html("เข้าสู่ระบบ");
                        $("#loginUsername").focus();
                        $("#loginPassword").val("");
                    }
                })
                .doLogin($("#loginUsername").val(), $("#loginPassword").val());
        }
        (function () {
            "use strict";

            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.querySelectorAll(".needs-validation");

            // Loop over them and prevent submission
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener(
                    "submit",
                    function (event) {
                        event.preventDefault();
                        if (!form.checkValidity()) {
                            event.stopPropagation();
                            form.classList.add("was-validated");
                            $(this).find(":invalid").first().focus();
                        } else {
                            let form = $(this);
                            if (form.attr("id") === "loginForm") {
                                handleLogin();
                            } else if (form.attr("id") === "editDataForm") {
                                handleUpdate();
                            }
                        }
                    },
                    false
                );
            });
        })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
</body>

</html>