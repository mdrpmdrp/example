<!DOCTYPE html>
<html lang="th">

<head>
    <base target="_top">
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smile Focus - ระบบจัดการคนไข้คลินิคทันตกรรม</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_red.css">
    <link
        href="https://cdn.datatables.net/v/bs5/dt-2.3.0/b-3.2.3/date-1.5.5/fh-4.0.1/r-3.0.4/sl-3.0.0/datatables.min.css"
        rel="stylesheet" integrity="sha384-pDoMXaoekHsQmb1L6aeyRL/WoJRQnDTYvUeWu4LbiTVT2Vhp2niYUKgdwBE/Tnl8"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .navbar-brand {
            font-weight: bold;
            color: #30308b !important;
        }

        .navbar-logo {
            height: 32px;
            width: auto;
            max-width: 40px;
            object-fit: contain;
        }

        .clinic-logo {
            height: 80px;
            width: auto;
            max-width: 120px;
            object-fit: contain;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 10px;
        }

        .btn-primary {
            background: #30308b;
            border: none;
        }

        .btn-primary:hover {
            background: #a92246;
        }

        .sidebar {
            min-height: 100vh;
            background: #30308b;
        }

        .sidebar .nav-link {
            color: white !important;
            padding: 12px 20px;
            border-radius: 5px;
            margin: 5px 10px;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .stats-card {
            background: #30308b;
            color: white;
            border-radius: 15px;
        }

        .stats-card-2 {
            background: #a92246;
            color: white;
            border-radius: 15px;
        }

        .stats-card-3 {
            background: #009958;
            color: white;
            border-radius: 15px;
        }

        .stats-card-4 {
            background: #30308b;
            color: white;
            border-radius: 15px;
        }

        .login-container {
            min-height: 100vh;
            background: #30308b;
        }

        .login-card {
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .calendar-cell {
            background: white;
            min-height: 80px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calendar-cell:hover {
            background-color: #f8f9fa;
        }

        .calendar-cell.other-month {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .calendar-cell.today {
            background-color: #e6f0f9;
            font-weight: bold;
        }

        .appointment-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #009958;
            position: absolute;
            bottom: 5px;
            right: 5px;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #a92246;
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 12px;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Login Page -->
    <div id="loginPage" class="login-container d-flex align-items-center justify-content-center">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-4">
                    <div class="card login-card">
                        <div class="card-body p-5">
                            <div class="text-center mb-4">
                                <img src="https://img2.pic.in.th/pic/Screenshot-2025-09-22-215301.png"
                                    alt="Smile Focus Logo" class="clinic-logo mb-3">
                                <h3 class="mb-1">Smile Focus</h3>
                                <p class="text-muted">เข้าสู่ระบบเพื่อใช้งาน</p>
                            </div>

                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="username" class="form-label">ชื่อผู้ใช้</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input type="text" class="form-control" id="username" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="password" class="form-label">รหัสผ่าน</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                        <input type="password" class="form-control" id="password" required>
                                    </div>
                                </div>


                                <button type="submit" class="btn btn-primary w-100 py-2">
                                    <i class="fas fa-sign-in-alt me-2"></i>เข้าสู่ระบบ
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <img src="https://img2.pic.in.th/pic/Screenshot-2025-09-22-215301.png" alt="Smile Focus Logo"
                        class="navbar-logo me-2">
                    Smile Focus
                </a>

                <div class="d-flex align-items-center">
                    <div class="dropdown me-3">
                        <button class="btn btn-outline-primary dropdown-toggle position-relative" type="button"
                            id="notificationDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-bell"></i>
                            <span id="notificationBadge" class="notification-badge hidden">0</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" id="notificationList">
                            <li>
                                <h6 class="dropdown-header">การแจ้งเตือน</h6>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><span class="dropdown-item-text text-muted">ไม่มีการแจ้งเตือนใหม่</span></li>
                        </ul>
                    </div>

                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="userDropdown"
                            data-bs-toggle="dropdown">
                            <i class="fas fa-user me-2"></i>
                            <span id="currentUser">ผู้ใช้</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="logoutBtn">
                                    <i class="fas fa-sign-out-alt me-2"></i>ออกจากระบบ
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3 col-lg-2 px-0">
                    <div class="sidebar">
                        <div class="nav flex-column nav-pills p-3">
                            <a class="nav-link active" href="#" data-page="dashboard">
                                <i class="fas fa-tachometer-alt me-2"></i>หน้าหลัก
                            </a>
                            <a class="nav-link" href="#" data-page="patients">
                                <i class="fas fa-users me-2"></i>จัดการคนไข้
                            </a>
                            <a class="nav-link" href="#" data-page="appointments">
                                <i class="fas fa-calendar-alt me-2"></i>การนัดหมาย
                            </a>
                            <a class="nav-link" href="#" data-page="revenue">
                                <i class="fas fa-chart-line me-2"></i>รายได้รายวัน
                            </a>
                            <a class="nav-link admin-only hidden" href="#" data-page="reports">
                                <i class="fas fa-chart-bar me-2"></i>รายงาน
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-9 col-lg-10">
                    <div class="p-4">
                        <!-- Dashboard Page -->
                        <div id="dashboardPage" class="page-content">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>หน้าหลัก</h2>
                                <div class="text-muted">วันที่: <span id="currentDate"></span></div>
                            </div>

                            <!-- Statistics Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3 mb-3">
                                    <div class="card stats-card p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">คนไข้ทั้งหมด</h6>
                                                <h3 class="mb-0" id="totalPatients">0</h3>
                                            </div>
                                            <i class="fas fa-users fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 mb-3">
                                    <div class="card stats-card-2 p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">นัดหมายวันนี้</h6>
                                                <h3 class="mb-0" id="todayAppointments">0</h3>
                                            </div>
                                            <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 mb-3">
                                    <div class="card stats-card-3 p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">รายได้วันนี้</h6>
                                                <h3 class="mb-0" id="todayRevenue">0</h3>
                                            </div>
                                            <i class="fas fa-money-bill-wave fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3 mb-3">
                                    <div class="card stats-card-4 p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">การแจ้งเตือน</h6>
                                                <h3 class="mb-0" id="totalNotifications">0</h3>
                                            </div>
                                            <i class="fas fa-bell fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activities -->
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">นัดหมายในสัปดาห์นี้</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="weeklyAppointments"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">คนไข้ใหม่ล่าสุด</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="recentPatients"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Patients Page -->
                        <div id="patientsPage" class="page-content hidden">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>จัดการคนไข้</h2>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#patientModal">
                                    <i class="fas fa-plus me-2"></i>เพิ่มคนไข้ใหม่
                                </button>
                            </div>

                            <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="patientsTable" class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>รหัสคนไข้</th>
                                                    <th>ชื่อ-นามสกุล</th>
                                                    <th>เบอร์โทร</th>
                                                    <th>อายุ</th>
                                                    <th>วันที่ลงทะเบียน</th>
                                                    <th>การจัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Appointments Page -->
                        <div id="appointmentsPage" class="page-content hidden">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>การนัดหมาย</h2>
                                <button class="btn btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#appointmentModal">
                                    <i class="fas fa-plus me-2"></i>เพิ่มนัดหมายใหม่
                                </button>
                            </div>

                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">ปฏิทินการนัดหมาย</h5>
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary" id="prevMonth">
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <span id="currentMonth" class="mx-3"></span>
                                                <button class="btn btn-sm btn-outline-primary" id="nextMonth">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="calendar"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">นัดหมายวันนี้</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="todayAppointmentsList"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Revenue Page -->
                        <div id="revenuePage" class="page-content hidden">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>รายได้รายวัน</h2>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#revenueModal">
                                    <i class="fas fa-plus me-2"></i>บันทึกรายได้
                                </button>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="text-muted">รายได้วันนี้</h6>
                                            <h3 class="text-primary" id="dailyRevenue">0 บาท</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="text-muted">รายได้เดือนนี้</h6>
                                            <h3 class="text-success" id="monthlyRevenue">0 บาท</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="text-muted">รายได้ปีนี้</h6>
                                            <h3 class="text-info" id="yearlyRevenue">0 บาท</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">กราฟรายได้รายเดือน</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="revenueChart" height="100"></canvas>
                                </div>
                            </div>

                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="mb-0">ประวัติรายได้</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="revenueTable" class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>วันที่</th>
                                                    <th>รายการ</th>
                                                    <th>จำนวนเงิน</th>
                                                    <th>หมายเหตุ</th>
                                                    <th>การจัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reports Page (Admin Only) -->
                        <div id="reportsPage" class="page-content hidden">
                            <h2 class="mb-4">รายงาน</h2>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">สรุปคนไข้รายเดือน</h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="patientsChart" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">สรุปการนัดหมายรายเดือน</h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="appointmentsChart" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Modal -->
    <div class="modal fade" id="patientModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่ม/แก้ไขข้อมูลคนไข้</h5>
                    <button type="button" class="btn-close"></button>
                </div>
                <form id="patientForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ชื่อ</label>
                                    <input type="text" class="form-control" name="firstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">นามสกุล</label>
                                    <input type="text" class="form-control" name="lastName" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">เบอร์โทรศัพท์</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">วันเกิด</label>
                                    <input type="date" class="form-control" name="birthDate" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ที่อยู่</label>
                            <textarea class="form-control" name="address" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ประวัติการแพ้ยา</label>
                            <textarea class="form-control" name="allergies" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">โรคประจำตัว</label>
                            <textarea class="form-control" name="medicalHistory" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">หมายเหตุ</label>
                            <textarea class="form-control" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelButton">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div class="modal fade" id="appointmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่ม/แก้ไขการนัดหมาย</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="appointmentForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">เลือกคนไข้</label>
                            <select class="form-select" name="patientId" required>
                                <option value="">เลือกคนไข้</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">วันที่นัด</label>
                                    <input type="date" class="form-control" name="appointmentDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">เวลานัด</label>
                                    <input type="time" class="form-control" name="appointmentTime" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">รายการรักษา</label>
                            <input type="text" class="form-control" name="treatment" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ค่าใช้จ่าย (บาท)</label>
                            <input type="number" class="form-control" name="cost" min="0" step="0.01">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">หมายเหตุ</label>
                            <textarea class="form-control" name="notes" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">สถานะ</label>
                            <select class="form-select" name="status">
                                <option value="scheduled">กำหนดการ</option>
                                <option value="completed">เสร็จสิ้น</option>
                                <option value="cancelled">ยกเลิก</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Revenue Modal -->
    <div class="modal fade" id="revenueModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">บันทึกรายได้</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="revenueForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">วันที่</label>
                            <input type="date" class="form-control" name="date" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">รายการ</label>
                            <input type="text" class="form-control" name="description" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">จำนวนเงิน (บาท)</label>
                            <input type="number" class="form-control" name="amount" min="0" step="0.01" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ประเภท</label>
                            <select class="form-select" name="type">
                                <option value="treatment">รายได้จากการรักษา</option>
                                <option value="consultation">รายได้จากการตรวจ</option>
                                <option value="other">อื่นๆ</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">หมายเหตุ</label>
                            <textarea class="form-control" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
        </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <script
        src="https://cdn.datatables.net/v/bs5/dt-2.3.0/b-3.2.3/date-1.5.5/fh-4.0.1/r-3.0.4/sl-3.0.0/datatables.min.js"
        integrity="sha384-NGgUUnjETvXZrx9vJMQOG/C654mzSDv63TrMt0zQmS1HW58fN4RdjorjyZqEMIZ9" crossorigin="anonymous">
        </script>

    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/tanaikech/ResumableUploadForGoogleDrive_js@master/resumableupload_js.min.js">
        </script>
    <script>
        AOS.init();

        // Constants for UI text strings
        const UI_TEXT = {
            MESSAGES: {
                LOGIN_SUCCESS: 'เข้าสุ่ในระบบสำเร็จ',
                LOGIN_FAILED: 'เข้าสู่ระบบไม่สำเร็จ',
                LOGIN_ERROR: 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ',
                LOGOUT_SUCCESS: 'ออกจากระบบเรียบร้อย',
                LOGOUT_CONFIRM: 'ต้องการออกจากระบบ?',
                DELETE_PATIENT_CONFIRM: 'ต้องการลบข้อมูลคนไข้?',
                DELETE_REVENUE_CONFIRM: 'ต้องการลบรายการรายได้?',
                DELETE_WARNING: 'การดำเนินการนี้ไม่สามารถย้อนกลับได้',
                NO_APPOINTMENTS_WEEK: 'ไม่มีนัดหมายในสัปดาห์นี้',
                NO_PATIENTS: 'ยังไม่มีคนไข้',
                NO_PATIENT_DATA: 'ยังไม่มีข้อมูลคนไข้',
                NO_REVENUE_DATA: 'ยังไม่มีข้อมูลรายได้',
                NO_APPOINTMENTS_TODAY: 'ไม่มีนัดหมายวันนี้',
                NO_APPOINTMENTS_DATE: 'ไม่มีนัดหมายในวันนี้',
                PATIENT_NOT_FOUND: 'ไม่พบข้อมูลคนไข้',
                UPDATE_ERROR: 'เกิดข้อผิดพลาดในการอัปเดตข้อมูล',
                ADD_ERROR: 'เกิดข้อผิดพลาดในการเพิ่มข้อมูล',
                DELETE_ERROR: 'เกิดข้อผิดพลาดในการลบข้อมูล',
                APPOINTMENT_UPDATE_ERROR: 'เกิดข้อผิดพลาดในการอัปเดตการนัดหมาย',
                APPOINTMENT_ADD_ERROR: 'เกิดข้อผิดพลาดในการเพิ่มการนัดหมาย',
                REVENUE_ADD_ERROR: 'เกิดข้อผิดพลาดในการบันทึกรายได้',
                DELETE_REVENUE_ERROR: 'เกิดข้อผิดพลาดในการลบรายการ'
            },
            BUTTONS: {
                LOGIN: 'เข้าสู่ระบบ',
                LOGOUT: 'ออกจากระบบ',
                CANCEL: 'ยกเลิก',
                SAVE: 'บันทึก',
                DELETE: 'ลบ',
                EDIT: 'แก้ไข'
            },
            LABELS: {
                PATIENTS_TOTAL: 'คนไข้ทั้งหมด',
                APPOINTMENTS_TODAY: 'นัดหมายวันนี้',
                REVENUE_TODAY: 'รายได้วันนี้',
                NOTIFICATIONS: 'การแจ้งเตือน',
                REVENUE_DAILY: 'รายได้วันนี้',
                REVENUE_MONTHLY: 'รายได้เดือนนี้',
                REVENUE_YEARLY: 'รายได้ปีนี้',
                BAHT: 'บาท',
                YEARS_OLD: 'ปี',
                TIME: 'เวลา',
                APPOINTMENT_DATE: 'นัดหมายวันที่',
                SELECT_PATIENT: 'เลือกคนไข้',
                TOMORROW_APPOINTMENT: 'นัดพรุ่งนี้ เวลา'
            },
            NAVIGATION: {
                DASHBOARD: 'หน้าหลัก',
                PATIENTS: 'จัดการคนไข้',
                APPOINTMENTS: 'การนัดหมาย',
                REVENUE: 'รายได้รายวัน',
                REPORTS: 'รายงาน'
            },
            DAYS: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส']
        };

        // Constants for API method names
        const API_METHODS = {
            AUTHENTICATE_USER: 'authenticateUser',
            GET_ALL_PATIENTS: 'getAllPatients',
            GET_ALL_APPOINTMENTS: 'getAllAppointments',
            GET_ALL_REVENUES: 'getAllRevenues',
            ADD_PATIENT: 'addPatient',
            UPDATE_PATIENT: 'updatePatient',
            DELETE_PATIENT: 'deletePatient',
            ADD_APPOINTMENT: 'addAppointment',
            UPDATE_APPOINTMENT: 'updateAppointment',
            ADD_REVENUE: 'addRevenue',
            DELETE_REVENUE: 'deleteRevenue'
        };

        // Constants for DOM selectors and IDs
        const SELECTORS = {
            LOGIN_PAGE: '#loginPage',
            MAIN_APP: '#mainApp',
            LOGIN_FORM: '#loginForm',
            CURRENT_USER: '#currentUser',
            CURRENT_DATE: '#currentDate',
            TOTAL_PATIENTS: '#totalPatients',
            TODAY_APPOINTMENTS: '#todayAppointments',
            TODAY_REVENUE: '#todayRevenue',
            TOTAL_NOTIFICATIONS: '#totalNotifications',
            NOTIFICATION_BADGE: '#notificationBadge',
            NOTIFICATION_LIST: '#notificationList',
            WEEKLY_APPOINTMENTS: '#weeklyAppointments',
            RECENT_PATIENTS: '#recentPatients',
            PATIENTS_TABLE: '#patientsTable',
            PATIENT_FORM: '#patientForm',
            PATIENT_MODAL: '#patientModal',
            APPOINTMENT_FORM: '#appointmentForm',
            APPOINTMENT_MODAL: '#appointmentModal',
            REVENUE_FORM: '#revenueForm',
            REVENUE_MODAL: '#revenueModal',
            CALENDAR: '#calendar',
            CURRENT_MONTH: '#currentMonth',
            TODAY_APPOINTMENTS_LIST: '#todayAppointmentsList',
            REVENUE_TABLE: '#revenueTable',
            DAILY_REVENUE: '#dailyRevenue',
            MONTHLY_REVENUE: '#monthlyRevenue',
            YEARLY_REVENUE: '#yearlyRevenue',
            REVENUE_CHART: '#revenueChart'
        };

        // Constants for configuration values
        const CONFIG = {
            STORAGE_KEY: 'dentalUser',
            DATE_FORMAT_TH: 'th-TH',
            DATATABLES_LANG_URL: '//cdn.datatables.net/plug-ins/1.13.4/i18n/th.json',
            TOAST_TIMER: 3000,
            CALENDAR_DAYS: 42
        };

        let Toast;
        let currentUser = null;
        let currentUserType = null;
        let patients = [];
        let appointments = [];
        let revenues = [];
        let currentMonth = new Date();

        // Form tracking variables for unsaved changes warning
        let originalPatientFormData = {};
        let isPatientFormDirty = false;

        // Initialize Toast
        Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: CONFIG.TOAST_TIMER,
            timerProgressBar: true,
        });

        $(document).ready(function () {
            NProgress.done();
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            updateCurrentDate();
            checkLoginStatus();
        }

        function setupEventListeners() {
            // Login form
            $(SELECTORS.LOGIN_FORM).on('submit', handleLogin);

            // Logout
            $('#logoutBtn').on('click', handleLogout);

            // Navigation
            $('.nav-link[data-page]').on('click', function (e) {
                e.preventDefault();
                showPage($(this).data('page'));
            });

            // Forms
            $(SELECTORS.PATIENT_FORM).on('submit', handlePatientSubmit);
            $(SELECTORS.APPOINTMENT_FORM).on('submit', handleAppointmentSubmit);
            $(SELECTORS.REVENUE_FORM).on('submit', handleRevenueSubmit);

            // Calendar navigation
            $('#prevMonth').on('click', function () {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderCalendar();
            });

            $('#nextMonth').on('click', function () {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderCalendar();
            });

            // Set default revenue date to today
            $(`${SELECTORS.REVENUE_FORM} input[name="date"]`).val(new Date().toISOString().split('T')[0]);

            // Patient modal close button handlers
            $('#patientModal .btn-close').on('click', function (e) {
                handlePatientModalClose(e);
            });

            $('#cancelButton').on('click', function (e) {
                handlePatientModalClose(e);
            });

            // Capture form data when modal is opened for new patient
            $('#patientModal').on('shown.bs.modal', function () {
                // Small delay to ensure form is ready
                setTimeout(() => {
                    capturePatientFormData();
                }, 100);
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            };
            $(SELECTORS.CURRENT_DATE).text(now.toLocaleDateString(CONFIG.DATE_FORMAT_TH, options));
            flatpickr('input[name="birthDate"]', {
                locale: 'th',
                dateFormat: 'Y-m-d',
                altFormat: 'd F Y',
                altInput: true,
                maxDate: 'today'
            });
        }

        function checkLoginStatus() {
            // In a real app, check session storage or cookies
            const savedUser = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                if (new Date().getTime() > userData.expired) {
                    localStorage.removeItem(CONFIG.STORAGE_KEY);
                    showLoginPage();
                    return;
                }
                currentUser = userData.username;
                currentUserType = userData.type;
                console.log('Login until:', moment(userData.expired).format('LLLL'));
                showMainApp();
            } else {
                showLoginPage();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const showLoginLoading = () => {
                NProgress.start();
                $(e.target).find('button[type="submit"]').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังเข้าสู่ระบบ...');
            }
            const hideLoginLoading = () => {
                NProgress.done();
                $(e.target).find('button[type="submit"]').prop('disabled', false).html('เข้าสู่ระบบ');
            }
            const loginForm = e.target;
            const formData = new FormData(loginForm);
            const username = $('#username').val().trim();
            const password = $('#password').val().trim();

            if (!username || !password) {
                Toast.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน'
                });
                return;
            }
            showLoginLoading();
            // Call Google Apps Script backend
            google.script.run
                .withSuccessHandler(function (result) {
                    hideLoginLoading();
                    if (result.success) {
                        currentUser = result.user.username;
                        currentUserType = result.user.userType;

                        // Save to localStorage
                        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
                            username: result.user.username,
                            type: result.user.userType,
                            fullName: result.user.fullName,
                            expired: new Date().getTime() + (8 * 60 * 60 * 1000) // 2 hours expiry
                        }));
                        console.log('Login until:', moment(new Date().getTime() + (8 * 60 * 60 * 1000)).format('LLLL'));

                        showMainApp();
                        Toast.fire({
                            icon: 'success',
                            title: UI_TEXT.MESSAGES.LOGIN_SUCCESS
                        });
                    } else {
                        Toast.fire({
                            icon: 'error',
                            title: result.message || UI_TEXT.MESSAGES.LOGIN_FAILED
                        });
                    }
                    NProgress.done();
                })
                .withFailureHandler(function (error) {
                    hideLoginLoading();
                    console.error('Login error:', error);
                    Toast.fire({
                        icon: 'error',
                        title: UI_TEXT.MESSAGES.LOGIN_ERROR
                    });
                    NProgress.done();
                })
            [API_METHODS.AUTHENTICATE_USER](username, password);
        }

        function handleLogout() {
            event.preventDefault();
            Swal.fire({
                title: UI_TEXT.MESSAGES.LOGOUT_CONFIRM,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: UI_TEXT.BUTTONS.LOGOUT,
                cancelButtonText: UI_TEXT.BUTTONS.CANCEL
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem(CONFIG.STORAGE_KEY);
                    currentUser = null;
                    currentUserType = null;
                    showLoginPage();
                    Toast.fire({
                        icon: 'success',
                        title: UI_TEXT.MESSAGES.LOGOUT_SUCCESS
                    });
                }
            });
        }

        function showLoginPage() {
            $(SELECTORS.LOGIN_PAGE).removeClass('hidden');
            $(SELECTORS.MAIN_APP).addClass('hidden');
        }

        function showMainApp() {
            $(SELECTORS.LOGIN_PAGE).addClass('hidden');
            $(SELECTORS.MAIN_APP).removeClass('hidden');

            // Update user display
            $(SELECTORS.CURRENT_USER).text(currentUser);

            // Show/hide admin features
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                if (currentUserType === 'admin') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });

            // Load data and show dashboard
            loadData();
            showPage('dashboard');
        }

        function showPage(pageName) {
            // Hide all pages
            $('.page-content').addClass('hidden');

            // Update navigation
            $('.nav-link').removeClass('active');

            // Show selected page
            $('#' + pageName + 'Page').removeClass('hidden');
            $(`[data-page="${pageName}"]`).addClass('active');

            // Load page-specific data
            switch (pageName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'patients':
                    renderPatientsTable();
                    break;
                case 'appointments':
                    renderCalendar();
                    renderTodayAppointments();
                    loadPatientsForAppointment();
                    break;
                case 'revenue':
                    renderRevenueChart();
                    renderRevenueTable();
                    updateRevenueStats();
                    break;
                case 'reports':
                    if (currentUserType === 'admin') {
                        renderReports();
                    }
                    break;
            }
        }

        function loadData() {
            NProgress.start();

            // Load data from Google Apps Script backend
            loadPatients();
            loadAppointments();
            loadRevenues();
            updateNotifications();
        }

        function loadPatients() {
            google.script.run
                .withSuccessHandler(function (result) {
                    result = JSON.parse(result);
                    if (result.success) {
                        patients = result.patients || [];
                        renderPatientsTable();
                        updateDashboard();
                    } else {
                        console.error('Error loading patients:', result.message);
                        patients = [];
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Failed to load patients:', error);
                    patients = [];
                })
            [API_METHODS.GET_ALL_PATIENTS]();
        }

        function loadAppointments() {
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.success) {
                        appointments = result.appointments || [];
                        renderCalendar();
                        renderTodayAppointments();
                        updateDashboard();
                    } else {
                        console.error('Error loading appointments:', result.message);
                        appointments = [];
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Failed to load appointments:', error);
                    appointments = [];
                })
            [API_METHODS.GET_ALL_APPOINTMENTS]();
        }

        function loadRevenues() {
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.success) {
                        revenues = result.revenues || [];
                        renderRevenueTable();
                        updateRevenueStats();
                        renderRevenueChart();
                        updateDashboard();
                    } else {
                        console.error('Error loading revenues:', result.message);
                        revenues = [];
                    }
                    NProgress.done();
                })
                .withFailureHandler(function (error) {
                    console.error('Failed to load revenues:', error);
                    revenues = [];
                    NProgress.done();
                })
            [API_METHODS.GET_ALL_REVENUES]();
        }



        function updateDashboard() {
            // Update statistics
            $(SELECTORS.TOTAL_PATIENTS).text(patients.length);

            const today = new Date().toISOString().split('T')[0];
            const todayAppts = appointments.filter(apt => apt.appointment_date === today);
            $(SELECTORS.TODAY_APPOINTMENTS).text(todayAppts.length);

            const todayRev = revenues.filter(rev => rev.date === today)
                .reduce((sum, rev) => sum + rev.amount, 0);
            $(SELECTORS.TODAY_REVENUE).text(todayRev.toLocaleString() + ` ${UI_TEXT.LABELS.BAHT}`);

            $(SELECTORS.TOTAL_NOTIFICATIONS).text(todayAppts.length);

            // Update recent activities
            renderWeeklyAppointments();
            renderRecentPatients();
        }

        function renderWeeklyAppointments() {
            const $container = $(SELECTORS.WEEKLY_APPOINTMENTS);
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());

            const weeklyAppts = appointments.filter(apt => {
                const aptDate = new Date(apt.appointmentDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                return aptDate >= weekStart && aptDate <= weekEnd;
            });

            if (weeklyAppts.length === 0) {
                $container.html(`<p class="text-muted">${UI_TEXT.MESSAGES.NO_APPOINTMENTS_WEEK}</p>`);
                return;
            }

            const html = weeklyAppts.map(apt => {
                const patient = patients.find(p => p.id === apt.patientId);
                const patientName = patient ? `${patient.first_name} ${patient.last_name}` : UI_TEXT.MESSAGES.PATIENT_NOT_FOUND;
                const aptDate = new Date(apt.appointment_date);
                const dateStr = aptDate.toLocaleDateString(CONFIG.DATE_FORMAT_TH, {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short'
                });

                return `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <div class="fw-bold">${patientName}</div>
                            <small class="text-muted">${apt.treatment}</small>
                        </div>
                        <div class="text-end">
                            <div class="small">${dateStr}</div>
                            <div class="small text-primary">${apt.appointment_time}</div>
                        </div>
                    </div>
                `;
            }).join('');

            $container.html(html);
        }

        function renderRecentPatients() {
            const $container = $(SELECTORS.RECENT_PATIENTS);
            const recentPatients = patients.slice(-5).reverse();

            if (recentPatients.length === 0) {
                $container.html(`<p class="text-muted">${UI_TEXT.MESSAGES.NO_PATIENTS}</p>`);
                return;
            }

            const html = recentPatients.map(patient => {
                const regDate = new Date(patient.registration_date);
                const dateStr = regDate.toLocaleDateString(CONFIG.DATE_FORMAT_TH);

                return `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <div class="fw-bold">${patient.first_name} ${patient.last_name}</div>
                            <small class="text-muted">${patient.phone}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${dateStr}</small>
                        </div>
                    </div>
                `;
            }).join('');

            $container.html(html);
        }

        function renderPatientsTable() {
            const $tbody = $(`${SELECTORS.PATIENTS_TABLE} tbody`);

            if (patients.length === 0) {
                $tbody.html(`<tr><td colspan="6" class="text-center text-muted">${UI_TEXT.MESSAGES.NO_PATIENT_DATA}</td></tr>`);
                return;
            }

            const html = patients.map(patient => {
                const birthDate = new Date(patient.birth_date);
                const age = new Date().getFullYear() - birthDate.getFullYear();
                const regDate = new Date(patient.registration_date).toLocaleDateString(CONFIG.DATE_FORMAT_TH);

                return `
                    <tr>
                        <td>${patient.id}</td>
                        <td>${patient.first_name} ${patient.last_name}</td>
                        <td>${patient.phone}</td>
                        <td>${age} ${UI_TEXT.LABELS.YEARS_OLD}</td>
                        <td>${regDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editPatient('${patient.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePatient('${patient.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            $tbody.html(html);

            // Initialize DataTable if not already initialized
            if (!$.fn.DataTable.isDataTable(SELECTORS.PATIENTS_TABLE)) {
                $(SELECTORS.PATIENTS_TABLE).DataTable({
                    language: {
                        url: CONFIG.DATATABLES_LANG_URL
                    },
                    responsive: true,
                    columnDefs: [
                        { orderable: false, targets: 5 },
                        { className: 'dt-head-center dt-head-nowrap dt-body-center dt-body-nowrap text-center', targets: '_all' }
                    ]
                });
            }else{
                $(SELECTORS.PATIENTS_TABLE).DataTable().draw()
            }
        }

        function handlePatientSubmit(e) {
            e.preventDefault();
            const showPatientLoading = () => {
                NProgress.start();
                Swal.fire({
                    iconHtml: '<i class="bi-hourglass-split text-primary"></i>',
                    title: 'กำลังบันทึกข้อมูล...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: ' rounded-4',
                        icon: 'border-0'
                    }
                });
            }
            const hidePatientLoading = () => {
                NProgress.done();
                Swal.close();
            }
            const formData = new FormData(e.target);

            const patientData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                phone: formData.get('phone'),
                birthDate: formData.get('birthDate'),
                address: formData.get('address'),
                allergies: formData.get('allergies'),
                medicalHistory: formData.get('medicalHistory'),
                notes: formData.get('notes')
            };

            const patientId = e.target.dataset.patientId;
            showPatientLoading();
            if (patientId) {
                // Update existing patient
                google.script.run
                    .withSuccessHandler(function (result) {
                        hidePatientLoading();
                        if (result.success) {
                            loadPatients();
                            closePatientModal(e.target);
                            Toast.fire({
                                icon: 'success',
                                title: result.message
                            });
                        } else {
                            Toast.fire({
                                icon: 'error',
                                title: result.message
                            });
                        }
                        NProgress.done();
                    })
                    .withFailureHandler(function (error) {
                        hidePatientLoading();
                        console.error('Error updating patient:', error);
                        Toast.fire({
                            icon: 'error',
                            title: UI_TEXT.MESSAGES.UPDATE_ERROR
                        });
                        NProgress.done();
                    })
                [API_METHODS.UPDATE_PATIENT](patientId, patientData);
            } else {
                // Add new patient
                patientData.registrationDate = new Date().toISOString().split('T')[0];

                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result.success) {
                            loadPatients();
                            closePatientModal(e.target);
                            Toast.fire({
                                icon: 'success',
                                title: result.message
                            });
                        } else {
                            Toast.fire({
                                icon: 'error',
                                title: result.message
                            });
                        }
                        NProgress.done();
                    })
                    .withFailureHandler(function (error) {
                        console.error('Error adding patient:', error);
                        Toast.fire({
                            icon: 'error',
                            title: UI_TEXT.MESSAGES.ADD_ERROR
                        });
                        NProgress.done();
                    })
                [API_METHODS.ADD_PATIENT](patientData);
            }
        }

        function closePatientModal(form) {
            const modal = bootstrap.Modal.getInstance($(SELECTORS.PATIENT_MODAL)[0]);
            modal.hide();
            form.reset();
            delete form.dataset.patientId;
            // Reset form tracking
            originalPatientFormData = {};
            isPatientFormDirty = false;
        }

        // Function to capture initial form data
        function capturePatientFormData() {
            const form = $(SELECTORS.PATIENT_FORM)[0];
            const formData = new FormData(form);
            originalPatientFormData = {};

            for (let [key, value] of formData.entries()) {
                originalPatientFormData[key] = value;
            }

            // Also capture empty fields
            const inputs = form.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (!originalPatientFormData.hasOwnProperty(input.name)) {
                    originalPatientFormData[input.name] = input.value || '';
                }
            });

            isPatientFormDirty = false;
        }

        // Function to check if form data has changed
        function isPatientFormChanged() {
            const form = $(SELECTORS.PATIENT_FORM)[0];
            const currentFormData = new FormData(form);

            // Check all current form fields
            for (let [key, value] of currentFormData.entries()) {
                if (originalPatientFormData[key] !== value) {
                    return true;
                }
            }

            // Check for empty fields that might have had values initially
            const inputs = form.querySelectorAll('input, textarea, select');
            for (let input of inputs) {
                const currentValue = input.value || '';
                const originalValue = originalPatientFormData[input.name] || '';
                if (currentValue !== originalValue) {
                    return true;
                }
            }

            return false;
        }

        // Function to handle modal close with unsaved changes warning
        function handlePatientModalClose(event) {
            if (isPatientFormChanged()) {
                event.preventDefault();
                event.stopPropagation();

                Swal.fire({
                    title: 'มีการเปลี่ยนแปลงข้อมูล',
                    text: 'คุณมีการเปลี่ยนแปลงข้อมูลที่ยังไม่ได้บันทึก ต้องการออกจากหน้านี้หรือไม่?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ออกจากหน้านี้',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#a92246'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const form = $(SELECTORS.PATIENT_FORM)[0];
                        closePatientModal(form);
                    }
                });

                return false;
            }

            // If no changes, proceed with normal close
            const form = $(SELECTORS.PATIENT_FORM)[0];
            closePatientModal(form);
            return true;
        }

        function editPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            const form = $(SELECTORS.PATIENT_FORM)[0];
            form.dataset.patientId = patientId;

            // Populate form
            form.querySelector('[name="firstName"]').value = patient.first_name;
            form.querySelector('[name="lastName"]').value = patient.last_name;
            form.querySelector('[name="phone"]').value = patient.phone;
            form.querySelector('[name="address"]').value = patient.address || '';
            form.querySelector('[name="allergies"]').value = patient.allergies || '';
            form.querySelector('[name="medicalHistory"]').value = patient.medical_history || '';
            form.querySelector('[name="notes"]').value = patient.notes || '';
            form.querySelector('[name="birthDate"]')._flatpickr.setDate(patient.birth_date, true);
            // Show modal
            const modal = new bootstrap.Modal($(SELECTORS.PATIENT_MODAL)[0]);
            modal.show();

            // Capture initial form data after modal is shown and form is populated
            setTimeout(() => {
                capturePatientFormData();
            }, 100);
        }

        function deletePatient(patientId) {
            Swal.fire({
                title: UI_TEXT.MESSAGES.DELETE_PATIENT_CONFIRM,
                text: UI_TEXT.MESSAGES.DELETE_WARNING,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: UI_TEXT.BUTTONS.DELETE,
                cancelButtonText: UI_TEXT.BUTTONS.CANCEL,
                confirmButtonColor: '#a92246',
                customClass: {
                    popup: 'rounded-4'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    NProgress.start();
                    Swal.fire({
                        iconHtml: '<i class="bi-hourglass-split text-danger"></i>',
                        title: 'กำลังลบข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        customClass: {
                            popup: 'rounded-4',
                            icon: 'border-0'
                        }
                    });
                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                loadPatients();
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error deleting patient:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.DELETE_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.DELETE_PATIENT](patientId);
                }
            });
        }

        function renderCalendar() {
            const $calendar = $(SELECTORS.CALENDAR);
            const $monthYear = $(SELECTORS.CURRENT_MONTH);

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            $monthYear.text(currentMonth.toLocaleDateString(CONFIG.DATE_FORMAT_TH, {
                year: 'numeric',
                month: 'long'
            }));

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date();
            let html = '<div class="calendar-grid">';

            // Days of week header
            UI_TEXT.DAYS.forEach(day => {
                html += `<div class="calendar-cell text-center fw-bold bg-light">${day}</div>`;
            });

            // Calendar days
            for (let i = 0; i < CONFIG.CALENDAR_DAYS; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);

                const isCurrentMonth = date.getMonth() === month;
                const isToday = date.toDateString() === today.toDateString();
                const dateStr = date.toISOString().split('T')[0];

                const dayAppointments = appointments.filter(apt => apt.appointmentDate === dateStr);

                let cellClass = 'calendar-cell';
                if (!isCurrentMonth) cellClass += ' other-month';
                if (isToday) cellClass += ' today';

                html += `<div class="${cellClass}" data-date="${dateStr}">
                    <div>${date.getDate()}</div>`;

                if (dayAppointments.length > 0) {
                    html += `<div class="appointment-dot"></div>`;
                    html += `<small class="text-primary">${dayAppointments.length} นัด</small>`;
                }

                html += '</div>';
            }

            html += '</div>';
            $calendar.html(html);

            // Add click event to calendar cells
            $calendar.find('.calendar-cell').on('click', function () {
                const date = $(this).data('date');
                if (date) {
                    showAppointmentsForDate(date);
                }
            });
        }

        function showAppointmentsForDate(date) {
            const dayAppointments = appointments.filter(apt => apt.appointmentDate === date);
            const formattedDate = new Date(date).toLocaleDateString(CONFIG.DATE_FORMAT_TH);

            let html = `<h6>${UI_TEXT.LABELS.APPOINTMENT_DATE} ${formattedDate}</h6>`;

            if (dayAppointments.length === 0) {
                html += `<p class="text-muted">${UI_TEXT.MESSAGES.NO_APPOINTMENTS_DATE}</p>`;
            } else {
                html += dayAppointments.map(apt => {
                    const patient = patients.find(p => p.id === apt.patientId);
                    const patientName = patient ? `${patient.firstName} ${patient.lastName}` : UI_TEXT.MESSAGES.PATIENT_NOT_FOUND;

                    return `
                        <div class="card mb-2">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="fw-bold">${patientName}</div>
                                        <div class="text-muted">${apt.treatment}</div>
                                        <div class="small">${UI_TEXT.LABELS.TIME}: ${apt.appointmentTime}</div>
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editAppointment('${apt.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            Swal.fire({
                html: html,
                width: '600px',
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        function renderTodayAppointments() {
            const $container = $(SELECTORS.TODAY_APPOINTMENTS_LIST);
            const today = new Date().toISOString().split('T')[0];
            const todayAppts = appointments.filter(apt => apt.appointmentDate === today);

            if (todayAppts.length === 0) {
                $container.html(`<p class="text-muted">${UI_TEXT.MESSAGES.NO_APPOINTMENTS_TODAY}</p>`);
                return;
            }

            const html = todayAppts.map(apt => {
                const patient = patients.find(p => p.id === apt.patientId);
                const patientName = patient ? `${patient.firstName} ${patient.lastName}` : UI_TEXT.MESSAGES.PATIENT_NOT_FOUND;

                return `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <div class="fw-bold">${patientName}</div>
                            <div class="text-muted small">${apt.treatment}</div>
                            <div class="text-primary small">${UI_TEXT.LABELS.TIME}: ${apt.appointmentTime}</div>
                        </div>
                    </div>
                `;
            }).join('');

            $container.html(html);
        }

        function loadPatientsForAppointment() {
            const $select = $(`${SELECTORS.APPOINTMENT_FORM} select[name="patientId"]`);
            const options = patients.map(patient =>
                `<option value="${patient.id}">${patient.firstName} ${patient.lastName}</option>`
            ).join('');

            $select.html(`<option value="">${UI_TEXT.LABELS.SELECT_PATIENT}</option>` + options);
        }

        function handleAppointmentSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            const appointmentData = {
                patientId: formData.get('patientId'),
                appointmentDate: formData.get('appointmentDate'),
                appointmentTime: formData.get('appointmentTime'),
                treatment: formData.get('treatment'),
                cost: parseFloat(formData.get('cost')) || 0,
                notes: formData.get('notes'),
                status: formData.get('status')
            };

            const appointmentId = e.target.dataset.appointmentId;

            NProgress.start();

            if (appointmentId) {
                // Update existing appointment
                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result.success) {
                            loadAppointments();
                            closeAppointmentModal(e.target);
                            Toast.fire({
                                icon: 'success',
                                title: result.message
                            });
                        } else {
                            Toast.fire({
                                icon: 'error',
                                title: result.message
                            });
                        }
                        NProgress.done();
                    })
                    .withFailureHandler(function (error) {
                        console.error('Error updating appointment:', error);
                        Toast.fire({
                            icon: 'error',
                            title: UI_TEXT.MESSAGES.APPOINTMENT_UPDATE_ERROR
                        });
                        NProgress.done();
                    })
                [API_METHODS.UPDATE_APPOINTMENT](appointmentId, appointmentData);
            } else {
                // Add new appointment
                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result.success) {
                            loadAppointments();
                            closeAppointmentModal(e.target);
                            Toast.fire({
                                icon: 'success',
                                title: result.message
                            });
                        } else {
                            Toast.fire({
                                icon: 'error',
                                title: result.message
                            });
                        }
                        NProgress.done();
                    })
                    .withFailureHandler(function (error) {
                        console.error('Error adding appointment:', error);
                        Toast.fire({
                            icon: 'error',
                            title: UI_TEXT.MESSAGES.APPOINTMENT_ADD_ERROR
                        });
                        NProgress.done();
                    })
                [API_METHODS.ADD_APPOINTMENT](appointmentData);
            }
        }

        function closeAppointmentModal(form) {
            const modal = bootstrap.Modal.getInstance(document.querySelector(SELECTORS.APPOINTMENT_MODAL));
            modal.hide();
            form.reset();
            delete form.dataset.appointmentId;
        }

        function editAppointment(appointmentId) {
            const appointment = appointments.find(a => a.id === appointmentId);
            if (!appointment) return;

            const form = document.querySelector(SELECTORS.APPOINTMENT_FORM);
            form.dataset.appointmentId = appointmentId;

            // Populate form
            form.querySelector('[name="patientId"]').value = appointment.patientId;
            form.querySelector('[name="appointmentDate"]').value = appointment.appointmentDate;
            form.querySelector('[name="appointmentTime"]').value = appointment.appointmentTime;
            form.querySelector('[name="treatment"]').value = appointment.treatment;
            form.querySelector('[name="cost"]').value = appointment.cost;
            form.querySelector('[name="notes"]').value = appointment.notes || '';
            form.querySelector('[name="status"]').value = appointment.status;

            // Show modal
            const modal = new bootstrap.Modal(document.querySelector(SELECTORS.APPOINTMENT_MODAL));
            modal.show();
        }

        function handleRevenueSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            const revenueData = {
                date: formData.get('date'),
                description: formData.get('description'),
                amount: parseFloat(formData.get('amount')),
                type: formData.get('type'),
                notes: formData.get('notes')
            };

            NProgress.start();

            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.success) {
                        loadRevenues();
                        closeRevenueModal(e.target);
                        Toast.fire({
                            icon: 'success',
                            title: result.message
                        });
                    } else {
                        Toast.fire({
                            icon: 'error',
                            title: result.message
                        });
                    }
                    NProgress.done();
                })
                .withFailureHandler(function (error) {
                    console.error('Error adding revenue:', error);
                    Toast.fire({
                        icon: 'error',
                        title: UI_TEXT.MESSAGES.REVENUE_ADD_ERROR
                    });
                    NProgress.done();
                })
            [API_METHODS.ADD_REVENUE](revenueData);
        }

        function closeRevenueModal(form) {
            const modal = bootstrap.Modal.getInstance(document.querySelector(SELECTORS.REVENUE_MODAL));
            modal.hide();
            form.reset();
            form.querySelector('[name="date"]').value = new Date().toISOString().split('T')[0];
        }

        function renderRevenueTable() {
            const tbody = document.querySelector(`${SELECTORS.REVENUE_TABLE} tbody`);

            if (revenues.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">${UI_TEXT.MESSAGES.NO_REVENUE_DATA}</td></tr>`;
                return;
            }

            const sortedRevenues = revenues.sort((a, b) => new Date(b.date) - new Date(a.date));

            const html = sortedRevenues.map(revenue => {
                const date = new Date(revenue.date).toLocaleDateString(CONFIG.DATE_FORMAT_TH);

                return `
                    <tr>
                        <td>${date}</td>
                        <td>${revenue.description}</td>
                        <td class="text-end">${revenue.amount.toLocaleString()} ${UI_TEXT.LABELS.BAHT}</td>
                        <td>${revenue.notes || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRevenue('${revenue.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html;
        }

        function deleteRevenue(revenueId) {
            Swal.fire({
                title: UI_TEXT.MESSAGES.DELETE_REVENUE_CONFIRM,
                text: UI_TEXT.MESSAGES.DELETE_WARNING,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: UI_TEXT.BUTTONS.DELETE,
                cancelButtonText: UI_TEXT.BUTTONS.CANCEL,
                confirmButtonColor: '#a92246'
            }).then((result) => {
                if (result.isConfirmed) {
                    NProgress.start();

                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                loadRevenues();
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error deleting revenue:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.DELETE_REVENUE_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.DELETE_REVENUE](revenueId);
                }
            });
        }

        function updateRevenueStats() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const todayStr = today.toISOString().split('T')[0];

            // Daily revenue
            const dailyRev = revenues.filter(r => r.date === todayStr)
                .reduce((sum, r) => sum + r.amount, 0);
            $(SELECTORS.DAILY_REVENUE).text(`${dailyRev.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`);

            // Monthly revenue
            const monthlyRev = revenues.filter(r => {
                const rDate = new Date(r.date);
                return rDate.getMonth() === currentMonth && rDate.getFullYear() === currentYear;
            }).reduce((sum, r) => sum + r.amount, 0);
            $(SELECTORS.MONTHLY_REVENUE).text(`${monthlyRev.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`);

            // Yearly revenue
            const yearlyRev = revenues.filter(r => {
                const rDate = new Date(r.date);
                return rDate.getFullYear() === currentYear;
            }).reduce((sum, r) => sum + r.amount, 0);
            $(SELECTORS.YEARLY_REVENUE).text(`${yearlyRev.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`);
        }

        function renderRevenueChart() {
            const canvas = $(SELECTORS.REVENUE_CHART)[0];

            // Check if chart already exists and destroy it
            if (Chart.getChart(canvas)) {
                Chart.getChart(canvas).destroy();
            }

            const ctx = canvas.getContext('2d');

            // Get last 12 months data
            const monthlyData = [];
            const labels = [];

            for (let i = 11; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const month = date.getMonth();
                const year = date.getFullYear();

                const monthRevenue = revenues.filter(r => {
                    const rDate = new Date(r.date);
                    return rDate.getMonth() === month && rDate.getFullYear() === year;
                }).reduce((sum, r) => sum + r.amount, 0);

                monthlyData.push(monthRevenue);
                labels.push(date.toLocaleDateString(CONFIG.DATE_FORMAT_TH, { month: 'short', year: '2-digit' }));
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${UI_TEXT.LABELS.REVENUE_DAILY} (${UI_TEXT.LABELS.BAHT})`,
                        data: monthlyData,
                        borderColor: '#30308b',
                        backgroundColor: 'rgba(48, 48, 139, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return `${value.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`;
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${UI_TEXT.LABELS.REVENUE_DAILY}: ${context.parsed.y.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateNotifications() {
            // Simple notification system for upcoming appointments
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            const tomorrowAppts = appointments.filter(apt => apt.appointmentDate === tomorrowStr);

            if (tomorrowAppts.length > 0) {
                $(SELECTORS.NOTIFICATION_BADGE).text(tomorrowAppts.length);
                $(SELECTORS.NOTIFICATION_BADGE).removeClass('hidden');

                const $notificationList = $(SELECTORS.NOTIFICATION_LIST);
                const html = `
                    <li><h6 class="dropdown-header">${UI_TEXT.LABELS.NOTIFICATIONS}</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    ${tomorrowAppts.map(apt => {
                    const patient = patients.find(p => p.id === apt.patientId);
                    const patientName = patient ? `${patient.firstName} ${patient.lastName}` : UI_TEXT.MESSAGES.PATIENT_NOT_FOUND;
                    return `<li><a class="dropdown-item" href="#"><div class="fw-bold">${patientName}</div><small>${UI_TEXT.LABELS.TOMORROW_APPOINTMENT} ${apt.appointmentTime}</small></a></li>`;
                }).join('')}
                `;
                $notificationList.html(html);
            }
        }

        function renderReports() {
            // This would be implemented for admin users
            console.log('Rendering reports for admin user');
        }

        // Global functions for onclick events
        window.editPatient = editPatient;
        window.deletePatient = deletePatient;
        window.editAppointment = editAppointment;
        window.deleteRevenue = deleteRevenue;
    </script>
</body>

</html>