    <!DOCTYPE html>
    <html lang="th">

    <head>
        <base target="_top">
        <!-- no cache -->
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <!-- no cache -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Smile Focus - ระบบจัดการคนไข้คลินิคทันตกรรม</title>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
        <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_red.css">
        <link
            href="https://cdn.datatables.net/v/bs5/dt-2.3.0/b-3.2.3/date-1.5.5/fh-4.0.1/r-3.0.4/sl-3.0.0/datatables.min.css"
            rel="stylesheet" integrity="sha384-pDoMXaoekHsQmb1L6aeyRL/WoJRQnDTYvUeWu4LbiTVT2Vhp2niYUKgdwBE/Tnl8"
            crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
            integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
            crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
        <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
        <!-- Styles -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

        <style>
            * {
                font-family: 'Noto Sans Thai', sans-serif;
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            .navbar-brand {
                font-weight: bold;
                color: #30308b !important;
            }

            .navbar-logo {
                height: 32px;
                width: auto;
                max-width: 40px;
                object-fit: contain;
            }

            .clinic-logo {
                height: 80px;
                width: auto;
                max-width: 120px;
                object-fit: contain;
            }

            .card {
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                border: none;
                border-radius: 10px;
            }

            .btn-primary {
                background: #30308b;
                border: none;
            }

            .btn-primary:hover {
                background: #a92246;
            }

            .sidebar {
                min-height: 100vh;
                background: #30308b;
            }

            .sidebar .nav-link {
                color: white !important;
                padding: 12px 20px;
                border-radius: 5px;
                margin: 5px 10px;
                transition: all 0.3s;
            }

            .sidebar .nav-link:hover,
            .sidebar .nav-link.active {
                background: rgba(255, 255, 255, 0.2);
                transform: translateX(5px);
            }

            .stats-card {
                background: #30308b;
                color: white;
                border-radius: 15px;
            }

            .stats-card-2 {
                background: #a92246;
                color: white;
                border-radius: 15px;
            }

            .stats-card-3 {
                background: #009958;
                color: white;
                border-radius: 15px;
            }

            .stats-card-4 {
                background: #30308b;
                color: white;
                border-radius: 15px;
            }

            .login-container {
                min-height: 100vh;
                background: white;
            }

            .login-card {
                border-radius: 20px;
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            }

            .hidden {
                display: none !important;
            }

            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 1px;
                background: #dee2e6;
                border-radius: 10px;
                overflow: hidden;
            }

            .calendar-cell {
                background: white;
                min-height: 80px;
                padding: 8px;
                position: relative;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .calendar-cell:hover {
                background-color: #f8f9fa;
            }

            .calendar-cell.other-month {
                background-color: #f8f9fa;
                color: #6c757d;
            }

            .calendar-cell.today {
                background-color: #e6f0f9;
                font-weight: bold;
            }

            .calendar-cell.selected {
                border: 3px solid #30308b;
                background-color: #f0f8ff;
                font-weight: bold;
            }

            .appointment-dots {
                position: absolute;
                bottom: 5px;
                right: 5px;
                display: flex;
                flex-direction: column;
                gap: 2px;
            }

            .appointment-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: #009958;
            }

            .appointment-dot.scheduled {
                background-color: #30308b;
            }

            .appointment-dot.completed {
                background-color: #009958;
            }

            .appointment-dot.cancelled {
                background-color: #a92246;
            }

            .appointment-status-icon {
                width: 16px;
                height: 16px;
                margin-right: 8px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                font-size: 10px;
                color: white;
            }

            .appointment-status-icon.scheduled {
                background-color: #30308b;
            }

            .appointment-status-icon.completed {
                background-color: #009958;
            }

            .appointment-status-icon.cancelled {
                background-color: #a92246;
            }

            .notification-badge {
                position: absolute;
                top: -5px;
                right: -5px;
                background: #a92246;
                color: white;
                border-radius: 50%;
                padding: 4px 8px;
                font-size: 12px;
            }

            .small {
                font-size: 0.875em;
            }

            #todayAppointmentsList .list-group-item {
                cursor: pointer;
            }

            #todayAppointmentsList .list-group-item:hover {
                background-color: #f8f9fa;
            }

            #todayAppointmentsList .list-group-item {
                .badge.completed {
                    background-color: #009958;
                }

                .badge.cancelled {
                    background-color: #a92246;
                }

                .badge.scheduled {
                    background-color: #30308b;
                }
            }

            .form-check-container {
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid #dee2e6;
                border-radius: 5px;
                padding: 10px;
                background-color: #f8f9fa;
            }

            .form-check {
                margin-bottom: 8px;
            }

            .form-check-input:checked {
                background-color: #30308b;
                border-color: #30308b;
            }

            .form-check-input:focus {
                border-color: #30308b;
                box-shadow: 0 0 0 0.2rem rgba(48, 48, 139, 0.25);
            }

            /* Pill styling */
            .case-type-pill, .case-details-pill {
                transition: all 0.3s ease;
                cursor: pointer !important;
                font-size: 0.9em !important;
                padding: 8px 12px !important;
                border: 2px solid #d6d8db !important;
                color: #6c757d !important;
                background: #f8f9fa !important;
            }

            .case-type-pill:hover {
                border-color: #0d6efd !important;
                color: #0d6efd !important;
                background: #fff !important;
            }

            .case-type-pill.selected {
                border-color: #0d6efd !important;
                color: #fff !important;
                background: #0d6efd !important;
            }

            .case-details-pill:hover {
                border-color: #198754 !important;
                color: #198754 !important;
                background: #fff !important;
            }

            .case-details-pill.selected {
                border-color: #198754 !important;
                color: #fff !important;
                background: #198754 !important;
            }

            .case-details-pill.case-details-other:hover {
                border-color: #ffc107 !important;
                color: #ffc107 !important;
                background: #fff !important;
            }

            .case-details-pill.case-details-other.selected {
                border-color: #ffc107 !important;
                color: #000 !important;
                background: #ffc107 !important;
            }

            /* Loading page styles */
            .loading-page {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 9999;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                transition: opacity 0.5s ease-out;
            }

            .loading-page.fade-out {
                opacity: 0;
                pointer-events: none;
            }

            .loading-logo {
                width: 250px;
                height: 250px;
                margin-bottom: 40px;
                animation: pulse 2s infinite ease-in-out;
            }

            .loading-text {
                font-size: 1.2rem;
                color: #30308b;
                margin-bottom: 20px;
                font-weight: 500;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #30308b;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </head>

    <body class="bg-light">
        <!-- Loading Page -->
        <div id="loadingPage" class="loading-page">
            <img src="https://img2.pic.in.th/pic/Screenshot-2025-09-22-215301.png" alt="Clinic Logo" class="loading-logo">
            <div class="loading-text">กำลังโหลดระบบจัดการคลินิคทันตกรรม</div>
            <div class="loading-spinner"></div>
            <div class="mt-3 text-muted">กรุณารอสักครู่...</div>
        </div>

        <!-- Login Page -->
        <div id="loginPage" class="login-container d-flex align-items-center justify-content-center">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-6 col-lg-4">
                        <div class="card login-card">
                            <div class="card-body p-5">
                                <div class="text-center mb-4">
                                    <img src="https://img2.pic.in.th/pic/Screenshot-2025-09-22-215301.png"
                                        alt="Smile Focus Logo" class="clinic-logo mb-3">
                                    <h3 class="mb-1">Smile Focus</h3>
                                    <p class="text-muted">เข้าสู่ระบบเพื่อใช้งาน</p>
                                </div>

                                <form id="loginForm">
                                    <div class="mb-3">
                                        <label for="username" class="form-label">ชื่อผู้ใช้</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                                            <input type="text" class="form-control" id="username" required>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="password" class="form-label">รหัสผ่าน</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                            <input type="password" class="form-control" id="password" required>
                                        </div>
                                    </div>


                                    <button type="submit" class="btn btn-primary w-100 py-2">
                                        <i class="fas fa-sign-in-alt me-2"></i>เข้าสู่ระบบ
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <!-- Navigation -->
            <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                <div class="container-fluid">
                    <a class="navbar-brand" href="javascript:void(0)">
                        <img src="https://img2.pic.in.th/pic/Screenshot-2025-09-22-215301.png" alt="Smile Focus Logo"
                            class="navbar-logo me-2">
                        Smile Focus
                    </a>

                    <div class="d-flex align-items-center">
                        <div class="dropdown me-3">
                            <button class="btn btn-outline-primary dropdown-toggle position-relative" type="button"
                                id="notificationDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-bell"></i>
                                <span id="notificationBadge" class="notification-badge hidden">0</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" id="notificationList">
                                <li>
                                    <h6 class="dropdown-header">การแจ้งเตือน</h6>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><span class="dropdown-item-text text-muted">ไม่มีการแจ้งเตือนใหม่</span></li>
                            </ul>
                        </div>

                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="userDropdown"
                                data-bs-toggle="dropdown">
                                <i class="fas fa-user me-2"></i>
                                <span id="currentUser">ผู้ใช้</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="javascript:void(0)" id="logoutBtn">
                                        <i class="fas fa-sign-out-alt me-2"></i>ออกจากระบบ
                                    </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="container-fluid">
                <div class="row">
                    <!-- Sidebar -->
                    <div class="col-md-3 col-lg-2 px-0">
                        <div class="sidebar">
                            <div class="nav flex-column nav-pills p-3">
                                <a class="nav-link active" href="javascript:void(0)" data-page="dashboard">
                                    <i class="fas fa-tachometer-alt me-2"></i>หน้าหลัก
                                </a>
                                <a class="nav-link" href="javascript:void(0)" data-page="patients">
                                    <i class="fas fa-users me-2"></i>จัดการคนไข้
                                </a>
                                <a class="nav-link" href="javascript:void(0)" data-page="doctors">
                                    <i class="fas fa-user-md me-2"></i>จัดการหมอ
                                </a>
                                <a class="nav-link" href="javascript:void(0)" data-page="appointments">
                                    <i class="fas fa-calendar-alt me-2"></i>การนัดหมาย
                                </a>
                                <a class="nav-link" href="javascript:void(0)" data-page="revenue">
                                    <i class="fas fa-chart-line me-2"></i>รายได้รายวัน
                                </a>
                                <a class="nav-link admin-only hidden" href="javascript:void(0)" data-page="reports">
                                    <i class="fas fa-chart-bar me-2"></i>รายงาน
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="col-md-9 col-lg-10">
                        <div class="p-4">
                            <!-- Dashboard Page -->
                            <div id="dashboardPage" class="page-content">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h2>หน้าหลัก</h2>
                                    <div class="text-muted">วันที่: <span id="currentDate"></span></div>
                                </div>

                                <!-- Statistics Cards -->
                                <div class="row mb-4">
                                    <div class="col-md-4 mb-3">
                                        <div class="card stats-card p-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">คนไข้ทั้งหมด</h6>
                                                    <h3 class="mb-0" id="totalPatients">0</h3>
                                                </div>
                                                <i class="fas fa-users fa-2x opacity-75"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <div class="card stats-card-2 p-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">นัดหมายวันนี้</h6>
                                                    <h3 class="mb-0" id="todayAppointments">0</h3>
                                                </div>
                                                <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <div class="card stats-card-3 p-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">รายได้วันนี้</h6>
                                                    <h3 class="mb-0" id="todayRevenue">0</h3>
                                                </div>
                                                <i class="fas fa-money-bill-wave fa-2x opacity-75"></i>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <!-- Recent Activities -->
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">นัดหมายในสัปดาห์นี้</h5>
                                            </div>
                                            <div class="card-body">
                                                <div id="weeklyAppointments"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">คนไข้ใหม่ล่าสุด</h5>
                                            </div>
                                            <div class="card-body">
                                                <div id="recentPatients"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Patients Page -->
                            <div id="patientsPage" class="page-content hidden">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h2>จัดการคนไข้</h2>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#patientModal">
                                        <i class="fas fa-plus me-2"></i>เพิ่มคนไข้ใหม่
                                    </button>
                                </div>

                                <div class="card">
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table id="patientsTable" class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>รหัสคนไข้</th>
                                                        <th>ชื่อ-นามสกุล</th>
                                                        <th>เบอร์โทร</th>
                                                        <th>อายุ</th>
                                                        <th>วันที่ลงทะเบียน</th>
                                                        <th>การจัดการ</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Doctors Page -->
                            <div id="doctorsPage" class="page-content hidden">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h2>จัดการหมอ</h2>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#doctorModal">
                                        <i class="fas fa-plus me-2"></i>เพิ่มหมอใหม่
                                    </button>
                                </div>

                                <div class="card">
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table id="doctorsTable" class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>รหัสหมอ</th>
                                                        <th>ชื่อ-นามสกุล</th>
                                                        <th>ความเชี่ยวชาญ</th>
                                                        <th>เบอร์โทร</th>
                                                        <th>อีเมล</th>
                                                        <th>การจัดการ</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Appointments Page -->
                            <div id="appointmentsPage" class="page-content hidden">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h2>การนัดหมาย</h2>
                                    <button class="btn btn-primary" data-bs-toggle="modal"
                                        data-bs-target="#appointmentModal">
                                        <i class="fas fa-plus me-2"></i>เพิ่มนัดหมายใหม่
                                    </button>
                                </div>

                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">ปฏิทินการนัดหมาย</h5>
                                                <div>
                                                    <button class="btn btn-sm btn-outline-primary" id="prevMonth">
                                                        <i class="fas fa-chevron-left"></i>
                                                    </button>
                                                    <span id="currentMonth" class="mx-3"></span>
                                                    <button class="btn btn-sm btn-outline-primary" id="nextMonth">
                                                        <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="calendar"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">นัดหมายวันที่ <span id="selectedDate"
                                                        class="text-primary"></span></h5>
                                            </div>
                                            <div class="card-body">
                                                <div id="todayAppointmentsList" class="list-group list-group-flush">
                                                    <p class="text-muted">กำลังโหลด...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Revenue Page -->
                            <div id="revenuePage" class="page-content hidden">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h2>รายได้รายวัน</h2>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#revenueModal">
                                        <i class="fas fa-plus me-2"></i>บันทึกรายได้
                                    </button>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="text-muted">รายได้วันนี้</h6>
                                                <h3 class="text-primary" id="dailyRevenue">0 บาท</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="text-muted">รายได้เดือนนี้</h6>
                                                <h3 class="text-success" id="monthlyRevenue">0 บาท</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="text-muted">รายได้ปีนี้</h6>
                                                <h3 class="text-info" id="yearlyRevenue">0 บาท</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">กราฟรายได้รายเดือน</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="revenueChart" height="100"></canvas>
                                    </div>
                                </div>

                                <div class="card mt-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">ประวัติรายได้</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table id="revenueTable" class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>วันที่</th>
                                                        <th>รายการ</th>
                                                        <th>จำนวนเงิน</th>
                                                        <th>หมายเหตุ</th>
                                                        <th>การจัดการ</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reports Page (Admin Only) -->
                            <div id="reportsPage" class="page-content hidden">
                                <h2 class="mb-4">รายงาน</h2>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">สรุปคนไข้รายเดือน</h5>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="patientsChart" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">สรุปการนัดหมายรายเดือน</h5>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="appointmentsChart" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Modal -->
        <div class="modal fade" id="patientModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
            data-bs-focus="false">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">เพิ่ม/แก้ไขข้อมูลคนไข้</h5>
                        <button type="button" class="btn-close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="patientForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">คำนำหน้าชื่อ</label>
                                        <input type="text" class="form-control" name="titlePrefix" list="titlePrefixList"
                                            placeholder="เลือกหรือพิมพ์">
                                        <datalist id="titlePrefixList">
                                            <option value="นาย">
                                            <option value="นาง">
                                            <option value="นางสาว">
                                            <option value="ไม่ระบุ">
                                        </datalist>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">ชื่อ</label>
                                        <input type="text" class="form-control" name="firstName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">นามสกุล</label>
                                        <input type="text" class="form-control" name="lastName" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">เบอร์โทรศัพท์</label>
                                        <input type="tel" class="form-control" name="phone" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">วันเกิด</label>
                                        <input type="date" class="form-control" name="birthDate" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ที่อยู่</label>
                                <textarea class="form-control" name="address" rows="3"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ประวัติการแพ้ยา</label>
                                <textarea class="form-control" name="allergies" rows="2"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">โรคประจำตัว</label>
                                <textarea class="form-control" name="medicalHistory" rows="2"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">หมายเหตุ</label>
                                <textarea class="form-control" name="notes" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelButton">ยกเลิก</button>
                        <button type="button" class="btn btn-primary" id="savePatientButton">บันทึก</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Doctor Modal -->
        <div class="modal fade" id="doctorModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
            data-bs-focus="false">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">เพิ่ม/แก้ไขข้อมูลหมอ</h5>
                        <button type="button" class="btn-close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="doctorForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">ชื่อ</label>
                                        <input type="text" class="form-control" name="firstName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">นามสกุล</label>
                                        <input type="text" class="form-control" name="lastName" required>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ความเชี่ยวชาญ</label>
                                <input type="text" class="form-control" name="specialty" required
                                    placeholder="เช่น ทันตกรรมจัดฟัน, ทันตกรรมรากฟัน">
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">เบอร์โทรศัพท์</label>
                                        <input type="tel" class="form-control" name="phone" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">อีเมล</label>
                                        <input type="email" class="form-control" name="email">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ใบอนุญาตประกอบวิชาชีพ</label>
                                <input type="text" class="form-control" name="licenseNumber" placeholder="หมายเลขใบอนุญาต">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">หมายเหตุ</label>
                                <textarea class="form-control" name="notes" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelDoctorButton">ยกเลิก</button>
                        <button type="button" class="btn btn-primary" id="saveDoctorButton">บันทึก</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointment Modal -->
        <div class="modal fade" id="appointmentModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
            data-bs-focus="false">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">เพิ่ม/แก้ไขการนัดหมาย</h5>
                        <button type="button" class="btn-close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="appointmentForm">
                            <div class="mb-3">
                                <label class="form-label">เลือกคนไข้</label>
                                <select class="form-select" name="patientId" required>
                                    <option value="">เลือกคนไข้</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">เลือกหมอ</label>
                                <select class="form-select" name="doctorId" required>
                                    <option value="">เลือกหมอ</option>
                                </select>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">วันที่นัด</label>
                                        <input type="date" class="form-control" name="appointmentDate" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">เวลานัด</label>
                                        <input type="time" class="form-control" name="appointmentTime" required>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ประเภทเคส <span class="text-danger">*</span></label>
                                <div class="form-check-container">
                                    <!-- Dynamic case type options will be loaded here -->
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">รายละเอียดเคส</label>
                                <div class="form-check-container">
                                    <!-- Dynamic case details options will be loaded here -->
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ค่าใช้จ่าย (บาท)</label>
                                <input type="number" class="form-control" name="cost" min="0" step="0.01">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">หมายเหตุ</label>
                                <textarea class="form-control" name="notes" rows="2"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">สถานะ</label>
                                <select class="form-select" name="status">
                                    <option value="scheduled">นัดหมาย</option>
                                    <option value="completed">เสร็จสิ้น</option>
                                    <option value="cancelled">ยกเลิก</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelAppointmentButton">ยกเลิก</button>
                        <button type="button" class="btn btn-primary" id="saveAppointmentButton">บันทึก</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue Modal -->
        <div class="modal fade" id="revenueModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
            data-bs-focus="false">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">บันทึกรายได้</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="revenueForm">
                            <div class="mb-3">
                                <label class="form-label">วันที่</label>
                                <input type="date" class="form-control" name="date" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">รายการ</label>
                                <input type="text" class="form-control" name="description" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">จำนวนเงิน (บาท)</label>
                                <input type="number" class="form-control" name="amount" min="0" step="0.01" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ประเภท</label>
                                <select class="form-select" name="type">
                                    <option value="treatment">รายได้จากการรักษา</option>
                                    <option value="consultation">รายได้จากการตรวจ</option>
                                    <option value="other">อื่นๆ</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">หมายเหตุ</label>
                                <textarea class="form-control" name="notes" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="button" class="btn btn-primary" id="saveRevenueButton">บันทึก</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
            </script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
        <script
            src="https://cdn.datatables.net/v/bs5/dt-2.3.0/b-3.2.3/date-1.5.5/fh-4.0.1/r-3.0.4/sl-3.0.0/datatables.min.js"
            integrity="sha384-NGgUUnjETvXZrx9vJMQOG/C654mzSDv63TrMt0zQmS1HW58fN4RdjorjyZqEMIZ9" crossorigin="anonymous">
            </script>

        <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
        <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script
            src="https://cdn.jsdelivr.net/gh/tanaikech/ResumableUploadForGoogleDrive_js@master/resumableupload_js.min.js">
            </script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script>
            AOS.init();
            moment.locale('th');
            flatpickr.localize(flatpickr.l10ns.th);
            // Constants for UI text strings
            const UI_TEXT = {
                MESSAGES: {
                    LOGIN_SUCCESS: 'เข้าสุ่ในระบบสำเร็จ',
                    LOGIN_FAILED: 'เข้าสู่ระบบไม่สำเร็จ',
                    LOGIN_ERROR: 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ',
                    LOGOUT_SUCCESS: 'ออกจากระบบเรียบร้อย',
                    LOGOUT_CONFIRM: 'ต้องการออกจากระบบ?',
                    DELETE_PATIENT_CONFIRM: 'ต้องการลบข้อมูลคนไข้?',
                    DELETE_REVENUE_CONFIRM: 'ต้องการลบรายการรายได้?',
                    DELETE_WARNING: 'การดำเนินการนี้ไม่สามารถย้อนกลับได้',
                    NO_APPOINTMENTS_WEEK: 'ไม่มีนัดหมายในสัปดาห์นี้',
                    NO_PATIENTS: 'ยังไม่มีคนไข้',
                    NO_PATIENT_DATA: 'ยังไม่มีข้อมูลคนไข้',
                    NO_REVENUE_DATA: 'ยังไม่มีข้อมูลรายได้',
                    NO_APPOINTMENTS_TODAY: 'ไม่มีนัดหมายวันนี้',
                    NO_APPOINTMENTS_DATE: 'ไม่มีนัดหมายในวันนี้',
                    PATIENT_NOT_FOUND: 'ไม่พบข้อมูลคนไข้',
                    UPDATE_ERROR: 'เกิดข้อผิดพลาดในการอัปเดตข้อมูล',
                    ADD_ERROR: 'เกิดข้อผิดพลาดในการเพิ่มข้อมูล',
                    DELETE_ERROR: 'เกิดข้อผิดพลาดในการลบข้อมูล',
                    APPOINTMENT_UPDATE_ERROR: 'เกิดข้อผิดพลาดในการอัปเดตการนัดหมาย',
                    APPOINTMENT_ADD_ERROR: 'เกิดข้อผิดพลาดในการเพิ่มการนัดหมาย',
                    REVENUE_ADD_ERROR: 'เกิดข้อผิดพลาดในการบันทึกรายได้',
                    DELETE_REVENUE_ERROR: 'เกิดข้อผิดพลาดในการลบรายการ',
                    DELETE_DOCTOR_CONFIRM: 'ต้องการลบข้อมูลหมอ?',
                    NO_DOCTORS: 'ยังไม่มีข้อมูลหมอ',
                    DOCTOR_NOT_FOUND: 'ไม่พบข้อมูลหมอ',
                    DOCTOR_UPDATE_ERROR: 'เกิดข้อผิดพลาดในการอัปเดตข้อมูลหมอ',
                    DOCTOR_ADD_ERROR: 'เกิดข้อผิดพลาดในการเพิ่มข้อมูลหมอ',
                    DELETE_DOCTOR_ERROR: 'เกิดข้อผิดพลาดในการลบข้อมูลหมอ'
                },
                BUTTONS: {
                    LOGIN: 'เข้าสู่ระบบ',
                    LOGOUT: 'ออกจากระบบ',
                    CANCEL: 'ยกเลิก',
                    SAVE: 'บันทึก',
                    DELETE: 'ลบ',
                    EDIT: 'แก้ไข'
                },
                LABELS: {
                    PATIENTS_TOTAL: 'คนไข้ทั้งหมด',
                    APPOINTMENTS_TODAY: 'นัดหมายวันนี้',
                    REVENUE_TODAY: 'รายได้วันนี้',
                    NOTIFICATIONS: 'การแจ้งเตือน',
                    REVENUE_DAILY: 'รายได้วันนี้',
                    REVENUE_MONTHLY: 'รายได้เดือนนี้',
                    REVENUE_YEARLY: 'รายได้ปีนี้',
                    BAHT: 'บาท',
                    YEARS_OLD: 'ปี',
                    TIME: 'เวลา',
                    APPOINTMENT_DATE: 'นัดหมายวันที่',
                    SELECT_PATIENT: 'เลือกคนไข้',
                    SELECT_DOCTOR: 'เลือกหมอ',
                    DOCTORS_TOTAL: 'หมอทั้งหมด',
                    TOMORROW_APPOINTMENT: 'นัดพรุ่งนี้ เวลา'
                },
                NAVIGATION: {
                    DASHBOARD: 'หน้าหลัก',
                    PATIENTS: 'จัดการคนไข้',
                    DOCTORS: 'จัดการหมอ',
                    APPOINTMENTS: 'การนัดหมาย',
                    REVENUE: 'รายได้รายวัน',
                    REPORTS: 'รายงาน'
                },
                DAYS: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส']
            };

            // Constants for API method names
            const API_METHODS = {
                AUTHENTICATE_USER: 'authenticateUser',
                GET_ALL_PATIENTS: 'getAllPatients',
                GET_ALL_APPOINTMENTS: 'getAllAppointments',
                GET_ALL_REVENUES: 'getAllRevenues',
                GET_ALL_OPTIONS: 'getAllOptions',
                ADD_PATIENT: 'addPatient',
                UPDATE_PATIENT: 'updatePatient',
                DELETE_PATIENT: 'deletePatient',
                ADD_APPOINTMENT: 'addAppointment',
                UPDATE_APPOINTMENT: 'updateAppointment',
                ADD_REVENUE: 'addRevenue',
                DELETE_REVENUE: 'deleteRevenue'
            };

            // Constants for DOM selectors and IDs
            const SELECTORS = {
                LOGIN_PAGE: '#loginPage',
                MAIN_APP: '#mainApp',
                LOGIN_FORM: '#loginForm',
                CURRENT_USER: '#currentUser',
                CURRENT_DATE: '#currentDate',
                TOTAL_PATIENTS: '#totalPatients',
                TOTAL_DOCTORS: '#totalDoctors',
                TODAY_APPOINTMENTS: '#todayAppointments',
                TODAY_REVENUE: '#todayRevenue',
                NOTIFICATION_BADGE: '#notificationBadge',
                NOTIFICATION_LIST: '#notificationList',
                WEEKLY_APPOINTMENTS: '#weeklyAppointments',
                RECENT_PATIENTS: '#recentPatients',
                PATIENTS_TABLE: '#patientsTable',
                PATIENT_FORM: '#patientForm',
                PATIENT_MODAL: '#patientModal',
                APPOINTMENT_FORM: '#appointmentForm',
                APPOINTMENT_MODAL: '#appointmentModal',
                REVENUE_FORM: '#revenueForm',
                REVENUE_MODAL: '#revenueModal',
                CALENDAR: '#calendar',
                CURRENT_MONTH: '#currentMonth',
                TODAY_APPOINTMENTS_LIST: '#todayAppointmentsList',
                REVENUE_TABLE: '#revenueTable',
                DAILY_REVENUE: '#dailyRevenue',
                MONTHLY_REVENUE: '#monthlyRevenue',
                YEARLY_REVENUE: '#yearlyRevenue',
                REVENUE_CHART: '#revenueChart',
                DOCTOR_FORM: '#doctorForm',
                DOCTOR_MODAL: '#doctorModal',
                SUBMIT_PATIENT_BUTTON: '#savePatientButton',
                SUBMIT_APPOINTMENT_BUTTON: '#saveAppointmentButton',
                SUBMIT_REVENUE_BUTTON: '#saveRevenueButton',
                SUBMIT_DOCTOR_BUTTON: '#saveDoctorButton'
            };

            // Constants for configuration values
            const CONFIG = {
                STORAGE_KEY: 'dentalUser',
                DATE_FORMAT_TH: 'th-TH',
                DATATABLES_LANG_URL: '//cdn.datatables.net/plug-ins/1.13.4/i18n/th.json',
                TOAST_TIMER: 3000,
                CALENDAR_DAYS: 42
            };

            let Toast;
            let currentUser = null;
            let currentUserType = null;
            let patients = [];
            let doctors = [];
            let appointments = [];
            let revenues = [];
            let currentMonth = new Date();

            // Option lists from Option List sheet
            let caseTypes = [];
            let caseDetails = [];

            // Form tracking variables for unsaved changes warning
            let originalPatientFormData = {};
            let isPatientFormDirty = false;
            let originalAppointmentFormData = {};
            let isAppointmentFormDirty = false;
            let originalDoctorFormData = {};
            let isDoctorFormDirty = false;

            // Appointment status helper functions
            function getStatusIcon(status) {
                const statusIcons = {
                    'scheduled': 'fas fa-clock',
                    'completed': 'fas fa-check',
                    'cancelled': 'fas fa-times'
                };
                return statusIcons[status] || 'fas fa-clock';
            }

            function getStatusText(status) {
                const statusTexts = {
                    'scheduled': 'นัดหมาย',
                    'completed': 'เสร็จสิ้น',
                    'cancelled': 'ยกเลิก'
                };
                return statusTexts[status] || 'นัดหมาย';
            }

            function groupAppointmentsByStatus(appointments) {
                return appointments.reduce((groups, apt) => {
                    const status = apt.status || 'scheduled';
                    if (!groups[status]) {
                        groups[status] = [];
                    }
                    groups[status].push(apt);
                    return groups;
                }, {});
            }

            // Initialize Toast
            Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: CONFIG.TOAST_TIMER,
                timerProgressBar: true,
            });

            $(document).ready(function () {
                NProgress.done();
                initializeApp();
            });

            function initializeApp() {
                checkLoginStatus();
                setupEventListeners();
                updateCurrentDate();
                setupSelect2()
            }

            function setupSelect2() {
                // Initialize Select2 elements
                $(SELECTORS.APPOINTMENT_FORM + ' select[name="patientId"]').select2({
                    theme: 'bootstrap-5',
                    dropdownParent: $('#appointmentModal'),
                    templateResult: function (option) {
                        if (!option.id) return option.text;

                        const patient = patients.find(p => p.id === option.id);
                        if (!patient) return option.text;

                        return $(`<div><strong>${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name}</strong> ${patient.last_name}</div>`);
                    },
                });

                $(SELECTORS.APPOINTMENT_FORM + ' select[name="doctorId"]').select2({
                    theme: 'bootstrap-5',
                    dropdownParent: $('#appointmentModal'),
                    templateResult: function (option) {
                        if (!option.id) return option.text;

                        const doctor = doctors.find(d => d.id === option.id);
                        if (!doctor) return option.text;

                        return $(`<div><strong>${doctor.first_name}</strong> ${doctor.last_name}</div>`);
                    },
                });
            }

            function setupEventListeners() {
                // Login form
                $(SELECTORS.LOGIN_FORM).on('submit', handleLogin);

                // Logout
                $('#logoutBtn').on('click', handleLogout);

                // Navigation
                $('.nav-link[data-page]').on('click', function (e) {
                    e.preventDefault();
                    showPage($(this).data('page'));
                });


                // Forms
                $(SELECTORS.PATIENT_FORM).on('submit', handlePatientSubmit);
                $(SELECTORS.APPOINTMENT_FORM).on('submit', handleAppointmentSubmit);
                $(SELECTORS.REVENUE_FORM).on('submit', handleRevenueSubmit);
                $(SELECTORS.DOCTOR_FORM).on('submit', handleDoctorSubmit);

                // // Modal Submit
                $(SELECTORS.SUBMIT_PATIENT_BUTTON).on('click', () => $(SELECTORS.PATIENT_FORM).submit())
                $(SELECTORS.SUBMIT_APPOINTMENT_BUTTON).on('click', () => $(SELECTORS.APPOINTMENT_FORM).submit())
                $(SELECTORS.SUBMIT_REVENUE_BUTTON).on('click', () => $(SELECTORS.REVENUE_FORM).submit());
                $(SELECTORS.SUBMIT_DOCTOR_BUTTON).on('click', () => $(SELECTORS.DOCTOR_FORM).submit());

                // Calendar navigation
                $('#prevMonth').on('click', function () {
                    currentMonth.setMonth(currentMonth.getMonth() - 1);
                    renderCalendar();
                });

                $('#nextMonth').on('click', function () {
                    currentMonth.setMonth(currentMonth.getMonth() + 1);
                    renderCalendar();
                });

                // Set default revenue date to today
                $(`${SELECTORS.REVENUE_FORM} input[name="date"]`).val(new Date().toISOString().split('T')[0]);

                // Patient modal close button handlers
                $('#patientModal .btn-close').on('click', function (e) {
                    handlePatientModalClose(e);
                });

                $('#cancelButton').on('click', function (e) {
                    handlePatientModalClose(e);
                });

                // Capture form data when modal is opened for new patient
                $('#patientModal').on('shown.bs.modal', function () {
                    // Small delay to ensure form is ready
                    setTimeout(() => {
                        capturePatientFormData();
                    }, 100);
                });

                // Appointment modal close button handlers
                $('#appointmentModal .btn-close').on('click', function (e) {
                    handleAppointmentModalClose(e);
                });

                $('#cancelAppointmentButton').on('click', function (e) {
                    handleAppointmentModalClose(e);
                });

                // Capture form data when appointment modal is opened
                $('#appointmentModal').on('shown.bs.modal', function () {
                    // Ensure options are rendered if not already
                    if (caseTypes.length > 0 && $('.form-check-container').first().children().length === 0) {
                        renderCaseTypeOptions();
                        renderCaseDetailsOptions();
                    }

                    // Small delay to ensure form is ready
                    setTimeout(() => {
                        captureAppointmentFormData();
                    }, 100);
                });

                // Note: "Other" pill functionality is now handled directly in renderCaseDetailsOptions()

                // Doctor modal close button handlers
                $('#doctorModal .btn-close').on('click', function (e) {
                    handleDoctorModalClose(e);
                });

                $('#cancelDoctorButton').on('click', function (e) {
                    handleDoctorModalClose(e);
                });

                // Capture form data when doctor modal is opened
                $('#doctorModal').on('shown.bs.modal', function () {
                    // Small delay to ensure form is ready
                    setTimeout(() => {
                        captureDoctorFormData();
                    }, 100);
                });
            }

            function updateCurrentDate() {
                const now = new Date();
                const options = {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                };
                $(SELECTORS.CURRENT_DATE).text(now.toLocaleDateString(CONFIG.DATE_FORMAT_TH, options));
                flatpickr('input[name="birthDate"]', {
                    locale: 'th',
                    dateFormat: 'Y-m-d',
                    altFormat: 'd F Y',
                    altInput: true,
                    maxDate: 'today',
                });
                flatpickr('input[name="appointmentDate"]', {
                    locale: 'th',
                    dateFormat: 'Y-m-d',
                    altFormat: 'd F Y',
                    altInput: true,
                    minDate: 'today'
                });
                flatpickr('input[name="appointmentTime"]', {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: 'H:i',
                    time_24hr: true,
                    defaultHour: 9,
                    defaultMinute: 0,
                    minuteIncrement: 15
                });
            }

            function checkLoginStatus() {
                // In a real app, check session storage or cookies
                const savedUser = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (savedUser) {
                    const userData = JSON.parse(savedUser);
                    if (new Date().getTime() > userData.expired) {
                        localStorage.removeItem(CONFIG.STORAGE_KEY);
                        showLoginPage();
                        return;
                    }
                    currentUser = userData.username;
                    currentUserType = userData.type;
                    console.log('Login until:', moment(userData.expired).format('LLLL'));
                    showMainApp();
                } else {
                    showLoginPage();
                }
            }

            function handleLogin(e) {
                e.preventDefault();
                const showLoginLoading = () => {
                    NProgress.start();
                    $(e.target).find('button[type="submit"]').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังเข้าสู่ระบบ...');
                }
                const hideLoginLoading = () => {
                    NProgress.done();
                    $(e.target).find('button[type="submit"]').prop('disabled', false).html('เข้าสู่ระบบ');
                }
                const loginForm = e.target;
                const formData = new FormData(loginForm);
                const username = $('#username').val().trim();
                const password = $('#password').val().trim();

                if (!username || !password) {
                    Toast.fire({
                        icon: 'warning',
                        title: 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน'
                    });
                    return;
                }
                showLoginLoading();
                // Call Google Apps Script backend
                google.script.run
                    .withSuccessHandler(function (result) {
                        hideLoginLoading();
                        if (result.success) {
                            currentUser = result.user.username;
                            currentUserType = result.user.userType;

                            // Save to localStorage
                            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
                                username: result.user.username,
                                type: result.user.userType,
                                fullName: result.user.fullName,
                                expired: new Date().getTime() + (8 * 60 * 60 * 1000) // 2 hours expiry
                            }));
                            console.log('Login until:', moment(new Date().getTime() + (8 * 60 * 60 * 1000)).format('LLLL'));

                            showMainApp();
                            Toast.fire({
                                icon: 'success',
                                title: UI_TEXT.MESSAGES.LOGIN_SUCCESS
                            });
                        } else {
                            Toast.fire({
                                icon: 'error',
                                title: result.message || UI_TEXT.MESSAGES.LOGIN_FAILED
                            });
                        }
                        NProgress.done();
                    })
                    .withFailureHandler(function (error) {
                        hideLoginLoading();
                        console.error('Login error:', error);
                        Toast.fire({
                            icon: 'error',
                            title: UI_TEXT.MESSAGES.LOGIN_ERROR
                        });
                        NProgress.done();
                    })
                [API_METHODS.AUTHENTICATE_USER](username, password);
            }

            function handleLogout() {
                event.preventDefault();
                Swal.fire({
                    title: UI_TEXT.MESSAGES.LOGOUT_CONFIRM,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: UI_TEXT.BUTTONS.LOGOUT,
                    cancelButtonText: UI_TEXT.BUTTONS.CANCEL,
                    customClass: {
                        confirmButton: 'btn btn-danger',
                        cancelButton: 'btn btn-secondary'
                    },
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.removeItem(CONFIG.STORAGE_KEY);
                        currentUser = null;
                        currentUserType = null;
                        showLoginPage();
                        Toast.fire({
                            icon: 'success',
                            title: UI_TEXT.MESSAGES.LOGOUT_SUCCESS
                        });
                    }
                });
            }

            function showLoginPage() {
                $(SELECTORS.LOGIN_PAGE).removeClass('hidden');
                $(SELECTORS.MAIN_APP).addClass('hidden');

                // hide loading page if still visible
                hideLoadingPage();
            }

            function showMainApp() {
                $(SELECTORS.LOGIN_PAGE).addClass('hidden');
                $(SELECTORS.MAIN_APP).removeClass('hidden');

                // Update user display
                $(SELECTORS.CURRENT_USER).text(currentUser);

                // Show/hide admin features
                const adminElements = document.querySelectorAll('.admin-only');
                adminElements.forEach(el => {
                    if (currentUserType === 'admin') {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                });

                // Load data and show dashboard
                loadData();
                showPage('dashboard');
            }

            function showPage(pageName) {
                // Hide all pages
                $('.page-content').addClass('hidden');

                // Update navigation
                $('.nav-link').removeClass('active');

                // Show selected page
                $('#' + pageName + 'Page').removeClass('hidden');
                $(`[data-page="${pageName}"]`).addClass('active');

                // Load page-specific data
                switch (pageName) {
                    case 'dashboard':
                        updateDashboard();
                        break;
                    case 'patients':
                        renderPatientsTable();
                        break;
                    case 'appointments':
                        renderCalendar();
                        renderTodayAppointments();
                        break;
                    case 'doctors':
                        loadDoctors();
                        break;
                    case 'revenue':
                        renderRevenueChart();
                        renderRevenueTable();
                        updateRevenueStats();
                        break;
                    case 'reports':
                        if (currentUserType === 'admin') {
                            renderReports();
                        }
                        break;
                }
            }

            function loadData() {
                NProgress.start();

                // Initialize loading counter
                window.loadingCounter = {
                    total: 5, // patients, appointments, revenues, doctors, options
                    completed: 0
                };

                // Load data from Google Apps Script backend
                loadPatients();
                loadAppointments();
                loadRevenues();
                loadDoctors();
                loadOptions();
            }

            function checkLoadingComplete() {
                window.loadingCounter.completed++;
                
                if (window.loadingCounter.completed >= window.loadingCounter.total) {
                    // All data loaded, hide loading page
                    setTimeout(() => {
                        hideLoadingPage();
                    }, 500); // Small delay to ensure smooth transition
                }
            }

            function hideLoadingPage() {
                const loadingPage = document.getElementById('loadingPage');
                if (loadingPage) {
                    loadingPage.classList.add('fade-out');
                    setTimeout(() => {
                        loadingPage.style.display = 'none';
                    }, 500); // Match the CSS transition duration
                }
                NProgress.done();
            }

            function loadPatients() {
                google.script.run
                    .withSuccessHandler(function (result) {
                        result = JSON.parse(result);
                        if (result.success) {
                            patients = result.patients || [];
                            renderPatientsTable();
                            updateDashboard();
                        } else {
                            console.error('Error loading patients:', result.message);
                            patients = [];
                        }
                        checkLoadingComplete();
                    })
                    .withFailureHandler(function (error) {
                        console.error('Failed to load patients:', error);
                        patients = [];
                        checkLoadingComplete();
                    })
                [API_METHODS.GET_ALL_PATIENTS]();
            }

            function loadAppointments() {
                google.script.run
                    .withSuccessHandler(function (result) {
                        result = JSON.parse(result);
                        console.log('Appointments loaded:', result);
                        if (result.success) {
                            appointments = result.appointments || [];
                            renderCalendar();
                            renderTodayAppointments();
                            updateDashboard();
                        } else {
                            console.error('Error loading appointments:', result.message);
                            appointments = [];
                        }
                        checkLoadingComplete();
                    })
                    .withFailureHandler(function (error) {
                        console.error('Failed to load appointments:', error);
                        appointments = [];
                        checkLoadingComplete();
                    })
                [API_METHODS.GET_ALL_APPOINTMENTS]();
            }

            function loadRevenues() {
                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result.success) {
                            revenues = result.revenues || [];
                            renderRevenueTable();
                            updateRevenueStats();
                            renderRevenueChart();
                            updateDashboard();
                        } else {
                            console.error('Error loading revenues:', result.message);
                            revenues = [];
                        }
                        checkLoadingComplete();
                    })
                    .withFailureHandler(function (error) {
                        console.error('Failed to load revenues:', error);
                        revenues = [];
                        checkLoadingComplete();
                    })
                [API_METHODS.GET_ALL_REVENUES]();
            }

            // Doctor management functions
            function loadDoctors() {
                google.script.run
                    .withSuccessHandler(function (result) {
                        result = JSON.parse(result);
                        if (result.success) {
                            doctors = result.doctors || [];
                            renderDoctorsTable();
                            updateDashboard();
                            loadDoctorsForAppointment();
                        } else {
                            Toast.fire({
                                icon: 'error',
                                title: result.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูลหมอ'
                            });
                            doctors = [];
                        }
                        checkLoadingComplete();
                    })
                    .withFailureHandler(function (error) {
                        console.error('Error loading doctors:', error);
                        Toast.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                        });
                        doctors = [];
                        checkLoadingComplete();
                    })
                    .getAllDoctors();
            }

            function loadOptions() {
                google.script.run
                    .withSuccessHandler(function (result) {
                        result = JSON.parse(result);
                        if (result.success) {
                            caseTypes = result.caseTypes || [];
                            caseDetails = result.caseDetails || [];
                            renderCaseTypeOptions();
                            renderCaseDetailsOptions();
                        } else {
                            console.error('Failed to load options:', result.message);
                            Toast.fire({
                                icon: 'error',
                                title: result.message || 'เกิดข้อผิดพลาดในการโหลดตัวเลือก'
                            });
                        }
                        checkLoadingComplete();
                    })
                    .withFailureHandler(function (error) {
                        console.error('Error loading options:', error);
                        Toast.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                        });
                        checkLoadingComplete();
                    })
                [API_METHODS.GET_ALL_OPTIONS]();
            }

            function renderCaseTypeOptions() {
                const $container = $('.form-check-container').first(); // Case type container

                if (caseTypes.length === 0) {
                    $container.html('<div class="text-muted">ไม่พบตัวเลือกประเภทเคส</div>');
                    return;
                }

                const html = caseTypes.map((option, index) => `
                    <span class="badge case-type-pill pill-option me-2 mb-2" 
                        data-value="${option.value}" 
                        data-name="caseType">
                        ${option.value}
                    </span>
                `).join('');

                // Add hidden inputs to store selected values
                const hiddenInputsHtml = '<div class="case-type-hidden-inputs"></div>';

                $container.html(html + hiddenInputsHtml);

                // Add click event handlers for pills
                $container.find('.case-type-pill').on('click', function() {
                    const $pill = $(this);
                    const value = $pill.data('value');
                    const isSelected = $pill.hasClass('selected');

                    if (isSelected) {
                        // Deselect
                        $pill.removeClass('selected');
                        // Remove hidden input
                        $container.find(`.case-type-hidden-inputs input[value="${value}"]`).remove();
                    } else {
                        // Select
                        $pill.addClass('selected');
                        // Add hidden input
                        $container.find('.case-type-hidden-inputs').append(
                            `<input type="hidden" name="caseType" value="${value}">`
                        );
                    }
                });
            }

            function renderCaseDetailsOptions() {
                const $container = $('.form-check-container').eq(1); // Case details container

                if (caseDetails.length === 0) {
                    $container.html('<div class="text-muted">ไม่พบตัวเลือกรายละเอียดเคส</div>');
                    return;
                }

                const html = caseDetails.map((option, index) => `
                    <span class="badge case-details-pill pill-option me-2 mb-2" 
                        data-value="${option.value}" 
                        data-name="caseDetails">
                        ${option.value}
                    </span>
                `).join('');

                // Add "Other" option as a pill
                const otherPillHtml = `
                    <span class="badge case-details-pill case-details-other pill-option me-2 mb-2" 
                        data-value="อื่นๆ" 
                        data-name="caseDetails">
                        อื่นๆ
                    </span>
                `;

                // Add text input for "Other" option
                const otherInputHtml = `
                    <div class="mt-2">
                        <input type="text" class="form-control case-details-other-input" name="caseDetailsOther" 
                            placeholder="ระบุรายละเอียดอื่นๆ" style="display: none;">
                    </div>
                `;

                // Add hidden inputs container
                const hiddenInputsHtml = '<div class="case-details-hidden-inputs"></div>';

                $container.html(html + otherPillHtml + otherInputHtml + hiddenInputsHtml);

                // Add click event handlers for pills
                $container.find('.case-details-pill').on('click', function() {
                    const $pill = $(this);
                    const value = $pill.data('value');
                    const isSelected = $pill.hasClass('selected');
                    const isOther = $pill.hasClass('case-details-other');

                    if (isSelected) {
                        // Deselect
                        $pill.removeClass('selected');
                        
                        if (isOther) {
                            // Hide and clear other input
                            $container.find('.case-details-other-input').hide().val('');
                        }
                        
                        // Remove hidden input
                        $container.find(`.case-details-hidden-inputs input[value="${value}"]`).remove();
                    } else {
                        // Select
                        $pill.addClass('selected');
                        
                        if (isOther) {
                            // Show other input
                            $container.find('.case-details-other-input').show().focus();
                        }
                        
                        // Add hidden input
                        $container.find('.case-details-hidden-inputs').append(
                            `<input type="hidden" name="caseDetails" value="${value}">`
                        );
                    }
                });

                // Handle "Other" text input changes
                $container.find('.case-details-other-input').on('input', function() {
                    const otherText = $(this).val().trim();
                    const $otherPill = $container.find('.case-details-other');
                    
                    if (otherText && $otherPill.hasClass('selected')) {
                        // Update hidden input with custom text
                        const $hiddenInput = $container.find('.case-details-hidden-inputs input[value="อื่นๆ"]');
                        if ($hiddenInput.length) {
                            $hiddenInput.val(`อื่นๆ: ${otherText}`);
                        }
                    }
                });
            }

            function renderDoctorsTable() {
                const $table = $('#doctorsTable tbody');

                if (doctors.length === 0) {
                    $table.html(`<tr><td colspan="6" class="text-center text-muted">${UI_TEXT.MESSAGES.NO_DOCTORS}</td></tr>`);
                    return;
                }

                const rows = doctors.map(doctor => `
                    <tr>
                        <td>${doctor.id}</td>
                        <td>${doctor.first_name} ${doctor.last_name}</td>
                        <td>${doctor.specialty}</td>
                        <td>${doctor.phone}</td>
                        <td>${doctor.email || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editDoctor('${doctor.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor('${doctor.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                $table.html(rows);
            }



            function updateDashboard() {
                // Update statistics
                $(SELECTORS.TOTAL_PATIENTS).text(patients.length);
                $(SELECTORS.TOTAL_DOCTORS).text(doctors.length);

                const today = moment().format('YYYY-MM-DD');
                const todayAppts = appointments.filter(apt => moment(apt.appointment_date).format('YYYY-MM-DD') === today);
                $(SELECTORS.TODAY_APPOINTMENTS).text(todayAppts.length);

                const todayRev = revenues.filter(rev => moment(rev.date).format('YYYY-MM-DD') === today)
                    .reduce((sum, rev) => sum + rev.amount, 0);
                $(SELECTORS.TODAY_REVENUE).text(todayRev.toLocaleString() + ` ${UI_TEXT.LABELS.BAHT}`);

                $(SELECTORS.TOTAL_NOTIFICATIONS).text(todayAppts.length);

                // Update recent activities
                renderWeeklyAppointments();
                loadPatientsForAppointment();
                loadDoctorsForAppointment();
                renderRecentPatients();
                updateNotifications();
            }

            function renderWeeklyAppointments() {
                const $container = $(SELECTORS.WEEKLY_APPOINTMENTS);
                const today = new Date();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());

                const weeklyAppts = appointments.filter(apt => {
                    const aptDate = new Date(apt.appointment_date);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    return aptDate >= weekStart && aptDate <= weekEnd;
                });

                if (weeklyAppts.length === 0) {
                    $container.html(`<p class="text-muted">${UI_TEXT.MESSAGES.NO_APPOINTMENTS_WEEK}</p>`);
                    return;
                }

                const html = weeklyAppts.map(apt => {
                    const patient = patients.find(p => p.id === apt.patient_id);
                    const doctor = doctors.find(d => d.id === apt.doctor_id);
                    const patientName = patient ? `${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}` : UI_TEXT.MESSAGES.PATIENT_NOT_FOUND;
                    const doctorName = doctor ? `${doctor.first_name} ${doctor.last_name}` : 'ไม่ระบุหมอ';
                    const aptDate = new Date(apt.appointment_date);
                    const dateStr = aptDate.toLocaleDateString(CONFIG.DATE_FORMAT_TH, {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short'
                    });

                    return `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <div class="fw-bold">${patientName}</div>
                                ${apt.case_type ? `<div class="small text-info"><strong>ประเภทเคส:</strong> ${apt.case_type}</div>` : ''}
                                ${apt.case_details ? `<div class="small text-success"><strong>รายละเอียดเคส:</strong> ${apt.case_details}</div>` : ''}
                                <div><small class="text-secondary">${doctorName}</small></div>
                            </div>
                            <div class="text-end">
                                <div class="small">${dateStr}</div>
                                <div class="small text-primary">${apt.appointment_time}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                $container.html(html);
            }

            function renderRecentPatients() {
                const $container = $(SELECTORS.RECENT_PATIENTS);
                const recentPatients = patients.slice(-5).reverse();

                if (recentPatients.length === 0) {
                    $container.html(`<p class="text-muted">${UI_TEXT.MESSAGES.NO_PATIENTS}</p>`);
                    return;
                }

                const html = recentPatients.map(patient => {
                    const regDate = new Date(patient.registration_date);
                    const dateStr = regDate.toLocaleDateString(CONFIG.DATE_FORMAT_TH);

                    return `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <div class="fw-bold">${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}</div>
                                <small class="text-muted">${patient.phone}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">${dateStr}</small>
                            </div>
                        </div>
                    `;
                }).join('');

                $container.html(html);
            }

            function renderPatientsTable() {
                const $tbody = $(`${SELECTORS.PATIENTS_TABLE} tbody`);

                // Initialize DataTable if not already initialized
                if ($.fn.DataTable.isDataTable(SELECTORS.PATIENTS_TABLE)) {
                    $(SELECTORS.PATIENTS_TABLE).DataTable().destroy()
                }

                if (patients.length === 0) {
                    $tbody.html(`<tr><td colspan="6" class="text-center text-muted">${UI_TEXT.MESSAGES.NO_PATIENT_DATA}</td></tr>`);
                    return;
                }



                const html = patients.map(patient => {
                    const birthDate = new Date(patient.birth_date);
                    const age = new Date().getFullYear() - birthDate.getFullYear();
                    const regDate = new Date(patient.registration_date).toLocaleDateString(CONFIG.DATE_FORMAT_TH);

                    return `
                        <tr>
                            <td>${patient.id}</td>
                            <td>${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}</td>
                            <td>${patient.phone}</td>
                            <td>${age} ${UI_TEXT.LABELS.YEARS_OLD}</td>
                            <td>${regDate}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editPatient('${patient.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deletePatient('${patient.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                $tbody.html(html);
                $(SELECTORS.PATIENTS_TABLE).DataTable({
                    language: {
                        url: CONFIG.DATATABLES_LANG_URL
                    },
                    responsive: true,
                    order: [0, 'desc'],
                    columnDefs: [
                        { orderable: false, targets: 5 },
                        { className: 'dt-head-center dt-head-nowrap dt-body-center dt-body-nowrap text-center', targets: '_all' }
                    ]
                });
            }

            function handlePatientSubmit(e) {
                e.preventDefault();
                const showPatientLoading = () => {
                    NProgress.start();
                    Swal.fire({
                        iconHtml: '<i class="bi-hourglass-split text-primary"></i>',
                        title: 'กำลังบันทึกข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        customClass: {
                            popup: ' rounded-4',
                            icon: 'border-0'
                        }
                    });
                }
                const hidePatientLoading = () => {
                    NProgress.done();
                    Swal.close();
                }
                const formData = new FormData(e.target);

                const patientData = {
                    titlePrefix: formData.get('titlePrefix'),
                    firstName: formData.get('firstName'),
                    lastName: formData.get('lastName'),
                    phone: formData.get('phone'),
                    birthDate: formData.get('birthDate'),
                    address: formData.get('address'),
                    allergies: formData.get('allergies'),
                    medicalHistory: formData.get('medicalHistory'),
                    notes: formData.get('notes')
                };

                const patientId = e.target.dataset.patientId;

                // Show confirmation dialog with patient details
                const patientName = `${patientData.titlePrefix} ${patientData.firstName} ${patientData.lastName}`.trim();
                const confirmAction = patientId ? 'อัปเดต' : 'เพิ่ม';
                const confirmTitle = patientId ? 'ยืนยันการอัปเดตข้อมูลผู้ป่วย' : 'ยืนยันการเพิ่มผู้ป่วยใหม่';
                
                const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>ชื่อ-นามสกุล:</strong> ${patientName}<br>
                        <strong>เบอร์โทร:</strong> ${patientData.phone || '-'}<br>
                        <strong>วันเกิด:</strong> ${patientData.birthDate || '-'}<br>
                        <strong>ที่อยู่:</strong> ${patientData.address || '-'}<br>
                        ${patientData.allergies ? `<strong>ภูมิแพ้:</strong> ${patientData.allergies}<br>` : ''}
                        ${patientData.medicalHistory ? `<strong>ประวัติการรักษา:</strong> ${patientData.medicalHistory}<br>` : ''}
                        ${patientData.notes ? `<strong>หมายเหตุ:</strong> ${patientData.notes}<br>` : ''}
                    </div>
                `;

                Swal.fire({
                    title: confirmTitle,
                    html: `ต้องการ${confirmAction}ข้อมูลผู้ป่วยนี้หรือไม่?${detailsHtml}`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: `ยืนยัน${confirmAction}`,
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#198754',
                    cancelButtonColor: '#6c757d',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Proceed with saving
                        proceedWithPatientSubmit();
                    }
                });

                function proceedWithPatientSubmit() {
                showPatientLoading();
                if (patientId) {
                    // Update existing patient
                    google.script.run
                        .withSuccessHandler(function (result) {
                            hidePatientLoading();
                            if (result.success) {
                                loadPatients();
                                closePatientModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            hidePatientLoading();
                            console.error('Error updating patient:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.UPDATE_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.UPDATE_PATIENT](patientId, patientData);
                } else {
                    // Add new patient
                    patientData.registrationDate = new Date().toISOString().split('T')[0];

                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                loadPatients();
                                closePatientModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error adding patient:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.ADD_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.ADD_PATIENT](patientData);
                }
                }
            }

            function closePatientModal(form) {
                const modal = bootstrap.Modal.getInstance($(SELECTORS.PATIENT_MODAL)[0]);
                modal.hide();
                form.reset();
                delete form.dataset.patientId;
                // Reset form tracking
                originalPatientFormData = {};
                isPatientFormDirty = false;
            }

            // Function to capture initial form data
            function capturePatientFormData() {
                const form = $(SELECTORS.PATIENT_FORM)[0];
                const formData = new FormData(form);
                originalPatientFormData = {};

                for (let [key, value] of formData.entries()) {
                    originalPatientFormData[key] = value;
                }

                // Also capture empty fields
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (!originalPatientFormData.hasOwnProperty(input.name)) {
                        originalPatientFormData[input.name] = input.value || '';
                    }
                });

                isPatientFormDirty = false;
            }

            // Function to check if form data has changed
            function isPatientFormChanged() {
                const form = $(SELECTORS.PATIENT_FORM)[0];
                const currentFormData = new FormData(form);

                // Check all current form fields
                for (let [key, value] of currentFormData.entries()) {
                    if (originalPatientFormData[key] !== value) {
                        return true;
                    }
                }

                // Check for empty fields that might have had values initially
                const inputs = form.querySelectorAll('input, textarea, select');
                for (let input of inputs) {
                    const currentValue = input.value || '';
                    const originalValue = originalPatientFormData[input.name] || '';
                    if (currentValue !== originalValue) {
                        return true;
                    }
                }

                return false;
            }

            // Function to handle modal close with unsaved changes warning
            function handlePatientModalClose(event) {
                if (isPatientFormChanged()) {
                    event.preventDefault();
                    event.stopPropagation();

                    Swal.fire({
                        title: 'มีการเปลี่ยนแปลงข้อมูล',
                        text: 'คุณมีการเปลี่ยนแปลงข้อมูลที่ยังไม่ได้บันทึก ต้องการออกจากหน้านี้หรือไม่?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'ออกจากหน้านี้',
                        cancelButtonText: 'ยกเลิก',
                        confirmButtonColor: '#a92246',
                        customClass: {
                            popup: 'rounded-4'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const form = $(SELECTORS.PATIENT_FORM)[0];
                            closePatientModal(form);
                        }
                    });

                    return false;
                }

                // If no changes, proceed with normal close
                const form = $(SELECTORS.PATIENT_FORM)[0];
                closePatientModal(form);
                return true;
            }

            function editPatient(patientId) {
                const patient = patients.find(p => p.id === patientId);
                if (!patient) return;

                const form = $(SELECTORS.PATIENT_FORM)[0];
                form.dataset.patientId = patientId;

                // Populate form
                form.querySelector('[name="titlePrefix"]').value = patient.title_prefix || '';
                form.querySelector('[name="firstName"]').value = patient.first_name;
                form.querySelector('[name="lastName"]').value = patient.last_name;
                form.querySelector('[name="phone"]').value = patient.phone;
                form.querySelector('[name="address"]').value = patient.address || '';
                form.querySelector('[name="allergies"]').value = patient.allergies || '';
                form.querySelector('[name="medicalHistory"]').value = patient.medical_history || '';
                form.querySelector('[name="notes"]').value = patient.notes || '';
                form.querySelector('[name="birthDate"]')._flatpickr.setDate(patient.birth_date, true);
                // Show modal
                const modal = new bootstrap.Modal($(SELECTORS.PATIENT_MODAL)[0]);
                modal.show();

                // Capture initial form data after modal is shown and form is populated
                setTimeout(() => {
                    capturePatientFormData();
                }, 100);
            }

            function deletePatient(patientId) {
                // Find patient details
                const patient = patients.find(p => p.id === patientId);
                const patientName = patient ? `${patient.title_prefix || ''} ${patient.first_name} ${patient.last_name}`.trim() : 'ไม่ทราบชื่อ';
                
                const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>ชื่อ-นามสกุล:</strong> ${patientName}<br>
                        <strong>เบอร์โทร:</strong> ${patient?.phone || '-'}<br>
                        <strong>วันเกิด:</strong> ${patient?.birth_date || '-'}<br>
                        ${patient?.allergies ? `<strong>ภูมิแพ้:</strong> ${patient.allergies}<br>` : ''}
                    </div>
                    <div style="color: #dc3545; font-weight: bold; margin-top: 15px;">
                        ⚠️ การลบข้อมูลนี้ไม่สามารถกู้คืนได้!
                    </div>
                `;

                Swal.fire({
                    title: 'ยืนยันการลบข้อมูลผู้ป่วย',
                    html: `ต้องการลบข้อมูลผู้ป่วยนี้หรือไม่?${detailsHtml}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ยืนยันลบ',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        NProgress.start();
                        Swal.fire({
                            iconHtml: '<i class="bi-hourglass-split text-danger"></i>',
                            title: 'กำลังลบข้อมูล...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            },
                            customClass: {
                                popup: 'rounded-4',
                                icon: 'border-0'
                            }
                        });
                        google.script.run
                            .withSuccessHandler(function (result) {
                                if (result.success) {
                                    loadPatients();
                                    Toast.fire({
                                        icon: 'success',
                                        title: result.message
                                    });
                                } else {
                                    Toast.fire({
                                        icon: 'error',
                                        title: result.message
                                    });
                                }
                                NProgress.done();
                            })
                            .withFailureHandler(function (error) {
                                console.error('Error deleting patient:', error);
                                Toast.fire({
                                    icon: 'error',
                                    title: UI_TEXT.MESSAGES.DELETE_ERROR
                                });
                                NProgress.done();
                            })
                        [API_METHODS.DELETE_PATIENT](patientId);
                    }
                });
            }

            function renderCalendar() {
                let $calendar = $(SELECTORS.CALENDAR);
                let $monthYear = $(SELECTORS.CURRENT_MONTH);

                let year = currentMonth.getFullYear();
                let month = currentMonth.getMonth();

                $monthYear.text(currentMonth.toLocaleDateString(CONFIG.DATE_FORMAT_TH, {
                    year: 'numeric',
                    month: 'long'
                }));

                let firstDay = new Date(year, month, 1);
                let startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                let selectedDate = $('#selectedDate').data('date') ? new Date($('#selectedDate').data('date')) : new Date();
                console.log("🚀 ~ renderCalendar ~ selectedDate:", selectedDate)
                let today = new Date();
                let todayStr = today.toDateString();

                // Pre-group appointments by date for O(1) lookup
                let appointmentsByDate = {};
                appointments.forEach(apt => {
                    let dateStr = moment(apt.appointment_date).format('YYYY-MM-DD');
                    if (!appointmentsByDate[dateStr]) {
                        appointmentsByDate[dateStr] = [];
                    }
                    appointmentsByDate[dateStr].push(apt);
                });

                // Build HTML string array for better performance
                let htmlParts = ['<div class="calendar-grid">'];

                // Days of week header
                UI_TEXT.DAYS.forEach(day => {
                    htmlParts.push(`<div class="calendar-cell text-center fw-bold bg-light">${day}</div>`);
                });

                // Pre-calculate base date to avoid repeated date calculations
                let baseDate = new Date(startDate);

                // Calendar days
                for (let i = 0; i < CONFIG.CALENDAR_DAYS; i++) {
                    let date = new Date(baseDate.getTime() + (i * 24 * 60 * 60 * 1000));

                    let isCurrentMonth = date.getMonth() === month;
                    let isToday = date.toDateString() === todayStr;
                    let dateStr = moment(date).format('YYYY-MM-DD');
                    let isSelected = selectedDate && moment(selectedDate).format('YYYY-MM-DD') === dateStr;

                    // O(1) lookup instead of filter operation
                    let dayAppointments = appointmentsByDate[dateStr] || [];

                    // Build CSS classes efficiently
                    let cssClasses = ['calendar-cell'];
                    if (!isCurrentMonth) cssClasses.push('other-month');
                    if (isToday) cssClasses.push('today');
                    if (isSelected) cssClasses.push('selected');

                    htmlParts.push(`<div class="${cssClasses.join(' ')}" data-date="${dateStr}">
                        <div>${date.getDate()}</div>`);

                    if (dayAppointments.length > 0) {
                        // Group appointments by status and create status-based dots
                        let statusGroups = groupAppointmentsByStatus(dayAppointments);
                        htmlParts.push('<div class="appointment-dots">');

                        // Show dots for each status type
                        Object.keys(statusGroups).forEach(status => {
                            let count = statusGroups[status].length;
                            if (count > 0) {
                                htmlParts.push(`<div class="appointment-dot ${status}" title="${getStatusText(status)}: ${count} นัด"></div>`);
                            }
                        });

                        htmlParts.push('</div>');
                        htmlParts.push(`<small class="text-primary">${dayAppointments.length} นัด</small>`);
                    }

                    htmlParts.push('</div>');
                }

                htmlParts.push('</div>');

                // Single DOM update
                $calendar.html(htmlParts.join(''));

                // Use event delegation for better performance
                $calendar.off('click.calendar').on('click.calendar', '.calendar-cell', function () {
                    let date = $(this).data('date');
                    $('#selectedDate').data('date', date);
                    if (date) {
                        // Re-render calendar to show selected state
                        renderCalendar();
                        // Render appointments for selected date
                        renderTodayAppointments(new Date(date));
                    }
                });
            }

            function renderTodayAppointments() {
                const $container = $(SELECTORS.TODAY_APPOINTMENTS_LIST);
                let selectedDate = $('#selectedDate').data('date') ? new Date($('#selectedDate').data('date')) : null;
                console.log("🚀 ~ renderTodayAppointments ~ selectedDate:", selectedDate)
                if (!selectedDate) selectedDate = new Date();
                const today = moment(selectedDate).format('YYYY-MM-DD');
                $('#selectedDate').text(new Date(today).toLocaleDateString(CONFIG.DATE_FORMAT_TH, {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                }));

                const todayAppts = appointments.filter(apt => moment(apt.appointment_date).format('YYYY-MM-DD') === today);

                if (todayAppts.length === 0) {
                    $container.html(`<li class="list-group-item text-center text-muted">${UI_TEXT.MESSAGES.NO_APPOINTMENTS_TODAY}</li>`);
                    return;
                }

                // Pre-group patients and doctors for O(1) lookup
                const patientLookup = patients.reduce((acc, patient) => {
                    acc[patient.id] = `${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}`;
                    return acc;
                }, {});

                const doctorLookup = doctors.reduce((acc, doctor) => {
                    acc[doctor.id] = `${doctor.first_name} ${doctor.last_name}`;
                    return acc;
                }, {});
                console.log("🚀 ~ renderTodayAppointments ~ patientLookup:", patientLookup)

                // Build HTML array for single DOM update
                const htmlParts = todayAppts.map(apt => {
                    const patientName = patientLookup[apt.patient_id] || UI_TEXT.MESSAGES.PATIENT_NOT_FOUND;
                    const doctorName = doctorLookup[apt.doctor_id] || 'ไม่ระบุหมอ';
                    const status = apt.status || 'scheduled';
                    const statusIcon = getStatusIcon(status);
                    const statusText = getStatusText(status);
                    console.log("🚀 ~ renderTodayAppointments ~ patientLookup:", patientLookup)

                    return `<li class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 btn text-start" onclick="editAppointment('${apt.id}')">
                            <div class="d-flex align-items-center">
                                <div class="appointment-status-icon ${status}" title="${statusText}">
                                    <i class="${statusIcon}"></i>
                                </div>
                                <div class="fw-bold">${patientName}</div>
                            </div>
                            ${apt.case_type ? `<div class="small text-info"><strong>ประเภทเคส:</strong> ${apt.case_type}</div>` : ''}
                            ${apt.case_details ? `<div class="small text-success"><strong>รายละเอียดเคส:</strong> ${apt.case_details}</div>` : ''}
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-secondary">${doctorName}</small>
                                <div class="small text-primary fw-semibold">${apt.appointment_time}</div>
                                <small class="badge ${status}">${statusText}</small>
                            </div>
                        </div>
                        <i class="fas fa-edit text-secondary" style="cursor: pointer;" onclick="editAppointment('${apt.id}')"></i>
                    </li>`;
                });

                $container.html(htmlParts.join(''));
            }

            function loadPatientsForAppointment() {
                const $select = $(`${SELECTORS.APPOINTMENT_FORM} select[name="patientId"]`);
                const options = patients.map(patient =>
                    `<option value="${patient.id}">${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}</option>`
                ).join('');

                $select.html(`<option value="">${UI_TEXT.LABELS.SELECT_PATIENT}</option>` + options);
            }



            function renderDoctorsTable() {
                const $tbody = $('#doctorsTable tbody');

                // Initialize DataTable if not already initialized
                if ($.fn.DataTable.isDataTable('#doctorsTable')) {
                    $('#doctorsTable').DataTable().destroy()
                }

                if (doctors.length === 0) {
                    $tbody.html(`<tr><td colspan="6" class="text-center text-muted">${UI_TEXT.MESSAGES.NO_DOCTOR_DATA}</td></tr>`);
                    return;
                }

                const html = doctors.map(doctor => {
                    return `
                        <tr>
                            <td>${doctor.id}</td>
                            <td>${doctor.first_name} ${doctor.last_name}</td>
                            <td>${doctor.specialty}</td>
                            <td>${doctor.phone}</td>
                            <td>${doctor.email || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editDoctor('${doctor.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor('${doctor.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                $tbody.html(html);
                $('#doctorsTable').DataTable({
                    language: {
                        url: CONFIG.DATATABLES_LANG_URL
                    },
                    responsive: true,
                    order: [0, 'desc'],
                    columnDefs: [
                        { orderable: false, targets: 5 },
                        { className: 'dt-head-center dt-head-nowrap dt-body-center dt-body-nowrap text-center', targets: '_all' }
                    ]
                });

            }

            function loadDoctorsForAppointment() {
                const $select = $(`${SELECTORS.APPOINTMENT_FORM} select[name="doctorId"]`);
                const options = doctors.map(doctor =>
                    `<option value="${doctor.id}">${doctor.first_name} ${doctor.last_name}</option>`
                ).join('');

                $select.html(`<option value="">${UI_TEXT.LABELS.SELECT_DOCTOR}</option>` + options);
            }

            function handleDoctorSubmit(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const showDoctorLoading = () => {
                    NProgress.start();
                    Swal.fire({
                        iconHtml: '<i class="bi-hourglass-split text-primary"></i>',
                        title: 'กำลังบันทึกข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        customClass: {
                            popup: ' rounded-4',
                            icon: 'border-0'
                        }
                    });
                }
                const hideDoctorLoading = () => {
                    NProgress.done();
                    Swal.close();
                }
                const doctorData = {
                    firstName: formData.get('firstName'),
                    lastName: formData.get('lastName'),
                    specialty: formData.get('specialty'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    licenseNumber: formData.get('licenseNumber'),
                    notes: formData.get('notes')
                };

                // Show confirmation dialog with doctor details
                const doctorName = `${doctorData.firstName} ${doctorData.lastName}`.trim();
                const isEdit = e.target.dataset.doctorId;
                const confirmAction = isEdit ? 'อัปเดต' : 'เพิ่ม';
                const confirmTitle = isEdit ? 'ยืนยันการอัปเดตข้อมูลหมอ' : 'ยืนยันการเพิ่มหมอใหม่';
                
                const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>ชื่อ-นามสกุล:</strong> ${doctorName}<br>
                        <strong>ความเชี่ยวชาญ:</strong> ${doctorData.specialty || '-'}<br>
                        <strong>เบอร์โทร:</strong> ${doctorData.phone || '-'}<br>
                        <strong>อีเมล:</strong> ${doctorData.email || '-'}<br>
                        <strong>เลขใบประกอบวิชาชีพ:</strong> ${doctorData.licenseNumber || '-'}<br>
                        ${doctorData.notes ? `<strong>หมายเหตุ:</strong> ${doctorData.notes}<br>` : ''}
                    </div>
                `;

                Swal.fire({
                    title: confirmTitle,
                    html: `ต้องการ${confirmAction}ข้อมูลหมอนี้หรือไม่?${detailsHtml}`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: `ยืนยัน${confirmAction}`,
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#198754',
                    cancelButtonColor: '#6c757d',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Proceed with saving
                        proceedWithDoctorSubmit();
                    }
                });

                function proceedWithDoctorSubmit() {
                    showDoctorLoading();

                if (e.target.dataset.doctorId) {
                    // Edit existing doctor
                    const doctorId = e.target.dataset.doctorId;

                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                hideDoctorLoading();
                                loadDoctors();
                                closeDoctorModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: 'อัปเดตข้อมูลหมอสำเร็จ'
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message || 'เกิดข้อผิดพลาดในการอัปเดต'
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            hideDoctorLoading();
                            console.error('Error updating doctor:', error);
                            Toast.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                            });
                            NProgress.done();
                        })
                        .updateDoctor(doctorId, doctorData);
                } else {
                    // Add new doctor
                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                loadDoctors();
                                closeDoctorModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: 'เพิ่มหมอใหม่สำเร็จ'
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message || 'เกิดข้อผิดพลาดในการเพิ่มข้อมูล'
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error adding doctor:', error);
                            Toast.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                            });
                            NProgress.done();
                        })
                        .addDoctor(doctorData);
                }
                }
            }

            function editDoctor(doctorId) {
                console.log("🚀 ~ editDoctor ~ doctors:", doctors)
                console.log("🚀 ~ editDoctor ~ doctorId:", doctorId)
                const doctor = doctors.find(d => d.id === doctorId);
                console.log("🚀 ~ editDoctor ~ doctor:", doctor)
                if (!doctor) return;

                const form = $('#doctorForm')[0];
                form.dataset.doctorId = doctorId;

                // Populate form
                form.querySelector('[name="firstName"]').value = doctor.first_name;
                form.querySelector('[name="lastName"]').value = doctor.last_name;
                form.querySelector('[name="specialty"]').value = doctor.specialty;
                form.querySelector('[name="phone"]').value = doctor.phone;
                form.querySelector('[name="email"]').value = doctor.email || '';
                form.querySelector('[name="licenseNumber"]').value = doctor.license_number || '';
                form.querySelector('[name="notes"]').value = doctor.notes || '';

                // Show modal
                const modal = new bootstrap.Modal($('#doctorModal')[0]);
                modal.show();
            }

            function deleteDoctor(doctorId) {
                // Find doctor details
                const doctor = doctors.find(d => d.id === doctorId);
                const doctorName = doctor ? `${doctor.first_name} ${doctor.last_name}`.trim() : 'ไม่ทราบชื่อ';
                
                const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>ชื่อ-นามสกุล:</strong> ${doctorName}<br>
                        <strong>ความเชี่ยวชาญ:</strong> ${doctor?.specialty || '-'}<br>
                        <strong>เบอร์โทร:</strong> ${doctor?.phone || '-'}<br>
                        <strong>อีเมล:</strong> ${doctor?.email || '-'}<br>
                        <strong>เลขใบประกอบวิชาชีพ:</strong> ${doctor?.license_number || '-'}<br>
                    </div>
                    <div style="color: #dc3545; font-weight: bold; margin-top: 15px;">
                        ⚠️ การลบข้อมูลนี้ไม่สามารถกู้คืนได้!
                    </div>
                `;

                Swal.fire({
                    title: 'ยืนยันการลบข้อมูลหมอ',
                    html: `ต้องการลบข้อมูลหมอนี้หรือไม่?${detailsHtml}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ยืนยันลบ',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        NProgress.start();
                        Swal.fire({
                            iconHtml: '<i class="bi-hourglass-split text-danger"></i>',
                            title: 'กำลังลบข้อมูล...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            },
                            customClass: {
                                popup: 'rounded-4',
                                icon: 'border-0'
                            }
                        });
                        google.script.run
                            .withSuccessHandler(function (result) {
                                Swal.close();
                                if (result.success) {
                                    loadDoctors();
                                    Toast.fire({
                                        icon: 'success',
                                        title: 'ลบข้อมูลหมอสำเร็จ'
                                    });
                                } else {
                                    Toast.fire({
                                        icon: 'error',
                                        title: result.message || 'เกิดข้อผิดพลาดในการลบข้อมูล'
                                    });
                                }
                                NProgress.done();
                            })
                            .withFailureHandler(function (error) {
                                Swal.close();
                                console.error('Error deleting doctor:', error);
                                Toast.fire({
                                    icon: 'error',
                                    title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                                });
                                NProgress.done();
                            })
                            .deleteDoctor(doctorId);
                    }
                });
            }

            function closeDoctorModal(form) {
                const modal = bootstrap.Modal.getInstance($('#doctorModal')[0]);
                modal.hide();
                form.reset();
                delete form.dataset.doctorId;
            }

            // Appointment form tracking functions
            function captureAppointmentFormData() {
                const form = $(SELECTORS.APPOINTMENT_FORM)[0];
                const formData = new FormData(form);
                originalAppointmentFormData = {};

                for (let [key, value] of formData.entries()) {
                    // Handle multiple values for the same key (checkboxes)
                    if (originalAppointmentFormData.hasOwnProperty(key)) {
                        // Convert to array if not already
                        if (!Array.isArray(originalAppointmentFormData[key])) {
                            originalAppointmentFormData[key] = [originalAppointmentFormData[key]];
                        }
                        originalAppointmentFormData[key].push(value);
                    } else {
                        originalAppointmentFormData[key] = value;
                    }
                }

                // Also capture empty fields and checkbox states
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        const checkboxes = form.querySelectorAll(`input[name="${input.name}"]`);
                        if (checkboxes.length > 1) {
                            // Multiple checkboxes with same name
                            const checkedValues = Array.from(checkboxes)
                                .filter(cb => cb.checked)
                                .map(cb => cb.value)
                                .join(',');
                            originalAppointmentFormData[input.name] = checkedValues;
                        } else {
                            // Single checkbox
                            originalAppointmentFormData[input.name] = input.checked ? input.value : '';
                        }
                    } else if (!originalAppointmentFormData.hasOwnProperty(input.name)) {
                        originalAppointmentFormData[input.name] = input.value || '';
                    }
                });

                isAppointmentFormDirty = false;

            }

            // Doctor form tracking functions
            function captureDoctorFormData() {
                const form = $(SELECTORS.DOCTOR_FORM)[0];
                const formData = new FormData(form);
                originalDoctorFormData = {};

                for (let [key, value] of formData.entries()) {
                    originalDoctorFormData[key] = value;
                }

                // Also capture empty fields
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (!originalDoctorFormData.hasOwnProperty(input.name)) {
                        originalDoctorFormData[input.name] = input.value || '';
                    }
                });

                isDoctorFormDirty = false;
            }

            // Function to check if doctor form data has changed
            function isDoctorFormChanged() {
                const form = $(SELECTORS.DOCTOR_FORM)[0];
                const currentFormData = new FormData(form);

                // Check all current form fields
                for (let [key, value] of currentFormData.entries()) {
                    const originalValue = originalDoctorFormData[key] || '';
                    if (value !== originalValue) {
                        return true;
                    }
                }

                // Check if any original fields are now missing
                for (let key in originalDoctorFormData) {
                    const input = form.querySelector(`[name="${key}"]`);
                    const currentValue = input ? input.value || '' : '';
                    const originalValue = originalDoctorFormData[key] || '';
                    if (currentValue !== originalValue) {
                        return true;
                    }
                }

                return false;
            }

            // Function to handle doctor modal close with unsaved changes warning
            function handleDoctorModalClose(event) {
                if (isDoctorFormChanged()) {
                    event.preventDefault();
                    event.stopPropagation();

                    Swal.fire({
                        title: 'มีการเปลี่ยนแปลงข้อมูล',
                        text: 'คุณมีการเปลี่ยนแปลงข้อมูลหมอที่ยังไม่ได้บันทึก ต้องการออกจากหน้านี้หรือไม่?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'ออกจากหน้านี้',
                        cancelButtonText: 'ยกเลิก',
                        confirmButtonColor: '#a92246',
                        customClass: {
                            popup: 'rounded-4'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const form = $(SELECTORS.DOCTOR_FORM)[0];
                            closeDoctorModal(form);
                        }
                    });

                    return false;
                }

                // If no changes, proceed with normal close
                const form = $(SELECTORS.DOCTOR_FORM)[0];
                closeDoctorModal(form);
                return true;
            }

            // Function to check if appointment form data has changed
            function isAppointmentFormChanged() {
                const form = $(SELECTORS.APPOINTMENT_FORM)[0];

                const formData = new FormData(form);
                let currentAppointmentFormData = {};

                for (let [key, value] of formData.entries()) {
                    // Handle multiple values for the same key (checkboxes)
                    if (currentAppointmentFormData.hasOwnProperty(key)) {
                        // Convert to array if not already
                        if (!Array.isArray(currentAppointmentFormData[key])) {
                            currentAppointmentFormData[key] = [currentAppointmentFormData[key]];
                        }
                        currentAppointmentFormData[key].push(value);
                    } else {
                        currentAppointmentFormData[key] = value;
                    }
                }

                // Also capture empty fields and checkbox states
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        const checkboxes = form.querySelectorAll(`input[name="${input.name}"]`);
                        if (checkboxes.length > 1) {
                            // Multiple checkboxes with same name
                            const checkedValues = Array.from(checkboxes)
                                .filter(cb => cb.checked)
                                .map(cb => cb.value)
                                .join(',');
                            currentAppointmentFormData[input.name] = checkedValues;
                        } else {
                            // Single checkbox
                            currentAppointmentFormData[input.name] = input.checked ? input.value : '';
                        }
                    } else if (!currentAppointmentFormData.hasOwnProperty(input.name)) {
                        currentAppointmentFormData[input.name] = input.value || '';
                    }
                });
                return JSON.stringify(currentAppointmentFormData) !== JSON.stringify(originalAppointmentFormData);
            }

            // Function to handle appointment modal close with unsaved changes warning
            function handleAppointmentModalClose(event) {
                if (isAppointmentFormChanged()) {
                    event.preventDefault();
                    event.stopPropagation();

                    Swal.fire({
                        title: 'มีการเปลี่ยนแปลงข้อมูล',
                        text: 'คุณมีการเปลี่ยนแปลงข้อมูลการนัดหมายที่ยังไม่ได้บันทึก ต้องการออกจากหน้านี้หรือไม่?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'ออกจากหน้านี้',
                        cancelButtonText: 'ยกเลิก',
                        confirmButtonColor: '#a92246',
                        customClass: {
                            popup: 'rounded-4'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const form = $(SELECTORS.APPOINTMENT_FORM)[0];
                            closeAppointmentModal(form);
                        }
                    });

                    return false;
                }

                // If no changes, proceed with normal close
                const form = $(SELECTORS.APPOINTMENT_FORM)[0];
                closeAppointmentModal(form);
                return true;
            }

            function handleAppointmentSubmit(e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                // Get selected case types from hidden inputs
                const caseTypes = [];
                const caseTypeInputs = e.target.querySelectorAll('input[name="caseType"][type="hidden"]');
                caseTypeInputs.forEach(input => caseTypes.push(input.value));

                // Validate that at least one case type is selected
                if (caseTypes.length === 0) {
                    Toast.fire({
                        icon: 'error',
                        title: 'กรุณาเลือกประเภทเคสอย่างน้อย 1 รายการ'
                    });
                    return;
                }

                // Get selected case details from hidden inputs
                const caseDetails = [];
                const caseDetailsInputs = e.target.querySelectorAll('input[name="caseDetails"][type="hidden"]');
                caseDetailsInputs.forEach(input => caseDetails.push(input.value));

                // The "Other" text is already handled in the hidden input value by the pill click handler
                // No additional processing needed here since the pill system already handles "อื่นๆ: text" format

                const appointmentData = {
                    patientId: formData.get('patientId'),
                    doctorId: formData.get('doctorId'),
                    appointmentDate: formData.get('appointmentDate'),
                    appointmentTime: formData.get('appointmentTime'),
                    caseType: caseTypes.join(', '),
                    caseDetails: caseDetails.join(', '),
                    cost: parseFloat(formData.get('cost')) || 0,
                    notes: formData.get('notes'),
                    status: formData.get('status')
                };

                const showAppointmentLoading = () => {
                    NProgress.start();
                    Swal.fire({
                        iconHtml: '<i class="bi-hourglass-split text-primary"></i>',
                        title: 'กำลังบันทึกข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        customClass: {
                            popup: ' rounded-4',
                            icon: 'border-0'
                        }
                    });
                }
                const hideAppointmentLoading = () => {
                    NProgress.done();
                    Swal.close();
                }

                const appointmentId = e.target.dataset.appointmentId;

                // Get patient and doctor names for display
                const selectedPatient = patients.find(p => p.id == appointmentData.patientId);
                const selectedDoctor = doctors.find(d => d.id == appointmentData.doctorId);
                const patientName = selectedPatient ? `${selectedPatient.title_prefix || ''} ${selectedPatient.first_name} ${selectedPatient.last_name}`.trim() : 'ไม่ระบุ';
                const doctorName = selectedDoctor ? `${selectedDoctor.first_name} ${selectedDoctor.last_name}`.trim() : 'ไม่ระบุ';

                // Show confirmation dialog with appointment details
                const isEdit = appointmentId;
                const confirmAction = isEdit ? 'อัปเดต' : 'เพิ่ม';
                const confirmTitle = isEdit ? 'ยืนยันการอัปเดตการนัดหมาย' : 'ยืนยันการเพิ่มการนัดหมายใหม่';
                
                const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>ผู้ป่วย:</strong> ${patientName}<br>
                        <strong>หมอ:</strong> ${doctorName}<br>
                        <strong>วันที่นัด:</strong> ${appointmentData.appointmentDate || '-'}<br>
                        <strong>เวลา:</strong> ${appointmentData.appointmentTime || '-'}<br>
                        <strong>ประเภทเคส:</strong> ${appointmentData.caseType || '-'}<br>
                        <strong>รายละเอียดเคส:</strong> ${appointmentData.caseDetails || '-'}<br>
                        <strong>ค่าใช้จ่าย:</strong> ${appointmentData.cost ? appointmentData.cost.toLocaleString() + ' บาท' : '0 บาท'}<br>
                        <strong>สถานะ:</strong> ${appointmentData.status || '-'}<br>
                        ${appointmentData.notes ? `<strong>หมายเหตุ:</strong> ${appointmentData.notes}<br>` : ''}
                    </div>
                `;

                Swal.fire({
                    title: confirmTitle,
                    html: `ต้องการ${confirmAction}การนัดหมายนี้หรือไม่?${detailsHtml}`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: `ยืนยัน${confirmAction}`,
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#198754',
                    cancelButtonColor: '#6c757d',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Proceed with saving
                        proceedWithAppointmentSubmit();
                    }
                });

                function proceedWithAppointmentSubmit() {
                    showAppointmentLoading();

                if (appointmentId) {
                    // Update existing appointment
                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                hideAppointmentLoading()
                                loadAppointments();
                                closeAppointmentModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error updating appointment:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.APPOINTMENT_UPDATE_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.UPDATE_APPOINTMENT](appointmentId, appointmentData);
                } else {
                    // Add new appointment
                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                loadAppointments();
                                closeAppointmentModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error adding appointment:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.APPOINTMENT_ADD_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.ADD_APPOINTMENT](appointmentData);
                }
                }
            }

            function closeAppointmentModal(form) {
                const modal = bootstrap.Modal.getInstance(document.querySelector(SELECTORS.APPOINTMENT_MODAL));
                modal.hide();
                form.reset();
                delete form.dataset.appointmentId;

                // Reset pills and hidden inputs
                form.querySelectorAll('.pill-option').forEach(pill => pill.classList.remove('selected'));
                form.querySelectorAll('input[name="caseType"][type="hidden"]').forEach(input => input.remove());
                form.querySelectorAll('input[name="caseDetails"][type="hidden"]').forEach(input => input.remove());
                const otherInput = form.querySelector('input[name="caseDetailsOther"]');
                if (otherInput) {
                    otherInput.value = '';
                    otherInput.style.display = 'none';
                }

                // Reset form tracking
                originalAppointmentFormData = {};
                isAppointmentFormDirty = false;
            }

            function editAppointment(appointmentId) {
                console.log("🚀 ~ editAppointment ~ appointmentId:", appointmentId)
                const appointment = appointments.find(a => a.id === appointmentId);
                if (!appointment) return;

                const form = document.querySelector(SELECTORS.APPOINTMENT_FORM);
                form.dataset.appointmentId = appointmentId;

                // Reset all pills first
                form.querySelectorAll('.pill-option').forEach(pill => {
                    pill.classList.remove('selected');
                });
                // Reset hidden inputs
                form.querySelectorAll('input[name="caseType"]').forEach(input => input.remove());
                form.querySelectorAll('input[name="caseDetails"]').forEach(input => input.remove());
                const otherInput = form.querySelector('input[name="caseDetailsOther"]');
                if (otherInput) {
                    otherInput.value = '';
                    otherInput.style.display = 'none';
                }

                // Populate form
                form.querySelector('[name="cost"]').value = appointment.cost;
                form.querySelector('[name="notes"]').value = appointment.notes || '';
                form.querySelector('[name="status"]').value = appointment.status;

                // Populate case types
                if (appointment.case_type) {
                    const caseTypes = appointment.case_type.split(', ');
                    const firstContainer = form.querySelectorAll('.form-check-container')[0]; // Case type container
                    caseTypes.forEach(type => {
                        const pill = firstContainer.querySelector(`.case-type-pill[data-value="${type}"]`);
                        if (pill) {
                            pill.click(); // Simulate click to trigger selection
                        }
                    });
                }

                // Populate case details
                if (appointment.case_details) {
                    const caseDetails = appointment.case_details.split(', ');
                    const secondContainer = form.querySelectorAll('.form-check-container')[1]; // Case details container
                    caseDetails.forEach(detail => {
                        if (detail.startsWith('อื่นๆ: ')) {
                            // Handle "Other" option
                            const otherPill = secondContainer.querySelector('.case-details-pill[data-value="อื่นๆ"]');
                            const otherInput = secondContainer.querySelector('input[name="caseDetailsOther"]');
                            if (otherPill && otherInput) {
                                otherPill.click(); // Simulate click to select "Other"
                                otherInput.value = detail.replace('อื่นๆ: ', '');
                            }
                        } else {
                            const pill = secondContainer.querySelector(`.case-details-pill[data-value="${detail}"]`);
                            if (pill) {
                                pill.click(); // Simulate click to trigger selection
                            }
                        }
                    });
                }

                $('[name="patientId"]').val(appointment.patient_id).trigger('change');
                $('[name="doctorId"]').val(appointment.doctor_id).trigger('change');
                form.querySelector('[name="appointmentDate"]')._flatpickr.setDate(appointment.appointment_date, true);
                form.querySelector('[name="appointmentTime"]')._flatpickr.setDate(appointment.appointment_time, true);

                // Show modal
                const modal = new bootstrap.Modal(document.querySelector(SELECTORS.APPOINTMENT_MODAL));
                modal.show();

                // Capture initial form data after modal is shown and form is populated
                setTimeout(() => {
                    captureAppointmentFormData();
                }, 100);
            }

            function handleRevenueSubmit(e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                const revenueData = {
                    date: formData.get('date'),
                    description: formData.get('description'),
                    amount: parseFloat(formData.get('amount')),
                    type: formData.get('type'),
                    notes: formData.get('notes')
                };

                // Show confirmation dialog with revenue details
                const revenueTypeText = revenueData.type === 'income' ? 'รายรับ' : 'รายจ่าย';
                const confirmTitle = 'ยืนยันการเพิ่มข้อมูลรายรับ-รายจ่าย';
                
                const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>วันที่:</strong> ${revenueData.date || '-'}<br>
                        <strong>รายการ:</strong> ${revenueData.description || '-'}<br>
                        <strong>จำนวนเงิน:</strong> ${revenueData.amount ? revenueData.amount.toLocaleString() + ' บาท' : '0 บาท'}<br>
                        <strong>ประเภท:</strong> ${revenueTypeText}<br>
                        ${revenueData.notes ? `<strong>หมายเหตุ:</strong> ${revenueData.notes}<br>` : ''}
                    </div>
                `;

                Swal.fire({
                    title: confirmTitle,
                    html: `ต้องการเพิ่มข้อมูลรายรับ-รายจ่ายนี้หรือไม่?${detailsHtml}`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ยืนยันเพิ่ม',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#198754',
                    cancelButtonColor: '#6c757d',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Proceed with saving
                        proceedWithRevenueSubmit();
                    }
                });

                function proceedWithRevenueSubmit() {
                    NProgress.start();

                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result.success) {
                            loadRevenues();
                            closeRevenueModal(e.target);
                            Toast.fire({
                                icon: 'success',
                                title: result.message
                            });
                        } else {
                            Toast.fire({
                                icon: 'error',
                                title: result.message
                            });
                        }
                        NProgress.done();
                    })
                    .withFailureHandler(function (error) {
                        console.error('Error adding revenue:', error);
                        Toast.fire({
                            icon: 'error',
                            title: UI_TEXT.MESSAGES.REVENUE_ADD_ERROR
                        });
                        NProgress.done();
                    })
                [API_METHODS.ADD_REVENUE](revenueData);
                }
            }

            function closeRevenueModal(form) {
                const modal = bootstrap.Modal.getInstance(document.querySelector(SELECTORS.REVENUE_MODAL));
                modal.hide();
                form.reset();
                form.querySelector('[name="date"]').value = new Date().toISOString().split('T')[0];
            }

            function renderRevenueTable() {
                const tbody = document.querySelector(`${SELECTORS.REVENUE_TABLE} tbody`);

                if (revenues.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">${UI_TEXT.MESSAGES.NO_REVENUE_DATA}</td></tr>`;
                    return;
                }

                const sortedRevenues = revenues.sort((a, b) => new Date(b.date) - new Date(a.date));

                const html = sortedRevenues.map(revenue => {
                    const date = new Date(revenue.date).toLocaleDateString(CONFIG.DATE_FORMAT_TH);

                    return `
                        <tr>
                            <td>${date}</td>
                            <td>${revenue.description}</td>
                            <td class="text-end">${revenue.amount.toLocaleString()} ${UI_TEXT.LABELS.BAHT}</td>
                            <td>${revenue.notes || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRevenue('${revenue.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = html;
            }

            function deleteRevenue(revenueId) {
                // Find revenue details
                const revenue = revenues.find(r => r.id === revenueId);
                const revenueTypeText = revenue?.type === 'income' ? 'รายรับ' : 'รายจ่าย';
                
                const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>วันที่:</strong> ${revenue?.date || '-'}<br>
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>วันที่:</strong> ${revenue?.date || '-'}<br>
                        <strong>รายการ:</strong> ${revenue?.description || '-'}<br>
                        <strong>จำนวนเงิน:</strong> ${revenue?.amount ? revenue.amount.toLocaleString() + ' บาท' : '0 บาท'}<br>
                        <strong>ประเภท:</strong> ${revenueTypeText}<br>
                        ${revenue?.notes ? `<strong>หมายเหตุ:</strong> ${revenue.notes}<br>` : ''}
                    </div>
                    <div style="color: #dc3545; font-weight: bold; margin-top: 15px;">
                        ⚠️ การลบข้อมูลนี้ไม่สามารถกู้คืนได้!
                    </div>
                `;

                Swal.fire({
                    title: 'ยืนยันการลบข้อมูลรายรับ-รายจ่าย',
                    html: `ต้องการลบข้อมูลรายรับ-รายจ่ายนี้หรือไม่?${detailsHtml}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ยืนยันลบ',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        NProgress.start();
                        Swal.fire({
                            iconHtml: '<i class="bi-hourglass-split text-danger"></i>',
                            title: 'กำลังลบข้อมูล...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            },
                            customClass: {
                                popup: 'rounded-4',
                                icon: 'border-0'
                            }
                        });
                        google.script.run
                            .withSuccessHandler(function (result) {
                                Swal.close();
                                if (result.success) {
                                    loadRevenues();
                                    Toast.fire({
                                        icon: 'success',
                                        title: result.message
                                    });
                                } else {
                                    Toast.fire({
                                        icon: 'error',
                                        title: result.message
                                    });
                                }
                                NProgress.done();
                            })
                            .withFailureHandler(function (error) {
                                Swal.close();
                                console.error('Error deleting revenue:', error);
                                Toast.fire({
                                    icon: 'error',
                                    title: UI_TEXT.MESSAGES.DELETE_REVENUE_ERROR
                                });
                                NProgress.done();
                            })
                        [API_METHODS.DELETE_REVENUE](revenueId);
                    }
                });
            }

            function updateRevenueStats() {
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const todayStr = today.toISOString().split('T')[0];

                // Daily revenue
                const dailyRev = revenues.filter(r => r.date === todayStr)
                    .reduce((sum, r) => sum + r.amount, 0);
                $(SELECTORS.DAILY_REVENUE).text(`${dailyRev.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`);

                // Monthly revenue
                const monthlyRev = revenues.filter(r => {
                    const rDate = new Date(r.date);
                    return rDate.getMonth() === currentMonth && rDate.getFullYear() === currentYear;
                }).reduce((sum, r) => sum + r.amount, 0);
                $(SELECTORS.MONTHLY_REVENUE).text(`${monthlyRev.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`);

                // Yearly revenue
                const yearlyRev = revenues.filter(r => {
                    const rDate = new Date(r.date);
                    return rDate.getFullYear() === currentYear;
                }).reduce((sum, r) => sum + r.amount, 0);
                $(SELECTORS.YEARLY_REVENUE).text(`${yearlyRev.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`);
            }

            function renderRevenueChart() {
                const canvas = $(SELECTORS.REVENUE_CHART)[0];

                // Check if chart already exists and destroy it
                if (Chart.getChart(canvas)) {
                    Chart.getChart(canvas).destroy();
                }

                const ctx = canvas.getContext('2d');

                // Get last 12 months data
                const monthlyData = [];
                const labels = [];

                for (let i = 11; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const month = date.getMonth();
                    const year = date.getFullYear();

                    const monthRevenue = revenues.filter(r => {
                        const rDate = new Date(r.date);
                        return rDate.getMonth() === month && rDate.getFullYear() === year;
                    }).reduce((sum, r) => sum + r.amount, 0);

                    monthlyData.push(monthRevenue);
                    labels.push(date.toLocaleDateString(CONFIG.DATE_FORMAT_TH, { month: 'short', year: '2-digit' }));
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${UI_TEXT.LABELS.REVENUE_DAILY} (${UI_TEXT.LABELS.BAHT})`,
                            data: monthlyData,
                            borderColor: '#30308b',
                            backgroundColor: 'rgba(48, 48, 139, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return `${value.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`;
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${UI_TEXT.LABELS.REVENUE_DAILY}: ${context.parsed.y.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function updateNotifications() {
                // Simple notification system for upcoming appointments
                const tomorrow = moment().add(1, 'days').format('YYYY-MM-DD');
                const tomorrowAppts = appointments.filter(apt => {
                    console.log(moment(apt.appointment_date).format('YYYY-MM-DD'))
                    return moment(apt.appointment_date).format('YYYY-MM-DD') === tomorrow;
                });

                if (tomorrowAppts.length > 0) {
                    $(SELECTORS.NOTIFICATION_BADGE).text(tomorrowAppts.length);
                    $(SELECTORS.NOTIFICATION_BADGE).removeClass('hidden');

                    const $notificationList = $(SELECTORS.NOTIFICATION_LIST);
                    const html = `
                        <li><h6 class="dropdown-header">${UI_TEXT.LABELS.NOTIFICATIONS}</h6></li>
                        <li><hr class="dropdown-divider"></li>
                        ${tomorrowAppts.map(apt => {
                        const patient = patients.find(p => p.id === apt.patient_id);
                        const patientName = patient ? `${patient.first_name} ${patient.last_name}` : UI_TEXT.MESSAGES.PATIENT_NOT_FOUND;
                        return `<li><a class="dropdown-item"><div class="fw-bold">${patientName}</div><small>${UI_TEXT.LABELS.TOMORROW_APPOINTMENT} ${apt.appointment_time}</small></a></li>`;
                    }).join('')}
                    `;
                    $notificationList.html(html);
                }
            }

            function renderReports() {
                // This would be implemented for admin users
                console.log('Rendering reports for admin user');
            }

            // Global functions for onclick events
            window.editPatient = editPatient;
            window.deletePatient = deletePatient;
            window.editAppointment = editAppointment;
            window.deleteRevenue = deleteRevenue;
        </script>
    </body>

    </html>