<!DOCTYPE html>
<html lang="th">

<head>
    <base target="_top">
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smile Focus - ระบบจัดการลูกค้าคลินิคทันตกรรม</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_red.css">
    <link
        href="https://cdn.datatables.net/v/bs5/dt-2.3.0/b-3.2.3/date-1.5.5/fh-4.0.1/r-3.0.4/sl-3.0.0/datatables.min.css"
        rel="stylesheet" integrity="sha384-pDoMXaoekHsQmb1L6aeyRL/WoJRQnDTYvUeWu4LbiTVT2Vhp2niYUKgdwBE/Tnl8"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .navbar-brand {
            font-weight: bold;
            color: #30308b !important;
        }

        .navbar-logo {
            height: 32px;
            width: auto;
            max-width: 40px;
            object-fit: contain;
        }

        .clinic-logo {
            height: 80px;
            width: auto;
            max-width: 120px;
            object-fit: contain;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 10px;
        }

        .btn-primary {
            background: #30308b;
            border: none;
        }

        .btn-primary:hover {
            background: #a92246;
        }

        .user-dropdown .dropdown-toggle {
            text-align: left;
            min-width: 180px;
        }

        .user-dropdown .dropdown-toggle .d-flex {
            align-items: flex-start;
        }

        .user-dropdown .dropdown-item-text {
            font-size: 0.875rem;
            padding: 0.375rem 1rem;
            white-space: nowrap;
        }

        .user-dropdown .dropdown-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: #30308b;
        }

        .sidebar {
            min-height: 100vh;
            background: #30308b;
        }

        .sidebar .nav-link {
            color: white !important;
            padding: 12px 20px;
            border-radius: 5px;
            margin: 5px 10px;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .stats-card {
            background: #30308b;
            color: white;
            border-radius: 15px;
        }

        .stats-card-2 {
            background: #a92246;
            color: white;
            border-radius: 15px;
        }

        .stats-card-3 {
            background: #009958;
            color: white;
            border-radius: 15px;
        }

        .stats-card-4 {
            background: #30308b;
            color: white;
            border-radius: 15px;
        }

        .login-container {
            min-height: 100vh;
            background: white;
        }

        .login-card {
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .super-admin-only {
            display: none !important;
        }

        .super-admin-only.show {
            display: block !important;
        }

        .sidebar .super-admin-only.show {
            display: flex !important;
        }

        .super-admin-only-filter {
            display: none !important;
        }

        .super-admin-only-filter.show {
            display: flex !important;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .calendar-cell {
            background: white;
            min-height: 80px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calendar-cell:hover {
            background-color: #f8f9fa;
        }

        .calendar-cell.other-month {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .calendar-cell.today {
            background-color: #e6f0f9;
            font-weight: bold;
        }

        .calendar-cell.selected {
            border: 3px solid #30308b;
            background-color: #f0f8ff;
            font-weight: bold;
        }

        .appointment-dots {
            position: absolute;
            bottom: 5px;
            right: 5px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .appointment-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #009958;
        }

        .appointment-dot.scheduled {
            background-color: #30308b;
        }

        .appointment-dot.completed {
            background-color: #009958;
        }

        .appointment-dot.cancelled {
            background-color: #a92246;
        }

        .appointment-status-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 10px;
            color: white;
        }

        .appointment-status-icon.scheduled {
            background-color: #30308b;
        }

        .appointment-status-icon.completed {
            background-color: #009958;
        }

        .appointment-status-icon.cancelled {
            background-color: #a92246;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #a92246;
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 12px;
        }

        .small {
            font-size: 0.875em;
        }

        #todayAppointmentsList .list-group-item {
            cursor: pointer;
        }

        #todayAppointmentsList .list-group-item:hover {
            background-color: #f8f9fa;
        }

        .badge.completed {
            background-color: #009958;
        }

        .badge.cancelled {
            background-color: #a92246;
        }

        .badge.scheduled {
            background-color: #30308b;
        }

        .form-check-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            align-items: center;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .form-check {
            margin-bottom: 8px;
        }

        .form-check-input:checked {
            background-color: #30308b;
            border-color: #30308b;
        }

        .form-check-input:focus {
            border-color: #30308b;
            box-shadow: 0 0 0 0.2rem rgba(48, 48, 139, 0.25);
        }

        /* Pill styling */
        .case-type-pill,
        .case-details-pill {
            transition: all 0.3s ease;
            cursor: pointer !important;
            font-size: 0.9em !important;
            padding: 8px 12px !important;
            border: 2px solid #d6d8db !important;
            color: #6c757d !important;
            background: #f8f9fa !important;
        }

        .case-type-pill:hover {
            border-color: #0d6efd !important;
            color: #0d6efd !important;
            background: #fff !important;
        }

        .case-type-pill.selected {
            border-color: #0d6efd !important;
            color: #fff !important;
            background: #0d6efd !important;
        }

        .case-details-pill:hover {
            border-color: #198754 !important;
            color: #198754 !important;
            background: #fff !important;
        }

        .case-details-pill.selected {
            border-color: #198754 !important;
            color: #fff !important;
            background: #198754 !important;
        }

        /* Payment Type Pill styling */
        .payment-type-pill {
            transition: all 0.3s ease;
            cursor: pointer !important;
            font-size: 0.9em !important;
            padding: 8px 12px !important;
            border: 2px solid #d6d8db !important;
            color: #6c757d !important;
            background: #f8f9fa !important;
        }

        .payment-type-pill:hover {
            border-color: #17a2b8 !important;
            color: #17a2b8 !important;
            background: #fff !important;
        }

        .payment-type-pill.selected {
            border-color: #17a2b8 !important;
            color: #fff !important;
            background: #17a2b8 !important;
        }

        .payment-type-pill.payment-type-other:hover {
            border-color: #fd7e14 !important;
            color: #fd7e14 !important;
            background: #fff !important;
        }

        .payment-type-pill.payment-type-other.selected {
            border-color: #fd7e14 !important;
            color: #fff !important;
            background: #fd7e14 !important;
        }

        /* Loading page styles */
        .loading-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out;
        }

        .loading-page.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            width: 250px;
            height: 250px;
            margin-bottom: 40px;
            animation: pulse 2s infinite ease-in-out;
        }

        .loading-text {
            font-size: 1.2rem;
            color: #30308b;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .loading-progress-container {
            width: 400px;
            max-width: 90vw;
            margin-bottom: 30px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .progress-label {
            color: #30308b;
            font-weight: 500;
        }

        .progress-percentage {
            color: #a92246;
            font-weight: 600;
        }

        .progress {
            background-color: #f1f1f1;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #30308b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        table.dataTable {

            td,
            th {
                vertical-align: middle;
            }
        }

        /* Modal styling for rounded corners */
        .modal-content {
            border-radius: 16px !important;
            border: none !important;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1) !important;
        }

        .modal-header {
            border-top-left-radius: 16px !important;
            border-top-right-radius: 16px !important;
            border-bottom: 1px solid #e9ecef !important;
        }

        .modal-footer {
            border-bottom-left-radius: 16px !important;
            border-bottom-right-radius: 16px !important;
            border-top: 1px solid #e9ecef !important;
        }

        .modal-dialog {
            margin: 1.75rem auto;
        }

        .modal-dialog-scrollable .modal-content {
            border-radius: 16px !important;
        }

        /* Ensure backdrop doesn't interfere with rounded corners */
        .modal {
            --bs-modal-border-radius: 16px;
        }

        .user-info-icon {
            width: 32px;
            height: 32px;
            align-content: center;
            display: flex;
            justify-content: center;
            border-radius: 50%;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Settings page specific styles */
        .steps-container .step {
            transition: all 0.3s ease;
        }

        .steps-container .step:hover {
            transform: translateX(5px);
        }

        .steps-container .badge {
            min-width: 24px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Settings modal styles */
        #setupInstructionsModal .modal-body {
            font-size: 0.95rem;
            line-height: 1.6;
        }

        #setupInstructionsModal code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Status indicators */
        .alert {
            border: none;
            border-radius: 12px;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.5em 0.75em;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Loading Page -->
    <div id="loadingPage" class="loading-page">
        <img src="https://img2.pic.in.th/pic/Screenshot-2025-09-22-215301.png" alt="Clinic Logo" class="loading-logo">
        <div class="loading-text">กำลังโหลดระบบจัดการคลินิคทันตกรรม</div>

        <!-- Progress Bar Container -->
        <div class="loading-progress-container">
            <div class="progress-info">
                <div class="progress-label" id="loadingProgressLabel">เริ่มต้นโหลดข้อมูล...</div>
                <div class="progress-percentage" id="loadingProgressPercentage">0%</div>
            </div>
            <div class="progress" style="height: 4px; border-radius: 10px;">
                <div class="progress-bar progress-bar-animated progress-bar-striped" id="loadingProgressBar"
                    role="progressbar" style="width: 0%; background: #30308b;" aria-valuenow="0" aria-valuemin="0"
                    aria-valuemax="100">
                </div>
            </div>
        </div>

        <div class="loading-spinner"></div>
        <div class="mt-3 text-muted">กรุณารอสักครู่...</div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-container d-flex align-items-center justify-content-center">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-4">
                    <div class="card login-card">
                        <div class="card-body p-5">
                            <div class="text-center mb-4">
                                <img src="https://img2.pic.in.th/pic/Screenshot-2025-09-22-215301.png"
                                    alt="Smile Focus Logo" class="clinic-logo mb-3">
                                <h3 class="mb-1">Smile Focus</h3>
                                <p class="text-muted">เข้าสู่ระบบเพื่อใช้งาน</p>
                            </div>

                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="username" class="form-label">ชื่อผู้ใช้</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input type="text" class="form-control" id="username" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="password" class="form-label">รหัสผ่าน</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                        <input type="password" class="form-control" id="password" required>
                                    </div>
                                </div>


                                <button type="submit" class="btn btn-primary w-100 py-2">
                                    <i class="fas fa-sign-in-alt me-2"></i>เข้าสู่ระบบ
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="javascript:void(0)">
                    <img src="https://img2.pic.in.th/pic/Screenshot-2025-09-22-215301.png" alt="Smile Focus Logo"
                        class="navbar-logo me-2">
                    Smile Focus
                </a>

                <div class="d-flex align-items-center">
                    <div class="dropdown me-3">
                        <button class="btn btn-outline-primary dropdown-toggle position-relative" type="button"
                            id="notificationDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-bell"></i>
                            <span
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden"
                                id="notificationBadge">
                                0
                                <span class="visually-hidden">unread messages</span>
                            </span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" id="notificationList" style="min-width: 300px;">
                            <li>
                                <h6 class="dropdown-header">การแจ้งเตือน</h6>
                            </li>
                            <!-- Branch Filter for Super Admin -->
                            <li class="super-admin-only">
                                <div class="dropdown-item-text">
                                    <label class="form-label mb-1" style="font-size: 0.875rem;">กรองตามสาขา:</label>
                                    <select class="form-select form-select-sm" id="notificationBranchFilter"
                                        onchange="updateNotifications()">
                                        <option value="">ทุกสาขา</option>
                                    </select>
                                </div>
                            </li>
                            <li class="super-admin-only">
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><span class="dropdown-item-text text-muted">ไม่มีการแจ้งเตือนใหม่</span></li>
                        </ul>
                    </div>

                    <div class="dropdown user-dropdown">
                        <button
                            class="btn btn-light border-0 shadow-sm dropdown-toggle d-flex align-items-center px-3 py-2 rounded-pill"
                            type="button" id="userDropdown" data-bs-toggle="dropdown"
                            style="transition: all 0.2s ease;">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2"
                                style="width: 32px; height: 32px;">
                                <i class="fas fa-user text-white" style="font-size: 0.875rem;"></i>
                            </div>
                            <div class="d-flex flex-column align-items-start text-start">
                                <span id="currentUser" class="fw-medium text-dark"
                                    style="font-size: 0.875rem; line-height: 1.2;">ผู้ใช้</span>
                                <small id="userInfo" class="text-muted"
                                    style="font-size: 0.7rem; line-height: 1;"></small>
                            </div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3"
                            style="min-width: 250px; margin-top: 8px;">
                            <li class="px-3 py-2 bg-light rounded-top">
                                <h6 class="mb-0 text-primary fw-semibold">
                                    <i class="fas fa-user-circle me-2"></i>ข้อมูลผู้ใช้
                                </h6>
                            </li>
                            <li class="px-3 py-2">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 user-info-icon p-2 me-3">
                                        <i class="fas fa-building text-primary" style="font-size: 0.875rem;"></i>
                                    </div>
                                    <div>
                                        <div class="text-muted small mb-1">สาขา</div>
                                        <div class="fw-medium" id="userBranch">-</div>
                                    </div>
                                </div>
                            </li>
                            <li class="px-3 py-2">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success bg-opacity-10 user-info-icon p-2 me-3">
                                        <i class="fas fa-user-tag text-success" style="font-size: 0.875rem;"></i>
                                    </div>
                                    <div>
                                        <div class="text-muted small mb-1">บทบาท</div>
                                        <div class="fw-medium" id="userRole">-</div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <hr class="dropdown-divider my-2">
                            </li>
                            <li class="px-2">
                                <a class="dropdown-item d-flex align-items-center px-3 py-2 rounded-2 text-danger"
                                    href="javascript:void(0)" id="logoutBtn" style="transition: all 0.2s ease;">
                                    <div class="bg-danger bg-opacity-10 user-info-icon p-2 me-3">
                                        <i class="fas fa-sign-out-alt text-danger" style="font-size: 0.875rem;"></i>
                                    </div>
                                    <span class="fw-medium">ออกจากระบบ</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3 col-lg-2 px-0">
                    <div class="sidebar">
                        <div class="nav flex-column nav-pills p-3">
                            <a class="nav-link active" href="javascript:void(0)" data-page="dashboard">
                                <i class="fas fa-tachometer-alt me-2"></i>หน้าหลัก
                            </a>
                            <a class="nav-link" href="javascript:void(0)" data-page="appointments">
                                <i class="fas fa-calendar-alt me-2"></i>การนัดหมาย
                            </a>
                            <a class="nav-link" href="javascript:void(0)" data-page="revenue">
                                <i class="fas fa-chart-line me-2"></i>แจ้งยอดรายวัน
                            </a>
                            <a class="nav-link" href="javascript:void(0)" data-page="patients">
                                <i class="fas fa-users me-2"></i>จัดการลูกค้า
                            </a>
                            <a class="nav-link admin-only" href="javascript:void(0)" data-page="doctors">
                                <i class="fas fa-user-md me-2"></i>จัดการหมอ
                            </a>
                            <a class="nav-link admin-only" href="javascript:void(0)" data-page="users">
                                <i class="fas fa-users-cog me-2"></i>จัดการผู้ใช้
                            </a>
                            <a class="nav-link admin-only hidden" href="javascript:void(0)" data-page="reports">
                                <i class="fas fa-chart-bar me-2"></i>รายงาน
                            </a>
                            <a class="nav-link super-admin-only" href="javascript:void(0)" data-page="settings">
                                <i class="fas fa-cog me-2"></i>ตั้งค่าระบบ
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-9 col-lg-10">
                    <div class="p-4">
                        <!-- Dashboard Page -->
                        <div id="dashboardPage" class="page-content">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>หน้าหลัก</h2>
                                <div class="text-muted">วันที่: <span id="currentDate"></span></div>
                            </div>

                            <!-- Statistics Cards -->
                            <div class="row mb-4">
                                <div class="col-md-4 mb-3">
                                    <div class="card stats-card p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">ลูกค้าทั้งหมด</h6>
                                                <h3 class="mb-0" id="totalPatients">0</h3>
                                            </div>
                                            <i class="fas fa-users fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <div class="card stats-card-2 p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">นัดหมายวันนี้</h6>
                                                <h3 class="mb-0" id="todayAppointments">0</h3>
                                            </div>
                                            <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <div class="card stats-card-3 p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">รายได้วันนี้</h6>
                                                <h3 class="mb-0" id="todayRevenue">0</h3>
                                            </div>
                                            <i class="fas fa-money-bill-wave fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Recent Activities -->
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">นัดหมายในสัปดาห์นี้</h5>
                                            <div class="d-flex align-items-center super-admin-only-filter">
                                                <label class="form-label me-2 mb-0">สาขา:</label>
                                                <select id="weeklyAppointmentsBranchFilter"
                                                    class="form-select form-select-sm rounded-3" style="width: 150px;">
                                                    <option value="">ทุกสาขา</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="weeklyAppointments"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">ลูกค้าใหม่ล่าสุด</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="recentPatients"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Patients Page -->
                        <div id="patientsPage" class="page-content hidden">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>จัดการลูกค้า</h2>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#patientModal">
                                    <i class="fas fa-plus me-2"></i>เพิ่มลูกค้าใหม่
                                </button>
                            </div>

                            <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="patientsTable" class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>รหัสลูกค้า</th>
                                                    <th>ชื่อ-นามสกุล</th>
                                                    <th>เบอร์โทร</th>
                                                    <th>อายุ</th>
                                                    <th>วันที่ลงทะเบียน</th>
                                                    <th>การจัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Doctors Page -->
                        <div id="doctorsPage" class="page-content hidden admin-only">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>จัดการหมอ</h2>
                                <button class="btn btn-primary admin-only" data-bs-toggle="modal"
                                    data-bs-target="#doctorModal">
                                    <i class="fas fa-plus me-2"></i>เพิ่มหมอใหม่
                                </button>
                            </div>

                            <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="doctorsTable" class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>รหัสหมอ</th>
                                                    <th>ชื่อ-นามสกุล</th>
                                                    <th>ความเชี่ยวชาญ</th>
                                                    <th>เบอร์โทร</th>
                                                    <th>อีเมล</th>
                                                    <th>การจัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Users Page -->
                        <div id="usersPage" class="page-content hidden admin-only">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>จัดการผู้ใช้</h2>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal">
                                    <i class="fas fa-plus me-2"></i>เพิ่มผู้ใช้ใหม่
                                </button>
                            </div>

                            <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="usersTable" class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ชื่อผู้ใช้</th>
                                                    <th>ชื่อ-นามสกุล</th>
                                                    <th>สาขา</th>
                                                    <th>ระดับผู้ใช้</th>
                                                    <th>สถานะ</th>
                                                    <th>วันที่สร้าง</th>
                                                    <th>การจัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Appointments Page -->
                        <div id="appointmentsPage" class="page-content hidden">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>การนัดหมาย</h2>
                                <button class="btn btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#appointmentModal">
                                    <i class="fas fa-plus me-2"></i>เพิ่มนัดหมายใหม่
                                </button>
                            </div>

                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">ปฏิทินการนัดหมาย</h5>
                                            <div class="d-flex align-items-center gap-3">
                                                <div class="d-flex align-items-center super-admin-only-filter">
                                                    <label class="form-label me-2 mb-0">สาขา:</label>
                                                    <select id="calendarBranchFilter"
                                                        class="form-select form-select-sm rounded-3"
                                                        style="width: 150px;">
                                                        <option value="">ทุกสาขา</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <button class="btn btn-sm btn-outline-primary" id="prevMonth">
                                                        <i class="fas fa-chevron-left"></i>
                                                    </button>
                                                    <span id="currentMonth" class="mx-3"></span>
                                                    <button class="btn btn-sm btn-outline-primary" id="nextMonth">
                                                        <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="calendar"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">นัดหมายวันที่ <span id="selectedDate"
                                                    class="text-primary"></span></h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="todayAppointmentsList" class="list-group list-group-flush">
                                                <p class="text-muted">กำลังโหลด...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Revenue Page -->
                        <div id="revenuePage" class="page-content hidden">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>รายได้รายวัน</h2>
                                <div class="d-flex gap-3 align-items-center">
                                    <!-- Branch Filter for Super Admin -->
                                    <div class="super-admin-only-filter d-flex align-items-center gap-2">
                                        <label class="form-label mb-0 text-nowrap"
                                            style="font-size: 0.9rem;">สาขา:</label>
                                        <select class="form-select form-select-sm" id="revenueBranchFilter"
                                            style="min-width: 150px;">
                                            <option value="">ทุกสาขา</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" data-bs-toggle="modal"
                                        data-bs-target="#revenueModal">
                                        <i class="fas fa-plus me-2"></i>บันทึกรายได้
                                    </button>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="text-muted">รายได้วันนี้</h6>
                                            <h3 class="text-primary" id="dailyRevenue">0 บาท</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="text-muted">รายได้เดือนนี้</h6>
                                            <h3 class="text-success" id="monthlyRevenue">0 บาท</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="text-muted">รายได้ปีนี้</h6>
                                            <h3 class="text-info" id="yearlyRevenue">0 บาท</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">กราฟรายได้รายเดือน</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="revenueChart" height="100"></canvas>
                                </div>
                            </div>

                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5 class="mb-0">ประวัติรายได้</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="revenueTable" class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>วันที่</th>
                                                    <th>ลูกค้า</th>
                                                    <th>หมอ</th>
                                                    <th>ประเภทเคส</th>
                                                    <th>การชำระ</th>
                                                    <th>ยอดรวม</th>
                                                    <th>การจัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reports Page (Admin Only) -->
                        <div id="reportsPage" class="page-content hidden">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>รายงาน</h2>
                                <!-- Branch Filter for Super Admin -->
                                <div class="super-admin-only-filter d-flex align-items-center gap-2">
                                    <label class="form-label mb-0 text-nowrap" style="font-size: 0.9rem;">สาขา:</label>
                                    <select class="form-select form-select-sm" id="reportsBranchFilter"
                                        style="min-width: 150px;">
                                        <option value="">ทุกสาขา</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">สรุปลูกค้ารายเดือน</h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="patientsChart" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">สรุปการนัดหมายรายเดือน</h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="appointmentsChart" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Page (Super Admin Only) -->
                        <div id="settingsPage" class="page-content hidden">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>ตั้งค่าระบบ</h2>
                            </div>

                            <div class="row">
                                <div class="col-md-10 mx-auto">
                                    <div class="card">
                                        <div class="card-header d-flex align-items-center">
                                            <i class="fas fa-bell me-2 text-primary"></i>
                                            <h5 class="mb-0">การแจ้งเตือน Google Chat</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <p class="text-muted">
                                                    ตั้งค่า Google Chat เพื่อรับการแจ้งเตือนเมื่อมีข้อมูลใหม่ในระบบ
                                                </p>
                                            </div>

                                            <div id="notificationStatus" class="alert" role="alert">
                                                <div class="d-flex align-items-center">
                                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <span>กำลังตรวจสอบสถานะ...</span>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label for="chatWebhookUrl" class="form-label">
                                                    <i class="fas fa-link me-1"></i>Google Chat Webhook URL
                                                </label>
                                                <input type="url" class="form-control" id="chatWebhookUrl"
                                                    placeholder="https://chat.googleapis.com/v1/spaces/YOUR_SPACE/messages?key=YOUR_KEY&token=YOUR_TOKEN"
                                                    disabled>
                                                <div class="form-text">
                                                    กรอก Webhook URL ของ Google Chat Space ที่ต้องการรับการแจ้งเตือน
                                                </div>
                                            </div>

                                            <div class="d-flex gap-2 flex-wrap mb-4">
                                                <button type="button" class="btn btn-primary" id="saveWebhookBtn"
                                                    disabled>
                                                    <i class="fas fa-save me-1"></i>บันทึกการตั้งค่า
                                                </button>
                                                <button type="button" class="btn btn-success" id="testNotificationBtn"
                                                    disabled>
                                                    <i class="fas fa-paper-plane me-1"></i>ทดสอบการแจ้งเตือน
                                                </button>
                                                <button type="button" class="btn btn-info" id="setupInstructionsBtn">
                                                    <i class="fas fa-question-circle me-1"></i>วิธีการตั้งค่า
                                                </button>
                                            </div>

                                            <div class="alert alert-warning">
                                                <div class="d-flex align-items-start">
                                                    <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                                                    <div>
                                                        <strong>คำเตือน:</strong>
                                                        <p class="mb-0 small">
                                                            การตั้งค่านี้จะส่งผลต่อการแจ้งเตือนของระบบทั้งหมด กรุณาตรวจสอบให้แน่ใจก่อนบันทึก
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Modal -->
    <div class="modal fade" id="patientModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        data-bs-focus="false">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่ม/แก้ไขข้อมูลลูกค้า</h5>
                    <button type="button" class="btn-close"></button>
                </div>
                <div class="modal-body">
                    <form id="patientForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">คำนำหน้าชื่อ</label>
                                    <input type="text" class="form-control" name="titlePrefix" list="titlePrefixList"
                                        placeholder="เลือกหรือพิมพ์">
                                    <datalist id="titlePrefixList">
                                        <option value="นาย">
                                        <option value="นาง">
                                        <option value="นางสาว">
                                        <option value="เด็กชาย">
                                        <option value="เด็กหญิง">
                                        <option value="ไม่ระบุ">
                                    </datalist>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ชื่อ</label>
                                    <input type="text" class="form-control" name="firstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">นามสกุล</label>
                                    <input type="text" class="form-control" name="lastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">เบอร์โทรศัพท์</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">วันเกิด</label>
                                    <input type="date" class="form-control" name="birthDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">เพศ</label>
                                    <select class="form-select" name="gender">
                                        <option value="">เลือกเพศ</option>
                                        <option value="ชาย">ชาย</option>
                                        <option value="หญิง">หญิง</option>
                                        <option value="ไม่ระบุ">ไม่ระบุ</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 super-admin-only">
                                <div class="mb-3">
                                    <label class="form-label">สาขา <span class="text-danger">*</span></label>
                                    <select class="form-select" name="branch">
                                        <option value="">เลือกสาขา</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ที่อยู่</label>
                            <textarea class="form-control" name="address" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ประวัติการแพ้ยา</label>
                            <textarea class="form-control" name="allergies" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">โรคประจำตัว</label>
                            <textarea class="form-control" name="medicalHistory" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">หมายเหตุ</label>
                            <textarea class="form-control" name="notes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelButton">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="savePatientButton">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Doctor Modal -->
    <div class="modal fade admin-only" id="doctorModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        data-bs-focus="false">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่ม/แก้ไขข้อมูลหมอ</h5>
                    <button type="button" class="btn-close"></button>
                </div>
                <div class="modal-body">
                    <form id="doctorForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ชื่อ</label>
                                    <input type="text" class="form-control" name="firstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">นามสกุล</label>
                                    <input type="text" class="form-control" name="lastName" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ความเชี่ยวชาญ</label>
                            <input type="text" class="form-control" name="specialty" required
                                placeholder="เช่น ทันตกรรมจัดฟัน, ทันตกรรมรากฟัน">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">เบอร์โทรศัพท์</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">อีเมล</label>
                                    <input type="email" class="form-control" name="email">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ใบอนุญาตประกอบวิชาชีพ</label>
                            <input type="text" class="form-control" name="licenseNumber" placeholder="หมายเลขใบอนุญาต">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">หมายเหตุ</label>
                            <textarea class="form-control" name="notes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelDoctorButton">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="saveDoctorButton">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div class="modal fade" id="appointmentModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        data-bs-focus="false">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่ม/แก้ไขการนัดหมาย</h5>
                    <button type="button" class="btn-close"></button>
                </div>
                <div class="modal-body">
                    <form id="appointmentForm">
                        <div class="mb-3 super-admin-only">
                            <label class="form-label">สาขา <span class="text-danger">*</span></label>
                            <select class="form-select" name="branch">
                                <option value="">เลือกสาขา</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">เลือกลูกค้า</label>
                            <select class="form-select" name="patientId" required>
                                <option value="">เลือกลูกค้า</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">เลือกหมอ</label>
                            <select class="form-select" name="doctorId" required>
                                <option value="">เลือกหมอ</option>
                            </select>
                        </div>


                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">วันที่นัด</label>
                                    <input type="date" class="form-control" name="appointmentDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">เวลานัด</label>
                                    <input type="time" class="form-control" name="appointmentTime" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ประเภทเคส <span class="text-danger">*</span></label>
                            <div class="form-check-container">
                                <!-- Dynamic case type options will be loaded here -->
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">รายละเอียดเคส</label>
                            <div class="form-check-container">
                                <!-- Dynamic case details options will be loaded here -->
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ช่องทางการติดต่อ <span class="text-danger">*</span></label>
                            <select class="form-select" name="contactChannel" required>
                                <option value="">เลือกช่องทางการติดต่อ</option>
                                <!-- Dynamic contact channel options will be loaded here -->
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ค่าใช้จ่าย (บาท)</label>
                            <input type="number" class="form-control" name="cost" min="0" step="0.01">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">หมายเหตุ</label>
                            <textarea class="form-control" name="notes" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">สถานะ</label>
                            <select class="form-select" name="status">
                                <option value="scheduled">นัดหมาย</option>
                                <option value="completed">เสร็จสิ้น</option>
                                <option value="cancelled">ยกเลิก</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelAppointmentButton">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="saveAppointmentButton">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue Modal -->
    <div class="modal fade" id="revenueModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        data-bs-focus="false">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">บันทึกรายได้</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="revenueForm">
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">วันที่</label>
                                    <input type="date" class="form-control" name="date" required>
                                </div>
                            </div>
                            <div class="col-12 super-admin-only">
                                <div class="mb-3">
                                    <label class="form-label">สาขา <span class="text-danger">*</span></label>
                                    <select class="form-select" name="branch">
                                        <option value="">เลือกสาขา</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">ชื่อลูกค้า</label>
                                    <select class="form-select" name="patientId" required>
                                        <option value="">เลือกลูกค้า</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">ชื่อหมอ</label>
                                    <select class="form-select" name="doctorId" required>
                                        <option value="">เลือกหมอ</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ประเภทเคส</label>
                            <div class="form-check-container" id="revenueCaseTypeContainer">
                                <!-- Case type options will be rendered here -->
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">รายละเอียดเคส</label>
                            <div class="form-check-container" id="revenueCaseDetailsContainer">
                                <!-- Case details options will be rendered here -->
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ประเภทการชำระ</label>
                            <div class="form-check-container" id="revenuePaymentTypeContainer">
                                <!-- Payment type options will be rendered here -->
                            </div>
                        </div>

                        <!-- Payment Amount Fields (Dynamic based on payment type selection) -->
                        <div id="paymentAmountSection" style="display: none;">
                            <h6 class="text-primary mb-3">รายละเอียดการชำระเงิน</h6>
                            <div class="row" id="paymentAmountFields">
                                <!-- Dynamic payment amount fields will be rendered here -->
                            </div>
                        </div>

                        <!-- Additional Cost Fields -->
                        <h6 class="text-primary mb-3">ค่าใช้จ่ายเพิ่มเติม</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">ค่าเอ็กซเรย์ (บาท)</label>
                                    <input type="number" class="form-control" name="xrayFee" min="0" step="1"
                                        id="xrayFee">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">ค่ายา (บาท)</label>
                                    <input type="number" class="form-control" name="medicineFee" min="0" step="1"
                                        id="medicineFee">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">ค่าผลิตภัณฑ์อื่นไม่ใช่ยา (บาท)</label>
                                    <input type="number" class="form-control" name="otherProductFee" min="0" step="1"
                                        id="otherProductFee">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ส่วนลด (บาท)</label>
                                    <input type="number" class="form-control" name="discount" min="0" step="1"
                                        id="discount">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">หมายเหตุ</label>
                            <textarea class="form-control" name="notes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="saveRevenueButton">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal fade admin-only" id="userModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        data-bs-focus="false">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">จัดการผู้ใช้</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm" novalidate>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ชื่อผู้ใช้ <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="username" required>
                                    <div class="invalid-feedback">กรุณากรอกชื่อผู้ใช้</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">รหัสผ่าน <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="password" required>
                                    <div class="invalid-feedback">กรุณากรอกรหัสผ่าน</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ชื่อจริง <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="firstName" required>
                                    <div class="invalid-feedback">กรุณากรอกชื่อจริง</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">นามสกุล <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="lastName" required>
                                    <div class="invalid-feedback">กรุณากรอกนามสกุล</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">สาขา <span class="text-danger">*</span></label>
                                    <select class="form-select" name="branch" required>
                                        <option value="">เลือกสาขา</option>
                                    </select>
                                    <div class="invalid-feedback">กรุณาเลือกสาขา</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ระดับผู้ใช้ <span class="text-danger">*</span></label>
                                    <select class="form-select" name="role" required>
                                        <option value="">เลือกระดับผู้ใช้</option>
                                        <option value="user">ผู้ใช้ทั่วไป</option>
                                        <option value="admin" class="super-admin-only">ผู้ดูแลระบบ</option>
                                        <option value="super_admin" class="super-admin-only">ผู้ดูแลระบบสูงสุด</option>
                                    </select>
                                    <div class="invalid-feedback">กรุณาเลือกระดับผู้ใช้</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">อีเมล</label>
                                    <input type="email" class="form-control" name="email">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">เบอร์โทรศัพท์</label>
                                    <input type="tel" class="form-control" name="phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">สถานะ</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="userStatus"
                                            name="status" value="active" checked>
                                        <label class="form-check-label" for="userStatus">
                                            เปิดใช้งาน
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="saveUserButton">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Chat Setup Instructions Modal -->
    <div class="modal fade" id="setupInstructionsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fab fa-google text-primary me-2"></i>วิธีการตั้งค่า Google Chat
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>ข้อมูลสำคัญ:</strong> การตั้งค่านี้จะทำให้ระบบส่งการแจ้งเตือนอัตโนมัติไปยัง Google Chat เมื่อมีข้อมูลใหม่
                    </div>

                    <div class="steps-container">
                        <h6 class="mb-3"><i class="fas fa-list-ol me-2 text-primary"></i>ขั้นตอนการตั้งค่า:</h6>
                        
                        <div class="step mb-4">
                            <div class="d-flex align-items-start">
                                <span class="badge bg-primary rounded-circle me-3" style="width: 24px; height: 24px; line-height: 16px;">1</span>
                                <div>
                                    <strong>สร้างหรือเปิด Google Chat Space</strong>
                                    <p class="text-muted mb-1">เข้าไปที่ <code>chat.google.com</code> และสร้าง Space ใหม่หรือเลือก Space ที่มีอยู่</p>
                                </div>
                            </div>
                        </div>

                        <div class="step mb-4">
                            <div class="d-flex align-items-start">
                                <span class="badge bg-primary rounded-circle me-3" style="width: 24px; height: 24px; line-height: 16px;">2</span>
                                <div>
                                    <strong>คลิกที่ชื่อ Space</strong>
                                    <p class="text-muted mb-1">คลิกที่ชื่อ Space ด้านบนเพื่อเข้าสู่การตั้งค่า</p>
                                </div>
                            </div>
                        </div>

                        <div class="step mb-4">
                            <div class="d-flex align-items-start">
                                <span class="badge bg-primary rounded-circle me-3" style="width: 24px; height: 24px; line-height: 16px;">3</span>
                                <div>
                                    <strong>เลือก "Manage webhooks"</strong>
                                    <p class="text-muted mb-1">เลือกเมนู "Manage webhooks" จากรายการตัวเลือก</p>
                                </div>
                            </div>
                        </div>

                        <div class="step mb-4">
                            <div class="d-flex align-items-start">
                                <span class="badge bg-primary rounded-circle me-3" style="width: 24px; height: 24px; line-height: 16px;">4</span>
                                <div>
                                    <strong>คลิก "Add webhook"</strong>
                                    <p class="text-muted mb-1">คลิกปุ่ม "Add webhook" เพื่อสร้าง webhook ใหม่</p>
                                </div>
                            </div>
                        </div>

                        <div class="step mb-4">
                            <div class="d-flex align-items-start">
                                <span class="badge bg-primary rounded-circle me-3" style="width: 24px; height: 24px; line-height: 16px;">5</span>
                                <div>
                                    <strong>ตั้งชื่อและคัดลอก URL</strong>
                                    <p class="text-muted mb-1">ตั้งชื่อให้กับ webhook (เช่น "ระบบคลินิคทันตกรรม") และคัดลอก URL ที่ได้</p>
                                </div>
                            </div>
                        </div>

                        <div class="step mb-4">
                            <div class="d-flex align-items-start">
                                <span class="badge bg-success rounded-circle me-3" style="width: 24px; height: 24px; line-height: 16px;">6</span>
                                <div>
                                    <strong>นำ URL มาใส่ในระบบ</strong>
                                    <p class="text-muted mb-1">นำ Webhook URL ที่ได้มาวางในช่อง "Google Chat Webhook URL" และกดบันทึก</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>หมายเหตุ:</strong> URL ที่ได้จะมีลักษณะเช่น:<br>
                        <code class="small">https://chat.googleapis.com/v1/spaces/AAAA.../messages?key=...&token=...</code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check me-1"></i>เข้าใจแล้ว
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
        </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <script
        src="https://cdn.datatables.net/v/bs5/dt-2.3.0/b-3.2.3/date-1.5.5/fh-4.0.1/r-3.0.4/sl-3.0.0/datatables.min.js"
        integrity="sha384-NGgUUnjETvXZrx9vJMQOG/C654mzSDv63TrMt0zQmS1HW58fN4RdjorjyZqEMIZ9" crossorigin="anonymous">
        </script>

    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/tanaikech/ResumableUploadForGoogleDrive_js@master/resumableupload_js.min.js">
        </script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        AOS.init();
        moment.locale('th');
        flatpickr.localize(flatpickr.l10ns.th);
        // Constants for UI text strings
        const UI_TEXT = {
            MESSAGES: {
                LOGIN_SUCCESS: 'เข้าสุ่ในระบบสำเร็จ',
                LOGIN_FAILED: 'เข้าสู่ระบบไม่สำเร็จ',
                LOGIN_ERROR: 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ',
                LOGOUT_SUCCESS: 'ออกจากระบบเรียบร้อย',
                LOGOUT_CONFIRM: 'ต้องการออกจากระบบ?',
                DELETE_PATIENT_CONFIRM: 'ต้องการลบข้อมูลลูกค้า?',
                DELETE_REVENUE_CONFIRM: 'ต้องการลบรายการรายได้?',
                DELETE_WARNING: 'การดำเนินการนี้ไม่สามารถย้อนกลับได้',
                NO_APPOINTMENTS_WEEK: 'ไม่มีนัดหมายในสัปดาห์นี้',
                NO_PATIENTS: 'ยังไม่มีลูกค้า',
                NO_PATIENT_DATA: 'ยังไม่มีข้อมูลลูกค้า',
                NO_REVENUE_DATA: 'ยังไม่มีข้อมูลรายได้',
                NO_APPOINTMENTS_TODAY: 'ไม่มีนัดหมายวันนี้',
                NO_APPOINTMENTS_DATE: 'ไม่มีนัดหมายในวันนี้',
                PATIENT_NOT_FOUND: 'ไม่พบข้อมูลลูกค้า',
                UPDATE_ERROR: 'เกิดข้อผิดพลาดในการอัปเดตข้อมูล',
                ADD_ERROR: 'เกิดข้อผิดพลาดในการเพิ่มข้อมูล',
                DELETE_ERROR: 'เกิดข้อผิดพลาดในการลบข้อมูล',
                APPOINTMENT_UPDATE_ERROR: 'เกิดข้อผิดพลาดในการอัปเดตการนัดหมาย',
                APPOINTMENT_ADD_ERROR: 'เกิดข้อผิดพลาดในการเพิ่มการนัดหมาย',
                REVENUE_ADD_ERROR: 'เกิดข้อผิดพลาดในการบันทึกรายได้',
                DELETE_REVENUE_ERROR: 'เกิดข้อผิดพลาดในการลบรายการ',
                DELETE_DOCTOR_CONFIRM: 'ต้องการลบข้อมูลหมอ?',
                NO_DOCTORS: 'ยังไม่มีข้อมูลหมอ',
                DOCTOR_NOT_FOUND: 'ไม่พบข้อมูลหมอ',
                DOCTOR_UPDATE_ERROR: 'เกิดข้อผิดพลาดในการอัปเดตข้อมูลหมอ',
                DOCTOR_ADD_ERROR: 'เกิดข้อผิดพลาดในการเพิ่มข้อมูลหมอ',
                DELETE_DOCTOR_ERROR: 'เกิดข้อผิดพลาดในการลบข้อมูลหมอ'
            },
            BUTTONS: {
                LOGIN: 'เข้าสู่ระบบ',
                LOGOUT: 'ออกจากระบบ',
                CANCEL: 'ยกเลิก',
                SAVE: 'บันทึก',
                DELETE: 'ลบ',
                EDIT: 'แก้ไข'
            },
            LABELS: {
                PATIENTS_TOTAL: 'ลูกค้าทั้งหมด',
                APPOINTMENTS_TODAY: 'นัดหมายวันนี้',
                REVENUE_TODAY: 'รายได้วันนี้',
                NOTIFICATIONS: 'การแจ้งเตือน',
                REVENUE_DAILY: 'รายได้วันนี้',
                REVENUE_MONTHLY: 'รายได้เดือนนี้',
                REVENUE_YEARLY: 'รายได้ปีนี้',
                BAHT: 'บาท',
                YEARS_OLD: 'ปี',
                TIME: 'เวลา',
                APPOINTMENT_DATE: 'นัดหมายวันที่',
                SELECT_PATIENT: 'เลือกลูกค้า',
                SELECT_DOCTOR: 'เลือกหมอ',
                DOCTORS_TOTAL: 'หมอทั้งหมด',
                TOMORROW_APPOINTMENT: 'นัดพรุ่งนี้ เวลา'
            },
            NAVIGATION: {
                DASHBOARD: 'หน้าหลัก',
                PATIENTS: 'จัดการลูกค้า',
                DOCTORS: 'จัดการหมอ',
                APPOINTMENTS: 'การนัดหมาย',
                REVENUE: 'รายได้รายวัน',
                REPORTS: 'รายงาน'
            },
            DAYS: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส']
        };

        // Constants for API method names
        const API_METHODS = {
            AUTHENTICATE_USER: 'authenticateUser',
            GET_ALL_PATIENTS: 'getAllPatients',
            GET_ALL_APPOINTMENTS: 'getAllAppointments',
            GET_ALL_REVENUES: 'getAllRevenues',
            GET_ALL_OPTIONS: 'getAllOptions',
            GET_ALL_USERS: 'getAllUsers',
            ADD_PATIENT: 'addPatient',
            UPDATE_PATIENT: 'updatePatient',
            DELETE_PATIENT: 'deletePatient',
            ADD_APPOINTMENT: 'addAppointment',
            UPDATE_APPOINTMENT: 'updateAppointment',
            ADD_REVENUE: 'addRevenue',
            DELETE_REVENUE: 'deleteRevenue',
            ADD_USER: 'addUser',
            UPDATE_USER: 'updateUser',
            DELETE_USER: 'deleteUser'
        };

        // Constants for DOM selectors and IDs
        const SELECTORS = {
            LOGIN_PAGE: '#loginPage',
            MAIN_APP: '#mainApp',
            LOGIN_FORM: '#loginForm',
            CURRENT_USER: '#currentUser',
            CURRENT_DATE: '#currentDate',
            TOTAL_PATIENTS: '#totalPatients',
            TOTAL_DOCTORS: '#totalDoctors',
            TODAY_APPOINTMENTS: '#todayAppointments',
            TODAY_REVENUE: '#todayRevenue',
            NOTIFICATION_BADGE: '#notificationBadge',
            NOTIFICATION_LIST: '#notificationList',
            WEEKLY_APPOINTMENTS: '#weeklyAppointments',
            RECENT_PATIENTS: '#recentPatients',
            PATIENTS_TABLE: '#patientsTable',
            PATIENT_FORM: '#patientForm',
            PATIENT_MODAL: '#patientModal',
            APPOINTMENT_FORM: '#appointmentForm',
            APPOINTMENT_MODAL: '#appointmentModal',
            REVENUE_FORM: '#revenueForm',
            REVENUE_MODAL: '#revenueModal',
            CALENDAR: '#calendar',
            CURRENT_MONTH: '#currentMonth',
            TODAY_APPOINTMENTS_LIST: '#todayAppointmentsList',
            REVENUE_TABLE: '#revenueTable',
            DAILY_REVENUE: '#dailyRevenue',
            MONTHLY_REVENUE: '#monthlyRevenue',
            YEARLY_REVENUE: '#yearlyRevenue',
            REVENUE_CHART: '#revenueChart',
            DOCTOR_FORM: '#doctorForm',
            DOCTOR_MODAL: '#doctorModal',
            USER_FORM: '#userForm',
            USER_MODAL: '#userModal',
            SUBMIT_PATIENT_BUTTON: '#savePatientButton',
            SUBMIT_APPOINTMENT_BUTTON: '#saveAppointmentButton',
            SUBMIT_REVENUE_BUTTON: '#saveRevenueButton',
            SUBMIT_DOCTOR_BUTTON: '#saveDoctorButton',
            SUBMIT_USER_BUTTON: '#saveUserButton'
        };

        // Constants for configuration values
        const CONFIG = {
            STORAGE_KEY: 'dentalUser',
            DATE_FORMAT_TH: 'th-TH',
            DATATABLES_LANG_URL: '//cdn.datatables.net/plug-ins/1.13.4/i18n/th.json',
            TOAST_TIMER: 3000,
            CALENDAR_DAYS: 42
        };

        let Toast;
        let currentUser = null;
        let currentUserType = null;
        let currentUserBranch = null;
        let currentUserRole = null;
        let patients = [];
        let doctors = [];
        let users = [];
        let appointments = [];
        let revenues = [];
        let currentMonth = new Date();

        // Option lists from Option List sheet
        let caseTypes = [];
        let caseDetails = [];
        let contactChannels = [];
        let paymentTypes = [];
        let branches = [];

        // Form tracking variables for unsaved changes warning
        let originalPatientFormData = {};
        let isPatientFormDirty = false;
        let originalAppointmentFormData = {};
        let isAppointmentFormDirty = false;
        let originalDoctorFormData = {};
        let isDoctorFormDirty = false;
        let originalRevenueFormData = {};
        let isRevenueFormDirty = false;
        let originalUserFormData = {};
        let isUserFormDirty = false;

        // Flatpickr instances
        let birthDatePicker = null;
        let appointmentDatePicker = null;
        let appointmentTimePicker = null;
        let revenueDatePicker = null;

        // Appointment status helper functions
        function getStatusIcon(status) {
            const statusIcons = {
                'scheduled': 'fas fa-clock',
                'completed': 'fas fa-check',
                'cancelled': 'fas fa-times'
            };
            return statusIcons[status] || 'fas fa-clock';
        }

        function getStatusText(status) {
            const statusTexts = {
                'scheduled': 'นัดหมาย',
                'completed': 'เสร็จสิ้น',
                'cancelled': 'ยกเลิก'
            };
            return statusTexts[status] || 'นัดหมาย';
        }

        function groupAppointmentsByStatus(appointments) {
            return appointments.reduce((groups, apt) => {
                const status = apt.status || 'scheduled';
                if (!groups[status]) {
                    groups[status] = [];
                }
                groups[status].push(apt);
                return groups;
            }, {});
        }

        // Loading progress functions
        function updateLoadingProgress(processName, completed, total) {
            const percentage = Math.round((completed / total) * 100);

            const progressBar = document.getElementById('loadingProgressBar');
            const progressLabel = document.getElementById('loadingProgressLabel');
            const progressPercentage = document.getElementById('loadingProgressPercentage');

            if (progressBar && progressLabel && progressPercentage) {
                progressBar.style.width = percentage + '%';
                progressBar.setAttribute('aria-valuenow', percentage);
                progressLabel.textContent = processName;
                progressPercentage.textContent = percentage + '%';
            }
        }

        function getLoadingProcessName(processIndex) {
            const processes = [
                'กำลังโหลดข้อมูลผู้ป่วย...',
                'กำลังโหลดข้อมูลการนัดหมาย...',
                'กำลังโหลดข้อมูลรายได้...',
                'กำลังโหลดข้อมูลแพทย์...',
                'กำลังโหลดตัวเลือกระบบ...'
            ];
            return processes[processIndex] || 'กำลังโหลดข้อมูล...';
        }

        // Revenue calculation helper function
        function calculateRevenueAmount(revenue) {
            console.log('Calculating revenue for:', revenue);
            let total = 0;

            // Add individual payment amounts (new format)
            total += (parseFloat(revenue.cash_amount) || 0);
            total += (parseFloat(revenue.transfer_amount) || 0);
            total += (parseFloat(revenue.social_security_amount) || 0);
            total += (parseFloat(revenue.visa_amount) || 0);

            // For backward compatibility with old paymentAmounts object
            if (total === 0 && revenue.payment_amounts && typeof revenue.payment_amounts === 'object') {
                Object.values(revenue.payment_amounts).forEach(amount => {
                    total += parseFloat(amount) || 0;
                });
            }

            // Add additional fees
            total += (parseFloat(revenue.xray_fee) || 0);
            total += (parseFloat(revenue.medicine_fee) || 0);
            total += (parseFloat(revenue.other_product_fee) || 0);

            // Subtract discount
            total -= (parseFloat(revenue.discount) || 0);

            // Fallback to legacy fields if new calculation results in 0
            if (total === 0) {
                total = revenue.grand_total_amount || revenue.total_amount || revenue.amount || 0;
            }

            return total;
        }

        // Initialize Toast
        Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: CONFIG.TOAST_TIMER,
            timerProgressBar: true,
        });

        $(document).ready(function () {
            NProgress.done();
            initializeApp();
        });

        function initializeApp() {
            checkLoginStatus();
            updateCurrentDate();
            setupSelect2()
            setupEventListeners();
        }

        function setupSelect2() {
            // Initialize Select2 elements for appointment form
            $(SELECTORS.APPOINTMENT_FORM + ' select[name="patientId"]').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#appointmentModal'),
                templateResult: function (option) {
                    if (!option.id) return option.text;

                    const patient = patients.find(p => p.id === option.id);
                    if (!patient) return option.text;

                    return $(`<div><strong>${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name}</strong> ${patient.last_name}</div>`);
                },
            });

            $(SELECTORS.APPOINTMENT_FORM + ' select[name="doctorId"]').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#appointmentModal'),
                templateResult: function (option) {
                    if (!option.id) return option.text;

                    const doctor = doctors.find(d => d.id === option.id);
                    if (!doctor) return option.text;

                    return $(`<div><strong>${doctor.first_name}</strong> ${doctor.last_name}</div>`);
                },
            });

            // Initialize Select2 elements for revenue form
            $(SELECTORS.REVENUE_FORM + ' select[name="patientId"]').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#revenueModal'),
                templateResult: function (option) {
                    if (!option.id) return option.text;

                    const patient = patients.find(p => p.id === option.id);
                    if (!patient) return option.text;

                    return $(`<div><strong>${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name}</strong> ${patient.last_name}</div>`);
                },
            });

            $(SELECTORS.REVENUE_FORM + ' select[name="doctorId"]').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#revenueModal'),
                templateResult: function (option) {
                    if (!option.id) return option.text;

                    const doctor = doctors.find(d => d.id === option.id);
                    if (!doctor) return option.text;

                    return $(`<div><strong>${doctor.first_name}</strong> ${doctor.last_name}</div>`);
                },
            });
        }

        function setupEventListeners() {
            // Login form
            $(SELECTORS.LOGIN_FORM).on('submit', handleLogin);

            // Logout
            $('#logoutBtn').on('click', handleLogout);

            // Navigation
            $('.nav-link[data-page]').on('click', function (e) {
                e.preventDefault();
                showPage($(this).data('page'));
            });


            // Forms
            $(SELECTORS.PATIENT_FORM).on('submit', handlePatientSubmit);
            $(SELECTORS.APPOINTMENT_FORM).on('submit', handleAppointmentSubmit);
            $(SELECTORS.REVENUE_FORM).on('submit', handleRevenueSubmit);
            $(SELECTORS.DOCTOR_FORM).on('submit', handleDoctorSubmit);
            $(SELECTORS.USER_FORM).on('submit', handleUserSubmit);

            // // Modal Submit
            $(SELECTORS.SUBMIT_PATIENT_BUTTON).on('click', () => $(SELECTORS.PATIENT_FORM).submit())
            $(SELECTORS.SUBMIT_APPOINTMENT_BUTTON).on('click', () => $(SELECTORS.APPOINTMENT_FORM).submit())
            $(SELECTORS.SUBMIT_REVENUE_BUTTON).on('click', () => $(SELECTORS.REVENUE_FORM).submit());
            $(SELECTORS.SUBMIT_DOCTOR_BUTTON).on('click', () => $(SELECTORS.DOCTOR_FORM).submit());
            $(SELECTORS.SUBMIT_USER_BUTTON).on('click', () => $(SELECTORS.USER_FORM).submit());

            // Calendar navigation
            $('#prevMonth').on('click', function () {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderCalendar();
            });

            $('#nextMonth').on('click', function () {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderCalendar();
            });

            // Set default revenue date to today
            $(`${SELECTORS.REVENUE_FORM} input[name="date"]`).val(new Date().toISOString().split('T')[0]);

            // Patient modal close button handlers
            $('#patientModal .btn-close').on('click', function (e) {
                handlePatientModalClose(e);
            });

            $('#cancelButton').on('click', function (e) {
                handlePatientModalClose(e);
            });

            // Capture form data when modal is opened for new patient
            $('#patientModal').on('shown.bs.modal', function () {
                // Small delay to ensure form is ready
                setTimeout(() => {
                    capturePatientFormData();
                }, 100);
            });

            // Reset Flatpickr when patient modal is completely hidden
            $('#patientModal').on('hidden.bs.modal', function () {
                if (birthDatePicker) {
                    birthDatePicker.clear();
                    birthDatePicker.setDate(null);
                }
                $('#patientForm').removeClass('was-validated');
            });

            $('#appointmentModal').on('hidden.bs.modal', function () {
                if (appointmentDatePicker) {
                    appointmentDatePicker.clear();
                    appointmentDatePicker.setDate(null);
                }
                if (appointmentTimePicker) {
                    appointmentTimePicker.clear();
                    appointmentTimePicker.setDate(null);
                }
                $('#appointmentForm').removeClass('was-validated');
            });

            $('#doctorModal').on('hidden.bs.modal', function () {
                $('#doctorForm').removeClass('was-validated');
            });

            $('#userModal').on('shown.bs.modal', function () {
                // Filter role options based on current user permissions
                const roleSelect = document.querySelector('#userModal select[name="role"]');
                if (roleSelect) {
                    const options = roleSelect.querySelectorAll('option');
                    options.forEach(option => {
                        if (option.value === '') return; // Keep empty option

                        if (currentUserRole === 'admin') {
                            // Admin can only create users
                            if (option.value !== 'user') {
                                option.style.display = 'none';
                            } else {
                                option.style.display = '';
                            }
                        } else if (currentUserRole === 'super_admin') {
                            // Super admin can create users and admins
                            if (option.value === 'super_admin') {
                                option.style.display = 'none';
                            } else {
                                option.style.display = '';
                            }
                        }
                    });
                }

                // Filter branch options based on current user permissions
                const branchSelect = document.querySelector('#userModal select[name="branch"]');
                if (branchSelect && currentUserRole === 'admin') {
                    // Admin can only create users in their own branch
                    branchSelect.value = currentUserBranch;
                    branchSelect.disabled = true;
                } else if (branchSelect) {
                    branchSelect.disabled = false;
                }

                // Add event listener for status switch change
                const statusSwitch = document.querySelector('#userStatus');
                const statusLabel = document.querySelector('#userModal label[for="userStatus"]');

                if (statusSwitch && statusLabel) {
                    // Remove existing event listener to avoid duplicates
                    statusSwitch.removeEventListener('change', handleUserStatusChange);
                    // Add new event listener
                    statusSwitch.addEventListener('change', handleUserStatusChange);

                    // Set initial label based on current status
                    statusLabel.textContent = statusSwitch.checked ? 'เปิดใช้งาน' : 'ปิดใช้งาน';
                }
            });

            $('#userModal').on('hidden.bs.modal', function () {
                $('#userForm').removeClass('was-validated');
            });

            $('#revenueModal').on('hidden.bs.modal', function () {
                if (revenueDatePicker) {
                    revenueDatePicker.clear();
                    revenueDatePicker.setDate(moment().toDate());
                }
                $('#revenueForm').removeClass('was-validated');
            });

            // Revenue modal close button handlers
            $('#revenueModal .btn-close').on('click', function (e) {
                handleRevenueModalClose(e);
            });

            $('#revenueModal .btn-secondary').on('click', function (e) {
                handleRevenueModalClose(e);
            });

            // Capture form data when revenue modal is opened
            $('#revenueModal').on('shown.bs.modal', function () {
                // Render case type and details options for revenue form
                if (caseTypes.length > 0) {
                    renderRevenueCaseTypeOptions();
                }
                if (caseDetails.length > 0) {
                    renderRevenueCaseDetailsOptions();
                }

                // Render payment type options for revenue form
                renderPaymentTypeOptions();

                // Load patients and doctors for revenue form
                loadPatientsForRevenue(); // Load all patients initially
                loadDoctorsForRevenue();

                // Small delay to ensure form is ready
                setTimeout(() => {
                    captureRevenueFormData();
                }, 100);
            });


            // Appointment modal close button handlers
            $('#appointmentModal .btn-close').on('click', function (e) {
                handleAppointmentModalClose(e);
            });

            $('#cancelAppointmentButton').on('click', function (e) {
                handleAppointmentModalClose(e);
            });

            // Capture form data when appointment modal is opened
            $('#appointmentModal').on('shown.bs.modal', function () {
                // Ensure options are rendered if not already
                if (caseTypes.length > 0 && $('.form-check-container').first().children().length === 0) {
                    renderCaseTypeOptions();
                    renderCaseDetailsOptions();
                }

                // Ensure contact channel options are rendered
                if (contactChannels.length > 0) {
                    renderContactChannelOptions();
                }

                // Reset patient filtering for new appointments (super_admin only)
                if (currentUserRole === 'super_admin') {
                    // If this is a new appointment (no appointmentId), reset patient list to show all
                    const form = document.querySelector(SELECTORS.APPOINTMENT_FORM);
                    if (!form.dataset.appointmentId) {
                        loadPatientsForAppointment(); // Load all patients for new appointment
                    }
                }

                // Small delay to ensure form is ready
                setTimeout(() => {
                    captureAppointmentFormData();
                }, 100);
            });

            // Reset Flatpickr when appointment modal is completely hidden
            $('#appointmentModal').on('hidden.bs.modal', function () {
                if (appointmentDatePicker) {
                    appointmentDatePicker.clear();
                    appointmentDatePicker.setDate(null);
                }
                if (appointmentTimePicker) {
                    appointmentTimePicker.clear();
                    appointmentTimePicker.setDate(null);
                }
            });

            // Note: "Other" pill functionality is now handled directly in renderCaseDetailsOptions()

            // Doctor modal close button handlers
            $('#doctorModal .btn-close').on('click', function (e) {
                handleDoctorModalClose(e);
            });

            $('#cancelDoctorButton').on('click', function (e) {
                handleDoctorModalClose(e);
            });

            // Capture form data when doctor modal is opened
            $('#doctorModal').on('shown.bs.modal', function () {
                // Small delay to ensure form is ready
                setTimeout(() => {
                    captureDoctorFormData();
                }, 100);
            });

            // Branch filter event handlers - only bind if elements exist
            const weeklyBranchFilter = document.getElementById('weeklyAppointmentsBranchFilter');
            if (weeklyBranchFilter) {
                $('#weeklyAppointmentsBranchFilter').on('change', function () {
                    renderWeeklyAppointments();
                });
            }

            const calendarBranchFilter = document.getElementById('calendarBranchFilter');
            if (calendarBranchFilter) {
                $('#calendarBranchFilter').on('change', function () {
                    renderCalendar();
                    renderTodayAppointments();
                });
            }

            const revenueBranchFilter = document.getElementById('revenueBranchFilter');
            if (revenueBranchFilter) {
                $('#revenueBranchFilter').on('change', function () {
                    renderRevenueTable();
                    updateRevenueStats();
                    renderRevenueChart();
                });
            }

            const reportsBranchFilter = document.getElementById('reportsBranchFilter');
            if (reportsBranchFilter) {
                $('#reportsBranchFilter').on('change', function () {
                    renderReports();
                });
            }

            // Phone number validation - accept only numbers and max length 10
            setupPhoneValidation();

            // Patient and branch selection event listeners for auto-filtering
            setupPatientBranchFiltering();

            // Settings event listeners
            $('#saveWebhookBtn').on('click', saveGoogleChatWebhook);
            $('#testNotificationBtn').on('click', testGoogleChatNotification);
            $('#setupInstructionsBtn').on('click', showSetupInstructions);
        }

        function setupPhoneValidation() {
            // Find all phone input fields
            const phoneInputs = document.querySelectorAll('input[name="phone"], input[type="tel"]');

            phoneInputs.forEach(function (input) {
                // Set max length
                input.setAttribute('maxlength', '10');

                // Add input event listener to filter non-numeric characters
                input.addEventListener('input', function (e) {
                    // Remove any non-digit characters
                    let value = e.target.value.replace(/\D/g, '');
                    // Limit to 10 digits
                    if (value.length > 10) {
                        value = value.substring(0, 10);
                    }
                    e.target.value = value;
                });

                // Add keypress event listener to prevent non-numeric input
                input.addEventListener('keypress', function (e) {
                    // Allow: backspace, delete, tab, escape, enter
                    if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                        // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                        (e.keyCode === 65 && e.ctrlKey === true) ||
                        (e.keyCode === 67 && e.ctrlKey === true) ||
                        (e.keyCode === 86 && e.ctrlKey === true) ||
                        (e.keyCode === 88 && e.ctrlKey === true)) {
                        return;
                    }
                    // Ensure that it is a number and stop the keypress
                    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                });

                // Add paste event listener to handle pasted content
                input.addEventListener('paste', function (e) {
                    e.preventDefault();
                    let paste = (e.clipboardData || window.clipboardData).getData('text');
                    // Remove any non-digit characters and limit to 10 digits
                    paste = paste.replace(/\D/g, '').substring(0, 10);
                    e.target.value = paste;
                });
            });
        }

        function handleUserStatusChange() {
            const statusSwitch = document.querySelector('#userStatus');
            const statusLabel = document.querySelector('#userModal label[for="userStatus"]');

            if (statusSwitch && statusLabel) {
                statusLabel.textContent = statusSwitch.checked ? 'เปิดใช้งาน' : 'ปิดใช้งาน';
            }
        }

        function setupPatientBranchFiltering() {
            // Only setup for super_admin users
            if (currentUserRole !== 'super_admin') {
                return;
            }


            $(SELECTORS.APPOINTMENT_FORM + ' select[name="patientId"]').prop('disabled', true);
            $(SELECTORS.REVENUE_FORM + ' select[name="patientId"]').prop('disabled', true);

            // Appointment form - branch selection change
            $(SELECTORS.APPOINTMENT_FORM + ' select[name="branch"]').on('change.branchFilter', function () {
                const selectedBranch = $(this).val();
                loadPatientsForAppointment(selectedBranch);
                // Clear patient selection when branch changes to avoid confusion
                $(SELECTORS.APPOINTMENT_FORM + ' select[name="patientId"]').val('').trigger('change').prop('disabled', false);
            });

            // Revenue form - branch selection change
            $(SELECTORS.REVENUE_FORM + ' select[name="branch"]').on('change.branchFilter', function () {
                const selectedBranch = $(this).val();
                loadPatientsForRevenue(selectedBranch);
                // Clear patient selection when branch changes to avoid confusion
                $(SELECTORS.REVENUE_FORM + ' select[name="patientId"]').val('').trigger('change').prop('disabled', false);
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            };
            $(SELECTORS.CURRENT_DATE).text(now.toLocaleDateString(CONFIG.DATE_FORMAT_TH, options));

            // Initialize Flatpickr instances and store references
            birthDatePicker = flatpickr('input[name="birthDate"]', {
                locale: 'th',
                dateFormat: 'Y-m-d',
                altFormat: 'd F Y',
                altInput: true,
                maxDate: 'today',
            });

            appointmentDatePicker = flatpickr('input[name="appointmentDate"]', {
                locale: 'th',
                dateFormat: 'Y-m-d',
                altFormat: 'd F Y',
                altInput: true,
                minDate: 'today'
            });

            appointmentTimePicker = flatpickr('input[name="appointmentTime"]', {
                enableTime: true,
                noCalendar: true,
                dateFormat: 'H:i',
                time_24hr: true,
                defaultHour: 9,
                defaultMinute: 0,
                minuteIncrement: 15
            });

            revenueDatePicker = flatpickr('input[name="date"]', {
                locale: 'th',
                dateFormat: 'Y-m-d',
                altFormat: 'd F Y',
                altInput: true,
                defaultDate: 'today'
            });
        }

        function checkLoginStatus() {
            // In a real app, check session storage or cookies
            const savedUser = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                if (new Date().getTime() > userData.expired) {
                    localStorage.removeItem(CONFIG.STORAGE_KEY);
                    showLoginPage();
                    return;
                }
                currentUser = userData.username;
                currentUserType = userData.type;
                currentUserBranch = userData.branch;
                currentUserRole = userData.role;
                console.log('Login until:', moment(userData.expired).format('LLLL'));
                showMainApp();
            } else {
                showLoginPage();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const showLoginLoading = () => {
                NProgress.start();
                $(e.target).find('button[type="submit"]').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังเข้าสู่ระบบ...');
            }
            const hideLoginLoading = () => {
                NProgress.done();
                $(e.target).find('button[type="submit"]').prop('disabled', false).html('เข้าสู่ระบบ');
            }
            const loginForm = e.target;
            const formData = new FormData(loginForm);
            const username = $('#username').val().trim();
            const password = $('#password').val().trim();

            if (!username || !password) {
                Toast.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน'
                });
                return;
            }
            showLoginLoading();
            // Call Google Apps Script backend
            google.script.run
                .withSuccessHandler(function (result) {
                    hideLoginLoading();
                    if (result.success) {
                        currentUser = result.user.username;
                        currentUserType = result.user.userType;
                        currentUserBranch = result.user.branch;
                        currentUserRole = result.user.role;

                        // Save to localStorage
                        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
                            username: result.user.username,
                            type: result.user.userType,
                            branch: result.user.branch,
                            role: result.user.role,
                            fullName: result.user.fullName,
                            expired: new Date().getTime() + (8 * 60 * 60 * 1000) // 2 hours expiry
                        }));
                        console.log('Login until:', moment(new Date().getTime() + (8 * 60 * 60 * 1000)).format('LLLL'));

                        showMainApp();
                        Toast.fire({
                            icon: 'success',
                            title: UI_TEXT.MESSAGES.LOGIN_SUCCESS
                        });
                    } else {
                        Toast.fire({
                            icon: 'error',
                            title: result.message || UI_TEXT.MESSAGES.LOGIN_FAILED
                        });
                    }
                    NProgress.done();
                })
                .withFailureHandler(function (error) {
                    hideLoginLoading();
                    console.error('Login error:', error);
                    Toast.fire({
                        icon: 'error',
                        title: UI_TEXT.MESSAGES.LOGIN_ERROR
                    });
                    NProgress.done();
                })
            [API_METHODS.AUTHENTICATE_USER](username, password);
        }

        function handleLogout() {
            event.preventDefault();
            Swal.fire({
                title: UI_TEXT.MESSAGES.LOGOUT_CONFIRM,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#30308b',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: UI_TEXT.BUTTONS.LOGOUT,
                cancelButtonText: UI_TEXT.BUTTONS.CANCEL,
                customClass: {
                    confirmButton: 'btn btn-danger',
                    cancelButton: 'btn btn-secondary',
                    popup: 'rounded-4',
                },
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem(CONFIG.STORAGE_KEY);
                    currentUser = null;
                    currentUserType = null;
                    currentUserBranch = null;
                    currentUserRole = null;
                    showLoginPage();
                    Toast.fire({
                        icon: 'success',
                        title: UI_TEXT.MESSAGES.LOGOUT_SUCCESS
                    });
                }
            });
        }

        function showLoginPage() {
            $(SELECTORS.LOGIN_PAGE).removeClass('hidden');
            $(SELECTORS.MAIN_APP).addClass('hidden');

            // hide loading page if still visible
            hideLoadingPage();
        }

        function showMainApp() {
              // Load data and show dashboard
            loadData();
            // Ensure loading page is visible during data loading
            const loadingPage = document.getElementById('loadingPage');
            if (loadingPage) {
                loadingPage.classList.remove('fade-out');
                loadingPage.style.display = 'flex';
            }

            // Update user display
            $(SELECTORS.CURRENT_USER).text(currentUser);

            // Update user info display
            updateUserInfoDisplay();

            // Show/hide admin features
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                if (currentUserRole === 'admin' || currentUserRole === 'super_admin') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });

            // Show/hide super-admin-only features
            const superAdminElements = document.querySelectorAll('.super-admin-only, .super-admin-only-filter');
            superAdminElements.forEach(el => {
                if (currentUserRole === 'super_admin') {
                    el.classList.add('show');
                    el.style.display = '';
                } else {
                    el.classList.remove('show');
                    el.style.display = 'none';
                }
            });

            // Handle branch field required attributes based on user role
            const branchFields = document.querySelectorAll('select[name="branch"]');
            branchFields.forEach(field => {
                if (currentUserRole === 'super_admin') {
                    field.setAttribute('required', '');
                } else {
                    field.removeAttribute('required');
                }
            });

          

        }

        function updateUserInfoDisplay() {
            // Function to get Thai role name
            const getRoleDisplayName = (role) => {
                switch (role) {
                    case 'super_admin': return 'ผู้ดูแลระบบ';
                    case 'admin': return 'ผู้จัดการ';
                    case 'user': return 'ผู้ใช้';
                    default: return role || '-';
                }
            };

            // Function to get Thai branch name
            const getBranchDisplayName = (branch) => {
                console.log("🚀 ~ getBranchDisplayName ~ branch:", branch)
                const branchObj = branches.find(b => b.id === branch);
                return branchObj ? branchObj.name : (branch || '-');
            };

            // Update user info in navbar
            const branchDisplay = getBranchDisplayName(currentUserBranch);
            const roleDisplay = getRoleDisplayName(currentUserRole);

            $('#userInfo').text(`${branchDisplay} • ${roleDisplay}`);
            $('#userBranch').text(branchDisplay);
            $('#userRole').text(roleDisplay);
        }

        function showPage(pageName) {
            // Hide all pages
            $('.page-content').addClass('hidden');

            // Update navigation
            $('.nav-link').removeClass('active');

            // Show selected page
            $('#' + pageName + 'Page').removeClass('hidden');
            $(`[data-page="${pageName}"]`).addClass('active');

            // Load page-specific data
            switch (pageName) {
                case 'dashboard':
                    updateDashboard();
                    renderWeeklyAppointments();
                    break;
                case 'patients':
                    renderPatientsTable();
                    break;
                case 'appointments':
                    renderCalendar();
                    renderTodayAppointments();
                    break;
                case 'doctors':
                    loadDoctors();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'revenue':
                    renderRevenueChart();
                    renderRevenueTable();
                    updateRevenueStats();
                    break;
                case 'reports':
                    if (currentUserType !== 'user') {
                        renderReports();
                    }
                    break;
                case 'settings':
                    if (currentUserRole === 'super_admin') {
                        loadSettingsPage();
                    }
                    break;
            }
        }

        function loadData() {
            NProgress.start();

            // Initialize loading counter - check if user management should be included
            const shouldLoadUsers = (currentUserRole === 'admin' || currentUserRole === 'super_admin');
            window.loadingCounter = {
                total: shouldLoadUsers ? 6 : 5, // patients, appointments, revenues, doctors, options, users (if admin+)
                completed: 0
            };

            // Initialize progress bar
            updateLoadingProgress('เริ่มต้นโหลดข้อมูล...', 0, window.loadingCounter.total);
            loadPatients();
            loadAppointments();
            loadRevenues();
            loadDoctors();
            loadOptions();

            // Load users only for admin and super_admin
            if (shouldLoadUsers) {
                loadUsers();
            }
        }

        function checkLoadingComplete() {
            window.loadingCounter.completed++;

            // Update progress bar
            updateLoadingProgress(
                window.loadingCounter.completed >= window.loadingCounter.total ?
                    'โหลดข้อมูลเสร็จสิ้น!' :
                    `กำลังประมวลผล... (${window.loadingCounter.completed}/${window.loadingCounter.total})`,
                window.loadingCounter.completed,
                window.loadingCounter.total
            );

            if (window.loadingCounter.completed >= window.loadingCounter.total) {
                // All data loaded, show completion message briefly then hide loading page
                setTimeout(() => {
                    updateLoadingProgress('เตรียมเข้าสู่ระบบ...', window.loadingCounter.total, window.loadingCounter.total);
                }, 200);

                setTimeout(() => {
                    $(SELECTORS.LOGIN_PAGE).addClass('hidden');
                    $(SELECTORS.MAIN_APP).removeClass('hidden');
                    hideLoadingPage();

                    // Setup patient-branch filtering after all data is loaded
                    setupPatientBranchFiltering();
                    showPage('dashboard');
                }, 200); // Longer delay to show completion
            }
        } function hideLoadingPage() {
            const loadingPage = document.getElementById('loadingPage');
            if (loadingPage) {
                loadingPage.classList.add('fade-out');
                setTimeout(() => {
                    loadingPage.style.display = 'none';
                }, 500); // Match the CSS transition duration
            }
            NProgress.done();
        }

        function loadPatients(needToCheck = true) {
            google.script.run
                .withSuccessHandler(function (result) {
                    result = JSON.parse(result);
                    if (result.success) {
                        patients = result.patients || [];
                        renderPatientsTable();
                        updateDashboard();
                        // Update progress with success message
                        setTimeout(() => {
                            updateLoadingProgress(`โหลดข้อมูลผู้ป่วยสำเร็จ (${patients.length} รายการ)`, window.loadingCounter.completed, window.loadingCounter.total);
                        }, 100);
                    } else {
                        console.error('Error loading patients:', result.message);
                        patients = [];
                    }
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Failed to load patients:', error);
                    patients = [];
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
            [API_METHODS.GET_ALL_PATIENTS]({
                branch: currentUserBranch,
                role: currentUserRole
            });
        }

        function loadAppointments(needToCheck = true) {
            google.script.run
                .withSuccessHandler(function (result) {
                    result = JSON.parse(result);
                    console.log('Appointments loaded:', result);
                    if (result.success) {
                        appointments = result.appointments || [];
                        renderCalendar();
                        renderTodayAppointments();
                        renderWeeklyAppointments();
                        updateDashboard();
                        // Update progress with success message
                        setTimeout(() => {
                            updateLoadingProgress(`โหลดข้อมูลการนัดหมายสำเร็จ (${appointments.length} รายการ)`, window.loadingCounter.completed, window.loadingCounter.total);
                        }, 100);
                    } else {
                        console.error('Error loading appointments:', result.message);
                        appointments = [];
                    }
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Failed to load appointments:', error);
                    appointments = [];
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
            [API_METHODS.GET_ALL_APPOINTMENTS]({
                branch: currentUserBranch,
                role: currentUserRole
            });
        }

        function loadRevenues(needToCheck = true) {
            google.script.run
                .withSuccessHandler(function (result) {
                    result = JSON.parse(result);
                    if (result.success) {
                        revenues = result.revenues || [];
                        renderRevenueTable();
                        updateRevenueStats();
                        renderRevenueChart();
                        updateDashboard();
                        // Update progress with success message
                        setTimeout(() => {
                            updateLoadingProgress(`โหลดข้อมูลรายได้สำเร็จ (${revenues.length} รายการ)`, window.loadingCounter.completed, window.loadingCounter.total);
                        }, 100);
                    } else {
                        console.error('Error loading revenues:', result.message);
                        revenues = [];
                    }
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Failed to load revenues:', error);
                    revenues = [];
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
            [API_METHODS.GET_ALL_REVENUES]({
                branch: currentUserBranch,
                role: currentUserRole
            });
        }

        // Doctor management functions
        function loadDoctors(needToCheck = true) {
            console.log(currentUser)
            google.script.run
                .withSuccessHandler(function (result) {
                    result = JSON.parse(result);
                    if (result.success) {
                        doctors = result.doctors || [];
                        renderDoctorsTable();
                        updateDashboard();
                        loadDoctorsForAppointment();
                        // Update progress with success message
                        setTimeout(() => {
                            updateLoadingProgress(`โหลดข้อมูลแพทย์สำเร็จ (${doctors.length} รายการ)`, window.loadingCounter.completed, window.loadingCounter.total);
                        }, 100);
                    } else {
                        Toast.fire({
                            icon: 'error',
                            title: result.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูลหมอ'
                        });
                        doctors = [];
                    }
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error loading doctors:', error);
                    Toast.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                    });
                    doctors = [];
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
                .getAllDoctors({
                    branch: currentUserBranch,
                    role: currentUserRole
                });
        }

        // User management functions
        function loadUsers(needToCheck = true) {
            google.script.run
                .withSuccessHandler(function (result) {
                    result = JSON.parse(result);
                    if (result.success) {
                        users = result.users || [];
                        renderUsersTable();
                        // Update progress with success message
                        setTimeout(() => {
                            updateLoadingProgress(`โหลดข้อมูลผู้ใช้สำเร็จ (${users.length} รายการ)`, window.loadingCounter.completed, window.loadingCounter.total);
                        }, 100);
                    } else {
                        Toast.fire({
                            icon: 'error',
                            title: result.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้'
                        });
                        users = [];
                    }
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error loading users:', error);
                    Toast.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                    });
                    users = [];
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
            [API_METHODS.GET_ALL_USERS]({
                username: currentUser,
                branch: currentUserBranch,
                role: currentUserRole
            });
        }

        function loadOptions(needToCheck = true) {
            google.script.run
                .withSuccessHandler(function (result) {
                    result = JSON.parse(result);
                    console.log('Options loaded:', result);
                    if (result.success) {
                        caseTypes = result.options.caseTypes || [];
                        caseDetails = result.options.caseDetails || [];
                        contactChannels = result.options.contactChannels || [];
                        paymentTypes = result.options.paymentTypes || [];
                        branches = result.options.branches || [];
                        renderCaseTypeOptions();
                        renderCaseDetailsOptions();
                        renderContactChannelOptions();
                        renderPaymentTypeOptions();
                        renderBranchOptions();
                        // Update progress with success message
                        setTimeout(() => {
                            updateLoadingProgress(`โหลดตัวเลือกระบบสำเร็จ`, window.loadingCounter.completed, window.loadingCounter.total);
                        }, 100);
                    } else {
                        console.error('Failed to load options:', result.message);
                        Toast.fire({
                            icon: 'error',
                            title: result.message || 'เกิดข้อผิดพลาดในการโหลดตัวเลือก'
                        });
                    }
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error loading options:', error);
                    Toast.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                    });
                    if (needToCheck) {
                        checkLoadingComplete();
                    }
                })
            [API_METHODS.GET_ALL_OPTIONS]();
        }

        function renderCaseTypeOptions() {
            const $container = $('.form-check-container').first(); // Case type container

            if (caseTypes.length === 0) {
                $container.html('<div class="text-muted">ไม่พบตัวเลือกประเภทเคส</div>');
                return;
            }

            const html = caseTypes.map((option, index) => `
                    <span class="badge case-type-pill pill-option" 
                        data-value="${option.value}" 
                        data-name="caseType">
                        ${option.value}
                    </span>
                `).join('');

            // Add hidden inputs to store selected values
            const hiddenInputsHtml = '<div class="case-type-hidden-inputs"></div>';

            $container.html(html + hiddenInputsHtml);

            // Add click event handlers for pills
            $container.find('.case-type-pill').on('click', function () {
                const $pill = $(this);
                const value = $pill.data('value');
                const isSelected = $pill.hasClass('selected');

                if (isSelected) {
                    // Deselect
                    $pill.removeClass('selected');
                    // Remove hidden input
                    $container.find(`.case-type-hidden-inputs input[value="${value}"]`).remove();
                } else {
                    // Select
                    $pill.addClass('selected');
                    // Add hidden input
                    $container.find('.case-type-hidden-inputs').append(
                        `<input type="hidden" name="caseType" value="${value}">`
                    );
                }
            });
        }

        function renderCaseDetailsOptions() {
            const $container = $('.form-check-container').eq(1); // Case details container

            if (caseDetails.length === 0) {
                $container.html('<div class="text-muted">ไม่พบตัวเลือกรายละเอียดเคส</div>');
                return;
            }

            const html = caseDetails.map((option, index) => `
                    <span class="badge case-details-pill pill-option" 
                        data-value="${option.value}" 
                        data-name="caseDetails">
                        ${option.value}
                    </span>
                `).join('');

            // Add hidden inputs container
            const hiddenInputsHtml = '<div class="case-details-hidden-inputs"></div>';

            $container.html(html + hiddenInputsHtml);

            // Add click event handlers for pills
            $container.find('.case-details-pill').on('click', function () {
                const $pill = $(this);
                const value = $pill.data('value');
                const isSelected = $pill.hasClass('selected');

                if (isSelected) {
                    // Deselect
                    $pill.removeClass('selected');

                    // Remove hidden input
                    $container.find(`.case-details-hidden-inputs input[value="${value}"]`).remove();
                } else {
                    // Select
                    $pill.addClass('selected');

                    // Add hidden input
                    $container.find('.case-details-hidden-inputs').append(
                        `<input type="hidden" name="caseDetails" value="${value}">`
                    );
                }
            });
        }

        function renderContactChannelOptions() {
            const $select = $('select[name="contactChannel"]');

            if (contactChannels.length === 0) {
                $select.html('<option value="">ไม่พบตัวเลือกช่องทางการติดต่อ</option>');
                return;
            }

            // Build options HTML
            let optionsHtml = '<option value="">เลือกช่องทางการติดต่อ</option>';
            optionsHtml += contactChannels.map(channel =>
                `<option value="${channel.value}">${channel.value}</option>`
            ).join('');

            $select.html(optionsHtml);
        }

        function renderPaymentTypeOptions() {
            const $select = $('select[name="contactChannel"]');

            // Hardcoded payment types - no longer reading from sheet
            const hardcodedPaymentTypes = [
                { value: 'เงินสด' },
                { value: 'เงินโอน' },
                { value: 'ประกันสังคม' },
                { value: 'Visa' }
            ];

            // Always use hardcoded payment types
            paymentTypes = hardcodedPaymentTypes;

            const $container = $('#revenuePaymentTypeContainer');

            const html = paymentTypes.map((option, index) => `
                <span class="badge payment-type-pill pill-option" data-value="${option.value}" style="cursor: pointer;">
                    ${option.value}
                </span>
            `).join('');

            // Add hidden inputs container
            const hiddenInputsHtml = '<div class="payment-type-hidden-inputs"></div>';

            $container.html(html + hiddenInputsHtml);

            // Add click event handlers for pills
            $container.find('.payment-type-pill').on('click', function () {
                const $pill = $(this);
                const value = $pill.data('value');
                const isSelected = $pill.hasClass('selected');

                if (isSelected) {
                    // Deselect
                    $pill.removeClass('selected');

                    // Remove hidden input
                    $container.find(`.payment-type-hidden-inputs input[value="${value}"]`).remove();
                } else {
                    // Select
                    $pill.addClass('selected');

                    // Add hidden input
                    $container.find('.payment-type-hidden-inputs').append(
                        `<input type="hidden" name="paymentType" value="${value}">`
                    );
                }

                // Update payment amount fields based on selected payment types
                updatePaymentAmountFields();
            });
        }

        function updatePaymentAmountFields() {
            // Get currently selected payment types
            const selectedPaymentTypes = [];
            $('#revenuePaymentTypeContainer input[name="paymentType"]').each(function () {
                selectedPaymentTypes.push($(this).val());
            });

            renderPaymentAmountFields(selectedPaymentTypes);
        }

        function renderPaymentAmountFields(selectedPaymentTypes) {
            const $container = $('#paymentAmountFields');
            const $section = $('#paymentAmountSection');

            if (selectedPaymentTypes.length === 0) {
                $section.hide();
                return;
            }

            $section.show();

            // Define payment type mappings to match backend column names
            const paymentTypeFields = {
                'เงินสด': { label: 'ยอดชำระเงินสด', name: 'cashAmount' },
                'เงินโอน': { label: 'ยอดชำระเงินโอน', name: 'transferAmount' },
                'ประกันสังคม': { label: 'ยอดชำระประกันสังคม', name: 'socialSecurityAmount' },
                'Visa': { label: 'ยอดชำระ Visa', name: 'visaAmount' }
            };

            let fieldsHtml = '';
            selectedPaymentTypes.forEach((paymentType, index) => {
                const fieldConfig = paymentTypeFields[paymentType];
                if (fieldConfig) {
                    const colClass = selectedPaymentTypes.length <= 2 ? 'col-md-6' : 'col-md-4';

                    fieldsHtml += `
                        <div class="${colClass}">
                            <div class="mb-3">
                                <label class="form-label">${fieldConfig.label} (บาท)</label>
                                <input type="number" class="form-control" name="${fieldConfig.name}" min="0" step="0.01">
                            </div>
                        </div>
                    `;
                }
            });

            $container.html(fieldsHtml);

        }

        function renderBranchOptions() {
            // Update branch select fields in all forms
            const branchSelects = document.querySelectorAll('select[name="branch"]');

            branchSelects.forEach(select => {
                // Store current value to restore after populating options
                const currentValue = select.value;

                // Build options HTML
                let optionsHtml = '<option value="">เลือกสาขา</option>';
                console.log('branches:', branches);
                if (branches.length > 0) {
                    optionsHtml += branches.map(branch =>
                        `<option value="${branch}">${branch}</option>`
                    ).join('');
                } else {
                    // Fallback to default branches if no data from sheet
                    const defaultBranches = [
                        { value: 'HEAD_OFFICE', displayName: 'สำนักงานใหญ่' },
                        { value: 'BRANCH_01', displayName: 'สาขาที่ 1' },
                        { value: 'BRANCH_02', displayName: 'สาขาที่ 2' },
                        { value: 'BRANCH_03', displayName: 'สาขาที่ 3' },
                        { value: 'BRANCH_04', displayName: 'สาขาที่ 4' },
                        { value: 'BRANCH_05', displayName: 'สาขาที่ 5' }
                    ];
                    optionsHtml += defaultBranches.map(branch =>
                        `<option value="${branch.value}">${branch.displayName}</option>`
                    ).join('');
                }

                select.innerHTML = optionsHtml;

                // Restore previous value if it exists in the new options
                if (currentValue) {
                    select.value = currentValue;
                }
            });

            // Update branch filter dropdowns
            updateBranchFilterDropdowns();
        }

        function updateBranchFilterDropdowns() {
            const filterDropdowns = [
                '#weeklyAppointmentsBranchFilter',
                '#calendarBranchFilter',
                '#notificationBranchFilter',
                '#revenueBranchFilter',
                '#reportsBranchFilter'
            ];

            filterDropdowns.forEach(selector => {
                const dropdown = document.querySelector(selector);
                if (dropdown) {
                    const currentValue = dropdown.value;

                    let optionsHtml = '<option value="">ทุกสาขา</option>';

                    if (branches.length > 0) {
                        optionsHtml += branches.map(branch =>
                            `<option value="${branch.value}">${branch.displayName}</option>`
                        ).join('');
                    } else {
                        // Fallback to default branches if no data from sheet
                        const defaultBranches = [
                            { value: 'HEAD_OFFICE', displayName: 'สำนักงานใหญ่' },
                            { value: 'BRANCH_01', displayName: 'สาขาที่ 1' },
                            { value: 'BRANCH_02', displayName: 'สาขาที่ 2' },
                            { value: 'BRANCH_03', displayName: 'สาขาที่ 3' },
                            { value: 'BRANCH_04', displayName: 'สาขาที่ 4' },
                            { value: 'BRANCH_05', displayName: 'สาขาที่ 5' }
                        ];
                        optionsHtml += defaultBranches.map(branch =>
                            `<option value="${branch.value}">${branch.displayName}</option>`
                        ).join('');
                    }

                    dropdown.innerHTML = optionsHtml;

                    // Restore previous value if it exists in the new options
                    if (currentValue) {
                        dropdown.value = currentValue;
                    }
                }
            });
        }

        function loadPatientsForRevenue(filterBranch = null) {
            const $select = $(`${SELECTORS.REVENUE_FORM} select[name="patientId"]`);

            // Filter patients by branch if specified
            let filteredPatients = patients;
            if (filterBranch && currentUserRole === 'super_admin') {
                filteredPatients = patients.filter(patient => patient.branch === filterBranch);
            }

            const options = filteredPatients.map(patient =>
                `<option value="${patient.id}">${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}</option>`
            ).join('');

            $select.html(`<option value="">เลือกลูกค้า</option>` + options);

            // Trigger Select2 to refresh
            $select.trigger('change');
        }

        function loadDoctorsForRevenue() {
            const $select = $(`${SELECTORS.REVENUE_FORM} select[name="doctorId"]`);
            const options = doctors.map(doctor =>
                `<option value="${doctor.id}">${doctor.first_name} ${doctor.last_name}</option>`
            ).join('');

            $select.html(`<option value="">เลือกหมอ</option>` + options);
        }

        function renderRevenueCaseTypeOptions() {
            const $container = $('#revenueCaseTypeContainer');

            if (caseTypes.length === 0) {
                $container.html('<p class="text-muted">ไม่พบตัวเลือกประเภทเคส</p>');
                return;
            }

            const html = caseTypes.map((option, index) => `
                <span class="badge case-type-pill pill-option" data-value="${option.value}" style="cursor: pointer;">
                    ${option.value}
                </span>
            `).join('');

            // Add hidden inputs to store selected values
            const hiddenInputsHtml = '<div class="case-type-hidden-inputs"></div>';

            $container.html(html + hiddenInputsHtml);

            // Add click event handlers for pills
            $container.find('.case-type-pill').on('click', function () {
                const $pill = $(this);
                const value = $pill.data('value');
                const isSelected = $pill.hasClass('selected');

                if (isSelected) {
                    // Deselect
                    $pill.removeClass('selected');
                    $container.find(`.case-type-hidden-inputs input[value="${value}"]`).remove();
                } else {
                    // Select
                    $pill.addClass('selected');
                    $container.find('.case-type-hidden-inputs').append(
                        `<input type="hidden" name="caseType" value="${value}">`
                    );
                }
            });
        }

        function renderRevenueCaseDetailsOptions() {
            const $container = $('#revenueCaseDetailsContainer');

            if (caseDetails.length === 0) {
                $container.html('<p class="text-muted">ไม่พบตัวเลือกรายละเอียดเคส</p>');
                return;
            }

            const html = caseDetails.map((option, index) => `
                <span class="badge case-details-pill pill-option" data-value="${option.value}" style="cursor: pointer;">
                    ${option.value}
                </span>
            `).join('');

            // Add hidden inputs container
            const hiddenInputsHtml = '<div class="case-details-hidden-inputs"></div>';

            $container.html(html + hiddenInputsHtml);

            // Add click event handlers for pills
            $container.find('.case-details-pill').on('click', function () {
                const $pill = $(this);
                const value = $pill.data('value');
                const isSelected = $pill.hasClass('selected');

                if (isSelected) {
                    // Deselect
                    $pill.removeClass('selected');

                    // Remove hidden input
                    $container.find(`.case-details-hidden-inputs input[value="${value}"]`).remove();
                } else {
                    // Select
                    $pill.addClass('selected');

                    // Add hidden input
                    $container.find('.case-details-hidden-inputs').append(
                        `<input type="hidden" name="caseDetails" value="${value}">`
                    );
                }
            });
        }

        function renderDoctorsTable() {
            const $table = $('#doctorsTable tbody');

            if (doctors.length === 0) {
                $table.html(`<tr><td colspan="6" class="text-center text-muted">${UI_TEXT.MESSAGES.NO_DOCTORS}</td></tr>`);
                return;
            }

            const rows = doctors.map(doctor => `
                    <tr>
                        <td>${doctor.id}</td>
                        <td>${doctor.first_name} ${doctor.last_name}</td>
                        <td>${doctor.specialty}</td>
                        <td>${doctor.phone}</td>
                        <td>${doctor.email || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editDoctor('${doctor.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor('${doctor.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

            $table.html(rows);
        }



        function updateDashboard() {
            // Update statistics
            $(SELECTORS.TOTAL_PATIENTS).text(patients.length);
            $(SELECTORS.TOTAL_DOCTORS).text(doctors.length);

            const today = moment().format('YYYY-MM-DD');
            const todayAppts = appointments.filter(apt => moment(apt.appointment_date).format('YYYY-MM-DD') === today);
            $(SELECTORS.TODAY_APPOINTMENTS).text(todayAppts.length);

            // Calculate today's revenue with the new method
            const todayRevenues = revenues.filter(rev => moment(rev.date).format('YYYY-MM-DD') === today);
            const todayRev = todayRevenues.reduce((sum, rev) => sum + calculateRevenueAmount(rev), 0);
            $(SELECTORS.TODAY_REVENUE).text(todayRev.toLocaleString() + ` ${UI_TEXT.LABELS.BAHT}`);

            $(SELECTORS.TOTAL_NOTIFICATIONS).text(todayAppts.length);

            // Update recent activities
            renderWeeklyAppointments();
            loadPatientsForAppointment();
            loadDoctorsForAppointment();
            renderRecentPatients();
            updateNotifications();
        }

        function renderWeeklyAppointments() {
            const $container = $(SELECTORS.WEEKLY_APPOINTMENTS);
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());

            // Get selected branch filter
            const selectedBranch = document.querySelector('#weeklyAppointmentsBranchFilter')?.value || '';

            const weeklyAppts = appointments.filter(apt => {
                const aptDate = new Date(apt.appointment_date);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);

                // Filter by date range
                const dateMatch = aptDate >= weekStart && aptDate <= weekEnd;

                // Filter by branch if selected
                const branchMatch = !selectedBranch || apt.branch === selectedBranch;

                return dateMatch && branchMatch;
            });

            if (weeklyAppts.length === 0) {
                $container.html(`<p class="text-muted">${UI_TEXT.MESSAGES.NO_APPOINTMENTS_WEEK}</p>`);
                return;
            }

            const html = weeklyAppts.map(apt => {
                const patient = patients.find(p => p.id === apt.patient_id);
                const doctor = doctors.find(d => d.id === apt.doctor_id);
                const patientName = patient ? `${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}` : UI_TEXT.MESSAGES.PATIENT_NOT_FOUND;
                const doctorName = doctor ? `แพทย์ : ${doctor.first_name} ${doctor.last_name}` : 'ไม่ระบุหมอ';
                const status = apt.status || 'scheduled';
                const statusText = getStatusText(status);
                const aptDate = new Date(apt.appointment_date);
                const dateStr = aptDate.toLocaleDateString(CONFIG.DATE_FORMAT_TH, {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short'
                });

                // Get branch display name
                const branch = branches.find(b => b.value === apt.branch);
                const branchName = branch ? `สาขา : ${branch.displayName || apt.branch}` : 'ไม่ระบุสาขา';

                return `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <div class="fw-bold">${patientName}</div>
                                <div><small class="text-secondary">${doctorName}</small></div>
                                <div><small class="text-muted">${branchName}</small></div>
                            </div>
                            <div class="text-end">
                                <div class="small">${dateStr}</div>
                                <div class="small text-primary">${apt.appointment_time} น.</div>
                                <small class="badge ${status}">${statusText}</small>
                            </div>
                        </div>
                    `;
            }).join('');

            $container.html(html);
        }

        function renderRecentPatients() {
            const $container = $(SELECTORS.RECENT_PATIENTS);
            const recentPatients = patients.slice(-5).reverse();

            if (recentPatients.length === 0) {
                $container.html(`<p class="text-muted">${UI_TEXT.MESSAGES.NO_PATIENTS}</p>`);
                return;
            }

            const html = recentPatients.map(patient => {
                const regDate = new Date(patient.registration_date);
                const dateStr = regDate.toLocaleDateString(CONFIG.DATE_FORMAT_TH);

                // Gender icon
                let genderIcon = '';
                if (patient.gender === 'ชาย') {
                    genderIcon = '<i class="fas fa-mars text-primary" title="ชาย"></i>';
                } else if (patient.gender === 'หญิง') {
                    genderIcon = '<i class="fas fa-venus text-danger" title="หญิง"></i>';
                } else {
                    genderIcon = '<i class="fas fa-genderless text-secondary" title="ไม่ระบุ"></i>';
                }

                return `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <div class="fw-bold">
                                    ${genderIcon} ${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}
                                </div>
                                <small class="text-muted">${patient.phone}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">${dateStr}</small>
                            </div>
                        </div>
                    `;
            }).join('');

            $container.html(html);
        }

        function renderPatientsTable() {
            const $tbody = $(`${SELECTORS.PATIENTS_TABLE} tbody`);

            // Initialize DataTable if not already initialized
            if ($.fn.DataTable.isDataTable(SELECTORS.PATIENTS_TABLE)) {
                $(SELECTORS.PATIENTS_TABLE).DataTable().destroy()
            }

            if (patients.length === 0) {
                $tbody.html(`<tr><td colspan="6" class="text-center text-muted">${UI_TEXT.MESSAGES.NO_PATIENT_DATA}</td></tr>`);
                return;
            }



            const html = patients.map(patient => {
                const birthDate = new Date(patient.birth_date);
                const age = new Date().getFullYear() - birthDate.getFullYear();
                const regDate = new Date(patient.registration_date).toLocaleDateString(CONFIG.DATE_FORMAT_TH);

                // Gender icon
                let genderIcon = '';
                if (patient.gender === 'ชาย') {
                    genderIcon = '<i class="fas fa-mars text-primary me-1" title="ชาย"></i>';
                } else if (patient.gender === 'หญิง') {
                    genderIcon = '<i class="fas fa-venus text-danger me-1" title="หญิง"></i>';
                } else {
                    genderIcon = '<i class="fas fa-genderless text-secondary me-1" title="ไม่ระบุ"></i>';
                }

                return `
                        <tr>
                            <td>${patient.id}</td>
                            <td>${genderIcon}${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}</td>
                            <td>${patient.phone}</td>
                            <td>${age} ${UI_TEXT.LABELS.YEARS_OLD}</td>
                            <td>${regDate}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editPatient('${patient.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deletePatient('${patient.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
            }).join('');

            $tbody.html(html);
            $(SELECTORS.PATIENTS_TABLE).DataTable({
                language: {
                    url: CONFIG.DATATABLES_LANG_URL
                },
                responsive: true,
                order: [0, 'desc'],
                columnDefs: [
                    { orderable: false, targets: 5 },
                    { className: 'dt-head-nowrap dt-head-center dt-body-nowrap', targets: '_all' },
                    { className: 'dt-body-left', targets: 1 },
                    { className: 'dt-body-center text-center', targets: [0, 2, 3, 4, 5] }
                ]
            });
        }

        function handlePatientSubmit(e) {
            e.preventDefault();
            if (!e.target.checkValidity()) {
                e.target.classList.add('was-validated');
                Toast.fire({
                    icon: 'error',
                    title: 'กรุณากรอกข้อมูลให้ครบถ้วนตามที่กำหนด'
                });
                $(e.target).find(':invalid')[0].focus();
                return;
            } else {
                e.target.classList.remove('was-validated');
            }
            const showPatientLoading = () => {
                NProgress.start();
                Swal.fire({
                    iconHtml: '<i class="bi-hourglass-split text-primary"></i>',
                    title: 'กำลังบันทึกข้อมูล...',
                    allowOutsideClick: false,
                    confirmButtonColor: '#30308b',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: true,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: ' rounded-4',
                        icon: 'border-0'
                    }
                });
            }
            const hidePatientLoading = () => {
                NProgress.done();
                Swal.close();
            }
            const formData = new FormData(e.target);

            const patientData = {
                titlePrefix: formData.get('titlePrefix'),
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                phone: formData.get('phone'),
                birthDate: formData.get('birthDate'),
                gender: formData.get('gender'),
                address: formData.get('address'),
                allergies: formData.get('allergies'),
                medicalHistory: formData.get('medicalHistory'),
                notes: formData.get('notes'),
                branch: currentUserRole === 'super_admin' ? formData.get('branch') : currentUserBranch // Use form branch for super_admin, otherwise use user's branch
            };

            const patientId = e.target.dataset.patientId;

            // Show confirmation dialog with patient details
            const patientName = `${patientData.titlePrefix} ${patientData.firstName} ${patientData.lastName}`.trim();
            const confirmAction = patientId ? 'อัปเดต' : 'เพิ่ม';
            const confirmTitle = patientId ? 'ยืนยันการอัปเดตข้อมูลลูกค้า' : 'ยืนยันการเพิ่มลูกค้าใหม่';

            const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>ชื่อ-นามสกุล:</strong> ${patientName}<br>
                        <strong>เบอร์โทร:</strong> ${patientData.phone || '-'}<br>
                        <strong>วันเกิด:</strong> ${patientData.birthDate || '-'}<br>
                        <strong>ที่อยู่:</strong> ${patientData.address || '-'}<br>
                        ${patientData.allergies ? `<strong>ภูมิแพ้:</strong> ${patientData.allergies}<br>` : ''}
                        ${patientData.medicalHistory ? `<strong>ประวัติการรักษา:</strong> ${patientData.medicalHistory}<br>` : ''}
                        ${patientData.notes ? `<strong>หมายเหตุ:</strong> ${patientData.notes}<br>` : ''}
                    </div>
                `;

            Swal.fire({
                title: confirmTitle,
                html: `ต้องการ${confirmAction}ข้อมูลลูกค้านี้หรือไม่?${detailsHtml}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#30308b',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: `ยืนยัน${confirmAction}`,
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-4'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Proceed with saving
                    proceedWithPatientSubmit();
                }
            });

            function proceedWithPatientSubmit() {
                showPatientLoading();
                if (patientId) {
                    // Update existing patient
                    google.script.run
                        .withSuccessHandler(function (result) {
                            hidePatientLoading();
                            if (result.success) {
                                loadPatients(false);
                                closePatientModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            hidePatientLoading();
                            console.error('Error updating patient:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.UPDATE_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.UPDATE_PATIENT](patientId, patientData, {
                        username: currentUser,
                        branch: currentUserBranch,
                        role: currentUserRole
                    });
                } else {
                    // Add new patient
                    patientData.registrationDate = new Date().toISOString().split('T')[0];
                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                loadPatients(false);
                                closePatientModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error adding patient:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.ADD_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.ADD_PATIENT](patientData, {
                        username: currentUser,
                        branch: currentUserBranch,
                        role: currentUserRole
                    });
                }
            }
        }

        function closePatientModal(form) {
            const modal = bootstrap.Modal.getInstance($(SELECTORS.PATIENT_MODAL)[0]);
            modal.hide();
            form.reset();
            delete form.dataset.patientId;

            // Reset Flatpickr date picker for birth date
            if (birthDatePicker) {
                birthDatePicker.clear();
                birthDatePicker.setDate(null);
            }

            // Reset form tracking
            originalPatientFormData = {};
            isPatientFormDirty = false;
        }

        // Function to capture initial form data
        function capturePatientFormData() {
            const form = $(SELECTORS.PATIENT_FORM)[0];
            const formData = new FormData(form);
            originalPatientFormData = {};

            for (let [key, value] of formData.entries()) {
                originalPatientFormData[key] = value;
            }

            // Also capture empty fields
            const inputs = form.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (!originalPatientFormData.hasOwnProperty(input.name)) {
                    originalPatientFormData[input.name] = input.value || '';
                }
            });

            isPatientFormDirty = false;
        }

        // Function to check if form data has changed
        function isPatientFormChanged() {
            const form = $(SELECTORS.PATIENT_FORM)[0];
            const currentFormData = new FormData(form);

            // Check all current form fields
            for (let [key, value] of currentFormData.entries()) {
                if (originalPatientFormData[key] !== value) {
                    return true;
                }
            }

            // Check for empty fields that might have had values initially
            const inputs = form.querySelectorAll('input, textarea, select');
            for (let input of inputs) {
                const currentValue = input.value || '';
                const originalValue = originalPatientFormData[input.name] || '';
                if (currentValue !== originalValue) {
                    return true;
                }
            }

            return false;
        }

        // Function to handle modal close with unsaved changes warning
        function handlePatientModalClose(event) {
            if (isPatientFormChanged()) {
                event.preventDefault();
                event.stopPropagation();

                Swal.fire({
                    title: 'มีการเปลี่ยนแปลงข้อมูล',
                    text: 'คุณมีการเปลี่ยนแปลงข้อมูลที่ยังไม่ได้บันทึก ต้องการออกจากหน้านี้หรือไม่?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#30308b',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: true,
                    confirmButtonText: 'ออกจากหน้านี้',
                    cancelButtonText: 'ยกเลิก',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const form = $(SELECTORS.PATIENT_FORM)[0];
                        closePatientModal(form);
                    }
                });

                return false;
            }

            // If no changes, proceed with normal close
            const form = $(SELECTORS.PATIENT_FORM)[0];
            closePatientModal(form);
            return true;
        }

        function editPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            const form = $(SELECTORS.PATIENT_FORM)[0];
            form.dataset.patientId = patientId;

            // Populate form
            form.querySelector('[name="titlePrefix"]').value = patient.title_prefix || '';
            form.querySelector('[name="firstName"]').value = patient.first_name;
            form.querySelector('[name="lastName"]').value = patient.last_name;
            form.querySelector('[name="phone"]').value = patient.phone;
            form.querySelector('[name="gender"]').value = patient.gender || '';
            form.querySelector('[name="address"]').value = patient.address || '';
            form.querySelector('[name="allergies"]').value = patient.allergies || '';
            form.querySelector('[name="medicalHistory"]').value = patient.medical_history || '';
            form.querySelector('[name="notes"]').value = patient.notes || '';
            // Set branch field for super_admin users
            if (currentUserRole === 'super_admin' && form.querySelector('[name="branch"]')) {
                form.querySelector('[name="branch"]').value = patient.branch || '';
            }
            form.querySelector('[name="birthDate"]')._flatpickr.setDate(patient.birth_date, true);
            // Show modal
            const modal = new bootstrap.Modal($(SELECTORS.PATIENT_MODAL)[0]);
            modal.show();

            // Capture initial form data after modal is shown and form is populated
            setTimeout(() => {
                capturePatientFormData();
            }, 100);
        }

        function deletePatient(patientId) {
            // Find patient details
            const patient = patients.find(p => p.id === patientId);
            const patientName = patient ? `${patient.title_prefix || ''} ${patient.first_name} ${patient.last_name}`.trim() : 'ไม่ทราบชื่อ';

            const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>ชื่อ-นามสกุล:</strong> ${patientName}<br>
                        <strong>เบอร์โทร:</strong> ${patient?.phone || '-'}<br>
                        <strong>เพศ:</strong> ${patient?.gender || 'ไม่ระบุ'}<br>
                        <strong>วันเกิด:</strong> ${patient?.birth_date || '-'}<br>
                        ${patient?.allergies ? `<strong>ภูมิแพ้:</strong> ${patient.allergies}<br>` : ''}
                    </div>
                    <div style="color: #dc3545; font-weight: bold; margin-top: 15px;">
                        ⚠️ การลบข้อมูลนี้ไม่สามารถกู้คืนได้!
                    </div>
                `;

            Swal.fire({
                title: 'ยืนยันการลบข้อมูลลูกค้า',
                html: `ต้องการลบข้อมูลลูกค้านี้หรือไม่?${detailsHtml}`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#30308b',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: 'ยืนยันลบ',
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-4'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    NProgress.start();
                    Swal.fire({
                        iconHtml: '<i class="bi-hourglass-split text-danger"></i>',
                        title: 'กำลังลบข้อมูล...',
                        allowOutsideClick: false,
                        confirmButtonColor: '#30308b',
                        cancelButtonColor: '#6c757d',
                        reverseButtons: true,
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        customClass: {
                            popup: 'rounded-4',
                            icon: 'border-0'
                        }
                    });
                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                loadPatients(false);
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error deleting patient:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.DELETE_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.DELETE_PATIENT](patientId, {
                        username: currentUser,
                        branch: currentUserBranch,
                        role: currentUserRole
                    });
                }
            });
        }

        function renderCalendar() {
            let $calendar = $(SELECTORS.CALENDAR);
            let $monthYear = $(SELECTORS.CURRENT_MONTH);

            let year = currentMonth.getFullYear();
            let month = currentMonth.getMonth();

            $monthYear.text(currentMonth.toLocaleDateString(CONFIG.DATE_FORMAT_TH, {
                year: 'numeric',
                month: 'long'
            }));

            let firstDay = new Date(year, month, 1);
            let startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            let selectedDate = $('#selectedDate').data('date') ? new Date($('#selectedDate').data('date')) : new Date();
            console.log("🚀 ~ renderCalendar ~ selectedDate:", selectedDate)
            let today = new Date();
            let todayStr = today.toDateString();

            // Pre-group appointments by date for O(1) lookup
            let appointmentsByDate = {};

            // Get selected branch filter for calendar
            const selectedBranch = document.querySelector('#calendarBranchFilter')?.value || '';

            // Filter appointments by branch if selected
            const filteredAppointments = selectedBranch ?
                appointments.filter(apt => apt.branch === selectedBranch) :
                appointments;

            filteredAppointments.forEach(apt => {
                let dateStr = moment(apt.appointment_date).format('YYYY-MM-DD');
                if (!appointmentsByDate[dateStr]) {
                    appointmentsByDate[dateStr] = [];
                }
                appointmentsByDate[dateStr].push(apt);
            });

            // Build HTML string array for better performance
            let htmlParts = ['<div class="calendar-grid">'];

            // Days of week header
            UI_TEXT.DAYS.forEach(day => {
                htmlParts.push(`<div class="calendar-cell text-center fw-bold bg-light">${day}</div>`);
            });

            // Pre-calculate base date to avoid repeated date calculations
            let baseDate = new Date(startDate);

            // Calendar days
            for (let i = 0; i < CONFIG.CALENDAR_DAYS; i++) {
                let date = new Date(baseDate.getTime() + (i * 24 * 60 * 60 * 1000));

                let isCurrentMonth = date.getMonth() === month;
                let isToday = date.toDateString() === todayStr;
                let dateStr = moment(date).format('YYYY-MM-DD');
                let isSelected = selectedDate && moment(selectedDate).format('YYYY-MM-DD') === dateStr;

                // O(1) lookup instead of filter operation
                let dayAppointments = appointmentsByDate[dateStr] || [];

                // Build CSS classes efficiently
                let cssClasses = ['calendar-cell'];
                if (!isCurrentMonth) cssClasses.push('other-month');
                if (isToday) cssClasses.push('today');
                if (isSelected) cssClasses.push('selected');

                htmlParts.push(`<div class="${cssClasses.join(' ')}" data-date="${dateStr}">
                        <div>${date.getDate()}</div>`);

                if (dayAppointments.length > 0) {
                    // Group appointments by status and create status-based dots
                    let statusGroups = groupAppointmentsByStatus(dayAppointments);
                    htmlParts.push('<div class="appointment-dots">');

                    // Show dots for each status type
                    Object.keys(statusGroups).forEach(status => {
                        let count = statusGroups[status].length;
                        if (count > 0) {
                            htmlParts.push(`<div class="appointment-dot ${status}" title="${getStatusText(status)}: ${count} นัด"></div>`);
                        }
                    });

                    htmlParts.push('</div>');
                    htmlParts.push(`<small class="text-primary">${dayAppointments.length} นัด</small>`);
                }

                htmlParts.push('</div>');
            }

            htmlParts.push('</div>');

            // Single DOM update
            $calendar.html(htmlParts.join(''));

            // Use event delegation for better performance
            $calendar.off('click.calendar').on('click.calendar', '.calendar-cell', function () {
                let date = $(this).data('date');
                $('#selectedDate').data('date', date);
                if (date) {
                    // Re-render calendar to show selected state
                    renderCalendar();
                    // Render appointments for selected date
                    renderTodayAppointments(new Date(date));
                }
            });
        }

        function renderTodayAppointments() {
            const $container = $(SELECTORS.TODAY_APPOINTMENTS_LIST);
            let selectedDate = $('#selectedDate').data('date') ? new Date($('#selectedDate').data('date')) : null;
            console.log("🚀 ~ renderTodayAppointments ~ selectedDate:", selectedDate)
            if (!selectedDate) selectedDate = new Date();
            const today = moment(selectedDate).format('YYYY-MM-DD');
            $('#selectedDate').text(new Date(today).toLocaleDateString(CONFIG.DATE_FORMAT_TH, {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            }));

            const todayAppts = appointments.filter(apt => {
                const dateMatch = moment(apt.appointment_date).format('YYYY-MM-DD') === today;

                // Get selected branch filter from calendar branch filter
                const selectedBranch = document.querySelector('#calendarBranchFilter')?.value || '';
                const branchMatch = !selectedBranch || apt.branch === selectedBranch;

                return dateMatch && branchMatch;
            });

            if (todayAppts.length === 0) {
                $container.html(`<li class="list-group-item text-center text-muted">${UI_TEXT.MESSAGES.NO_APPOINTMENTS_TODAY}</li>`);
                return;
            }

            // Pre-group patients and doctors for O(1) lookup
            const patientLookup = patients.reduce((acc, patient) => {
                acc[patient.id] = `${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}`;
                return acc;
            }, {});

            const doctorLookup = doctors.reduce((acc, doctor) => {
                acc[doctor.id] = `${doctor.first_name} ${doctor.last_name}`;
                return acc;
            }, {});
            console.log("🚀 ~ renderTodayAppointments ~ patientLookup:", patientLookup)

            // Build HTML array for single DOM update
            const htmlParts = todayAppts.map(apt => {
                const patientName = patientLookup[apt.patient_id] || UI_TEXT.MESSAGES.PATIENT_NOT_FOUND;
                const doctorName = doctorLookup[apt.doctor_id] ? `แพทย์ : ${doctorLookup[apt.doctor_id]}` : 'ไม่ระบุหมอ';
                const status = apt.status || 'scheduled';
                const statusIcon = getStatusIcon(status);
                const statusText = getStatusText(status);

                // Get branch display name
                const branch = branches.find(b => b.value === apt.branch);
                const branchName = branch ? branch.displayName : apt.branch || 'ไม่ระบุสาขา';
                console.log("🚀 ~ renderTodayAppointments ~ patientLookup:", patientLookup)

                return `<li class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 btn text-start" onclick="editAppointment('${apt.id}')">
                            <div class="d-flex align-items-center">
                                <div class="appointment-status-icon ${status}" title="${statusText}">
                                    <i class="${statusIcon}"></i>
                                </div>
                                <div class="fw-bold">${patientName}</div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-secondary">${doctorName}</small>
                                <small class="text-muted">${branchName}</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="small text-primary fw-semibold">${apt.appointment_time} น.</div>
                                <small class="badge ${status}">${statusText}</small>
                            </div>
                        </div>
                        <i class="fas fa-edit text-secondary" style="cursor: pointer;" onclick="editAppointment('${apt.id}')"></i>
                    </li>`;
            });

            $container.html(htmlParts.join(''));
        }

        function loadPatientsForAppointment(filterBranch = null) {
            const $select = $(`${SELECTORS.APPOINTMENT_FORM} select[name="patientId"]`);

            // Filter patients by branch if specified
            let filteredPatients = patients;
            if (filterBranch && currentUserRole === 'super_admin') {
                filteredPatients = patients.filter(patient => patient.branch === filterBranch);
            }

            const options = filteredPatients.map(patient =>
                `<option value="${patient.id}">${patient.title_prefix ? patient.title_prefix + ' ' : ''}${patient.first_name} ${patient.last_name}</option>`
            ).join('');

            $select.html(`<option value="">${UI_TEXT.LABELS.SELECT_PATIENT}</option>` + options);

            // Trigger Select2 to refresh
            $select.trigger('change');
        }



        function renderDoctorsTable() {
            const $tbody = $('#doctorsTable tbody');

            // Initialize DataTable if not already initialized
            if ($.fn.DataTable.isDataTable('#doctorsTable')) {
                $('#doctorsTable').DataTable().destroy()
            }

            if (doctors.length === 0) {
                $tbody.html(`<tr><td colspan="6" class="text-center text-muted">${UI_TEXT.MESSAGES.NO_DOCTOR_DATA}</td></tr>`);
                return;
            }

            const html = doctors.map(doctor => {
                // Show edit/delete buttons only for admin and super_admin
                const adminButtons = (currentUserRole === 'admin' || currentUserRole === 'super_admin') ? `
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editDoctor('${doctor.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor('${doctor.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : '<span class="text-muted">ไม่มีสิทธิ์</span>';

                return `
                        <tr>
                            <td>${doctor.id}</td>
                            <td>${doctor.first_name} ${doctor.last_name}</td>
                            <td>${doctor.specialty}</td>
                            <td>${doctor.phone}</td>
                            <td>${doctor.email || '-'}</td>
                            <td>
                                ${adminButtons}
                            </td>
                        </tr>
                    `;
            }).join('');

            $tbody.html(html);
            $(SELECTORS.DOCTORS_TABLE).DataTable({
                language: {
                    url: CONFIG.DATATABLES_LANG_URL
                },
                responsive: true,
                order: [0, 'desc'],
                columnDefs: [
                    { orderable: false, targets: 5 },
                    { className: 'dt-head-center dt-head-nowrap dt-body-center dt-body-nowrap text-center', targets: '_all' }
                ]
            });

        }

        function loadDoctorsForAppointment() {
            const $select = $(`${SELECTORS.APPOINTMENT_FORM} select[name="doctorId"]`);
            const options = doctors.map(doctor =>
                `<option value="${doctor.id}">${doctor.first_name} ${doctor.last_name}</option>`
            ).join('');

            $select.html(`<option value="">${UI_TEXT.LABELS.SELECT_DOCTOR}</option>` + options);
        }

        function handleDoctorSubmit(e) {
            e.preventDefault();
            if (!e.target.checkValidity()) {
                e.target.classList.add('was-validated');
                Toast.fire({
                    icon: 'error',
                    title: 'กรุณากรอกข้อมูลให้ครบถ้วนตามที่กำหนด'
                });
                $(e.target).find(':invalid')[0].focus();
                return;
            } else {
                e.target.classList.remove('was-validated');
            }
            // Check admin permissions
            if (currentUserRole !== 'admin' && currentUserRole !== 'super_admin') {
                Toast.fire({
                    icon: 'error',
                    title: 'ไม่มีสิทธิ์ในการเพิ่ม/แก้ไขข้อมูลหมอ'
                });
                return;
            }

            const formData = new FormData(e.target);
            const showDoctorLoading = () => {
                NProgress.start();
                Swal.fire({
                    iconHtml: '<i class="bi-hourglass-split text-primary"></i>',
                    title: 'กำลังบันทึกข้อมูล...',
                    allowOutsideClick: false,
                    confirmButtonColor: '#30308b',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: true,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: ' rounded-4',
                        icon: 'border-0'
                    }
                });
            }
            const hideDoctorLoading = () => {
                NProgress.done();
                Swal.close();
            }
            const doctorData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                specialty: formData.get('specialty'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                licenseNumber: formData.get('licenseNumber'),
                notes: formData.get('notes')
            };

            // Show confirmation dialog with doctor details
            const doctorName = `${doctorData.firstName} ${doctorData.lastName}`.trim();
            const isEdit = e.target.dataset.doctorId;
            const confirmAction = isEdit ? 'อัปเดต' : 'เพิ่ม';
            const confirmTitle = isEdit ? 'ยืนยันการอัปเดตข้อมูลหมอ' : 'ยืนยันการเพิ่มหมอใหม่';

            const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>ชื่อ-นามสกุล:</strong> ${doctorName}<br>
                        <strong>ความเชี่ยวชาญ:</strong> ${doctorData.specialty || '-'}<br>
                        <strong>เบอร์โทร:</strong> ${doctorData.phone || '-'}<br>
                        <strong>อีเมล:</strong> ${doctorData.email || '-'}<br>
                        <strong>เลขใบประกอบวิชาชีพ:</strong> ${doctorData.licenseNumber || '-'}<br>
                        ${doctorData.notes ? `<strong>หมายเหตุ:</strong> ${doctorData.notes}<br>` : ''}
                    </div>
                `;

            Swal.fire({
                title: confirmTitle,
                html: `ต้องการ${confirmAction}ข้อมูลหมอนี้หรือไม่?${detailsHtml}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#30308b',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: `ยืนยัน${confirmAction}`,
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-4'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Proceed with saving
                    proceedWithDoctorSubmit();
                }
            });

            function proceedWithDoctorSubmit() {
                showDoctorLoading();

                if (e.target.dataset.doctorId) {
                    // Edit existing doctor
                    const doctorId = e.target.dataset.doctorId;

                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                hideDoctorLoading();
                                loadDoctors(false);
                                closeDoctorModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: 'อัปเดตข้อมูลหมอสำเร็จ'
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message || 'เกิดข้อผิดพลาดในการอัปเดต'
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            hideDoctorLoading();
                            console.error('Error updating doctor:', error);
                            Toast.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                            });
                            NProgress.done();
                        })
                        .updateDoctor(doctorId, doctorData, {
                            username: currentUser,
                            branch: currentUserBranch,
                            role: currentUserRole
                        });
                } else {
                    // Add new doctor
                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                loadDoctors(false);
                                closeDoctorModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: 'เพิ่มหมอใหม่สำเร็จ'
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message || 'เกิดข้อผิดพลาดในการเพิ่มข้อมูล'
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error adding doctor:', error);
                            Toast.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                            });
                            NProgress.done();
                        })
                        .addDoctor(doctorData, {
                            username: currentUser,
                            branch: currentUserBranch,
                            role: currentUserRole
                        });
                }
            }
        }

        function editDoctor(doctorId) {
            // Check admin permissions
            if (currentUserRole !== 'admin' && currentUserRole !== 'super_admin') {
                Toast.fire({
                    icon: 'error',
                    title: 'ไม่มีสิทธิ์ในการแก้ไขข้อมูลหมอ'
                });
                return;
            }

            console.log("🚀 ~ editDoctor ~ doctors:", doctors)
            console.log("🚀 ~ editDoctor ~ doctorId:", doctorId)
            const doctor = doctors.find(d => d.id === doctorId);
            console.log("🚀 ~ editDoctor ~ doctor:", doctor)
            if (!doctor) return;

            const form = $('#doctorForm')[0];
            form.dataset.doctorId = doctorId;

            // Populate form
            form.querySelector('[name="firstName"]').value = doctor.first_name;
            form.querySelector('[name="lastName"]').value = doctor.last_name;
            form.querySelector('[name="specialty"]').value = doctor.specialty;
            form.querySelector('[name="phone"]').value = doctor.phone;
            form.querySelector('[name="email"]').value = doctor.email || '';
            form.querySelector('[name="licenseNumber"]').value = doctor.license_number || '';
            form.querySelector('[name="notes"]').value = doctor.notes || '';

            // Show modal
            const modal = new bootstrap.Modal($('#doctorModal')[0]);
            modal.show();
        }

        function deleteDoctor(doctorId) {
            // Check admin permissions
            if (currentUserRole !== 'admin' && currentUserRole !== 'super_admin') {
                Toast.fire({
                    icon: 'error',
                    title: 'ไม่มีสิทธิ์ในการลบข้อมูลหมอ'
                });
                return;
            }

            // Find doctor details
            const doctor = doctors.find(d => d.id === doctorId);
            const doctorName = doctor ? `${doctor.first_name} ${doctor.last_name}`.trim() : 'ไม่ทราบชื่อ';

            const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>ชื่อ-นามสกุล:</strong> ${doctorName}<br>
                        <strong>ความเชี่ยวชาญ:</strong> ${doctor?.specialty || '-'}<br>
                        <strong>เบอร์โทร:</strong> ${doctor?.phone || '-'}<br>
                        <strong>อีเมล:</strong> ${doctor?.email || '-'}<br>
                        <strong>เลขใบประกอบวิชาชีพ:</strong> ${doctor?.license_number || '-'}<br>
                    </div>
                    <div style="color: #dc3545; font-weight: bold; margin-top: 15px;">
                        ⚠️ การลบข้อมูลนี้ไม่สามารถกู้คืนได้!
                    </div>
                `;

            Swal.fire({
                title: 'ยืนยันการลบข้อมูลหมอ',
                html: `ต้องการลบข้อมูลหมอนี้หรือไม่?${detailsHtml}`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#30308b',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: 'ยืนยันลบ',
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-4'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    NProgress.start();
                    Swal.fire({
                        iconHtml: '<i class="bi-hourglass-split text-danger"></i>',
                        title: 'กำลังลบข้อมูล...',
                        allowOutsideClick: false,
                        confirmButtonColor: '#30308b',
                        cancelButtonColor: '#6c757d',
                        reverseButtons: true,
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        customClass: {
                            popup: 'rounded-4',
                            icon: 'border-0'
                        }
                    });
                    google.script.run
                        .withSuccessHandler(function (result) {
                            Swal.close();
                            if (result.success) {
                                loadDoctors(false);
                                Toast.fire({
                                    icon: 'success',
                                    title: 'ลบข้อมูลหมอสำเร็จ'
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message || 'เกิดข้อผิดพลาดในการลบข้อมูล'
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            Swal.close();
                            console.error('Error deleting doctor:', error);
                            Toast.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ'
                            });
                            NProgress.done();
                        })
                        .deleteDoctor(doctorId, {
                            branch: currentUserBranch,
                            role: currentUserRole
                        });
                }
            });
        }

        function closeDoctorModal(form) {
            const modal = bootstrap.Modal.getInstance($('#doctorModal')[0]);
            modal.hide();
            form.reset();
            delete form.dataset.doctorId;
        }

        // User management functions
        function renderUsersTable() {
            const $tbody = $('#usersTable tbody');

            if (users.length === 0) {
                $tbody.html('<tr><td colspan="7" class="text-center">ไม่มีข้อมูลผู้ใช้</td></tr>');
                return;
            }

            const html = users.map(user => {
                const roleText = user.role === 'super_admin' ? 'ผู้ดูแลระบบสูงสุด' :
                    user.role === 'admin' ? 'ผู้ดูแลระบบ' : 'ผู้ใช้ทั่วไป';
                const statusClass = user.status === 'active' ? 'success' : 'secondary';
                const statusText = user.status === 'active' ? 'เปิดใช้งาน' : 'ปิดใช้งาน';
                const createdDate = user.created_at ? new Date(user.created_at).toLocaleDateString('th-TH') : '';

                return `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.first_name || ''} ${user.last_name || ''}</td>
                        <td>${user.branch || ''}</td>
                        <td>${roleText}</td>
                        <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser('${user.username}')">
                                <i class="fas fa-edit"></i> แก้ไข
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.username}')">
                                <i class="fas fa-trash"></i> ลบ
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            $tbody.html(html);
            $(SELECTORS.USERS_TABLE).DataTable({
                language: {
                    url: CONFIG.DATATABLES_LANG_URL
                },
                responsive: true,
                order: [0, 'asc'],
                columnDefs: [
                    { orderable: false, targets: 6 },
                    { className: 'dt-head-center dt-head-nowrap dt-body-center dt-body-nowrap text-center', targets: '_all' }
                ]
            });
        }

        function handleUserSubmit(e) {
            e.preventDefault();
            if (!e.target.checkValidity()) {
                e.target.classList.add('was-validated');
                return;
            }

            const formData = new FormData(e.target);
            const userData = {
                username: formData.get('username'),
                password: formData.get('password'),
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                branch: formData.get('branch'),
                role: formData.get('role'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                status: formData.get('status') === 'active' ? 'active' : 'disable'
            };
            console.log("🚀 ~ handleUserSubmit ~ userData:", userData)

            const userId = e.target.dataset.userId;
            const isEdit = Boolean(userId);

            const confirmAction = isEdit ? 'อัปเดต' : 'เพิ่ม';
            const confirmTitle = isEdit ? 'ยืนยันการอัปเดตข้อมูลผู้ใช้' : 'ยืนยันการเพิ่มผู้ใช้ใหม่';

            Swal.fire({
                title: confirmTitle,
                text: `คุณต้องการ${confirmAction}ข้อมูลผู้ใช้ "${userData.username}" หรือไม่?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#30308b',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-4'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        iconHtml: '<i class="bi-hourglass-split text-primary"></i>',
                        title: 'กำลังบันทึกข้อมูล...',
                        allowOutsideClick: false,
                        confirmButtonColor: '#30308b',
                        cancelButtonColor: '#6c757d',
                        reverseButtons: true,
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        customClass: {
                            popup: ' rounded-4',
                            icon: 'border-0'
                        }
                    });
                    if (isEdit) {
                        google.script.run
                            .withSuccessHandler(function (result) {
                                if (result.success) {
                                    loadUsers();
                                    closeUserModal(e.target);
                                    Toast.fire({
                                        icon: 'success',
                                        title: result.message
                                    });
                                } else {
                                    Toast.fire({
                                        icon: 'error',
                                        title: result.message
                                    });
                                }
                            })
                            .withFailureHandler(function (error) {
                                console.error('Error updating user:', error);
                                Toast.fire({
                                    icon: 'error',
                                    title: 'เกิดข้อผิดพลาดในการอัปเดตข้อมูลผู้ใช้'
                                });
                            })
                        [API_METHODS.UPDATE_USER](userId, userData, {
                            username: currentUser,
                            branch: currentUserBranch,
                            role: currentUserRole
                        });
                    } else {
                        google.script.run
                            .withSuccessHandler(function (result) {
                                if (result.success) {
                                    loadUsers();
                                    closeUserModal(e.target);
                                    Toast.fire({
                                        icon: 'success',
                                        title: result.message
                                    });
                                } else {
                                    Toast.fire({
                                        icon: 'error',
                                        title: result.message
                                    });
                                }
                            })
                            .withFailureHandler(function (error) {
                                console.error('Error adding user:', error);
                                Toast.fire({
                                    icon: 'error',
                                    title: 'เกิดข้อผิดพลาดในการเพิ่มผู้ใช้'
                                });
                            })
                        [API_METHODS.ADD_USER](userData, {
                            username: currentUser,
                            branch: currentUserBranch,
                            role: currentUserRole
                        });
                    }
                }
            });
        }

        function editUser(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            console.log("🚀 ~ editUser ~ user:", user)
            const form = $(SELECTORS.USER_FORM)[0];
            form.dataset.userId = username;

            // Populate form
            form.querySelector('[name="username"]').value = user.username;
            form.querySelector('[name="password"]').value = user.password || '';
            form.querySelector('[name="password"]').required = false; // Password optional for edit
            form.querySelector('[name="firstName"]').value = user.first_name || '';
            form.querySelector('[name="lastName"]').value = user.last_name || '';
            form.querySelector('[name="branch"]').value = user.branch || '';
            form.querySelector('[name="role"]').value = user.role || '';
            form.querySelector('[name="email"]').value = user.email || '';
            form.querySelector('[name="phone"]').value = user.phone || '';

            // Set status switch and update label accordingly
            const statusSwitch = form.querySelector('[name="status"]');
            const statusLabel = document.querySelector('#userModal label[for="userStatus"]');
            const isActive = user.status === 'active';

            statusSwitch.checked = isActive;
            if (statusLabel) {
                statusLabel.textContent = isActive ? 'เปิดใช้งาน' : 'ปิดใช้งาน';
            }

            // Show modal
            const modal = new bootstrap.Modal($(SELECTORS.USER_MODAL)[0]);
            modal.show();
        }

        function deleteUser(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;

            const userName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username;

            Swal.fire({
                title: 'ยืนยันการลบผู้ใช้',
                text: `คุณต้องการลบผู้ใช้ "${userName}" หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#30308b',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-4'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                loadUsers();
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error deleting user:', error);
                            Toast.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาดในการลบผู้ใช้'
                            });
                        })
                    [API_METHODS.DELETE_USER](username, {
                        username: currentUser,
                        branch: currentUserBranch,
                        role: currentUserRole
                    });
                }
            });
        }

        function closeUserModal(form) {
            const modal = bootstrap.Modal.getInstance($(SELECTORS.USER_MODAL)[0]);
            modal.hide();
            form.reset();
            delete form.dataset.userId;

            // Re-enable username field and make password required for next use
            form.querySelector('[name="username"]').disabled = false;
            form.querySelector('[name="password"]').required = true;
        }

        // Appointment form tracking functions
        function captureAppointmentFormData() {
            const form = $(SELECTORS.APPOINTMENT_FORM)[0];
            const formData = new FormData(form);
            originalAppointmentFormData = {};

            for (let [key, value] of formData.entries()) {
                // Handle multiple values for the same key (checkboxes)
                if (originalAppointmentFormData.hasOwnProperty(key)) {
                    // Convert to array if not already
                    if (!Array.isArray(originalAppointmentFormData[key])) {
                        originalAppointmentFormData[key] = [originalAppointmentFormData[key]];
                    }
                    originalAppointmentFormData[key].push(value);
                } else {
                    originalAppointmentFormData[key] = value;
                }
            }

            // Also capture empty fields and checkbox states
            const inputs = form.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    const checkboxes = form.querySelectorAll(`input[name="${input.name}"]`);
                    if (checkboxes.length > 1) {
                        // Multiple checkboxes with same name
                        const checkedValues = Array.from(checkboxes)
                            .filter(cb => cb.checked)
                            .map(cb => cb.value)
                            .join(',');
                        originalAppointmentFormData[input.name] = checkedValues;
                    } else {
                        // Single checkbox
                        originalAppointmentFormData[input.name] = input.checked ? input.value : '';
                    }
                } else if (!originalAppointmentFormData.hasOwnProperty(input.name)) {
                    originalAppointmentFormData[input.name] = input.value || '';
                }
            });

            isAppointmentFormDirty = false;

        }

        // Doctor form tracking functions
        function captureDoctorFormData() {
            const form = $(SELECTORS.DOCTOR_FORM)[0];
            const formData = new FormData(form);
            originalDoctorFormData = {};

            for (let [key, value] of formData.entries()) {
                originalDoctorFormData[key] = value;
            }

            // Also capture empty fields
            const inputs = form.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (!originalDoctorFormData.hasOwnProperty(input.name)) {
                    originalDoctorFormData[input.name] = input.value || '';
                }
            });

            isDoctorFormDirty = false;
        }

        // Function to check if doctor form data has changed
        function isDoctorFormChanged() {
            const form = $(SELECTORS.DOCTOR_FORM)[0];
            const currentFormData = new FormData(form);

            // Check all current form fields
            for (let [key, value] of currentFormData.entries()) {
                const originalValue = originalDoctorFormData[key] || '';
                if (value !== originalValue) {
                    return true;
                }
            }

            // Check if any original fields are now missing
            for (let key in originalDoctorFormData) {
                const input = form.querySelector(`[name="${key}"]`);
                const currentValue = input ? input.value || '' : '';
                const originalValue = originalDoctorFormData[key] || '';
                if (currentValue !== originalValue) {
                    return true;
                }
            }

            return false;
        }

        // Function to handle doctor modal close with unsaved changes warning
        function handleDoctorModalClose(event) {
            if (isDoctorFormChanged()) {
                event.preventDefault();
                event.stopPropagation();

                Swal.fire({
                    title: 'มีการเปลี่ยนแปลงข้อมูล',
                    text: 'คุณมีการเปลี่ยนแปลงข้อมูลหมอที่ยังไม่ได้บันทึก ต้องการออกจากหน้านี้หรือไม่?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#30308b',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: true,
                    confirmButtonText: 'ออกจากหน้านี้',
                    cancelButtonText: 'ยกเลิก',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const form = $(SELECTORS.DOCTOR_FORM)[0];
                        closeDoctorModal(form);
                    }
                });

                return false;
            }

            // If no changes, proceed with normal close
            const form = $(SELECTORS.DOCTOR_FORM)[0];
            closeDoctorModal(form);
            return true;
        }

        // Revenue form tracking functions
        function captureRevenueFormData() {
            const form = document.getElementById('revenueForm');
            if (!form) return {};
            
            originalRevenueFormData = {
                patientId: form.patientId.value || '',
                doctorId: form.doctorId.value || '',
                date: form.date.value || '',
                caseType: form.caseType ? Array.from(form.caseType).filter(cb => cb.checked).map(cb => cb.value) : [],
                caseDetails: form.caseDetails ? Array.from(form.caseDetails).filter(cb => cb.checked).map(cb => cb.value) : [],
                paymentTypes: form.paymentTypes ? Array.from(form.paymentTypes).filter(cb => cb.checked).map(cb => cb.value) : [],
                notes: form.notes.value || '',
                branch: form.branch.value || ''
            };
            
            // Get payment amounts
            const paymentAmountInputs = form.querySelectorAll('input[name^="paymentAmount_"]');
            paymentAmountInputs.forEach(input => {
                originalRevenueFormData[input.name] = input.value || '';
            });
            
            isRevenueFormDirty = false;
        }
        
        function isRevenueFormChanged() {
            const form = document.getElementById('revenueForm');
            if (!form) return false;
            
            const currentData = {
                patientId: form.patientId.value || '',
                doctorId: form.doctorId.value || '',
                date: form.date.value || '',
                caseType: form.caseType ? Array.from(form.caseType).filter(cb => cb.checked).map(cb => cb.value) : [],
                caseDetails: form.caseDetails ? Array.from(form.caseDetails).filter(cb => cb.checked).map(cb => cb.value) : [],
                paymentTypes: form.paymentTypes ? Array.from(form.paymentTypes).filter(cb => cb.checked).map(cb => cb.value) : [],
                notes: form.notes.value || '',
                branch: form.branch.value || ''
            };
            
            // Check payment amounts
            const paymentAmountInputs = form.querySelectorAll('input[name^="paymentAmount_"]');
            paymentAmountInputs.forEach(input => {
                currentData[input.name] = input.value || '';
            });
            
            return JSON.stringify(currentData) !== JSON.stringify(originalRevenueFormData);
        }
        
        function handleRevenueModalClose(event) {
            if (isRevenueFormDirty && isRevenueFormChanged()) {
                event.preventDefault();
                
                Swal.fire({
                    title: 'มีข้อมูลที่ยังไม่ได้บันทึก',
                    text: 'คุณต้องการออกโดยไม่บันทึกข้อมูลหรือไม่?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ออกโดยไม่บันทึก',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        closeRevenueModal(document.getElementById('revenueForm'));
                    }
                });
            }
        }

        // Settings page functions
        function loadSettingsPage() {
            // Load notification status
            checkNotificationStatus();
        }

        function checkNotificationStatus() {
            const statusEl = document.getElementById('notificationStatus');
            const webhookUrlInput = document.getElementById('chatWebhookUrl');
            const saveBtn = document.getElementById('saveWebhookBtn');
            const testBtn = document.getElementById('testNotificationBtn');

            // Show loading state
            statusEl.className = 'alert alert-info';
            statusEl.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>กำลังตรวจสอบสถานะ...</span>
                </div>
            `;

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        const isConfigured = result.isConfigured;
                        
                        // Update status display
                        if (isConfigured) {
                            statusEl.className = 'alert alert-success';
                            statusEl.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <span>${result.message}</span>
                                </div>
                            `;
                        } else {
                            statusEl.className = 'alert alert-warning';
                            statusEl.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span>${result.message}</span>
                                </div>
                            `;
                        }

                        // Enable/disable controls based on status
                        webhookUrlInput.disabled = false;
                        saveBtn.disabled = false;
                        testBtn.disabled = !isConfigured;
                        
                        // Show current webhook URL (partially masked for security)
                        if (isConfigured) {
                            google.script.run
                                .withSuccessHandler(function(webhookUrl) {
                                    if (webhookUrl) {
                                        // Mask the URL for security (show only first and last parts)
                                        const maskedUrl = webhookUrl.length > 50 
                                            ? webhookUrl.substring(0, 40) + '...' + webhookUrl.substring(webhookUrl.length - 20)
                                            : webhookUrl;
                                        webhookUrlInput.placeholder = maskedUrl;
                                    }
                                })
                                .getGoogleChatWebhook();
                        }
                    } else {
                        statusEl.className = 'alert alert-danger';
                        statusEl.innerHTML = `
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <span>เกิดข้อผิดพลาด: ${result.message}</span>
                            </div>
                        `;
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error checking notification status:', error);
                    statusEl.className = 'alert alert-danger';
                    statusEl.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span>ไม่สามารถตรวจสอบสถานะได้: ${error.message}</span>
                        </div>
                    `;
                })
                .getNotificationStatus();
        }

        function saveGoogleChatWebhook() {
            const webhookUrlInput = document.getElementById('chatWebhookUrl');
            const webhookUrl = webhookUrlInput.value.trim();
            const saveBtn = document.getElementById('saveWebhookBtn');

            if (!webhookUrl) {
                Toast.fire({
                    icon: 'error',
                    title: 'กรุณากรอก Webhook URL'
                });
                return;
            }

            // Validate URL format
            try {
                new URL(webhookUrl);
            } catch (e) {
                Toast.fire({
                    icon: 'error',
                    title: 'รูปแบบ URL ไม่ถูกต้อง'
                });
                return;
            }

            // Check if it's a Google Chat webhook URL
            if (!webhookUrl.includes('chat.googleapis.com')) {
                Swal.fire({
                    title: 'ยืนยันการบันทึก',
                    text: 'URL นี้ไม่ใช่ Google Chat webhook URL คุณต้องการดำเนินการต่อหรือไม่?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ดำเนินการต่อ',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        performWebhookSave(webhookUrl, saveBtn);
                    }
                });
            } else {
                performWebhookSave(webhookUrl, saveBtn);
            }
        }

        function performWebhookSave(webhookUrl, saveBtn) {
            // Show loading state
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>กำลังบันทึก...';

            google.script.run
                .withSuccessHandler(function(result) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;

                    if (result.success) {
                        Toast.fire({
                            icon: 'success',
                            title: result.message
                        });
                        
                        // Clear the input after successful save
                        document.getElementById('chatWebhookUrl').value = '';
                        
                        // Refresh status
                        setTimeout(() => {
                            checkNotificationStatus();
                        }, 1000);
                    } else {
                        Toast.fire({
                            icon: 'error',
                            title: result.message
                        });
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error saving webhook:', error);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                    
                    Toast.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาดในการบันทึก'
                    });
                })
                .setGoogleChatWebhook(webhookUrl);
        }

        function testGoogleChatNotification() {
            const testBtn = document.getElementById('testNotificationBtn');
            const originalText = testBtn.innerHTML;
            
            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>กำลังทดสอบ...';

            google.script.run
                .withSuccessHandler(function(result) {
                    testBtn.disabled = false;
                    testBtn.innerHTML = originalText;

                    if (result.success) {
                        Toast.fire({
                            icon: 'success',
                            title: 'ส่งข้อความทดสอบสำเร็จ'
                        });
                    } else {
                        Toast.fire({
                            icon: 'error',
                            title: `การทดสอบล้มเหลว: ${result.message}`
                        });
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error testing notification:', error);
                    testBtn.disabled = false;
                    testBtn.innerHTML = originalText;
                    
                    Toast.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาดในการทดสอบ'
                    });
                })
                .testGoogleChatNotification();
        }

        function showSetupInstructions() {
            const modal = new bootstrap.Modal(document.getElementById('setupInstructionsModal'));
            modal.show();
        }
        function captureRevenueFormData() {
            const form = $(SELECTORS.REVENUE_FORM)[0];
            const formData = new FormData(form);
            originalRevenueFormData = {};

            for (let [key, value] of formData.entries()) {
                originalRevenueFormData[key] = value;
            }

            // Also capture empty fields
            const inputs = form.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (!originalRevenueFormData.hasOwnProperty(input.name)) {
                    originalRevenueFormData[input.name] = input.value || '';
                }
            });

            isRevenueFormDirty = false;
        }

        // Function to check if revenue form data has changed
        function isRevenueFormChanged() {
            const form = $(SELECTORS.REVENUE_FORM)[0];
            const currentFormData = new FormData(form);

            // Check all current form fields
            for (let [key, value] of currentFormData.entries()) {
                if (originalRevenueFormData[key] !== value) {
                    return true;
                }
            }

            // Check if any original fields are now missing
            for (let key in originalRevenueFormData) {
                if (!currentFormData.has(key)) {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input && (input.value || '') !== originalRevenueFormData[key]) {
                        return true;
                    }
                }
            }

            return false;
        }

        // Function to handle revenue modal close with unsaved changes warning
        function handleRevenueModalClose(event) {
            // Just trigger the bootstrap modal close, which will be caught by the hide.bs.modal handler
            const modal = bootstrap.Modal.getInstance(document.querySelector(SELECTORS.REVENUE_MODAL));
            if (modal) {
                modal.hide();
            }
        }

        // Function to check if appointment form data has changed
        function isAppointmentFormChanged() {
            const form = $(SELECTORS.APPOINTMENT_FORM)[0];

            const formData = new FormData(form);
            let currentAppointmentFormData = {};

            for (let [key, value] of formData.entries()) {
                // Handle multiple values for the same key (checkboxes)
                if (currentAppointmentFormData.hasOwnProperty(key)) {
                    // Convert to array if not already
                    if (!Array.isArray(currentAppointmentFormData[key])) {
                        currentAppointmentFormData[key] = [currentAppointmentFormData[key]];
                    }
                    currentAppointmentFormData[key].push(value);
                } else {
                    currentAppointmentFormData[key] = value;
                }
            }

            // Also capture empty fields and checkbox states
            const inputs = form.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    const checkboxes = form.querySelectorAll(`input[name="${input.name}"]`);
                    if (checkboxes.length > 1) {
                        // Multiple checkboxes with same name
                        const checkedValues = Array.from(checkboxes)
                            .filter(cb => cb.checked)
                            .map(cb => cb.value)
                            .join(',');
                        currentAppointmentFormData[input.name] = checkedValues;
                    } else {
                        // Single checkbox
                        currentAppointmentFormData[input.name] = input.checked ? input.value : '';
                    }
                } else if (!currentAppointmentFormData.hasOwnProperty(input.name)) {
                    currentAppointmentFormData[input.name] = input.value || '';
                }
            });
            return JSON.stringify(currentAppointmentFormData) !== JSON.stringify(originalAppointmentFormData);
        }

        // Function to handle appointment modal close with unsaved changes warning
        function handleAppointmentModalClose(event) {
            if (isAppointmentFormChanged()) {
                event.preventDefault();
                event.stopPropagation();

                Swal.fire({
                    title: 'มีการเปลี่ยนแปลงข้อมูล',
                    text: 'คุณมีการเปลี่ยนแปลงข้อมูลการนัดหมายที่ยังไม่ได้บันทึก ต้องการออกจากหน้านี้หรือไม่?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#30308b',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: true,
                    confirmButtonText: 'ออกจากหน้านี้',
                    cancelButtonText: 'ยกเลิก',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const form = $(SELECTORS.APPOINTMENT_FORM)[0];
                        closeAppointmentModal(form);
                    }
                });

                return false;
            }

            // If no changes, proceed with normal close
            const form = $(SELECTORS.APPOINTMENT_FORM)[0];
            closeAppointmentModal(form);
            return true;
        }

        function handleAppointmentSubmit(e) {
            e.preventDefault();
            if (!e.target.checkValidity()) {
                e.target.classList.add('was-validated');
                Toast.fire({
                    icon: 'error',
                    title: 'กรุณากรอกข้อมูลให้ครบถ้วนตามที่กำหนด'
                });
                $(e.target).find(':invalid')[0].focus();
                return;
            } else {
                e.target.classList.remove('was-validated');
            }
            const formData = new FormData(e.target);

            // Get selected case types from hidden inputs
            const caseTypes = [];
            const caseTypeInputs = e.target.querySelectorAll('input[name="caseType"][type="hidden"]');
            caseTypeInputs.forEach(input => caseTypes.push(input.value));

            // Validate that at least one case type is selected
            if (caseTypes.length === 0) {
                Toast.fire({
                    icon: 'error',
                    title: 'กรุณาเลือกประเภทเคสอย่างน้อย 1 รายการ'
                });
                return;
            }

            // Get selected case details from hidden inputs
            const caseDetails = [];
            const caseDetailsInputs = e.target.querySelectorAll('input[name="caseDetails"][type="hidden"]');
            caseDetailsInputs.forEach(input => caseDetails.push(input.value));

            const appointmentData = {
                patientId: formData.get('patientId'),
                doctorId: formData.get('doctorId'),
                appointmentDate: formData.get('appointmentDate'),
                appointmentTime: formData.get('appointmentTime'),
                caseType: caseTypes.join(', '),
                caseDetails: caseDetails.join(', '),
                contactChannel: formData.get('contactChannel'),
                cost: parseFloat(formData.get('cost')) || 0,
                notes: formData.get('notes'),
                status: formData.get('status'),
                branch: currentUserRole === 'super_admin' ? formData.get('branch') : currentUserBranch // Use form branch for super_admin, otherwise use user's branch
            };
            console.log("🚀 ~ handleAppointmentSubmit ~ appointmentData:", appointmentData)

            const showAppointmentLoading = () => {
                NProgress.start();
                Swal.fire({
                    iconHtml: '<i class="bi-hourglass-split text-primary"></i>',
                    title: 'กำลังบันทึกข้อมูล...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: ' rounded-4',
                        icon: 'border-0'
                    }
                });
            }
            const hideAppointmentLoading = () => {
                NProgress.done();
                Swal.close();
            }

            const appointmentId = e.target.dataset.appointmentId;

            // Get patient and doctor names for display
            const selectedPatient = patients.find(p => p.id == appointmentData.patientId);
            const selectedDoctor = doctors.find(d => d.id == appointmentData.doctorId);
            const patientName = selectedPatient ? `${selectedPatient.title_prefix || ''} ${selectedPatient.first_name} ${selectedPatient.last_name}`.trim() : 'ไม่ระบุ';
            const doctorName = selectedDoctor ? `${selectedDoctor.first_name} ${selectedDoctor.last_name}`.trim() : 'ไม่ระบุ';

            // Show confirmation dialog with appointment details
            const isEdit = appointmentId;
            const confirmAction = isEdit ? 'อัปเดต' : 'เพิ่ม';
            const confirmTitle = isEdit ? 'ยืนยันการอัปเดตการนัดหมาย' : 'ยืนยันการเพิ่มการนัดหมายใหม่';

            const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>ลูกค้า:</strong> ${patientName}<br>
                        <strong>หมอ:</strong> ${doctorName}<br>
                        <strong>วันที่นัด:</strong> ${appointmentData.appointmentDate || '-'}<br>
                        <strong>เวลา:</strong> ${appointmentData.appointmentTime || '-'}<br>
                        <strong>ประเภทเคส:</strong> ${appointmentData.caseType || '-'}<br>
                        <strong>รายละเอียดเคส:</strong> ${appointmentData.caseDetails || '-'}<br>
                        <strong>ช่องทางการติดต่อ:</strong> ${appointmentData.contactChannel || '-'}<br>
                        <strong>ค่าใช้จ่าย:</strong> ${appointmentData.cost ? appointmentData.cost.toLocaleString() + ' บาท' : '0 บาท'}<br>
                        <strong>สถานะ:</strong> ${appointmentData.status || '-'}<br>
                        ${appointmentData.notes ? `<strong>หมายเหตุ:</strong> ${appointmentData.notes}<br>` : ''}
                    </div>
                `;

            Swal.fire({
                title: confirmTitle,
                html: `ต้องการ${confirmAction}การนัดหมายนี้หรือไม่?${detailsHtml}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#30308b',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: `ยืนยัน${confirmAction}`,
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-4'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Proceed with saving
                    proceedWithAppointmentSubmit();
                }
            });

            function proceedWithAppointmentSubmit() {
                showAppointmentLoading();

                if (appointmentId) {
                    // Update existing appointment
                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                hideAppointmentLoading()
                                loadAppointments(false);
                                closeAppointmentModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error updating appointment:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.APPOINTMENT_UPDATE_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.UPDATE_APPOINTMENT](appointmentId, appointmentData, {
                        username: currentUser,
                        branch: currentUserBranch,
                        role: currentUserRole
                    });
                } else {
                    // Add new appointment
                    google.script.run
                        .withSuccessHandler(function (result) {
                            if (result.success) {
                                loadAppointments(false);
                                closeAppointmentModal(e.target);
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error adding appointment:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.APPOINTMENT_ADD_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.ADD_APPOINTMENT](appointmentData, {
                        username: currentUser,
                        branch: currentUserBranch,
                        role: currentUserRole
                    });
                }
            }
        }

        function closeAppointmentModal(form) {
            const modal = bootstrap.Modal.getInstance(document.querySelector(SELECTORS.APPOINTMENT_MODAL));
            modal.hide();
            form.reset();
            delete form.dataset.appointmentId;

            // Reset pills and hidden inputs
            form.querySelectorAll('.pill-option').forEach(pill => pill.classList.remove('selected'));
            form.querySelectorAll('input[name="caseType"][type="hidden"]').forEach(input => input.remove());
            form.querySelectorAll('input[name="caseDetails"][type="hidden"]').forEach(input => input.remove());
            const otherInput = form.querySelector('input[name="caseDetailsOther"]');
            if (otherInput) {
                otherInput.value = '';
                otherInput.style.display = 'none';
            }

            // Reset Flatpickr date pickers
            if (appointmentDatePicker) {
                appointmentDatePicker.clear();
                appointmentDatePicker.setDate(null);
            }
            if (appointmentTimePicker) {
                appointmentTimePicker.clear();
                appointmentTimePicker.setDate(null);
            }

            // Reset form tracking
            originalAppointmentFormData = {};
            isAppointmentFormDirty = false;
        }

        function editAppointment(appointmentId) {
            console.log("🚀 ~ editAppointment ~ appointmentId:", appointmentId)
            const appointment = appointments.find(a => a.id === appointmentId);
            console.log("🚀 ~ editAppointment ~ appointment:", appointment)
            if (!appointment) return;

            const form = document.querySelector(SELECTORS.APPOINTMENT_FORM);
            form.dataset.appointmentId = appointmentId;

            // Reset all pills first
            form.querySelectorAll('.pill-option').forEach(pill => {
                pill.classList.remove('selected');
            });
            // Reset hidden inputs
            form.querySelectorAll('input[name="caseType"]').forEach(input => input.remove());
            form.querySelectorAll('input[name="caseDetails"]').forEach(input => input.remove());
            const otherInput = form.querySelector('input[name="caseDetailsOther"]');
            if (otherInput) {
                otherInput.value = '';
                otherInput.style.display = 'none';
            }

            // Populate form
            setTimeout(() => {
                form.querySelector('[name="cost"]').value = appointment.cost;
                form.querySelector('[name="notes"]').value = appointment.notes || '';
                form.querySelector('[name="status"]').value = appointment.status;
                form.querySelector('[name="contactChannel"]').value = appointment.contact_channel || '';
            }, 1000); // Delay to ensure form is ready

            // Populate case types
            if (appointment.case_type) {
                const caseTypes = appointment.case_type.split(', ');
                const firstContainer = form.querySelectorAll('.form-check-container')[0]; // Case type container
                caseTypes.forEach(type => {
                    const pill = firstContainer.querySelector(`.case-type-pill[data-value="${type}"]`);
                    if (pill) {
                        pill.click(); // Simulate click to trigger selection
                    }
                });
            }

            // Populate case details
            if (appointment.case_details) {
                const caseDetails = appointment.case_details.split(', ');
                const secondContainer = form.querySelectorAll('.form-check-container')[1]; // Case details container
                caseDetails.forEach(detail => {
                    if (detail.startsWith('อื่นๆ: ')) {
                        // Legacy "Other" option - skip since we removed this functionality
                        console.log('Skipping legacy "Other" case detail:', detail);
                    } else {
                        const pill = secondContainer.querySelector(`.case-details-pill[data-value="${detail}"]`);
                        if (pill) {
                            pill.click(); // Simulate click to trigger selection
                        }
                    }
                });
            }

            // Set branch field for super_admin users and load filtered patients
            if (currentUserRole === 'super_admin' && form.querySelector('[name="branch"]')) {
                const appointmentBranch = appointment.branch || '';
                form.querySelector('[name="branch"]').value = appointmentBranch;

                // Load patients filtered by branch first, then set patient selection
                if (appointmentBranch) {
                    loadPatientsForAppointment(appointmentBranch);
                } else {
                    loadPatientsForAppointment(); // Load all patients if no branch
                }

                // Use setTimeout to ensure patients are loaded before setting selection
                setTimeout(() => {
                    $('[name="patientId"]').val(appointment.patient_id).trigger('change').prop('disabled', false);
                }, 50);
            } else {
                // For non-super_admin users, just set the patient selection normally
                $('[name="patientId"]').val(appointment.patient_id).trigger('change').prop('disabled', false);
            }

            $('[name="doctorId"]').val(appointment.doctor_id).trigger('change');
            form.querySelector('[name="appointmentDate"]')._flatpickr.setDate(appointment.appointment_date, true);
            form.querySelector('[name="appointmentTime"]')._flatpickr.setDate(appointment.appointment_time, true);

            // Show modal
            const modal = new bootstrap.Modal(document.querySelector(SELECTORS.APPOINTMENT_MODAL));
            modal.show();

            // Capture initial form data after modal is shown and form is populated
            setTimeout(() => {
                captureAppointmentFormData();
            }, 100);
        }

        function handleRevenueSubmit(e) {
            e.preventDefault();
            if (!e.target.checkValidity()) {
                e.target.classList.add('was-validated');
                Toast.fire({
                    icon: 'error',
                    title: 'กรุณากรอกข้อมูลให้ครบถ้วนตามที่กำหนด'
                });
                $(e.target).find(':invalid')[0].focus();
                return;
            } else {
                e.target.classList.remove('was-validated');
            }
            const formData = new FormData(e.target);

            // Get selected case types from hidden inputs
            const caseTypes = [];
            const caseTypeInputs = e.target.querySelectorAll('input[name="caseType"][type="hidden"]');
            caseTypeInputs.forEach(input => caseTypes.push(input.value));

            // Get selected case details from hidden inputs
            const caseDetails = [];
            const caseDetailsInputs = e.target.querySelectorAll('input[name="caseDetails"][type="hidden"]');
            caseDetailsInputs.forEach(input => caseDetails.push(input.value));

            // Get selected payment types from hidden inputs
            const paymentTypes = [];
            const paymentTypeInputs = e.target.querySelectorAll('input[name="paymentType"][type="hidden"]');
            paymentTypeInputs.forEach(input => paymentTypes.push(input.value));

            // Get individual payment amounts using standardized field names
            const cashAmount = parseFloat(formData.get('cashAmount')) || 0;
            const transferAmount = parseFloat(formData.get('transferAmount')) || 0;
            const socialSecurityAmount = parseFloat(formData.get('socialSecurityAmount')) || 0;
            const visaAmount = parseFloat(formData.get('visaAmount')) || 0;

            const revenueData = {
                date: formData.get('date'),
                patientId: formData.get('patientId'),
                doctorId: formData.get('doctorId'),
                caseType: caseTypes.join(', '),
                caseDetails: caseDetails.join(', '),
                paymentType: paymentTypes.join(', '),
                cashAmount: cashAmount,
                transferAmount: transferAmount,
                socialSecurityAmount: socialSecurityAmount,
                visaAmount: visaAmount,
                xrayFee: parseFloat(formData.get('xrayFee')) || 0,
                medicineFee: parseFloat(formData.get('medicineFee')) || 0,
                otherProductFee: parseFloat(formData.get('otherProductFee')) || 0,
                discount: parseFloat(formData.get('discount')) || 0,
                notes: formData.get('notes'),
                branch: currentUserRole === 'super_admin' ? formData.get('branch') : currentUserBranch // Use form branch for super_admin, otherwise use user's branch
            };

            // Get patient and doctor names for display
            const selectedPatient = patients.find(p => p.id == revenueData.patientId);
            const selectedDoctor = doctors.find(d => d.id == revenueData.doctorId);
            const patientName = selectedPatient ? `${selectedPatient.title_prefix || ''} ${selectedPatient.first_name} ${selectedPatient.last_name}`.trim() : 'ไม่ระบุ';
            const doctorName = selectedDoctor ? `${selectedDoctor.first_name} ${selectedDoctor.last_name}`.trim() : 'ไม่ระบุ';

            // Get payment type display text (now supports multiple types)
            const paymentTypeText = revenueData.paymentType || 'ไม่ระบุ';

            const confirmTitle = 'ยืนยันการเพิ่มข้อมูลรายได้';

            // Build payment amounts display from individual payment fields
            let paymentAmountsText = '';
            const paymentAmountItems = [];

            if (revenueData.cashAmount > 0) paymentAmountItems.push(`เงินสด: ${revenueData.cashAmount.toLocaleString()} บาท`);
            if (revenueData.transferAmount > 0) paymentAmountItems.push(`เงินโอน: ${revenueData.transferAmount.toLocaleString()} บาท`);
            if (revenueData.socialSecurityAmount > 0) paymentAmountItems.push(`ประกันสังคม: ${revenueData.socialSecurityAmount.toLocaleString()} บาท`);
            if (revenueData.visaAmount > 0) paymentAmountItems.push(`Visa: ${revenueData.visaAmount.toLocaleString()} บาท`);

            if (paymentAmountItems.length > 0) {
                paymentAmountsText = paymentAmountItems.join('<br>');
            }

            const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>วันที่:</strong> ${revenueData.date || '-'}<br>
                        <strong>ผู้ป่วย:</strong> ${patientName}<br>
                        <strong>หมอ:</strong> ${doctorName}<br>
                        <strong>ประเภทเคส:</strong> ${revenueData.caseType || '-'}<br>
                        <strong>รายละเอียดเคส:</strong> ${revenueData.caseDetails || '-'}<br>
                        <strong>ประเภทการชำระ:</strong> ${paymentTypeText}<br>
                        ${paymentAmountsText ? `<strong>รายละเอียดการชำระ:</strong><br>${paymentAmountsText}<br>` : ''}
                        <strong>ค่าเอ็กซเรย์:</strong> ${revenueData.xrayFee.toLocaleString()} บาท<br>
                        <strong>ค่ายา:</strong> ${revenueData.medicineFee.toLocaleString()} บาท<br>
                        <strong>ค่าผลิตภัณฑ์อื่น:</strong> ${revenueData.otherProductFee.toLocaleString()} บาท<br>
                        <strong>ส่วนลด:</strong> ${revenueData.discount.toLocaleString()} บาท<br>
                        ${revenueData.notes ? `<strong>หมายเหตุ:</strong> ${revenueData.notes}<br>` : ''}
                    </div>
                `;

            Swal.fire({
                title: confirmTitle,
                html: `ต้องการเพิ่มข้อมูลรายได้นี้หรือไม่?${detailsHtml}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#30308b',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: 'ยืนยันเพิ่ม',
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-4'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Proceed with saving
                    proceedWithRevenueSubmit();
                }
            });

            function proceedWithRevenueSubmit() {
                NProgress.start();
                Swal.fire({
                    iconHtml: '<i class="bi-hourglass-split text-primary"></i>',
                    title: 'กำลังบันทึกข้อมูล...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: ' rounded-4',
                        icon: 'border-0'
                    }
                });
                google.script.run
                    .withSuccessHandler(function (result) {
                        Swal.close();
                        if (result.success) {
                            loadRevenues(false);
                            closeRevenueModal(e.target);
                            Toast.fire({
                                icon: 'success',
                                title: result.message
                            });
                        } else {
                            Toast.fire({
                                icon: 'error',
                                title: result.message
                            });
                        }
                        NProgress.done();
                    })
                    .withFailureHandler(function (error) {
                        Swal.close();
                        console.error('Error adding revenue:', error);
                        Toast.fire({
                            icon: 'error',
                            title: UI_TEXT.MESSAGES.REVENUE_ADD_ERROR
                        });
                        NProgress.done();
                    })
                [API_METHODS.ADD_REVENUE](revenueData, {
                    username: currentUser,
                    branch: currentUserBranch,
                    role: currentUserRole
                });
            }
        }

        function closeRevenueModal(form) {
            form.reset();
            form.querySelector('[name="date"]')._flatpickr.setDate(new Date());
            $(SELECTORS.REVENUE_MODAL).modal('hide');

            // Reset pills and hidden inputs
            form.querySelectorAll('.pill-option').forEach(pill => pill.classList.remove('selected'));
            form.querySelectorAll('input[name="caseType"][type="hidden"]').forEach(input => input.remove());
            form.querySelectorAll('input[name="caseDetails"][type="hidden"]').forEach(input => input.remove());
            form.querySelectorAll('input[name="paymentType"][type="hidden"]').forEach(input => input.remove());

            // Reset select2 elements
            form.querySelectorAll('select').forEach(select => {
                if ($(select).hasClass('select2-hidden-accessible')) {
                    $(select).val('').trigger('change');
                }
            });

            // Reset form tracking
            originalRevenueFormData = {};
            isRevenueFormDirty = false;
        }


        function renderRevenueTable() {
            const tbody = document.querySelector(`${SELECTORS.REVENUE_TABLE} tbody`);

            // Get selected branch filter
            const selectedBranch = document.querySelector('#revenueBranchFilter')?.value || '';

            // Filter revenues by branch (only for super admin)
            let filteredRevenues = revenues;
            if (currentUserRole === 'super_admin' && selectedBranch) {
                filteredRevenues = revenues.filter(revenue => revenue.branch === selectedBranch);
            } else if (currentUserRole !== 'super_admin') {
                // Non-super admin users only see their own branch data
                filteredRevenues = revenues.filter(revenue => revenue.branch === currentUserBranch);
            }

            if (filteredRevenues.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">${UI_TEXT.MESSAGES.NO_REVENUE_DATA}</td></tr>`;
                return;
            }

            const sortedRevenues = filteredRevenues.sort((a, b) => new Date(b.date) - new Date(a.date));

            const html = sortedRevenues.map(revenue => {
                const date = new Date(revenue.date).toLocaleDateString(CONFIG.DATE_FORMAT_TH);

                // Get patient and doctor names
                const patient = patients.find(p => p.id == revenue.patientId);
                const doctor = doctors.find(d => d.id == revenue.doctorId);
                const patientName = patient ? `${patient.title_prefix || ''} ${patient.first_name} ${patient.last_name}`.trim() : 'ไม่ระบุ';
                const doctorName = doctor ? `${doctor.first_name} ${doctor.last_name}`.trim() : 'ไม่ระบุ';

                // Payment type text - now supports multiple types
                const paymentTypeText = revenue.paymentType || '-';

                // Calculate total amount using helper function
                const totalAmount = calculateRevenueAmount(revenue);

                return `
                        <tr>
                            <td>${date}</td>
                            <td>${patientName}</td>
                            <td>${doctorName}</td>
                            <td>${revenue.caseType || '-'}</td>
                            <td>${paymentTypeText}</td>
                            <td class="text-end">${totalAmount.toLocaleString()} บาท</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRevenue('${revenue.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
            }).join('');

            tbody.innerHTML = html;
        }

        function deleteRevenue(revenueId) {
            // Find revenue details
            const revenue = revenues.find(r => r.id === revenueId);

            // Get patient and doctor names for display
            const patient = patients.find(p => p.id == revenue?.patientId);
            const doctor = doctors.find(d => d.id == revenue?.doctorId);
            const patientName = patient ? `${patient.title_prefix || ''} ${patient.first_name} ${patient.last_name}`.trim() : 'ไม่ระบุ';
            const doctorName = doctor ? `${doctor.first_name} ${doctor.last_name}`.trim() : 'ไม่ระบุ';

            // Calculate total amount for display using helper function
            const displayAmount = calculateRevenueAmount(revenue);

            // Build payment details display
            const paymentDetails = [];
            if (revenue?.cashAmount > 0) paymentDetails.push(`เงินสด: ${revenue.cashAmount.toLocaleString()} บาท`);
            if (revenue?.transferAmount > 0) paymentDetails.push(`เงินโอน: ${revenue.transferAmount.toLocaleString()} บาท`);
            if (revenue?.socialSecurityAmount > 0) paymentDetails.push(`ประกันสังคม: ${revenue.socialSecurityAmount.toLocaleString()} บาท`);
            if (revenue?.visaAmount > 0) paymentDetails.push(`Visa: ${revenue.visaAmount.toLocaleString()} บาท`);

            const detailsHtml = `
                    <div style="text-align: left; margin: 20px 0;">
                        <strong>วันที่:</strong> ${revenue?.date || '-'}<br>
                        <strong>ผู้ป่วย:</strong> ${patientName}<br>
                        <strong>หมอ:</strong> ${doctorName}<br>
                        <strong>ประเภทเคส:</strong> ${revenue?.caseType || '-'}<br>
                        <strong>รายละเอียดเคส:</strong> ${revenue?.caseDetails || '-'}<br>
                        <strong>ประเภทการชำระ:</strong> ${revenue?.paymentType || '-'}<br>
                        ${paymentDetails.length > 0 ? `<strong>รายละเอียดการชำระ:</strong><br>${paymentDetails.join('<br>')}<br>` : ''}
                        <strong>ยอดรวม:</strong> ${displayAmount.toLocaleString()} บาท<br>
                        ${revenue?.notes ? `<strong>หมายเหตุ:</strong> ${revenue.notes}<br>` : ''}
                    </div>
                    <div style="color: #dc3545; font-weight: bold; margin-top: 15px;">
                        ⚠️ การลบข้อมูลนี้ไม่สามารถกู้คืนได้!
                    </div>
                `;

            Swal.fire({
                title: 'ยืนยันการลบข้อมูลรายรับ-รายจ่าย',
                html: `ต้องการลบข้อมูลรายรับ-รายจ่ายนี้หรือไม่?${detailsHtml}`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#30308b',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                confirmButtonText: 'ยืนยันลบ',
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-4'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    NProgress.start();
                    Swal.fire({
                        iconHtml: '<i class="bi-hourglass-split text-danger"></i>',
                        title: 'กำลังลบข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        customClass: {
                            popup: 'rounded-4',
                            icon: 'border-0'
                        }
                    });
                    google.script.run
                        .withSuccessHandler(function (result) {
                            Swal.close();
                            if (result.success) {
                                loadRevenues(false);
                                Toast.fire({
                                    icon: 'success',
                                    title: result.message
                                });
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: result.message
                                });
                            }
                            NProgress.done();
                        })
                        .withFailureHandler(function (error) {
                            Swal.close();
                            console.error('Error deleting revenue:', error);
                            Toast.fire({
                                icon: 'error',
                                title: UI_TEXT.MESSAGES.DELETE_REVENUE_ERROR
                            });
                            NProgress.done();
                        })
                    [API_METHODS.DELETE_REVENUE](revenueId, {
                        branch: currentUserBranch,
                        role: currentUserRole
                    });
                }
            });
        }

        function updateRevenueStats() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const todayStr = moment().format('YYYY-MM-DD');

            // Get selected branch filter
            const selectedBranch = document.querySelector('#revenueBranchFilter')?.value || '';

            // Filter revenues by branch (only for super admin)
            let filteredRevenues = revenues;
            if (currentUserRole === 'super_admin' && selectedBranch) {
                filteredRevenues = revenues.filter(revenue => revenue.branch === selectedBranch);
            } else if (currentUserRole !== 'super_admin') {
                // Non-super admin users only see their own branch data
                filteredRevenues = revenues.filter(revenue => revenue.branch === currentUserBranch);
            }

            // Daily revenue
            console.log(filteredRevenues)
            const dailyRev = filteredRevenues.filter(r => moment(r.date).format('YYYY-MM-DD') === todayStr)
                .reduce((sum, r) => sum + calculateRevenueAmount(r), 0);
            $(SELECTORS.DAILY_REVENUE).text(`${dailyRev.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`);

            // Monthly revenue
            const monthlyRev = filteredRevenues.filter(r => {
                const rDate = moment(r.date);
                return rDate.month() === currentMonth && rDate.year() === currentYear;
            }).reduce((sum, r) => sum + calculateRevenueAmount(r), 0);
            $(SELECTORS.MONTHLY_REVENUE).text(`${monthlyRev.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`);

            // Yearly revenue
            const yearlyRev = filteredRevenues.filter(r => {
                const rDate = moment(r.date);
                return rDate.year() === currentYear;
            }).reduce((sum, r) => sum + calculateRevenueAmount(r), 0);
            $(SELECTORS.YEARLY_REVENUE).text(`${yearlyRev.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`);
        }

        function renderRevenueChart() {
            const canvas = $(SELECTORS.REVENUE_CHART)[0];

            // Check if chart already exists and destroy it
            if (Chart.getChart(canvas)) {
                Chart.getChart(canvas).destroy();
            }

            const ctx = canvas.getContext('2d');

            // Get selected branch filter
            const selectedBranch = document.querySelector('#revenueBranchFilter')?.value || '';

            // Filter revenues by branch (only for super admin)
            let filteredRevenues = revenues;
            if (currentUserRole === 'super_admin' && selectedBranch) {
                filteredRevenues = revenues.filter(revenue => revenue.branch === selectedBranch);
            } else if (currentUserRole !== 'super_admin') {
                // Non-super admin users only see their own branch data
                filteredRevenues = revenues.filter(revenue => revenue.branch === currentUserBranch);
            }

            // Get last 12 months data
            const monthlyData = [];
            const labels = [];

            for (let i = 11; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const month = date.getMonth();
                const year = date.getFullYear();

                const monthRevenue = filteredRevenues.filter(r => {
                    const rDate = new Date(r.date);
                    return rDate.getMonth() === month && rDate.getFullYear() === year;
                }).reduce((sum, r) => sum + calculateRevenueAmount(r), 0);

                monthlyData.push(monthRevenue);
                labels.push(date.toLocaleDateString(CONFIG.DATE_FORMAT_TH, { month: 'short', year: '2-digit' }));
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${UI_TEXT.LABELS.REVENUE_DAILY} (${UI_TEXT.LABELS.BAHT})`,
                        data: monthlyData,
                        borderColor: '#30308b',
                        backgroundColor: 'rgba(48, 48, 139, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return `${value.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`;
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${UI_TEXT.LABELS.REVENUE_DAILY}: ${context.parsed.y.toLocaleString()} ${UI_TEXT.LABELS.BAHT}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateNotifications() {
            // Simple notification system for upcoming appointments
            const tomorrow = moment().add(1, 'days').format('YYYY-MM-DD');

            // Filter appointments by branch for super admin
            let tomorrowAppts = appointments.filter(apt => {
                const isScheduled = apt.status === 'scheduled';
                const isTomorrow = moment(apt.appointment_date).format('YYYY-MM-DD') === tomorrow;

                if (!isScheduled || !isTomorrow) return false;

                // Branch filtering for super admin
                if (currentUserRole === 'super_admin') {
                    const selectedBranch = document.getElementById('notificationBranchFilter')?.value;
                    if (selectedBranch && apt.branch !== selectedBranch) {
                        return false;
                    }
                } else if (currentUserRole === 'admin') {
                    // Admin can only see appointments from their branch
                    return apt.branch === currentUserBranch;
                } else {
                    // Regular users can only see appointments from their branch
                    return apt.branch === currentUserBranch;
                }

                return true;
            });

            if (tomorrowAppts.length > 0) {
                $(SELECTORS.NOTIFICATION_BADGE).text(tomorrowAppts.length > 99 ? '99+' : tomorrowAppts.length);
                $(SELECTORS.NOTIFICATION_BADGE).removeClass('hidden');

                const $notificationList = $(SELECTORS.NOTIFICATION_LIST);
                const html = `
                        <li><h6 class="dropdown-header">${UI_TEXT.LABELS.NOTIFICATIONS}</h6></li>
                        <li class="super-admin-only ${currentUserRole === 'super_admin' ? 'show' : ''}">
                            <div class="dropdown-item-text">
                                <label class="form-label mb-1" style="font-size: 0.875rem;">กรองตามสาขา:</label>
                                <select class="form-select form-select-sm" id="notificationBranchFilter" onchange="updateNotifications()">
                                    <option value="">ทุกสาขา</option>
                                    ${branches.map(branch => `<option value="${branch.value}" ${document.getElementById('notificationBranchFilter')?.value === branch.value ? 'selected' : ''}>${branch.value}</option>`).join('')}
                                </select>
                            </div>
                        </li>
                        <li class="super-admin-only ${currentUserRole === 'super_admin' ? 'show' : ''}">
                            <hr class="dropdown-divider">
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        ${tomorrowAppts.map(apt => {
                    const patient = patients.find(p => p.id === apt.patient_id);
                    const patientName = patient ? `${patient.first_name} ${patient.last_name}` : UI_TEXT.MESSAGES.PATIENT_NOT_FOUND;
                    const branchText = currentUserRole === 'super_admin' ? ` (${apt.branch || 'ไม่ระบุสาขา'})` : '';
                    return `<li><a class="dropdown-item"><div class="fw-bold">${patientName}${branchText}</div><small>${UI_TEXT.LABELS.TOMORROW_APPOINTMENT} ${apt.appointment_time} น.</small></a></li>`;
                }).join('')}
                    `;
                $notificationList.html(html);
            } else {
                $(SELECTORS.NOTIFICATION_BADGE).addClass('hidden');
                const $notificationList = $(SELECTORS.NOTIFICATION_LIST);
                const html = `
                        <li><h6 class="dropdown-header">${UI_TEXT.LABELS.NOTIFICATIONS}</h6></li>
                        <!-- Branch Filter for Super Admin -->
                        <li class="super-admin-only">
                            <div class="dropdown-item-text">
                                <label class="form-label mb-1" style="font-size: 0.875rem;">กรองตามสาขา:</label>
                                <select class="form-select form-select-sm" id="notificationBranchFilter" onchange="updateNotifications()">
                                    <option value="">ทุกสาขา</option>
                                    ${branches.map(branch => `<option value="${branch.value}" ${document.getElementById('notificationBranchFilter')?.value === branch.value ? 'selected' : ''}>${branch.value}</option>`).join('')}
                                </select>
                            </div>
                        </li>
                        <li class="super-admin-only">
                            <hr class="dropdown-divider">
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><span class="dropdown-item-text text-muted">ไม่มีการแจ้งเตือนใหม่</span></li>
                    `;
                $notificationList.html(html);
            }
        }

        function renderReports() {
            // Only admin and super_admin users should see reports
            if (currentUserRole === 'user') {
                console.log('Regular users cannot access reports');
                return;
            }

            console.log('Rendering reports for admin user');

            // Get selected branch filter
            const selectedBranch = document.querySelector('#reportsBranchFilter')?.value || '';

            // Filter data by branch
            let filteredPatients = patients;
            let filteredAppointments = appointments;
            let filteredRevenues = revenues;

            if (currentUserRole === 'super_admin' && selectedBranch) {
                // Super admin with specific branch selected
                filteredPatients = patients.filter(p => p.branch === selectedBranch);
                filteredAppointments = appointments.filter(a => a.branch === selectedBranch);
                filteredRevenues = revenues.filter(r => r.branch === selectedBranch);
            } else if (currentUserRole !== 'super_admin') {
                // Non-super admin users only see their own branch
                filteredPatients = patients.filter(p => p.branch === currentUserBranch);
                filteredAppointments = appointments.filter(a => a.branch === currentUserBranch);
                filteredRevenues = revenues.filter(r => r.branch === currentUserBranch);
            }
            // If super_admin with no branch selected, show all data (no filtering)

            renderPatientsChart(filteredPatients);
            renderAppointmentsChart(filteredAppointments);
        }

        function renderPatientsChart(patientsData) {
            const canvas = document.getElementById('patientsChart');
            if (!canvas) return;

            // Check if chart already exists and destroy it
            if (Chart.getChart(canvas)) {
                Chart.getChart(canvas).destroy();
            }

            const ctx = canvas.getContext('2d');

            // Get last 12 months patient registration data
            const monthlyData = [];
            const labels = [];

            for (let i = 11; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const month = date.getMonth();
                const year = date.getFullYear();

                const monthPatients = patientsData.filter(p => {
                    const pDate = new Date(p.created_at || p.birthDate); // Use created_at or fallback to birthDate
                    return pDate.getMonth() === month && pDate.getFullYear() === year;
                }).length;

                monthlyData.push(monthPatients);
                labels.push(date.toLocaleDateString(CONFIG.DATE_FORMAT_TH, {
                    month: 'short',
                    year: '2-digit'
                }));
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'จำนวนลูกค้าใหม่',
                        data: monthlyData,
                        backgroundColor: 'rgba(48, 48, 139, 0.8)',
                        borderColor: '#30308b',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    return Math.floor(value) === value ? value : '';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `ลูกค้าใหม่: ${context.parsed.y} คน`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderAppointmentsChart(appointmentsData) {
            const canvas = document.getElementById('appointmentsChart');
            if (!canvas) return;

            // Check if chart already exists and destroy it
            if (Chart.getChart(canvas)) {
                Chart.getChart(canvas).destroy();
            }

            const ctx = canvas.getContext('2d');

            // Get appointment status summary for current month
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const currentMonthAppointments = appointmentsData.filter(apt => {
                const aptDate = new Date(apt.appointment_date);
                return aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
            });

            // Group by status
            const statusGroups = currentMonthAppointments.reduce((groups, apt) => {
                const status = apt.status || 'scheduled';
                groups[status] = (groups[status] || 0) + 1;
                return groups;
            }, {});

            // Prepare data for pie chart
            const statusLabels = {
                'scheduled': 'นัดหมาย',
                'completed': 'เสร็จสิ้น',
                'cancelled': 'ยกเลิก'
            };

            const statusColors = {
                'scheduled': '#30308b',
                'completed': '#009958',
                'cancelled': '#a92246'
            };

            const chartLabels = [];
            const chartData = [];
            const chartColors = [];

            Object.keys(statusGroups).forEach(status => {
                chartLabels.push(statusLabels[status] || status);
                chartData.push(statusGroups[status]);
                chartColors.push(statusColors[status] || '#6c757d');
            });

            // If no data, show a placeholder
            if (chartData.length === 0) {
                chartLabels.push('ไม่มีข้อมูล');
                chartData.push(1);
                chartColors.push('#e9ecef');
            }

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: chartColors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} ครั้ง (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Global functions for onclick events
        window.editPatient = editPatient;
        window.deletePatient = deletePatient;
        window.editAppointment = editAppointment;
        window.deleteRevenue = deleteRevenue;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        
        // Settings functions
        window.loadSettingsPage = loadSettingsPage;
        window.checkNotificationStatus = checkNotificationStatus;
        window.saveGoogleChatWebhook = saveGoogleChatWebhook;
        window.testGoogleChatNotification = testGoogleChatNotification;
        window.showSetupInstructions = showSetupInstructions;
    </script>
</body>

</html>