<!DOCTYPE html>
<html lang="th">

<head>
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบสินค้า Beef Good</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_red.css">
    <link href="https://cdn.datatables.net/v/bs5/dt-2.2.2/date-1.5.5/r-3.0.4/datatables.min.css" rel="stylesheet"
        integrity="sha384-1J1LAHaYmA8AXBKEwhykiJmyo7zmhJIUlWIRZPHuX+qDRljv5UcH4RQsMGAT5d4i" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .text-beef {
            color: #8B4513;
        }

        .btn-beef {
            background-color: #8B4513;
        }

        .select,
        #locale {
            width: 100%;
        }

        .like {
            margin-right: 10px;
        }
    </style>
</head>

<body class="bg-light">
    <nav class="navbar bg-black navbar-dark m-0 py-1 navbar-expand-md shadow-sm no-print">
        <div class="container-fluid" data-bs-theme="dark">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://img5.pic.in.th/file/secure-sv1/beef-good-logo.png" alt="Beef Good Logo" height="40"
                    class="d-inline-block align-text-top me-2 rounded-circle bg-white">
                <span class="text-beef fw-bold">Beef Good</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-target="#invent-tab-pane">
                            <i class="bi bi-plus-circle-fill"></i>&nbsp;นำเข้าสินค้า</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-target="#print-tab-pane">
                            <i class="bi bi-printer-fill"></i>&nbsp;พิมพ์ใบรายการ</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="tab-content no-print" id="myTabContent">
        <div class="tab-pane fade show active" id="invent-tab-pane" role="tabpanel" aria-labelledby="invent-tab"
            tabindex="0">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="text-center mt-3 h4 text-beef fw-bold">ระบบนำเข้าสินค้า</div>
                        <p class="text-center text-secondary">ใช้เครื่องสแกนหรือป้อนรหัสบาร์โค้ดด้านล่าง</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="input-group">
                            <input type="text" class="form-control barcode-input shadow-none" id="barcodeInput"
                                placeholder="สแกนหรือป้อนรหัสบาร์โค้ด" autofocus>
                            <button class="btn btn-dark border-0" type="button" id="addItemBtn">
                                <i class="bi bi-plus-circle"></i> เพิ่มรายการ
                            </button>

                        </div>

                    </div>
                </div>
                <div class="row mt-2 justify-content-center">
                    <div class="col-12 text-center" id="inventoryHeader" style="display: none;">
                        <div class="card my-3 bg-beef-subtle shadow-sm">
                            <div class="card-body py-3">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h6 class="fw-bold text-beef mb-1">จำนวนชิ้น</h6>
                                        <p class="fs-5 mb-0" id="itemCount">0</p>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="fw-bold text-beef mb-1">น้ำหนักรวม</h6>
                                        <p class="fs-5 mb-0" id="totalWeight">0.00 กก.</p>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="fw-bold text-beef mb-1">ราคารวม</h6>
                                        <p class="fs-5 mb-0" id="totalPrice">0 บาท</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4" id="actionButtons" style="display: none;">
                        <button class="btn btn-dark rounded-3 w-100 mt-2" type="button" id="saveBtn">
                            <i class="bi bi-floppy-fill"></i> บันทึก
                        </button>
                    </div>
                    <div class="col-12 mt-2 text-center" id="inventoryContainer">
                        <div class="inventory-empty" id="emptyState">
                            <i class="bi bi-upc-scan scan-icon display-1"></i>
                            <p class="mb-0">สแกนบาร์โค้ดสินค้าเพื่อเพิ่มข้อมูล</p>
                            <small class="text-muted">ระบบจะบันทึกข้อมูลการสแกนอัตโนมัติ</small>
                        </div>
                        <!-- Inventory items will be added here dynamically -->
                    </div>
                </div>

                <!-- History Modal -->
                <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-beef-subtle">
                                <h5 class="modal-title text-beef" id="historyModalLabel">ประวัติการสแกน</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="history-list" id="historyList">
                                    <!-- History items will be added here dynamically -->
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">ปิด</button>
                                <button type="button" class="btn btn-danger" id="clearHistoryBtn">ล้างประวัติ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="print-tab-pane" role="tabpanel" aria-labelledby="print-tab" tabindex="0">
            <div class="container">
                <div class="row mt-3 justify-content-center">
                    <div class="col-12 text-center">
                        <h4 class="text-beef fw-bold">พิมพ์ใบรายการ</h4>
                    </div>
                    <div class="col-md-6 text-center" id="dateFilter">
                        <label for="dateInput" class="form-label">เลือกวันที่
                            หรือเว้นว่างหากต้องการแสดงข้อมูลทั้งหมด</label>
                        <input type="text" class="form-control text-center" id="dateInput"
                            placeholder="เลือกวันที่ หรือเว้นว่างหากต้องการแสดงข้อมูลทั้งหมด" name="dateInput">
                        <button class="btn btn-dark mt-2" id="searchBtn">
                            <i class="bi bi-search"></i>
                            ค้นหารายการ
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12 text-center" id="printReport" style="display: none">
                        <button class="btn btn-dark" id="printBtn"><i class="bi bi-printer-fill"></i> พิมพ์</button>
                    </div>
                    <div class="col-12 table-responsive mt-3">
                        <table id="table" class="table table-striped table-bordered table-hover" style="width: 100%">
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Item Template -->
    <template id="item-template">
        <div class="inventory-item p-2 rounded-3 bg-danger-subtle mb-2" data-barcode="">
            <div class="item-card">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h5 class="card-title mb-0 item-name fw-bold">ชื่อสินค้า</h5>
                        <div class="d-flex align-items-center">
                            <h5 class="card-title mb-0 item-id">รหัสสินค้า</h5>
                            <button class="btn btn-sm btn-danger delete-btn ms-2 me-2 py-0 px-1" title="ลบรายการ">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row g-1">
                        <div class="col-6 text-start">
                            <p class="mb-0 "><span class="text-black-50">น้ำหนัก </span><span class="item-weight">0.00
                                    กก.</span></p>
                        </div>
                        <div class="col-6 txt-start">
                            <p class="mb-0 "><span class="text-black-50">ราคาขาย </span><span class="item-price">0.00
                                    บาท</span></p>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white p-1 rounded-3">
                    <div class="d-flex justify-content-between align-items-center px-1">
                        <small class="text-muted item-scan-time fs-smaller">สแกนเมื่อ: เดี๋ยวนี้</small>
                        <button class="btn btn-sm bg-beef-subtle text-beef details-btn py-0 px-2">
                            รายละเอียด <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <!-- Table Details Modal -->
    <div class="modal fade no-print" id="tableDetailsModal" tabindex="-1" aria-labelledby="tableDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-beef-subtle">
                    <h5 class="modal-title text-beef" id="tableDetailsModalLabel">รายละเอียดรายการ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="input-group input-group mb-1">
                                <span class="input-group-text fw-bold text-bg-danger">วันที่:</span>
                                <span class="form-control" id="detailDate"></span>
                            </div>
                        </div>
                        <div class="col-6">
                            <!-- <p class="mb-1"><strong>เลขที่บิล:</strong> <span id="detailBillId"></span></p> -->
                            <div class="input-group input-group mb-1">
                                <span class="input-group-text fw-bold text-bg-danger">เลขที่บิล:</span>
                                <span class="form-control" id="detailBillId"></span>
                            </div>
                        </div>
                        <div class="col-6">
                            <!-- <p class="mb-1"><strong>น้ำหนักรวม:</strong> <span id="detailTotalWeight"></span> กก.</p> -->
                            <div class="input-group input-group mb-1">
                                <span class="input-group-text fw-bold text-bg-danger">น้ำหนักรวม:</span>
                                <span class="form-control" id="detailTotalWeight"></span>
                            </div>
                        </div>
                        <div class="col-6">
                            <!-- <p class="mb-1"><strong>ราคารวม:</strong> <span id="detailTotalPrice"></span> บาท</p> -->
                            <div class="input-group input-group mb-1">
                                <span class="input-group-text fw-bold text-bg-danger">ราคารวม:</span>
                                <span class="form-control" id="detailTotalPrice"></span>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="detailsTable">
                            <thead class="table-dark">
                                <tr class="text-center">
                                    <th class="text-center">#</th>
                                    <th class="text-center">ชื่อสินค้า</th>
                                    <th class="text-center">ประเภท</th>
                                    <th class="text-center">เกรด</th>
                                    <th class="text-center">น้ำหนัก</th>
                                    <th class="text-center">จำนวน</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody" class="text-center"></tbody>
                            <!-- Details will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-dark" id="printDetailsBtn">
                        <i class="bi bi-printer-fill"></i> พิมพ์รายละเอียด
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid" id="print-area" style="display: none;">
        <div class="row">
            <div class="col-12 text-center mt-3">
                <h4 class="text-beef fw-bold">ใบรายการสินค้า</h4>
                <p class="text-secondary">วันที่: <span id="printDate"></span></p>
            </div>
            <div class="col-12 mt-3" id="printTableContainer">
                <!-- Print table will be generated here -->
            </div>
        </div>

    </div>
    <script>
        // Sample data for demonstration - in real implementation, this would come from your backend
        let scanHistory = JSON.parse(localStorage.getItem('beefScanHistory')) || [];
        const historyLimit = 500; // Limit history items
        const dt_lang = {
            processing: '<div class="text-beef">กำลังโหลดข้อมูล...</div>',
            searchPlaceholder: "ค้นหา",
            search: "ค้นหา:",
            lengthMenu: "แสดง _MENU_ รายการ",
            info: "แสดงรายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            infoEmpty: "แสดงรายการ 0 ถึง 0 จาก 0 รายการ",
            infoFiltered: "(กรองจากทั้งหมด _MAX_ รายการ)",
            loadingRecords: "กำลังโหลดข้อมูล...",
            zeroRecords: "ไม่พบรายการที่ค้นหา",
            emptyTable: "ยังไม่มีรายการในวันนี้ หากต้องการสั่งพิมพ์ย้อนหลังกรุณาเลือกวันอื่นที่มีรายการ",
            paginate: {
                first: "หน้าแรก",
                previous: "ก่อนหน้า",
                next: "ถัดไป",
                last: "หน้าสุดท้าย"
            },
            aria: {
                sortAscending: ": เรียงจากน้อยไปมาก",
                sortDescending: ": เรียงจากมากไปน้อย"
            }
        }
        const demo_data = <?!= getBarcodeDatas() ?>; // Fetch data from Google Sheets
        $(document).ready(function () {
            moment.locale('th'); // Set Thai locale for moment.js
            $('#dateInput').flatpickr({
                locale: 'th',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: "j F Y",
                defaultDate: moment().format('YYYY-MM-DD'),
                onChange: function (selectedDates, dateStr, instance) {
                    $('#table').DataTable().ajax.reload(null, false);
                }
            });
            $('#tableDetailsModal').on('shown.bs.modal', function () {
                $('#detailsTable').DataTable({
                    language: dt_lang,
                    paging: false,
                }).draw(false)
                let inputgroupwidth = Math.max(...$('.input-group-text').toArray().map(e => $(e).width()));
                console.log("🚀 ~ inputgroupwidth:", inputgroupwidth)
                $('.input-group-text').css('min-width', inputgroupwidth + 'pt');
            }).on('hidden.bs.modal', function () {
                $('#detailsTable').DataTable().destroy();
            });
            const barcodeInput = $('#barcodeInput');
            const historyBtn = $('#historyBtn');
            const clearHistoryBtn = $('#clearHistoryBtn');
            const addItemBtn = $('#addItemBtn');
            const saveBtn = $('#saveBtn');
            const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            scanHistory = scanHistory.filter(item => item.barcode);
            localStorage.setItem('beefScanHistory', JSON.stringify(scanHistory));
            scanHistory.forEach(item => {
                searchInventory(item.barcode, true);
            });
            // Set focus to barcode input
            // barcodeInput.focus();

            // Search for barcode when Enter is pressed or search button is clicked
            barcodeInput.on('keydown', function (e) {
                const barcode = $(this).val().trim();
                if (e.key === 'Enter' || barcode.length === 18) {
                    if (barcode) {
                        searchInventory(barcode);
                        $(this).val('').focus();
                    }
                }
            });


            addItemBtn.on('click', function () {
                const barcode = barcodeInput.val().trim();
                if (barcode) {
                    searchInventory(barcode);
                    barcodeInput.val('').focus();
                }
            });

            // Open history modal
            historyBtn.on('click', function () {
                renderHistory();
                historyModal.show();
            });

            saveBtn.on('click', function () {
                let history = JSON.parse(localStorage.getItem('beefScanHistory')) || [];
                console.log("🚀 ~ saveBtn.on ~ history:", history);
                Swal.fire({
                    title: 'กำลังบันทึกข้อมูล',
                    text: 'กรุณารอสักครู่...',
                    icon: 'warning',
                    confirmButtonColor: '#8B4513',
                    customClass: {
                        popup: 'rounded-4'
                    },
                    didOpen: () => {
                        Swal.showLoading();
                    }
                })
                google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                    console.log("🚀 ~ google.script.run.withFailureHandler ~ res:", res)
                    if (res.success) {
                        $('#inventoryHeader, #actionButtons').hide();
                        Swal.fire({
                            title: 'บันทึกข้อมูลสำเร็จ',
                            text: 'ข้อมูลได้ถูกบันทึกลง Google Sheets เรียบร้อยแล้ว',
                            icon: 'success',
                            confirmButtonColor: '#8B4513',
                            customClass: {
                                popup: 'rounded-4'
                            },
                            timer: 1500,
                            showConfirmButton: false
                        });
                        localStorage.removeItem('beefScanHistory');
                        scanHistory = [];
                        $('.inventory-item').remove(); // Clear inventory items
                        $('#emptyState').show(); // Show empty state
                    } else {
                        Swal.fire({
                            title: 'บันทึกข้อมูลไม่สำเร็จ',
                            text: 'กรุณาลองใหม่อีกครั้ง',
                            icon: 'error',
                            confirmButtonColor: '#8B4513',
                            customClass: {
                                popup: 'rounded-4'
                            }
                        });
                    }
                })
                    .saveDataToSheet(history);
            });
            $('.nav-link').click(function () {
                console.log('clicked');
                $('.nav-link').removeClass('active');
                $('.tab-pane').removeClass('show active');
                $(this).addClass('active');
                const target = $(this).data('bs-target');
                $(target).addClass('show active');
                historyModal.hide();
                if (target === '#invent-tab-pane') {
                    barcodeInput.focus();
                } else {
                    $('#dateInput').focus();
                    // $('#table').DataTable().ajax.reload(null, false);
                }
            });

            setTimeout(() => {
                getPrintData($('#dateInput').val());
            }, 1000);

            $('#searchBtn').click(function () {
                $('#table').DataTable().ajax.reload(null, false);
            });

            // Handle delete button click on inventory items
            $(document).on('click', '.delete-btn', function (e) {
                e.stopPropagation(); // Prevent event bubbling
                const itemElement = $(this).closest('.inventory-item');
                const itemName = itemElement.find('.item-name').text();

                Swal.fire({
                    title: 'ยืนยันการลบ',
                    text: `คุณต้องการลบ "${itemName}" ออกจากรายการหรือไม่?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'ลบรายการ',
                    cancelButtonText: 'ยกเลิก',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Remove the item
                        itemElement.fadeOut(300, function () {
                            itemElement.remove();
                            scanHistory = scanHistory.filter(item => item.barcode !== itemElement.data('barcode'));
                            localStorage.setItem('beefScanHistory', JSON.stringify(scanHistory));
                            // Update totals
                            updateTotals();
                            // Show empty state if no items left
                            if (scanHistory.length === 0) {
                                $('#inventoryHeader, #actionButtons').hide();
                                $('#emptyState').show();
                            }
                        });

                        // Show notification
                        showNotification('success', 'ลบรายการสำเร็จ', `ลบ "${itemName}" ออกจากรายการแล้ว`);
                    }
                });
            });

            // Clear history
            clearHistoryBtn.on('click', function () {
                Swal.fire({
                    title: 'ยืนยันการลบ',
                    text: 'คุณต้องการลบประวัติการสแกนทั้งหมดหรือไม่?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#8B4513',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'ลบประวัติ',
                    cancelButtonText: 'ยกเลิก',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        scanHistory = [];
                        localStorage.setItem('beefScanHistory', JSON.stringify(scanHistory));
                        renderHistory();
                        Swal.fire({
                            title: 'ลบประวัติแล้ว',
                            icon: 'success',
                            customClass: {
                                popup: 'rounded-4'
                            },
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
            });

            // Handle click on history item
            // $(document).on('click', '.history-item', function () {
            //     const barcode = $(this).data('barcode');
            //     historyModal.hide();
            //     searchInventory(barcode);
            //     barcodeInput.val('').focus();
            // });

            // Auto focus on barcode input when page is clicked
            $(document).on('click', function (e) {
                // Don't focus if clicking on a button, input or inside the history modal
                if (!$(e.target).is('button, input') &&
                    !$(e.target).closest('.modal').length) {
                    barcodeInput.focus();
                }
            });

            // Keep input in focus even after showing alerts
            $(document).on('shown.bs.modal hidden.bs.modal', function () {
                setTimeout(() => barcodeInput.focus(), 100);
            });
        });

        // Search inventory by barcode
        function searchInventory(barcode, isInitial = false) {
            let data = demo_data
            // Check if barcode has the correct length (18 digits)
            if (barcode.length !== 18 || !/^\d{18}$/.test(barcode)) {
                showNotification('error', 'รูปแบบบาร์โค้ดไม่ถูกต้อง', 'บาร์โค้ดต้องเป็นตัวเลข 18 หลักเท่านั้น');
                return;
            }
            if (barcode == '000000000000000000') {
                // save data
                localStorage.setItem('beefScanHistory', JSON.stringify(scanHistory));
                console.log("🚀 ~ searchInventory ~ scanHistory:", scanHistory);
                return;
            }

            // Extract information from barcode
            const productId = barcode.substring(4, 8);
            console.log("🚀 ~ searchInventory ~ productId:", productId)
            const weightRaw = barcode.substring(8, 13);
            const priceRaw = barcode.substring(13, 18);

            const weight = parseFloat(weightRaw) / 1000;
            const price = parseInt(priceRaw);
            console.log(data[Number(productId).toString()]);
            const product = data[Number(productId).toString()];

            // Create item data directly from barcode
            const item = {
                fullname: product.fullProductName || 'ไม่พบข้อมูลสินค้า',
                name: product.productName || '',
                type: product.type || '',
                grade: product.grade || '',
                productId: productId,
                productionDate: moment().format('YYYY-MM-DD HH:mm:ss'),
                weight: weight,
                price: price,
                barcode: barcode
            };

            // Hide empty state if visible
            $('#emptyState').hide();

            // Add to history

            // Create and show the item card

            // Show notification
            if (!isInitial) {
                addToHistory(item);
                showNotification('success', 'อ่านบาร์โค้ดสำเร็จ', `รหัสสินค้า: ${productId}, น้ำหนัก: ${weight} กก., ราคา: ${price} บาท`);
            }
            renderInventoryItem(barcode, item, productId);
        }

        // Render inventory item card
        function renderInventoryItem(barcode, item) {
            console.log("🚀 ~ renderInventoryItem ~ item:", item)
            $('#emptyState').hide(); // Hide empty state if visible
            $('#inventoryHeader, #actionButtons').show(); // Show header and action buttons
            // Clone the template
            const template = document.getElementById('item-template');
            const itemElement = document.importNode(template.content, true);

            $(itemElement).find('.inventory-item').attr('data-barcode', barcode); // Set barcode data attribute

            // Set item data
            $(itemElement).find('.item-name').text(item.fullname);
            $(itemElement).find('.item-id').text(item.productId);

            // Set only weight
            $(itemElement).find('.item-weight').text(item.weight + ' กก.');

            $(itemElement).find('.item-price').text(item.price + ' บาท');

            // Set only production date
            const productionDate = new Date(item.productionDate);
            $(itemElement).find('.item-production-date').text();

            // Hide expiry badge since we're not displaying it
            $(itemElement).find('.expiry-badge').hide();

            // Set scan time
            $(itemElement).find('.item-scan-time').text('สแกนเมื่อ: ' + (moment().format('DD/MM/YYYY HH:mm')));

            // Update details button click to show simplified details
            $(itemElement).find('.details-btn').on('click', function () {
                showSimplifiedItemDetails(barcode, item);
            });

            // Add to container
            const container = $('#inventoryContainer');
            container.prepend(itemElement);

            // Animate
            setTimeout(() => {
                container.find('.inventory-item').first().addClass('show');
            }, 10);
        }

        // Add to scan history
        function addToHistory(item) {
            scanHistory.unshift(item);
            localStorage.setItem('beefScanHistory', JSON.stringify(scanHistory));
        }

        // Render history list
        function renderHistory() {
            const historyList = $('#historyList');
            historyList.empty();

            if (scanHistory.length === 0) {
                historyList.html('<div class="text-center py-4 text-muted">ไม่มีประวัติการสแกน</div>');
                return;
            }

            scanHistory.forEach(item => {
                const timestamp = new Date(item.timestamp);
                const historyItem = $(`
                    <div class="history-item" data-barcode="${item.barcode}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${item.fullname}</strong>
                                <div class="text-muted small">${item.weight} กก. ${item.price} บาท</div>
                            </div>
                            <small class="text-muted">${moment(item.productionDate).format('HH:mm')}</small>
                        </div>
                    </div>
                `);
                historyList.append(historyItem);
            });
        }

        // Show item details modal
        function showItemDetails(barcode, item) {
            Swal.fire({
                title: item.fullname,
                html: `
                    <div class="text-start px-2">
                        <div class="mb-3 d-flex justify-content-between">
                            <div>
                                <span class="badge bg-light text-dark border">รหัส: ${barcode}</span>
                            </div>
                            <div>
                                <span class="badge bg-success">น้ำหนัก: ${item.weight} กก.</span>
                            </div>
                        </div>
                        <table class="table">
                            <tr>
                                <td><strong>ชื่อสินค้า:</strong></td>
                                <td>${item.fullname}</td>
                            </tr>
                            <tr>
                                <td><strong>ประเภท:</strong></td>
                                <td>${item.type}</td>
                            </tr>
                            <tr>
                                <td><strong>เกรด:</strong></td>
                                <td>${item.grade}</td>
                            </tr>
                            <tr>
                                <td><strong>วันที่ผลิต:</strong></td>
                                <td>${formatDate(new Date(item.productionDate))}</td>
                            </tr>
                            <tr>
                                <td><strong>วันหมดอายุ:</strong></td>
                                <td>${formatDate(new Date(item.expiryDate))}</td>
                            </tr>
                            <tr>
                                <td><strong>แหล่งที่มา:</strong></td>
                                <td>${item.source}</td>
                            </tr>
                            <tr>
                                <td><strong>ราคา:</strong></td>
                                <td>${item.price} บาท</td>
                            </tr>
                        </table>
                    </div>
                `,
                showConfirmButton: true,
                confirmButtonText: 'ปิด',
                confirmButtonColor: '#8B4513',
                customClass: {
                    popup: 'rounded-4'
                }
            });
        }

        // Show simplified item details modal - shows only product ID, weight, price, and production date
        function showSimplifiedItemDetails(barcode, item) {
            Swal.fire({
                title: item.fullname,
                html: `
                    <div class="text-start px-2">
                        <div class="mb-3 d-flex justify-content-between">
                            <div>
                                <span class="badge bg-light text-dark border">รหัส: ${barcode}</span>
                            </div>
                            <div>
                                <span class="badge bg-success">น้ำหนัก: ${item.weight} กก.</span>
                            </div>
                        </div>
                        <table class="table">
                            <tr>
                                <td><strong>รหัสสินค้า:</strong></td>
                                <td>${barcode.substring(2, 8)}</td>
                            </tr>
                            <tr>
                                <td><strong>น้ำหนัก:</strong></td>
                                <td>${item.weight} กก.</td>
                            </tr>
                            <tr>
                                <td><strong>ราคาขาย:</strong></td>
                                <td>${item.price} บาท</td>
                            </tr>
                            <tr>
                                <td><strong>วันที่ผลิต:</strong></td>
                                <td>${moment(item.productionDate).format('DD/MM/YYYY HH:mm')}</td>
                            </tr>
                        </table>
                    </div>
                `,
                showConfirmButton: true,
                confirmButtonText: 'ปิด',
                confirmButtonColor: '#8B4513',
                customClass: {
                    popup: 'rounded-4'
                }
            });
        }

        // Show notification
        function showNotification(type, title, message) {
            const toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                customClass: {
                    popup: 'rounded-4'
                }
            });

            toast.fire({
                icon: type,
                title: title,
                text: message
            });
        }

        // Format date as DD/MM/YYYY
        function formatDate(date) {
            return date.toLocaleDateString('th-TH', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Format time as HH:MM
        function formatTime(date) {
            return date.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        // Update totals when items are added
        function updateTotals() {
            let itemCount = $('.inventory-item').length;
            let totalWeight = 0;
            let totalPrice = 0;

            $('.inventory-item').each(function () {
                const weightText = $(this).find('.item-weight').text();
                const priceText = $(this).find('.item-price').text();

                const weight = parseFloat(weightText.replace(' กก.', ''));
                const price = parseInt(priceText.replace(' บาท', ''));

                totalWeight += weight;
                totalPrice += price;
            });

            $('#itemCount').text(itemCount);
            $('#totalWeight').text(totalWeight.toFixed(2) + ' กก.');
            $('#totalPrice').text(totalPrice + ' บาท');
        }

        // Override renderInventoryItem to call updateTotals
        const originalRenderInventoryItem = renderInventoryItem;
        renderInventoryItem = function (barcode, item) {
            originalRenderInventoryItem(barcode, item);
            updateTotals();
        };

        function getPrintData() {
            let table = $('#table').DataTable({
                scrollX: true,
                severSide: false,
                processing: true,
                ajax: function (data, callback, settings) {
                    const date = $('#dateInput').val();
                    console.log("🚀 ~ date:", date)
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                        if (res.success) {
                            const printData = JSON.parse(res.data);
                            callback({
                                data: printData,
                                recordsTotal: printData.length,
                                recordsFiltered: printData.length
                            });
                        } else {
                            Swal.fire({
                                title: 'ไม่สามารถดึงข้อมูลได้',
                                text: 'กรุณาลองใหม่อีกครั้ง',
                                icon: 'error',
                                confirmButtonColor: '#8B4513',
                                customClass: {
                                    popup: 'rounded-4'
                                }
                            });
                        }
                    }).getPrintData(date);
                },
                language: dt_lang,
                order: [[0, 'desc']],
                columns: [
                    { title: 'เลขที่บิล', data: 'billId' },
                    { title: 'จำนวนรายการ', data: null, render: function (data, type, row) { return row.data.length; } },
                    {
                        title: 'น้ำหนักรวม (กก.)', data: 'totalWeight', render: function (data, type, row) {
                            return data.toLocaleString({
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + ' กก.';
                        }
                    },
                    {
                        title: 'ราคารวม (บาท)', data: 'totalPrice', render: function (data, type, row) {
                            return data.toLocaleString({
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + ' บาท';
                        }
                    },
                    {
                        title: 'วันที่บันทึก', data: 'productionDate',
                        render: function (data, type, row) {
                            if (data === '') return data
                            if (type == 'filter' || type == 'sort') {
                                return moment(data).toDate().getTime();
                            }
                            return moment(data).format('HH:mm');
                        }
                    },
                    {
                        title: 'รายละเอียด',
                        data: null,
                        render: function (data, type, row) {
                            return '<button class="btn btn-sm text-bg-danger details-btn py-0 px-2" data-barcode="' + row.barcode + '">รายละเอียด <i class="bi bi-arrow-right"></i></button>'
                        }
                    },
                    {
                        title: 'สั่งพิมพ์',
                        data: null,
                        render: function (data, type, row) {
                            return '<button class="btn btn-sm print-btn py-0 px-2" data-barcode="' + row.barcode + '"><i class="bi bi-printer-fill text-beef"></i></button>'
                        }
                    }
                ],
                columnDefs: [
                    {
                        targets: '_all',
                        className: 'text-center dt-header-center dt-nowrap',
                    },
                    {
                        targets: 4,
                        orderable: false,
                        searchable: false,
                    }
                ],
            });
            $('#table').on('click', '.details-btn', function () {
                let row = table.row($(this).closest('tr')).data();
                console.log("Row data:", row);

                // Populate modal with bill details
                $('#detailDate').text(moment(row.productionDate).format('DD/MM/YYYY'));
                $('#detailBillId').text(row.billId);
                $('#detailTotalWeight').text(row.totalWeight.toLocaleString() + ' กก.');
                $('#detailTotalPrice').text(row.totalPrice.toLocaleString() + ' บาท');

                // Clear previous details
                $('#detailsTableBody').empty();

                // Add items to details table
                if (row.data && row.data.length > 0) {
                    row.groupId = Object.groupBy(row.data, function (x) {
                        return x[9].slice(4)
                    });
                    Object.keys(row.groupId)
                        .forEach((key, index) => {
                            row.groupId[key] = row.groupId[key].sort((a, b) => {
                                return a[3].localeCompare(b[3], 'th', { numeric: true });
                            })
                            let item = row.groupId[key][0]
                            $('#detailsTableBody').append(`
                            <tr>
                                <td class="text-center text-nowrap">${index + 1}</td>
                                <td class="text-center text-nowrap">${item[3]}</td>
                                <td class="text-center text-nowrap">${item[4]}</td>
                                <td class="text-end text-nowrap">${item[5]}</td>
                                <td class="text-end text-nowrap">${row.groupId[key][0][6].toLocaleString({
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            })} กก.</td>
                                <td class="text-center">${row.groupId[key].length}</td>
                            </tr>
                        `);
                        });
                } else {
                    $('#detailsTableBody').append(`
                        <tr>
                            <td colspan="5" class="text-center">ไม่พบรายการสินค้า</td>
                        </tr>
                    `);
                }

                // Show the modal
                $('#tableDetailsModal').modal('show');

                // Setup print button
                $('#printDetailsBtn').off('click').on('click', function () {
                    printBillDetails(row);
                });
            });

            $('#table').on('click', '.print-btn', function () {
                const row = table.row($(this).closest('tr')).data();
                console.log("Row data:", row);
                if (row.data?.length == 0) {
                    Swal.fire({
                        title: 'ไม่สามารถพิมพ์ได้',
                        text: 'ไม่มีรายการสินค้าในบิลนี้',
                        icon: 'warning',
                        confirmButtonColor: '#8B4513',
                        customClass: {
                            popup: 'rounded-4'
                        }
                    });
                    return;
                }
                row.data = row.data.sort((a, b) => {
                    return moment(b[6]).toDate().getTime() - moment(a[6]).toDate().getTime();
                })
                row.groupId = Object.groupBy(row.data, function (x) {
                    return x[9].slice(4)
                });
                printBillDetails(row);
            });
        }

        function printBillDetails(row) {
            console.log("🚀 ~ printBillDetails ~ row:", row)
            let print_html = `
            <div class="row my-3">
                <div class="col-12 text-end mb-3">
                    <p><b>เลขที่บิล</b>:  ${row.billId}</p>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-4 text-start">
                    <p class="text-nowrap"><b>วันที่</b>:  ${moment(row.productionDate).format('DD/MM/YYYY')}</p>
                </div>
                <div class="col-4 text-start">
                    <p class="text-nowrap"><b>น้ำหนักรวม</b>:  ${row.totalWeight.toLocaleString()} กก.</p>
                </div>
                <div class="col-4 text-start">
                    <p class="text-nowrap"><b>จำนวน</b>:  ${row.data.length} รายการ</p>
                </div>
                <div class="col-12">
                    <label class="text-nowrap"><b>รายละเอียด</b></label>
                    <textarea class="form-control" rows="2" readonly></textarea>
                </div>
            </div>
            <div class="row mb-3">
                <table class="table table-bordered" id="detailsTablePrint">  
                    <tbody id="detailsTableBodyPrint">
                        <tr class="text-center text-nowrap">
                            <th class="text-center">#</th>
                            <th class="text-center">ชื่อสินค้า</th>
                            <th class="text-center">ประเภท</th>
                            <th class="text-center">เกรด</th>
                            <th class="text-center">น้ำหนัก (กก.)</th>
                            <th class="text-center">จำนวน</th>
                        </tr>
                    </tbody>
                </table>
            </div>`;
            $('#print-area').html(print_html);
            if (row.data && row.data.length > 0) {
                Object.keys(row.groupId)
                    .sort((a, b) => {
                        return a.localeCompare(b, 'th', { numeric: true });
                    })
                    .forEach((key, index) => {
                        let item = row.groupId[key][0]
                        $('#detailsTableBodyPrint').append(`
                            <tr>
                                <td class="text-center text-nowrap">${index + 1}</td>
                                <td class="text-center text-nowrap">${item[3]}</td>
                                <td class="text-center text-nowrap">${item[4]}</td>
                                <td class="text-end text-nowrap">${item[5]}</td>
                                <td class="text-end text-nowrap">${row.groupId[key][0][6].toLocaleString({
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        })} กก.</td>
                                <td class="text-center">${row.groupId[key].length}</td>
                            </tr>
                        `);
                    });
            } else {
                $('#detailsTableBodyPrint').append(`
                    <tr>
                        <td colspan="5" class="text-center">ไม่พบรายการสินค้า</td>
                    </tr>
                `);
            }
            // Print the content of the print area
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write('<html><head><title>Print Bill Details</title>');
            printWindow.document.write('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">');
            printWindow.document.write('<style>body{font-family: "Mitr", sans-serif;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container">');
            printWindow.document.write($('#print-area').html());
            printWindow.document.write('</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.onload = function () {
                printWindow.print();
                printWindow.close();
            };
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <script src="https://cdn.datatables.net/v/bs5/dt-2.2.2/date-1.5.5/r-3.0.4/datatables.min.js"
        integrity="sha384-rLmuC6QiRpU3tKULE0+0yoUC4bOdfliJtgfKQnEIX1VqsucsKqaDl7qb0fCvbkxy"
        crossorigin="anonymous"></script>
</body>

</html>