<!DOCTYPE html>
<html lang="th">

<head>
    <base target="_top">
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบลงทะเบียนประวัติโค</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_red.css">
    <link
        href="https://cdn.datatables.net/v/bs5/dt-2.3.0/b-3.2.3/date-1.5.5/fh-4.0.1/r-3.0.4/sl-3.0.0/datatables.min.css"
        rel="stylesheet" integrity="sha384-pDoMXaoekHsQmb1L6aeyRL/WoJRQnDTYvUeWu4LbiTVT2Vhp2niYUKgdwBE/Tnl8"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #8B4513;
            /* Brown - main brand color */
            --secondary-color: #D2B48C;
            /* Tan - complementary color */
            --accent-color: #F5DEB3;
            /* Wheat - light accent */
            --dark-color: #3E2723;
            /* Dark brown - for depth */
            --light-color: #FEFAF5;
            /* Off-white - for backgrounds */
        }

        body {
            background-color: var(--light-color);
            color: #212529;
        }

        .text-beef {
            color: var(--primary-color);
        }

        .bg-beef {
            background-color: var(--primary-color);
            color: white;
        }

        .bg-beef-light {
            background-color: var(--secondary-color);
            color: var(--dark-color);
        }

        .btn-beef {
            background-color: var(--primary-color);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-export-cow {
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            padding: 8px 12px;
            margin-right: 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .btn-beef:hover {
            background-color: var(--dark-color);
            color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .card {
            border-color: var(--secondary-color);
            border-radius: 15px;
            overflow: hidden;
        }

        .card-header {
            background-color: var(--primary-color);
            border-bottom: none;
            padding: 1rem 1.5rem;
        }

        .nav-tabs .nav-link {
            color: var(--accent-color);
            border: none;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 8px 8px 0 0;
        }

        .nav-tabs .nav-link.active {
            background-color: transparent;
            color: white;
            border-bottom: 3px solid white;
        }

        .nav-tabs .nav-link:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: transparent;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(139, 69, 19, 0.25);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Logo styling */
        .logo-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
        }

        .logo-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .logo-image:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .navbar {
            background: linear-gradient(to right, var(--dark-color), var(--primary-color));
            padding: 0.75rem 1rem;
        }

        .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .select,
        #locale {
            width: 100%;
        }

        .like {
            margin-right: 10px;
        }

        /* Additional animation styles */
        .star-shape {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            animation: floatAnimation linear infinite;
        }

        @keyframes floatAnimation {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: var(--opacity);
            }

            90% {
                opacity: var(--opacity);
            }

            100% {
                transform: translateY(-100vh) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        .img-grid-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 4px;
        }

        .img-grid-col {
            flex: 33.33%;
            max-width: 33.33%;
            padding: 0 8px;
        }

        .img-grid-col img {
            /* margin-top: 8px; */
            vertical-align: middle;
            width: 100%;
        }

        .btn-muted {
            background-color: var(--secondary-color) !important;
            color: var(--dark-color) !important;
        }

        /* Enhanced checkbox styling for better contrast */
        .select-cow,
        .select-all-cows {
            width: 18px;
            height: 18px;
            border: 2px solid var(--primary-color);
            border-radius: 3px !important;
            background-color: #fff;
            cursor: pointer;
            margin-right: 5px;
            vertical-align: middle;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .select-cow:checked,
        .select-all-cows:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .select-cow:focus,
        .select-all-cows:focus {
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.25);
            outline: none;
        }

        .dt-head-nowrap {
            white-space: nowrap;
        }

        .temp-readonly {
            background-color: var(--secondary-color) !important;
            color: var(--dark-color) !important;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Dashboard styles */
        .dashboard-item {
            transition: transform 0.3s ease;
        }

        .dashboard-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dashboard-icon {
            width: 56px;
            height: 56px;
            font-size: 1.5rem;
        }

        table.dataTable {
            tr {

                td,
                th {
                    vertical-align: middle !important;
                }
            }
        }

        /* Summary Chart Styles */
        .table-beef {
            background-color: rgba(139, 69, 19, 0.1);
        }

        #cowSummaryBtn {
            transition: all 0.3s;
        }

        #cowSummaryBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        @media print {

            .no-print,
            .no-print * {
                display: none !important;
            }

            .modal {
                position: static;
                padding: 0;
                margin: 0;
                width: 100%;
            }

            .modal-dialog {
                width: 100%;
                max-width: none;
                margin: 0;
            }

            .modal-content {
                border: none;
                box-shadow: none;
            }
        }
    </style>
</head>

<body class="bg-light">
    <nav class="navbar navbar-dark m-0 py-2 navbar-expand-md shadow-sm no-print">
        <div class="container-fluid" data-bs-theme="dark">
            <a class="navbar-brand d-flex align-items-center" href="<?!= base_url() ?>">
                <img src="https://img5.pic.in.th/file/secure-sv1/efa573c6-eec8-41c0-8ec6-81129a372e9a.jpg"
                    alt="POKPA FARM Logo" height="45"
                    class="d-inline-block align-text-top me-2 rounded-circle border border-2 border-light">
                <span class="fw-bold" style="color: var(--accent-color);">POKPA FARM</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item" id="userInfoContainer" style="display: none;">
                        <span class="nav-link d-flex align-items-center text-light">
                            <i class="fa-solid fa-user me-2"></i>
                            <span id="currentUsername">Username</span>
                        </span>
                    </li>
                    <li class="nav-item" id="logoutBtnContainer" style="display: none;">
                        <button class="nav-link d-flex align-items-center" id="logoutBtn">
                            <i class="fa-solid fa-right-from-bracket"></i>&nbsp;<span id="logoutText"
                                style="display:none">ออกจากระบบ</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Login and Register Form Section -->
    <div class="container py-5" id="authContainer">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-lg border-0 rounded-lg mt-3" data-aos="fade-up" data-aos-duration="1000">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="authTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="login-tab" data-bs-toggle="tab"
                                    data-bs-target="#login" type="button" role="tab" aria-controls="login"
                                    aria-selected="true">เข้าสู่ระบบ</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="register-tab" data-bs-toggle="tab"
                                    data-bs-target="#register" type="button" role="tab" aria-controls="register"
                                    aria-selected="false">ลงทะเบียน</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body p-4">
                        <div class="tab-content" id="authTabsContent">
                            <!-- Login Form -->
                            <div class="tab-pane fade show active" id="login" role="tabpanel"
                                aria-labelledby="login-tab">
                                <div class="text-center mb-4">
                                    <div class="logo-container">
                                        <img src="https://img5.pic.in.th/file/secure-sv1/efa573c6-eec8-41c0-8ec6-81129a372e9a.jpg"
                                            alt="POKPA FARM Logo" class="logo-image">
                                    </div>
                                    <h4 class="text-beef fw-bold">เข้าสู่ระบบ POKPA FARM</h4>
                                    <p class="text-muted">กรอกข้อมูลเพื่อเข้าสู่ระบบจัดการข้อมูลโค</p>
                                </div>
                                <form id="loginForm">
                                    <div class="form-floating mb-3">
                                        <input class="form-control" id="loginUsername" type="text"
                                            placeholder="ชื่อผู้ใช้" required />
                                        <label for="loginUsername">ชื่อผู้ใช้</label>
                                        <div class="invalid-feedback mt-2">กรุณากรอกชื่อผู้ใช้</div>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input class="form-control" id="loginPassword" type="password"
                                            placeholder="รหัสผ่าน" required />
                                        <label for="loginPassword">รหัสผ่าน</label>
                                        <div class="invalid-feedback mt-2">กรุณากรอกรหัสผ่าน</div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-center mt-4 mb-0">
                                        <button class="btn btn-beef fw-bold rounded-3" type="submit"
                                            style="min-width: 200px;">
                                            <i class="fa-solid fa-right-to-bracket me-2"></i>
                                            เข้าสู่ระบบ
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Register Form -->
                            <div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
                                <div class="text-center mb-4">
                                    <div class="logo-container">
                                        <img src="https://img5.pic.in.th/file/secure-sv1/efa573c6-eec8-41c0-8ec6-81129a372e9a.jpg"
                                            alt="POKPA FARM Logo" class="logo-image">
                                    </div>
                                    <h4 class="text-beef fw-bold">ลงทะเบียนใช้งานระบบ</h4>
                                    <p class="text-muted">สร้างบัญชีใหม่เพื่อใช้งานระบบจัดการข้อมูลโค</p>
                                </div>
                                <form id="registerForm">
                                    <div class="form-floating mb-3">
                                        <input class="form-control" id="fullname" type="text" placeholder="ชื่อ"
                                            required />
                                        <label for="fullname">ชื่อ-นามสกุล</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input class="form-control" id="phone" type="tel" placeholder="เบอร์โทรศัพท์"
                                            required />
                                        <label for="phone">เบอร์โทรศัพท์</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input class="form-control" id="registerEmail" type="email"
                                            placeholder="name@example.com" />
                                        <label for="registerEmail">อีเมล <small
                                                class="text-muted">(ไม่บังคับ)</small></label>
                                        <div class="invalid-feedback mt-2">กรุณากรอกอีเมลให้ถูกต้อง</div>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <textarea class="form-control" id="registerAddress" placeholder="ที่อยู่"
                                            required rows="5" style="min-height: 100px;"></textarea>
                                        <label for="registerAddress">ที่อยู่</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input class="form-control" id="username" type="text" placeholder="ชื่อผู้ใช้"
                                            required />
                                        <label for="username">ชื่อผู้ใช้</label>
                                        <div class="invalid-feedback mt-2" id="invalid-username"></div>
                                        <div class="valid-feedback mt-2">ชื่อผู้ใช้สามารถใช้งานได้</div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="form-floating mb-3 mb-md-0">
                                                <input class="form-control" id="registerPassword" type="password"
                                                    placeholder="รหัสผ่าน" required />
                                                <label for="registerPassword">รหัสผ่าน</label>
                                                <div class="invalid-feedback mt-2">รหัสผ่านต้องมีอย่างน้อย 8 ตัวอักษร
                                                </div>
                                                <div class="valid-feedback mt-2">รหัสผ่านถูกต้อง</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <input class="form-control" id="confirmPassword" type="password"
                                                    placeholder="ยืนยันรหัสผ่าน" required />
                                                <label for="confirmPassword">ยืนยันรหัสผ่าน</label>
                                                <div class="invalid-feedback mt-2">รหัสผ่านไม่ตรงกัน</div>
                                                <div class="valid-feedback mt-2">รหัสผ่านตรงกัน</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 mb-0">
                                        <div class="d-grid">
                                            <button class="btn btn-beef fw-bold rounded-3" type="submit"
                                                style="min-width: 200px;">ลงทะเบียน</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <main>
        <div class="container-fluid d-none" id="mainContainer">
            <!-- Dashboard Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow-lg border-0 rounded-lg mt-3" data-aos="fade-up" data-aos-duration="800">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-beef fw-bold">ภาพรวมข้อมูลโค</h5>
                            <button class="btn btn-beef btn-sm d-none" id="cowSummaryBtn"
                                data-bs-target="#cowSummaryModal" data-bs-toggle="modal">
                                <i class="fa-solid fa-chart-line me-2"></i>สรุปยอดวัวเข้า-ออก
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="row g-0">
                                <div class="col-md-4">
                                    <div class="dashboard-item d-flex align-items-center p-4 border-end">
                                        <div
                                            class="dashboard-icon bg-beef-light rounded-circle me-3 d-flex align-items-center justify-content-center">
                                            <i class="fa-solid fa-cow fa-2x text-beef"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-0">จำนวนโคทั้งหมด</h6>
                                            <h2 class="fw-bold text-beef mb-0" id="totalCowCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="dashboard-item d-flex align-items-center p-4 border-end">
                                        <div
                                            class="dashboard-icon bg-primary-subtle rounded-circle me-3 d-flex align-items-center justify-content-center">
                                            <i class="fa-solid fa-mars fa-2x text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-0">จำนวนโคเพศผู้</h6>
                                            <h2 class="fw-bold text-primary mb-0" id="maleCowCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="dashboard-item d-flex align-items-center p-4">
                                        <div
                                            class="dashboard-icon bg-danger-subtle rounded-circle me-3 d-flex align-items-center justify-content-center">
                                            <i class="fa-solid fa-venus fa-2x text-danger"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-0">จำนวนโคเพศเมีย</h6>
                                            <h2 class="fw-bold text-danger mb-0" id="femaleCowCount">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Dashboard Section -->

            <div class="row justify-content-center">
                <div class="col-12">
                    <div class="card shadow-lg border-0 rounded-lg mt-3" data-aos="fade-up" data-aos-duration="1000">
                        <div class="card-header bg-beef text-light text-center">
                            <h4 class="fw-bold">ระบบจัดการข้อมูลโค</h4>
                        </div>

                        <div class="card-body p-2">
                            <div class="table-responsive p-2">
                                <table class="table table-striped table-bordered" id="cowDataTable">
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid d-none" id="loadingContainer">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6 text-center mt-5">
                    <h4 class="text-beef fw-bold">กำลังโหลดข้อมูล...</h4>
                    <p class="text-muted">กรุณารอสักครู่</p>
                    <div class="spinner-border text-beef" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid d-none" id="errorContainer">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6 text-center mt-5">
                    <h4 class="text-danger fw-bold">เกิดข้อผิดพลาดในการโหลดข้อมูล</h4>
                    <p class="text-muted">กรุณาลองใหม่อีกครั้ง</p>
                    <button class="btn btn-beef" id="retryBtn">ลองอีกครั้ง</button>
                </div>
            </div>
        </div>
        <div class="container-fluid d-none" id="logoutContainer">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6 text-center mt-5">
                    <h4 class="text-beef fw-bold">ออกจากระบบเรียบร้อยแล้ว</h4>
                    <p class="text-muted">กรุณาเข้าสู่ระบบอีกครั้ง</p>
                </div>
            </div>
        </div>
    </main>
    <div class="modal fade" id="addCowModal" tabindex="-1" aria-labelledby="addCowModalLabel" aria-hidden="true"
        data-static="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-beef text-light">
                    <h5 class="modal-title" id="addCowModalLabel">เพิ่มข้อมูลโค</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCowForm">
                        <div class="row mb-3 g-3">
                            <div class="col-md-6 d-none">
                                <label for="userID"><i class="fas fa-id-card"></i> Member ID</label>
                                <input type="text" class="form-control bg-secondary-subtle" id="userID" name="userID"
                                    readonly>
                            </div>
                            <div class="col-md-6 d-none">
                                <label for="cowID"><i class="fas fa-tag me-1"></i>
                                    cowID</label>
                                <input type="text" class="form-control" id="cowID" name="cowID" required readonly
                                    value="AUTO ID">
                            </div>
                            <div class="col-md-6 d-none">
                                <label for="farmID"><i class="fas fa-tag me-1"></i>
                                    รหัสฟาร์ม *</label>
                                <input type="text" class="form-control" id="farmID" name="farmID"
                                    oninput="checkFarmID(this.value)">
                            </div>
                            <div class="col-md-6">
                                <label for="cowName"><i class="fas fa-tag me-1"></i>
                                    รหัสโค/ชื่อโค *</label>
                                <input type="text" class="form-control" id="cowName" name="cowName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="birthDate"><i class="fas fa-calendar-alt me-1"></i>
                                    วันเกิด *</label>
                                <input type="text" class="form-control datepicker" id="birthDate" name="birthDate"
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label for="feedDate"><i class="fas fa-calendar-alt me-1"></i>
                                    วันที่ขุน</label>
                                <input type="text" class="form-control datepicker" id="feedDate" name="feedDate"
                                    equiredr>
                            </div>
                            <div class="col-md-6">
                                <label for="cowGender"><i class="fas fa-venus-mars me-1"></i>
                                    เพศ *</label>
                                <select class="form-select" id="cowGender" name="cowGender" required>
                                    <option value="" selected disabled>เลือกเพศ</option>
                                    <option value="ผู้">ผู้</option>
                                    <option value="เมีย">เมีย</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="fcowCode"><i class="fas fa-dna me-1"></i>
                                    Fโค</label>
                                <input type="text" class="form-control" id="fcowCode" name="fcowCode" required>
                            </div>
                            <div class="col-md-6 d-none">
                                <label for="cowStatus"><i class="fas fa-info-circle me-1"></i>
                                    สถานะโค *</label>
                                <select class="form-select" id="cowStatus" name="cowStatus" required>
                                    <option value="" selected disabled>เลือกสถานะ</option>
                                    <option value="อยู่ในฟาร์ม">อยู่ในฟาร์ม</option>
                                    <option value="อยู่กับสมาชิก" selected>อยู่กับสมาชิก</option>
                                    <option value="ส่งออกแล้ว">ส่งออกแล้ว</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3 g-3">
                            <div class="col-md-6">
                                <label for="motherCode"><i class="fas fa-venus me-1"></i>
                                    รหัสแม่/ชื่อแม่</label>
                                <input type="text" class="form-control" id="motherCode" name="motherCode" required>
                            </div>
                            <div class="col-md-6">
                                <label for="fmotherCode"><i class="fas fa-dna me-1"></i>
                                    Fแม่</label>
                                <input type="text" class="form-control" id="fmotherCode" name="fmotherCode" required>
                            </div>
                        </div>
                        <div class="row mb-3 g-3">
                            <div class="col-md-6">
                                <label for="fatherCode"><i class="fas fa-mars me-1"></i>
                                    รหัสพ่อ/ชื่อพ่อ</label>
                                <input type="text" class="form-control" id="fatherCode" name="fatherCode" required>
                            </div>
                            <!-- <div class="col-md-6">
                                <label for="ffatherCode"><i class="fas fa-dna me-1"></i>
                                    Fพ่อ</label>
                                <input type="text" class="form-control" id="ffatherCode" name="ffatherCode" required>
                            </div> -->
                        </div>
                        <div class="row mb-3 g-3">
                            <div class="col-md-6">
                                <label for="cowOwner"><i class="fas fa-user me-1"></i>
                                    ชื่อเจ้าของโค/ที่มา *</label>
                                <input type="text" class="form-control" id="cowOwner" name="cowOwner" required>
                            </div>
                            <div class="col-md-6">
                                <label for="dataDate"><i class="fas fa-user me-1"></i>
                                    วันที่ลงทะเบียน</label>
                                <input type="text" class="form-control datepicker" id="dataDate" name="dataDate"
                                    required readonly>
                            </div>
                        </div>
                        <div class="row mb-3 g-3">
                            <div class="col-12">
                                <template id="img-template">
                                    <div
                                        class="d-flex justify-content-center align-items-center position-relative border rounded-3 mt-3">
                                        <span
                                            class="position-absolute top-0 start-100 translate-middle badge rounded-circle bg-danger"
                                            style="cursor: pointer;">
                                            x
                                        </span>
                                        <img src="https://getbootstrap.com/docs/5.3/assets/brand/bootstrap-logo-shadow.png"
                                            alt="" class="img-fluid rounded-3" style="cursor: pointer;">
                                    </div>
                                </template>
                                <label for="cowImage">
                                    <i class="bi bi-image-fill text-red"></i>
                                    รูปภาพ <span class="text-muted">(สูงสุด 5 รูป)</span><br>
                                    <small class="text-beef">* กรณีลูกโค กรุณาอัพรูปแม่โคด้วย</small>
                                </label>
                                <div class="rounded-3 border bg-secondary-subtle p-2 text-center"
                                    style="cursor: pointer;" id="image-label">
                                    คลิกเพื่อเลือกรูปภาพ
                                </div>
                                <input type="file" class="form-control rounded-3" id="cowImage" name="cowImage"
                                    accept="image/*" multiple hidden>
                                <input type="file" name="temp-imgs" id="temp-imgs" class="d-none" multiple hidden>
                                </label>
                            </div>
                            <div class="col-12">
                                <div class="img-grid-row d-flex flex-wrap mb-4">
                                    <div class="img-grid-col">

                                    </div>
                                    <div class="img-grid-col"></div>
                                    <div class="img-grid-col"></div>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="remark"><i class="fas fa-comment"></i> หมายเหตุ</label>
                                <textarea class="form-control" id="remark" name="remark" rows="3"></textarea>
                            </div>
                            <div class="col-md-6 d-none" id="purchasePriceContainer">
                                <label for="purchasePrice"><i class="fas fa-tag me-1"></i>
                                    ราคาซื้อเข้า (บาท)</label>
                                <input type="number" class="form-control" id="purchasePrice" name="purchasePrice"
                                    min="0" step="1">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <small class="text-muted">* หมายเหตุ: กรุณากรอกข้อมูลให้ครบถ้วน</small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-beef btn-secondary" id="saveCowBtn">บันทึกข้อมูล</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="exportFormModal" tabindex="-1" aria-labelledby="exportFormModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-beef text-light">
                    <h5 class="modal-title" id="exportFormModalLabel">แบบฟอร์มการส่งออก</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="exportForm">
                        <div class="row mb-3 g-3">
                            <div class="col-md-6">
                                <label for="exportDate"><i class="fas fa-calendar-alt me-1"></i> วันที่ออก</label>
                                <input type="text" class="form-control datepicker" id="exportDate" name="exportDate"
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label for="exportDestination"><i class="fas fa-map-marker-alt me-1"></i>
                                    ปลายทางที่ส่งโคไป</label>
                                <input type="text" class="form-control" id="exportDestination" name="exportDestination"
                                    required>
                            </div>
                        </div>
                        <div class="row mb-3 g-3">
                            <div class="col-md-6">
                                <label for="exportMaleCount"><i class="fas fa-mars me-1"></i> จำนวนผู้</label>
                                <input type="number" min="0" class="form-control bg-secondary-subtle"
                                    id="exportMaleCount" name="exportMaleCount" required readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="exportFemaleCount"><i class="fas fa-venus me-1"></i> จำนวนเมีย</label>
                                <input type="number" min="0" class="form-control bg-secondary-subtle"
                                    id="exportFemaleCount" name="exportFemaleCount" required readonly>
                            </div>
                        </div>
                        <div class="row mb-3 g-3">
                            <div class="col-md-12">
                                <label for="exportCowIds"><i class="fas fa-tag me-1"></i> เลขประจำตัวโค (cowId)</label>
                                <textarea class="form-control bg-secondary-subtle" id="exportCowIds" name="exportCowIds"
                                    rows="4" required readonly></textarea>
                                <small class="text-beef">กรณีหลายตัวให้คั่นด้วยเครื่องหมาย , (คอมม่า)</small>
                            </div>
                        </div>
                        <div class="row mb-3 g-3">
                            <div class="col-md-12">
                                <label for="exportRemarks"><i class="fas fa-comment me-1"></i> หมายเหตุ</label>
                                <textarea class="form-control" id="exportRemarks" name="exportRemarks"
                                    rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <small class="text-muted">* หมายเหตุ: กรุณากรอกข้อมูลให้ครบถ้วน</small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-beef" id="saveExportFormBtn">บันทึกข้อมูล</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="cowSummaryModal" tabindex="-1" aria-labelledby="cowSummaryModalLabel" aria-hidden="true"
        data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-beef text-light">
                    <h5 class="modal-title" id="cowSummaryModalLabel">สรุปยอดวัวเข้า-ออกประจำปี</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="summaryYear">
                                        <!-- จะเติมปีด้วย JavaScript -->
                                    </select>
                                    <label for="summaryYear">เลือกปี</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <canvas id="cowSummaryChart" style="width:100%; height:100%"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4 g-3">
                            <div class="col-md-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-header bg-beef-light">
                                        <h6 class="card-title mb-0 text-light fw-bold">สรุปการนำเข้า</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover" id="importSummaryTable">
                                                <thead>
                                                    <tr>
                                                        <th>เดือน</th>
                                                        <th class="text-end">จำนวนวัวเข้า</th>
                                                        <th class="text-end">เพศผู้</th>
                                                        <th class="text-end">เพศเมีย</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- จะเติมข้อมูลด้วย JavaScript -->
                                                </tbody>
                                                <tfoot>
                                                    <tr class="table-beef">
                                                        <th>รวมทั้งสิ้น</th>
                                                        <th class="text-end" id="totalImport">0</th>
                                                        <th class="text-end" id="totalImportMale">0</th>
                                                        <th class="text-end" id="totalImportFemale">0</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-header bg-beef-light">
                                        <h6 class="card-title mb-0 text-light fw-bold">สรุปการส่งออก</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover" id="exportSummaryTable">
                                                <thead>
                                                    <tr>
                                                        <th>เดือน</th>
                                                        <th class="text-end">จำนวนวัวออก</th>
                                                        <th class="text-end">เพศผู้</th>
                                                        <th class="text-end">เพศเมีย</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- จะเติมข้อมูลด้วย JavaScript -->
                                                </tbody>
                                                <tfoot>
                                                    <tr class="table-beef">
                                                        <th>รวมทั้งสิ้น</th>
                                                        <th class="text-end" id="totalExport">0</th>
                                                        <th class="text-end" id="totalExportMale">0</th>
                                                        <th class="text-end" id="totalExportFemale">0</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
        </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <script
        src="https://cdn.datatables.net/v/bs5/dt-2.3.0/b-3.2.3/date-1.5.5/fh-4.0.1/r-3.0.4/sl-3.0.0/datatables.min.js"
        integrity="sha384-NGgUUnjETvXZrx9vJMQOG/C654mzSDv63TrMt0zQmS1HW58fN4RdjorjyZqEMIZ9" crossorigin="anonymous">
        </script>

    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/tanaikech/ResumableUploadForGoogleDrive_js@master/resumableupload_js.min.js">
        </script>
    <script>
        $('#image-label').click(function () {
            $('#cowImage').click();
        });

        $('#cowImage').change(function (e) {
            let MAX_IMAGES = 5
            let files = e.target.files;
            let tempFiles = $('#temp-imgs')[0].files;
            let newFiles = Array.from(files);
            let allFiles = [...tempFiles, ...newFiles];

            // Check for duplicate files
            let fileNames = new Set();
            allFiles = allFiles.filter(file => {
                if (fileNames.has(file.name)) {
                    return false;
                } else {
                    fileNames.add(file.name);
                    return true;
                }
            });

            console.log("🚀 ~ allFiles.length:", allFiles.length)
            console.log("🚀 ~ $('.img-grid-col img').not('.isNew').length:", $('.img-grid-col img').not('.isNew').length)
            if (allFiles.length > MAX_IMAGES - $('.img-grid-col img').not('.isNew').length) {
                Swal.fire({
                    icon: 'error',
                    title: 'เลือกได้สูงสุด 5 รูป',
                    customClass: {
                        icon: 'text-danger',
                        title: 'text-danger',
                        content: 'text-dark',
                        popup: 'rounded-4'
                    },
                    showConfirmButton: false,
                    timer: 2000,
                    allowOutsideClick: false,
                    timerProgressBar: true
                })
                return false;
            }

            Swal.fire({
                iconHtml: '<i class="bi bi-hourglass-split text-danger"></i>',
                title: 'Loading..',
                customClass: {
                    icon: 'border-0',
                    title: 'text-danger',
                    content: 'text-dark',
                    popup: 'rounded-4'
                },
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                },
            })

            let datatransfer = new DataTransfer();
            allFiles.forEach(file => {
                datatransfer.items.add(file);
            });
            $('#temp-imgs')[0].files = datatransfer.files;

            renderImagePreview(allFiles);
        });

        function renderImagePreview(allFiles) {
            $('.img-grid-col .isNew').parent().remove()
            allFiles.forEach((file, i) => {
                let eq = (i + $('.img-grid-col img').not('.isNew').length) % 3;
                let reader = new FileReader();
                reader.onload = function (e) {
                    let img = $($('#img-template').html());
                    img.find('img').attr('src', e.target.result).addClass('isNew')
                    img.find('span').on('click', function () {
                        let datatransfer = new DataTransfer();
                        let files = $('#temp-imgs')[0].files;
                        for (let i = 0; i < files.length; i++) {
                            if (files[i].name != file.name) {
                                datatransfer.items.add(files[i]);
                            }
                        }
                        $('#temp-imgs')[0].files = datatransfer.files;
                        renderImagePreview([...datatransfer.files]);
                    });
                    img.find('img').on('click', function () {
                        showImagePreview(e.target.src);
                    });
                    let div = $('.img-grid-col').eq(eq)
                    div.append(img)
                    if (i == allFiles.length - 1) {
                        Swal.close();
                    }
                    $('#image-label').text('เลือกแล้ว (' + $('.img-grid-col img').length + ') รูป')
                }
                reader.readAsDataURL(file);
            });

        }

        // Set current date and user info when opening the add cow modal
        $('#addCowModal')
            .on('shown.bs.modal', function () {
                let session = JSON.parse(localStorage.getItem('userSession'));
                if (session) {
                    $('#userID').val(session.id);
                    $('#recorder').val(session.name);

                    const isEditMode = $('form#addCowForm').attr('data-editmode');
                    console.log("🚀 ~ isEditMode:", isEditMode)
                    const isMember = ROLE === 'Member';
                    console.log("🚀 ~ isMember:", isMember)

                    // Set date only for new records
                    if (!isEditMode) {
                        $('#dataDate').val(moment().format('YYYY-MM-DD'));
                        $('#farmID')
                            .attr('readonly', isMember)
                            .parent()
                            .toggleClass('d-none', isMember);
                    } else {
                        $('#farmID').attr('readonly', !isMember)
                            .parent()
                            .toggleClass('d-none', isMember);
                    }

                    $("#cowName").attr("required", isMember)

                    // // Configure farmID field based on user role (same for both edit and add modes)
                    // $('#farmID')
                    //     .toggleClass('bg-secondary-subtle', !isMember)
                    //     .attr('required', isMember)
                    //     .parent()
                    //     .toggleClass('d-none', !isMember);

                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบใหม่',
                        confirmButtonColor: 'var(--primary-color)'
                    }).then(() => {
                        localStorage.removeItem('session');
                        NProgress.start();
                        NProgress.inc();
                        window.open('<?!= base_url() ?>', '_top');
                    });
                }
            })
            .on('hide.bs.modal', function () {
                $('#addCowForm')[0].reset();
                $('#farmID').val('').attr('readonly', true).removeAttr('required').removeClass('bg-secondary-subtle').parent().addClass('d-none');
                $('#temp-imgs').val('');
                $('.img-grid-col').empty();
                $('#image-label').text('คลิกเพื่อเลือกรูปภาพ');
                $('form#addCowForm').removeAttr('data-editmode');
                $('#addCowForm').removeClass('was-validated');
                $('#saveCowBtn').removeAttr('disabled').text('บันทึกข้อมูล');
                $('.temp-readonly').removeClass('temp-readonly');
                $('#addCowModalLabel').text('เพิ่มข้อมูลโค');
            });

        $('#cowSummaryModal')
            .on('show.bs.modal', function () {
                // Load years dynamically
                const currentYear = new Date().getFullYear();
                const yearSelect = $('#summaryYear');
                yearSelect.empty();
                for (let year = currentYear; year >= 2000; year--) {
                    yearSelect.append(`<option value="${year}">${year}</option>`);
                }
                yearSelect.val(currentYear); // Set current year as default

                yearSelect.change(function () {
                    loadCowSummaryData($(this).val());
                });
                loadCowSummaryData(currentYear);
            });

        function loadCowSummaryData(year) {
            let isMobile = window.innerWidth < 768;
            let data = $('#cowDataTable').DataTable().rows().data().toArray();
            console.log("🚀 ~ data:", data);
            let months_data = new Array(12).fill({
                importCount: 0,
                importMale: 0,
                importFemale: 0,
                exportCount: 0,
                exportMale: 0,
                exportFemale: 0
            });
            months_data = months_data.map((month, index) => {
                let importData = data.filter(row => {
                    let date = new Date(row.farmInDate);
                    console.log("🚀 ~ date:", date);
                    return date.getFullYear() == year && date.getMonth() == index && row.cowStatus == 'อยู่ในฟาร์ม';
                });
                let exportData = data.filter(row => {
                    let date = new Date(row.exportDate);
                    return date.getFullYear() == year && date.getMonth() == index && row.cowStatus == 'ส่งออกแล้ว';
                });
                return {
                    importCount: importData.length,
                    importMale: importData.filter(row => row.cowGender == 'ผู้').length,
                    importFemale: importData.filter(row => row.cowGender == 'เมีย').length,
                    exportCount: exportData.length,
                    exportMale: exportData.filter(row => row.cowGender == 'ผู้').length,
                    exportFemale: exportData.filter(row => row.cowGender == 'เมีย').length
                };
            });
            console.log("🚀 ~ months_data:", months_data);

            // show chart
            const ctx = document.getElementById('cowSummaryChart').getContext('2d');
            if (window.cowSummaryChart && typeof window.cowSummaryChart.destroy === 'function') {
                window.cowSummaryChart.destroy();
            }
            window.cowSummaryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months_data.map((_, index) => moment().month(index).format('MMMM')),
                    datasets: [
                        {
                            label: 'วัวเข้า',
                            data: months_data.map(month => month.importCount),
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 4
                        },
                        {
                            label: 'วัวออก',
                            data: months_data.map(month => month.exportCount),
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    // maintainAspectRatio: false,
                    aspectRatio: isMobile ? 1 : 2.7,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `สรุปยอดวัวเข้า-ออกประจำปี ${year}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // update summary table
            $('#importSummaryTable').find('tbody, tfoot').empty();
            $('#exportSummaryTable').find('tbody, tfoot').empty();
            let totalImport = 0, totalImportMale = 0, totalImportFemale = 0;
            let totalExport = 0, totalExportMale = 0, totalExportFemale = 0;
            months_data.forEach((month, index) => {
                $('#importSummaryTable tbody').append(`
                    <tr>
                        <td>${moment().month(index).format('MMMM')}</td>
                        <td class="text-end">${month.importCount}</td>
                        <td class="text-end">${month.importMale}</td>
                        <td class="text-end">${month.importFemale}</td>
                    </tr>
                `);
                $('#exportSummaryTable tbody').append(`
                    <tr>
                        <td>${moment().month(index).format('MMMM')}</td>
                        <td class="text-end">${month.exportCount}</td>
                        <td class="text-end">${month.exportMale}</td>
                        <td class="text-end">${month.exportFemale}</td>
                    </tr>
                `);
                totalImport += month.importCount;
                totalImportMale += month.importMale;
                totalImportFemale += month.importFemale;
                totalExport += month.exportCount;
                totalExportMale += month.exportMale;
                totalExportFemale += month.exportFemale;
            });
            $('#importSummaryTable tfoot').append(`
                <tr class="table-beef">
                    <th>รวมทั้งสิ้น</th>
                    <th class="text-end" id="totalImport">${totalImport}</th>
                    <th class="text-end" id="totalImportMale">${totalImportMale}</th>
                    <th class="text-end" id="totalImportFemale">${totalImportFemale}</th>
                </tr>
            `);
            $('#exportSummaryTable tfoot').append(`
                <tr class="table-beef">
                    <th>รวมทั้งสิ้น</th>
                    <th class="text-end" id="totalExport">${totalExport}</th>
                    <th class="text-end" id="totalExportMale">${totalExportMale}</th>
                    <th class="text-end" id="totalExportFemale">${totalExportFemale}</th>
                </tr>
            `);
        }

        // Handle save cow button
        $('#saveCowBtn').click(function () {
            const form = $('#addCowForm')[0];

            // Check if required fields are filled
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // if ($('#temp-imgs')[0].files.length == 0 && $('.img-grid-col img').length == 0 && !$('form#addCowForm').attr('data-editmode')) {
            //      Swal.fire({
            //         icon: 'error',
            //       title: 'กรุณาเลือกรูปภาพ',
            //       customClass: {
            //           icon: 'text-danger',
            //          title: 'text-danger',
            //          content: 'text-dark',
            //          popup: 'rounded-4'
            //         },
            //           showConfirmButton: false,
            //         timer: 2000,
            //         allowOutsideClick: false,
            //         timerProgressBar: true
            //     })
            //    return false;
            //     }
            // Gather form data
            let userSession = JSON.parse(localStorage.getItem('userSession'));
            const formData = {
                userID: $('#userID').val(),
                role: userSession.role,
                recorderName: userSession.name,
                farmID: $('#farmID').val(),
                cowID: $('#cowID').val() == "AUTO ID" || $("cowID").val() == "" ? undefined : $('#cowID').val(),
                cowName: $('#cowName').val(),
                birthDate: $('#birthDate').val(),
                feedDate: $('#feedDate').val(),
                cowGender: $('#cowGender').val(),
                cowStatus: $('#cowStatus').val(),
                fcowCode: $('#fcowCode').val(),
                motherCode: $('#motherCode').val(),
                fmotherCode: $('#fmotherCode').val(),
                fatherCode: $('#fatherCode').val(),
                cowOwner: $('#cowOwner').val(),
                dataDate: $('#dataDate').val(),
                remark: $('#remark').val(),
                purchasePrice: $('#purchasePrice').val() || 0
            }
            NProgress.start();
            NProgress.inc();
            uploadFiles(formData.userID, new Date().getTime()).then((res) => {
                if ($('form#addCowForm').attr('data-editmode')) {
                    if (res.length > 0) {
                        res = [...res, ...$('.img-grid-col img').not('.isNew').toArray().map(img => {
                            return $(img).attr('src').split('/d/')[1]
                        })]
                    } else {
                        res = $('.img-grid-col img').not('.isNew').toArray().map(img => {
                            return $(img).attr('src').split('/d/')[1]
                        })
                    }
                }
                cowData = {
                    ...formData,
                    isEdit: $('form#addCowForm').attr('data-editmode') ? true : false,
                    cowImage: res,
                    role: ROLE

                };
                console.log(cowData);
                saveNewCow(cowData);
            })



            // Add cow to database (you would integrate with your backend here)
        });

        async function uploadFiles(userID, cowID) {
            const f = document.getElementById("temp-imgs");
            if (f.files.length == 0) {
                return []
            }
            Swal.fire({
                iconHtml: '<i class="bi bi-cloud-arrow-up-fill text-danger"></i>',
                title: 'กำลังอัพโหลดไฟล์',
                customClass: {
                    icon: 'border-0',
                    title: 'text-danger',
                    content: 'text-dark',
                    popup: 'rounded-4'
                },
                allowOutsideClick: false,
                html: '<div class="container-fluid"><div class="row" id="progress"></div></div>',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                },
            })
            const { token, folder_id } = await getDownloadToken(userID, cowID);
            let file = await new Promise((resolve, reject) => {
                let length = f.files.length;
                let count = 0;
                let uploadfiles = [];
                [...f.files].forEach((file, i) => {
                    let fr = new FileReader();
                    fr.fileName = file.name;
                    fr.fileSize = file.size;
                    fr.fileType = file.type;
                    fr.readAsArrayBuffer(file);
                    fr.onload = e => {
                        var id = "p" + ++i;
                        var div = $("<div>", { class: 'col-12 text-truncate' });
                        div.attr("id", id);
                        $("#progress").append(div);
                        $('#' + id).text('Initialising (' + fr.fileName + ')')
                        const f = e.target;
                        const resource = {
                            fileName: f.fileName,
                            fileSize: f.fileSize,
                            fileType: f.fileType,
                            fileBuffer: f.result,
                            accessToken: token,
                            folderId: folder_id,
                            fields: "id",
                        };
                        const ru = new ResumableUploadToGoogleDrive();
                        ru.Do(resource, function (res, err) {
                            if (err) {
                                console.log(err);
                                return;
                            }
                            console.log(res);
                            let msg = "";
                            if (res.status == 'start' || res.status == 'getLocation' || res.status == 'initialize') {
                                msg = '<i class="bi bi-cloud-arrow-up-fill"></i> กำลังเตรียมอัพโหลด ' + f.fileName;
                            }
                            else if (res.status == "Uploading") {
                                msg =
                                    '<i class="bi bi-hourglass-split text-start text-danger"></i> กำลังอัพโหลด ' +
                                    Math.round(
                                        (res.progressNumber.current / res.progressNumber.end) * 100
                                    ) +
                                    "% (" +
                                    f.fileName +
                                    ")";
                            } else {
                                msg = '<i class="bi bi-check-circle-fill text-start text-success"></i> อัพโหลดสำเร็จ  (' + f.fileName + ")";
                            }

                            // If you want to put the uploaded file information to the active Spreadsheet,
                            // please use the following function.
                            if (res.status == "Done") {
                                uploadfiles.push(res.result.id);
                                if (uploadfiles.length == length) {
                                    resolve(uploadfiles);
                                }
                            }

                            $('#' + id).html(msg)
                        });
                    };
                });
            });
            return file;
        }

        function getDownloadToken(userID, cowID) {
            return new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler((res) => {
                    res = JSON.parse(res);
                    if (res.success) {
                        resolve(res.data);
                    } else {
                        reject(res.message);
                    }
                }).getDownloadToken(userID, cowID);
            });
        }

        // Mock function to save a new cow
        function saveNewCow(cowData) {
            // Show loading indicator
            Swal.fire({
                iconHtml: '<i class="bi bi-hourglass-split text-danger"></i>',
                title: 'กำลังบันทึกข้อมูล',
                customClass: {
                    icon: 'border-0',
                    title: 'text-danger',
                    content: 'text-dark',
                    popup: 'rounded-4'
                },
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                },
            });
            $('#saveCowBtn').html('<span class="spinner-border spinner-border-sm me-2"></span>กำลังบันทึก...').prop('disabled', true);

            google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                res = JSON.parse(res);
                NProgress.done()
                if (res.success) {
                    // Hide loading indicator
                    Swal.close();
                    $('#addCowModal').modal('hide');
                    $('#addCowForm')[0].reset();
                    $('#saveCowBtn').html('บันทึกข้อมูล').prop('disabled', false);
                    $('#cowDataTable').DataTable().ajax.reload(updateDashboardCounts, false);
                    Toast.fire({
                        icon: 'success',
                        title: 'บันทึกข้อมูลโคเรียบร้อยแล้ว'
                    });
                } else {
                    // Show error message
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: res.message,
                        confirmButtonColor: 'var(--primary-color)'
                    });
                }
            }).addCow(cowData);
        }


        function editCow(button) {
            const row = $(button).closest('tr');

            if (row.hasClass('child')) {
                row = row.prev('tr');
            }
            const data = cowDataTable.row(row).data();
            console.log("🚀 ~ editCow ~ data:", data)
            // Populate the form with the data
            $('#userID').val(data.userID);
            $('#farmID').val(data.farmID)
            $('#cowID').val(data.cowID)
            $('#cowName').val(data.cowName);
            $('#birthDate')[0]._flatpickr.setDate(data.birthDate, true);
            $('#feedDate')[0]._flatpickr.setDate(data.feedDate, true);
            $('#cowGender').val(data.cowGender);
            $('#cowStatus').val(data.cowStatus);
            $('#fcowCode').val(data.fcowCode);
            $('#motherCode').val(data.motherCode);
            $('#fmotherCode').val(data.fmotherCode);
            $('#fatherCode').val(data.fatherCode);
            // $('#ffatherCode').val(data.ffatherCode);
            $('#cowOwner').val(data.cowOwner);
            $('#remark').val(data.remark);
            $('#purchasePrice').val(data.purchasePrice || 0);
            // Show the modal
            // Set the form to edit mode
            $('#addCowModalLabel').text('แก้ไขข้อมูลโค');
            $('#saveCowBtn').text('บันทึกการแก้ไข');
            $('form#addCowForm').attr('data-editmode', true);
            $('#temp-imgs').val('');
            $('#addCowModal').modal('show');


            // show image
            let images = [data.cowImage1, data.cowImage2, data.cowImage3, data.cowImage4, data.cowImage5].filter(img => img !== '');
            if (images.length > 0) {
                $('#image-label').text('เลือกรูปภาพ (' + images.length + ' รูป)');
                $('.img-grid-col').empty();
                images.forEach((img, i) => {
                    let imgElement = $($('#img-template').html());
                    $('.img-grid-col').eq(i % 3).append(imgElement)
                    imgElement.find('img').attr('src', img)
                    imgElement.find('span').addClass('span-delete').on('click', function () {
                        deleteImage(img, row, data)
                    });
                    imgElement.find('img').on('click', function () {
                        Swal.fire({
                            imageUrl: img,
                            imageWidth: '100%',
                            imageHeight: '100%',
                            showCloseButton: true,
                            showConfirmButton: false,
                            allowOutsideClick: false
                        });
                    });
                });
            }
            if (ROLE !== 'Member') {
                $('#dataDate')[0]._flatpickr.setDate(data.dataDate, true)
            } else {
                // set form to readonly if row.date  is passed for 7 days
                let date = moment(data.date).add(7, 'days').format('YYYY-MM-DD')
                if (moment(date).isBefore(moment())) {
                    $('form#addCowForm').find('input, select, textarea, #image-label, .span-delete').addClass('temp-readonly')
                    $('#saveCowBtn').attr('disabled', true).text('ไม่สามารถแก้ไขได้หลังจาก 7 วัน')
                }
                $('#dataDate').val(moment(data.dataDate).format('YYYY-MM-DD'));
            }
        }

        function deleteCow(button) {
            const row = $(button).closest('tr');
            if (row.hasClass('child')) {
                row = row.prev('tr');
            }
            const data = cowDataTable.row(row).data();
            Swal.fire({
                icon: 'question',
                title: 'ยืนยันการลบ',
                html: 'คุณต้องการลบข้อมูลโคนี้หรือไม่?<br>' +
                    '<span class="text-danger">**หากลบข้อมูลโคนี้จะไม่สามารถกู้คืนได้</span>',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ลบข้อมูล',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: 'var(--primary-color)',
                cancelButtonColor: '#6c757d',
                customClass: {
                    title: 'text-danger',
                    content: 'text-dark',
                    popup: 'rounded-4'
                },
            }).then((result) => {
                if (result.isConfirmed) {
                    // Remove row from DataTable
                    Swal.fire({
                        iconHtml: '<i class="bi bi-hourglass-split text-danger"></i>',
                        title: 'กำลังลบข้อมูล',
                        customClass: {
                            icon: 'border-0',
                            title: 'text-danger',
                            content: 'text-dark',
                            popup: 'rounded-4'
                        },
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading()
                        },
                    })
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                        res = JSON.parse(res);
                        NProgress.done()
                        if (res.success) {
                            // Show success message
                            Toast.fire({
                                icon: 'success',
                                title: 'ลบข้อมูลโคเรียบร้อยแล้ว'
                            });
                            cowDataTable.row(row).remove().draw();
                        } else {
                            // Show error message
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: res.message,
                                confirmButtonColor: 'var(--primary-color)',
                                customElements: {
                                    title: 'text-danger',
                                    content: 'text-dark',
                                    popup: 'rounded-4'
                                }
                            });
                        }
                    }).deleteCow(data.cowID, data.userID);
                }
            });
        }

        function deleteImage(url, row, data) {
            console.log("🚀 ~ deleteImage ~ data:", data)
            console.log("🚀 ~ deleteImage ~ url:", url)
            Swal.fire({
                icon: 'question',
                title: 'ยืนยันการลบ',
                html: 'คุณต้องการลบรูปภาพนี้หรือไม่?<br>' +
                    '<img src="' + url + '" class="img-fluid rounded-3 mt-2" style="width: auto; max-height: 200px;">' +
                    '<br><span class="text-danger">**หากลบรูปภาพนี้จะไม่สามารถกู้คืนได้</span>',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ลบรูปภาพ',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: 'var(--primary-color)',
                cancelButtonColor: '#6c757d',
                customClass: {
                    icon: 'border-0',
                    title: 'text-danger',
                    content: 'text-dark',
                    popup: 'rounded-4'
                },
            }).then((result) => {
                if (result.isConfirmed) {
                    NProgress.start()
                    NProgress.inc();
                    Swal.fire({
                        iconHtml: '<i class="bi bi-hourglass-split text-danger"></i>',
                        title: 'กำลังลบรูปภาพ',
                        customClass: {
                            icon: 'border-0',
                            title: 'text-danger',
                            content: 'text-dark',
                            popup: 'rounded-4'
                        },
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading()
                        },
                    })
                    let images = [data.cowImage1, data.cowImage2, data.cowImage3, data.cowImage4, data.cowImage5].filter(img => img !== '' && img !== url);
                    console.log("🚀 ~ deleteImage ~ images:", images);
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                        res = JSON.parse(res);
                        NProgress.done()
                        if (res.success) {
                            // Update the cow data table
                            data.cowImage1 = images[0] || '';
                            data.cowImage2 = images[1] || '';
                            data.cowImage3 = images[2] || '';
                            data.cowImage4 = images[3] || '';
                            data.cowImage5 = images[4] || '';
                            cowDataTable.row(row).data(data).draw(false);
                            $('.img-grid-col img').not('.isNew').parent().remove()
                            if (images.length > 0) {
                                images.forEach((img, i) => {
                                    let imgElement = $($('#img-template').html());
                                    $('.img-grid-col').eq(i % 3).prepend(imgElement)

                                    imgElement.find('img').attr('src', img);
                                    imgElement.find('span').on('click', function () {
                                        deleteImage(img, row, cowDataTable.row(row).data())
                                    });
                                    imgElement.find('img').on('click', function () {
                                        Swal.fire({
                                            imageUrl: img,
                                            imageWidth: '100%',
                                            imageHeight: '100%',
                                            showCloseButton: true,
                                            showConfirmButton: false,
                                            allowOutsideClick: false,
                                            customClass: {
                                                popup: 'rounded-4'
                                            }
                                        });
                                    });
                                });
                            }
                            $('#image-label').text('เลือกรูปภาพ (' + ($('.img-grid-col').find('img').length) + ' รูป)');
                            Toast.fire({
                                icon: 'success',
                                title: 'ลบรูปภาพเรียบร้อยแล้ว'
                            });
                        } else {
                            // Show error message
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: res.message,
                                confirmButtonColor: 'var(--primary-color)',
                                customClass: {
                                    title: 'text-danger',
                                    content: 'text-dark',
                                    popup: 'rounded-4'
                                }
                            });
                        }
                    }).deleteImage(url.split('/d/')[1], data.cowID, images, data.userID)

                }
            });
        }

        function changeStatus(button) {
            const row = $(button).closest('tr');
            if (row.hasClass('child')) {
                row = row.prev('tr');
            }
            const data = cowDataTable.row(row).data();
            console.log("🚀 ~ changeStatus ~ data:", data)
            let selectStatus = null
            Swal.fire({
                icon: 'question',
                title: 'เปลี่ยนสถานะโค',
                html: 'เลือกสถานะที่ต้องการเปลี่ยน<br>' +
                    '<div class="container-fluid p-4"><div class="row g-2" id="status">' +
                    '<div class="col-12"><input type="radio" class="btn-check rounded-3" name="status-radio" id="status2" value="อยู่กับสมาชิก" autocomplete="off">' +
                    '<label class="btn btn-outline-primary w-100" for="status2">อยู่กับสมาชิก</label></div>' +
                    '<div class="col-12"><input type="radio" class="btn-check rounded-3" name="status-radio" id="status1" value="อยู่ในฟาร์ม" autocomplete="off">' +
                    '<label class="btn btn-outline-success w-100" for="status1">อยู่ในฟาร์ม</label></div>' +
                    '<div class="col-12"><input type="radio" class="btn-check rounded-3" name="status-radio" id="status3" value="ส่งออกแล้ว" autocomplete="off">' +
                    '<label class="btn btn-outline-secondary w-100" for="status3">ส่งออก</label></div>' +
                    '</div></div>',
                didOpen: () => {
                    $('input[name="status-radio"]').on('change', function () {
                        $('input[name="status-radio"]').each(function () {
                            $('label[for="' + $(this).attr('id') + '"]').find('i').remove()
                        });
                        $(this).parent().find('label').html('<i class="bi bi-check-circle-fill "></i> ' + $(this).parent().find('label').text())
                        selectStatus = $(this).val()
                    })

                    if (data.cowStatus == 'อยู่กับสมาชิก') {
                        $('label[for="status1"]').text('รับเข้าฟาร์ม')
                    }
                    $('input[name="status-radio"][value="' + data.cowStatus + '"]').prop('checked', true).trigger('change')
                },
                showCancelButton: true,
                confirmButtonText: 'บันทึกการสถานะ',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: 'var(--primary-color)',
                cancelButtonColor: '#6c757d',
                customClass: {
                    icon: 'border-0',
                    title: 'text-danger',
                    content: 'text-dark',
                    popup: 'rounded-4'
                },
                preConFirm: () => {
                    const status = $('input[name="status-radio"]:checked')
                    if (status.length == 0) {
                        Swal.showValidationMessage('กรุณาเลือกสถานะที่ต้องการเปลี่ยน')
                        return false;
                    }
                    return status.val()
                },

            }).then(async (result) => {
                console.log("🚀 ~ changeStatus ~ result:", result)
                if (result.isConfirmed && selectStatus != null) {
                    console.log("🚀 ~ changeStatus ~ selectStatus:", selectStatus)
                    // If selected status is "ส่งออกแล้ว", show export form modal
                    let status_index = {
                        'อยู่กับสมาชิก': 1,
                        'อยู่ในฟาร์ม': 2,
                        'ส่งออกแล้ว': 3
                    }
                    if (status_index[data.cowStatus] > status_index[selectStatus]) {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถเปลี่ยนสถานะโคจาก ' + data.cowStatus + ' เป็น ' + selectStatus,
                            confirmButtonColor: 'var(--primary-color)',
                            customClass: {
                                title: 'text-danger',
                                content: 'text-dark',
                                popup: 'rounded-4'
                            }
                        });
                        return;
                    }
                    if (selectStatus === 'ส่งออกแล้ว') {
                        showExportFormModal([{
                            cowID: data.cowID,
                            name: data.cowName,
                            gender: data.cowGender,
                            farmID: data.farmID,
                        }]);
                        return;
                    } else if (selectStatus === 'อยู่ในฟาร์ม') {
                        let fid
                        await Swal.fire({
                            icon: 'info',
                            title: 'กรุณากรอกรหัสฟาร์ม',
                            html: '<input type="text" class="form-control text-center" id="swal-farmID" placeholder="กรอกรหัสฟาร์ม">',
                            focusConfirm: false,
                            showLoaderOnConfirm: true,
                            preConfirm: async () => {
                                const farmID = $('#swal-farmID').val()
                                if (!farmID) {
                                    Swal.showValidationMessage('กรุณากรอกรหัสฟาร์ม')
                                    return false;
                                }
                                let is_available = await checkfid(farmID, true)
                                console.log("🚀 ~ changeStatus ~ is_available:", is_available)
                                if (!is_available) {
                                    Swal.showValidationMessage('รหัสฟาร์มนี้ถูกใช้แล้ว')
                                    return false;
                                }
                                fid = farmID
                                return farmID;
                            },
                            didOpen: () => {
                                $('#swal-farmID').focus().on('input', function () {
                                    fid = $(this).val()
                                    console.log("🚀 ~ fid:", fid)
                                });
                            },
                            showCancelButton: true,
                            confirmButtonText: 'รับเข้าฟาร์ม',
                            cancelButtonText: 'ยกเลิก',
                            confirmButtonColor: 'var(--primary-color)',
                            cancelButtonColor: '#6c757d',
                            customClass: {
                                title: 'text-danger',
                                content: 'text-dark',
                                popup: 'rounded-4',
                                input: 'rounded-3',

                            },
                        }).then((result) => {
                            if (result.isConfirmed) {
                                data.farmID = fid
                            } else {
                                return false;
                            }
                        })
                    }


                    // Continue with original status change flow for other statuses
                    let userSession = JSON.parse(localStorage.getItem('userSession'));
                    NProgress.start()
                    NProgress.inc();
                    Swal.fire({
                        iconHtml: '<i class="bi bi-hourglass-split text-danger"></i>',
                        title: 'กำลังเปลี่ยนสถานะโค',
                        customClass: {
                            icon: 'border-0',
                            title: 'text-danger',
                            content: 'text-dark',
                            popup: 'rounded-4'
                        },
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading()
                        },
                    })
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                        res = JSON.parse(res);
                        NProgress.done()
                        if (res.success) {
                            // Update the cow data table
                            cowDataTable.ajax.reload(updateDashboardCounts, false);
                            Toast.fire({
                                icon: 'success',
                                title: 'เปลี่ยนสถานะโคเรียบร้อยแล้ว'
                            });
                        } else {
                            // Show error message
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: res.message,
                                confirmButtonColor: 'var(--primary-color)',
                                customClass: {
                                    title: 'text-danger',
                                    content: 'text-dark',
                                    popup: 'rounded-4'
                                }
                            });
                        }
                    }).changeStatus(data.cowID, selectStatus, userSession.id, userSession.name, data.farmID)
                }
            })
        }

        function showExportFormModal(data) {
            console.log("🚀 ~ showExportFormModal ~ data:", data);
            if (data.map(cow => cow.farmID).some(cow => !cow || cow === "")) {
                Swal.fire({
                    icon: 'error',
                    title: 'ยังไม่สามารถส่งออกได้',
                    html: 'พบโคที่เลือกบางตัวยังไม่ได้รับเข้าฟาร์ม' + '<br><span class="text-danger">กรุณารับเข้าฟาร์มก่อน</span>',
                    confirmButtonColor: 'var(--primary-color)',
                    customClass: {
                        icon: 'border-0',
                        title: 'text-danger',
                        content: 'text-dark',
                        popup: 'rounded-4'
                    },
                    confirmButtonText: 'ตกลง',
                })
                return
            }
            $('#exportFormModal').modal('show');
            let userSession = JSON.parse(localStorage.getItem('userSession'));
            $('#exportCowIds').attr('data-export-ids', data.map(cow => cow.cowID).join(',')).val(data.map(cow => cow.farmID).join(', '));
            $('#exportMaleCount').val(data.filter(cow => cow.gender === 'ผู้').length);
            $('#exportFemaleCount').val(data.filter(cow => cow.gender === 'เมีย').length);
            $('#exportForm').off('submit').on('submit', function (e) {
                e.preventDefault();
                let form = $(this)[0];
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                const exportData = {
                    cowIDs: $('#exportCowIds').attr('data-export-ids'),
                    farmIDs: $('#exportCowIds').val(),
                    exportDestination: $('#exportDestination').val(),
                    exportMaleCount: parseInt($('#exportMaleCount').val()),
                    exportFemaleCount: parseInt($('#exportFemaleCount').val()),
                    exportDate: $('#exportDate').val(),
                    exportRemarks: $('#exportRemarks').val(),
                    userId: userSession.id,
                    userName: userSession.name,
                };
                // Validate form data

                if (exportData.cowIDs.split(',').length !== (exportData.exportMaleCount + exportData.exportFemaleCount)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'จำนวนรหัส/ชื่อโคที่ส่งออก ไม่ตรงกับจำนวนที่เลือก',
                        confirmButtonColor: 'var(--primary-color)',
                        customClass: {
                            icon: 'border-0',
                            title: 'text-danger',
                            content: 'text-dark',
                            popup: 'rounded-4'
                        }
                    });
                    return;
                }
                Swal.fire({
                    iconHtml: '<i class="bi bi-hourglass-split text-danger"></i>',
                    title: 'กำลังบันทึกข้อมูลการส่งออก',
                    customClass: {
                        icon: 'border-0',
                        title: 'text-danger',
                        content: 'text-dark',
                        popup: 'rounded-4'
                    },
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading()
                    },
                });
                google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                    res = JSON.parse(res);
                    if (res.success) {
                        $('#exportFormModal').modal('hide');
                        Toast.fire({
                            icon: 'success',
                            title: 'บันทึกข้อมูลการส่งออกเรียบร้อยแล้ว'
                        });
                        cowDataTable.ajax.reload(function () {
                            console.log("reload..");
                            $('#exportCowIds').attr('data-export-ids', '').val('');
                            $('#exportForm')[0].reset();
                            $('#exportDate')[0]._flatpickr.setDate(new Date(), true);
                            if ($('.show-all-cows').is(':visible')) {
                                cowDataTable.buttons(1).trigger()
                            }
                            updateDashboardCounts();
                        }, false);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: res.message,
                            confirmButtonColor: 'var(--primary-color)',
                            customClass: {
                                icon: 'border-0',
                                title: 'text-danger',
                                content: 'text-dark',
                                popup: 'rounded-4'
                            }
                        });
                    }
                }).saveExportData(exportData);
            });
        }

        $('#cowDataTable').on('click', '.btn-delete-cow', function () {
            const id = $(this).data('id');
            // Implement delete cow functionality with confirmation
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบข้อมูลโคนี้ใช่หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ลบข้อมูล',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: 'var(--primary-color)',
                cancelButtonColor: '#6c757d',
                customElements: {
                    title: 'text-danger',
                    content: 'text-dark',
                    popup: 'rounded-4'
                },
            }).then((result) => {
                if (result.isConfirmed) {
                    // Remove row from DataTable
                    const row = $(this).closest('tr');
                    cowDataTable.row(row).remove().draw();

                    Toast.fire({
                        icon: 'success',
                        title: 'ลบข้อมูลโคเรียบร้อยแล้ว'
                    });
                }
            });
        });

        // Setup save export form button functionality
        $('#saveExportFormBtn').on('click', function () {
            $('#exportForm').submit()
        });


        let checIDtimeout = null;
        function checkFarmID(value, waiting = true) {
            let timeout = 0;
            if (waiting) timeout = 1000;
            else timerout = 1;
            if (checIDtimeout) {
                clearTimeout(checIDtimeout);
            }
            checIDtimeout = setTimeout(() => {
                NProgress.start();
                if (waiting == false) {
                    Swal.fire({
                        iconHtml: '<i class="bi bi-hourglass-split text-danger"></i>',
                        title: 'กำลังตรวจสอบรหัสโค',
                        customClass: {
                            icon: 'border-0',
                            title: 'text-danger',
                            content: 'text-dark',
                            popup: 'rounded-4'
                        },
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading()
                        },
                    });
                }

                checkfid(value, waiting)
            }, timeout);
        }

        async function checkfid(value, waiting = true) {
            let res = await new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler((res) => {
                    res = JSON.parse(res);
                    console.log("🚀 ~ google.script.run.withSuccessHandler ~ res:", res)
                    if (res.success) {
                        if (waiting) {
                            Swal.fire({
                                icon: 'success',
                                title: res.message,
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true,
                                customClass: {
                                    icon: 'border-0',
                                    title: 'text-success',
                                    content: 'text-dark',
                                    popup: 'rounded-4'
                                }
                            })
                        }
                    }
                    resolve(res.success)
                }).checkFarmID(value)
            });
            return res;
        }

    </script>
    <script>
        AOS.init();
        let Toast
        document.addEventListener("DOMContentLoaded", function () {
            NProgress.start();
            NProgress.inc();

            // Initialize datepicker for export form
            flatpickr("#exportDate", {
                locale: "th",
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: "j F Y",
                defaultDate: 'today',
            });

            // Custom SweetAlert2 theme to match our color scheme
            Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.onmouseenter = Swal.stopTimer;
                    toast.onmouseleave = Swal.resumeTimer;
                }
            });

            // Form submission handlers
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            // Add focus effect to forms
            // const formInputs = document.querySelectorAll('.form-control');
            // formInputs.forEach(input => {
            //     input.addEventListener('focus', function() {
            //         this.parentElement.classList.add('shadow-sm');
            //     });
            //     input.addEventListener('blur', function() {
            //         this.parentElement.classList.remove('shadow-sm');
            //     });
            // });

            if (loginForm) {
                loginForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    let formData = {
                        username: document.getElementById('loginUsername').value,
                        password: document.getElementById('loginPassword').value
                    }
                    $(this).find('button[type="submit"]').html('<span class="spinner-border spinner-border-sm me-2"></span>กำลังเข้าสู่ระบบ...').prop('disabled', true);
                    NProgress.start();
                    NProgress.inc();
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler((res) => {
                        res = JSON.parse(res);
                        if (res.success) {
                            // Show success message
                            $('#loginForm').trigger('reset');
                            $('#loginForm').find('.form-control').removeClass('is-valid').removeClass('is-invalid');
                            $('#loginForm').find('button[type="submit"]').html('เข้าสู่ระบบ').prop('disabled', false);
                            localStorage.setItem('userSession', JSON.stringify({
                                expired: moment().unix() + 7200, // 2 hours session
                                id: res.userInfo.id,
                                name: res.userInfo.name,
                                role: res.userInfo.role,
                            }))
                            ROLE = res.userInfo.role
                            initializeApp(res.data);
                            Swal.fire({
                                title: 'เข้าสู่ระบบสำเร็จ!',
                                icon: 'success',
                                showConfirmButton: false,
                                background: 'var(--light-color)',
                                iconColor: 'var(--primary-color)',
                                timer: 2000,
                                timerProgressBar: true,
                                customClass: {
                                    popup: 'rounded-4'
                                }
                            })
                        } else {
                            // Show error message
                            $('#loginForm').find('button[type="submit"]').html('เข้าสู่ระบบ').prop('disabled', false);
                            $('#loginForm').find('.form-control').removeClass('is-valid').removeClass('is-invalid');
                            $('#loginForm').trigger('reset');
                            Swal.fire({
                                title: 'เกิดข้อผิดพลาด!',
                                text: res.message,
                                icon: 'error',
                                confirmButtonText: 'ตกลง',
                                confirmButtonColor: 'var(--primary-color)',
                                background: 'var(--light-color)',
                                iconColor: 'var(--primary-color)',
                                customClass: {
                                    popup: 'rounded-4'
                                }
                            });
                        }

                    }).loginUser(formData);
                });
            }

            if (registerForm) {
                registerForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    let formData = {
                        fullname: document.getElementById('fullname').value,
                        phone: document.getElementById('phone').value,
                        email: document.getElementById('registerEmail').value,
                        address: document.getElementById('registerAddress').value,
                        username: document.getElementById('username').value,
                        password: document.getElementById('registerPassword').value,
                        confirmPassword: document.getElementById('confirmPassword').value
                    }

                    // Validate form data
                    if ($(this).find(':invalid').length > 0) {
                        $(this).find(':invalid').each(function () {
                            $(this).addClass('is-invalid');
                        });
                        Toast.fire({
                            icon: 'error',
                            title: 'กรุณากรอกข้อมูลให้ถูกต้อง'
                        });
                    }

                    if (formData.password !== formData.confirmPassword) {
                        Toast.fire({
                            icon: 'error',
                            title: 'รหัสผ่านไม่ตรงกัน'
                        });
                        return;
                    }

                    $(this).find('button[type="submit"]').html('<span class="spinner-border spinner-border-sm me-2"></span>กำลังลงทะเบียน...').prop('disabled', true);
                    NProgress.start();
                    NProgress.inc();
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler((res) => {
                        res = JSON.parse(res);
                        if (res.success) {
                            // Show success message
                            $('#registerForm').trigger('reset');
                            $('#registerForm').find('.form-control').removeClass('is-valid').removeClass('is-invalid');
                            $('#registerForm').find('button[type="submit"]').html('ลงทะเบียน').prop('disabled', false);
                            Swal.fire({
                                title: 'ลงทะเบียนสำเร็จ!',
                                html: 'กรุณาเข้าสู่ระบบเพื่อใช้งานระบบจัดการข้อมูลโค<br> ระบบจะนำท่านไปยังหน้าเข้าสู่ระบบใน 10 วินาที',
                                icon: 'success',
                                confirmButtonText: 'ไปหน้าเข้าสู่ระบบ',
                                confirmButtonColor: 'var(--primary-color)',
                                background: 'var(--light-color)',
                                iconColor: 'var(--primary-color)',
                                timer: 10000,
                                timerProgressBar: true,
                                customClass: {
                                    popup: 'rounded-4'
                                }
                            }).then(() => {
                                // Redirect to login page after successful registration
                                window.open('<?!= base_url() ?>', '_top');
                            });
                        } else {
                            // Show error message
                            Swal.fire({
                                title: 'เกิดข้อผิดพลาด!',
                                text: res.message,
                                icon: 'error',
                                confirmButtonText: 'ตกลง',
                                confirmButtonColor: 'var(--primary-color)',
                                background: 'var(--light-color)',
                                iconColor: 'var(--primary-color)',
                                customClass: {
                                    popup: 'rounded-4'
                                }
                            });
                        }

                    }).registerUser(formData);
                });
            }

            // Add background animation
            const createStars = () => {
                const container = document.querySelector('body');
                const count = 60;
                const colors = ['var(--secondary-color)', 'var(--accent-color)'];

                for (let i = 0; i < count; i++) {
                    const star = document.createElement('div');
                    star.className = 'star-shape';
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.animationDuration = `${Math.random() * 30 + 20}s`;
                    star.style.animationDelay = `${Math.random() * 5}s`;
                    star.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    star.style.width = `${Math.random() * 15 + 1}px`;
                    star.style.height = star.style.width;
                    star.style.opacity = Math.random() * 0.5;
                    container.appendChild(star);
                }
            };

            // // Only create background animation on larger screens
            // if (window.innerWidth > 100) {
            createStars();
            // }
        });
        let ROLE
        $(document).ready(function () {
            let session = localStorage.getItem('userSession');
            console.log("🚀 ~ session:", session)
            console.log("🚀 ~ moment().unix():", moment().unix());
            if (session == null || (JSON.parse(session).expired && JSON.parse(session).expired < moment().unix())) {
                localStorage.removeItem('userSession');
                initLoginForm();
            } else {
                session = JSON.parse(session);
                ROLE = session.role
                $('#currentUsername').text(session.name)
                localStorage.setItem('userSession', JSON.stringify(session));
                initializeApp();
            }
            $(window).on('resize', function () {
                $('#logoutBtn').on('mouseenter', function () {
                    $('#logoutText').show(400)
                }).on('mouseleave', function () {
                    $('#logoutText').hide(400)
                });
            });
            $(window).trigger('resize');
        });

        $('#logoutBtn').on('click', function () {
            localStorage.removeItem('userSession');
            NProgress.start();
            NProgress.inc();
            window.open('<?!= ScriptApp.getService().getUrl() ?>', '_top');
        });

        function initLoginForm() {
            $('#authContainer').removeClass('d-none');
            $('#logoutBtnContainer').hide();
            $('#authTabsContent').removeClass('d-none');
            $('#authTabs').removeClass('d-none');
            $('#authContainer').fadeIn(500);
        }

        let cowDataTable = null;
        function initializeApp() {

            flatpickr("#birthDate", {
                locale: "th",
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: "j F Y",
                maxDate: 'today'
            });

            flatpickr("#feedDate", {
                locale: "th",
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: "j F Y",
                // defaultDate: 'today',
            });

            $('#currentUsername').text(JSON.parse(localStorage.getItem('userSession')).name)
            $('#userInfoContainer').show()
            if (ROLE !== 'Member') {

                flatpickr("#dataDate", {
                    locale: "th",
                    dateFormat: 'Y-m-d',
                    altInput: true,
                    altFormat: "j F Y",
                    defaultDate: 'today',
                });
                $('#dataDate').attr('readonly', false).removeClass('bg-secondary-subtle')
                if (ROLE === 'Admin') {
                    $('#purchasePriceContainer').removeClass('d-none');
                }
            } else {
                $('#dataDate').attr('readonly', true).val(moment().format('YYYY-MM-DD')).addClass('bg-secondary-subtle')
            }
            $('#authContainer').fadeOut(500, function () {
                $('#mainContainer').removeClass('d-none').fadeIn(500);
                $('#logoutBtnContainer').show();
                $('#authTabsContent').addClass('d-none');
                $('#authTabs').addClass('d-none');
                // Initialize the cow data table
                cowDataTable = $('#cowDataTable').DataTable({
                    responsive: true,
                    scrollX: true,
                    serverSide: false,
                    processing: true,
                    ajax: function (data, callback, settings) {
                        let session = JSON.parse(localStorage.getItem('userSession'));
                        NProgress.start();
                        NProgress.inc();
                        google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                            res = JSON.parse(res);
                            console.log("🚀 ~ google.script.run.withFailureHandler ~ res:", res)
                            NProgress.done();
                            callback({
                                recordsTotal: res.total,
                                recordsFiltered: res.total,
                                data: res.data
                            });
                        }).getData(session.id, session.role !== 'Member');
                    },
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/th.json',
                    },
                    dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>' +
                        '<"row"<"col-sm-12 mt-2"tr>>' +
                        '<"row justify-content-between mt-2"<"col-12 col-md-auto mt-2 text-center"i><"col-12 col-md-auto text-center"p>>',
                    buttons: {
                        dom: {
                            button: {
                                className: 'btn btn-beef'
                            }
                        },
                        buttons: getButtonsBasedOnRole(ROLE),
                    },
                    columns: [
                        {
                            data: null,
                            title: '#',
                            className: 'dt-head-center dt-head-nowrap all',
                            render: function (data, type, row, meta) {
                                if (type === 'display') {
                                    return meta.row + meta.settings._iDisplayStart + 1;
                                }
                                return meta.row;
                            }
                        },
                        {
                            data: 'date',
                            title: 'วันที่',
                            visible: false,
                            render: function (data, type, row) {
                                if (type === 'display') {
                                    return moment(data).format('DD/MM/YYYY HH:mm:ss');
                                }
                                return new Date(data).getTime();
                            }
                        },
                        {
                            data: 'userID',
                            title: 'รหัสสมาชิก',
                            className: 'dt-head-center dt-head-nowrap dt-body-center',
                            visible: false,
                        },
                        {
                            data: 'farmID',
                            title: 'รหัสฟาร์ม',
                            className: 'dt-head-center dt-head-nowrap dt-body-center' +
                                (ROLE !== 'Member' ? ' all' : ''),
                            visible: ROLE !== 'Member',
                            render: function (data, type, row) {
                                if (type === 'display') {
                                    return `<span class="text-success">${data}</span>`;
                                }
                                return data;
                            }
                        },
                        {
                            data: 'cowID',
                            title: 'รหัสโค',
                            visible: false,
                            className: 'dt-head-center dt-head-nowrap',
                        },
                        {
                            data: 'cowName',
                            title: '<input type="checkbox" class="form-check-input d-none select-all-cows" id="select-all-cows"> รหัสโค\n/ชื่อโค',
                            className: 'dt-head-center dt-head-nowrap dt-body-start all',
                            render: function (data, type, row) {
                                if (type === 'display') {
                                    return row.cowStatus === 'ส่งออกแล้ว' ? `<span class="text-muted">${data}</span>` :
                                        (ROLE === 'Member' ? `<span class="text-muted">${data}</span>` :
                                            `<input type="checkbox" class="form-check-input d-none select-cow" data-id="${row.cowID}" data-name="${data}" data-gender="${row.cowGender}" data-farmid="${row.farmID}" id="select-cow-${row.cowID}" /><span class="ms-2">${row.cowName}</span>`);
                                }
                                return data;
                            }
                        },
                        {
                            data: 'birthDate',
                            title: 'วันเกิด',
                            className: 'dt-head-center dt-head-nowrap' +
                                (ROLE !== 'Member' ? '' : ' none'),
                            render: function (data, type, row) {
                                if (type === 'display') {
                                    return moment(data).format('DD/MM/YYYY');
                                }
                                return new Date(data).getTime();
                            }
                        },
                        {
                            data: null,
                            title: 'อายุ',
                            className: 'dt-head-center dt-head-nowrap all',
                            render: function (data, type, row) {
                                if (!row.birthDate || row.birthDate === '') return '-';
                                if (type === 'display') {
                                    let age_month = moment().diff(moment(row.birthDate), 'months')
                                    return age_month + ' เดือน'
                                }
                                return moment().diff(moment(row.birthDate), 'months')
                            }
                        },
                        {
                            data: 'feedDate',
                            title: 'วันที่ขุน',
                            className: 'dt-head-center dt-head-nowrap' +
                                (ROLE !== 'Member' ? '' : ' none'),
                            render: function (data, type, row) {
                                if (data === '') return '';
                                if (type === 'display') {
                                    return moment(data).format('DD/MM/YYYY');
                                }
                                return new Date(data).getTime();
                            }
                        },
                        {
                            data: null,
                            title: 'อายุขุน',
                            className: 'dt-head-center dt-head-nowrap all',
                            render: function (data, type, row) {
                                if (!row.feedDate || row.feedDate === '') return '-';
                                if (type === 'display') {
                                    let age_month = moment().diff(moment(row.feedDate), 'months')
                                    return age_month + ' เดือน'
                                }
                                return moment().diff(moment(row.feedDate), 'months')
                            }
                        },
                        {
                            data: 'cowGender',
                            title: 'เพศ',
                            className: 'dt-head-center dt-head-nowrap dt-body-center',

                        },
                        {
                            data: 'fcowCode',
                            title: 'Fโค',
                            className: 'dt-head-center dt-head-nowrap dt-body-center',
                        },
                        {
                            data: 'motherCode',
                            title: 'รหัสแม่/ชื่อแม่',
                            visible: ROLE !== 'Member',
                            className: 'dt-head-center dt-head-nowrap dt-body-center',
                        },
                        {
                            data: 'fmotherCode',
                            className: 'dt-head-center dt-head-nowrap dt-body-center',
                            visible: ROLE !== 'Member',
                            title: 'Fแม่'
                        },
                        {
                            data: 'fatherCode',
                            title: 'รหัสพ่อ<br>/ชื่อพ่อ',
                            visible: ROLE !== 'Member',
                            className: 'dt-head-center dt-head-nowrap dt-body-center',
                        },
                        // {
                        //     data: 'ffatherCode',
                        //     className: 'dt-head-center dt-head-nowrap dt-body-center',
                        //     title: 'Fพ่อ'
                        // },
                        {
                            data: 'cowOwner',
                            title: 'ชื่อเจ้าของโค<br>/ที่มา',
                            className: 'dt-head-center dt-head-nowrap dt-body-center all',
                        },
                        {
                            data: 'recorderName',
                            title: 'ผู้บันทึกข้อมูล',
                            visible: ROLE !== 'Member',
                            className: 'dt-head-center dt-head-nowrap dt-body-center' +
                                (ROLE !== 'Member' ? ' all' : ' none'),
                        },
                        {
                            data: 'farmInDate',
                            title: 'วันที่เข้าฟาร์ม',
                            className: 'dt-head-center dt-head-nowrap dt-body-center' +
                                (ROLE !== 'Member' ? ' all' : ' none'),
                            render: function (data, type, row) {
                                if (data === '') return '';
                                if (type === 'display') {
                                    return moment(data).format('DD/MM/YYYY');
                                }
                                return new Date(data).getTime();
                            }
                        },
                        {
                            data: 'dataDate',
                            title: 'วันที่บันทึกข้อมูล',
                            className: 'dt-head-center dt-head-nowrap dt-body-center' +
                                (ROLE !== 'Member' ? '' : ' none'),
                            render: function (data, type, row) {
                                if (type === 'display') {
                                    return moment(data).format('DD/MM/YYYY');
                                }
                                return new Date(data).getTime();
                            }
                        },
                        {
                            data: 'lastUpdate',
                            title: 'วันที่อัพเดทข้อมูล',
                            className: 'dt-head-center dt-head-nowrap' +
                                (ROLE !== 'Member' ? '' : ' none'),
                            render: function (data, type, row) {
                                if (type === 'display') {
                                    return moment(data).format('DD/MM/YYYY HH:mm:ss');
                                }
                                return new Date(data).getTime();
                            }
                        },
                        {
                            data: 'remark',
                            title: 'หมายเหตุ',
                            className: 'dt-head-center dt-head-nowrap' +
                                (ROLE !== 'Member' ? '' : ' none'),
                        },
                        {
                            data: 'purchasePrice',
                            title: 'ราคาซื้อเข้า<br>(บาท)',
                            className: 'dt-head-center dt-head-nowrap' +
                                (ROLE === 'Admin' ? ' all' : ' none'),
                            visible: ROLE === 'Admin',
                            render: function (data, type, row) {
                                if (type === 'display') {
                                    if (!data || data === 0) return '-';
                                    return new Intl.NumberFormat('th-TH').format(data)
                                }
                                return data || 0;
                            }
                        },
                        {
                            data: null,
                            title: 'รูปภาพ',
                            className: 'dt-head-center dt-head-nowrap dt-body-center',
                            render: function (data, type, row) {
                                let images = [data.cowImage1, data.cowImage2, data.cowImage3, data.cowImage4, data.cowImage5].filter(img => img !== '');
                                console.log("🚀 ~ google.script.run.withFailureHandler ~ images:", images);
                                if (images.length > 0) {
                                    return `<button class="btn btn-sm btn-beef" onclick="showImageCarousel('${images.join('||')}')">
                                        <i class="bi bi-images"></i> ดูรูปภาพ (${images.length})
                                    </button>`;
                                } else {
                                    return '<div class="text-center">ไม่มีรูปภาพ</div>';
                                }
                            }
                        },
                        {
                            data: 'cowStatus',
                            title: 'สถานะ',
                            orderable: false,
                            className: 'dt-head-center dt-head-nowrap dt-body-center all',
                            visible: ROLE !== 'Member',
                            render: function (data) {
                                return `<button class="w-100 rounded-3 btn btn-sm btn-${data == 'อยู่ในฟาร์ม' ? 'success' : data == 'อยู่กับสมาชิก' ? 'primary' : 'muted'} change-status-btn ${ROLE === 'Member' ? 'pe-none' : ''}" ${ROLE === 'Member' ? '' : 'onclick="changeStatus(this)"'} data-status="${data}">
                                    ${ROLE === 'Member' ? '' : '<i class="fa-solid fa-arrow-pointer fa-flip-horizontal"></i>&nbsp;'}
                                    ${data}</button>`;
                            }
                        },
                        {
                            data: null,
                            orderable: false,
                            title: 'จัดการ',
                            className: 'dt-head-center dt-head-nowrap dt-body-center all',
                            render: function (data, type, row) {
                                return ROLE === 'Member' && row['cowStatus'] !== 'อยู่กับสมาชิก' ? 'ไม่สามารถแก้ไขได้' :
                                    ('<div class="btn-group btn-group-sm">' +
                                        '<button class="btn btn-warning" onclick="editCow(this)">' +
                                        '<i class="bi bi-pencil"></i>' +
                                        '</button>' +
                                        '<button class="btn btn-danger" onclick="deleteCow(this)">' +
                                        '<i class="bi bi-trash"></i>' +
                                        '</button>' +
                                        '</div>');
                            }
                        }
                    ],
                    columnDefs: [
                        {
                            targets: '_all',

                        },
                        {
                            targets: [2, 4, 16],
                            className: 'all'
                        },
                        {
                            targets: [2, 7, 15],
                            className: 'text-nowrap'
                        },
                    ],

                    order: [[1, 'desc']],
                    initComplete: function (settings, json) {


                        // Add event listener for the "select all" checkbox
                        $('.select-all-cows').on('change', function () {
                            $('.select-cow').trigger('change');
                        });
                        // Add status filter dropdown for non-Member users
                        if (ROLE !== 'Member') {
                            $('#cowSummaryBtn').removeClass('d-none');
                            // Replace status column header with select dropdown
                            let statusFilterHtml = `
                                <select class="form-select status-filter">
                                    <option value="">ทั้งหมด</option>
                                    <option value="อยู่ในฟาร์ม" selected>อยู่ในฟาร์ม</option>
                                    <option value="อยู่กับสมาชิก">อยู่กับสมาชิก</option>
                                    <option value="ส่งออกแล้ว">ส่งออกแล้ว</option>
                                </select>
                            `;

                            $(cowDataTable.column(23).header()).html(statusFilterHtml);
                            // Prevent sorting when clicking on the status filter dropdown
                            $('.status-filter').on('click', function (e) {
                                e.stopPropagation();
                            });

                            // Add filtering functionality
                            $('.status-filter').on('change', function () {
                                let filterValue = $(this).val();
                                cowDataTable.column(23).search(filterValue).draw();
                            });
                            $('.status-filter').change(); // Trigger change to apply initial filter
                        }
                        NProgress.done();

                        // Update dashboard counts
                        updateDashboardCounts();
                    },
                });
                NProgress.done();
            });
        }

        // Function to update dashboard counts
        function updateDashboardCounts() {
            let allCows = cowDataTable.data().toArray();
            let totalCount = allCows.length;
            let maleCount = allCows.filter(cow => cow.cowGender === 'ผู้').length;
            let femaleCount = allCows.filter(cow => cow.cowGender === 'เมีย').length;

            // Animate count numbers
            animateCount('totalCowCount', 0, totalCount);
            animateCount('maleCowCount', 0, maleCount);
            animateCount('femaleCowCount', 0, femaleCount);
        }

        // Animate count with counter
        function animateCount(elementId, start, end) {
            let duration = 1000;
            let startTime = null;

            function animation(currentTime) {
                if (!startTime) startTime = currentTime;
                let timeElapsed = currentTime - startTime;
                let progress = Math.min(timeElapsed / duration, 1);
                let value = Math.floor(progress * (end - start) + start);

                document.getElementById(elementId).textContent = value;

                if (progress < 1) {
                    requestAnimationFrame(animation);
                } else {
                    document.getElementById(elementId).textContent = end;
                }
            }

            requestAnimationFrame(animation);
        }

        function getButtonsBasedOnRole(role) {
            // Base button that all users have
            let buttons = [
                {
                    text: '<i class="bi bi-plus-circle"></i> เพิ่มโค',
                    className: 'btn btn-beef',
                    action: function () {
                        $('form#addCowForm').removeAttr('data-editmode')
                        $('#addCowModal').modal('show');
                    }
                }
            ];

            // Add additional buttons based on role
            buttons.push(
                {
                    text: '<i class="bi bi-file-earmark-arrow-up"></i> เลือกโคส่งออก',
                    className: 'btn btn-beef btn-enable-select' + (ROLE === 'Member' ? ' d-none' : ''),
                    action: function () {
                        if ($('.btn-enable-select').hasClass('cancel-select')) {
                            // Exit selection mode
                            $('.btn-enable-select').removeClass('cancel-select')
                                .html('<i class="bi bi-file-earmark-arrow-up"></i> เลือกโคส่งออก')
                                .removeClass('btn-danger').addClass('btn-beef');
                            $('.select-cow, .select-all-cows').prop('checked', false).addClass('d-none');
                            $('.btn-export-cow').attr('disabled', true).addClass('d-none');
                            return;
                        }

                        // Enter selection mode
                        $('.btn-enable-select').html('<i class="bi bi-file-earmark-arrow-down"></i> ยกเลิก')
                            .addClass('btn-danger cancel-select').removeClass('btn-beef');
                        $('.select-cow, .select-all-cows').removeClass('d-none');

                        // Handle checkbox changes
                        $('.select-cow').on('change', function () {
                            let selectedCows = $('.select-cow:checked').length;
                            let totalSelectableCows = $('.select-cow:visible').length;

                            // Update the export button visibility
                            if (selectedCows > 0) {
                                $('.btn-export-cow').removeAttr('disabled').removeClass('d-none');
                            } else {
                                $('.btn-export-cow').attr('disabled', true).addClass('d-none');
                            }

                            // Update "select all" checkbox state
                            if (selectedCows === 0) {
                                $('.select-all-cows').prop('checked', false);
                            } else if (selectedCows === totalSelectableCows) {
                                $('.select-all-cows').prop('checked', true);
                            } else {
                                // If some but not all are selected, keep the header checkbox unchecked
                                $('.select-all-cows').prop('checked', false);
                            }
                        });
                    }
                },
                {
                    text: '<i class="bi bi-file-earmark-arrow-up"></i> ส่งออกโค',
                    className: 'btn btn-export-cow d-none', // Add d-none class
                    action: function () {
                        let selectedCows = $('.select-cow:checked').toArray().map(function (checkbox) {
                            return {
                                cowID: $(checkbox).data('id'),
                                name: $(checkbox).data('name'),
                                gender: $(checkbox).data('gender'),
                                farmID: $(checkbox).data('farmid'),
                            }
                        });
                        if (selectedCows.length === 0) {
                            Toast.fire({
                                icon: 'error',
                                title: 'กรุณาเลือกโคที่ต้องการส่งออก'
                            });
                            return;
                        }
                        showExportFormModal(selectedCows);
                    }
                }
            );
            return buttons;
        }

        function showImagePreview(src) {
            Swal.fire({
                imageUrl: src,
                imageWidth: '100%',
                imageHeight: '100%',
                showCloseButton: true,
                showConfirmButton: false,
                allowOutsideClick: false,
                customClass: {
                    popup: 'rounded-4',
                    image: 'rounded-4',
                    htmlContainer: 'p-0 rounded-4',
                },
            });
        }

        function showImageCarousel(images) {
            const imageArray = images.split('||');
            const imageElements = imageArray.map((img, index) => {
                return `<div class="carousel-item ${index === 0 ? 'active' : ''}">
                            <img src="${img}" class="d-block w-100" alt="Image ${index + 1}">
                        </div>`;
            }).join('');

            Swal.fire({
                html: `<div id="imageCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                        ${imageArray.map((_, index) =>
                    `<button type="button" data-bs-target="#imageCarousel" data-bs-slide-to="${index}" 
                            ${index === 0 ? 'class="active" aria-current="true"' : ''} 
                            aria-label="Slide ${index + 1}"
                            style="background-color: var(--primary-color);"></button>`
                ).join('')}
                    </div>
                    <div class="carousel-inner">
                        ${imageElements}
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel" data-bs-slide="prev" 
                            style="opacity: 0.9;">
                        <span class="carousel-control-prev-icon" aria-hidden="true" 
                              style="filter: invert(25%) sepia(71%) saturate(935%) hue-rotate(346deg) brightness(89%) contrast(84%);"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel" data-bs-slide="next"
                            style="opacity: 0.9;">
                        <span class="carousel-control-next-icon" aria-hidden="true"
                              style="filter: invert(25%) sepia(71%) saturate(935%) hue-rotate(346deg) brightness(89%) contrast(84%);"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
               `,
                padding: '0',
                customClass: {
                    popup: 'rounded-4 col-12 col-md-8 col-lg-6',
                    image: 'rounded-4',
                    htmlContainer: 'p-0 rounded-4',
                },
                showCloseButton: true,
                showConfirmButton: false,
            });
        }

        $('#username').on('input', function () {
            clearTimeout(this.timer);
            this.timer = setTimeout(() => {
                const username = $(this).val();
                if (username.length < 6) {
                    $(this).addClass('is-invalid');
                    $('#invalid-username').text('ชื่อผู้ใช้ต้องมีอย่างน้อย 6 ตัวอักษร');
                } else if (/\s/g.test(username)) {
                    $(this).addClass('is-invalid');
                    $('#invalid-username').text('ชื่อผู้ใช้ไม่สามารถมีช่องว่างได้');
                } else if (!/^[a-zA-Z0-9]+$/.test(username)) {
                    $(this).addClass('is-invalid');
                    $('#invalid-username').text('ชื่อผู้ใช้ต้องเป็นตัวอักษรหรือตัวเลขเท่านั้น');
                }

                else {
                    $(this).addClass('is-invalid')
                    $('#invalid-username').html('กำลังตรวจสอบชื่อผู้ใช้...<i class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></i>');
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                        if (res) {
                            $(this).removeClass('is-invalid').addClass('is-valid');
                            $('#invalid-username').html('');
                        } else {
                            $(this).addClass('is-invalid');
                            $('#invalid-username').html('<i class="bi bi-x-circle-fill text-danger"></i> ชื่อผู้ใช้นี้มีอยู่แล้ว กรุณาลองใหม่อีกครั้ง');
                        }
                    }).checkUsername(username)
                }
            }, 500);
        });

        $('#registerPassword').on('input', function () {
            const password = $(this).val();
            $('#confirmPassword').removeClass('is-valid').removeClass('is-invalid').text('');
            if (password.length < 8) {
                $(this).addClass('is-invalid');
                $(this).removeClass('is-valid');
                $(this).next('.invalid-feedback').show().text('รหัสผ่านต้องมีอย่างน้อย 8 ตัวอักษร');
            } else {
                $(this).removeClass('is-invalid').addClass('is-valid');
            }
        });

        $('#confirmPassword').on('input', function () {
            const password = $('#registerPassword').val();
            const confirmPassword = $('#confirmPassword').val();
            if (password !== confirmPassword) {
                $('#confirmPassword').addClass('is-invalid');
                $('#confirmPassword').removeClass('is-valid');
                $('#confirmPassword').next('.invalid-feedback').show().text('รหัสผ่านไม่ตรงกัน');
            } else {
                $('#confirmPassword').removeClass('is-invalid').addClass('is-valid');
                $('#confirmPassword').next('.valid-feedback').show().text('รหัสผ่านตรงกัน');
            }
        });

        window.addEventListener("load", function () {
            NProgress.done();
        });
    </script>
</body>

</html>