<!DOCTYPE html>
<html lang="th">

<head>
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบสินค้า Beef Good</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_red.css">
    <link href="https://cdn.datatables.net/v/bs5/dt-2.2.2/date-1.5.5/r-3.0.4/datatables.min.css" rel="stylesheet"
        integrity="sha384-1J1LAHaYmA8AXBKEwhykiJmyo7zmhJIUlWIRZPHuX+qDRljv5UcH4RQsMGAT5d4i" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .text-beef {
            color: #8B4513;
        }

        .btn-beef {
            background-color: #8B4513;
        }

        .select,
        #locale {
            width: 100%;
        }

        .like {
            margin-right: 10px;
        }

        .btn-ssm{
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }
    </style>
</head>

<body class="bg-light">
    <nav class="navbar bg-black navbar-dark m-0 py-1 navbar-expand-md shadow-sm no-print">
        <div class="container-fluid" data-bs-theme="dark">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://img5.pic.in.th/file/secure-sv1/beef-good-logo.png" alt="Beef Good Logo" height="40"
                    class="d-inline-block align-text-top me-2 rounded-circle bg-white">
                <span class="text-beef fw-bold">Beef Good</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-target="#invent-tab-pane">
                            <i class="bi bi-plus-circle-fill"></i>&nbsp;นำเข้าสินค้า</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-target="#print-tab-pane">
                            <i class="bi bi-printer-fill"></i>&nbsp;พิมพ์ใบรายการ</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="tab-content no-print" id="myTabContent">
        <div class="tab-pane fade show active" id="invent-tab-pane" role="tabpanel" aria-labelledby="invent-tab"
            tabindex="0">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="text-center mt-3 h4 text-beef fw-bold">ระบบนำเข้าสินค้า</div>
                        <p class="text-center text-secondary">ใช้เครื่องสแกนหรือป้อนรหัสบาร์โค้ดด้านล่าง</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="input-group">
                            <input type="text" class="form-control barcode-input shadow-none" id="barcodeInput"
                                placeholder="สแกนหรือป้อนรหัสบาร์โค้ด" autofocus>
                            <button class="btn btn-dark border-0" type="button" id="addItemBtn">
                                <i class="bi bi-plus-circle"></i> เพิ่มรายการ
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mt-2 justify-content-center">
                    <div class="col-12 text-center" id="inventoryHeader" style="display: none;">
                        <div class="card my-3 bg-beef-subtle shadow-sm">
                            <div class="card-body py-3">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h6 class="fw-bold text-beef mb-1">จำนวนชิ้น</h6>
                                        <p class="fs-5 mb-0" id="itemCount">0</p>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="fw-bold text-beef mb-1">น้ำหนักรวม</h6>
                                        <p class="fs-5 mb-0" id="totalWeight">0.00 กก.</p>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="fw-bold text-beef mb-1">ราคารวม</h6>
                                        <p class="fs-5 mb-0" id="totalPrice">0 บาท</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4" id="actionButtons" style="display: none;">
                        <button class="btn btn-dark rounded-3 w-100 mt-2" type="button" id="saveBtn">
                            <i class="bi bi-floppy-fill"></i> บันทึก
                        </button>
                    </div>
                    <div class="col-12 mt-2 text-center" id="inventoryContainer">
                        <div class="inventory-empty" id="emptyState">
                            <i class="bi bi-upc-scan scan-icon display-1"></i>
                            <p class="mb-0">สแกนบาร์โค้ดสินค้าเพื่อเพิ่มข้อมูล</p>
                            <small class="text-muted">ระบบจะบันทึกข้อมูลการสแกนอัตโนมัติ</small>
                        </div>
                        <!-- Inventory items will be added here dynamically -->
                    </div>
                </div>
                <!-- History Modal -->
                <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-beef-subtle">
                                <h5 class="modal-title text-beef" id="historyModalLabel">ประวัติการสแกน</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="history-list" id="historyList">
                                    <!-- History items will be added here dynamically -->
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">ปิด</button>
                                <button type="button" class="btn btn-danger" id="clearHistoryBtn">ล้างประวัติ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="print-tab-pane" role="tabpanel" aria-labelledby="print-tab" tabindex="0">
            <div class="container">
                <div class="row mt-3 justify-content-center">
                    <div class="col-12 text-center">
                        <h4 class="text-beef fw-bold">พิมพ์ใบรายการ</h4>
                    </div>
                    <div class="col-md-6 text-center" id="dateFilter">
                        <label for="dateInput" class="form-label">เลือกวันที่
                            หรือเว้นว่างหากต้องการแสดงข้อมูลทั้งหมด</label>
                        <input type="text" class="form-control text-center" id="dateInput"
                            placeholder="เลือกวันที่ หรือเว้นว่างหากต้องการแสดงข้อมูลทั้งหมด" name="dateInput">
                        <button class="btn btn-dark mt-2" id="searchBtn">
                            <i class="bi bi-search"></i>
                            ค้นหารายการ
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12 text-center" id="printReport" style="display: none">
                        <button class="btn btn-dark" id="printBtn"><i class="bi bi-printer-fill"></i> พิมพ์</button>
                    </div>
                    <div class="col-12 table-responsive mt-3">
                        <table id="table" class="table table-striped table-bordered table-hover" style="width: 100%">
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Item Template -->
    <template id="item-template">
        <div class="inventory-item p-2 rounded-3 bg-danger-subtle mb-2" data-barcode="">
            <div class="item-card">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h5 class="card-title mb-0 item-name fw-bold">ชื่อสินค้า</h5>
                        <div class="d-flex align-items-center">
                            <h5 class="card-title mb-0 item-id">รหัสสินค้า</h5>
                            <button class="btn btn-sm btn-danger delete-btn ms-2 me-2 py-0 px-1" title="ลบรายการ">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row g-1">
                        <div class="col-6 text-start">
                            <p class="mb-0 "><span class="text-black-50">น้ำหนัก </span><span class="item-weight">0.00
                                    กก.</span></p>
                        </div>
                        <div class="col-6 txt-start">
                            <p class="mb-0 "><span class="text-black-50">ราคาขาย </span><span class="item-price">0.00
                                    บาท</span></p>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white p-1 rounded-3">
                    <div class="d-flex justify-content-between align-items-center px-1">
                        <small class="text-muted item-scan-time fs-smaller">สแกนเมื่อ: เดี๋ยวนี้</small>
                        <button class="btn btn-sm bg-beef-subtle text-beef details-btn py-0 px-2">
                            รายละเอียด <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <!-- Table Details Modal -->
    <div class="modal fade no-print" id="tableDetailsModal" tabindex="-1" aria-labelledby="tableDetailsModalLabel"
        aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-beef-subtle">
                    <h5 class="modal-title text-beef" id="tableDetailsModalLabel">รายละเอียดรายการ</h5>
                    <button type="button" class="btn-close btn-close-detail-modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="input-group input-group mb-1">
                                <span class="input-group-text fw-bold text-bg-danger">วันที่:</span>
                                <span class="form-control" id="detailDate"></span>
                            </div>
                        </div>
                        <div class="col-6">
                            <!-- <p class="mb-1"><strong>เลขที่บิล:</strong> <span id="detailBillId"></span></p> -->
                            <div class="input-group input-group mb-1">
                                <span class="input-group-text fw-bold text-bg-danger">เลขที่บิล:</span>
                                <span class="form-control" id="detailBillId"></span>
                            </div>
                        </div>
                        <div class="col-6">
                            <!-- <p class="mb-1"><strong>น้ำหนักรวม:</strong> <span id="detailTotalWeight"></span> กก.</p> -->
                            <div class="input-group input-group mb-1">
                                <span class="input-group-text fw-bold text-bg-danger">น้ำหนักรวม:</span>
                                <span class="form-control" id="detailTotalWeight"></span>
                            </div>
                        </div>
                        <div class="col-6">
                            <!-- <p class="mb-1"><strong>ราคารวม:</strong> <span id="detailTotalPrice"></span> บาท</p> -->
                            <div class="input-group input-group mb-1">
                                <span class="input-group-text fw-bold text-bg-danger">ราคารวม:</span>
                                <span class="form-control" id="detailTotalPrice"></span>
                            </div>
                        </div>
                        <div class="col-12 mt-3">
                            <label for="billDetails" class="fw-bold d-flex justify-content-between flex-wrap">รายละเอียด
                                <small class="text-muted" id="detail-updated-time"></small></label>
                            <textarea class="form-control" id="billDetails" rows="3"></textarea>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-ssm btn-warning mt-2" id="saveDetailsBtn">
                                    <i class="bi bi-save-fill"></i> บันทึกรายละเอียด
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="detailsTable">
                            <thead class="table-dark">
                                <tr class="text-center">
                                    <!-- <th class="text-center">#</th>
                                    <th class="text-center">ชื่อสินค้า</th>
                                    <th class="text-center">ประเภท</th>
                                    <th class="text-center">เกรด</th>
                                    <th class="text-center">น้ำหนัก</th>
                                    <th class="text-center">จำนวน</th> -->
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody" class="text-center"></tbody>
                            <!-- Details will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-close-detail-modal">ปิด</button>
                    <button type="button" class="btn btn-dark" id="printDetailsBtn">
                        <i class="bi bi-printer-fill"></i> พิมพ์รายละเอียด
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for adding beef -->
    <div class="modal fade" id="manualAddBeefModal" tabindex="-1" aria-labelledby="manualAddBeefModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-beef-subtle">
                    <h5 class="modal-title text-beef" id="manualAddBeefModalLabel">เพิ่มเนื้อเข้ารายการ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addBeefForm">
                        <input type="hidden" id="addBeefBillId" value="">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="beefProduct" class="form-label">เลือกเนื้อ</label>
                                <select class="form-select" id="beefProduct" required>
                                    <option value="" selected disabled>กรุณาเลือกเนื้อ</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="beefWeight" class="form-label">น้ำหนัก</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="beefWeight" step="0.01" min="0.01"
                                        required>
                                    <select class="form-select text-center" id="weightUnit" required>
                                        <option value="kg" selected>กิโลกรัม</option>
                                        <option value="g">กรัม</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="beefQuantity" class="form-label">จำนวน</label>
                                <input type="number" class="form-control" id="beefQuantity" min="1" value="1" required>
                            </div>
                            <div class="col-md-6">
                                <label for="beefPrice" class="form-label">ราคา (บาท)</label>
                                <input type="number" class="form-control" id="beefPrice" readonly>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-dark" id="confirmAddBeefBtn">
                        <i class="bi bi-plus-circle"></i> เพิ่มรายการ
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid" id="print-area" style="display: none;"></div>
    <script>
        // Sample data for demonstration - in real implementation, this would come from your backend
        let scanHistory = JSON.parse(localStorage.getItem('beefScanHistory')) || [];
        const historyLimit = 500; // Limit history items
        const dt_lang = {
            processing: '<div class="text-beef"><i class="bi bi-arrow-repeat display-1"></i><br>กำลังโหลดข้อมูล...</div>',
            searchPlaceholder: "ค้นหา",
            search: "ค้นหา:",
            lengthMenu: "แสดง _MENU_ รายการ",
            info: "แสดงรายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            infoEmpty: "แสดงรายการ 0 ถึง 0 จาก 0 รายการ",
            infoFiltered: "(กรองจากทั้งหมด _MAX_ รายการ)",
            loadingRecords: "กำลังโหลดข้อมูล...",
            zeroRecords: "ไม่พบรายการที่ค้นหา",
            emptyTable: "ยังไม่มีรายการในวันนี้ หากต้องการสั่งพิมพ์ย้อนหลังกรุณาเลือกวันอื่นที่มีรายการ",
            paginate: {
                first: "หน้าแรก",
                previous: "ก่อนหน้า",
                next: "ถัดไป",
                last: "หน้าสุดท้าย"
            },
            aria: {
                sortAscending: ": เรียงจากน้อยไปมาก",
                sortDescending: ": เรียงจากมากไปน้อย"
            }
        }
        const demo_data = <?!= getBarcodeDatas() ?>; // Fetch data from Google Sheets
        $(document).ready(function () {
            moment.locale('th'); // Set Thai locale for moment.js
            $('#dateInput').flatpickr({
                locale: 'th',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: "j F Y",
                defaultDate: moment().format('YYYY-MM-DD'),
                onChange: function (selectedDates, dateStr, instance) {
                    $('#table').DataTable().ajax.reload(null, false);
                }
            });
            $('#tableDetailsModal').on('shown.bs.modal', function () {
                $('#detailsTable').DataTable().draw(false);
                let inputgroupwidth = Math.max(...$('.input-group-text').toArray().map(e => $(e).width()));
                $('.input-group-text').css('min-width', inputgroupwidth + 'pt');
            }).on('hidden.bs.modal', function () {
                $('#detailsTable').DataTable().destroy();
                $('#detailsTable').removeAttr('table-type')
            });
            const barcodeInput = $('#barcodeInput');
            const historyBtn = $('#historyBtn');
            const clearHistoryBtn = $('#clearHistoryBtn');
            const addItemBtn = $('#addItemBtn');
            const saveBtn = $('#saveBtn');
            const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            scanHistory = scanHistory.filter(item => item.barcode);
            localStorage.setItem('beefScanHistory', JSON.stringify(scanHistory));
            scanHistory.forEach(item => {
                searchInventory(item.barcode, true);
            });
            Object.keys(demo_data).forEach(key => {
                const product = demo_data[key];
                $('#beefProduct').append(`<option value="${product.fullProductName}" data-name="${product.productName}" data-id="${key}" data-price="${product.price}" data-type="${product.type}" data-grade="${product.grade}">${product.fullProductName}</option>`);
            });
            $('#beefProduct').select2({
                theme: 'bootstrap-5',
                placeholder: 'กรุณาเลือกเนื้อ',
                allowClear: true,
                dropdownParent: $('#manualAddBeefModal'),
                matcher: function (params, data) {
                    // If there are no search terms, return all of the data
                    if ($.trim(params.term) === '') {
                        return data;
                    }
                    // Search in text AND data-id attribute
                    var text = data.text.toLowerCase();
                    var id = $(data.element).data('id');
                    var term = params.term.toLowerCase();
                    // Check if the text or id contains the search term
                    if (text.indexOf(term) > -1 || (id && id.toString().indexOf(term) > -1)) {
                        return data;
                    }
                    // Return `null` if the term should not be displayed
                    return null;
                },
            });
            $('#beefProduct, #weightUnit').on('change', function () {
                calculetePrice();
            });
            $('#beefWeight').on('input', function () {
                calculetePrice();
            });
            $('#beefQuantity').on('input', function () {
                calculetePrice()
            });
            $('#confirmAddBeefBtn').on('click', function () {
                $('#addBeefForm').submit();
            });
            $('#addBeefForm').on('submit', function (e) {
                e.preventDefault();
                let select_product = $('#beefProduct option:selected');
                let productName = select_product.data('name');
                let productId = select_product.data('id');
                let weight = parseFloat($('#beefWeight').val());
                let unit = $('#weightUnit').val();
                let price = parseFloat($('#beefPrice').val());
                let type = select_product.data('type');
                let grade = select_product.data('grade');
                let quantity = parseInt($('#beefQuantity').val());
                let billid = $('#addBeefBillId').val();
                let scanTime = moment().format('YYYY-MM-DD HH:mm:ss');
                weight = unit === 'kg' ? weight : (weight / 1000);
                const barcode = encryptBarcode(productId, weight, price);
                if (productName && weight && price && quantity) {
                    const item = {
                        barcode: barcode,
                        productName: productName,
                        productId: productId,
                        weight: weight,
                        unit: unit,
                        price: price,
                        type: type,
                        grade: grade,
                        quantity: quantity,
                        scanTime: scanTime,
                        billid: billid
                    };
                    Swal.fire({
                        title: 'กำลังบันทึกข้อมูล',
                        text: 'กรุณารอสักครู่...',
                        icon: 'warning',
                        confirmButtonColor: '#8B4513',
                        customClass: {
                            popup: 'rounded-4'
                        },
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    })
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                        if (res.success) {
                            $('#table').DataTable().ajax.reload(null, false);
                            $('#addBeefForm')[0].reset();
                            $('#beefProduct').val('').change();
                            $('#manualAddBeefModal').modal('hide');
                            showNotification('success', 'บันทึกข้อมูลสำเร็จ', 'ข้อมูลได้ถูกบันทึกลง Google Sheets เรียบร้อยแล้ว');
                        } else {
                            Swal.fire({
                                title: 'บันทึกข้อมูลไม่สำเร็จ',
                                text: 'กรุณาลองใหม่อีกครั้ง',
                                icon: 'error',
                                confirmButtonColor: '#8B4513',
                                customClass: {
                                    popup: 'rounded-4'
                                }
                            });
                        }
                    })
                        .addBeefToSheet(item);
                } else {
                    showNotification('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลให้ครบถ้วน');
                }
            });
            const calculetePrice = () => {
                const weight = parseFloat($('#beefWeight').val());
                const unit = $('#weightUnit').val();
                const quantity = parseInt($('#beefQuantity').val());
                const pricePerKg = parseFloat($('#beefProduct option:selected').data('price'));
                let price = 0;
                if (unit === 'kg') {
                    price = weight * pricePerKg * quantity;
                } else if (unit === 'g') {
                    price = (weight / 1000) * pricePerKg * quantity;
                }
                $('#beefPrice').val(price.toFixed(3));
            }
            // Search for barcode when Enter is pressed or search button is clicked
            barcodeInput.on('keydown', function (e) {
                const barcode = $(this).val().trim();
                if (e.key === 'Enter' || barcode.length === 18) {
                    if (barcode) {
                        searchInventory(barcode);
                        $(this).val('').focus();
                    }
                }
            });
            addItemBtn.on('click', function () {
                const barcode = barcodeInput.val().trim();
                if (barcode) {
                    searchInventory(barcode);
                    barcodeInput.val('').focus();
                }
            });
            // Open history modal
            historyBtn.on('click', function () {
                renderHistory();
                historyModal.show();
            });
            saveBtn.on('click', function () {
                let history = JSON.parse(localStorage.getItem('beefScanHistory')) || [];
                Swal.fire({
                    title: 'กำลังบันทึกข้อมูล',
                    text: 'กรุณารอสักครู่...',
                    icon: 'warning',
                    confirmButtonColor: '#8B4513',
                    customClass: {
                        popup: 'rounded-4'
                    },
                    didOpen: () => {
                        Swal.showLoading();
                    }
                })
                google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                    if (res.success) {
                        $('#inventoryHeader, #actionButtons').hide();
                        Swal.fire({
                            title: 'บันทึกข้อมูลสำเร็จ',
                            text: 'ข้อมูลได้ถูกบันทึกลง Google Sheets เรียบร้อยแล้ว',
                            icon: 'success',
                            confirmButtonColor: '#8B4513',
                            customClass: {
                                popup: 'rounded-4'
                            },
                            timer: 1500,
                            showConfirmButton: false
                        });
                        localStorage.removeItem('beefScanHistory');
                        scanHistory = [];
                        $('.inventory-item').remove(); // Clear inventory items
                        $('#emptyState').show(); // Show empty state
                    } else {
                        Swal.fire({
                            title: 'บันทึกข้อมูลไม่สำเร็จ',
                            text: 'กรุณาลองใหม่อีกครั้ง',
                            icon: 'error',
                            confirmButtonColor: '#8B4513',
                            customClass: {
                                popup: 'rounded-4'
                            }
                        });
                    }
                })
                    .saveDataToSheet(history);
            });
            $('.nav-link').click(function () {
                $('.nav-link').removeClass('active');
                $('.tab-pane').removeClass('show active');
                $(this).addClass('active');
                const target = $(this).data('bs-target');
                $(target).addClass('show active');
                historyModal.hide();
                if (target === '#invent-tab-pane') {
                    barcodeInput.focus();
                } else {
                    $('#dateInput').focus();
                    // $('#table').DataTable().ajax.reload(null, false);
                }
            });
            setTimeout(() => {
                getPrintData($('#dateInput').val());
            }, 1000);
            $('#searchBtn').click(function () {
                $('#table').DataTable().ajax.reload(null, false);
            });
            // Handle delete button click on inventory items
            $(document).on('click', '.delete-btn', function (e) {
                e.stopPropagation(); // Prevent event bubbling
                const itemElement = $(this).closest('.inventory-item');
                const itemName = itemElement.find('.item-name').text();
                Swal.fire({
                    title: 'ยืนยันการลบ',
                    text: `คุณต้องการลบ "${itemName}" ออกจากรายการหรือไม่?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'ลบรายการ',
                    cancelButtonText: 'ยกเลิก',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Remove the item
                        itemElement.fadeOut(300, function () {
                            itemElement.remove();
                            scanHistory = scanHistory.filter(item => item.barcode !== itemElement.data('barcode'));
                            localStorage.setItem('beefScanHistory', JSON.stringify(scanHistory));
                            // Update totals
                            updateTotals();
                            // Show empty state if no items left
                            if (scanHistory.length === 0) {
                                $('#inventoryHeader, #actionButtons').hide();
                                $('#emptyState').show();
                            }
                        });
                        // Show notification
                        showNotification('success', 'ลบรายการสำเร็จ', `ลบ "${itemName}" ออกจากรายการแล้ว`);
                    }
                });
            });
            // Clear history
            clearHistoryBtn.on('click', function () {
                Swal.fire({
                    title: 'ยืนยันการลบ',
                    text: 'คุณต้องการลบประวัติการสแกนทั้งหมดหรือไม่?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#8B4513',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'ลบประวัติ',
                    cancelButtonText: 'ยกเลิก',
                    customClass: {
                        popup: 'rounded-4'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        scanHistory = [];
                        localStorage.setItem('beefScanHistory', JSON.stringify(scanHistory));
                        renderHistory();
                        Swal.fire({
                            title: 'ลบประวัติแล้ว',
                            icon: 'success',
                            customClass: {
                                popup: 'rounded-4'
                            },
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
            });
            // Handle click on history item
            // $(document).on('click', '.history-item', function () {
            //     const barcode = $(this).data('barcode');
            //     historyModal.hide();
            //     searchInventory(barcode);
            //     barcodeInput.val('').focus();
            // });
            // Auto focus on barcode input when page is clicked
            $(document).on('click', function (e) {
                // Don't focus if clicking on a button, input or inside the history modal
                if (!$(e.target).is('button, input') &&
                    !$(e.target).closest('.modal').length) {
                    barcodeInput.focus();
                }
            });
            // Keep input in focus even after showing alerts
            $(document).on('shown.bs.modal hidden.bs.modal', function () {
                setTimeout(() => barcodeInput.focus(), 100);
            });

            $('#billDetails').on('input', function () {
                let original = $(this).data('original');
                if($(this).val() !== original) {
                    $(this).data('is-changed', true);
                } else {
                    $(this).data('is-changed', false);
                }
            });
        });

        $('.btn-close-detail-modal').click(function () {
                if($('#billDetails').data('is-changed')) {
                    Swal.fire({
                        title: 'คุณมีการเปลี่ยนแปลงข้อมูล',
                        text: 'คุณต้องการบันทึกการเปลี่ยนแปลงหรือไม่?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#8B4513',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'บันทึก',
                        cancelButtonText: 'ยกเลิก',
                        customClass: {
                            popup: 'rounded-4'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $('#saveDetailsBtn').click();
                        }else{
                            $('#billDetails').data('is-changed', false);
                            $('#billDetails').data('original', detail);
                            $('#tableDetailsModal').modal('hide');
                        } 
                    });
                } else {
                    $('#tableDetailsModal').modal('hide');
                }
            })

        $('#saveDetailsBtn').click(function (ele) {
            let billId = $('#billDetails').data('bill-id');
            let detail = $('#billDetails').val();
            NProgress.start();
            NProgress.inc()
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล',
                text: 'กรุณารอสักครู่...',
                icon: 'warning',
                confirmButtonColor: '#8B4513',
                customClass: {
                    popup: 'rounded-4'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            })

            google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                NProgress.done();
                res = JSON.parse(res);
                if (res.success) {
                    $('#billDetails').data('is-changed', false);
                    $('#billDetails').data('original', detail);
                    $('#detail-updated-time').text('อัปเดตเมื่อ ' + moment().format('DD/MM/YYYY HH:mm:ss'));
                    Swal.fire({
                        title: 'บันทึกข้อมูลสำเร็จ',
                        text: 'ข้อมูลได้ถูกบันทึกลง Google Sheets เรียบร้อยแล้ว',
                        icon: 'success',
                        confirmButtonColor: '#8B4513',
                        customClass: {
                            popup: 'rounded-4'
                        },
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        title: 'บันทึกข้อมูลไม่สำเร็จ',
                        text: 'กรุณาลองใหม่อีกครั้ง',
                        icon: 'error',
                        confirmButtonColor: '#8B4513',
                        customClass: {
                            popup: 'rounded-4'
                        }
                    });
                }
            }).saveBillDetails(billId, detail);
        })

        function initTableView(viewType) {
            // Set appropriate headers based on view type
            const headers = viewType === 'detailed'
                ? `<tr class="text-center">
                    <th class="text-center">#</th>
                    <th class="text-center">ชื่อสินค้า</th>
                    <th class="text-center">ประเภท</th>
                    <th class="text-center">เกรด</th>
                    <th class="text-center">น้ำหนัก</th>
                    <th class="text-center">จำนวน</th>
                </tr>`
                : `<tr class="text-center">
                    <th class="text-center">#</th>
                    <th class="text-center">ชื่อสินค้า</th>
                    <th class="text-center">น้ำหนัก</th>
                </tr>`;
            // Update DOM
            $('#detailsTable thead').html(headers);
            // Destroy existing DataTable if any
            if ($.fn.DataTable.isDataTable('#detailsTable')) {
                $('#detailsTable').DataTable().destroy();
            }
            // Initialize DataTable
            $('#detailsTable').DataTable({
                language: dt_lang,
                paging: false,
                dom: '<"row justify-content-between"<"col-auto tb-type"><"col-auto"f>>' +
                    '<"row"<"col-12"t>>' +
                    '<"row justify-content-between"<"col-auto"i><"col-auto"p>>',
                initComplete: function () {
                    // Create view toggle buttons
                    $('.tb-type').html('<div class="btn-group mb-2" role="group" aria-label="View Type">' +
                        '<input type="radio" class="btn-check" name="viewType" id="viewDetailed" autocomplete="off"' +
                        (viewType === 'detailed' ? ' checked' : '') + '>' +
                        '<label class="btn btn-outline-dark btn-sm" for="viewDetailed">แยกรายการ</label>' +
                        '<input type="radio" class="btn-check" name="viewType" id="viewSummary" autocomplete="off"' +
                        (viewType === 'summary' ? ' checked' : '') + '>' +
                        '<label class="btn btn-outline-dark btn-sm" for="viewSummary">รวมรายการ</label>' +
                        '</div>');
                    // Set up event handlers for view switching
                    $('#viewDetailed, #viewSummary').on('change', function () {
                        const selectedView = $(this).attr('id') === 'viewDetailed' ? 'detailed' : 'summary';
                        if (selectedView === 'detailed') {
                            initTableDetailsView();
                        } else {
                            initTableSummaryView();
                        }
                    });
                }
            }).draw(false);
        }
        function getBillData(billId) {
            let row = $('#table').DataTable().rows().data().toArray().find(item => item.billId === billId)
            return row;
        }
        // Wrapper functions for backward compatibility
        function initTableDetailsView() {
            // Destroy existing DataTable if any
            if ($.fn.DataTable.isDataTable('#detailsTable')) {
                $('#detailsTable').DataTable().destroy();
            }
            $('#detailsTable').data('table-type', 'detailed')
            let billId = $('#detailsTable').data('bill-id');
            let row = getBillData(billId);
            if (!row) {
                showNotification('error', 'ไม่พบข้อมูล', 'ไม่พบข้อมูลในตาราง');
                return;
            }
            // Clear previous details
            $('#detailsTableBody').empty();
            // Add items to details table
            if (row.data && row.data.length > 0) {
                row.groupId = Object.groupBy(row.data, function (x) {
                    return ("000000000000000000" + x[9].toString()).slice(-18).slice(4)
                });
                Object.keys(row.groupId)
                    .forEach((key, index) => {
                        row.groupId[key] = row.groupId[key].sort((a, b) => {
                            return a[3].localeCompare(b[3], 'th', { numeric: true });
                        })
                        let item = row.groupId[key][0]
                        $('#detailsTableBody').append(`<tr>
                <td class="text-center text-nowrap">${index + 1}</td>
                <td class="text-center text-nowrap">${item[3]}</td>
                <td class="text-center text-nowrap">${item[4]}</td>
                <td class="text-end text-nowrap">${item[5]}</td>
                <td class="text-end text-nowrap">${row.groupId[key][0][6].toLocaleString({
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        })} กก.</td>
                <td class="text-center">${row.groupId[key].length}</td>
            </tr>`);
                    });
            } else {
                $('#detailsTableBody').append(`<tr><td colspan="5" class="text-center">ไม่พบรายการสินค้า</td></tr>`);
            }
            initTableView('detailed');
        }
        function initTableSummaryView() {
            // Destroy existing DataTable if any
            if ($.fn.DataTable.isDataTable('#detailsTable')) {
                $('#detailsTable').DataTable().destroy();
            }
            $('#detailsTable').data('table-type', 'summary')
            let billId = $('#detailsTable').data('bill-id');
            let row = getBillData(billId);
            if (!row) {
                showNotification('error', 'ไม่พบข้อมูล', 'ไม่พบข้อมูลในตาราง');
                return;
            }
            // Clear previous details
            $('#detailsTableBody').empty();
            // Add items to details table
            if (row.data && row.data.length > 0) {
                row.groupName = Object.groupBy(row.data, x => x[3]);
                Object.keys(row.groupName)
                    .forEach((key, index) => {
                        row.groupName[key] = row.groupName[key].sort((a, b) => {
                            return a[3].localeCompare(b[3], 'th', { numeric: true });
                        })
                        let item = row.groupName[key][0]
                        let weights = row.groupName[key].map(item => item[6]).map(x => parseFloat(x).toFixed(2)).join(', ');
                        let total_weight = row.groupName[key].reduce((acc, item) => acc + parseFloat(item[6]), 0).toFixed(2);
                        let item_count = row.groupName[key].length;
                        $('#detailsTableBody').append(`<tr>
                <td class="text-center text-nowrap">${index + 1}</td>
                <td class="text-start text-nowrap">${item[3]}&nbsp;<span class="text-muted">(${item_count}) (${total_weight} กก.)</span></td>
                <td class="text-start">${weights}</td>
                </tr>`);
                    });
            } else {
                $('#detailsTableBody').append(`<tr><td colspan="5" class="text-center">ไม่พบรายการสินค้า</td></tr>`);
            }
            // Initialize DataTable for summary view
            initTableView('summary');
        }
        function decryptBarcode(barcode) {
            return {
                productId: barcode.substring(4, 8),
                weight: parseFloat(barcode.substring(8, 13)) / 1000, // Convert to kg
                price: parseInt(barcode.substring(13, 18))
            };
        }
        function encryptBarcode(productId, weight, price) {
            // Extract whole part and decimal part of weight
            const [whole, decimal = ''] = weight.toString().split('.');
            // Format the components
            const productIdStr = productId.toString().padStart(8, '0');
            const weightRaw = (whole + decimal.padEnd(3, '0')).slice(0, 5).padStart(5, '0');
            const priceRaw = Math.ceil(price).toString().padStart(5, '0');
            const barcode = '0000' + productIdStr.slice(-4) + weightRaw + priceRaw;
            return barcode
        }
        // Search inventory by barcode
        function searchInventory(barcode, isInitial = false) {
            let data = demo_data
            // Check if barcode has the correct length (18 digits)
            if (barcode.length !== 18 || !/^\d{18}$/.test(barcode)) {
                showNotification('error', 'รูปแบบบาร์โค้ดไม่ถูกต้อง', 'บาร์โค้ดต้องเป็นตัวเลข 18 หลักเท่านั้น');
                return;
            }
            if (barcode == '000000000000000000') {
                // save data
                localStorage.setItem('beefScanHistory', JSON.stringify(scanHistory));
                return;
            }
            let {
                productId,
                weight,
                price
            } = decryptBarcode(barcode);
            const product = data[Number(productId).toString()];
            // Create item data directly from barcode
            const item = {
                fullname: product.fullProductName || 'ไม่พบข้อมูลสินค้า',
                name: product.productName || '',
                type: product.type || '',
                grade: product.grade || '',
                productId: productId,
                productionDate: moment().format('YYYY-MM-DD HH:mm:ss'),
                weight: weight,
                price: price,
                barcode: barcode
            };
            // Hide empty state if visible
            $('#emptyState').hide();
            // Add to history
            // Create and show the item card
            // Show notification
            if (!isInitial) {
                addToHistory(item);
                showNotification('success', 'อ่านบาร์โค้ดสำเร็จ', `รหัสสินค้า: ${productId}, น้ำหนัก: ${weight} กก., ราคา: ${price} บาท`);
            }
            renderInventoryItem(barcode, item, productId);
        }
        // Render inventory item card
        function renderInventoryItem(barcode, item) {
            $('#emptyState').hide(); // Hide empty state if visible
            $('#inventoryHeader, #actionButtons').show(); // Show header and action buttons
            // Clone the template
            const template = document.getElementById('item-template');
            const itemElement = document.importNode(template.content, true);
            $(itemElement).find('.inventory-item').attr('data-barcode', barcode); // Set barcode data attribute
            // Set item data
            $(itemElement).find('.item-name').text(item.fullname);
            $(itemElement).find('.item-id').text(item.productId);
            // Set only weight
            $(itemElement).find('.item-weight').text(item.weight + ' กก.');
            $(itemElement).find('.item-price').text(item.price + ' บาท');
            // Set only production date
            const productionDate = new Date(item.productionDate);
            $(itemElement).find('.item-production-date').text();
            // Hide expiry badge since we're not displaying it
            $(itemElement).find('.expiry-badge').hide();
            // Set scan time
            $(itemElement).find('.item-scan-time').text('สแกนเมื่อ: ' + (moment().format('DD/MM/YYYY HH:mm')));
            // Update details button click to show simplified details
            $(itemElement).find('.details-btn').on('click', function () {
                showSimplifiedItemDetails(barcode, item);
            });
            // Add to container
            const container = $('#inventoryContainer');
            container.prepend(itemElement);
            // Animate
            setTimeout(() => {
                container.find('.inventory-item').first().addClass('show');
            }, 10);
        }
        // Add to scan history
        function addToHistory(item) {
            scanHistory.unshift(item);
            localStorage.setItem('beefScanHistory', JSON.stringify(scanHistory));
        }
        // Render history list
        function renderHistory() {
            const historyList = $('#historyList');
            historyList.empty();
            if (scanHistory.length === 0) {
                historyList.html('<div class="text-center py-4 text-muted">ไม่มีประวัติการสแกน</div>');
                return;
            }
            scanHistory.forEach(item => {
                const timestamp = new Date(item.timestamp);
                const historyItem = $(`
                    <div class="history-item" data-barcode="${item.barcode}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${item.fullname}</strong>
                                <div class="text-muted small">${item.weight} กก. ${item.price} บาท</div>
                            </div>
                            <small class="text-muted">${moment(item.productionDate).format('HH:mm')}</small>
                        </div>
                    </div>
                `);
                historyList.append(historyItem);
            });
        }
        // Show simplified item details modal - shows only product ID, weight, price, and production date
        function showSimplifiedItemDetails(barcode, item) {
            Swal.fire({
                title: item.fullname,
                html: `
                    <div class="text-start px-2">
                        <div class="mb-3 d-flex justify-content-between">
                            <div>
                                <span class="badge bg-light text-dark border">รหัส: ${barcode}</span>
                            </div>
                            <div>
                                <span class="badge bg-success">น้ำหนัก: ${item.weight} กก.</span>
                            </div>
                        </div>
                        <table class="table">
                            <tr>
                                <td><strong>รหัสสินค้า:</strong></td>
                                <td>${barcode.substring(2, 8)}</td>
                            </tr>
                            <tr>
                                <td><strong>น้ำหนัก:</strong></td>
                                <td>${item.weight} กก.</td>
                            </tr>
                            <tr>
                                <td><strong>ราคาขาย:</strong></td>
                                <td>${item.price} บาท</td>
                            </tr>
                            <tr>
                                <td><strong>วันที่ผลิต:</strong></td>
                                <td>${moment(item.productionDate).format('DD/MM/YYYY HH:mm')}</td>
                            </tr>
                        </table>
                    </div>
                `,
                showConfirmButton: true,
                confirmButtonText: 'ปิด',
                confirmButtonColor: '#8B4513',
                customClass: {
                    popup: 'rounded-4'
                }
            });
        }
        // Show notification
        function showNotification(type, title, message) {
            const toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                customClass: {
                    popup: 'rounded-4'
                }
            });
            toast.fire({
                icon: type,
                title: title,
                text: message
            });
        }
        // Format date as DD/MM/YYYY
        function formatDate(date) {
            return date.toLocaleDateString('th-TH', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        // Format time as HH:MM
        function formatTime(date) {
            return date.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }
        // Update totals when items are added
        function updateTotals() {
            let itemCount = $('.inventory-item').length;
            let totalWeight = 0;
            let totalPrice = 0;
            $('.inventory-item').each(function () {
                const weightText = $(this).find('.item-weight').text();
                const priceText = $(this).find('.item-price').text();
                const weight = parseFloat(weightText.replace(' กก.', ''));
                const price = parseInt(priceText.replace(' บาท', ''));
                totalWeight += weight;
                totalPrice += price;
            });
            $('#itemCount').text(itemCount);
            $('#totalWeight').text(totalWeight.toFixed(2) + ' กก.');
            $('#totalPrice').text(totalPrice + ' บาท');
        }
        // Override renderInventoryItem to call updateTotals
        const originalRenderInventoryItem = renderInventoryItem;
        renderInventoryItem = function (barcode, item) {
            originalRenderInventoryItem(barcode, item);
            updateTotals();
        };
        function getPrintData() {
            let table = $('#table').DataTable({
                scrollX: true,
                severSide: false,
                processing: true,
                ajax: function (data, callback, settings) {
                    NProgress.start();
                    const date = $('#dateInput').val();
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                        NProgress.done();
                        if (res.success) {
                            const printData = JSON.parse(res.data);
                            callback({
                                data: printData,
                                recordsTotal: printData.length,
                                recordsFiltered: printData.length
                            });
                        } else {
                            Swal.fire({
                                title: 'ไม่สามารถดึงข้อมูลได้',
                                text: 'กรุณาลองใหม่อีกครั้ง',
                                icon: 'error',
                                confirmButtonColor: '#8B4513',
                                customClass: {
                                    popup: 'rounded-4'
                                }
                            });
                        }
                    }).getPrintData(date);
                },
                language: dt_lang,
                order: [[0, 'desc']],
                pageLength: 25,
                lengthMenu: [10, 25, 50, 100],
                columns: [
                    { title: 'เลขที่บิล', data: 'billId' },
                    { title: 'จำนวนรายการ', data: null, render: function (data, type, row) { return row.data.length; } },
                    {
                        title: 'น้ำหนักรวม (กก.)', data: 'totalWeight', render: function (data, type, row) {
                            return data.toLocaleString({
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + ' กก.';
                        }
                    },
                    {
                        title: 'ราคารวม (บาท)', data: 'totalPrice', render: function (data, type, row) {
                            return data.toLocaleString({
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + ' บาท';
                        }
                    },
                    {
                        title: 'วันที่บันทึก', data: 'productionDate',
                        render: function (data, type, row) {
                            if (data === '') return data
                            if (type == 'filter' || type == 'sort') {
                                return moment(data).toDate().getTime();
                            }
                            return moment(data).format('HH:mm');
                        }
                    },
                    {
                        title: 'รายละเอียด',
                        data: null,
                        render: function (data, type, row) {
                            return '<button class="btn btn-sm text-bg-danger details-btn py-0 px-2" data-barcode="' + row.barcode + '">รายละเอียด <i class="bi bi-arrow-right"></i></button>'
                        }
                    },
                    {
                        title: 'เพิ่มรายการ',
                        data: null,
                        render: function (data, type, row) {
                            return '<button class="btn btn-sm btn-dark add-btn py-0 px-2" onclick="manualAddBeef(this)"><i class="bi bi-plus-circle"></i>&nbsp;เพิ่มเนื้อ</button>'
                        }
                    },
                    {
                        title: 'สั่งพิมพ์',
                        data: null,
                        orderable: false,
                        searchable: false,
                        className: 'text-center text-nowrap',
                        render: function (data, type, row) {
                            return '<button class="btn btn-sm print-btn py-0 px-2" data-barcode="' + row.barcode + '"><i class="bi bi-printer-fill text-beef"></i></button>'
                        }
                    }
                ],
                columnDefs: [
                    {
                        targets: '_all',
                        className: 'text-center dt-header-center dt-nowrap',
                    },
                    {
                        targets: 4,
                        orderable: false,
                        searchable: false,
                    }
                ],
            });
            $('#table').on('click', '.details-btn', async function () {
                let row = table.row($(this).closest('tr')).data();
                NProgress.start();
                NProgress.inc();
                Swal.fire({
                    title: 'กำลังโหลดข้อมูล',
                    text: 'กรุณารอสักครู่...',
                    icon: 'info',
                    showConfirmButton: false,
                    customClass: {
                        popup: 'rounded-4',
                        icon: "text-beef"
                    }
                });
                await new Promise(resolve => {
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                        res = JSON.parse(res);
                        console.log("🚀 ~ google.script.run.withFailureHandler ~ res:", res)
                        Swal.close();
                        $('#tableDetailsModal').modal('show');
                        if (res.success) {
                            $('#billDetails')
                                .val(res.data.detail)
                                .data({
                                    'original': res.data,
                                    'is-changed': false,
                                    'bill-id': row.billId
                                });
                            $('#detail-updated-time').text('อัพเดทเมื่อ: ' + moment(res.data.updatedTime, 'YYYY-MM-DD HH:mm:ss').fromNow());
                        } else {
                            $('#billDetails')
                                .val('')
                                .data({
                                    'original': null,
                                    'is-changed': false,
                                    'bill-id': row.billId
                                })
                                .removeAttr('data-original');
                        }
                        // Populate modal with bill details
                        $('#detailDate').text(moment(row.productionDate).format('DD/MM/YYYY'));
                        $('#detailBillId').text(row.billId);
                        $('#detailTotalWeight').text(row.totalWeight.toLocaleString() + ' กก.');
                        $('#detailTotalPrice').text(row.totalPrice.toLocaleString() + ' บาท');
                        $('#detailsTable').data('bill-id', row.billId);
                        initTableDetailsView()
                        // Show the modal
                        // Setup print button
                        $('#printDetailsBtn').off('click').on('click', function () {
                            printBillDetails(row);
                        });
                        resolve();
                    }).getBillDetails(row.billId)
                });
                NProgress.done();

            });
            $('#table').on('click', '.print-btn', function () {
                const row = table.row($(this).closest('tr')).data();
                if (row.data?.length == 0) {
                    Swal.fire({
                        title: 'ไม่สามารถพิมพ์ได้',
                        text: 'ไม่มีรายการสินค้าในบิลนี้',
                        icon: 'warning',
                        confirmButtonColor: '#8B4513',
                        customClass: {
                            popup: 'rounded-4'
                        }
                    });
                    return;
                }
                row.data = row.data.sort((a, b) => {
                    return moment(b[6]).toDate().getTime() - moment(a[6]).toDate().getTime();
                })
                row.groupId = Object.groupBy(row.data, function (x) {
                    return ("000000000000000000" + x[9].toString()).slice(-18).slice(4)
                });
                $('#detailsTable').data('table-type', 'detailed');
                printBillDetails(row);
            });
        }
        function printBillDetails(row) {
            let print_html = `
            <div class="row my-3">
                <div class="col-12 text-end mb-3">
                    <p><b>เลขที่บิล</b>:  ${row.billId}</p>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-4 text-start">
                    <p class="text-nowrap"><b>วันที่</b>:  ${moment(row.productionDate).format('DD/MM/YYYY')}</p>
                </div>
                <div class="col-4 text-start">
                    <p class="text-nowrap"><b>น้ำหนักรวม</b>:  ${row.totalWeight.toLocaleString()} กก.</p>
                </div>
                <div class="col-4 text-start">
                    <p class="text-nowrap"><b>จำนวน</b>:  ${row.data.length} รายการ</p>
                </div>
                <div class="col-12">
                    <label class="text-nowrap"><b>รายละเอียด</b></label>
                    <textarea class="form-control text-start" rows="4" id="billDetailsPrint" readonly>${$('#billDetails').val().trim()}</textarea>
                </div>
            </div>
            `;
            let tableType = $('#detailsTable').data('table-type');
            if (tableType === 'detailed') {
                print_html += `<div class="row mb-3"><div class="col-12">
                <table class="table table-bordered" id="detailsTablePrint">  
                    <tbody id="detailsTableBodyPrint">
                        <tr class="text-center text-nowrap">
                            <th class="text-center">#</th>
                            <th class="text-center">ชื่อสินค้า</th>
                            <th class="text-center">ประเภท</th>
                            <th class="text-center">เกรด</th>
                            <th class="text-center">น้ำหนัก (กก.)</th>
                            <th class="text-center">จำนวน</th>
                        </tr>
                    </tbody>
                </table></div></div>`;
                $('#print-area').html(print_html);
                if (row.data && row.data.length > 0) {
                    Object.keys(row.groupId)
                        .sort((a, b) => {
                            return a.localeCompare(b, 'th', { numeric: true });
                        })
                        .forEach((key, index) => {
                            let item = row.groupId[key][0]
                            $('#detailsTableBodyPrint').append(`
                            <tr>
                                <td class="text-center text-nowrap">${index + 1}</td>
                                <td class="text-center text-nowrap">${item[3]}</td>
                                <td class="text-center text-nowrap">${item[4]}</td>
                                <td class="text-end text-nowrap">${item[5]}</td>
                                <td class="text-end text-nowrap">${row.groupId[key][0][6].toLocaleString({
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            })} กก.</td>
                                <td class="text-center">${row.groupId[key].length}</td>
                            </tr>
                        `);
                        });
                } else {
                    $('#detailsTableBodyPrint').append(`
                    <tr>
                        <td colspan="5" class="text-center">ไม่พบรายการสินค้า</td>
                    </tr>
                `);
                }
            } else if (tableType === 'summary') {
                print_html += `<div class="row mb-3"><div class="col-12">
                <table class="table table-bordered" id="detailsTablePrint">  
                    <tbody id="detailsTableBodyPrint">
                        <tr class="text-center text-nowrap">
                            <th class="text-center">#</th>
                            <th class="text-center">ชื่อสินค้า</th>
                            <th class="text-center">น้ำหนัก (กก.)</th>
                        </tr>
                    </tbody>
                </table></div></div>`;
                $('#print-area').html(print_html);
                if (row.data && row.data.length > 0) {
                    row.groupName = Object.groupBy(row.data, x => x[3]);
                    Object.keys(row.groupName)
                        .sort((a, b) => {
                            return a.localeCompare(b, 'th', { numeric: true });
                        })
                        .forEach((key, index) => {
                            let item = row.groupName[key][0]
                            let weights = row.groupName[key].map(item => item[6]).map(x => parseFloat(x).toFixed(2)).join(', ');
                            let total_weight = row.groupName[key].reduce((acc, item) => acc + parseFloat(item[6]), 0)
                                .toFixed(2);
                            let item_count = row.groupName[key].length
                            $('#detailsTableBodyPrint').append(`
                            <tr>
                                <td class="text-center text-nowrap">${index + 1}</td>
                                <td class="text-start text-nowrap">${item[3]}&nbsp;<span class="text-muted">(${item_count}) (${total_weight} กก.)</span></td>
                                <td class="text-start">${weights}</td>
                            </tr>
                        `);
                        });
                } else {
                    $('#detailsTableBodyPrint').append(`
                    <tr>
                        <td colspan="3" class="text-center">ไม่พบรายการสินค้า</td>
                    </tr>
                `);
                }
            } else {
                console.error('Unknown table type:', tableType);
                return;
            }
            // Print the content of the print area
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write('<html><head><title>Print Bill Details</title>');
            printWindow.document.write('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">');
            printWindow.document.write('<style>body{font-family: "Mitr", sans-serif;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container">');
            printWindow.document.write($('#print-area').html());
            printWindow.document.write('</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.onload = function () {
                printWindow.print();
                // printWindow.close();
            };
        }
        function manualAddBeef(btn) {
            const row = $(btn).closest('tr');
            const data = $('#table').DataTable().row(row).data();
            $('#manualAddBeefModalLabel').text('เพิ่มเนื้อเข้าบิล ' + data.billId);
            $('#addBeefBillId').val(data.billId);
            $('#manualAddBeefModal').modal('show');
        }
        $('#manualAddBeefModal').on('show.bs.modal', function () {
            $('#beefProduct').val('');
            $('#beefWeight').val('');
            $('#weightUnit').val('kg');
            $('#beefPrice').val('');
            $('#beefProduct').focus();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <script src="https://cdn.datatables.net/v/bs5/dt-2.2.2/date-1.5.5/r-3.0.4/datatables.min.js"
        integrity="sha384-rLmuC6QiRpU3tKULE0+0yoUC4bOdfliJtgfKQnEIX1VqsucsKqaDl7qb0fCvbkxy"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.full.min.js"></script>
    <script>
        AOS.init();
        document.addEventListener("DOMContentLoaded", function () {
            NProgress.start();
            NProgress.inc()
        });
        window.addEventListener("load", function () {
            NProgress.done();
        });
    </script>
</body>

</html>


// function doGet(e) {
//     let opt = e.parameter.opt
//     if (opt === 'getbarcode') {
//       return getBarcodeDatas()
//     }
//     return HtmlService.createTemplateFromFile('index').evaluate()
//       .setSandboxMode(HtmlService.SandboxMode.IFRAME)
//       .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
//       .setTitle('Beef Good')
//       .addMetaTag('viewport', 'width=device-width, initial-scale=1')
//   }
  
//   function getBarcodeDatas() {
//     let ss = SpreadsheetApp.openById('1nUC-TGjuKHsblYzMzgX0t5AMzlbgEK4dHTFggD-1SzA')
//     let sheet = ss.getSheetByName('barcodescale')
//     let data = sheet.getDataRange().getValues().filter(r => r[0] !== '')
//     // data = data.map(r => {
//     //     return {
//     //         productId: r[0],
//     //         productName: [r[1] ,r[3] ,r[4]].filter(Boolean).join(' '),
//     //         price: r[5],
//     //     }
//     // })
//     data = data.reduce((acc, r) => {
//       let productId = r[0]
//       let fullProductName = [r[1], r[3], r[4]].filter(Boolean).join(' ')
//       let productName = r[1]
//       let type = r[3]
//       let grade = r[4]
//       let price = r[5]
//       if (!acc[productId]) {
//         acc[productId] = { productName, price, type, grade, fullProductName }
//       }
//       return acc
//     }, {})
//     let a = Object.entries(data)
//     return JSON.stringify(data)
//   }
  
//   function saveDataToSheet(data) {
//     const lock = LockService.getScriptLock();
  
//     // Exit early if lock can't be acquired
//     if (!lock.tryLock(10000)) {
//       return {
//         success: false,
//         message: 'Unable to acquire lock'
//       };
//     }
  
//     try {
//       const ss = SpreadsheetApp.getActiveSpreadsheet();
//       const sheet = ss.getSheetByName('data');
//       const lastRow = sheet.getLastRow();
//       const newRow = lastRow + 1;
//       const billId = getBillID(sheet);
//       const today = new Date();
  
//       // Prepare the data in one transformation
//       const formattedData = data.map(row => [
//         today,
//         billId,
//         row.productId,
//         row.name,
//         row.type,
//         row.grade,
//         row.weight,
//         row.price,
//         row.productionDate,
//         row.barcode
//       ]);
  
//       // Create formats array once instead of mapping each time
//       const formats = new Array(formattedData.length).fill(
//         ["dd/MM/yyyy HH:mm:ss", '@', '@', '@', '@', '@', '#', '#', 'yyyy-MM-dd HH:mm:ss', '000000000000000000']
//       );
  
//       // Set values and formats in one operation
//       sheet.getRange(newRow, 1, formattedData.length, formattedData[0].length)
//         .setNumberFormats(formats)
//         .setValues(formattedData);
  
//       return { success: true, billId: billId };
//     } catch (error) {
//       return { success: false, message: error.toString() };
//     } finally {
//       // Always release the lock
//       lock.releaseLock();
//     }
//   }
  
//   function getBillID(sheet) {
//     let lastRow = sheet.getLastRow();
//     let today = new Date();
//     let prefix = [
//       (today.getFullYear() < 2500 ? today.getFullYear() + 543 : today.getFullYear()).toString().slice(-2),
//       (today.getMonth() + 1).toString().padStart(2, '0'),
//       today.getDate().toString().padStart(2, '0')
//     ].join('');
//     if (lastRow <= 1) {
//       return `${prefix}-01`;
//     }
//     let lastBillId = sheet.getRange(lastRow, 2).getValue().toString();
//     if (!lastBillId.startsWith(prefix)) {
//       return `${prefix}-01`;
//     }
//     let newCounter = (parseInt(lastBillId.split('-')[1], 10) + 1).toString().padStart(2, '0');
//     return `${prefix}-${newCounter}`;
//   }
  
  
//   function getPrintData(dateFilter) {
//     let ss = SpreadsheetApp.getActiveSpreadsheet()
//     let sheet = ss.getSheetByName('data')
//     let sh_data = sheet.getDataRange().getValues().slice(1)
//     let data
//     if (dateFilter) {
//       let filterDate = new Date(dateFilter)
//       let filterYear = filterDate.getFullYear()
//       let filterMonth = filterDate.getMonth()
//       let filterDay = filterDate.getDate()
//       data = sh_data.filter(r => {
//         let date = new Date(r[0])
//         return date.getFullYear() === filterYear &&
//           date.getMonth() === filterMonth &&
//           date.getDate() === filterDay
//       })
//     }else{
//       data = sh_data
//     }
//     let filterBillIds = data.map(r => r[1])
//     data = sh_data.filter(r => {
//       return filterBillIds.includes(r[1])
//     })
//     let billIds = [...new Set(data.map(r => r[1]))]
//     let result = billIds.map(billId => {
//       let billData = data.filter(r => r[1] === billId)
//       let totalWeight = billData.reduce((acc, r) => acc + r[6], 0)
//       let totalPrice = billData.reduce((acc, r) => acc + r[7], 0)
//       let productionDate = billData[0][8]
//       return {
//         billId: billId,
//         totalWeight: totalWeight,
//         totalPrice: totalPrice,
//         productionDate: productionDate,
//         data: billData
//       }
//     })
//     return {
//       success: true,
//       data: JSON.stringify(result)
//     }
//   }
  
//   function addBeefToSheet(e) {
//     let {
//       barcode,
//       productName,
//       productId,
//       weight,
//       unit,
//       price,
//       type,
//       grade,
//       quantity,
//       scanTime,
//       billid
//     } = e
//     let lock = LockService.getScriptLock()
//     if (!lock.tryLock(10000)) {
//       return {
//         success: false,
//         message: 'Unable to acquire lock'
//       }
//     }
//     try {
//       let ss = SpreadsheetApp.getActiveSpreadsheet()
//       let sheet = ss.getSheetByName('data')
//       let data = sheet.getDataRange().getValues()
//       let last_billiD_index = data.findLastIndex(r => r[1] === billid)
//       let bill_timestamp = data[last_billiD_index][0]
//       let insert_row = [
//         bill_timestamp,
//         billid,
//         productId,
//         productName,
//         type,
//         grade,
//         weight,
//         price,
//         new Date(scanTime), 
//         barcode
//       ]
//       if (last_billiD_index === -1) {
//         return {
//           success: false,
//           message: 'ไม่พบบิลนี้ในระบบ'
//         }
//       }
//       sheet.insertRowAfter(last_billiD_index + 1)
//       sheet.getRange(last_billiD_index + 2, 1, 1, insert_row.length)
//         .setValues([insert_row])
//       return {
//         success: true,
//         message: 'บันทึกข้อมูลเรียบร้อยแล้ว'
//       }
//     } catch (error) {
//       return {
//         success: false,
//         message: error.toString()
//       }
//     } finally {
//       lock.releaseLock()
//     }
//   }
  

//   function getBillDetails(billId){
//     let ss = SpreadsheetApp.getActiveSpreadsheet()
//     let sheet = ss.getSheetByName('รายละเอียดบิล')
//     let data = sheet.getDataRange().getValues()
//     let billData = data.find(r => r[1] === billId)
//     if (!billData) {
//       return JSON.stringify({
//         success: false,
//         message: 'ไม่พบบิลนี้ในระบบ'
//       })
//     }
//     return JSON.stringify({
//       success: true,
//       data: {
//         detail: billData[2],
//         updated: billData[3],
//       }
//     })
//   }

//   function saveBillDetails(billId, detail){
//     let ss = SpreadsheetApp.getActiveSpreadsheet()
//     let sheet = ss.getSheetByName('รายละเอียดบิล')
//     let data = sheet.getDataRange().getValues()
//     let updated = new Date()
//     let index = data.findIndex(r => r[1] === billId)
//     if(index === -1){
//         sheet.getRange(sheet.getLastRow() + 1, 1, 1, 4)
//         .setValues([[updated, billId, detail, updated]])
//     }else{
//         sheet.getRange(index + 1, 3, 1, 2)
//         .setValues([[detail, updated]])
//     }
//     return JSON.stringify({
//       success: true,
//       message: 'บันทึกข้อมูลเรียบร้อยแล้ว'
//     })
//   }
