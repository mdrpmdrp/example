<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYM Operations System</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B35',
                        secondary: '#FF8E53',
                        accent: '#FFB366',
                        dark: '#2D1B69'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #FF6B35 0%, #FF8E53 100%);
        }

        .card-shadow {
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF6B35 0%, #FF8E53 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
        }

        .pending-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .datetime-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">KYM Operations System</h1>
                <p class="text-gray-600">ระบบบันทึกข้อมูล KYM และการโทรออก</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                        required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                        required>
                </div>
                <button type="submit"
                    class="w-full btn-primary text-white py-3 rounded-lg font-semibold">เข้าสู่ระบบ</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold">KYM Operations System</h1>
                        <p class="datetime-display" id="currentDateTime"></p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-sm"></span>
                        <button id="logoutBtn"
                            class="bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30 transition">ออกจากระบบ</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-md">
            <div class="container mx-auto px-4">
                <div class="flex space-x-8">
                    <button class="nav-btn py-4 px-6 border-b-2 border-primary text-primary font-semibold"
                        data-tab="kym">บันทึก KYM</button>
                    <button class="nav-btn py-4 px-6 text-gray-600 hover:text-primary"
                        data-tab="calls">การโทรออก</button>
                    <button class="nav-btn py-4 px-6 text-gray-600 hover:text-primary"
                        data-tab="reports">รายงาน</button>
                    <button id="dashboardBtn" class="nav-btn py-4 px-6 text-gray-600 hover:text-primary hidden"
                        data-tab="dashboard">แดชบอร์ด</button>
                    <button id="userManagementBtn" class="nav-btn py-4 px-6 text-gray-600 hover:text-primary hidden"
                        data-tab="users">จัดการผู้ใช้</button>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="container mx-auto px-4 py-8">
            <!-- KYM Form Tab -->
            <div id="kymTab" class="tab-content">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">บันทึกการทำ KYM</h2>
                    <form id="kymForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">หมายเลขทรูมันนี่</label>
                                <input type="tel" id="truemoneyId"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    placeholder="เช่น 0812345678" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อร้านค้า</label>
                                <input type="text" id="storeName"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    placeholder="ชื่อร้านค้า" required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ช่องทางการขาย</label>
                            <select id="salesChannel"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                required>
                                <option value="">เลือกช่องทางการขาย</option>
                                <option value="มีหน้าร้าน">มีหน้าร้าน</option>
                                <option value="ขายออนไลน์">ขายออนไลน์</option>
                                <option value="มีหน้าร้านและขายออนไลน์">มีหน้าร้านและขายออนไลน์</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่หลัก
                                    (Category)</label>
                                <select id="category"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    required>
                                    <option value="">เลือกหมวดหมู่หลัก</option>
                                    <option value="การศึกษา">การศึกษา</option>
                                    <option value="ช้อปปิ้ง">ช้อปปิ้ง</option>
                                    <option value="ท่องเที่ยว">ท่องเที่ยว</option>
                                    <option value="บริการต่างๆ">บริการต่างๆ</option>
                                    <option value="บันเทิง">บันเทิง</option>
                                    <option value="สุขภาพและความงาม">สุขภาพและความงาม</option>
                                    <option value="อาหารและเครื่องดื่ม">อาหารและเครื่องดื่ม</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่ย่อย
                                    (Sub-category)</label>
                                <select id="subCategory"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    required>
                                    <option value="">เลือกหมวดหมู่ย่อย</option>
                                </select>
                            </div>
                        </div>

                        <!-- KYM Assessment Section -->
                        <div class="bg-gradient-to-br from-orange-50 to-amber-50 p-6 rounded-xl border border-orange-200 space-y-6"
                            id="assessmentSection">
                            <div class="flex items-center space-x-3 mb-6">
                                <div class="bg-orange-500 p-2 rounded-lg">
                                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-orange-800">ระบบประเมิน KYM</h3>
                            </div>
                            <!-- Assessment Items Container -->
                            <div id="assessmentInfo" class="space-y-4">
                                <!-- This will be populated by renderAssessmentSection() -->
                                <div class="text-center py-8 text-gray-500">
                                    <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="currentColor"
                                        viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                    <p class="text-lg font-medium">กรุณาเลือกช่องทางการขาย</p>
                                    <p class="text-sm">เพื่อแสดงระบบประเมิน KYM ที่เหมาะสม</p>
                                </div>
                            </div>

                            <!-- Recommended Status -->
                            <div
                                class="bg-gradient-to-r from-orange-100 to-amber-100 p-6 rounded-xl border-2 border-orange-300 shadow-lg">
                                <div class="flex items-center space-x-4 mb-4">
                                    <div class="bg-orange-500 p-3 rounded-full shadow-md">
                                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-orange-800">สถานะที่แนะนำ</h4>
                                </div>
                                <div class="bg-white p-4 rounded-lg border border-orange-200 shadow-sm">
                                    <div id="recommendedStatus" class="text-2xl font-bold text-orange-700 mb-2">
                                        กรุณาประเมินข้อมูล</div>
                                    <div id="statusReason" class="text-base text-orange-600 font-medium"></div>
                                </div>
                            </div>

                            <!-- Quick Status Buttons -->
                            <div class="space-y-3">
                                <label class="block text-sm font-medium text-orange-800">เลือกสถานะ KYM:</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <button type="button" id="approveBtn"
                                        class="status-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-4 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg">
                                        <div class="flex items-center justify-center space-x-2">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                            <div class="text-center">
                                                <div>Approved</div>
                                                <div class="text-xs opacity-90">อนุมัติ</div>
                                            </div>
                                        </div>
                                    </button>
                                    <button type="button" id="reviseBtn"
                                        class="status-btn bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white py-3 px-4 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg">
                                        <div class="flex items-center justify-center space-x-2">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                            <div class="text-center">
                                                <div>Revised</div>
                                                <div class="text-xs opacity-90">แก้ไขข้อมูล</div>
                                            </div>
                                        </div>
                                    </button>
                                    <button type="button" id="rejectBtn"
                                        class="status-btn bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 px-4 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg">
                                        <div class="flex items-center justify-center space-x-2">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                            <div class="text-center">
                                                <div>Rejected</div>
                                                <div class="text-xs opacity-90">ไม่อนุมัติ</div>
                                            </div>
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <!-- Hidden Status Field -->
                            <input type="hidden" id="kymStatus" required>
                        </div>

                        <div id="reasonSection" class="hidden">
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2">เหตุผลที่ต้องแก้ไข/ปฏิเสธ</label>
                            <textarea id="reason"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                rows="4"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">หมายเหตุเพิ่มเติม</label>
                            <textarea id="notes"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                rows="3"></textarea>
                        </div>

                        <div class="flex space-x-4">
                            <button type="submit"
                                class="btn-primary text-white px-8 py-3 rounded-lg font-semibold">บันทึกข้อมูล
                                KYM</button>
                            <button type="button" id="clearKymForm"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition">ยกเลิก</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Calls Tab -->
            <div id="callsTab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- New Call Form -->
                    <div class="bg-white rounded-xl card-shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">บันทึกการโทรออก</h2>
                        <form id="callForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">หมายเลขทรูมันนี่</label>
                                    <input type="tel" id="callTruemoneyId"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                        placeholder="เช่น 0812345678" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">เบอร์ติดต่อกลับ</label>
                                    <input type="tel" id="contactNumber"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                        placeholder="เช่น 0812345678">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อร้านค้า</label>
                                <input type="text" id="callStoreName"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    placeholder="ชื่อร้านค้า" required>
                            </div>

                            <div>
                                <label
                                    class="block text-sm font-medium text-gray-700 mb-2">ชื่อผู้ที่ติดต่อ/เจ้าของร้าน</label>
                                <input type="text" id="contactName"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    placeholder="ชื่อ-นามสกุล">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">เหตุผลที่โทรออก</label>
                                <select id="callReason"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    required>
                                    <option value="">เลือกเหตุผล</option>
                                    <option value="เอกสารไม่ครบ">เอกสารไม่ครบ</option>
                                    <option value="ข้อมูลไม่ถูกต้อง">ข้อมูลไม่ถูกต้อง</option>
                                    <option value="ต้องการข้อมูลเพิ่มเติม">ต้องการข้อมูลเพิ่มเติม</option>
                                    <option value="ติดตามผล">ติดตามผล</option>
                                    <option value="อื่นๆ">อื่นๆ</option>
                                </select>
                            </div>

                            <div id="otherReasonSection" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ระบุเหตุผลอื่นๆ</label>
                                <input type="text" id="otherReason"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    placeholder="กรุณาระบุเหตุผล">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ผลการโทรออก</label>
                                <select id="callResult"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    required>
                                    <option value="">เลือกผลการโทร</option>
                                    <option value="ติดต่อได้">ติดต่อได้</option>
                                    <option value="ไม่รับสาย">ไม่รับสาย</option>
                                    <option value="เบอร์ผิด">เบอร์ผิด</option>
                                    <option value="ปิดเครื่อง">ปิดเครื่อง</option>
                                    <option value="ไม่สะดวก ขอนัดหมายใหม่">ไม่สะดวก ขอนัดหมายใหม่</option>
                                    <option value="ติดต่อไม่ได้ - ต้องโทรใหม่">ติดต่อไม่ได้ - ต้องโทรใหม่</option>
                                </select>
                            </div>

                            <div id="rescheduleSection" class="hidden space-y-4">
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-2">วันที่และเวลานัดหมายใหม่</label>
                                    <input type="text" id="rescheduleDateTime"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                </div>

                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-2">ช่วงเวลาที่เหมาะสม</label>
                                    <select id="preferredTimeSlot"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                        <option value="">เลือกช่วงเวลา</option>
                                        <option value="เช้า (09:00-12:00)">เช้า (09:00-12:00)</option>
                                        <option value="บ่าย (13:00-16:00)">บ่าย (13:00-16:00)</option>
                                        <option value="เย็น (17:00-20:00)">เย็น (17:00-20:00)</option>
                                        <option value="ตามสะดวก">ตามสะดวก</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">รายละเอียดการโทร</label>
                                <textarea id="callDetails"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    rows="4" required></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">สถานะเคส</label>
                                <select id="caseStatus"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                    required>
                                    <option value="Pending">Pending - รอดำเนินการ</option>
                                    <option value="Closed">Closed - ปิดเคส</option>
                                </select>
                            </div>

                            <div id="followUpSection" class="hidden space-y-4">
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-2">กำหนดนัดหมายครั้งต่อไป</label>
                                    <input type="datetime-local" id="followUpDate"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                </div>

                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-2">ช่วงเวลาที่ควรโทร</label>
                                    <select id="nextCallTimeSlot"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                        <option value="">เลือกช่วงเวลา</option>
                                        <option value="เช้า (09:00-12:00)">เช้า (09:00-12:00)</option>
                                        <option value="บ่าย (13:00-16:00)">บ่าย (13:00-16:00)</option>
                                        <option value="เย็น (17:00-20:00)">เย็น (17:00-20:00)</option>
                                        <option value="ตามสะดวก">ตามสะดวก</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Section for retry calls when contact failed -->
                            <div id="retryCallSection" class="hidden space-y-4">
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div class="flex items-center mb-3">
                                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <h4 class="font-medium text-yellow-800">กำหนดการโทรครั้งต่อไป</h4>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label
                                                class="block text-sm font-medium text-yellow-700 mb-2">วันที่โทรครั้งต่อไป</label>
                                            <input type="text" id="retryCallDate"
                                                class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white">
                                        </div>

                                        <div>
                                            <label
                                                class="block text-sm font-medium text-yellow-700 mb-2">ช่วงเวลาที่แนะนำ</label>
                                            <select id="retryTimeSlot"
                                                class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white">
                                                <option value="">เลือกช่วงเวลา</option>
                                                <option value="เช้า (09:00-12:00)">เช้า (09:00-12:00)</option>
                                                <option value="บ่าย (13:00-16:00)">บ่าย (13:00-16:00)</option>
                                                <option value="เย็น (17:00-20:00)">เย็น (17:00-20:00)</option>
                                                <option value="ตามสะดวก">ตามสะดวก</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <label
                                            class="block text-sm font-medium text-yellow-700 mb-2">หมายเหตุการโทรครั้งต่อไป</label>
                                        <textarea id="retryNotes"
                                            class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white"
                                            rows="2"
                                            placeholder="เช่น ลูกค้าขอให้โทรช่วงเย็น, หลีกเลี่ยงช่วงเที่ยง"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="flex space-x-4">
                                <button type="submit"
                                    class="btn-primary text-white px-8 py-3 rounded-lg font-semibold">บันทึกการโทรออก</button>
                                <button type="button" id="clearCallForm"
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition">ยกเลิก</button>
                            </div>
                        </form>
                    </div>

                    <!-- Pending Cases -->
                    <div class="bg-white rounded-xl card-shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">เคส Pending</h2>
                        <div id="pendingCases" class="space-y-4">
                            <!-- Pending cases will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Case Detail Modal -->
                <div id="caseDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-xl font-bold text-gray-800">รายละเอียดเคส</h3>
                                    <button id="closeCaseModal" class="text-gray-500 hover:text-gray-700">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div id="caseDetailContent">
                                    <!-- Case details will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Follow-up Call Modal -->
                <div id="followUpModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-xl font-bold text-gray-800">บันทึกการโทรติดตาม</h3>
                                    <button id="closeFollowUpModal" class="text-gray-500 hover:text-gray-700">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>

                                <!-- Case Info Display -->
                                <div id="followUpCaseInfo"
                                    class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                    <!-- Case info will be loaded here -->
                                </div>

                                <!-- Follow-up Form -->
                                <form id="followUpForm" class="space-y-6">
                                    <input type="hidden" id="followUpCaseId">

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ผลการโทรออก</label>
                                        <select id="followUpCallResult"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                            required>
                                            <option value="">เลือกผลการโทร</option>
                                            <option value="ติดต่อได้">ติดต่อได้</option>
                                            <option value="ไม่รับสาย">ไม่รับสาย</option>
                                            <option value="เบอร์ผิด">เบอร์ผิด</option>
                                            <option value="ปิดเครื่อง">ปิดเครื่อง</option>
                                            <option value="ไม่สะดวก">ไม่สะดวก ขอนัดหมายใหม่</option>
                                            <option value="ติดต่อไม่ได้">ติดต่อไม่ได้ - ต้องโทรใหม่</option>
                                        </select>
                                    </div>

                                    <div id="followUpRescheduleSection" class="hidden space-y-4">
                                        <div>
                                            <label
                                                class="block text-sm font-medium text-gray-700 mb-2">วันที่และเวลานัดหมายใหม่</label>
                                            <input type="text" id="followUpRescheduleDateTime"
                                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                        </div>
                                    </div>

                                    <div id="followUpRetrySection" class="hidden space-y-4">
                                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                            <div class="flex items-center mb-3">
                                                <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor"
                                                    viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd"
                                                        d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                                        clip-rule="evenodd"></path>
                                                </svg>
                                                <h4 class="font-medium text-yellow-800">กำหนดการโทรครั้งต่อไป</h4>
                                            </div>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label
                                                        class="block text-sm font-medium text-yellow-700 mb-2">วันที่โทรครั้งต่อไป</label>
                                                    <input type="text" id="followUpRetryCallDate"
                                                        class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white">
                                                </div>

                                                <div>
                                                    <label
                                                        class="block text-sm font-medium text-yellow-700 mb-2">ช่วงเวลาที่แนะนำ</label>
                                                    <select id="followUpRetryTimeSlot"
                                                        class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white">
                                                        <option value="">เลือกช่วงเวลา</option>
                                                        <option value="เช้า (09:00-12:00)">เช้า (09:00-12:00)</option>
                                                        <option value="บ่าย (13:00-16:00)">บ่าย (13:00-16:00)</option>
                                                        <option value="เย็น (17:00-20:00)">เย็น (17:00-20:00)</option>
                                                        <option value="ตามสะดวก">ตามสะดวก</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="mt-3">
                                                <label
                                                    class="block text-sm font-medium text-yellow-700 mb-2">หมายเหตุการโทรครั้งต่อไป</label>
                                                <textarea id="followUpRetryNotes"
                                                    class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white"
                                                    rows="2"
                                                    placeholder="เช่น ลูกค้าขอให้โทรช่วงเย็น, หลีกเลี่ยงช่วงเที่ยง"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2">รายละเอียดการโทร</label>
                                        <textarea id="followUpCallDetails"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                            rows="4" required></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">สถานะเคส</label>
                                        <select id="followUpCaseStatus"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                            required>
                                            <option value="Pending">Pending - รอดำเนินการ</option>
                                            <option value="Closed">Closed - ปิดเคส</option>
                                        </select>
                                    </div>

                                    <div id="followUpNextCallSection" class="hidden space-y-4">
                                        <div>
                                            <label
                                                class="block text-sm font-medium text-gray-700 mb-2">กำหนดนัดหมายครั้งต่อไป</label>
                                            <input type="datetime-local" id="followUpNextCallDate"
                                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                        </div>

                                        <div>
                                            <label
                                                class="block text-sm font-medium text-gray-700 mb-2">ช่วงเวลาที่ควรโทร</label>
                                            <select id="followUpNextCallTimeSlot"
                                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                                <option value="">เลือกช่วงเวลา</option>
                                                <option value="เช้า (09:00-12:00)">เช้า (09:00-12:00)</option>
                                                <option value="บ่าย (13:00-16:00)">บ่าย (13:00-16:00)</option>
                                                <option value="เย็น (17:00-20:00)">เย็น (17:00-20:00)</option>
                                                <option value="ตามสะดวก">ตามสะดวก</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="flex space-x-4 pt-4">
                                        <button type="submit"
                                            class="btn-primary text-white px-8 py-3 rounded-lg font-semibold">บันทึกการโทรติดตาม</button>
                                        <button type="button" id="cancelFollowUp"
                                            class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition">ยกเลิก</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content hidden">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">รายงาน</h2>

                    <!-- Quick Filter Buttons -->
                    <div class="flex flex-wrap gap-3 mb-6">
                        <button id="todayReport"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition">วันนี้</button>
                        <button id="last7DaysReport"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition">7
                            วันย้อนหลัง</button>
                        <button id="last30DaysReport"
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition">30
                            วันย้อนหลัง</button>
                        <button id="customRangeBtn"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition">กำหนดช่วงเอง</button>
                    </div>

                    <!-- Custom Date Range Section -->
                    <div id="customDateRange"
                        class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">วันที่เริ่มต้น</label>
                            <input type="date" id="reportStartDate"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">วันที่สิ้นสุด</label>
                            <input type="date" id="reportEndDate"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex items-end">
                            <button id="generateCustomReport"
                                class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">สร้างรายงาน</button>
                        </div>
                    </div>

                    <!-- Report Results -->
                    <div id="reportResults" class="space-y-6">
                        <!-- Report content will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab (Supervisor Only) -->
            <div id="dashboardTab" class="tab-content hidden">
                <div class="space-y-8">
                    <!-- Date Range Selector -->
                    <div class="bg-white rounded-xl card-shadow p-6">
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">แดชบอร์ด</h2>
                            <div class="flex flex-wrap gap-3">
                                <button id="dashToday"
                                    class="dashboard-period-btn bg-blue-500 text-white px-4 py-2 rounded-lg font-medium transition hover:bg-blue-600">วันนี้</button>
                                <button id="dashYesterday"
                                    class="dashboard-period-btn bg-gray-500 text-white px-4 py-2 rounded-lg font-medium transition hover:bg-gray-600">เมื่อวาน</button>
                                <button id="dash7Days"
                                    class="dashboard-period-btn bg-green-500 text-white px-4 py-2 rounded-lg font-medium transition hover:bg-green-600">7
                                    วัน</button>
                                <button id="dash30Days"
                                    class="dashboard-period-btn bg-purple-500 text-white px-4 py-2 rounded-lg font-medium transition hover:bg-purple-600">30
                                    วัน</button>
                                <button id="dashCustom"
                                    class="dashboard-period-btn bg-orange-500 text-white px-4 py-2 rounded-lg font-medium transition hover:bg-orange-600">กำหนดเอง</button>
                            </div>
                        </div>

                        <!-- Custom Date Range for Dashboard -->
                        <div id="dashboardCustomRange"
                            class="hidden mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">วันที่เริ่มต้น</label>
                                <input type="date" id="dashStartDate"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">วันที่สิ้นสุด</label>
                                <input type="date" id="dashEndDate"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="flex items-end">
                                <button id="updateDashboard"
                                    class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">อัปเดต</button>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-primary">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">KYM ทั้งหมด</p>
                                    <p class="text-4xl font-bold text-primary" id="totalKym">0</p>
                                    <p class="text-xs text-green-600 mt-1" id="kymGrowth">+0%</p>
                                </div>
                                <div class="bg-primary bg-opacity-10 p-4 rounded-full">
                                    <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-secondary">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">การโทรทั้งหมด</p>
                                    <p class="text-4xl font-bold text-secondary" id="totalCalls">0</p>
                                    <p class="text-xs text-green-600 mt-1" id="callsGrowth">+0%</p>
                                </div>
                                <div class="bg-secondary bg-opacity-10 p-4 rounded-full">
                                    <svg class="w-8 h-8 text-secondary" fill="currentColor" viewBox="0 0 20 20">
                                        <path
                                            d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z">
                                        </path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Pending Cases</p>
                                    <p class="text-4xl font-bold text-red-500 pending-pulse" id="pendingCount">0</p>
                                    <p class="text-xs text-red-600 mt-1" id="slaExpired">0 เกิน SLA</p>
                                </div>
                                <div class="bg-red-100 p-4 rounded-full">
                                    <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">อัตราสำเร็จ</p>
                                    <p class="text-4xl font-bold text-green-500" id="successRate">0%</p>
                                    <p class="text-xs text-green-600 mt-1" id="successGrowth">+0%</p>
                                </div>
                                <div class="bg-green-100 p-4 rounded-full">
                                    <svg class="w-8 h-8 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Performers -->
                    <div class="bg-white rounded-xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z">
                                </path>
                            </svg>
                            พนักงานดีเด่น
                        </h3>
                        <div id="topPerformers" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Top performers will be loaded here -->
                        </div>
                    </div>

                    <!-- Employee Performance Table -->
                    <div class="bg-white rounded-xl card-shadow overflow-hidden">
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path
                                            d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z">
                                        </path>
                                    </svg>
                                    ผลงานรายพนักงาน
                                </h3>
                                <div class="flex items-center space-x-3">
                                    <select id="sortBy"
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary text-sm">
                                        <option value="score">เรียงตามคะแนน</option>
                                        <option value="kym">เรียงตาม KYM</option>
                                        <option value="calls">เรียงตามการโทร</option>
                                        <option value="success">เรียงตามอัตราสำเร็จ</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            อันดับ</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            พนักงาน</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            KYM</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            การโทร</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            อัตราสำเร็จ</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Pending</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            คะแนน</th>
                                    </tr>
                                </thead>
                                <tbody id="performanceTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Performance data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- KYM Status Distribution -->
                    <div class="bg-white rounded-xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z">
                                </path>
                            </svg>
                            การกระจายสถานะ KYM
                        </h3>
                        <div id="kymStatusChart" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- KYM status distribution will be loaded here -->
                        </div>
                    </div>

                    <!-- Alerts Section -->
                    <div class="bg-white rounded-xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            แจ้งเตือนสำคัญ
                        </h3>
                        <div id="alertsSection" class="space-y-4">
                            <!-- Alerts will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Tab (Admin Only) -->
            <div id="usersTab" class="tab-content hidden">
                <div class="space-y-8">
                    <!-- Header Section -->
                    <div class="bg-gradient-to-r from-primary to-secondary text-white rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold mb-2">จัดการผู้ใช้งาน</h2>
                                <p class="text-sm opacity-90">เพิ่ม แก้ไข และจัดการสิทธิ์ผู้ใช้ในระบบ</p>
                            </div>
                            <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                                <div class="text-2xl font-bold" id="totalUsers">0</div>
                                <div class="text-sm opacity-90">ผู้ใช้ทั้งหมด</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Admin</p>
                                    <p class="text-2xl font-bold text-red-600" id="adminCount">0</p>
                                </div>
                                <div class="bg-red-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Supervisor</p>
                                    <p class="text-2xl font-bold text-blue-600" id="supervisorCount">0</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path
                                            d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z">
                                        </path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Employee</p>
                                    <p class="text-2xl font-bold text-green-600" id="employeeCount">0</p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path
                                            d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z">
                                        </path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-yellow-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">ระงับการใช้งาน</p>
                                    <p class="text-2xl font-bold text-yellow-600" id="inactiveCount">0</p>
                                </div>
                                <div class="bg-yellow-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add User Section -->
                    <div class="bg-white rounded-xl card-shadow overflow-hidden">
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path
                                            d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z">
                                        </path>
                                    </svg>
                                    เพิ่มผู้ใช้ใหม่
                                </h3>
                                <button id="toggleAddUserForm"
                                    class="bg-primary hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 transform hover:scale-105">
                                    <span id="toggleAddUserText">แสดงฟอร์ม</span>
                                </button>
                            </div>
                        </div>

                        <div id="addUserFormContainer" class="hidden p-6">
                            <form id="addUserForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Username <span
                                            class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="text" id="newUsername"
                                            class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                            placeholder="ชื่อผู้ใช้" required>
                                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-4" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"></path>
                                        </svg>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล <span
                                            class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="text" id="newFullName"
                                            class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                            placeholder="ชื่อจริง นามสกุล" required>
                                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-4" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">รหัสผ่าน <span
                                            class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="password" id="newPassword"
                                            class="w-full px-4 py-3 pl-10 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                            placeholder="รหัสผ่าน" required>
                                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-4" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <button type="button" onclick="togglePasswordVisibility('newPassword')"
                                            class="absolute right-3 top-4 text-gray-400 hover:text-gray-600">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                                <path fill-rule="evenodd"
                                                    d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">ยืนยันรหัสผ่าน <span
                                            class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="password" id="confirmPassword"
                                            class="w-full px-4 py-3 pl-10 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                            placeholder="ยืนยันรหัสผ่าน" required>
                                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-4" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <button type="button" onclick="togglePasswordVisibility('confirmPassword')"
                                            class="absolute right-3 top-4 text-gray-400 hover:text-gray-600">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                                <path fill-rule="evenodd"
                                                    d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">บทบาท <span
                                            class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <select id="newRole"
                                            class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all appearance-none bg-white"
                                            required>
                                            <option value="">เลือกบทบาท</option>
                                            <option value="Employee">👤 พนักงาน</option>
                                            <option value="Supervisor">👥 หัวหน้างาน</option>
                                            <option value="Admin">⚡ ผู้ดูแลระบบ</option>
                                        </select>
                                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-4" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <svg class="w-5 h-5 text-gray-400 absolute right-3 top-4 pointer-events-none"
                                            fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">อีเมล</label>
                                    <div class="relative">
                                        <input type="email" id="newEmail"
                                            class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                            placeholder="example@email.com">
                                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-4" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path
                                                d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z">
                                            </path>
                                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                                        </svg>
                                    </div>
                                </div>

                                <div class="md:col-span-2 flex gap-4 pt-4">
                                    <button type="submit"
                                        class="btn-primary text-white px-8 py-3 rounded-lg font-semibold flex items-center space-x-2 transition-all duration-200 transform hover:scale-105">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span>เพิ่มผู้ใช้</span>
                                    </button>
                                    <button type="button" onclick="clearAddUserForm()"
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold flex items-center space-x-2 transition-all duration-200">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span>ล้างข้อมูล</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Users List -->
                    <div class="bg-white rounded-xl card-shadow overflow-hidden">
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path
                                            d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z">
                                        </path>
                                    </svg>
                                    รายชื่อผู้ใช้งาน
                                </h3>
                                <div class="flex items-center space-x-3">
                                    <div class="relative">
                                        <input type="text" id="searchUsers" placeholder="ค้นหาผู้ใช้..."
                                            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="currentColor"
                                            viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <select id="filterRole"
                                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                        <option value="">ทุกบทบาท</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Supervisor">Supervisor</option>
                                        <option value="Employee">Employee</option>
                                    </select>
                                    <select id="filterStatus"
                                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                        <option value="">ทุกสถานะ</option>
                                        <option value="Active">ใช้งานได้</option>
                                        <option value="Inactive">ระงับการใช้งาน</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ผู้ใช้</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            บทบาท</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            อีเมล</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            สถานะ</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            วันที่สร้าง</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <div id="noUsersFound" class="hidden p-8 text-center">
                            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <p class="text-gray-500 text-lg">ไม่พบผู้ใช้ที่ตรงกับเงื่อนไขการค้นหา</p>
                        </div>
                    </div>
                </div>

                <!-- Edit User Modal -->
                <div id="editUserModal"
                    class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                        <path
                                            d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z">
                                        </path>
                                    </svg>
                                    แก้ไขข้อมูลผู้ใช้
                                </h3>
                                <button id="closeEditModal" class="text-gray-500 hover:text-gray-700 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <form id="editUserForm" class="space-y-6">
                                <input type="hidden" id="editUserId">

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-gray-700">Username</label>
                                        <input type="text" id="editUsername"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary bg-gray-100"
                                            readonly>
                                        <p class="text-xs text-gray-500">Username ไม่สามารถแก้ไขได้</p>
                                    </div>

                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล <span
                                                class="text-red-500">*</span></label>
                                        <input type="text" id="editFullName"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                            required>
                                    </div>

                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-gray-700">บทบาท <span
                                                class="text-red-500">*</span></label>
                                        <select id="editRole"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                            required>
                                            <option value="Employee">👤 พนักงาน</option>
                                            <option value="Supervisor">👥 หัวหน้างาน</option>
                                            <option value="Admin">⚡ ผู้ดูแลระบบ</option>
                                        </select>
                                    </div>

                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-gray-700">อีเมล</label>
                                        <input type="email" id="editEmail"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                    </div>
                                </div>

                                <div class="flex gap-4 pt-4">
                                    <button type="submit"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center space-x-2 transition-all">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path
                                                d="M7.707 10.293a1 1 0 10-1.414 1.414l2 2a1 1 0 001.414 0l4-4a1 1 0 00-1.414-1.414L9 11.586l-1.293-1.293z">
                                            </path>
                                        </svg>
                                        <span>บันทึกการแก้ไข</span>
                                    </button>
                                    <button type="button" id="cancelEdit"
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                                        ยกเลิก
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let kymData = [];
        let callData = [];
        let userData = [];
        let currentDashboardPeriod = 'today';

        // for test
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
            handleLogin()

        });

        // Password hashing function
        function hashPassword(password) {
            return CryptoJS.SHA256(password + 'KYM_SALT_2024').toString();
        }

        // Checklist definitions
        const checklists = {
            'มีหน้าร้าน': [
                {
                    id: 'storePhoto',
                    title: 'รูปหน้าร้านค้า',
                    description: 'เป็นรูปร้านค้าจริง รูปชัดเจน มุมกว้าง และแสดงบรรยากาศภายในร้าน ไม่ใช่รูป AI, ไม่ใช่รูปเซลฟี่',
                    score: 2,
                    required: true
                },
                {
                    id: 'productService',
                    title: 'ประเภทของสินค้าหรือบริการ',
                    description: 'ประเภทของสินค้าหรือบริการที่นำเสนอในร้านค้า',
                    score: 2,
                    required: true
                },
                {
                    id: 'storeNameCheck',
                    title: 'ชื่อร้านค้า',
                    description: 'ชื่อร้านค้าไม่มีคำหยาบ ไม่มีคำต้องห้าม',
                    score: 1,
                    required: true
                },
                {
                    id: 'businessReg',
                    title: 'ข้อมูลใบทะเบียนพาณิชย์',
                    description: 'ข้อมูลใบทะเบียนพาณิชย์ ตรงกับประเภทธุรกิจ และ ตรงกับชื่อเจ้าของ และตรงกับชื่อร้าน',
                    score: 2,
                    required: false
                },
                {
                    id: 'professionalLicense',
                    title: 'ใบประกอบวิชาชีพ',
                    description: 'มีใบประกอบวิชาชีพ ข้อมูลถูกต้อง และตรงกับข้อมูลที่ใช้สมัครร้านค้าทรูมันนี่',
                    score: 2,
                    required: true
                },
                {
                    id: 'prohibitedStore',
                    title: 'ร้านค้าต้องห้าม',
                    description: 'ร้านค้าประเภทต้องห้าม เช่น บาร์ ผับ หรือธุรกิจผิดกฎหมาย',
                    score: 0,
                    required: false,
                    important: true
                },
                {
                    id: 'repeatApplication',
                    title: 'อนุมัติแล้วลบแล้วสมัครใหม่ซ้ำๆ',
                    description: 'ร้านค้าที่เคยได้รับการอนุมัติแล้ว แต่ลบบัญชีและสมัครใหม่ซ้ำๆ',
                    score: 0,
                    required: false,
                    important: true
                }

            ],
            'ขายออนไลน์': [
                {
                    id: 'onlineStorePhoto',
                    title: 'รูปเพจหรือรูปหน้าร้านค้าออนไลน์',
                    description: 'รูปหน้าเพจร้านค้า หรือรูปหน้าร้านค้าออนไลน์จริง สอดคล้องกับสินค้าและบริการที่จำหน่าย',
                    score: 1,
                    required: true
                },
                {
                    id: 'storePhoto',
                    title: 'รูปหน้าการจัดการร้านค้า',
                    description: 'รูปหน้าการจัดการร้านค้าจริง สอดคล้องกับสินค้าและบริการที่จำหน่าย',
                    score: 1,
                    required: true
                },
                {
                    id: 'productService',
                    title: 'ประเภทของสินค้าหรือบริการ',
                    description: 'ประเภทของสินค้าหรือบริการตรงกับสินค้าและบริการที่จำหน่าย',
                    score: 2,
                    required: true
                },
                {
                    id: 'storeNameCheck',
                    title: 'ชื่อร้านค้า',
                    description: 'ชื่อร้านค้าไม่มีคำหยาบ ไม่มีคำต้องห้าม',
                    score: 1,
                    required: true
                },
                {
                    id: 'businessReg',
                    title: 'ข้อมูลใบทะเบียนพาณิชย์',
                    description: 'ข้อมูลใบทะเบียนพาณิชย์ ตรงกับประเภทธุรกิจ และ ตรงกับชื่อเจ้าของ และตรงกับชื่อร้าน',
                    score: 2,
                    required: false
                },
                {
                    id: 'professionalLicense',
                    title: 'ใบประกอบวิชาชีพ',
                    description: 'มีใบประกอบวิชาชีพ ข้อมูลถูกต้อง และตรงกับข้อมูลที่ใช้สมัครร้านค้าทรูมันนี่',
                    score: 2,
                    required: true
                },
                {
                    id: 'prohibitedStore',
                    title: 'ร้านค้าต้องห้าม',
                    description: 'ร้านค้าประเภทต้องห้าม เช่น บาร์ ผับ หรือธุรกิจผิดกฎหมาย',
                    score: 0,
                    required: false,
                    important: true
                },
                {
                    id: 'repeatApplication',
                    title: 'อนุมัติแล้วลบแล้วสมัครใหม่ซ้ำๆ',
                    description: 'ร้านค้าที่เคยได้รับการอนุมัติแล้ว แต่ลบบัญชีและสมัครใหม่ซ้ำๆ',
                    score: 0,
                    required: false,
                    important: true
                }

            ],
            'มีหน้าร้านและขายออนไลน์': [
                {
                    id: 'storePhoto',
                    title: 'รูปหน้าร้านค้า (Offline)',
                    description: 'เป็นรูปร้านค้าจริง รูปชัดเจน มุมกว้าง และแสดงบรรยากาศภายในร้าน ไม่ใช่รูป AI, ไม่ใช่รูปเซลฟี่',
                    score: 1,
                    required: true
                },
                {
                    id: 'onlineStorePhoto',
                    title: 'รูปหน้าการจัดการร้านค้า (Online)',
                    description: 'ต้องเห็นหน้าแก้ไขข้อมูลร้านค้า หรือ หน้าเพิ่มสินค้า หรือ หน้ารับคำสั่งซื้อ ที่ระบุว่าเป็นของร้านค้านี้',
                    score: 1,
                    required: true
                },
                {
                    id: 'productService',
                    title: 'ประเภทของสินค้าหรือบริการ',
                    description: 'ประเภทของสินค้าหรือบริการตรงกับสินค้าและบริการที่จำหน่าย',
                    score: 2,
                    required: true
                },
                {
                    id: 'storeNameCheck',
                    title: 'ชื่อร้านค้า',
                    description: 'ชื่อร้านค้าไม่มีคำหยาบ ไม่มีคำต้องห้าม',
                    score: 1,
                    required: true
                },
                {
                    id: 'businessReg',
                    title: 'ข้อมูลใบทะเบียนพาณิชย์',
                    description: 'ข้อมูลใบทะเบียนพาณิชย์ ตรงกับประเภทธุรกิจ และ ตรงกับชื่อเจ้าของ และตรงกับชื่อร้าน',
                    score: 2,
                    required: false
                },
                {
                    id: 'professionalLicense',
                    title: 'ใบประกอบวิชาชีพ',
                    description: 'มีใบประกอบวิชาชีพ ข้อมูลถูกต้อง และตรงกับข้อมูลที่ใช้สมัครร้านค้าทรูมันนี่',
                    score: 2,
                    required: true
                },
                {
                    id: 'prohibitedStore',
                    title: 'ร้านค้าต้องห้าม',
                    description: 'ร้านค้าประเภทต้องห้าม เช่น บาร์ ผับ หรือธุรกิจผิดกฎหมาย',
                    score: 0,
                    required: false,
                    important: true
                },
                {
                    id: 'repeatApplication',
                    title: 'อนุมัติแล้วลบแล้วสมัครใหม่ซ้ำๆ',
                    description: 'ร้านค้าที่เคยได้รับการอนุมัติแล้ว แต่ลบบัญชีและสมัครใหม่ซ้ำๆ',
                    score: 0,
                    required: false,
                    important: true
                }
            ]
        }

        // Category and Sub-category mapping
        const categoryMapping = {
            'การศึกษา': [
                'สตูดิโอ สอนเต้นรำ สอนบัลเล่ย์ สอนดนตรี',
                'โรงเรียนและบริการทางการศึกษา สถาบันกวดวิชา'
            ],
            'ช้อปปิ้ง': [
                'สินค้าเกษตร',
                'อุปกรณ์ถ่ายภาพ ไมโครฟิล์ม',
                'คอมพิวเตอร์และอุปกรณ์ต่อพ่วงคอมพิวเตอร์และซอฟต์แวร์',
                'เครื่องใช้ไฟฟ้า และอุปกรณ์ไฟฟ้า',
                'เครื่องเขียน เครื่องใช้สำนักงาน กระดาษพิมพ์และเขียน',
                'อุปกรณ์ทำสวน ดอกไม้ ต้นไม้',
                'วัสดุก่อสร้าง',
                'ร้านค้าส่ง',
                'ร้านขายของชำ โชห่วย และซูเปอร์มาร์เก็ต',
                'ร้านขายของสด หรือ เนื้อสัตว์แช่แข็ง',
                'ผลิตภัณฑ์ดูแลสุขภาพ',
                'ร้านขายสินค้าเบ็ตเตล็ด',
                'ร้านอะไหล่รถยนต์และอุปกรณ์เสริม',
                'สินค้าแม่และเด็ก',
                'ร้านรองเท้า กระเป๋า เครื่องหนัง',
                'เสื้อผ้าและเครื่องประดับ',
                'เฟอร์นิเจอร์ และของแต่งบ้าน',
                'เครื่องดนตรี และอุปกรณ์เกี่ยวกับดนตรี',
                'ร้านขายยา',
                'จักรยาน อุปกรณ์เสริม และเสื้อผ้าสำหรับปั่นจักรยาน',
                'ร้านหนังสือ',
                'ของสะสม และของเล่น',
                'ร้านกิฟต์ชอป, ร้านของชําร่วย',
                'เครื่องสำอางค์',
                'สัตว์เลี้ยง อาหารสัตว์เลี้ยง และอุปกรณ์สำหรับสัตว์เลี้ยง',
                'ของที่ระลึก กรอบรูป',
                'แว่นตาและสินค้าออฟติคอล',
                'อุปกรณ์กีฬา ชุดกีฬา อุปกรณ์ตั้งแคมป์ และอุปกรณ์เดินป่า',
                'ร้านขายเครื่องใช้ในครัวเรือน',
                'สลากกินแบ่งรัฐบาล',
                'สินค้าดิจิทัล - แอปพลิเคชัน (ไม่รวมเกม)',
                'โทรศัพท์มือถือ อุปกรณ์เสริมมือถือ',
                'ร้านค้าอิเล็กทรอนิกส์'
            ],
            'ท่องเที่ยว': [
                'รถเช่า',
                'ที่พัก – โรงแรม รีสอร์ท',
                'สถานที่ท่องเที่ยว/นิทรรศการ/งานแฟร์',
                'ตัวแทนจองโรงแรม/ที่พัก/สายการบิน/แพ็คเกจทัวร์'
            ],
            'บริการต่างๆ': [
                'จัดสวนและทำสวน',
                'สกรีนเสื้อ จาน แก้ว หมวก',
                'บริการส่งจดหมาย ส่งพัสดุ',
                'บริการจัดเลี้ยง',
                'บริการซัก อบ รีดและตัดเย็บเสื้อผ้า',
                'ร้านซ่อมรองเท้า ร้านขัดรองเท้า',
                'รับจัดงานแต่งงาน',
                'บริการเลี้ยงเด็กและดูแลที่พักอาศัย',
                'บริการเช่าชุดต่างๆ',
                'บริการต่างๆ และรับเหมาทั่วไป',
                'ถ่ายเอกสาร คัดลอกสำเนา รับพิมพ์นามบัตร และรับพิมพ์งานต่าง',
                'บริการรับทำความสะอาด',
                'บริการซ่อมคอมพิวเตอร์',
                'ช่างทำกุญแจ',
                'บริการรับจอดรถ ให้เช่าที่จอดรถ',
                'ร้านล้างรถ',
                'ร้านซ่อมเครื่องใช้ไฟฟ้า',
                'ซ่อมนาฬิกา และเครื่องประดับ',
                'รับซ่อมต่างๆ',
                'บริการสัตวแพทย์และบริการที่เกี่ยวกับสัตว์เลี้ยง',
                'บริการขนส่งผู้โดยสาร (รถยนต์ รถจักรยานยนต์ เเละเรือข้ามฝาก)',
                'ตัวแทนจำหน่ายน้ำมันเชื้อเพลิง',
                'การถ่ายภาพเชิงพาณิชย์ ศิลปะ และกราฟิก',
                'บริการโฆษณา',
                'สถานบันเทิง บาร์, ไนท์คลับ, ค็อกเทลเลานจ์และดิสโกเธคส์',
                'ซ่อมรถยนต์ ซ่อมมอร์ไซด์ รับปะยาง เปลี่ยนที่ปัดน้ำฝน',
                'ร้านขายยางและซ่อมยางรถยนต์',
                'บริการด้านกฎหมายและทนายความ'
            ],
            'บันเทิง': [
                'คาราโอเกะ',
                'วงดนตรี นักเต้น นักมายากล',
                'ลานโบว์ลิ่ง',
                'สันทนาการต่างๆ',
                'สถานที่ประกอบการบันเทิงเครื่องจักร (ตู้เพลง)'
            ],
            'สุขภาพและความงาม': [
                'ร้านเสริมสวยและร้านทำผม',
                'สถาบันเสริมความงามและศัลยกรรม',
                'สนามกีฬา สโมสรกีฬา',
                'นวดแผนไทยและสปาสุขภาพ',
                'คลินิก หรือสถานพยาบาล',
                'คลิกนิกทันตกรรม',
                'นักทัศนมาตรและจักษุแพทย์'
            ],
            'อาหารและเครื่องดื่ม': [
                'ร้านขายผลไม้',
                'ขนม ของทานเล่น',
                'เบเกอรี่ / ของหวาน / ไอศกรีม',
                'ร้านเครื่องดื่ม / คาเฟ่',
                'ร้านอาหาร',
                'อาหารจานด่วน หรือฟาสต์ฟู้ด'
            ]
        };

        // License requirement mapping
        const licenseRequiredCategories = {
            'สุขภาพและความงาม': [
                'คลินิก หรือสถานพยาบาล',
                'คลิกนิกทันตกรรม',
                'นวดแผนไทยและสปาสุขภาพ',
                'สถาบันเสริมความงามและศัลยกรรม',
                'นักทัศนมาตรและจักษุแพทย์'
            ],
            'ช้อปปิ้ง': [
                'ร้านขายยา'
            ],
            'บริการต่างๆ': [
                'บริการสัตวแพทย์และบริการที่เกี่ยวกับสัตว์เลี้ยง'
            ]
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
            updateDateTime();
            setInterval(updateDateTime, 1000); // Update every second
            moment.locale('th');
        });

        function updateDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Bangkok'
            };
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = now.toLocaleDateString('th-TH', options);
            }
        }

        function initializeApp() {
            // Set up event listeners
            setupEventListeners();

            // Check for notifications
            checkNotifications();

            // Set up periodic checks
            setInterval(checkNotifications, 60000); // Check every minute
        }

        // Load data from server
        function loadAllDataFromServer() {
            Swal.fire({
                icon: 'info',
                title: 'กำลังโหลดข้อมูล...',
                allowOutsideClick: false,
                customClass: {
                    popup: 'rounded-2xl'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            });


            Promise.all([
                // getUsersData(),
                getKymData(),
                // getCallData()
            ]).then(() => {
                Swal.close();
            }).catch((error) => {
                console.error('Load data error:', error);
                Swal.fire({
                    icon: 'warning',
                    title: 'แจ้งเตือน',
                    text: 'โหลดข้อมูลจากเซิร์ฟเวอร์ไม่สำเร็จ กำลังใช้ข้อมูลจาก Cache',
                    timer: 3000,
                    allowOutsideClick: false,
                    confirmButtonColor: '#FF6B35',
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
                // loadAllData();
            })
        }

        function getUsersData() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function (result) {
                        result = JSON.parse(result);
                        console.log(result);
                        if (result.success) {
                            userData = result.data || [];
                            resolve();
                        } else {
                            Swal.fire({
                                icon: 'warning',
                                title: 'แจ้งเตือน',
                                text: 'โหลดข้อมูลผู้ใช้ไม่สำเร็จ: ' + result.error,
                                allowOutsideClick: false,
                                confirmButtonColor: '#FF6B35',
                                customClass: {
                                    popup: 'rounded-2xl'
                                }
                            });
                            reject(new Error('โหลดข้อมูลผู้ใช้ไม่สำเร็จ: ' + result.error));
                        }
                    })
                    .withFailureHandler(function (error) {
                        console.error('Load users error:', error);
                        reject(error);
                    })
                    .getAllUsers(currentUser.role);
            });

        }

        function getKymData() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function (result) {
                        result = JSON.parse(result);
                        if (result.success) {
                            kymData = result.data || [];
                            resolve();
                        } else {
                            Swal.fire({
                                icon: 'warning',
                                title: 'แจ้งเตือน',
                                text: 'โหลดข้อมูล KYM ไม่สำเร็จ: ' + result.error,
                                allowOutsideClick: false,
                                confirmButtonColor: '#FF6B35',
                                customClass: {
                                    popup: 'rounded-2xl'
                                }
                            });
                            reject(new Error('โหลดข้อมูล KYM ไม่สำเร็จ: ' + result.error));
                        }
                    })
                    .withFailureHandler(function (error) {
                        console.error('Load KYM error:', error);
                        reject(error);
                    })
                    .getKYMRecords();
            });

        }

        function getCallData() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function (result) {
                        result = JSON.parse(result);
                        if (result.success) {
                            callData = result.data || [];
                            console.log('Call Data:', callData);
                            resolve();
                        } else {
                            Swal.fire({
                                icon: 'warning',
                                title: 'แจ้งเตือน',
                                text: 'โหลดข้อมูลการโทรไม่สำเร็จ: ' + result.error,
                                allowOutsideClick: false,
                                confirmButtonColor: '#FF6B35',
                                customClass: {
                                    popup: 'rounded-2xl'
                                }
                            });
                            reject(new Error('โหลดข้อมูลการโทรไม่สำเร็จ: ' + result.error));
                        }
                    })
                    .withFailureHandler(function (error) {
                        console.error('Load call data error:', error);
                        reject(error);
                    })
                    .getCallLogs();
            });

        }

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });

            // Forms
            document.getElementById('kymForm').addEventListener('submit', handleKymSubmit);
            document.getElementById('clearKymForm').addEventListener('click', clearKymForm);
            document.getElementById('callForm').addEventListener('submit', handleCallSubmit);
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('editUserForm').addEventListener('submit', handleEditUser);

            // User Management
            document.getElementById('toggleAddUserForm').addEventListener('click', toggleAddUserForm);
            document.getElementById('closeEditModal').addEventListener('click', closeEditUserModal);
            document.getElementById('cancelEdit').addEventListener('click', closeEditUserModal);
            document.getElementById('searchUsers').addEventListener('input', filterUsers);
            document.getElementById('filterRole').addEventListener('change', filterUsers);
            document.getElementById('filterStatus').addEventListener('change', filterUsers);

            // Dashboard period buttons
            document.getElementById('dashToday').addEventListener('click', () => updateDashboardPeriod('today'));
            document.getElementById('dashYesterday').addEventListener('click', () => updateDashboardPeriod('yesterday'));
            document.getElementById('dash7Days').addEventListener('click', () => updateDashboardPeriod('7days'));
            document.getElementById('dash30Days').addEventListener('click', () => updateDashboardPeriod('30days'));
            document.getElementById('dashCustom').addEventListener('click', () => toggleDashboardCustomRange());
            document.getElementById('updateDashboard').addEventListener('click', updateDashboardCustom);
            document.getElementById('sortBy').addEventListener('change', loadPerformanceTable);

            // Report buttons
            document.getElementById('todayReport').addEventListener('click', () => generateQuickReport('today'));
            document.getElementById('last7DaysReport').addEventListener('click', () => generateQuickReport('7days'));
            document.getElementById('last30DaysReport').addEventListener('click', () => generateQuickReport('30days'));
            document.getElementById('customRangeBtn').addEventListener('click', toggleCustomDateRange);
            document.getElementById('generateCustomReport').addEventListener('click', generateCustomReport);

            // Dynamic form changes
            document.getElementById('caseStatus').addEventListener('change', toggleFollowUpSection);
            document.getElementById('category').addEventListener('change', updateSubCategories);
            document.getElementById('subCategory').addEventListener('change', checkLicenseRequirement);
            document.getElementById('callReason').addEventListener('change', toggleOtherReasonSection);
            document.getElementById('callResult').addEventListener('change', toggleRescheduleSection);
            document.getElementById('clearCallForm').addEventListener('click', clearCallForm);
            document.getElementById('closeCaseModal').addEventListener('click', closeCaseDetailModal);
            document.getElementById('closeFollowUpModal').addEventListener('click', closeFollowUpModal);
            document.getElementById('cancelFollowUp').addEventListener('click', closeFollowUpModal);
            document.getElementById('followUpForm').addEventListener('submit', handleFollowUpSubmit);
            document.getElementById('followUpCallResult').addEventListener('change', toggleFollowUpSections);
            document.getElementById('followUpCaseStatus').addEventListener('change', toggleFollowUpNextCallSection);

            // Checklist definitions
            document.getElementById('salesChannel').addEventListener('change', renderAssessmentSection);
        }

        function handleLogin(e) {
            e?.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            // const hashedPassword = hashPassword(password);

            // Show loading
            Swal.fire({
                icon: 'info',
                title: 'กำลังเข้าสู่ระบบ...',
                allowOutsideClick: false,
                customClass: {
                    popup: 'rounded-2xl'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // เรียกใช้ผ่าน google.script.run
            google.script.run
                .withSuccessHandler(function (result) {
                    Swal.close()
                    result = JSON.parse(result); // Parse the JSON string
                    console.log("🚀 ~ handleLogin ~ result:", result)
                    if (result.success) {
                        currentUser = result.user;
                        document.getElementById('userInfo').textContent = `${currentUser.name} (${currentUser.role})`;

                        // Show appropriate buttons based on role
                        if (currentUser.role === 'Supervisor' || currentUser.role === 'Admin') {
                            document.getElementById('dashboardBtn').classList.remove('hidden');
                        }
                        if (currentUser.role === 'Admin') {
                            document.getElementById('userManagementBtn').classList.remove('hidden');
                        }

                        // Switch to main app
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');

                        // Load data from server
                        loadAllDataFromServer();

                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'เข้าสู่ระบบไม่สำเร็จ',
                            text: result.error || 'กรุณาตรวจสอบ Username และ Password',
                            allowOutsideClick: false,
                            confirmButtonColor: '#FF6B35',
                            customClass: {
                                popup: 'rounded-2xl'
                            }
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Login error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error.message,
                        allowOutsideClick: false,
                        confirmButtonColor: '#FF6B35',
                        customClass: {
                            popup: 'rounded-2xl'
                        }
                    });
                })
                .authenticateUser(username, password);
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('dashboardBtn').classList.add('hidden');
            document.getElementById('userManagementBtn').classList.add('hidden');

            // Reset forms
            document.getElementById('loginForm').reset();
            document.getElementById('kymForm').reset();
            document.getElementById('callForm').reset();
        }

        async function handleAddUser(e) {
            e.preventDefault();

            const username = document.getElementById('newUsername').value;
            const fullName = document.getElementById('newFullName').value;
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const role = document.getElementById('newRole').value;
            const email = document.getElementById('newEmail').value;

            if (password !== confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'รหัสผ่านไม่ตรงกัน',
                    text: 'กรุณาตรวจสอบรหัสผ่านและยืนยันรหัสผ่านให้ตรงกัน',
                    allowOutsideClick: false,
                    confirmButtonColor: '#FF6B35',
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
                return;
            }

            Swal.fire({
                icon: 'info',
                title: 'กำลังบันทึก...',
                allowOutsideClick: false,
                customClass: {
                    popup: 'rounded-2xl'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            const checkUserName = await new Promise((resolve) => {
                google.script.run
                    .withSuccessHandler(function (result) {
                        result = JSON.parse(result);
                        resolve(result);
                    })
                    .withFailureHandler(function (error) {
                        console.error('Check username error:', error);
                        resolve({ success: false, error: 'ไม่สามารถตรวจสอบ Username ได้' });
                    })
                    .checkUsernameExists(username);
            });
            if (!checkUserName.success) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: checkUserName.error,
                    allowOutsideClick: false,
                    confirmButtonColor: '#FF6B35',
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
                return;
            }
            if (checkUserName.success && checkUserName.exists) {
                Swal.fire({
                    icon: 'error',
                    title: 'Username ซ้ำ',
                    text: 'Username นี้มีอยู่ในระบบแล้ว กรุณาเลือก Username อื่น',
                    allowOutsideClick: false,
                    confirmButtonColor: '#FF6B35',
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
                return;
            }

            const newUser = {
                id: Date.now(),
                username: username,
                password: password,
                name: fullName,
                role: role,
                email: email,
                status: 'Active',
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username
            };

            google.script.run
                .withSuccessHandler(function (result) {
                    result = JSON.parse(result);
                    if (result.success) {
                        loadUsersTable();
                        updateUserStats();
                        document.getElementById('addUserForm').reset();
                        toggleAddUserForm();

                        Swal.fire({
                            icon: 'success',
                            title: 'เพิ่มผู้ใช้สำเร็จ',
                            text: 'กำลังดึงรายการผู้ใช้ใหม่...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            },
                            customClass: {
                                popup: 'rounded-2xl'
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: result.error,
                            allowOutsideClick: false,
                            confirmButtonColor: '#FF6B35',
                            customClass: {
                                popup: 'rounded-2xl'
                            }
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Add user error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถเพิ่มผู้ใช้ได้: ' + error.message,
                        allowOutsideClick: false,
                        confirmButtonColor: '#FF6B35',
                        customClass: {
                            popup: 'rounded-2xl'
                        }
                    });
                })
                .addUser(newUser);
        }

        async function loadUsersTable(filteredUsers = null) {
            if (!Swal.isVisible()) {
                Swal.fire({
                    icon: 'info',
                    title: 'กำลังโหลดข้อมูลผู้ใช้...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                })
            }
            const tbody = document.getElementById('usersTableBody');
            const noUsersFound = document.getElementById('noUsersFound');
            tbody.innerHTML = '';
            await getUsersData();
            Swal.close();
            const usersToShow = filteredUsers || userData;

            // Update stats
            updateUserStats();

            if (usersToShow.length === 0) {
                tbody.innerHTML = '';
                noUsersFound.classList.remove('hidden');
                return;
            }

            noUsersFound.classList.add('hidden');

            tbody.innerHTML = usersToShow.map(user => {
                const isCurrentUser = currentUser && currentUser.username === user.username;
                const canDelete = !isCurrentUser && user.role !== 'Admin';

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full ${user.role === 'Admin' ? 'bg-red-100' :
                        user.role === 'Supervisor' ? 'bg-blue-100' : 'bg-green-100'
                    } flex items-center justify-center">
                                        <span class="text-sm font-medium ${user.role === 'Admin' ? 'text-red-800' :
                        user.role === 'Supervisor' ? 'text-blue-800' : 'text-green-800'
                    }">
                                            ${user.name.charAt(0).toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900 flex items-center">
                                        ${user.name}
                                        ${isCurrentUser ? '<span class="ml-2 px-2 py-1 text-xs bg-primary text-white rounded-full">คุณ</span>' : ''}
                                    </div>
                                    <div class="text-sm text-gray-500">@${user.username}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${user.role === 'Admin' ? 'bg-red-100 text-red-800' :
                        user.role === 'Supervisor' ? 'bg-blue-100 text-blue-800' :
                            'bg-green-100 text-green-800'
                    }">
                                ${user.role === 'Admin' ? '⚡ Admin' :
                        user.role === 'Supervisor' ? '👥 Supervisor' : '👤 Employee'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            ${user.email || '<span class="text-gray-400 italic">ไม่ระบุ</span>'}
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }">
                                <span class="w-2 h-2 mr-2 rounded-full ${user.status === 'Active' ? 'bg-green-400' : 'bg-red-400'
                    }"></span>
                                ${user.status === 'Active' ? 'ใช้งานได้' : 'ระงับการใช้งาน'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            ${new Date(user.createdAt).toLocaleDateString('th-TH')}
                        </td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-900 transition-colors">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                    </svg>
                                </button>
                                <button onclick="toggleUserStatus(${user.id})" class="text-yellow-600 hover:text-yellow-900 transition-colors" title="${user.status === 'Active' ? 'ระงับการใช้งาน' : 'เปิดใช้งาน'}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        ${user.status === 'Active' ?
                        '<path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"></path>' :
                        '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>'
                    }
                                    </svg>
                                </button>
                                ${canDelete ? `
                                    <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-900 transition-colors">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"></path>
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateUserStats() {
            document.getElementById('totalUsers').textContent = userData.length;
            document.getElementById('adminCount').textContent = userData.filter(u => u.role === 'Admin').length;
            document.getElementById('supervisorCount').textContent = userData.filter(u => u.role === 'Supervisor').length;
            document.getElementById('employeeCount').textContent = userData.filter(u => u.role === 'Employee').length;
            document.getElementById('inactiveCount').textContent = userData.filter(u => u.status === 'Inactive').length;
        }

        function toggleAddUserForm() {
            const container = document.getElementById('addUserFormContainer');
            const button = document.getElementById('toggleAddUserForm');
            const text = document.getElementById('toggleAddUserText');

            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                text.textContent = 'ซ่อนฟอร์ม';
                button.classList.remove('bg-primary', 'hover:bg-orange-600');
                button.classList.add('bg-gray-500', 'hover:bg-gray-600');
            } else {
                container.classList.add('hidden');
                text.textContent = 'แสดงฟอร์ม';
                button.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                button.classList.add('bg-primary', 'hover:bg-orange-600');
            }
        }

        function clearAddUserForm() {
            document.getElementById('addUserForm').reset();
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value;
            const statusFilter = document.getElementById('filterStatus').value;

            const filteredUsers = userData.filter(user => {
                const matchesSearch = user.name.toLowerCase().includes(searchTerm) ||
                    user.username.toLowerCase().includes(searchTerm) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm));
                const matchesRole = !roleFilter || user.role === roleFilter;
                const matchesStatus = !statusFilter || user.status === statusFilter;

                return matchesSearch && matchesRole && matchesStatus;
            });

            loadUsersTable(filteredUsers);
        }

        function editUser(userId) {
            const user = userData.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editFullName').value = user.name;
            document.getElementById('editRole').value = user.role;
            document.getElementById('editEmail').value = user.email || '';

            document.getElementById('editUserModal').classList.remove('hidden');
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            document.getElementById('editUserForm').reset();
        }

        function handleEditUser(e) {
            e.preventDefault();

            const userId = parseInt(document.getElementById('editUserId').value);
            const fullName = document.getElementById('editFullName').value;
            const role = document.getElementById('editRole').value;
            const email = document.getElementById('editEmail').value;

            const userIndex = userData.findIndex(u => u.id === userId);
            if (userIndex === -1) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่พบผู้ใช้',
                    text: 'ไม่พบข้อมูลผู้ใช้ที่ต้องการแก้ไข',
                    allowOutsideClick: false
                });
                return;
            }

            const updatedUser = {
                id: userId,
                name: fullName,
                role: role,
                email: email,
                status: userData[userIndex].status
            };

            Swal.fire({
                icon: 'info',
                title: 'กำลังบันทึก...',
                allowOutsideClick: false,
                customClass: {
                    popup: 'rounded-2xl'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            google.script.run
                .withSuccessHandler(function (result) {
                    result = JSON.parse(result);
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'แก้ไขข้อมูลสำเร็จ',
                            text: 'กำลังดึงรายการผู้ใช้ใหม่...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            },
                            customClass: {
                                popup: 'rounded-2xl'
                            }
                        });
                        loadUsersTable();
                        closeEditUserModal();

                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: result.error,
                            allowOutsideClick: false,
                            confirmButtonColor: '#FF6B35',
                            customClass: {
                                popup: 'rounded-2xl'
                            }
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Update user error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถแก้ไขข้อมูลผู้ใช้ได้: ' + error.message,
                        allowOutsideClick: false,
                        confirmButtonColor: '#FF6B35',
                        customClass: {
                            popup: 'rounded-2xl'
                        }
                    });
                })
                .updateUser(updatedUser);
        }

        function toggleUserStatus(userId) {
            const user = userData.find(u => u.id === userId);
            if (!user) return;

            const newStatus = user.status === 'Active' ? 'Inactive' : 'Active';
            const action = newStatus === 'Active' ? 'เปิดใช้งาน' : 'ระงับการใช้งาน';

            Swal.fire({
                title: `ยืนยัน${action}`,
                text: `คุณต้องการ${action}ผู้ใช้ ${user.name} หรือไม่?`,
                icon: 'warning',
                allowOutsideClick: false,
                showCancelButton: true,
                confirmButtonColor: '#FF6B35',
                cancelButtonColor: '#6B7280',
                confirmButtonText: `ใช่, ${action}`,
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-2xl'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        icon: 'info',
                        title: 'กำลังบันทึก...',
                        allowOutsideClick: false,
                        customClass: {
                            popup: 'rounded-2xl'
                        },
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    google.script.run
                        .withSuccessHandler(function (result) {
                            result = JSON.parse(result);
                            if (result.success) {
                                // อัพเดท Local Data
                                user.status = newStatus;
                                user.updatedAt = new Date().toISOString();
                                user.updatedBy = currentUser.username;


                                Swal.fire({
                                    icon: 'success',
                                    title: `${action}สำเร็จ`,
                                    text: 'กำลังดึงรายการผู้ใช้ใหม่...',
                                    allowOutsideClick: false,
                                    didOpen: () => {
                                        Swal.showLoading();
                                    },
                                    customClass: {
                                        popup: 'rounded-2xl'
                                    }
                                });
                                loadUsersTable();
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'เกิดข้อผิดพลาด',
                                    text: result.error,
                                    allowOutsideClick: false,
                                    confirmButtonColor: '#FF6B35',
                                    customClass: {
                                        popup: 'rounded-2xl'
                                    }
                                });
                            }
                        })
                        .withFailureHandler(function (error) {
                            console.error('Toggle status error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: 'ไม่สามารถเปลี่ยนสถานะได้: ' + error.message,
                                allowOutsideClick: false,
                                confirmButtonColor: '#FF6B35',
                                customClass: {
                                    popup: 'rounded-2xl'
                                }
                            });
                        })
                        .toggleUserStatus(userId);
                }
            });
        }

        function deleteUser(userId) {
            const user = userData.find(u => u.id === userId);
            if (!user) return;

            Swal.fire({
                title: 'ยืนยันการลบ',
                text: `คุณต้องการลบผู้ใช้ ${user.name} หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้`,
                icon: 'warning',
                allowOutsideClick: false,
                showCancelButton: true,
                confirmButtonColor: '#FF6B35',
                cancelButtonColor: '#6B7280',
                confirmButtonText: 'ใช่, ลบเลย',
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-2xl'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        icon: 'info',
                        title: 'กำลังลบ...',
                        allowOutsideClick: false,
                        customClass: {
                            popup: 'rounded-2xl'
                        },
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    google.script.run
                        .withSuccessHandler(function (result) {
                            result = JSON.parse(result);
                            if (result.success) {
                                // ลบจาก Local Data
                                const userIndex = userData.findIndex(u => u.id === userId);
                                userData.splice(userIndex, 1);

                                loadUsersTable();

                                Swal.fire({
                                    icon: 'success',
                                    title: 'ลบสำเร็จ',
                                    text: `ลบผู้ใช้ ${user.name} เรียบร้อยแล้ว`,
                                    allowOutsideClick: false,
                                    showConfirmButton: false,
                                    confirmButtonColor: '#FF6B35',
                                    customClass: {
                                        popup: 'rounded-2xl'
                                    }
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'เกิดข้อผิดพลาด',
                                    text: result.error,
                                    allowOutsideClick: false,
                                    confirmButtonColor: '#FF6B35',
                                    customClass: {
                                        popup: 'rounded-2xl'
                                    }
                                });
                            }
                        })
                        .withFailureHandler(function (error) {
                            console.error('Delete user error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: 'ไม่สามารถลบผู้ใช้ได้: ' + error.message,
                                allowOutsideClick: false,
                                confirmButtonColor: '#FF6B35',
                                customClass: {
                                    popup: 'rounded-2xl'
                                }
                            });
                        })
                        .deleteUser(userId);
                }
            });
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
        }

        // Additional missing functions

        function switchTab(tabName) {
            console.log(`Switching to tab: ${tabName}`);
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('border-primary', 'text-primary', 'border-b-2');
                btn.classList.add('text-gray-600');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');

            // Add active class to selected nav button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('border-primary', 'text-primary', 'border-b-2');
            activeBtn.classList.remove('text-gray-600');

            // Load data for specific tabs
            if (tabName === 'users' && currentUser && currentUser.role === 'Admin') {
                loadUsersTable();
            } else if (tabName === 'dashboard' && currentUser && (currentUser.role === 'Supervisor' || currentUser.role === 'Admin')) {
                updateDashboard();
            } else if (tabName === 'calls') {
                loadPendingCases();
                let datePicker = document.getElementById('retryCallDate');
                if (datePicker._flatpickr) {
                    datePicker._flatpickr.setDate(new Date(), true)
                } else {
                    datePicker.flatpickr({
                        locale: 'th',
                        dateFormat: "Y-m-d",
                        altFormat: "j F Y",
                        altInput: true,
                        minDate: "today",
                        defaultDate: new Date()
                    });
                }
            } else if (tabName === 'reports') {
                // Auto-load today's report when switching to reports tab
                generateQuickReport('today');
            }
        }

        function checkNotifications() {
            // Check for pending cases that need attention
            const pendingCases = callData.filter(call => call.caseStatus === 'Pending');
            const overdueCases = pendingCases.filter(call => {
                if (call.followUpDate) {
                    return new Date(call.followUpDate) < new Date();
                }
                return false;
            });

            if (overdueCases.length > 0) {
                console.log(`${overdueCases.length} overdue cases found`);
            }
        }

        async function loadPendingCases() {
            if (!Swal.isVisible()) {
                Swal.fire({
                    icon: 'info',
                    title: 'กำลังโหลดข้อมูลเคส Pending',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                })
            }
            await getCallData();
            Swal.close();
            const pendingCases = callData.filter(call => call.caseStatus === 'Pending');
            const container = document.getElementById('pendingCases');

            if (pendingCases.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <p class="text-gray-500">ไม่มีเคส Pending</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = pendingCases.map(call => {
                const isOverdue = call.followUpDate && new Date(call.followUpDate) < new Date();
                const activities = call.activities || [];
                const totalCalls = activities.length + 1; // +1 for original call

                return `
                    <div class="border rounded-lg p-4 ${isOverdue ? 'border-red-300 bg-red-50' : 'border-gray-200'} hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-800">${call.truemoneyId}</h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">โทร ${totalCalls} ครั้ง</span>
                                ${isOverdue ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded-full">เกิน SLA</span>' : ''}
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">${call.storeName || 'ไม่ระบุชื่อร้าน'}</p>
                        <p class="text-sm text-gray-500 mb-2">${call.contactName || 'ไม่ระบุชื่อผู้ติดต่อ'}</p>
                        <p class="text-sm text-gray-500 mb-3">${call.callReason}</p>
                        
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-gray-400">
                                ${new Date(call.timestamp).toLocaleDateString('th-TH')} โดย ${call.operator}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="showCaseDetail('${call.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-medium flex items-center space-x-1">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ดูรายละเอียด</span>
                                </button>
                                <button onclick="addFollowUpCall('${call.id}')" class="bg-primary hover:bg-orange-600 text-white text-xs px-3 py-1 rounded-lg font-medium flex items-center space-x-1 transition">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                                    </svg>
                                    <span>โทรติดตาม</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCaseDetail(caseId) {
            const call = callData.find(c => c.id == caseId);
            if (!call) return;

            const activities = call.activities || [];
            const modal = document.getElementById('caseDetailModal');
            const content = document.getElementById('caseDetailContent');

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Case Header -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-xl font-bold text-gray-800">เคส: ${call.truemoneyId}</h4>
                                <p class="text-gray-700 font-medium">${call.storeName || 'ไม่ระบุชื่อร้าน'}</p>
                                <p class="text-gray-600">${call.contactName || 'ไม่ระบุชื่อผู้ติดต่อ'}</p>
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${call.caseStatus === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'
                }">
                                    ${call.caseStatus === 'Pending' ? '🔄 รอดำเนินการ' : '✅ ปิดเคส'}
                                </span>
                                <div class="text-sm text-gray-500 mt-1">
                                    โทรทั้งหมด ${activities.length + 1} ครั้ง
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-700">เบอร์ติดต่อ:</span>
                                <span class="text-gray-600">${call.contactNumber || 'ไม่ระบุ'}</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">เหตุผลหลัก:</span>
                                <span class="text-gray-600">${call.callReason}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Call History Timeline -->
                    <div>
                        <h5 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                            ประวัติการโทร
                        </h5>
                        
                        <div class="space-y-4">
                            <!-- Original Call -->
                            <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-lg border-l-4 border-blue-500">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">1</div>
                                </div>
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start mb-2">
                                        <h6 class="font-semibold text-gray-800">การโทรครั้งแรก</h6>
                                        <span class="text-xs text-gray-500">
                                            ${new Date(call.timestamp).toLocaleString('th-TH')}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <p><span class="font-medium">ผลการโทร:</span> ${call.callResult}</p>
                                        <p><span class="font-medium">รายละเอียด:</span> ${call.callDetails}</p>
                                        <p><span class="font-medium">ผู้ดำเนินการ:</span> ${call.operatorName}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Follow-up Activities -->
                            ${activities.map((activity, index) => `
                                <div class="flex items-start space-x-4 p-4 bg-white rounded-lg border-l-4 border-orange-500 shadow-sm">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-white text-sm font-bold">${index + 2}</div>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="flex justify-between items-start mb-2">
                                            <h6 class="font-semibold text-gray-800">การโทรติดตาม</h6>
                                            <span class="text-xs text-gray-500">${new Date(activity.timestamp).toLocaleString('th-TH')}</span>
                                        </div>
                                        <div class="text-sm text-gray-600 space-y-1">
                                            <p><span class="font-medium">ผลการโทร:</span> ${activity.callResult}</p>
                                            <p><span class="font-medium">รายละเอียด:</span> ${activity.callDetails}</p>
                                            <p><span class="font-medium">ผู้ดำเนินการ:</span> ${activity.operatorName}</p>
                                            ${activity.rescheduleDateTime ? `<p><span class="font-medium">นัดหมายใหม่:</span> ${new Date(activity.rescheduleDateTime).toLocaleString('th-TH')}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Next Follow-up -->
                    ${call.followUpDate ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-medium text-yellow-800">การติดตามครั้งต่อไป: ${moment(call.followUpDate).format('LL')} <span class="text-gray-500 font-small">(${moment(call.followUpDate).fromNow()})</span></span>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Action Buttons -->
                    ${call.caseStatus === 'Pending' ? `
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button onclick="addFollowUpCall('${call.id}')" class="bg-primary hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-medium flex items-center space-x-2 transition">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                                </svg>
                                <span>เพิ่มการโทรติดตาม</span>
                            </button>
                            <button onclick="closeCaseFromDetail('${call.id}')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium flex items-center space-x-2 transition">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span>ปิดเคส</span>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            modal.classList.remove('hidden');
        }

        function addFollowUpCall(caseId) {
            const call = callData.find(c => c.id == caseId);
            console.log(call)
            if (!call) return;

            // Set case ID for follow-up
            document.getElementById('followUpCaseId').value = caseId;

            // Display case information
            const caseInfo = document.getElementById('followUpCaseInfo');
            caseInfo.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-bold text-blue-800">ข้อมูลเคส</h4>
                    <span class="text-sm text-blue-600">เคสที่ ${(call.activities?.length || 0) + 1}</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-blue-700">หมายเลขทรูมันนี่:</span>
                        <span class="text-blue-900 ml-2">${call.truemoneyId}</span>
                    </div>
                    <div>
                        <span class="font-medium text-blue-700">ชื่อร้านค้า:</span>
                        <span class="text-blue-900 ml-2">${call.storeName || 'ไม่ระบุ'}</span>
                    </div>
                    <div>
                        <span class="font-medium text-blue-700">ชื่อผู้ติดต่อ:</span>
                        <span class="text-blue-900 ml-2">${call.contactName || 'ไม่ระบุ'}</span>
                    </div>
                    <div>
                        <span class="font-medium text-blue-700">เหตุผลหลัก:</span>
                        <span class="text-blue-900 ml-2">${call.callReason}</span>
                    </div>
                </div>
            `;



            // Reset form
            document.getElementById('followUpForm').reset();
            document.getElementById('followUpCaseId').value = caseId;

            // Hide conditional sections
            document.getElementById('followUpRescheduleSection').classList.add('hidden');
            document.getElementById('followUpRetrySection').classList.add('hidden');
            document.getElementById('followUpNextCallSection').classList.add('hidden');

            // Close case detail modal if open
            closeCaseDetailModal();

            // Show follow-up modal
            document.getElementById('followUpModal').classList.remove('hidden');
            let reScheduleDateTimePicker = document.getElementById('followUpRescheduleDateTime');
            let retryDatePicker = document.getElementById('followUpRetryCallDate');
            if (reScheduleDateTimePicker._flatpickr) {
                reScheduleDateTimePicker._flatpickr.clear();
            } else {
                reScheduleDateTimePicker.flatpickr({
                    locale: 'th',
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    altFormat: "j F Y H:i",
                    altInput: true,
                    allowInput: true,
                    minDate: "today",
                    minuteIncrement: 15
                });
            }
            if (retryDatePicker._flatpickr) {
                retryDatePicker._flatpickr.clear()
            } else {
                retryDatePicker.flatpickr({
                    locale: 'th',
                    dateFormat: "Y-m-d",
                    altFormat: "j F Y",
                    altInput: true,
                    allowInput: true,
                    minDate: "today",
                });
            }
        }

        function closeCaseFromDetail(caseId) {
            Swal.fire({
                title: 'ยืนยันการปิดเคส',
                text: 'คุณต้องการปิดเคสนี้หรือไม่?',
                icon: 'question',
                allowOutsideClick: false,
                showCancelButton: true,
                confirmButtonColor: '#FF6B35',
                cancelButtonColor: '#6B7280',
                confirmButtonText: 'ใช่, ปิดเคส',
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-2xl'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const callIndex = callData.findIndex(c => c.id == caseId);
                    if (callIndex !== -1) {
                        let existingCall = callData[callIndex];
                        const activity = {
                            id: Date.now(),
                            callResult: "ปิดเคส",
                            callDetails: document.getElementById('followUpCallDetails').value,
                            rescheduleDateTime: document.getElementById('followUpRescheduleDateTime').value,
                            retryCallDate: "",
                            retryTimeSlot: document.getElementById('followUpRetryTimeSlot').value,
                            operator: currentUser.username,
                            operatorName: currentUser.name,
                            timestamp: new Date().toISOString()
                        };
                        existingCall.activities = existingCall.activities || [];
                        existingCall.activities.push(activity);
                        existingCall.caseStatus = "Closed";
                        existingCall.closedAt = moment().format('DD/MM/YYYY, HH:mm:ss');
                        existingCall.lastOperator = currentUser.username;
                        existingCall.lastActivity = activity.timestamp;
                        existingCall.lastOperator = activity.operatorName;

                        Swal.fire({
                            icon: 'info',
                            title: 'กำลังบันทึก...',
                            allowOutsideClick: false,
                            customClass: {
                                popup: 'rounded-2xl'
                            },
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                        console.log('Submitting follow-up for case ID:', caseId, existingCall);

                        google.script.run
                            .withSuccessHandler(async function (result) {
                                result = JSON.parse(result);
                                if (result.success) {
                                    closeCaseDetailModal();
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'บันทึกการโทรติดตามสำเร็จ',
                                        text: `กำลังโหลดข้อมูลใหม่...`,
                                        allowOutsideClick: false,
                                        didOpen: () => {
                                            Swal.showLoading();
                                        },
                                        customClass: {
                                            popup: 'rounded-2xl'
                                        }
                                    });
                                    await loadPendingCases();
                                    Swal.close()
                                    if (currentUser && (currentUser.role === 'Supervisor' || currentUser.role === 'Admin')) {
                                        updateDashboard();
                                    }

                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'เกิดข้อผิดพลาด',
                                        text: result.error,
                                        allowOutsideClick: false,
                                        confirmButtonColor: '#FF6B35',
                                        customClass: {
                                            popup: 'rounded-2xl'
                                        }
                                    });
                                }
                            })
                            .withFailureHandler(function (error) {
                                console.error('Follow-up submit error:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'เกิดข้อผิดพลาด',
                                    text: 'ไม่สามารถบันทึกการโทรติดตามได้: ' + error.message,
                                    allowOutsideClick: false,
                                    confirmButtonColor: '#FF6B35',
                                    customClass: {
                                        popup: 'rounded-2xl'
                                    }
                                });
                            })
                            .updateCallLog(existingCall);
                    }
                }
            });
        }

        function updateDashboard() {
            if (!currentUser || (currentUser.role !== 'Supervisor' && currentUser.role !== 'Admin')) {
                return;
            }

            // Get current period dates
            const { startDate, endDate } = getDashboardPeriodDates(currentDashboardPeriod);

            // Filter data by current period
            const filteredKymData = kymData.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate >= startDate && recordDate <= endDate;
            });

            const filteredCallData = callData.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate >= startDate && recordDate <= endDate;
            });

            // Update summary cards
            updateDashboardSummary(filteredKymData, filteredCallData);

            // Update performance table
            updatePerformanceTable(filteredKymData, filteredCallData);

            // Update top performers
            updateTopPerformers(filteredKymData, filteredCallData);

            // Update KYM status chart
            updateKymStatusChart(filteredKymData);

            // Update alerts
            updateAlertsSection();
        }

        function getDashboardPeriodDates(period) {
            const now = new Date();
            let startDate, endDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'yesterday':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case '7days':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    endDate = now;
                    break;
                case '30days':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    endDate = now;
                    break;
                case 'custom':
                    const startDateStr = document.getElementById('dashStartDate').value;
                    const endDateStr = document.getElementById('dashEndDate').value;
                    if (startDateStr && endDateStr) {
                        startDate = new Date(startDateStr);
                        endDate = new Date(endDateStr + 'T23:59:59');
                    } else {
                        // Default to today if custom dates not set
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    }
                    break;
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            }

            return { startDate, endDate };
        }

        function updateDashboardSummary(kymData, callData) {
            // KYM Statistics
            const totalKym = kymData.length;
            const approvedKym = kymData.filter(r => r.status === 'Approved').length;

            // Call Statistics
            const totalCalls = callData.length;
            const contactedCalls = callData.filter(r => r.callResult === 'ติดต่อได้').length;
            const pendingCases = callData.filter(r => r.caseStatus === 'Pending').length;

            // Calculate success rate
            const successRate = totalCalls > 0 ? Math.round((contactedCalls / totalCalls) * 100) : 0;

            // Update DOM elements
            document.getElementById('totalKym').textContent = totalKym;
            document.getElementById('totalCalls').textContent = totalCalls;
            document.getElementById('pendingCount').textContent = pendingCases;
            document.getElementById('successRate').textContent = successRate + '%';

            // Calculate growth (simplified - comparing with previous period)
            // For demo purposes, showing static growth indicators
            document.getElementById('kymGrowth').textContent = '+12%';
            document.getElementById('callsGrowth').textContent = '+8%';
            document.getElementById('successGrowth').textContent = '+5%';

            // Update SLA expired count (cases pending for more than 24 hours)
            const now = new Date();
            const slaExpired = callData.filter(call => {
                if (call.caseStatus === 'Pending') {
                    const callDate = new Date(call.timestamp);
                    const hoursDiff = (now - callDate) / (1000 * 60 * 60);
                    return hoursDiff > 24;
                }
                return false;
            }).length;

            document.getElementById('slaExpired').textContent = slaExpired + ' เกิน SLA';
        }

        function updatePerformanceTable(kymData, callData) {
            // Group data by operator
            const operatorStats = {};

            // Process KYM data
            kymData.forEach(record => {
                if (!operatorStats[record.operatorName]) {
                    operatorStats[record.operatorName] = {
                        name: record.operatorName,
                        kym: 0,
                        calls: 0,
                        contacted: 0,
                        pending: 0,
                        score: 0
                    };
                }
                operatorStats[record.operatorName].kym++;
            });

            // Process call data
            callData.forEach(record => {
                if (!operatorStats[record.operatorName]) {
                    operatorStats[record.operatorName] = {
                        name: record.operatorName,
                        kym: 0,
                        calls: 0,
                        contacted: 0,
                        pending: 0,
                        score: 0
                    };
                }
                operatorStats[record.operatorName].calls++;
                if (record.callResult === 'ติดต่อได้') {
                    operatorStats[record.operatorName].contacted++;
                }
                if (record.caseStatus === 'Pending') {
                    operatorStats[record.operatorName].pending++;
                }
            });

            // Calculate scores and success rates
            Object.values(operatorStats).forEach(op => {
                const successRate = op.calls > 0 ? (op.contacted / op.calls) * 100 : 0;
                op.successRate = Math.round(successRate);
                op.score = (op.kym * 2) + (op.contacted * 3) - (op.pending * 1);
            });

            // Sort operators
            const sortBy = document.getElementById('sortBy').value || 'score';
            const operators = Object.values(operatorStats).sort((a, b) => {
                switch (sortBy) {
                    case 'kym': return b.kym - a.kym;
                    case 'calls': return b.calls - a.calls;
                    case 'success': return b.successRate - a.successRate;
                    default: return b.score - a.score;
                }
            });

            // Update performance table
            const tbody = document.getElementById('performanceTableBody');
            tbody.innerHTML = operators.map((op, index) => {
                const rank = index + 1;
                const rankBadge = rank <= 3 ?
                    `<span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ${rank === 1 ? 'bg-yellow-100 text-yellow-800' :
                        rank === 2 ? 'bg-gray-100 text-gray-800' :
                            'bg-orange-100 text-orange-800'
                    }">${rank}</span>` :
                    `<span class="text-gray-500">${rank}</span>`;

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">${rankBadge}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${op.name}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${op.kym}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${op.calls}</td>
                        <td class="px-6 py-4">
                            <span class="text-sm ${op.successRate >= 70 ? 'text-green-600' : op.successRate >= 50 ? 'text-yellow-600' : 'text-red-600'} font-medium">
                                ${op.successRate}%
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-sm ${op.pending > 5 ? 'text-red-600' : op.pending > 2 ? 'text-yellow-600' : 'text-green-600'} font-medium">
                                ${op.pending}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${op.score >= 20 ? 'bg-green-100 text-green-800' :
                        op.score >= 10 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                    }">
                                ${op.score}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateTopPerformers(kymData, callData) {
            // Get top 3 performers based on score
            const operatorStats = {};

            // Calculate stats for each operator
            [...kymData, ...callData].forEach(record => {
                if (!operatorStats[record.operatorName]) {
                    operatorStats[record.operatorName] = {
                        name: record.operatorName,
                        kym: 0,
                        calls: 0,
                        contacted: 0,
                        score: 0
                    };
                }

                if (record.status) { // KYM record
                    operatorStats[record.operatorName].kym++;
                } else { // Call record
                    operatorStats[record.operatorName].calls++;
                    if (record.callResult === 'ติดต่อได้') {
                        operatorStats[record.operatorName].contacted++;
                    }
                }
            });

            // Calculate scores
            Object.values(operatorStats).forEach(op => {
                op.score = (op.kym * 2) + (op.contacted * 3);
            });

            // Get top 3
            const topPerformers = Object.values(operatorStats)
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);

            // Update DOM
            const container = document.getElementById('topPerformers');
            container.innerHTML = topPerformers.map((performer, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : '🥉';
                const bgColor = rank === 1 ? 'bg-yellow-50 border-yellow-200' :
                    rank === 2 ? 'bg-gray-50 border-gray-200' :
                        'bg-orange-50 border-orange-200';

                return `
                    <div class="p-4 rounded-lg border-2 ${bgColor} text-center">
                        <div class="text-2xl mb-2">${medal}</div>
                        <div class="font-bold text-gray-800">${performer.name}</div>
                        <div class="text-sm text-gray-600 mt-1">
                            KYM: ${performer.kym} | โทร: ${performer.calls}
                        </div>
                        <div class="text-lg font-bold text-primary mt-2">
                            ${performer.score} คะแนน
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateKymStatusChart(kymData) {
            const approved = kymData.filter(r => r.status === 'Approved').length;
            const revised = kymData.filter(r => r.status === 'Revised').length;
            const rejected = kymData.filter(r => r.status === 'Rejected').length;
            const total = kymData.length;

            const container = document.getElementById('kymStatusChart');
            container.innerHTML = `
                <div class="text-center p-6 bg-green-50 rounded-lg border border-green-200">
                    <div class="text-3xl font-bold text-green-600">${approved}</div>
                    <div class="text-sm text-green-600 font-medium">อนุมัติ</div>
                    <div class="text-xs text-green-500 mt-1">${total > 0 ? Math.round((approved / total) * 100) : 0}%</div>
                </div>
                <div class="text-center p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                    <div class="text-3xl font-bold text-yellow-600">${revised}</div>
                    <div class="text-sm text-yellow-600 font-medium">แก้ไข</div>
                    <div class="text-xs text-yellow-500 mt-1">${total > 0 ? Math.round((revised / total) * 100) : 0}%</div>
                </div>
                <div class="text-center p-6 bg-red-50 rounded-lg border border-red-200">
                    <div class="text-3xl font-bold text-red-600">${rejected}</div>
                    <div class="text-sm text-red-600 font-medium">ปฏิเสธ</div>
                    <div class="text-xs text-red-500 mt-1">${total > 0 ? Math.round((rejected / total) * 100) : 0}%</div>
                </div>
            `;
        }

        function updateAlertsSection() {
            const now = new Date();
            const alerts = [];

            // Check for overdue cases
            const overdueCases = callData.filter(call => {
                if (call.caseStatus === 'Pending' && call.followUpDate) {
                    return new Date(call.followUpDate) < now;
                }
                return false;
            });

            if (overdueCases.length > 0) {
                alerts.push({
                    type: 'error',
                    title: 'เคสเกิน SLA',
                    message: `มี ${overdueCases.length} เคสที่เกินกำหนดเวลาติดตาม`,
                    action: 'ตรวจสอบเคส Pending'
                });
            }

            // Check for high pending cases per operator
            const operatorPending = {};
            callData.filter(c => c.caseStatus === 'Pending').forEach(call => {
                operatorPending[call.operatorName] = (operatorPending[call.operatorName] || 0) + 1;
            });

            Object.entries(operatorPending).forEach(([operator, count]) => {
                if (count > 10) {
                    alerts.push({
                        type: 'warning',
                        title: 'เคส Pending สูง',
                        message: `${operator} มีเคส Pending ${count} เคส`,
                        action: 'ควรติดตามเร่งด่วน'
                    });
                }
            });

            // Default message if no alerts
            if (alerts.length === 0) {
                alerts.push({
                    type: 'success',
                    title: 'ระบบปกติ',
                    message: 'ไม่มีแจ้งเตือนที่ต้องดำเนินการ',
                    action: 'ทุกอย่างเป็นไปตามปกติ'
                });
            }

            const container = document.getElementById('alertsSection');
            container.innerHTML = alerts.map(alert => {
                const iconColor = alert.type === 'error' ? 'text-red-500' :
                    alert.type === 'warning' ? 'text-yellow-500' : 'text-green-500';
                const bgColor = alert.type === 'error' ? 'bg-red-50 border-red-200' :
                    alert.type === 'warning' ? 'bg-yellow-50 border-yellow-200' : 'bg-green-50 border-green-200';

                return `
                    <div class="p-4 rounded-lg border ${bgColor}">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 ${iconColor} mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                ${alert.type === 'error' ?
                        '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>' :
                        alert.type === 'warning' ?
                            '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>' :
                            '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>'
                    }
                            </svg>
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-800">${alert.title}</h4>
                                <p class="text-sm text-gray-600 mt-1">${alert.message}</p>
                                <p class="text-xs text-gray-500 mt-2">${alert.action}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateDashboardPeriod(period) {
            currentDashboardPeriod = period;
            // Update dashboard based on period
            console.log('Dashboard period updated to:', period);
        }

        function toggleDashboardCustomRange() {
            const customRange = document.getElementById('dashboardCustomRange');
            customRange.classList.toggle('hidden');
        }

        function updateDashboardCustom() {
            // Implementation for custom dashboard update
            console.log('Custom dashboard update');
        }

        function loadPerformanceTable() {
            // Implementation for performance table
            console.log('Loading performance table');
        }

        function generateQuickReport(period) {
            let startDate, endDate;
            const now = new Date();

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case '7days':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    endDate = now;
                    break;
                case '30days':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    endDate = now;
                    break;
            }

            generateReport(startDate, endDate, period);
        }

        function toggleCustomDateRange() {
            const customRange = document.getElementById('customDateRange');
            customRange.classList.toggle('hidden');
        }

        function generateCustomReport() {
            const startDateStr = document.getElementById('reportStartDate').value;
            const endDateStr = document.getElementById('reportEndDate').value;

            if (!startDateStr || !endDateStr) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกวันที่',
                    text: 'กรุณาเลือกวันที่เริ่มต้นและวันที่สิ้นสุด',
                    allowOutsideClick: false,
                    confirmButtonColor: '#FF6B35',
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
                return;
            }

            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr + 'T23:59:59');

            if (startDate > endDate) {
                Swal.fire({
                    icon: 'error',
                    title: 'วันที่ไม่ถูกต้อง',
                    text: 'วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด',
                    allowOutsideClick: false,
                    confirmButtonColor: '#FF6B35',
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
                return;
            }

            generateReport(startDate, endDate, 'custom');
        }

        function generateReport(startDate, endDate, periodType) {
            // Filter data by date range
            const filteredKymData = kymData.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate >= startDate && recordDate <= endDate;
            });

            const filteredCallData = callData.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate >= startDate && recordDate <= endDate;
            });

            // Generate report HTML
            const reportResults = document.getElementById('reportResults');

            if (filteredKymData.length === 0 && filteredCallData.length === 0) {
                reportResults.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">ไม่พบข้อมูลในช่วงเวลาที่เลือก</h3>
                        <p class="text-gray-500">ลองเลือกช่วงเวลาอื่น หรือตรวจสอบว่ามีการบันทึกข้อมูลแล้ว</p>
                    </div>
                `;
                return;
            }

            // Calculate statistics
            const kymStats = {
                total: filteredKymData.length,
                approved: filteredKymData.filter(r => r.status === 'Approved').length,
                revised: filteredKymData.filter(r => r.status === 'Revised').length,
                rejected: filteredKymData.filter(r => r.status === 'Rejected').length
            };

            const callStats = {
                total: filteredCallData.length,
                contacted: filteredCallData.filter(r => r.callResult === 'ติดต่อได้').length,
                pending: filteredCallData.filter(r => r.caseStatus === 'Pending').length,
                closed: filteredCallData.filter(r => r.caseStatus === 'Closed').length
            };

            // Generate period label
            let periodLabel = '';
            switch (periodType) {
                case 'today':
                    periodLabel = 'วันนี้';
                    break;
                case '7days':
                    periodLabel = '7 วันย้อนหลัง';
                    break;
                case '30days':
                    periodLabel = '30 วันย้อนหลัง';
                    break;
                case 'custom':
                    periodLabel = `${startDate.toLocaleDateString('th-TH')} - ${endDate.toLocaleDateString('th-TH')}`;
                    break;
            }

            reportResults.innerHTML = `
                <div class="space-y-8">
                    <!-- Report Header -->
                    <div class="bg-gradient-to-r from-primary to-secondary text-white rounded-xl p-6">
                        <h3 class="text-2xl font-bold mb-2">รายงานประจำ${periodLabel}</h3>
                        <p class="text-sm opacity-90">สร้างเมื่อ: ${new Date().toLocaleString('th-TH')}</p>
                        
                        <!-- Download Buttons -->
                        <div class="flex flex-wrap gap-3 mt-4">
                            <button onclick="downloadCallReport('${periodType}', '${startDate.toISOString()}', '${endDate.toISOString()}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                                <span>รายงานสถิติการโทร (.txt)</span>
                            </button>
                            <button onclick="downloadCallDetailsCSV('${periodType}', '${startDate.toISOString()}', '${endDate.toISOString()}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                                <span>รายละเอียดการโทรออก (.csv)</span>
                            </button>
                            ${filteredKymData.length > 0 ? `
                            <button onclick="downloadKymDetailsCSV('${periodType}', '${startDate.toISOString()}', '${endDate.toISOString()}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                                <span>รายละเอียด KYM (.csv)</span>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">KYM ทั้งหมด</p>
                                    <p class="text-3xl font-bold text-blue-600">${kymStats.total}</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">อนุมัติ</p>
                                    <p class="text-3xl font-bold text-green-600">${kymStats.approved}</p>
                                    <p class="text-xs text-green-600">${kymStats.total > 0 ? Math.round((kymStats.approved / kymStats.total) * 100) : 0}%</p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-yellow-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">ต้องแก้ไข</p>
                                    <p class="text-3xl font-bold text-yellow-600">${kymStats.revised}</p>
                                    <p class="text-xs text-yellow-600">${kymStats.total > 0 ? Math.round((kymStats.revised / kymStats.total) * 100) : 0}%</p>
                                </div>
                                <div class="bg-yellow-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl card-shadow p-6 border-l-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">ปฏิเสธ</p>
                                    <p class="text-3xl font-bold text-red-600">${kymStats.rejected}</p>
                                    <p class="text-xs text-red-600">${kymStats.total > 0 ? Math.round((kymStats.rejected / kymStats.total) * 100) : 0}%</p>
                                </div>
                                <div class="bg-red-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Call Statistics -->
                    ${callStats.total > 0 ? `
                    <div class="bg-white rounded-xl card-shadow p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h4 class="text-xl font-bold text-gray-800 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                                </svg>
                                สถิติการโทรออก
                            </h4>
                            <div class="text-sm text-gray-500">
                                อัตราสำเร็จ: <span class="font-bold text-green-600">${callStats.total > 0 ? Math.round((callStats.contacted / callStats.total) * 100) : 0}%</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="text-3xl font-bold text-blue-600">${callStats.total}</div>
                                <div class="text-sm text-blue-600 font-medium">การโทรทั้งหมด</div>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg border border-green-200">
                                <div class="text-3xl font-bold text-green-600">${callStats.contacted}</div>
                                <div class="text-sm text-green-600 font-medium">ติดต่อได้</div>
                                <div class="text-xs text-green-500">${callStats.total > 0 ? Math.round((callStats.contacted / callStats.total) * 100) : 0}%</div>
                            </div>
                            <div class="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                <div class="text-3xl font-bold text-yellow-600">${callStats.pending}</div>
                                <div class="text-sm text-yellow-600 font-medium">รอติดตาม</div>
                                <div class="text-xs text-yellow-500">${callStats.total > 0 ? Math.round((callStats.pending / callStats.total) * 100) : 0}%</div>
                            </div>
                            <div class="text-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <div class="text-3xl font-bold text-gray-600">${callStats.closed}</div>
                                <div class="text-sm text-gray-600 font-medium">ปิดเคสแล้ว</div>
                                <div class="text-xs text-gray-500">${callStats.total > 0 ? Math.round((callStats.closed / callStats.total) * 100) : 0}%</div>
                            </div>
                        </div>
                        
                        <!-- Call Results Breakdown -->
                        <div class="border-t pt-4">
                            <h5 class="font-semibold text-gray-700 mb-3">รายละเอียดผลการโทร</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                ${generateCallResultsBreakdown(filteredCallData)}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- KYM Details Table -->
                    ${filteredKymData.length > 0 ? `
                    <div class="bg-white rounded-xl card-shadow overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b">
                            <h4 class="text-xl font-bold text-gray-800">รายละเอียด KYM</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">วันที่</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ทรูมันนี่</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ร้านค้า</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">หมวดหมู่</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ระบบแนะนำ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">สถานะ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ผู้ดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${filteredKymData.map(record => {
                // Calculate recommended status based on assessment
                let recommendedStatus = 'N/A';
                if (record.assessment) {
                    const { prohibitedStore, repeatApplication, storePhoto, productService, storeNameCheck, professionalLicense } = record.assessment;

                    // Check for immediate rejection reasons
                    if (prohibitedStore || repeatApplication) {
                        recommendedStatus = 'Rejected';
                    } else {
                        // Check required items
                        const requiredItems = [storePhoto, productService, storeNameCheck];

                        // Check if professional license is required (simplified check)
                        const licenseRequired = record.subCategory && (
                            record.subCategory.includes('คลินิก') ||
                            record.subCategory.includes('ทันตกรรม') ||
                            record.subCategory.includes('นวด') ||
                            record.subCategory.includes('สถาบันเสริมความงาม') ||
                            record.subCategory.includes('ทัศนมาตร') ||
                            record.subCategory.includes('ขายยา') ||
                            record.subCategory.includes('สัตวแพทย์')
                        );

                        if (licenseRequired) {
                            requiredItems.push(professionalLicense);
                        }

                        const missingRequired = requiredItems.filter(item => !item);
                        recommendedStatus = missingRequired.length > 0 ? 'Revised' : 'Approved';
                    }
                }

                return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm text-gray-900">${new Date(record.timestamp).toLocaleDateString('th-TH')}</td>
                                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${record.truemoneyId}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${record.storeName}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${record.category}</td>
                                            <td class="px-6 py-4">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${recommendedStatus === 'Approved' ? 'bg-blue-100 text-blue-800' :
                        recommendedStatus === 'Revised' ? 'bg-orange-100 text-orange-800' :
                            recommendedStatus === 'Rejected' ? 'bg-purple-100 text-purple-800' :
                                'bg-gray-100 text-gray-800'
                    }">
                                                    ${recommendedStatus}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${record.status === 'Approved' ? 'bg-green-100 text-green-800' :
                        record.status === 'Revised' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                    }">
                                                    ${record.status}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${record.operatorName}</td>
                                        </tr>
                                        `;
            }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Call Details Table -->
                    ${filteredCallData.length > 0 ? `
                    <div class="bg-white rounded-xl card-shadow overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b">
                            <h4 class="text-xl font-bold text-gray-800">รายละเอียดการโทรออก</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">วันที่</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ทรูมันนี่</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ร้านค้า</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ผู้ติดต่อ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">เหตุผล</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ผลการโทร</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">สถานะเคส</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">การติดตาม</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ผู้ดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${filteredCallData.slice(0, 50).map(record => {
                const followUpCount = record.activities ? record.activities.length : 0;
                return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm text-gray-900">${new Date(record.timestamp).toLocaleDateString('th-TH')}</td>
                                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${record.truemoneyId}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${record.storeName || 'ไม่ระบุ'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${record.contactName || 'ไม่ระบุ'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${record.callReason}</td>
                                            <td class="px-6 py-4">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${record.callResult === 'ติดต่อได้' ? 'bg-green-100 text-green-800' :
                        record.callResult === 'ไม่รับสาย' ? 'bg-yellow-100 text-yellow-800' :
                            record.callResult === 'เบอร์ผิด' ? 'bg-red-100 text-red-800' :
                                'bg-gray-100 text-gray-800'
                    }">
                                                    ${record.callResult}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${record.caseStatus === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'
                    }">
                                                    ${record.caseStatus === 'Pending' ? 'รอติดตาม' : 'ปิดเคส'}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-500">
                                                ${followUpCount > 0 ? `${followUpCount + 1} ครั้ง` : '1 ครั้ง'}
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${record.operatorName}</td>
                                        </tr>
                                        `;
            }).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${filteredCallData.length > 50 ? `
                        <div class="bg-gray-50 px-6 py-3 border-t">
                            <p class="text-sm text-gray-500 text-center">
                                แสดง 50 รายการแรก จากทั้งหมด ${filteredCallData.length} รายการ 
                                <span class="font-medium">ดาวน์โหลดไฟล์ CSV เพื่อดูข้อมูลทั้งหมด</span>
                            </p>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- Performance by Operator -->
                    ${generateOperatorPerformance(filteredKymData, filteredCallData)}
                </div>
            `;
        }

        function generateOperatorPerformance(kymData, callData) {
            if (kymData.length === 0 && callData.length === 0) return '';

            // Group by operator
            const operatorStats = {};

            // Process KYM data
            kymData.forEach(record => {
                if (!operatorStats[record.operatorName]) {
                    operatorStats[record.operatorName] = {
                        name: record.operatorName,
                        kym: { total: 0, approved: 0, revised: 0, rejected: 0 },
                        calls: { total: 0, contacted: 0, pending: 0, closed: 0 }
                    };
                }

                operatorStats[record.operatorName].kym.total++;
                operatorStats[record.operatorName].kym[record.status.toLowerCase()]++;
            });

            // Process call data
            callData.forEach(record => {
                if (!operatorStats[record.operatorName]) {
                    operatorStats[record.operatorName] = {
                        name: record.operatorName,
                        kym: { total: 0, approved: 0, revised: 0, rejected: 0 },
                        calls: { total: 0, contacted: 0, pending: 0, closed: 0 }
                    };
                }

                operatorStats[record.operatorName].calls.total++;
                if (record.callResult === 'ติดต่อได้') operatorStats[record.operatorName].calls.contacted++;
                if (record.caseStatus === 'Pending') operatorStats[record.operatorName].calls.pending++;
                if (record.caseStatus === 'Closed') operatorStats[record.operatorName].calls.closed++;
            });

            const operators = Object.values(operatorStats);

            if (operators.length === 0) return '';

            return `
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b">
                        <h4 class="text-xl font-bold text-gray-800">ผลงานรายพนักงาน</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">พนักงาน</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">KYM</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">อนุมัติ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">แก้ไข</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ปฏิเสธ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">การโทร</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">อัตราสำเร็จ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${operators.map(op => {
                const successRate = op.calls.total > 0 ? Math.round((op.calls.contacted / op.calls.total) * 100) : 0;
                return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${op.name}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${op.kym.total}</td>
                                            <td class="px-6 py-4 text-sm text-green-600">${op.kym.approved}</td>
                                            <td class="px-6 py-4 text-sm text-yellow-600">${op.kym.revised}</td>
                                            <td class="px-6 py-4 text-sm text-red-600">${op.kym.rejected}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${op.calls.total}</td>
                                            <td class="px-6 py-4 text-sm ${successRate >= 70 ? 'text-green-600' : successRate >= 50 ? 'text-yellow-600' : 'text-red-600'}">${successRate}%</td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function toggleFollowUpSection() {
            const status = document.getElementById('caseStatus').value;
            const section = document.getElementById('followUpSection');

            if (status === 'Pending') {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }

        function updateSubCategories() {
            const category = document.getElementById('category').value;
            const subCategorySelect = document.getElementById('subCategory');

            subCategorySelect.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย</option>';

            if (category && categoryMapping[category]) {
                categoryMapping[category].forEach(subCat => {
                    const option = document.createElement('option');
                    option.value = subCat;
                    option.textContent = subCat;
                    subCategorySelect.appendChild(option);
                });
            }
        }

        function checkLicenseRequirement() {
            const category = document.getElementById('category').value;
            const subCategory = document.getElementById('subCategory').value;
            const licenseSection = document.getElementById('licenseSection');
            console.log(category, subCategory);

            let requiresLicense = false;

            if (licenseRequiredCategories[category]) {
                requiresLicense = licenseRequiredCategories[category].includes(subCategory);
            }

            if (requiresLicense) {
                licenseSection.classList.remove('hidden');
            } else {
                licenseSection.classList.add('hidden');
                document.getElementById('professionalLicense').checked = false;
            }

            updateRecommendedStatus();
        }

        function toggleOtherReasonSection() {
            const reason = document.getElementById('callReason').value;
            const section = document.getElementById('otherReasonSection');

            if (reason === 'อื่นๆ') {
                section.classList.remove('hidden');
                document.getElementById('otherReason').required = true;
            } else {
                section.classList.add('hidden');
                document.getElementById('otherReason').required = false;
            }
        }

        function toggleRescheduleSection() {
            const result = document.getElementById('callResult').value;
            const rescheduleSection = document.getElementById('rescheduleSection');
            const retrySection = document.getElementById('retryCallSection');

            // Hide both sections first
            rescheduleSection.classList.add('hidden');
            retrySection.classList.add('hidden');

            // Reset required fields
            document.getElementById('rescheduleDateTime').required = false;
            document.getElementById('retryCallDate').required = false;

            if (result === 'ไม่สะดวก') {
                rescheduleSection.classList.remove('hidden');
                document.getElementById('rescheduleDateTime').required = true;
            } else if (result === 'ติดต่อไม่ได้' || result === 'ไม่รับสาย' || result === 'ปิดเครื่อง') {
                retrySection.classList.remove('hidden');
                document.getElementById('retryCallDate').required = true;
                if (call.retryCallDate) {
                    document.getElementById('retryCallDate')._flatpickr.setDate(call.retryCallDate);
                }
            }
        }

        function clearCallForm() {
            const form = document.getElementById('callForm');
            form.reset();

            // Clear follow-up flag
            delete form.dataset.followUpFor;

            // Hide conditional sections
            document.getElementById('otherReasonSection').classList.add('hidden');
            document.getElementById('rescheduleSection').classList.add('hidden');
            document.getElementById('retryCallSection').classList.add('hidden');
            document.getElementById('followUpSection').classList.add('hidden');

            // Reset required attributes
            document.getElementById('otherReason').required = false;
            document.getElementById('rescheduleDateTime').required = false;
            document.getElementById('retryCallDate').required = false;
        }
        function clearKymForm() {
            const form = document.getElementById('kymForm');
            form.reset();

            // ซ่อน sections ที่เป็น conditional
            document.getElementById('reasonSection').classList.add('hidden');
            document.getElementById('licenseSection').classList.add('hidden');

            // รีเซ็ต subcategory dropdown
            document.getElementById('subCategory').innerHTML = '<option value="">เลือกหมวดหมู่ย่อย</option>';

            // รีเซ็ต recommended status
            document.getElementById('recommendedStatus').textContent = 'กรุณาประเมินข้อมูล';
            document.getElementById('statusReason').textContent = '';

            // รีเซ็ต status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-opacity-50', 'ring-opacity-75', 'ring-green-400', 'ring-yellow-400', 'ring-red-400');
                btn.classList.remove('bg-opacity-90', 'transform', 'scale-105');
                btn.style.boxShadow = '';
            });

            // รีเซ็ต hidden status field
            document.getElementById('kymStatus').value = '';

            // รีเซ็ตสวิตช์การประเมิน
            document.querySelectorAll('.assessment-switch').forEach(switchEl => {
                switchEl.checked = false;
            });
        }
        function closeCaseDetailModal() {
            document.getElementById('caseDetailModal').classList.add('hidden');
        }

        function closeFollowUpModal() {
            document.getElementById('followUpModal').classList.add('hidden');
            document.getElementById('followUpForm').reset();
        }

        function toggleFollowUpSections() {
            const result = document.getElementById('followUpCallResult').value;
            const rescheduleSection = document.getElementById('followUpRescheduleSection');
            const retrySection = document.getElementById('followUpRetrySection');

            // Hide both sections first
            rescheduleSection.classList.add('hidden');
            retrySection.classList.add('hidden');

            // Reset required fields
            document.getElementById('followUpRescheduleDateTime').required = false;
            document.getElementById('followUpRetryCallDate').required = false;

            if (result === 'ไม่สะดวก') {
                rescheduleSection.classList.remove('hidden');
                document.getElementById('followUpRescheduleDateTime').required = true;
            } else if (result === 'ติดต่อไม่ได้' || result === 'ไม่รับสาย' || result === 'ปิดเครื่อง') {
                retrySection.classList.remove('hidden');
                document.getElementById('followUpRetryCallDate').required = true;

            }
        }

        function toggleFollowUpNextCallSection() {
            const status = document.getElementById('followUpCaseStatus').value;
            const section = document.getElementById('followUpNextCallSection');

            if (status === 'Pending') {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }

        function handleFollowUpSubmit(e) {
            e.preventDefault();

            const caseId = document.getElementById('followUpCaseId').value;
            const existingCallIndex = callData.findIndex(c => c.id == caseId);

            if (existingCallIndex === -1) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่พบเคส',
                    text: 'ไม่สามารถหาเคสที่ต้องการติดตามได้',
                    allowOutsideClick: false,
                    confirmButtonColor: '#FF6B35',
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
                return;
            }

            const existingCall = callData[existingCallIndex];
            console.log(existingCall)

            if (!existingCall.activities) {
                existingCall.activities = [];
            }

            const activity = {
                id: Date.now(),
                callResult: document.getElementById('followUpCallResult').value,
                callDetails: document.getElementById('followUpCallDetails').value,
                rescheduleDateTime: document.getElementById('followUpRescheduleDateTime').value,
                retryCallDate: document.getElementById('followUpRetryCallDate').value,
                retryTimeSlot: document.getElementById('followUpRetryTimeSlot').value,
                retryNotes: document.getElementById('followUpRetryNotes').value,
                operator: currentUser.username,
                operatorName: currentUser.name,
                timestamp: new Date().toISOString()
            };

            existingCall.activities.push(activity);
            existingCall.caseStatus = document.getElementById('followUpCaseStatus').value;

            const nextCallDate = document.getElementById('followUpNextCallDate').value;
            const retryCallDate = document.getElementById('followUpRetryCallDate').value;
            const rescheduleDateTime = document.getElementById('followUpRescheduleDateTime').value;

            if (nextCallDate) {
                console.log('Setting next call date for follow-up:', nextCallDate);
                existingCall.followUpDate = nextCallDate;
                existingCall.nextCallTimeSlot = document.getElementById('followUpNextCallTimeSlot').value;
            } else if (retryCallDate) {
                console.log('Setting retry call date for follow-up:', retryCallDate);
                existingCall.followUpDate = moment(retryCallDate).format('YYYY-MM-DD');
                existingCall.nextCallTimeSlot = document.getElementById('followUpRetryTimeSlot').value;
                existingCall.retryNotes = document.getElementById('followUpRetryNotes').value;
            } else if (rescheduleDateTime) {
                existingCall.followUpDate = rescheduleDateTime;
            } else if (existingCall.caseStatus === 'Closed') {
                delete existingCall.followUpDate;
                delete existingCall.nextCallTimeSlot;
                delete existingCall.retryNotes;
                existingCall.closedAt = moment().format('DD/MM/YYYY, HH:mm:ss');
                existingCall.lastOperator = currentUser.username;
            }
            existingCall.retryCallDate = retryCallDate ? moment(retryCallDate).format('YYYY-MM-DD') : '';
            existingCall.lastActivity = activity.timestamp;
            existingCall.lastOperator = activity.operatorName;

            Swal.fire({
                icon: 'info',
                title: 'กำลังบันทึก...',
                allowOutsideClick: false,
                customClass: {
                    popup: 'rounded-2xl'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            console.log('Submitting follow-up for case ID:', caseId, existingCall);

            google.script.run
                .withSuccessHandler(async function (result) {
                    result = JSON.parse(result);
                    if (result.success) {
                        closeFollowUpModal();
                        Swal.fire({
                            icon: 'success',
                            title: 'บันทึกการโทรติดตามสำเร็จ',
                            text: `กำลังโหลดข้อมูลใหม่...`,
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            },
                            customClass: {
                                popup: 'rounded-2xl'
                            }
                        });
                        await loadPendingCases();
                        Swal.close()
                        if (currentUser && (currentUser.role === 'Supervisor' || currentUser.role === 'Admin')) {
                            updateDashboard();
                        }


                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: result.error,
                            allowOutsideClick: false,
                            confirmButtonColor: '#FF6B35',
                            customClass: {
                                popup: 'rounded-2xl'
                            }
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Follow-up submit error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถบันทึกการโทรติดตามได้: ' + error.message,
                        allowOutsideClick: false,
                        confirmButtonColor: '#FF6B35',
                        customClass: {
                            popup: 'rounded-2xl'
                        }
                    });
                })
                .updateCallLog(existingCall);
        }

        function renderAssessmentSection() {
            // รีเซ็ต recommended status
            document.getElementById('recommendedStatus').textContent = 'กรุณาประเมินข้อมูล';
            document.getElementById('statusReason').textContent = '';

            const channel = document.getElementById('salesChannel').value;
            const section = document.getElementById('assessmentSection');
            const assessmentInfo = document.getElementById('assessmentInfo');
            const checklistItems = document.querySelectorAll('.checklist-item');
            checklistItems.forEach(item => item.remove());
            const checklist = JSON.parse(JSON.stringify(checklists[channel]))
            if (!checklist) {
                assessmentInfo.classList.remove('hidden');
                return
            } else {
                assessmentInfo.classList.add('hidden');
            }
            checklist.reverse();

            checklist.forEach((item, i) => {
                const div = document.createElement('div');
                if (item.id === 'professionalLicense') {
                    div.id = 'licenseSection';
                }
                div.className = `bg-white p-4 rounded-lg border border-orange-100 shadow-sm checklist-item ${item.id === 'professionalLicense' ? 'hidden' : ''}`;
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <h4 class="font-semibold text-gray-800">
                                    ${(checklist.length - i)}. ${item.title}
                                </h4>
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${item.important ? 'bg-red-100 text-red-800' : (item.required ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800')}">
                                    ${item.important ? ('ตรวจสอบ • สำคัญ') : (`${item.score} คะแนน • ${item.required ? 'จำเป็น' : 'ไม่จำเป็น'}`)}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600">
                                ${item.description}
                            </p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer ml-4">
                            <input type="checkbox" id="${item.id}"
                                class="sr-only peer assessment-switch">
                            <div
                                class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-orange-500">
                            </div>
                        </label>
                    </div>
                `;

                // Insert between the first child (header) and second child (first existing checklist item)
                if (section.children.length > 2) {
                    section.insertBefore(div, section.children[2]);
                } else {
                    section.appendChild(div);
                }
            });
            setupAssessmentSystem();
            checkLicenseRequirement()
        }


        function setupAssessmentSystem() {
            const switches = document.querySelectorAll('.assessment-switch');
            switches.forEach(switchEl => {
                switchEl.addEventListener('change', updateRecommendedStatus);
            });

            // Status buttons
            document.getElementById('approveBtn').addEventListener('click', () => setKymStatus('Approve'));
            document.getElementById('reviseBtn').addEventListener('click', () => setKymStatus('Revise'));
            document.getElementById('rejectBtn').addEventListener('click', () => setKymStatus('Reject'));
        }

        function updateRecommendedStatus() {
            const onlineStorePhoto = document.getElementById('onlineStorePhoto')?.checked;
            const storePhoto = document.getElementById('storePhoto')?.checked;
            const productService = document.getElementById('productService')?.checked;
            const storeNameCheck = document.getElementById('storeNameCheck')?.checked;
            const businessReg = document.getElementById('businessReg')?.checked;
            const professionalLicense = document.getElementById('professionalLicense')?.checked;
            const prohibitedStore = document.getElementById('prohibitedStore')?.checked;
            const repeatApplication = document.getElementById('repeatApplication')?.checked;
            const licenseRequired = !document.getElementById('licenseSection').classList.contains('hidden');

            const statusElement = document.getElementById('recommendedStatus');
            const reasonElement = document.getElementById('statusReason');

            // ตรวจสอบเงื่อนไขที่ต้อง Reject ทันที
            if (prohibitedStore || repeatApplication) {
                statusElement.textContent = 'Rejected';
                statusElement.className = 'text-2xl font-bold text-red-700 mb-2';

                let rejectReasons = [];
                if (prohibitedStore) rejectReasons.push('ร้านค้าต้องห้าม');
                if (repeatApplication) rejectReasons.push('อนุมัติแล้วลบแล้วสมัครใหม่ซ้ำๆ');

                reasonElement.innerHTML = `
                    <div class="space-y-2">
                        <div class="text-red-800 font-semibold">แนะนำปฏิเสธ - พบปัญหาร้ายแรง</div>
                        <div class="text-sm text-red-600">เหตุผล: ${rejectReasons.join(', ')}</div>
                        <div class="text-sm text-red-500">⚠️ กรณีนี้ไม่ควรอนุมัติ</div>
                    </div>
                `;
                return;
            }

            // ตรวจสอบข้อจำเป็น (ข้อ 1-3 สำหรับร้านค้าธรรมดา)
            const requiredItems = [storePhoto, productService, storeNameCheck];
            const missingRequired = [];

            if (!storePhoto) missingRequired.push('รูปร้านค้าจริง (2 คะแนน)');
            if (!productService) missingRequired.push('ประเภทสินค้า/บริการ (2 คะแนน)');
            if (!storeNameCheck) missingRequired.push('ชื่อร้านค้า (1 คะแนน)');

            // ตรวจสอบใบประกอบวิชาชีพ (จำเป็นสำหรับบางประเภท)
            if (licenseRequired && !professionalLicense) {
                missingRequired.push('ใบประกอบวิชาชีพ (2 คะแนน)');
            }

            // คำนวณคะแนน
            let totalScore = 0;
            let maxScore = 7; // ข้อ 1(2) + ข้อ 2(2) + ข้อ 3(1) + ข้อ 4(2) = 7 คะแนน

            if (storePhoto) totalScore += 2;
            if (productService) totalScore += 2;
            if (storeNameCheck) totalScore += 1;
            if (businessReg) totalScore += 2;

            // เพิ่มคะแนนใบประกอบวิชาชีพถ้าจำเป็น
            if (licenseRequired) {
                maxScore = 9; // เพิ่มข้อ 5(2) = 9 คะแนน
                if (professionalLicense) totalScore += 2;
            }

            // กำหนดสถานะตามเกณฑ์ใหม่
            if (missingRequired.length > 0) {
                // หากขาดข้อจำเป็นข้อใดข้อหนึ่ง = Revised
                statusElement.textContent = 'Revised';
                statusElement.className = 'text-2xl font-bold text-yellow-700 mb-2';
                reasonElement.innerHTML = `
                    <div class="space-y-2">
                        <div>ขาดข้อจำเป็น - แนะนำให้แก้ไข</div>
                        <div class="text-sm">คะแนนรวม: ${totalScore}/${maxScore}</div>
                        <div class="text-sm text-red-600">ข้อที่ยังไม่ผ่าน: ${missingRequired.join(', ')}</div>
                    </div>
                `;
            } else {
                // ผ่านข้อจำเป็นทั้งหมด = Approved
                statusElement.textContent = 'Approved';
                statusElement.className = 'text-2xl font-bold text-green-700 mb-2';
                reasonElement.innerHTML = `
                    <div class="space-y-2">
                        <div>ผ่านเกณฑ์การประเมินทุกข้อจำเป็น - แนะนำอนุมัติ</div>
                        <div class="text-sm text-green-600">คะแนนรวม: ${totalScore}/${maxScore}</div>
                        ${!businessReg ? '<div class="text-sm text-amber-600">หมายเหตุ: ไม่มีใบทะเบียนพาณิชย์ (ไม่จำเป็น)</div>' : ''}
                    </div>
                `;
            }
        }

        function setKymStatus(status) {
            document.getElementById('kymStatus').value = status;

            // Update button styles - make selection much more obvious
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-opacity-50', 'ring-green-400', 'ring-yellow-400', 'ring-red-400');
                btn.classList.remove('bg-opacity-90', 'transform', 'scale-105');
                btn.style.boxShadow = '';
            });

            const selectedBtn = document.getElementById(status.toLowerCase() + 'Btn');
            selectedBtn.classList.add('ring-4', 'ring-opacity-75', 'bg-opacity-90', 'transform', 'scale-105');

            // Add specific ring colors and enhanced styling
            if (status === 'Approved') {
                selectedBtn.classList.add('ring-green-400');
                selectedBtn.style.boxShadow = '0 0 20px rgba(34, 197, 94, 0.4)';
            } else if (status === 'Revised') {
                selectedBtn.classList.add('ring-yellow-400');
                selectedBtn.style.boxShadow = '0 0 20px rgba(251, 191, 36, 0.4)';
            } else if (status === 'Rejected') {
                selectedBtn.classList.add('ring-red-400');
                selectedBtn.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.4)';
            }

            // Update recommended status display to show selected status with enhanced styling
            const statusElement = document.getElementById('recommendedStatus');
            const reasonElement = document.getElementById('statusReason');

            if (status === 'Approved') {
                statusElement.textContent = '✅ Approved';
                statusElement.className = 'text-2xl font-bold text-green-700 mb-2';
                reasonElement.innerHTML = `
                    <div class="bg-green-100 border border-green-300 rounded-lg p-3">
                        <div class="text-green-800 font-semibold">✅ คุณได้เลือกสถานะ: อนุมัติ</div>
                        <div class="text-green-600 text-sm mt-1">สถานะนี้จะถูกบันทึกเมื่อกดปุ่ม "บันทึกข้อมูล KYM"</div>
                    </div>
                `;
            } else if (status === 'Revised') {
                statusElement.textContent = '⚠️ Revised';
                statusElement.className = 'text-2xl font-bold text-yellow-700 mb-2';
                reasonElement.innerHTML = `
                    <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-3">
                        <div class="text-yellow-800 font-semibold">⚠️ คุณได้เลือกสถานะ: แก้ไขข้อมูล</div>
                        <div class="text-yellow-600 text-sm mt-1">กรุณาระบุเหตุผลในช่องด้านล่าง</div>
                    </div>
                `;
            } else if (status === 'Rejected') {
                statusElement.textContent = '❌ Rejected';
                statusElement.className = 'text-2xl font-bold text-red-700 mb-2';
                reasonElement.innerHTML = `
                    <div class="bg-red-100 border border-red-300 rounded-lg p-3">
                        <div class="text-red-800 font-semibold">❌ คุณได้เลือกสถานะ: ไม่อนุมัติ</div>
                        <div class="text-red-600 text-sm mt-1">กรุณาระบุเหตุผลในช่องด้านล่าง</div>
                    </div>
                `;
            }

            // Show/hide reason section
            const reasonSection = document.getElementById('reasonSection');
            if (status === 'Revised' || status === 'Rejected') {
                reasonSection.classList.remove('hidden');
                document.getElementById('reason').required = true;
            } else {
                reasonSection.classList.add('hidden');
                document.getElementById('reason').required = false;
            }
        }

        function handleKymSubmit(e) {
            e.preventDefault();

            const kymRecord = {
                id: Date.now(),
                truemoneyId: document.getElementById('truemoneyId').value,
                storeName: document.getElementById('storeName').value,
                salesChannel: document.getElementById('salesChannel').value,
                category: document.getElementById('category').value,
                subCategory: document.getElementById('subCategory').value,
                status: document.getElementById('kymStatus').value,
                reason: document.getElementById('reason').value,
                notes: document.getElementById('notes').value,
                assessment: {
                    onlineStorePhoto: document.getElementById('onlineStorePhoto')?.checked,
                    storePhoto: document.getElementById('storePhoto')?.checked,
                    productService: document.getElementById('productService')?.checked,
                    storeNameCheck: document.getElementById('storeNameCheck')?.checked,
                    businessReg: document.getElementById('businessReg')?.checked,
                    professionalLicense: document.getElementById('professionalLicense')?.checked,
                    prohibitedStore: document.getElementById('prohibitedStore')?.checked,
                    repeatApplication: document.getElementById('repeatApplication')?.checked
                },
                operator: currentUser.username,
                operatorName: currentUser.name,
                timestamp: new Date().toISOString()
            };
            console.log('Submitting KYM Record:', kymRecord);

            Swal.fire({
                icon: 'info',
                title: 'กำลังบันทึก...',
                allowOutsideClick: false,
                customClass: {
                    popup: 'rounded-2xl'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            google.script.run
                .withSuccessHandler(async function (result) {
                    result = JSON.parse(result);
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'บันทึก KYM สำเร็จ',
                            text: 'กำลังโหลดข้อมูลใหม่...',
                            allowOutsideClick: false,
                            showConfirmButton: false,
                            confirmButtonColor: '#FF6B35',
                            customClass: {
                                popup: 'rounded-2xl'
                            }
                        });
                        await getKymData()
                        Swal.close()
                        if (currentUser && (currentUser.role === 'Supervisor' || currentUser.role === 'Admin')) {
                            updateDashboard();
                        }

                        // Reset form
                        document.getElementById('kymForm').reset();
                        document.getElementById('reasonSection').classList.add('hidden');
                        document.getElementById('licenseSection').classList.add('hidden');
                        document.getElementById('subCategory').innerHTML = '<option value="">เลือกหมวดหมู่ย่อย</option>';
                        document.getElementById('recommendedStatus').textContent = 'กรุณาประเมินข้อมูล';
                        document.getElementById('statusReason').textContent = '';
                        document.querySelectorAll('.status-btn').forEach(btn => {
                            btn.classList.remove('ring-4', 'ring-opacity-50');
                            btn.style.boxShadow = '';
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: result.error,
                            allowOutsideClick: false
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('KYM submit error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถบันทึกข้อมูล KYM ได้: ' + error.message,
                        allowOutsideClick: false
                    });
                })
                .saveKYMRecord(kymRecord);
        }

        function handleCallSubmit(e) {
            e.preventDefault();

            const callRecord = {
                id: Date.now(),
                truemoneyId: document.getElementById('callTruemoneyId').value,
                storeName: document.getElementById('callStoreName').value,
                contactNumber: document.getElementById('contactNumber').value,
                contactName: document.getElementById('contactName').value,
                callReason: document.getElementById('callReason').value === 'อื่นๆ' ?
                    document.getElementById('otherReason').value :
                    document.getElementById('callReason').value,
                callResult: document.getElementById('callResult').value,
                callDetails: document.getElementById('callDetails').value,
                caseStatus: document.getElementById('caseStatus').value,
                rescheduleDateTime: document.getElementById('rescheduleDateTime').value,
                followUpDate: document.getElementById('followUpDate').value,
                nextCallTimeSlot: document.getElementById('nextCallTimeSlot').value,
                retryCallDate: document.getElementById('retryCallDate').value,
                retryTimeSlot: document.getElementById('retryTimeSlot').value,
                retryNotes: document.getElementById('retryNotes').value,
                activities: [],
                operator: currentUser.username,
                operatorName: currentUser.name,
                timestamp: new Date().toISOString()
            };

            Swal.fire({
                icon: 'info',
                title: 'กำลังบันทึก...',
                allowOutsideClick: false,
                customClass: {
                    popup: 'rounded-2xl'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            console.log(callRecord);

            google.script.run
                .withSuccessHandler(async function (result) {
                    result = JSON.parse(result);
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'บันทึกการโทรออกสำเร็จ',
                            text: 'กำลังโหลดข้อมูลใหม่...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            },
                            customClass: {
                                popup: 'rounded-2xl'
                            }
                        });
                        await loadPendingCases();
                        if (currentUser && (currentUser.role === 'Supervisor' || currentUser.role === 'Admin')) {
                            updateDashboard();
                        }
                        clearCallForm();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: result.error,
                            allowOutsideClick: false,
                            confirmButtonColor: '#FF6B35',
                            customClass: {
                                popup: 'rounded-2xl'
                            }
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Call submit error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถบันทึกการโทรออกได้: ' + error.message,
                        allowOutsideClick: false,
                        confirmButtonColor: '#FF6B35',
                        customClass: {
                            popup: 'rounded-2xl'
                        }
                    });
                })
                .saveCallLog(callRecord);
        }

        // Download functions
        function downloadCallReport(periodType, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);

            // Filter call data by date range
            const filteredCallData = callData.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate >= start && recordDate <= end;
            });

            if (filteredCallData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลการโทรในช่วงเวลาที่เลือก',
                    allowOutsideClick: false,
                    confirmButtonColor: '#FF6B35',
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
                return;
            }

            // Calculate statistics
            const stats = {
                total: filteredCallData.length,
                contacted: filteredCallData.filter(r => r.callResult === 'ติดต่อได้').length,
                pending: filteredCallData.filter(r => r.caseStatus === 'Pending').length,
                closed: filteredCallData.filter(r => r.caseStatus === 'Closed').length,
                noAnswer: filteredCallData.filter(r => r.callResult === 'ไม่รับสาย').length,
                wrongNumber: filteredCallData.filter(r => r.callResult === 'เบอร์ผิด').length,
                phoneOff: filteredCallData.filter(r => r.callResult === 'ปิดเครื่อง').length
            };

            // Generate period label
            let periodLabel = '';
            switch (periodType) {
                case 'today':
                    periodLabel = 'วันนี้';
                    break;
                case '7days':
                    periodLabel = '7 วันย้อนหลัง';
                    break;
                case '30days':
                    periodLabel = '30 วันย้อนหลัง';
                    break;
                case 'custom':
                    periodLabel = `${start.toLocaleDateString('th-TH')} - ${end.toLocaleDateString('th-TH')}`;
                    break;
            }

            // Create report content
            const reportContent = `
รายงานสถิติการโทรออก - ${periodLabel}
สร้างเมื่อ: ${new Date().toLocaleString('th-TH')}
ผู้สร้างรายงาน: ${currentUser.name}

=== สรุปผล ===
การโทรทั้งหมด: ${stats.total} ครั้ง
ติดต่อได้: ${stats.contacted} ครั้ง (${stats.total > 0 ? Math.round((stats.contacted / stats.total) * 100) : 0}%)
ไม่รับสาย: ${stats.noAnswer} ครั้ง (${stats.total > 0 ? Math.round((stats.noAnswer / stats.total) * 100) : 0}%)
เบอร์ผิด: ${stats.wrongNumber} ครั้ง (${stats.total > 0 ? Math.round((stats.wrongNumber / stats.total) * 100) : 0}%)
ปิดเครื่อง: ${stats.phoneOff} ครั้ง (${stats.total > 0 ? Math.round((stats.phoneOff / stats.total) * 100) : 0}%)

=== สถานะเคส ===
รอติดตาม: ${stats.pending} เคส (${stats.total > 0 ? Math.round((stats.pending / stats.total) * 100) : 0}%)
ปิดเคสแล้ว: ${stats.closed} เคส (${stats.total > 0 ? Math.round((stats.closed / stats.total) * 100) : 0}%)

=== อัตราสำเร็จ ===
อัตราการติดต่อสำเร็จ: ${stats.total > 0 ? Math.round((stats.contacted / stats.total) * 100) : 0}%
อัตราการปิดเคส: ${stats.total > 0 ? Math.round((stats.closed / stats.total) * 100) : 0}%

=== รายละเอียดตามพนักงาน ===
${generateOperatorCallStats(filteredCallData)}
            `.trim();

            // Download as text file
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `รายงานการโทรออก_${periodLabel.replace(/[\/\s]/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            Swal.fire({
                icon: 'success',
                title: 'ดาวน์โหลดสำเร็จ',
                text: 'ไฟล์รายงานได้รับการดาวน์โหลดแล้ว',
                timer: 2000,
                allowOutsideClick: false,
                showConfirmButton: false
            });
        }

        function generateOperatorCallStats(callData) {
            const operatorStats = {};

            callData.forEach(record => {
                if (!operatorStats[record.operatorName]) {
                    operatorStats[record.operatorName] = {
                        name: record.operatorName,
                        total: 0,
                        contacted: 0,
                        pending: 0,
                        closed: 0
                    };
                }

                operatorStats[record.operatorName].total++;
                if (record.callResult === 'ติดต่อได้') operatorStats[record.operatorName].contacted++;
                if (record.caseStatus === 'Pending') operatorStats[record.operatorName].pending++;
                if (record.caseStatus === 'Closed') operatorStats[record.operatorName].closed++;
            });

            const operators = Object.values(operatorStats)
                .sort((a, b) => b.total - a.total);

            return operators.map(op => {
                const successRate = op.total > 0 ? Math.round((op.contacted / op.total) * 100) : 0;
                return `${op.name}: ${op.total} ครั้ง, ติดต่อได้ ${op.contacted} ครั้ง (${successRate}%), Pending ${op.pending} เคส`;
            }).join('\n');
        }

        function generateCallResultsBreakdown(callData) {
            const results = {};

            callData.forEach(record => {
                const result = record.callResult;
                if (!results[result]) {
                    results[result] = 0;
                }
                results[result]++;
            });

            const total = callData.length;
            const resultEntries = Object.entries(results).sort((a, b) => b[1] - a[1]);

            return resultEntries.map(([result, count]) => {
                const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                const colorClass = getResultColorClass(result);

                return `
                    <div class="text-center p-3 ${colorClass.bg} rounded-lg border ${colorClass.border}">
                        <div class="text-lg font-bold ${colorClass.text}">${count}</div>
                        <div class="text-xs ${colorClass.textSecondary} font-medium">${result}</div>
                        <div class="text-xs ${colorClass.textSecondary}">${percentage}%</div>
                    </div>
                `;
            }).join('');
        }

        function getResultColorClass(result) {
            switch (result) {
                case 'ติดต่อได้':
                    return {
                        bg: 'bg-green-50',
                        border: 'border-green-200',
                        text: 'text-green-600',
                        textSecondary: 'text-green-500'
                    };
                case 'ไม่รับสาย':
                    return {
                        bg: 'bg-yellow-50',
                        border: 'border-yellow-200',
                        text: 'text-yellow-600',
                        textSecondary: 'text-yellow-500'
                    };
                case 'เบอร์ผิด':
                    return {
                        bg: 'bg-red-50',
                        border: 'border-red-200',
                        text: 'text-red-600',
                        textSecondary: 'text-red-500'
                    };
                case 'ปิดเครื่อง':
                    return {
                        bg: 'bg-orange-50',
                        border: 'border-orange-200',
                        text: 'text-orange-600',
                        textSecondary: 'text-orange-500'
                    };
                case 'ไม่สะดวก':
                    return {
                        bg: 'bg-purple-50',
                        border: 'border-purple-200',
                        text: 'text-purple-600',
                        textSecondary: 'text-purple-500'
                    };
                case 'ติดต่อไม่ได้':
                    return {
                        bg: 'bg-gray-50',
                        border: 'border-gray-200',
                        text: 'text-gray-600',
                        textSecondary: 'text-gray-500'
                    };
                default:
                    return {
                        bg: 'bg-blue-50',
                        border: 'border-blue-200',
                        text: 'text-blue-600',
                        textSecondary: 'text-blue-500'
                    };
            }
        }

        function downloadCallDetailsCSV(periodType, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);

            // Filter call data by date range
            const filteredCallData = callData.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate >= start && recordDate <= end;
            });

            if (filteredCallData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลการโทรในช่วงเวลาที่เลือก',
                    allowOutsideClick: false,
                    confirmButtonColor: '#FF6B35',
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
                return;
            }

            // Generate period label
            let periodLabel = '';
            switch (periodType) {
                case 'today':
                    periodLabel = 'วันนี้';
                    break;
                case '7days':
                    periodLabel = '7 วันย้อนหลัง';
                    break;
                case '30days':
                    periodLabel = '30 วันย้อนหลัง';
                    break;
                case 'custom':
                    periodLabel = `${start.toLocaleDateString('th-TH')} - ${end.toLocaleDateString('th-TH')}`;
                    break;
            }

            // Create CSV content
            const headers = [
                'วันที่',
                'เวลา',
                'หมายเลขทรูมันนี่',
                'ชื่อร้านค้า',
                'เบอร์ติดต่อ',
                'ชื่อผู้ติดต่อ',
                'เหตุผลที่โทร',
                'ผลการโทร',
                'รายละเอียดการโทร',
                'สถานะเคส',
                'วันที่ติดตามครั้งต่อไป',
                'ช่วงเวลาที่แนะนำ',
                'ผู้ดำเนินการ',
                'จำนวนการโทรติดตาม'
            ];

            const csvContent = [
                headers.join(','),
                ...filteredCallData.map(record => {
                    const date = new Date(record.timestamp);
                    const followUpCount = record.activities ? record.activities.length : 0;

                    return [
                        `"${date.toLocaleDateString('th-TH')}"`,
                        `"${date.toLocaleTimeString('th-TH')}"`,
                        `"${record.truemoneyId}"`,
                        `"${record.storeName || 'ไม่ระบุ'}"`,
                        `"${record.contactNumber || 'ไม่ระบุ'}"`,
                        `"${record.contactName || 'ไม่ระบุ'}"`,
                        `"${record.callReason}"`,
                        `"${record.callResult}"`,
                        `"${record.callDetails.replace(/"/g, '""')}"`,
                        `"${record.caseStatus === 'Pending' ? 'รอติดตาม' : 'ปิดเคส'}"`,
                        `"${record.followUpDate ? new Date(record.followUpDate).toLocaleString('th-TH') : 'ไม่มี'}"`,
                        `"${record.nextCallTimeSlot || record.retryTimeSlot || 'ไม่ระบุ'}"`,
                        `"${record.operatorName}"`,
                        `"${followUpCount}"`
                    ].join(',');
                })
            ].join('\n');

            // Add BOM for proper Thai character display in Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `รายละเอียดการโทรออก_${periodLabel.replace(/[\/\s]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            Swal.fire({
                icon: 'success',
                title: 'ดาวน์โหลดสำเร็จ',
                text: 'ไฟล์ CSV ได้รับการดาวน์โหลดแล้ว',
                timer: 2000,
                allowOutsideClick: false,
                showConfirmButton: false,
                confirmButtonColor: '#FF6B35',
                customClass: {
                    popup: 'rounded-2xl'
                }
            });
        }

        function downloadKymDetailsCSV(periodType, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);

            // Filter KYM data by date range
            const filteredKymData = kymData.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate >= start && recordDate <= end;
            });

            if (filteredKymData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูล KYM ในช่วงเวลาที่เลือก',
                    allowOutsideClick: false,
                    confirmButtonColor: '#FF6B35',
                    customClass: {
                        popup: 'rounded-2xl'
                    }
                });
                return;
            }

            // Generate period label
            let periodLabel = '';
            switch (periodType) {
                case 'today':
                    periodLabel = 'วันนี้';
                    break;
                case '7days':
                    periodLabel = '7 วันย้อนหลัง';
                    break;
                case '30days':
                    periodLabel = '30 วันย้อนหลัง';
                    break;
                case 'custom':
                    periodLabel = `${start.toLocaleDateString('th-TH')} - ${end.toLocaleDateString('th-TH')}`;
                    break;
            }

            // Create CSV content
            const headers = [
                'วันที่',
                'เวลา',
                'หมายเลขทรูมันนี่',
                'ชื่อร้านค้า',
                'ช่องทางการขาย',
                'หมวดหมู่หลัก',
                'หมวดหมู่ย่อย',
                'รูปร้านค้าจริง',
                'ประเภทสินค้า/บริการ',
                'ชื่อร้านค้า',
                'ใบทะเบียนพาณิชย์',
                'ใบประกอบวิชาชีพ',
                'ร้านค้าต้องห้าม',
                'สมัครซ้ำ',
                'ระบบแนะนำ',
                'สถานะ',
                'เหตุผล',
                'หมายเหตุ',
                'ผู้ดำเนินการ'
            ];

            const csvContent = [
                headers.join(','),
                ...filteredKymData.map(record => {
                    const date = new Date(record.timestamp);

                    // Calculate recommended status
                    let recommendedStatus = 'N/A';
                    if (record.assessment) {
                        const { prohibitedStore, repeatApplication, storePhoto, productService, storeNameCheck, professionalLicense } = record.assessment;

                        if (prohibitedStore || repeatApplication) {
                            recommendedStatus = 'Rejected';
                        } else {
                            const requiredItems = [storePhoto, productService, storeNameCheck];
                            const licenseRequired = record.subCategory && (
                                record.subCategory.includes('คลินิก') ||
                                record.subCategory.includes('ทันตกรรม') ||
                                record.subCategory.includes('นวด') ||
                                record.subCategory.includes('สถาบันเสริมความงาม') ||
                                record.subCategory.includes('ทัศนมาตร') ||
                                record.subCategory.includes('ขายยา') ||
                                record.subCategory.includes('สัตวแพทย์')
                            );

                            if (licenseRequired) {
                                requiredItems.push(professionalLicense);
                            }

                            const missingRequired = requiredItems.filter(item => !item);
                            recommendedStatus = missingRequired.length > 0 ? 'Revised' : 'Approved';
                        }
                    }

                    return [
                        `"${date.toLocaleDateString('th-TH')}"`,
                        `"${date.toLocaleTimeString('th-TH')}"`,
                        `"${record.truemoneyId}"`,
                        `"${record.storeName}"`,
                        `"${record.salesChannel}"`,
                        `"${record.category}"`,
                        `"${record.subCategory}"`,
                        `"${record.assessment?.storePhoto ? 'ผ่าน' : 'ไม่ผ่าน'}"`,
                        `"${record.assessment?.productService ? 'ผ่าน' : 'ไม่ผ่าน'}"`,
                        `"${record.assessment?.storeNameCheck ? 'ผ่าน' : 'ไม่ผ่าน'}"`,
                        `"${record.assessment?.businessReg ? 'มี' : 'ไม่มี'}"`,
                        `"${record.assessment?.professionalLicense ? 'มี' : 'ไม่มี'}"`,
                        `"${record.assessment?.prohibitedStore ? 'ใช่' : 'ไม่ใช่'}"`,
                        `"${record.assessment?.repeatApplication ? 'ใช่' : 'ไม่ใช่'}"`,
                        `"${recommendedStatus}"`,
                        `"${record.status}"`,
                        `"${record.reason || 'ไม่มี'}"`,
                        `"${record.notes || 'ไม่มี'}"`,
                        `"${record.operatorName}"`
                    ].join(',');
                })
            ].join('\n');

            // Add BOM for proper Thai character display in Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `รายละเอียด_KYM_${periodLabel.replace(/[\/\s]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            Swal.fire({
                icon: 'success',
                title: 'ดาวน์โหลดสำเร็จ',
                text: 'ไฟล์ CSV ได้รับการดาวน์โหลดแล้ว',
                timer: 2000,
                allowOutsideClick: false,
                showConfirmButton: false,
                confirmButtonColor: '#FF6B35',
                customClass: {
                    popup: 'rounded-2xl'
                }
            });
        }
    </script>
    <!-- <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'98a506cf056225e5',t:'MTc1OTc1MjMyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script> -->
</body>

</html>