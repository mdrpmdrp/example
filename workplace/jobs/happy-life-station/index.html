<!DOCTYPE html>
<html lang="en">

<head>
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบฟอร์มส่งรายละเอียดสั่งสินค้า</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .bg-red-subtle {
            background-color: #f8d7da;
        }

        .text-red {
            color: #dc3545;
        }

        .container {
            max-width: 600px;
        }
    </style>

</head>

<body class="bg-light">
    <nav class="navbar bg-danger-subtle navbar-light m-0 py-1">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://img2.pic.in.th/pic/-1920-x-1920-6.png" alt="Logo" height="40"
                    class="d-inline-block align-text-top">
            </a>
        </div>
    </nav>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="text-center mt-3 h4 text-red fw-bold">แบบฟอร์มส่งรายละเอียดสั่งสินค้า</div>
            </div>
        </div>
        <main>
            <form id="mainform" class="needs-validation" novalidate>
                <div class="row g-3 mt-3">
                    <div class="col-12 text-center d-none">
                        <div class="d-flex flex-column align-items-center justify-content-center">
                            <img src="" alt="User Avatar" class="rounded-circle" id="userAvatar" width="100" height="100">
                            <span id="username" class="fw-bold rounded-pill text-bg-danger px-2 mt-2"></span>
                        </div>
                    </div>
                    <div class="col-12">
                        <label for="platform">
                            <i class="bi bi-cart-fill text-red"></i>
                            ช่องทางการสั่งซื้อ</label>
                        <select class="form-select rounded-3" id="platform" name="platform"  required>
                            <option value="">เลือกช่องทางการสั่งซื้อ</option>
                            <option value="shopee">Shopee</option>
                            <option value="lazada">Lazada</option>
                            <option value="facebook">Facebook</option>
                            <option value="line">Line</option>
                            <option value="website">Website</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="orderNumber">
                            <i class="bi bi-clipboard-data-fill text-red"></i>
                            เลขออเดอร์</label>
                        <input type="text" class="form-control rounded-3" id="orderNumber" name="orderNumber"
                             required>
                    </div>
                    <div class="col-12">
                        <label for="cus_name">
                            <i class="bi bi-person-fill text-red"></i>
                            ชื่อลูกค้าในไลน์ @</label>
                        <input type="text" class="form-control rounded-3" id="cus_name" name="cus_name"  required>
                    </div>
                    <div class="col-12">
                        <label for="phone">
                            <i class="bi bi-telephone-fill text-red"></i>
                            เบอร์โทรศัพท์</label>
                        <input type="text" class="form-control rounded-3" id="phone" name="phone"  required>
                    </div>
                    <div class="col-12">
                        <label for="detail">
                            <i class="bi bi-file-earmark-richtext-fill text-red"></i>
                            รายละเอียด</label>
                        <textarea class="form-control rounded-3" id="detail" name="detail" rows="5"
                             required></textarea>
                    </div>
                    <div class="col-12">
                        <label for="remark">
                            <i class="bi bi-chat-left-text-fill text-red"></i>
                            หมายเหตุ</label>
                        <input type="text" class="form-control rounded-3" id="remark" name="remark">
                    </div>
                    <div class="col-12">
                        <label for="image">
                            <i class="bi bi-image-fill text-red"></i>
                            รูปภาพ</label>
                        <input type="file" class="form-control rounded-3" id="image" name="image" accept="image/*">
                        </label>
                    </div>
                    <div class="col-12 text-center">
                        <img id="preview" class="img-fluid rounded-3 mt-2" src="" alt="" style="max-height: 300px;">
                    </div>
                </div>
                <div class="row mb-5">
                    <div class="col-12">
                        <button type="submit" class="btn btn-danger rounded-3 w-100 mt-3">
                            ส่งข้อมูล
                            <i class="bi bi-hand-index-thumb-fill"></i>
                        </button>
                    </div>
                </div>
            </form>
        </main>
    </div>
    <script>
        const scripturl = 'https://script.google.com/macros/s/AKfycbz5-_0D8_cNqfVK6MvfZw78cWPcqgn2pqBxRCcGYKK7HVzuslmqivD3NW1ToLRQtzI/exec'
        $(document).ready(function () {
            liff.init({ liffId: '1655873446-3xe866Ql' })
            liff.ready.then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return
                }
                liff.getProfile().then(profile => {
                    $('#username').text(profile.displayName);
                    $('#cus_name').val(profile.displayName);
                    $('#userAvatar').attr('src', profile.pictureUrl);
                    setTimeout(() => {
                        $('.d-none').removeClass('d-none');
                    }, 1000);
                })
            })
        });

        $('#image').change(function (e) {
            var file = e.target.files[0];
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#preview').attr({
                    'src': e.target.result,
                    'data-name': file.name,
                    'data-size': file.size,
                    'data-type': file.type
                })
            }
            reader.readAsDataURL(file);
        });

        function submit() {
            if($('#image').val() == '') {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณาเลือกรูปภาพ',
                    customClass: {
                        icon: 'text-danger',
                        title: 'text-danger',
                        content: 'text-dark',
                        popup: 'rounded-4'
                    },
                    confirmButtonText: 'ปิด',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    allowEnterKey: false,
                })
                return false;
            }
            uploadFiles().then((res) => {
                let data = $('#mainform').serializeArray().reduce((obj, item) => {
                    obj[item.name] = item.value;
                    return obj;
                }, { fileId: res.id, opt: 'submit'});
                data.uid = liff.getDecodedIDToken().sub;
                data.profile = $('#username').text().trim();
                data.picture = $('#userAvatar').attr('src');
                console.log(data);
                Swal.fire({
                    iconHtml: '<i class="bi bi-hourglass-split text-danger"></i>',
                    title: 'กำลังส่งข้อมูล',
                    customClass: {
                        icon: 'border-0',
                        title: 'text-danger',
                        content: 'text-dark',
                        popup: 'rounded-4'
                    },
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading()
                    },
                })
                $.post(scripturl, data, function(response) {
                    success()
                    Swal.fire({
                        icon: 'success',
                        title: 'ส่งข้อมูลสำเร็จ',
                        text: 'ขอบคุณที่ใช้บริการ',
                        customClass: {
                            icon: 'text-success',
                            title: 'text-success',
                            content: 'text-dark',
                            popup: 'rounded-4'
                        },
                        confirmButtonText: 'ปิด',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false,
                    })
                }).fail(function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'กรุณาลองใหม่อีกครั้ง',
                        customClass: {
                            icon: 'text-danger',
                            title: 'text-danger',
                            content: 'text-dark',
                            popup: 'rounded-4'
                        },
                        confirmButtonText: 'ปิด',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false,
                    })
                });
            });
        }

        async function uploadFiles() {
            Swal.fire({
                iconHtml: '<i class="bi bi-cloud-arrow-up-fill text-danger"></i>',
                title: 'กำลังอัพโหลดไฟล์',
                customClass: {
                    icon: 'border-0',
                    title: 'text-danger',
                    content: 'text-dark',
                    popup: 'rounded-4'
                },
                allowOutsideClick: false,
                html: '<div class="container-fluid"><div class="row" id="progress"></div></div>',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                },
            })
            const { token, folder_id } = await getDownloadToken();
            const f = document.getElementById("image");
            if (f.files.length == 0) {
                return false
            }
            let file = await new Promise((resolve, reject) => {
                let length = f.files.length;
                let count = 0;
                [...f.files].forEach((file, i) => {
                    let fr = new FileReader();
                    fr.fileName = file.name;
                    fr.fileSize = file.size;
                    fr.fileType = file.type;
                    fr.readAsArrayBuffer(file);
                    fr.onload = e => {
                        var id = "p" + ++i;
                        var div = $("<div>", { class: 'col-12 text-truncate' });
                        div.attr("id", id);
                        $("#progress").append(div);
                        $('#' + id).text('Initialising (' + fr.fileName + ')')
                        const f = e.target;
                        const resource = {
                            fileName: f.fileName,
                            fileSize: f.fileSize,
                            fileType: f.fileType,
                            fileBuffer: f.result,
                            accessToken: token,
                            folderId: folder_id,
                            fields: "id",
                        };
                        const ru = new ResumableUploadToGoogleDrive();
                        ru.Do(resource, function (res, err) {
                            if (err) {
                                console.log(err);
                                return;
                            }
                            console.log(res);
                            let msg = "";
                            if (res.status == 'start' || res.status == 'getLocation' || res.status == 'initialize') {
                                msg = '<i class="bi bi-cloud-arrow-up-fill"></i> กำลังเตรียมอัพโหลด ' + f.fileName;
                            }
                            else if (res.status == "Uploading") {
                                msg =
                                    '<i class="bi bi-hourglass-split text-info"></i> กำลังอัพโหลด ' +
                                    Math.round(
                                        (res.progressNumber.current / res.progressNumber.end) * 100
                                    ) +
                                    "% (" +
                                    f.fileName +
                                    ")";
                            } else {
                                msg = '<i class="bi bi-check-circle-fill text-success"></i> อัพโหลดสำเร็จ  (' + f.fileName + ")";
                            }

                            // If you want to put the uploaded file information to the active Spreadsheet,
                            // please use the following function.
                            if (res.status == "Done") {
                                count++;
                                if (count == length) {
                                    resolve({
                                        id: res.result.id,
                                    });
                                }
                            }

                            $('#' + id).html(msg)
                        });
                    };
                });
            });
            return file;
        }

        function getDownloadToken() {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: scripturl + '?opt=token',
                    type: 'GET',
                    success: function (data) {
                        console.log("🚀 ~ returnnewPromise ~ data:", data)
                        resolve(data);
                    },
                    error: function (error) {
                        reject(error);
                    }
                });
            });
        }

        function success() {
            $('main').html('')
            $('main').append(`
            <div class="row">
                <div class="col-12 text-center">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 100px;"></i>
                    <h3 class="text-success">ส่งข้อมูลสำเร็จ</h3>
                    <p>ขอบคุณที่ใช้บริการ</p>
                </div>
            </div>
            `)
        }
    </script>
    <script>
        (function () {
            'use strict'

            var forms = document.querySelectorAll('.needs-validation')

            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        event.preventDefault()
                        if (!form.checkValidity()) {
                            event.stopPropagation()
                            form.classList.add('was-validated')
                            $(form).find(':invalid').first().focus();
                        } else {
                            submit()
                        }
                    }, false)
                })
        })()
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/tanaikech/ResumableUploadForGoogleDrive_js@master/resumableupload_js.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js">
    </script>
    <script> // VConsole will be exported to `window.VConsole` by default.
        var vConsole = new window.VConsole();
    </script> -->
</body>

</html>