<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการข้อมูล Complain</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- โหลด Tom Select (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">

    <style>
        * {
            font-family: 'Kanit', sans-serif;
        }

        /* SweetAlert2 Custom Styles - More Rounded */
        .swal2-popup {
            border-radius: 2rem !important;
            padding: 2rem !important;
        }

        .swal2-title {
            font-family: 'Kanit', sans-serif !important;
            border-radius: 1.5rem !important;
        }

        .swal2-html-container {
            font-family: 'Kanit', sans-serif !important;
        }

        .swal2-confirm,
        .swal2-cancel,
        .swal2-deny {
            border-radius: 1.5rem !important;
            padding: 0.75rem 2rem !important;
            font-family: 'Kanit', sans-serif !important;
            font-weight: 500 !important;
            transition: all 0.3s ease !important;
        }

        .swal2-confirm:hover,
        .swal2-cancel:hover,
        .swal2-deny:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
        }

        .swal2-icon {
            border-radius: 50% !important;
        }

        .swal2-input,
        .swal2-textarea {
            border-radius: 1rem !important;
            border: 1px solid rgba(209, 213, 219, 0.5) !important;
            font-family: 'Kanit', sans-serif !important;
            transition: all 0.3s ease !important;
        }

        .swal2-input:focus,
        .swal2-textarea:focus {
            border-color: #374151 !important;
            box-shadow: 0 0 0 4px rgba(55, 65, 81, 0.1) !important;
        }

        .swal2-validation-message {
            border-radius: 1rem !important;
            font-family: 'Kanit', sans-serif !important;
        }

        .swal2-progress-steps .swal2-progress-step {
            border-radius: 50% !important;
        }

        .swal2-progress-steps .swal2-progress-step-line {
            border-radius: 1rem !important;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        .card-minimal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(209, 213, 219, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .card-minimal:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: rgba(55, 65, 81, 0.2);
        }

        .severity-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }

        .severity-yellow {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.3);
        }

        .severity-red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            color: white;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
            font-weight: 600;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            border: 2px solid rgba(209, 213, 219, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            font-weight: 500;
        }

        .btn-secondary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
            font-weight: 600;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 12px 20px -3px rgba(16, 185, 129, 0.5);
        }

        .btn-success:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 4px -1px rgba(16, 185, 129, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.3);
            font-weight: 600;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 12px 20px -3px rgba(245, 158, 11, 0.5);
        }

        .btn-warning:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 4px -1px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
            font-weight: 600;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 12px 20px -3px rgba(239, 68, 68, 0.5);
        }

        .btn-danger:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 4px -1px rgba(239, 68, 68, 0.3);
        }

        .input-minimal {
            border: 1px solid rgba(209, 213, 219, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .input-minimal:focus {
            border-color: #374151;
            box-shadow: 0 0 0 4px rgba(55, 65, 81, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }

        .input-minimal:hover {
            border-color: rgba(156, 163, 175, 0.8);
        }

        /* Select dropdown arrow spacing */
        select.input-minimal {
            padding-right: 2.5rem !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23374151' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .slide-in {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
            }

            to {
                transform: translateY(0);
            }
        }

        .table-row-hover {
            transition: all 0.2s ease;
        }

        .table-row-hover:hover {
            background: #f9fafb;
        }

        .highlighted {
            background: #fef3c7 !important;
            animation: highlight-pulse 2s ease-in-out;
            transition: all 0.3s ease;
        }

        @keyframes highlight-pulse {
            0% {
                background: #fef3c7;
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
            }

            50% {
                background: #fde68a;
                box-shadow: 0 0 0 10px rgba(251, 191, 36, 0);
            }

            100% {
                background: #fef3c7;
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .gray-accent {
            color: #374151;
        }

        .gray-bg {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .gray-light-bg {
            background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
        }

        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.98);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                transform: translateY(10px);
            }

            to {
                transform: translateY(0);
            }
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-4px) scale(1.01);
        }

        /* Editing mode styles */
        #formSection.editing {
            border: 2px solid #3b82f6 !important;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, rgba(239, 246, 255, 0.95) 0%, rgba(219, 234, 254, 0.95) 100%);
        }

        #formSection.editing::before {
            content: '✏️ โหมดแก้ไข';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 0.375rem 1.25rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
            z-index: 10;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-10px);
            }

            to {
                transform: translateX(-50%) translateY(0);
            }
        }

        #formSection.editing .icon-container-mobile {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            animation: pulse 2s ease-in-out infinite;
        }

        #formSection.editing h2 {
            color: #2563eb !important;
        }

        /* Pipeline Stepper Styles */
        .pipeline-stepper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            padding: 1rem 0;
        }

        .pipeline-stepper::before {
            content: '';
            position: absolute;
            top: 45%;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, #e5e7eb 0%, #d1d5db 100%);
            transform: translateY(-50%);
            z-index: 0;
        }

        .pipeline-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pipeline-step:hover .step-circle {
            transform: scale(1.15);
        }

        .step-circle {
            width: 5rem;
            height: 5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 3px solid #e5e7eb;
            font-size: 1.25rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.5rem;
        }

        .step-circle:hover {
            /* make circle bigger on hover */
            transform: scale(1.15);
        }

        .step-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-align: center;
            max-width: 100px;
            transition: all 0.3s ease;
        }

        /* Reported Step (Blue) */
        .pipeline-step.reported .step-circle {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #2563eb;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .pipeline-step.reported .step-label {
            color: #2563eb;
            font-weight: 600;
        }

        /* In Progress Step (Orange) */
        .pipeline-step.in_progress .step-circle {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-color: #f59e0b;
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .pipeline-step.in_progress .step-label {
            color: #f59e0b;
            font-weight: 600;
        }

        /* Pending Close Step (Orange) */
        .pipeline-step.pending_close .step-circle {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-color: #fbbf24;
            color: white;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .pipeline-step.pending_close .step-label {
            color: #fbbf24;
            font-weight: 600;
        }

        /* Closed Step (Green) */
        .pipeline-step.closed .step-circle {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .pipeline-step.closed .step-label {
            color: #10b981;
            font-weight: 600;
        }


        /* Hover effects for inactive steps */
        .pipeline-step:not(.reported):not(.in_progress):not(.pending_close):not(.closed):hover .step-circle {
            border-color: #9ca3af;
            background: #f9fafb;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .pipeline-step:not(.reported):not(.in_progress):not(.pending_close):not(.closed):hover .step-label {
            color: #374151;
        }

        /* Hidden input for form submission */
        #pipelineValue {
            display: none;
        }

        /* Solution Cards Styles */
        .solution-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(209, 213, 219, 0.5);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .solution-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .solution-card .solution-number {
            position: absolute;
            top: -12px;
            left: 1rem;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .solution-card .delete-solution {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .solution-card .delete-solution:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .solution-card .edit-solution {
            position: absolute;
            top: 0.5rem;
            right: 3rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .solution-card .edit-solution:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .solution-empty-state {
            text-align: center;
            padding: 2rem;
            color: #9ca3af;
            font-size: 0.875rem;
        }

        /* Custom scrollbar styles */
        .scrollbar-thin {
            scrollbar-width: thin;
        }

        .scrollbar-thumb-gray-300::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 6px;
        }

        .scrollbar-track-gray-100::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }

        .scrollbar-thin::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .gradient-bg {
                padding: 0 !important;
            }

            .container {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            .card-minimal {
                border-radius: 1.5rem !important;
                padding: 1.5rem !important;
                margin-bottom: 1.5rem !important;
            }

            h1 {
                font-size: 1.75rem !important;
                line-height: 2rem !important;
            }

            h2 {
                font-size: 1.5rem !important;
                line-height: 1.75rem !important;
            }

            .btn-primary,
            .btn-secondary,
            .btn-success,
            .btn-warning,
            .btn-danger {
                padding: 0.75rem 1.25rem !important;
                font-size: 0.875rem !important;
                min-height: 44px;
            }

            .input-minimal {
                padding: 0.875rem 1rem !important;
                font-size: 1rem !important;
                min-height: 44px;
            }

            /* Stack navigation tabs vertically on mobile */
            .nav-tabs-mobile {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }

            .nav-tabs-mobile button {
                width: 100% !important;
                justify-content: center !important;
            }

            /* Form grid to single column */
            .form-grid-mobile {
                grid-template-columns: 1fr !important;
            }

            /* Search and action buttons stack */
            .action-buttons-mobile {
                flex-direction: column !important;
                width: 100% !important;
            }

            .action-buttons-mobile>* {
                width: 100% !important;
            }

            .action-buttons-mobile input {
                width: 100% !important;
            }

            /* Icon containers smaller on mobile */
            .icon-container-mobile {
                width: 3rem !important;
                height: 3rem !important;
            }

            .icon-container-mobile i {
                font-size: 1rem !important;
            }

            /* Table improvements */
            .table-container {
                font-size: 0.75rem !important;
            }

            .table-container th,
            .table-container td {
                padding: 0.5rem !important;
                white-space: nowrap;
            }

            .mobile-table-hint {
                background: linear-gradient(90deg, transparent, #f3f4f6 50%, transparent);
                animation: shimmer 2s infinite;
            }

            /* Report grid to single column */
            .report-grid-mobile {
                grid-template-columns: 1fr !important;
            }

            /* Pipeline stepper mobile - improved layout */
            .pipeline-stepper {
                flex-direction: column;
                gap: 0.75rem;
                padding: 0.5rem 0;
                position: relative;
                width: 100%;
            }

            .pipeline-stepper::before {
                content: '';
                position: absolute;
                top: 0;
                left: 37px;
                width: 3px;
                height: 100%;
                background: linear-gradient(to bottom, #e5e7eb 0%, #d1d5db 100%);
                transform: translateX(-50%);
                z-index: 0;

            }

            .pipeline-step {
                flex-direction: row;
                justify-content: flex-start;
                align-items: center;
                padding: 0.75rem;
                background: rgba(255, 255, 255, 0.0);
                border-radius: 0.75rem;
                border: 2px solid transparent;
                margin-bottom: 0;
                transition: all 0.3s ease;
                width: 100%;
                position: relative;
                z-index: 1;
            }

            .pipeline-step:active {
                transform: scale(0.98);
            }

            .step-circle {
                width: 3rem;
                height: 3rem;
                font-size: 1.25rem;
                margin-bottom: 0;
                margin-right: 0.75rem;
                flex-shrink: 0;
            }

            .step-label {
                font-size: 0.875rem;
                text-align: left;
                max-width: none;
                flex: 1;
                font-weight: 500;
            }

            /* Active state backgrounds for mobile */
            .pipeline-step.reported {
                background: rgba(59, 130, 246, 0.1);
                border-color: rgba(59, 130, 246, 0.3);
            }

            .pipeline-step.in_progress {
                background: rgba(245, 158, 11, 0.1);
                border-color: rgba(245, 158, 11, 0.3);
            }

            .pipeline-step.pending_close {
                background: rgba(251, 191, 36, 0.1);
                border-color: rgba(251, 191, 36, 0.3);
            }

            .pipeline-step.closed {
                background: rgba(16, 185, 129, 0.1);
                border-color: rgba(16, 185, 129, 0.3);
            }

            /* Reduce spacing */
            .mb-10 {
                margin-bottom: 1.5rem !important;
            }

            .p-10 {
                padding: 1.5rem !important;
            }

            /* Header icon */
            .header-icon-mobile {
                width: 3.5rem !important;
                height: 3.5rem !important;
            }

            .header-icon-mobile i {
                font-size: 1.25rem !important;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }

            100% {
                background-position: 200px 0;
            }
        }
    </style>
</head>

<body class="gradient-bg min-h-screen">
    <!-- Modern Background Pattern -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-20 right-20 w-96 h-96 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 rounded-full blur-3xl animate-pulse"
            style="animation-duration: 4s;"></div>
        <div class="absolute bottom-20 left-20 w-80 h-80 bg-gradient-to-br from-blue-500/10 to-cyan-500/10 rounded-full blur-3xl animate-pulse"
            style="animation-duration: 6s; animation-delay: 1s;"></div>
        <div
            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-gradient-to-br from-gray-500/5 to-slate-500/5 rounded-full blur-2xl">
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- Header -->
        <div class="card-minimal rounded-3xl shadow-2xl p-10 mb-8 slide-in border-2 border-gray-100/50">
            <div class="text-center">
                <div
                    class="inline-flex items-center justify-center w-20 h-20 header-icon-mobile gray-bg rounded-3xl mb-6 transform hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                </div>
                <h1 class="text-4xl md:text-4xl font-bold text-gray-900 mb-3 tracking-tight">
                    ระบบจัดการข้อมูล Complain
                </h1>
                <p class="text-gray-600 text-base md:text-lg font-light">จัดการและติดตามข้อร้องเรียนอย่างมีประสิทธิภาพ
                </p>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex flex-col md:flex-row justify-center gap-3 mt-10 nav-tabs-mobile">
                <button onclick="showTab('form'); resetForm();" id="formTab"
                    class="tab-btn px-8 py-4 btn-primary rounded-2xl font-medium text-base flex items-center gap-3 transition-all duration-300 w-full md:w-auto">
                    <i class="fas fa-plus text-lg"></i>
                    <span>เพิ่มข้อมูล</span>
                </button>
                <button onclick="showTab('list')" id="listTab"
                    class="tab-btn px-8 py-4 btn-secondary rounded-2xl font-medium text-base flex items-center gap-3 transition-all duration-300 w-full md:w-auto hidden">
                    <i class="fas fa-list text-lg"></i>
                    <span>รายการข้อมูล</span>
                </button>
                <button onclick="showTab('report')" id="reportTab"
                    class="tab-btn px-8 py-4 btn-secondary rounded-2xl font-medium text-base flex items-center gap-3 transition-all duration-300 w-full md:w-auto hidden">
                    <i class="fas fa-chart-bar text-lg"></i>
                    <span>รายงาน</span>
                </button>
            </div>
        </div>

        <!-- Form Tab -->
        <div id="formSection"
            class="card-minimal rounded-3xl shadow-2xl p-10 mb-8 slide-in border-2 border-gray-100/50">
            <div class="flex items-center mb-10">
                <div
                    class="w-14 h-14 icon-container-mobile gray-bg rounded-2xl flex items-center justify-center mr-3 md:mr-5 transform hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-edit text-white text-xl"></i>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 tracking-tight">
                    <span id="formTitle">เพิ่มข้อมูล Complain ใหม่</span>
                </h2>
            </div>

            <form id="complainForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 form-grid-mobile">
                <input type="hidden" id="editId" value="">

                <!-- วันที่ -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-2 gray-accent"></i>วันที่
                    </label>
                    <input type="date" id="date"
                        class="w-full px-4 py-3 input-minimal rounded-lg font-medium bg-gray-900 text-gray-100">
                </div>

                <!-- weekOfYear -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-2 gray-accent"></i>Work Week
                    </label>
                    <input type="text" id="weekOfYear"
                        class="w-full px-4 py-3 input-minimal rounded-lg font-medium bg-gray-900 text-gray-100"
                        disabled>
                </div>

                <!-- สินค้า -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-box mr-2 gray-accent"></i>สินค้า
                    </label>

                    <select id="product" class="w-full px-4 py-3 input-minimal rounded-lg font-medium">
                        <option value="">— เลือกสินค้า —</option>
                    </select>
                </div>

                <!-- จำนวน -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-sort-numeric-up mr-2 gray-accent"></i>จำนวน
                    </label>
                    <input type="number" id="quantity" inputmode="numeric"
                        class="w-full px-4 py-3 input-minimal rounded-lg font-medium">
                </div>

                <!-- ร้านค้า -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-store mr-2 gray-accent"></i>ร้านค้า
                    </label>
                    <select id="store" class="w-full px-4 py-3 input-minimal rounded-lg font-medium">
                        <option value="">— เลือกร้านค้า —</option>
                    </select>
                </div>

                <!-- หน่วยสินค้า -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-box mr-2 gray-accent"></i>หน่วยสินค้า
                    </label>
                    <select id="unit" class="w-full px-4 py-3 input-minimal rounded-lg font-medium">
                        <option value="">— เลือกหน่วยสินค้า —</option>
                    </select>
                </div>

                <!-- ประเภท -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-tags mr-2 gray-accent"></i>ประเภท
                    </label>
                    <select id="type" class="w-full px-4 py-3 input-minimal rounded-lg font-medium">
                        <option value="">— เลือกประเภท —</option>
                    </select>
                </div>

                <!-- ความรุนแรง -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-exclamation-circle mr-2 gray-accent"></i>ความรุนแรง
                    </label>

                    <select id="severity"
                        class="w-full px-4 py-3 input-minimal rounded-lg font-medium transition-colors duration-300"
                        required>
                        <option value="">— เลือกความรุนแรง —</option>
                    </select>
                </div>

                <!-- มูลค่าเคลม (บาท) -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-dollar-sign mr-2 gray-accent"></i>มูลค่าเคลม (บาท)
                    </label>
                    <input type="number" id="claimValue" step="0.01" inputmode="decimal"
                        class="w-full px-4 py-3 input-minimal rounded-lg font-medium">
                </div>

                <!-- ทีมรับผิดชอบ -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-users mr-2 gray-accent"></i>ทีมรับผิดชอบ
                    </label>
                    <select id="responsibleTeam" class="w-full px-4 py-3 input-minimal rounded-lg font-medium">
                        <option value="">— เลือกทีมรับผิดชอบ —</option>
                    </select>
                </div>

                <!-- ชื่อตัวแทนทีม -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-2 gray-accent"></i>ชื่อตัวแทนทีม
                    </label>
                    <input type="text" id="teamRepresentative"
                        class="w-full px-4 py-3 input-minimal rounded-lg font-medium">
                </div>


                <!-- Pipeline -->
                <div class="space-y-2 md:col-span-2 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-route mr-2 gray-accent"></i>Pipeline การดำเนินงาน
                    </label>

                    <input type="hidden" id="pipelineValue" name="pipeline" value="reported">

                    <div class="pipeline-stepper">
                        <div class="pipeline-step reported" data-value="reported" onclick="selectPipelineStep(this)">
                            <div class="step-circle">
                                <i class="fas fa-flag fa-beat" style="animation-play-state: paused;"></i>
                            </div>
                            <div class="step-label">แจ้งเรื่อง</div>
                        </div>

                        <div class="pipeline-step" data-value="in_progress" onclick="selectPipelineStep(this)">
                            <div class="step-circle">
                                <i class="fas fa-cog fa-spin" style="animation-play-state: paused;"></i>
                            </div>
                            <div class="step-label">กำลังแก้ไข</div>
                        </div>

                        <div class="pipeline-step" data-value="pending_close" onclick="selectPipelineStep(this)">
                            <div class="step-circle">
                                <i class="fas fa-check-circle fa-beat" style="animation-play-state: paused;"></i>
                            </div>
                            <div class="step-label">รอปิดเคส</div>
                        </div>

                        <div class="pipeline-step" data-value="closed" onclick="selectPipelineStep(this)">
                            <div class="step-circle">
                                <i class="fas fa-check-double fa-beat" style="animation-play-state: paused;"></i>
                            </div>
                            <div class="step-label">ปิดเคสแล้ว</div>
                        </div>
                    </div>
                </div>

                <!-- ปัญหา -->
                <div class="space-y-2 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-exclamation-triangle mr-2 gray-accent"></i>ปัญหา
                    </label>
                    <textarea id="problem" class="w-full px-4 py-3 input-minimal rounded-lg font-medium"
                        rows="3"></textarea>
                </div>

                <!-- รูปภาพ -->
                <div class="space-y-2 md:col-span-2">
                    <template id="img-template">
                        <div class="flex justify-center items-center relative border rounded-lg mt-3">
                            <span
                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer hover:bg-red-600 transition-colors z-10 remove-image-btn">
                                <i class="fas fa-times text-xs"></i>
                            </span>
                            <div
                                class="pending-upload-overlay absolute inset-0 bg-black bg-opacity-40 rounded-lg flex items-center justify-center hidden">
                                <div class="text-center">
                                    <span class="text-white font-semibold text-sm">รออัพโหลด</span>
                                </div>
                            </div>
                            <img src="https://getbootstrap.com/docs/5.3/assets/brand/bootstrap-logo-shadow.png" alt=""
                                class="rounded-lg cursor-pointer max-w-full h-auto">
                        </div>
                    </template>

                    <label for="complainImage" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-image mr-2 gray-accent"></i>รูปภาพ
                        <span class="text-gray-500 text-sm">(สูงสุด 3 รูป)</span><br>
                    </label>

                    <div class="rounded-xl border-2 border-dashed border-gray-300 bg-gradient-to-br from-gray-50 to-gray-100 p-4 text-center cursor-pointer hover:border-gray-400 hover:bg-gradient-to-br hover:from-blue-50 hover:to-gray-100 transition-all duration-300 group"
                        id="image-label">
                        <div class="flex flex-col items-center gap-2">
                            <div
                                class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md group-hover:shadow-lg group-hover:scale-110 transition-all duration-300">
                                <i
                                    class="fas fa-cloud-upload-alt text-2xl text-gray-400 group-hover:text-blue-500 transition-colors duration-300"></i>
                            </div>
                            <div>
                                <p
                                    class="text-sm font-medium text-gray-700 group-hover:text-gray-900 transition-colors">
                                    คลิกเพื่อเลือกรูปภาพ</p>
                                <p class="text-xs text-gray-500">รองรับไฟล์ JPG, PNG, GIF</p>
                            </div>
                        </div>
                    </div>

                    <input type="file" class="hidden" id="complainImage" name="complainImage" accept="image/*" multiple>
                    <input type="file" name="temp-imgs" id="temp-imgs" class="hidden" multiple>

                    <div class="flex flex-wrap justify-center gap-2 mt-4" id="imagePreviewContainer">
                        <div class="w-32 sm:w-40 img-grid-col" id="img-col-1"></div>
                        <div class="w-32 sm:w-40 img-grid-col" id="img-col-2"></div>
                        <div class="w-32 sm:w-40 img-grid-col" id="img-col-3"></div>
                    </div>
                </div>

                <!-- Solutions Section (แสดงเฉพาะในโหมดแก้ไข) -->
                <div id="solutionsSection" class="md:col-span-2 space-y-4 hidden">
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-lightbulb mr-2 gray-accent"></i>แนวทางแก้ไข
                        </label>
                        <button type="button" onclick="openAddSolutionDialog()"
                            class="px-4 py-2 btn-success rounded-lg font-medium text-sm flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            <span>เพิ่มแนวทางแก้ไข</span>
                        </button>
                    </div>

                    <div id="solutionsList" class="space-y-3">
                        <!-- Solution cards will be inserted here -->
                        <div class="solution-empty-state">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>ยังไม่มีแนวทางแก้ไข</p>
                            <p class="text-xs mt-1">คลิกปุ่ม "เพิ่มแนวทางแก้ไข" เพื่อเริ่มต้น</p>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 pt-4">
                    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                        <button type="submit"
                            class="w-full sm:w-auto px-6 py-3 btn-primary rounded-xl font-medium flex items-center justify-center gap-2 order-1">
                            <i class="fas fa-save"></i>
                            <span>บันทึกข้อมูล</span>
                        </button>
                        <button type="button" onclick="resetForm()"
                            class="w-full sm:w-auto px-6 py-3 btn-secondary rounded-xl font-medium flex items-center justify-center gap-2 order-2">
                            <i class="fas fa-times"></i>
                            <span>ยกเลิก</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- List Tab -->
        <div id="listSection"
            class="card-minimal rounded-3xl shadow-2xl p-10 mb-8 hidden slide-in border-2 border-gray-100/50">
            <div class="mb-10">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <div class="flex items-center">
                        <div
                            class="w-14 h-14 icon-container-mobile gray-bg rounded-2xl flex items-center justify-center mr-3 md:mr-5 transform hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-list text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 tracking-tight">รายการข้อมูล Complain
                        </h2>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto action-buttons-mobile">
                        <div class="relative group w-full sm:flex-1 lg:w-auto">
                            <input type="text" id="searchInput" placeholder="ค้นหา..."
                                class="pl-9 pr-4 py-3 input-minimal rounded-xl font-medium w-full lg:w-56 xl:w-64 transition-all duration-300 text-sm h-[46px]">
                            <i
                                class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 gray-accent group-focus-within:text-gray-700 transition-colors text-sm"></i>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button onclick="searchData()"
                                class="w-full sm:w-auto px-4 py-3 btn-primary rounded-xl font-medium flex items-center justify-center gap-2 whitespace-nowrap h-[46px]">
                                <i class="fas fa-search"></i>
                                <span class="hidden sm:inline">ค้นหา</span>
                            </button>
                            <button onclick="loadDataFromSheets()"
                                class="w-full sm:w-auto px-4 py-3 btn-success rounded-xl font-medium flex items-center justify-center gap-2 whitespace-nowrap h-[46px]">
                                <i class="fas fa-sync-alt"></i>
                                <span class="hidden sm:inline">รีเฟรช</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
                <div
                    class="overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 table-container">
                    <table class="min-w-full table-auto">
                        <thead class="gray-light-bg">
                            <tr>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 whitespace-nowrap">
                                    วันที่</th>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-center text-xs md:text-sm font-semibold text-gray-700 whitespace-nowrap">
                                    Work week</th>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 min-w-[120px]">
                                    สินค้า</th>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 min-w-[100px]">
                                    ร้านค้า</th>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 min-w-[120px]">
                                    ประเภท</th>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 whitespace-nowrap">
                                    มูลค่า (฿)</th>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 whitespace-nowrap">
                                    ความรุนแรง</th>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 min-w-[140px]">
                                    แนวทางแก้ไข</th>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 whitespace-nowrap">
                                    สถานะ</th>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 min-w-[140px]">
                                    รูปภาพ</th>
                                <th
                                    class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-semibold text-gray-700 whitespace-nowrap">
                                    จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                <!-- Mobile scroll hint -->
                <div class="md:hidden text-center py-2 text-xs text-gray-500 border-t border-gray-100">
                    <i class="fas fa-arrows-alt-h mr-1"></i>เลื่อนซ้าย-ขวาเพื่อดูข้อมูลเพิ่มเติม
                </div>
                <!-- Pagination Controls -->
                <div class="border-t border-gray-200 px-4 py-3 bg-gray-50">
                    <div class="flex flex-col gap-4">
                        <!-- Page size and info -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                            <div class="flex items-center gap-2 text-xs sm:text-sm text-gray-600">
                                <span>แสดง</span>
                                <select id="pageSizeSelect" onchange="changePageSize(this.value)"
                                    class="px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 text-xs sm:text-sm">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <span class="hidden xs:inline">รายการต่อหน้า</span>
                            </div>
                            <div id="paginationInfo" class="text-xs sm:text-sm font-medium text-gray-600">แสดง 0-0 จาก 0
                                รายการ</div>
                        </div>

                        <!-- Navigation buttons -->
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="goToFirstPage()" id="firstPageBtn"
                                class="px-2 sm:px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-xs sm:text-base">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button onclick="goToPreviousPage()" id="prevPageBtn"
                                class="px-2 sm:px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-xs sm:text-base">
                                <i class="fas fa-angle-left"></i>
                            </button>
                            <div id="pageNumbers"
                                class="flex items-center gap-1 overflow-x-auto max-w-[200px] sm:max-w-none scrollbar-none">
                                <!-- Page numbers will be inserted here -->
                            </div>
                            <button onclick="goToNextPage()" id="nextPageBtn"
                                class="px-2 sm:px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-xs sm:text-base">
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button onclick="goToLastPage()" id="lastPageBtn"
                                class="px-2 sm:px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-xs sm:text-base">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Tab -->
        <div id="reportSection"
            class="card-minimal rounded-3xl shadow-2xl p-10 hidden slide-in border-2 border-gray-100/50">
            <div class="flex flex-col justify-start items-start mb-10 gap-4">
                <div class="flex items-center">
                    <div
                        class="w-14 h-14 icon-container-mobile gray-bg rounded-2xl flex items-center justify-center mr-3 md:mr-5 transform hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-chart-bar text-white text-xl"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-900 tracking-tight">รายงานสรุป</h2>
                </div>
                <!-- <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto action-buttons-mobile flex-wrap flex-cols-1 md:justify-start md:items-center md:flex-cols-3"> -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full  action-buttons-mobile">
                    <div class="grid grid-rows-1 w-full">
                        <!-- filter report date -->
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt mr-2 gray-accent"></i>ตั้งแต่วันที่
                        </label>
                        <div class="relative flex-1 min-w-0">
                            <input type="date" id="reportStartDate"
                                class="pl-12 pr-4 py-3.5 input-minimal rounded-xl font-medium w-full">
                            <i
                                class="fas fa-calendar-alt absolute left-4 top-1/2 transform -translate-y-1/2 gray-accent"></i>
                        </div>
                    </div>
                    <div class="grid grid-rows-1 w-full">
                        <!-- filter report date -->
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt mr-2 gray-accent"></i>ถึงวันที่
                        </label>
                        <div class="relative flex-1 min-w-0">
                            <input type="date" id="reportEndDate"
                                class="pl-12 pr-4 py-3.5 input-minimal rounded-xl font-medium w-full">
                            <i
                                class="fas fa-calendar-alt absolute left-4 top-1/2 transform -translate-y-1/2 gray-accent"></i>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full action-buttons-mobile">
                    <!-- filter report store -->
                    <div class="relative flex-1 min-w-0">
                        <select id="reportStore" class="pl-12 pr-4 py-3.5 input-minimal rounded-xl font-medium w-full">
                            <option value="">— เลือกร้านค้า —</option>
                        </select>
                        <i class="fas fa-store absolute left-4 top-1/2 transform -translate-y-1/2 gray-accent"></i>
                    </div>
                    <!-- filter report type -->
                    <div class="relative flex-1 min-w-0">
                        <select id="reportType" class="pl-12 pr-4 py-3.5 input-minimal rounded-xl font-medium w-full">
                            <option value="">— เลือกประเภท —</option>
                        </select>
                        <i class="fas fa-tags absolute left-4 top-1/2 transform -translate-y-1/2 gray-accent"></i>
                    </div>
                    <!-- filter report severity -->
                    <div class="relative flex-1 min-w-0">
                        <select id="reportSeverity"
                            class="pl-12 pr-4 py-3.5 input-minimal rounded-xl font-medium w-full">
                            <option value="">— เลือกความรุนแรง —</option>
                        </select>
                        <i
                            class="fas fa-exclamation-circle absolute left-4 top-1/2 transform -translate-y-1/2 gray-accent"></i>
                    </div>
                    <!-- <button onclick="sendEmailReport()" class="px-6 py-3 btn-primary rounded-xl font-medium">
                        <i class="fas fa-envelope mr-2"></i>ส่งอีเมล
                    </button> -->
                </div>
            </div>

            <div id="reportContent" class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 report-grid-mobile">
                <!-- Report content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Solution Dialog Modal -->
    <div id="solutionModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-3xl">
                <div class="flex items-center justify-between">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-900">
                        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                        <span id="modalTitleText">เพิ่มแนวทางแก้ไข</span>
                    </h3>
                    <button onclick="closeSolutionModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>

            <form id="solutionForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-align-left mr-2 gray-accent"></i>รายละเอียดแนวทางแก้ไข <span
                            class="text-red-500">*</span>
                    </label>
                    <textarea id="modal-solution-detail" class="w-full px-4 py-3 input-minimal rounded-lg font-medium"
                        rows="4" placeholder="กรอกรายละเอียดแนวทางแก้ไข..." required></textarea>
                    <p id="detail-error" class="text-red-500 text-sm mt-1 hidden">กรุณากรอกรายละเอียดแนวทางแก้ไข</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-users mr-2 gray-accent"></i>ทีมรับผิดชอบ <span class="text-red-500">*</span>
                    </label>
                    <select id="modal-solution-team" class="w-full px-4 py-3 input-minimal rounded-lg font-medium"
                        required>
                        <option value="">— เลือกทีม —</option>
                    </select>
                    <p id="team-error" class="text-red-500 text-sm mt-1 hidden">กรุณาเลือกทีมรับผิดชอบ</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-2 gray-accent"></i>ชื่อตัวแทนทีม <span class="text-red-500">*</span>
                    </label>
                    <input id="modal-solution-representative" type="text"
                        class="w-full px-4 py-3 input-minimal rounded-lg font-medium" placeholder="ชื่อตัวแทนทีม"
                        required>
                    <p id="representative-error" class="text-red-500 text-sm mt-1 hidden">กรุณากรอกชื่อตัวแทนทีม</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-check mr-2 gray-accent"></i>วันที่ติดตามการแก้ไข <span
                            class="text-red-500">*</span>
                    </label>
                    <input id="modal-solution-followup" type="text"
                        class="w-full px-4 py-3 input-minimal rounded-lg font-medium" required>
                    <p id="followup-error" class="text-red-500 text-sm mt-1 hidden">กรุณาเลือกวันที่ติดตาม</p>
                </div>
                <!-- รูปภาพ -->
                <div class="space-y-2 md:col-span-2">
                    <template id="img-template">
                        <div class="flex justify-center items-center relative border rounded-lg mt-3">
                            <span
                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer hover:bg-red-600 transition-colors">
                                <i class="fas fa-times text-xs"></i>
                            </span>
                            <img src="https://getbootstrap.com/docs/5.3/assets/brand/bootstrap-logo-shadow.png" alt=""
                                class="rounded-lg cursor-pointer max-w-full h-auto">
                        </div>
                    </template>

                    <label for="solutionImage">
                        <i class="fas fa-image mr-2 gray-accent"></i>รูปภาพ
                        <span class="text-gray-500 text-sm">(สูงสุด 3 รูป)</span><br>
                    </label>

                    <div class="rounded-xl border-2 border-dashed border-gray-300 bg-gradient-to-br from-gray-50 to-gray-100 p-4 text-center cursor-pointer hover:border-gray-400 hover:bg-gradient-to-br hover:from-blue-50 hover:to-gray-100 transition-all duration-300 group"
                        id="solution-image-label">
                        <div class="flex flex-col items-center gap-2">
                            <div
                                class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md group-hover:shadow-lg group-hover:scale-110 transition-all duration-300">
                                <i
                                    class="fas fa-cloud-upload-alt text-2xl text-gray-400 group-hover:text-blue-500 transition-colors duration-300"></i>
                            </div>
                            <div>
                                <p
                                    class="text-sm font-medium text-gray-700 group-hover:text-gray-900 transition-colors">
                                    คลิกเพื่อเลือกรูปภาพ</p>
                                <p class="text-xs text-gray-500">รองรับไฟล์ JPG, PNG, GIF</p>
                            </div>
                        </div>
                    </div>

                    <input type="file" class="hidden" id="solutionImage" name="solutionImage" accept="image/*" multiple>
                    <input type="file" name="solution-temp-imgs" id="solution-temp-imgs" class="hidden" multiple>

                    <div class="flex flex-wrap justify-center gap-2 mt-4" id="solution-imagePreviewContainer">
                        <div class="w-32 sm:w-40 solution-img-grid-col" id="solution-img-col-1"></div>
                        <div class="w-32 sm:w-40 solution-img-grid-col" id="solution-img-col-2"></div>
                        <div class="w-32 sm:w-40 solution-img-grid-col" id="solution-img-col-3"></div>
                    </div>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 px-6 py-3 btn-success rounded-xl font-medium">
                        <i class="fas fa-save mr-2"></i>
                        <span id="modalSubmitText">บันทึก</span>
                    </button>
                    <button type="button" onclick="closeSolutionModal()"
                        class="flex-1 px-6 py-3 btn-secondary rounded-xl font-medium">
                        <i class="fas fa-times mr-2"></i>ยกเลิก
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Performance optimization constants
        const DOM_CACHE = {};
        const DEBOUNCE_DELAY = 300;

        // Utility: Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Utility: Cache DOM selectors
        function getCached(selector) {
            if (!DOM_CACHE[selector]) {
                DOM_CACHE[selector] = $(selector);
            }
            return DOM_CACHE[selector];
        }

        // Utility: Batch DOM updates
        function batchDOMUpdate(callback) {
            requestAnimationFrame(() => {
                callback();
            });
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // Initialize
        let dateInput, reportDateStartInput, reportDateEndInput, modalDateInput;
        const originalComplainImageLabelHTML = $('#image-label').html(), originalComplainImageLabeClass = $('#solution-image-label').attr('class');
        const originalSolutionImageLabelHTML = $('#solution-image-label').html(), originalSolutionImageLabeClass = $('#solution-image-label').attr('class');
        $(document).ready(function () {
            NProgress.configure({
                showSpinner: false,
                trickleSpeed: 200,
                minimum: 0.08,
                easing: 'ease',
                speed: 500,
                parent: 'body',
                template: '<div class="bar" role="bar" style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); height: 4px;"><div class="peg"></div></div><div class="spinner" role="spinner"><div class="spinner-icon"></div></div>'
            });

            dateInput = flatpickr('#date', {
                locale: "th",
                dateFormat: "Y-m-d",
                defaultDate: new Date(),
            });

            reportDateStartInput = flatpickr('#reportStartDate', {
                locale: "th",
                dateFormat: "Y-m-d",
                defaultDate: new Date(),
                allowInput: true,
                onChange: function (selectedDates, dateStr, instance) {
                    generateReport();
                }
            });

            reportDateEndInput = flatpickr('#reportEndDate', {
                locale: "th",
                dateFormat: "Y-m-d",
                defaultDate: new Date(),
                allowInput: true,
                onChange: function (selectedDates, dateStr, instance) {
                    generateReport();
                }
            });

            modalDateInput = flatpickr('#modal-solution-followup', {
                locale: "th",
                dateFormat: "Y-m-d",
                defaultDate: new Date()
            });

            dateInput._input.setAttribute('disabled', 'disabled');
            const weekOfYear = getWeekNumber(new Date());
            $('#weekOfYear').val(weekOfYear + '/' + new Date().getFullYear());
            showTab('form');

            $('#reportType, #reportStore, #reportSeverity').on('change', generateReport);

            // load dropdown data
            callScript({
                func: 'getDropdownList',
                onSuccess: function (list) {
                    list = JSON.parse(list);
                    populateDropdowns(list);
                },
                onFailure: function (error) {
                    error = JSON.stringify(error);
                    console.error('Error loading dropdown data:', error);
                },
            });

            // Load data from Google Sheets on startup
            loadDataFromSheets();

            // Handle URL parameters for direct navigation
            google.script.url.getLocation((async function (location) {
                if (location.parameter && location.parameter.page === 'complainDataView') {
                    console.log('Navigating to Complain Data View tab');
                    let complainId = location.parameter.id;
                    if (complainId) {
                        while (isLoading) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                        setTimeout(() => {
                            editData(complainId);
                        }, 200);
                    }

                }
            }));

        });



        // Pipeline Stepper Function
        function selectPipelineStep(element) {
            const value = $(element).data('value');

            // Remove active states from all steps
            $('.pipeline-step').each(function () {
                $(this).removeClass('reported in_progress pending_close closed');
                const cogIcon = $(this).find('.fas');
                if (cogIcon.length) cogIcon.css('animation-play-state', 'paused');
            });

            // Activate selected step
            $(element).addClass(value);

            // Animate cog for in_progress state
            const cogIcon = $(element).find('.fas');
            if (cogIcon.length) cogIcon.css('animation-play-state', 'running');

            // Update hidden input
            $('#pipelineValue').val(value);

            // Visual feedback animation
            $(element).css('transform', 'scale(1.05)');
            setTimeout(() => $(element).css('transform', ''), 200);
        }

        const processCounter = {
            increment() {
                const count = (parseInt(localStorage.getItem('processCount') || '0') + 1);
                localStorage.setItem('processCount', count.toString());
                if (count === 1) NProgress.start();
            },
            decrement() {
                const count = Math.max(0, (parseInt(localStorage.getItem('processCount') || '0') - 1));
                count > 0 ? localStorage.setItem('processCount', count.toString()) : localStorage.removeItem('processCount');
                if (count === 0) NProgress.done();
            }
        };

        function callScript({ func, params, onSuccess, onFailure }) {
            processCounter.increment();

            const handleSuccess = (result) => {
                processCounter.decrement();
                onSuccess?.(result);
            };

            const handleFailure = (error) => {
                processCounter.decrement();
                onFailure?.(error);
            };

            const runner = google.script.run
                .withSuccessHandler(handleSuccess)
                .withFailureHandler(handleFailure);

            params !== undefined ? runner[func](params) : runner[func]();
        }

        function populateDropdowns(list) {
            console.log('Populating dropdowns with data:', list);
            const dropdowns = [
                { id: 'product', data: list['สินค้า'].sort() },
                { id: 'store', data: list['ร้านค้า'].sort() },
                { id: 'responsibleTeam', data: list['ทีมรับผิดชอบ'].sort() },
                { id: 'unit', data: list['หน่วยสินค้า'].sort() },
                { id: 'type', data: list['ประเภท'].sort() },
                { id: 'severity', data: list['ความรุนแรง'] },
                { id: 'modal-solution-team', data: list['ทีมรับผิดชอบ'].sort() },
                { id: 'reportStore', data: list['ร้านค้า'].sort() },
                { id: 'reportType', data: list['ประเภท'].sort() },
                { id: 'reportSeverity', data: list['ความรุนแรง'] },
            ];

            dropdowns.forEach(({ id, data }) => {
                const selectEl = document.getElementById(id);
                data.forEach(item => {
                    const opt = $('<option></option>')
                        .val(id === 'severity' ? item.split('.')[0].split(' ')[1].trim() : item)
                        .text(item);
                    selectEl.appendChild(opt[0]);
                });
            });
        }

        // Solutions Management Functions
        function openAddSolutionDialog() {
            editingSolutionIndex = null;
            showSolutionDialog();
        }

        function openEditSolutionDialog(index) {
            editingSolutionIndex = index;
            const solution = currentSolutions[index];
            console.log('Editing solution:', solution);
            showSolutionDialog(solution);
        }

        function showSolutionDialog(existingSolution = null) {
            const $modal = $('#solutionModal');
            const $form = $('#solutionForm');
            const $modalTitleText = $('#modalTitleText');
            const $modalSubmitText = $('#modalSubmitText');

            // Set modal title and button text
            if (existingSolution) {
                $modalTitleText.text('แก้ไขแนวทางแก้ไข');
                $modalSubmitText.text('บันทึกการแก้ไข');
            } else {
                $modalTitleText.text('เพิ่มแนวทางแก้ไข');
                $modalSubmitText.text('เพิ่มแนวทาง');
            }

            // Reset form and errors
            $form[0].reset();
            hideAllErrors();

            // Populate form if editing
            if (existingSolution) {
                console.log('Populating form with existing solution data:', existingSolution);
                $('#modal-solution-detail').val(existingSolution.text || '');
                $('#modal-solution-team').val(existingSolution.team || '');
                $('#modal-solution-representative').val(existingSolution.rep || '');
                modalDateInput.setDate(existingSolution.date || new Date());
                $('#team-error').val(existingSolution.team || '');
                $('#representative-error').val(existingSolution.rep || '');

                let images = existingSolution.images || [];
                if (images.length > 0) {
                    $solutionImageLabel.text('เลือกรูปภาพ (' + images.length + ' รูป)');
                    $('.solution-img-grid-col').empty();
                    images.forEach((img, i) => {
                        let imgElement = $($('#img-template').html());
                        $('.solution-img-grid-col').eq(i % 3).append(imgElement)
                        imgElement.find('img').attr('src', img)
                        imgElement.find('span').addClass('span-delete').on('click', function () {
                            deleteImage(img, existingSolution, 'solution');
                        });
                        imgElement.find('img').on('click', function () {
                            showImagePreview($(this).attr('src'));
                        });
                    });
                    updateSolutionImageLabel()
                }




            } else {
                $('#modal-solution-team').val($('#responsibleTeam').val() || '');
                $('#modal-solution-representative').val($('#teamRepresentative').val() || '');
            }

            // Show modal with animation
            $modal.removeClass('hidden');
            setTimeout(() => {
                $modal.find('.bg-white').addClass('slide-in');
            }, 10);
        }

        function closeSolutionModal() {
            $('#solutionModal').addClass('hidden');
            $('#solutionForm')[0].reset();
            $('.solution-img-grid-col').empty();
            editingSolutionIndex = null;
            $solutionImage.val('');
            $solutionTempImgs.val('');
            $solutionImageLabel.html(originalSolutionImageLabelHTML).attr('class', originalSolutionImageLabeClass);
            hideAllErrors();
        }

        function hideAllErrors() {
            $('#detail-error, #team-error, #representative-error, #followup-error').addClass('hidden');
        }

        function showError(fieldId, errorId) {
            $('#' + fieldId).addClass('border-red-500');
            $('#' + errorId).removeClass('hidden');
        }

        function hideError(fieldId, errorId) {
            $('#' + fieldId).removeClass('border-red-500');
            $('#' + errorId).addClass('hidden');
        }

        // Handle form submission
        $(document).ready(function () {
            $('#solutionForm').on('submit', async function (e) {
                e.preventDefault();

                // Get form values
                const detail = $('#modal-solution-detail').val().trim();
                const team = $('#modal-solution-team').val();
                const representative = $('#modal-solution-representative').val().trim();
                const followUpDate = $('#modal-solution-followup').val();

                // Reset errors
                hideAllErrors();

                // Validate
                let hasError = false;

                if (!detail) {
                    showError('modal-solution-detail', 'detail-error');
                    hasError = true;
                }

                if (!team) {
                    showError('modal-solution-team', 'team-error');
                    hasError = true;
                }

                if (!representative) {
                    showError('modal-solution-representative', 'representative-error');
                    hasError = true;
                }

                if (!followUpDate) {
                    showError('modal-solution-followup', 'followup-error');
                    hasError = true;
                }

                if (hasError) {
                    return;
                }

                // Check if we're editing an existing complaint (has ID in Google Sheets)
                const complainId = $('#editId').val() || currentEditId;
                let imagesData = '', folder_id = '';
                let existingImages = getExistingSolutionImages().toArray().map((img) => img.src);
                if ($solutionTempImgs[0].files.length > 0) {
                    const uploadData = await uploadSolutionFiles(complainId, editingSolutionIndex);
                    imagesData = uploadData.imageIds.filter(img => img !== null).map(id => 'https://lh3.googleusercontent.com/d/' + id)
                    imagesData = existingImages.concat(imagesData);
                    folder_id = uploadData.folderId;
                } else {
                    imagesData = existingImages;
                }

                Swal.fire({
                    title: 'กำลังบันทึกแนวทางแก้ไข...',
                    html: '<div class="pulse-animation">กรุณารอสักครู่</div>',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    background: '#ffffff',
                    color: '#1f2937',
                    customClass: {
                        popup: 'rounded-3xl shadow-2xl',
                        title: 'text-gray-900 font-bold',
                        htmlContainer: 'text-gray-600'
                    },
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });



                // Create solution object
                const solutionData = {
                    text: detail,
                    team: team,
                    rep: representative,
                    date: followUpDate,
                    images: imagesData,
                    folderId: folder_id
                };

                const isEdit = editingSolutionIndex !== null;
                console.log(isEdit ? 'Editing existing solution' : 'Adding new solution');

                if (isEdit) {
                    updateSolutionInSheets(complainId, currentSolutions[editingSolutionIndex].id, solutionData)
                        .then(response => {
                            // Update local data
                            currentSolutions[editingSolutionIndex] = response.solution;
                            renderSolutions();
                            closeSolutionModal();

                            Swal.fire({
                                icon: 'success',
                                title: 'แก้ไขสำเร็จ! 🎉',
                                text: 'แก้ไขแนวทางแก้ไขเรียบร้อยแล้ว',
                                timer: 2000,
                                showConfirmButton: false,
                                background: '#ffffff',
                                color: '#1f2937',
                                iconColor: '#10b981',
                                customClass: {
                                    popup: 'rounded-3xl shadow-2xl',
                                    title: 'text-gray-900 font-bold',
                                    htmlContainer: 'text-gray-600'
                                }
                            });

                            // Reload data to sync
                            loadDataFromSheets();
                        })
                        .catch(error => {
                            console.error('Error updating solution:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด! ❌',
                                text: 'ไม่สามารถแก้ไขแนวทางแก้ไขได้: ' + error.message,
                                background: '#ffffff',
                                color: '#1f2937',
                                iconColor: '#ef4444',
                                confirmButtonColor: '#374151',
                                confirmButtonText: 'ลองอีกครั้ง',
                                customClass: {
                                    popup: 'rounded-3xl shadow-2xl',
                                    title: 'text-gray-900 font-bold',
                                    htmlContainer: 'text-gray-600',
                                    confirmButton: 'rounded-xl px-6 py-3'
                                }
                            });
                        });
                } else {
                    addSolutionToSheets(complainId, solutionData)
                        .then(response => {
                            // Add to local data
                            currentSolutions.push(response.solution);
                            console.log(currentSolutions)
                            renderSolutions();
                            closeSolutionModal();

                            Swal.fire({
                                icon: 'success',
                                title: 'เพิ่มสำเร็จ! 🎉',
                                text: 'เพิ่มแนวทางแก้ไขเรียบร้อยแล้ว',
                                timer: 2000,
                                showConfirmButton: false,
                                background: '#ffffff',
                                color: '#1f2937',
                                iconColor: '#10b981',
                                customClass: {
                                    popup: 'rounded-3xl shadow-2xl',
                                    title: 'text-gray-900 font-bold',
                                    htmlContainer: 'text-gray-600'
                                }
                            });

                        })
                        .catch(error => {
                            console.error('Error adding solution:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด! ❌',
                                text: 'ไม่สามารถเพิ่มแนวทางแก้ไขได้: ' + error.message,
                                background: '#ffffff',
                                color: '#1f2937',
                                iconColor: '#ef4444',
                                confirmButtonColor: '#374151',
                                confirmButtonText: 'ลองอีกครั้ง',
                                customClass: {
                                    popup: 'rounded-3xl shadow-2xl',
                                    title: 'text-gray-900 font-bold',
                                    htmlContainer: 'text-gray-600',
                                    confirmButton: 'rounded-xl px-6 py-3'
                                }
                            });
                        });
                }

                // // If editing an existing complaint with ID, save to Google Sheets
                // if (complainId) {
                //     // Show loading
                //     Swal.fire({
                //         title: editingSolutionIndex !== null ? 'กำลังแก้ไขแนวทางแก้ไข...' : 'กำลังเพิ่มแนวทางแก้ไข...',
                //         html: '<div class="pulse-animation">กรุณารอสักครู่</div>',
                //         allowOutsideClick: false,
                //         showConfirmButton: false,
                //         background: '#ffffff',
                //         color: '#1f2937',
                //         customClass: {
                //             popup: 'rounded-3xl shadow-2xl',
                //             title: 'text-gray-900 font-bold',
                //             htmlContainer: 'text-gray-600'
                //         },
                //         didOpen: () => {
                //             Swal.showLoading();
                //         }
                //     });
                //     console.log('Saving solution to Sheets:', solutionData);
                //     console.log('Complain ID:', complainId);
                //     console.log('Editing Solution Index:', editingSolutionIndex);

                //     // Add or update solution in Google Sheets
                //     if (editingSolutionIndex !== null) {
                //         const solutionId = currentSolutions[editingSolutionIndex].id;
                //         console.log('Updating solution ID:', solutionId);
                //         updateSolutionInSheets(complainId, solutionId, solutionData)
                //             .then(response => {
                //                 // Update local data
                //                 currentSolutions[editingSolutionIndex] = response.solution;
                //                 renderSolutions();
                //                 closeSolutionModal();

                //                 Swal.fire({
                //                     icon: 'success',
                //                     title: 'แก้ไขสำเร็จ! 🎉',
                //                     text: 'แก้ไขแนวทางแก้ไขเรียบร้อยแล้ว',
                //                     timer: 2000,
                //                     showConfirmButton: false,
                //                     background: '#ffffff',
                //                     color: '#1f2937',
                //                     iconColor: '#10b981',
                //                     customClass: {
                //                         popup: 'rounded-3xl shadow-2xl',
                //                         title: 'text-gray-900 font-bold',
                //                         htmlContainer: 'text-gray-600'
                //                     }
                //                 });

                //                 // Reload data to sync
                //                 loadDataFromSheets();
                //             })
                //             .catch(error => {
                //                 console.error('Error updating solution:', error);
                //                 Swal.fire({
                //                     icon: 'error',
                //                     title: 'เกิดข้อผิดพลาด! ❌',
                //                     text: 'ไม่สามารถแก้ไขแนวทางแก้ไขได้: ' + error.message,
                //                     background: '#ffffff',
                //                     color: '#1f2937',
                //                     iconColor: '#ef4444',
                //                     confirmButtonColor: '#374151',
                //                     confirmButtonText: 'ลองอีกครั้ง',
                //                     customClass: {
                //                         popup: 'rounded-3xl shadow-2xl',
                //                         title: 'text-gray-900 font-bold',
                //                         htmlContainer: 'text-gray-600',
                //                         confirmButton: 'rounded-xl px-6 py-3'
                //                     }
                //                 });
                //             });
                //     } else {
                //         addSolutionToSheets(complainId, solutionData)
                //             .then(response => {
                //                 // Add to local data
                //                 currentSolutions.push(response.solution);
                //                 renderSolutions();
                //                 closeSolutionModal();

                //                 Swal.fire({
                //                     icon: 'success',
                //                     title: 'เพิ่มสำเร็จ! 🎉',
                //                     text: 'เพิ่มแนวทางแก้ไขเรียบร้อยแล้ว',
                //                     timer: 2000,
                //                     showConfirmButton: false,
                //                     background: '#ffffff',
                //                     color: '#1f2937',
                //                     iconColor: '#10b981',
                //                     customClass: {
                //                         popup: 'rounded-3xl shadow-2xl',
                //                         title: 'text-gray-900 font-bold',
                //                         htmlContainer: 'text-gray-600'
                //                     }
                //                 });
                //             })
                //             .catch(error => {
                //                 console.error('Error adding solution:', error);
                //                 Swal.fire({
                //                     icon: 'error',
                //                     title: 'เกิดข้อผิดพลาด! ❌',
                //                     text: 'ไม่สามารถเพิ่มแนวทางแก้ไขได้: ' + error.message,
                //                     background: '#ffffff',
                //                     color: '#1f2937',
                //                     iconColor: '#ef4444',
                //                     confirmButtonColor: '#374151',
                //                     confirmButtonText: 'ลองอีกครั้ง',
                //                     customClass: {
                //                         popup: 'rounded-3xl shadow-2xl',
                //                         title: 'text-gray-900 font-bold',
                //                         htmlContainer: 'text-gray-600',
                //                         confirmButton: 'rounded-xl px-6 py-3'
                //                     }
                //                 });
                //             });
                //     }
                // } else {
                //     // For new complaints not yet saved, just update local array
                //     if (editingSolutionIndex !== null) {
                //         currentSolutions[editingSolutionIndex] = solutionData;
                //         showToast('แก้ไขสำเร็จ!', 'แก้ไขแนวทางแก้ไขเรียบร้อยแล้ว', 'success');
                //     } else {
                //         currentSolutions.push(solutionData);
                //         showToast('เพิ่มสำเร็จ!', 'เพิ่มแนวทางแก้ไขเรียบร้อยแล้ว', 'success');
                //     }

                //     renderSolutions();
                //     closeSolutionModal();
                // }
            });
        });

        function showToast(title, message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };

            const toast = $(`
                <div class="fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3 slide-in" style="min-width: 300px;">
                    <i class="fas ${icons[type]} text-2xl"></i>
                    <div>
                        <div class="font-bold">${title}</div>
                        <div class="text-sm opacity-90">${message}</div>
                    </div>
                </div>
            `);

            $('body').append(toast);

            setTimeout(() => {
                toast.fadeOut(300, function () {
                    $(this).remove();
                });
            }, 2000);
        }

        function renderSolutions() {
            const $container = getCached('#solutionsList');

            batchDOMUpdate(() => {
                $container.empty();

                if (currentSolutions.length === 0) {
                    $container.html(`
                        <div class="solution-empty-state">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>ยังไม่มีแนวทางแก้ไข</p>
                            <p class="text-xs mt-1">คลิกปุ่ม "เพิ่มแนวทางแก้ไข" เพื่อเริ่มต้น</p>
                        </div>
                    `);
                    return;
                }

                const fragment = document.createDocumentFragment();
                const len = currentSolutions.length;

                for (let index = 0; index < len; index++) {
                    const solution = currentSolutions[index];
                    const div = document.createElement('div');
                    div.className = 'solution-card fade-in';
                    div.innerHTML = `
                        <span class="solution-number">Action แก้ไข #${index + 1}</span>
                        <button type="button" class="edit-solution" onclick="openEditSolutionDialog(${index})" title="แก้ไข">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="delete-solution" onclick="deleteSolution(${index})" title="ลบ">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="mt-4 space-y-3 text-base">
                            <div>
                                <strong class="text-gray-700 text-lg"><i class="fas fa-align-left mr-2"></i>รายละเอียด:</strong>
                                <p class="text-gray-600 mt-2 whitespace-pre-wrap text-base leading-relaxed">${solution.text}</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                                <div>
                                    <strong class="text-gray-700 text-base"><i class="fas fa-users mr-2"></i>ทีม:</strong>
                                    <span class="text-gray-600 text-base ml-2">${solution.team || '-'}</span>
                                </div>
                                <div>
                                    <strong class="text-gray-700 text-base"><i class="fas fa-user mr-2"></i>ตัวแทน:</strong>
                                    <span class="text-gray-600 text-base ml-2">${solution.rep || '-'}</span>
                                </div>
                                <div>
                                    <strong class="text-gray-700 text-base"><i class="fas fa-calendar-alt mr-2"></i>วันที่บันทึก:</strong>
                                    <span class="text-gray-600 text-base ml-2">${moment(solution.createAt).format('D MMM YYYY HH:mm น.') || '-'}</span>
                                </div>
                                <div>
                                    <strong class="text-gray-700 text-base"><i class="fas fa-calendar-check mr-2"></i>วันที่ติดตาม:</strong>
                                    <span class="text-gray-600 text-base ml-2">${moment(solution.date).format('D MMM YYYY') || '-'}</span>
                                </div>
                            </div>
                            ${solution.images && solution.images.length > 0 ? `
                                <div class="mt-4">
                                    <strong class="text-gray-700 text-base"><i class="fas fa-image mr-2"></i>รูปภาพ:</strong>
                                    <div class="flex gap-2 flex-wrap mt-2">
                                        ${solution.images.map(img => `
                                            <div class="relative group cursor-pointer" onclick="showImagePreview('${img}')">
                                                <img src="${img}" 
                                                     class="w-12 h-12 object-cover rounded-lg border-2 border-gray-200 hover:border-blue-500 transition-all duration-200 hover:scale-110 shadow-sm" 
                                                     alt="Thumbnail">
                                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 rounded-lg transition-all duration-200 flex items-center justify-center">
                                                    <i class="fas fa-search-plus text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200"></i>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    fragment.appendChild(div);
                }
                $container.append(fragment);
            });
        }

        function deleteSolution(index) {
            const complainId = $('#editId').val() || currentEditId;
            const solution = currentSolutions[index];

            Swal.fire({
                title: '⚠️ ยืนยันการลบแนวทางแก้ไข',
                html: `
                    <div class="text-center py-4">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-trash-alt text-3xl text-red-500"></i>
                        </div>
                        <p class="text-gray-700 text-lg mb-2">คุณแน่ใจหรือไม่ว่าต้องการลบ</p>
                        <p class="text-gray-600 font-semibold">แนวทางแก้ไข #${index + 1}</p>
                        <p class="text-gray-500 text-sm mt-3">การดำเนินการนี้ไม่สามารถย้อนกลับได้</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-trash mr-2"></i>ลบแนวทาง',
                cancelButtonText: '<i class="fas fa-times mr-2"></i>ยกเลิก',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                background: '#ffffff',
                color: '#1f2937',
                iconColor: '#f59e0b',
                customClass: {
                    popup: 'rounded-3xl shadow-2xl',
                    title: 'text-gray-900 font-bold text-xl',
                    htmlContainer: 'text-gray-600',
                    confirmButton: 'rounded-xl px-6 py-3 font-semibold',
                    cancelButton: 'rounded-xl px-6 py-3 font-semibold'
                },
                buttonsStyling: true,
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // If editing an existing complaint with ID, delete from Google Sheets
                    if (complainId && solution.id) {
                        Swal.fire({
                            title: 'กำลังลบแนวทางแก้ไข...',
                            html: '<div class="pulse-animation">กรุณารอสักครู่</div>',
                            allowOutsideClick: false,
                            showConfirmButton: false,
                            background: '#ffffff',
                            color: '#1f2937',
                            customClass: {
                                popup: 'rounded-3xl shadow-2xl',
                                title: 'text-gray-900 font-bold',
                                htmlContainer: 'text-gray-600'
                            },
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        deleteSolutionFromSheets(complainId, solution.id)
                            .then(response => {
                                currentSolutions.splice(index, 1);
                                renderSolutions();

                                Swal.fire({
                                    icon: 'success',
                                    title: 'ลบสำเร็จ! 🗑️',
                                    timer: 1500,
                                    showConfirmButton: false,
                                    background: '#ffffff',
                                    color: '#1f2937',
                                    iconColor: '#10b981',
                                    customClass: {
                                        popup: 'rounded-3xl shadow-2xl',
                                        title: 'text-gray-900 font-bold'
                                    }
                                });

                                // Reload data to sync
                                loadDataFromSheets();
                            })
                            .catch(error => {
                                console.error('Error deleting solution:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'เกิดข้อผิดพลาด! ❌',
                                    text: 'ไม่สามารถลบแนวทางแก้ไขได้: ' + error.message,
                                    background: '#ffffff',
                                    color: '#1f2937',
                                    iconColor: '#ef4444',
                                    confirmButtonColor: '#374151',
                                    confirmButtonText: 'ลองอีกครั้ง',
                                    customClass: {
                                        popup: 'rounded-3xl shadow-2xl',
                                        title: 'text-gray-900 font-bold',
                                        htmlContainer: 'text-gray-600',
                                        confirmButton: 'rounded-xl px-6 py-3'
                                    }
                                });
                            });
                    } else {
                        // For new complaints not yet saved, just update local array
                        currentSolutions.splice(index, 1);
                        renderSolutions();
                        Swal.fire({
                            icon: 'success',
                            title: 'ลบสำเร็จ! 🗑️',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                }
            });
        }

        function formatDateThai(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const day = date.getDate();
            const month = thaiMonths[date.getMonth()];
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        } function formatDateThai(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const day = date.getDate();
            const month = thaiMonths[date.getMonth()];
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }
    </script>

    <script>
        // Data storage
        let complainData = [];
        let filteredData = []; // Store filtered data for pagination
        let currentEditId = null;
        let isLoading = false;
        let currentSolutions = []; // Store solutions for current complain
        let editingSolutionIndex = null; // Track which solution is being edited

        // Pagination variables
        let currentPage = 1;
        let pageSize = 25;
        let totalPages = 1;

        // Google Apps Script Integration Functions using google.script.run
        function loadDataFromSheets() {
            if (isLoading) {
                return; // Prevent multiple simultaneous loads
            }

            isLoading = true;
            showLoadingMessage('กำลังโหลดข้อมูลจาก Google Sheets...', 'info');
            callScript({
                func: 'getComplainData',
                params: undefined,
                onSuccess: function (data) {
                    data = JSON.parse(data); // Parse JSON string
                    if (data.success) {
                        complainData = data.data || [];
                        filteredData = complainData;
                        currentPage = 1;
                        updateDataTable();
                        updateLoadingMessage('โหลดข้อมูลสำเร็จ!', 'success');
                        $('#listTab, #reportTab').removeClass('hidden');
                        $('#formSection').removeClass('editing');
                    } else {
                        throw new Error(data.error || 'ไม่สามารถโหลดข้อมูลได้');
                    }
                    isLoading = false;
                },
                onFailure: function (error) {
                    error = JSON.parse(error); // Parse JSON string
                    console.error('Error loading data:', error);
                    hideLoadingMessage();
                    NProgress.done();
                    isLoading = false;

                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด! ❌',
                        text: 'ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้: ' + error.message,
                        background: '#ffffff',
                        color: '#1f2937',
                        iconColor: '#ef4444',
                        confirmButtonColor: '#374151',
                        confirmButtonText: 'ตรวจสอบอีกครั้ง',
                        customClass: {
                            popup: 'rounded-3xl shadow-2xl',
                            title: 'text-gray-900 font-bold',
                            htmlContainer: 'text-gray-600',
                            confirmButton: 'rounded-xl px-6 py-3'
                        }
                    });
                },
            })
        }

        function saveDataToSheets(formData, isEdit = false) {
            return new Promise((resolve, reject) => {
                if (isEdit) {
                    callScript({
                        func: 'updateComplainData',
                        params: formData,
                        onSuccess: function (data) {
                            data = JSON.parse(data); // Parse JSON string
                            if (data.success) {
                                resolve(data);
                            } else {
                                reject(new Error(data.error || 'ไม่สามารถแก้ไขข้อมูลได้'));
                            }
                        },
                        onFailure: function (error) {
                            error = JSON.parse(error); // Parse JSON string
                            console.error('Error updating data:', error);
                            reject(error);
                        },
                    });
                } else {
                    callScript({
                        func: 'addComplainData',
                        params: formData,
                        onSuccess: function (data) {
                            data = JSON.parse(data); // Parse JSON string
                            if (data.success) {
                                complainData.push(data.newRecord); // Add new record to local data
                                resolve(data);
                            } else {
                                reject(new Error(data.error || 'ไม่สามารถบันทึกข้อมูลได้'));
                            }
                        },
                        onFailure: function (error) {
                            error = JSON.parse(error); // Parse JSON string
                            console.error('Error saving data:', error);
                            reject(error);
                        },
                    });
                }
            });
        }

        function deleteDataFromSheets(id) {
            return new Promise((resolve, reject) => {
                callScript({
                    func: 'deleteComplainData',
                    params: {
                        id: id
                    },
                    onSuccess: function (data) {
                        console.log("🚀 ~ deleteDataFromSheets ~ data:", data)
                        data = JSON.parse(data); // Parse JSON string
                        if (data.success) {
                            resolve(data);
                        } else {
                            reject(new Error(data.error || 'ไม่สามารถลบข้อมูลได้'));
                        }
                    },
                    onFailure: function (error) {
                        error = JSON.parse(error); // Parse JSON string
                        console.error('Error deleting data:', error);
                        reject(error);
                    },
                });
            });
        }

        // Solution Management Functions for Google Sheets
        function addSolutionToSheets(complainId, solutionData) {
            console.log('Adding solution to Sheets:', complainId, solutionData);
            return new Promise((resolve, reject) => {
                callScript({
                    func: 'addSolution',
                    params: { complainId: complainId, solutionData: solutionData },
                    onSuccess: function (data) {
                        data = JSON.parse(data); // Parse JSON string
                        if (data.success) {
                            resolve(data);
                        } else {
                            reject(new Error(data.error || 'ไม่สามารถเพิ่มแนวทางแก้ไขได้'));
                        }
                    },
                    onFailure: function (error) {
                        error = JSON.parse(error); // Parse JSON string
                        console.error('Error adding solution:', error);
                        reject(error);
                    },
                });
            });
        }

        function updateSolutionInSheets(complainId, solutionId, solutionData) {
            return new Promise((resolve, reject) => {
                callScript({
                    func: 'updateSolution',
                    params: { complainId: complainId, solutionId: solutionId, solutionData: solutionData },
                    onSuccess: function (data) {
                        data = JSON.parse(data); // Parse JSON string
                        if (data.success) {
                            resolve(data);
                        } else {
                            reject(new Error(data.error || 'ไม่สามารถแก้ไขแนวทางแก้ไขได้'));
                        }
                    },
                    onFailure: function (error) {
                        error = JSON.parse(error); // Parse JSON string
                        console.error('Error updating solution:', error);
                        reject(error);
                    },
                });
            });
        }

        function deleteSolutionFromSheets(complainId, solutionId) {
            return new Promise((resolve, reject) => {
                callScript({
                    func: 'deleteSolution',
                    params: { complainId: complainId, solutionId: solutionId },
                    onSuccess: function (data) {
                        data = JSON.parse(data); // Parse JSON string
                        if (data.success) {
                            resolve(data);
                        } else {
                            reject(new Error(data.error || 'ไม่สามารถลบแนวทางแก้ไขได้'));
                        }
                    },
                    onFailure: function (error) {
                        error = JSON.parse(error); // Parse JSON string
                        console.error('Error deleting solution:', error);
                        reject(error);
                    },
                });
            });
        }

        function getSolutionsFromSheets(complainId) {
            return new Promise((resolve, reject) => {
                callScript({
                    func: 'getSolutions',
                    params: complainId,
                    onSuccess: function (data) {
                        data = JSON.parse(data); // Parse JSON string
                        if (data.success) {
                            resolve(data);
                        } else {
                            reject(new Error(data.error || 'ไม่สามารถโหลดแนวทางแก้ไขได้'));
                        }
                    },
                    onFailure: function (error) {
                        error = JSON.parse(error); // Parse JSON string
                        console.error('Error loading solutions:', error);
                        reject(error);
                    },
                });
            });
        }

        function showLoadingMessage(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                info: 'fa-info-circle'
            };

            const animateIcon = type === 'info' ? `
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-3"></div>
            ` : `
                <i class="fas ${icons[type]} text-white text-xl mr-3"></i>
            `;
            $('body').append(`
                <div id="loadingMessage" class="fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center">
                    ${animateIcon}
                    <span>${message}</span>
                </div>
            `);
        }

        function hideLoadingMessage() {
            $('#loadingMessage').remove();
        }

        function updateLoadingMessage(message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                info: 'fa-info-circle'
            };
            const animateIcon = type === 'info' ? `
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-3"></div>
            ` : `
                <i class="fas ${icons[type]} text-white text-xl mr-3 fa-bounce"></i>
            `;
            const $message = $('#loadingMessage');
            if ($message.length) {
                $message.removeClass('bg-blue-500 bg-green-500 bg-red-500')
                    .addClass(colors[type]);
                $message.html(`
                    ${animateIcon}
                    <span>${message}</span>
                `);
                setTimeout(() => {
                    hideLoadingMessage();
                }, 2000);
            }
        }


        // Tab management
        function showTab(tabName, isEdit = false) {
            // Hide all sections
            const previousTab = $('#formSection, #listSection, #reportSection').filter(':not(.hidden)').attr('id');
            $('#formSection, #listSection, #reportSection').addClass('hidden');

            // Reset tab buttons
            $('#formTab, #listTab, #reportTab').removeClass('btn-primary').addClass('btn-secondary');

            // Show selected section and highlight tab
            const tabs = {
                'form': { section: '#formSection', tab: '#formTab', callback: null },
                'list': { section: '#listSection', tab: '#listTab', callback: updateDataTable },
                'report': { section: '#reportSection', tab: '#reportTab', callback: generateReport }
            };

            console.log("🚀 ~ showTab ~ previousTab:", previousTab)


            const selected = tabs[tabName];
            if (selected) {
                $(selected.section).removeClass('hidden')
                if (tabName === 'form' && isEdit) {
                    $('#formSection').addClass('editing');
                    $('#formTitle').text('แก้ไขข้อมูล Complain');
                    $('#pipelineValue').parent().removeClass('hidden');
                    $('#solutionsSection').removeClass('hidden'); // Show solutions section

                    // scroll to top of form
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                else {
                    $('#formSection').removeClass('editing');
                    $('#formTitle').text('เพิ่มข้อมูล Complain');
                    $('#pipelineValue').parent().addClass('hidden');
                    $('#solutionsSection').addClass('hidden'); // Hide solutions section
                }
                $(selected.tab).removeClass('btn-secondary').addClass('btn-primary').attr('data-previous-tab', previousTab);
                if (selected.callback) selected.callback();
            }

        }

        // Form submission
        $('#complainForm').on('submit', async function (e) {
            e.preventDefault();
            let imagesData = '', folder_id = '';
            let existingImages = getExistingImages().toArray().map((img) => img.src).join('\n');
            if ($tempImgs[0].files.length > 0) {
                const uploadData = await uploadComplainFiles();
                imagesData = uploadData.imageIds.filter(img => img !== null).map(id => 'https://lh3.googleusercontent.com/d/' + id).join('\n');
                imagesData = existingImages.concat('\n', imagesData).trim();
                folder_id = uploadData.folderId;
            } else {
                imagesData = existingImages;
            }

            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                html: '<div class="pulse-animation">กรุณารอสักครู่</div>',
                allowOutsideClick: false,
                showConfirmButton: false,
                background: '#ffffff',
                color: '#1f2937',
                customClass: {
                    popup: 'rounded-3xl shadow-2xl',
                    title: 'text-gray-900 font-bold',
                    htmlContainer: 'text-gray-600'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const formData = {
                date: $('#date').val(),
                weekOfYear: $('#weekOfYear').val(),
                product: $('#product').val(),
                quantity: parseInt($('#quantity').val()),
                problem: $('#problem').val(),
                store: $('#store').val(),
                unit: $('#unit').val(),
                pipeline: $('#pipelineValue').val(),
                type: $('#type').val(),
                severity: $('#severity').val(),
                claimValue: parseFloat($('#claimValue').val()),
                responsibleTeam: $('#responsibleTeam').val(),
                teamRepresentative: $('#teamRepresentative').val(),
                solutions: currentSolutions,
                images: imagesData,
                folderId: folder_id,
            };

            console.log(formData)

            const editId = $('#editId').val();
            const isEdit = !!editId;

            if (isEdit) {
                formData.id = editId;
            }

            // Save to Google Sheets
            saveDataToSheets(formData, isEdit)
                .then(response => {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกข้อมูลสำเร็จ! 🎉',
                        text: isEdit ? 'แก้ไขข้อมูลเรียบร้อยแล้ว' : 'เพิ่มข้อมูลใหม่เรียบร้อยแล้ว',
                        timer: 2500,
                        showConfirmButton: false,
                        background: '#ffffff',
                        color: '#1f2937',
                        iconColor: '#10b981',
                        customClass: {
                            popup: 'rounded-3xl shadow-2xl',
                            title: 'text-gray-900 font-bold',
                            htmlContainer: 'text-gray-600'
                        }
                    });

                    if (isEdit) {
                        // Update local data
                        const index = complainData.findIndex(item => item.id == editId);
                        if (index !== -1) {
                            formData.images = formData.images == '' ? [] : formData.images.split('\n');
                            complainData[index] = formData;
                        }
                        resetForm();
                        showTab('list', false);
                        setTimeout(() => {
                            const $row = $(`tr[data-complain-id="${editId}"]`);
                            if ($row.length) {
                                $('html, body').animate({
                                    scrollTop: $row.offset().top - 100
                                }, 200);

                                $row.addClass('highlighted');
                                setTimeout(() => {
                                    $row.removeClass('highlighted');
                                }, 5000);
                            }
                        }, 100);
                    } else {
                        // Add to local data
                        formData.images = formData.images == '' ? [] : formData.images.split('\n');
                        formData.id = response.id; // Assign new ID from response
                        console.log(formData)
                        console.log(complainData)
                        resetForm();
                        showTab('form', false);
                    }
                    $tempImgs.val('');
                    $complainImage.val('');
                    updateImageLabel();
                    updateDataTable();
                })
                .catch(error => {
                    console.error('Error saving data:', error);

                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด! ❌',
                        text: 'ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                        background: '#ffffff',
                        color: '#1f2937',
                        iconColor: '#ef4444',
                        confirmButtonColor: '#374151',
                        confirmButtonText: 'ลองอีกครั้ง',
                        customClass: {
                            popup: 'rounded-3xl shadow-2xl',
                            title: 'text-gray-900 font-bold',
                            htmlContainer: 'text-gray-600',
                            confirmButton: 'rounded-xl px-6 py-3'
                        }
                    });
                });
        });

        // Reset form
        function resetForm() {
            // check if in edit mode
            const isEdit = !!currentEditId;
            console.log('Resetting form, isEdit:', isEdit);
            let activeTab = $('.tab-btn.btn-primary').attr('id');
            let previousTab = $('.tab-btn.btn-primary').attr('data-previous-tab');
            console.log("🚀 ~ resetForm ~ previousTab:", previousTab)
            console.log('Active Tab:', activeTab);
            if (!isEdit) {
                showTab('form', false);

            } else {
                showTab(previousTab.replace('Section', ''), false);
            }
            $('#complainForm')[0].reset();
            $('#editId').val('');
            $('#date').val(new Date().toISOString().split('T')[0]);
            currentEditId = null;
            currentSolutions = []; // Clear solutions
            renderSolutions(); // Re-render empty state

            // Clear selected images
            if (window.getSelectedImages) {
                const selectedImages = window.getSelectedImages();
                selectedImages.length = 0;
                $('#img-col-1, #img-col-2, #img-col-3').empty();
            }

            // Reset TomSelect dropdowns
            ['#product', '#store', '#responsibleTeam'].forEach(selector => {
                const ts = $(selector)[0].tomselect;
                if (ts) ts.clear();
            });

            // Reset pipeline stepper to default (reported)
            document.querySelectorAll('.pipeline-step').forEach(step => {
                step.classList.remove('reported', 'in_progress', 'pending_close', 'closed');
                const icon = step.querySelector('.fas');
                if (icon) icon.style.animationPlayState = 'paused';
            });
            const defaultStep = document.querySelector('.pipeline-step[data-value="reported"]');
            if (defaultStep) {
                defaultStep.classList.add('reported');
                document.getElementById('pipelineValue').value = 'reported';
                const icon = defaultStep.querySelector('.fas');
                if (icon) icon.style.animationPlayState = 'running';
            }

            $('#pipelineValue').val('reported').parent().addClass('d-none');

            // reset images data
            $tempImgs.val('');
            $('.img-grid-col').empty();
            $('#image-label').html(originalComplainImageLabelHTML).removeAttr('class').addClass(originalComplainImageLabeClass);
            selectedImages = [];


            console.log('Form has been reset.');

        }

        // Pagination functions
        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            currentPage = 1;
            updateDataTable();
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            updateDataTable();
        }

        function goToFirstPage() {
            goToPage(1);
        }

        function goToPreviousPage() {
            goToPage(currentPage - 1);
        }

        function goToNextPage() {
            goToPage(currentPage + 1);
        }

        function goToLastPage() {
            goToPage(totalPages);
        }

        function updatePaginationControls() {
            const totalRecords = filteredData.length;
            totalPages = Math.ceil(totalRecords / pageSize) || 1;

            // Update info text
            const startRecord = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endRecord = Math.min(currentPage * pageSize, totalRecords);
            document.getElementById('paginationInfo').textContent =
                `แสดง ${startRecord}-${endRecord} จาก ${totalRecords} รายการ`;

            // Update button states
            const firstBtn = document.getElementById('firstPageBtn');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const lastBtn = document.getElementById('lastPageBtn');

            firstBtn.disabled = currentPage === 1;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            lastBtn.disabled = currentPage === totalPages;

            // Generate page numbers
            const pageNumbersContainer = document.getElementById('pageNumbers');
            pageNumbersContainer.innerHTML = '';

            // Show fewer pages on mobile
            const isMobile = window.innerWidth < 640;
            const maxButtons = isMobile ? 3 : 5;

            // Calculate page range
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            // Adjust if we're near the end
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.onclick = () => goToPage(i);
                btn.className = i === currentPage
                    ? 'px-2 sm:px-3 py-2 rounded-lg border-2 border-gray-700 bg-gray-700 text-white font-semibold min-w-[32px] sm:min-w-[40px] text-xs sm:text-base flex-shrink-0'
                    : 'px-2 sm:px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors min-w-[32px] sm:min-w-[40px] text-xs sm:text-base flex-shrink-0';
                btn.textContent = i;
                pageNumbersContainer.appendChild(btn);
            }
        }

        // Update data table (optimized with DocumentFragment)
        function updateDataTable() {
            const tbody = getCached('#dataTableBody');

            batchDOMUpdate(() => {
                tbody.empty();

                // Use filtered data if available, otherwise use all data
                const dataToDisplay = filteredData.length > 0 || complainData.length === 0 ? filteredData : complainData;
                dataToDisplay.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (dateB - dateA !== 0) {
                        return dateB - dateA; // Sort by date descending (newest first)
                    }
                    // If dates are equal, sort by id descending (newest first)
                    return (b.id || '').localeCompare(a.id || '');
                });
                // Calculate pagination
                totalPages = Math.ceil(dataToDisplay.length / pageSize) || 1;
                if (currentPage > totalPages) currentPage = 1;

                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = Math.min(startIndex + pageSize, dataToDisplay.length);
                const paginatedData = dataToDisplay.slice(startIndex, endIndex);

                if (dataToDisplay.length === 0) {
                    tbody.html(`
                        <tr data-complain-id="no-data">
                            <td colspan="8" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center justify-center">
                                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                        <i class="fas fa-inbox text-3xl text-gray-400"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-600 mb-2">ไม่มีข้อมูล</h3>
                                    <p class="text-gray-500 text-sm">ยังไม่มีข้อร้องเรียนในระบบ</p>
                                </div>
                            </td>
                        </tr>
                    `);
                    updatePaginationControls();
                    return;
                }

                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                const len = paginatedData.length;

                // Cache static mappings
                const severityMap = {
                    '1': { text: 'ต่ำ', class: 'severity-green' },
                    '2': { text: 'ปานกลาง', class: 'severity-yellow' },
                    '3': { text: 'สูง', class: 'severity-red' }
                };

                const typeMap = {
                    'A': 'Order ผิด',
                    'B': 'ส่งสินค้าไม่ครบ/ผิด',
                    'C': 'สินค้าไม่ได้คุณภาพ',
                    'D': 'ส่งไม่ถูกต้อง',
                    'E': 'เอกสารผิด',
                    'F': 'ตกเครื่อง'
                };

                const pipelineStatusMap = {
                    'reported': { text: 'แจ้งเรื่อง', class: 'bg-blue-100 text-blue-800', icon: 'fa-flag' },
                    'in_progress': { text: 'กำลังแก้ไข', class: 'bg-orange-100 text-orange-800', icon: 'fa-cog' },
                    'pending_close': { text: 'รอปิดเคส', class: 'bg-yellow-100 text-yellow-800', icon: 'fa-check-circle' },
                    'closed': { text: 'ปิดเคสแล้ว', class: 'bg-green-100 text-green-800', icon: 'fa-check-double' }
                };

                for (let i = 0; i < len; i++) {
                    const item = paginatedData[i];
                    const severity = severityMap[item.severity] || { text: 'สูง', class: 'severity-red' };
                    const typeText = typeMap[item.type] || item.type;
                    const status = pipelineStatusMap[item.pipeline] || pipelineStatusMap['reported'];
                    const severityText = severity.text;
                    const severityClass = severity.class;
                    const solutionCount = item.solutions ? item.solutions.length : 0;
                    const images = item.images ? item.images.filter(img => img.trim() !== '') : [];
                    const tr = document.createElement('tr');
                    tr.className = 'table-row-hover border-b border-gray-100';
                    tr.setAttribute('data-complain-id', item.id);
                    tr.style.animationDelay = `${i * 0.05}s`; // Reduced delay for faster rendering
                    tr.innerHTML = `
                    <td class="px-3 md:px-6 py-3 md:py-4 font-medium text-gray-800 text-xs md:text-sm whitespace-nowrap">${item.date}</td>
                    <td class="px-3 md:px-6 py-3 md:py-4 font-medium text-gray-800 text-xs md:text-sm whitespace-nowrap text-center">${item.weekOfYear}</td>
                    <td class="px-3 md:px-6 py-3 md:py-4 font-medium text-gray-800 text-xs md:text-sm">
                        <div class="max-w-[120px] truncate" title="${item.product}">${item.product}</div>
                    </td>
                    <td class="px-3 md:px-6 py-3 md:py-4 font-medium text-gray-800 text-xs md:text-sm">
                        <div class="max-w-[100px] truncate" title="${item.store}">${item.store}</div>
                    </td>
                    <td class="px-3 md:px-6 py-3 md:py-4">
                        ${typeText && type !== "" ? ` <span class="px-2 md:px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold whitespace-nowrap">
                            ${typeText}
                        </span>` : ""}
                       
                    </td>
                      <td class="px-3 md:px-6 py-3 md:py-4 font-bold text-green-600 text-xs md:text-sm whitespace-nowrap">${item.claimValue.toLocaleString()}</td>
                    <td class="px-3 md:px-6 py-3 md:py-4">
                        ${severityText && severityText !== "" ? `<span class="px-2 md:px-3 py-1 rounded-full text-white text-xs font-semibold ${severityClass} whitespace-nowrap">
                            ${severityText}
                        </span>` : ""}
                    </td>
                      <td class="px-3 md:px-6 py-3 md:py-4 font-medium text-gray-800 text-xs md:text-sm whitespace-nowrap text-center">
                        ${solutionCount} รายการ
                    </td>
                    <td class="px-3 md:px-6 py-3 md:py-4">
                        ${status ? `<span class="px-2 md:px-3 py-1 rounded-full text-xs font-semibold whitespace-nowrap ${status.class} inline-flex items-center gap-1">
                            <i class="fas ${status.icon} text-xs"></i>
                            ${status.text}
                        </span>` : ""}
                    </td>
                  
                    <td class="px-3 md:px-6 py-3 md:py-4">
                        ${images.length > 0 ? `
                            <div class="flex gap-1 flex-wrap">
                                ${images.slice(0, 3).map(img => `
                                    <div class="relative group" onclick="showImagePreview(\`${img}\`)">
                                        <img src="${img}" 
                                             class="w-8 h-8 md:w-10 md:h-10 object-cover rounded-lg border-2 border-gray-200 cursor-pointer hover:border-blue-500 transition-all duration-200 hover:scale-110" 
                                             alt="Thumbnail">
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-lg transition-all duration-200 flex items-center justify-center">
                                            <i class="fas fa-search-plus text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200"></i>
                                        </div>
                                    </div>
                                `).join('')}
                                ${images.length > 3 ? `
                                    <div class="w-8 h-8 md:w-10 md:h-10 bg-gray-100 rounded-lg border-2 border-gray-200 flex items-center justify-center">
                                        <span class="text-xs text-gray-600 font-semibold">+${images.length - 3}</span>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <span class="text-gray-400 text-xs">ไม่มีรูปภาพ</span>
                        `}
                    </td>
                    <td class="px-3 md:px-6 py-3 md:py-4">
                        <div class="flex space-x-1 md:space-x-2">
                            <button onclick="editData('${item.id}')" class="px-2 md:px-3 py-1 md:py-2 btn-warning text-white rounded-lg text-xs md:text-sm font-semibold">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteData('${item.id}')" class="px-2 md:px-3 py-1 md:py-2 btn-danger text-white rounded-lg text-xs md:text-sm font-semibold">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                    fragment.appendChild(tr);
                }
                tbody.append(fragment);
                updatePaginationControls();
            });
        }

        function editData(id) {
            const item = complainData.find(data => data.id === id);
            console.log('Editing item:', item);
            if (!item) return;
            currentEditId = id;
            // กรอกค่าปกติในฟอร์ม
            $('#editId').val(item.id);
            $('#date').val(item.date);
            $('#weekOfYear').val(item.weekOfYear);
            $('#quantity').val(item.quantity);
            $('#problem').val(item.problem);
            $('#unit').val(item.unit);
            $('#type').val(item.type);
            $('#severity').val(item.severity);
            $('#claimValue').val(item.claimValue);
            $('#teamRepresentative').val(item.teamRepresentative);
            $('#product').val(item.product);
            $('#store').val(item.store);
            $('#responsibleTeam').val(item.responsibleTeam);

            // Load solutions
            currentSolutions = item.solutions || [];
            renderSolutions();
            // show image
            let images = item.images || [];
            if (images.length > 0) {
                $('#image-label').text('เลือกรูปภาพ (' + images.length + ' รูป)');
                $('.img-grid-col').empty();
                images.forEach((img, i) => {
                    let imgElement = $($('#img-template').html());
                    $('.img-grid-col').eq(i % 3).append(imgElement)
                    imgElement.find('img').attr('src', img)
                    imgElement.find('span').addClass('span-delete').on('click', function () {
                        deleteImage(img, item, 'complain');
                    });
                    imgElement.find('img').on('click', function () {
                        showImagePreview($(this).attr('src'));
                    });
                });
                updateImageLabel();
            }


            // Set pipeline stepper
            $('.pipeline-step').each(function () {
                $(this).removeClass('reported in_progress pending_close closed');
                const icon = $(this).find('.fas');
                if (icon.length) icon.css('animation-play-state', 'paused');
            });

            const pipelineValue = item.pipeline || 'reported';
            const pipelineSteps = ['reported', 'in_progress', 'pending_close', 'closed'];
            const currentStepIndex = pipelineSteps.indexOf(pipelineValue);

            $('.pipeline-step').each(function () {
                const stepValue = $(this).data('value');
                const stepIndex = pipelineSteps.indexOf(stepValue);

                if (stepIndex < currentStepIndex) {
                    $(this)
                        .css({
                            'pointer-events': 'none',
                            'cursor': 'not-allowed'
                        })
                        .find('.fas').css({
                            'opacity': '0.5',
                        });
                } else {
                    $(this)
                        .css({
                            'pointer-events': 'auto',
                            'cursor': 'pointer'
                        })
                        .find('.fas')
                        .css({
                            'opacity': '1',
                        });
                }
            });

            const activeStep = $(`.pipeline-step[data-value="${pipelineValue}"]`);
            if (activeStep.length) {
                activeStep.addClass(pipelineValue);
                if (pipelineValue === 'in_progress') {
                    const icon = activeStep.find('.fas');
                    if (icon.length) icon.css('animation-play-state', 'running');
                }
            }
            $('#pipelineValue').val(pipelineValue);

            console.log("pipeline =", item);

            // ----------------------------------------------------
            $('#formTitle').text('แก้ไขข้อมูล Complain');
            showTab('form', true);
            setTimeout(() => {
                // Scroll to form
                $('html, body').animate({ scrollTop: $('#formSection').offset().top - 50 });
            }, 100);
        }

        // Delete data
        function deleteData(id) {
            Swal.fire({
                title: 'ยืนยันการลบ? 🗑️',
                html: `
                    <p class="text-gray-700 text-lg mb-2">คุณต้องการลบข้อมูลนี้หรือไม่?</p>
                    <p class="text-red-500 text-sm mt-2">⚠️ การดำเนินการนี้จะลบข้อมูลรูปภาพที่เกี่ยวข้องทั้งหมด</p>
                `,
                icon: 'warning',
                showCancelButton: true,
                background: '#ffffff',
                color: '#1f2937',
                iconColor: '#f59e0b',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#9ca3af',
                confirmButtonText: 'ลบเลย',
                cancelButtonText: 'ยกเลิก',
                customClass: {
                    popup: 'rounded-3xl shadow-2xl',
                    title: 'text-gray-900 font-bold',
                    htmlContainer: 'text-gray-600',
                    confirmButton: 'rounded-xl px-6 py-3',
                    cancelButton: 'rounded-xl px-6 py-3'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading
                    Swal.fire({
                        title: 'กำลังลบข้อมูล...',
                        html: '<div class="pulse-animation">กรุณารอสักครู่</div>',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        background: '#ffffff',
                        color: '#1f2937',
                        customClass: {
                            popup: 'rounded-3xl shadow-2xl',
                            title: 'text-gray-900 font-bold',
                            htmlContainer: 'text-gray-600'
                        },
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Delete from Google Sheets
                    deleteDataFromSheets(id)
                        .then(response => {
                            if (!response.success) {
                                throw new Error(response.error || 'ไม่สามารถลบข้อมูลได้');
                            }
                            // Remove from local data
                            complainData = complainData.filter(item => item.id !== id);
                            filteredData = filteredData.filter(item => item.id !== id);
                            updateDataTable();

                            Swal.fire({
                                icon: 'success',
                                title: 'ลบข้อมูลสำเร็จ! ✅',
                                timer: 1500,
                                showConfirmButton: false,
                                background: '#ffffff',
                                color: '#1f2937',
                                iconColor: '#10b981',
                                customClass: {
                                    popup: 'rounded-3xl shadow-2xl',
                                    title: 'text-gray-900 font-bold'
                                }
                            });
                        })
                        .catch(error => {
                            error = JSON.parse(error); // Parse JSON string
                            console.error('Error deleting data:', error);

                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด! ❌',
                                text: 'ไม่สามารถลบข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                                background: '#ffffff',
                                color: '#1f2937',
                                iconColor: '#ef4444',
                                confirmButtonColor: '#374151',
                                confirmButtonText: 'ลองอีกครั้ง',
                                customClass: {
                                    popup: 'rounded-3xl shadow-2xl',
                                    title: 'text-gray-900 font-bold',
                                    htmlContainer: 'text-gray-600',
                                    confirmButton: 'rounded-xl px-6 py-3'
                                }
                            });
                        });
                }
            });
        }

        // Search data (optimized with debouncing)
        const searchDataDebounced = debounce(function () {
            const searchTerm = getCached('#searchInput').val().toLowerCase();

            if (!searchTerm) {
                filteredData = complainData;
                currentPage = 1;
                updateDataTable();
                return;
            }

            // Filter data based on search term
            filteredData = complainData.filter(item => {
                return (
                    String(item.date || '').toLowerCase().includes(searchTerm) ||
                    String(item.product || '').toLowerCase().includes(searchTerm) ||
                    String(item.store || '').toLowerCase().includes(searchTerm) ||
                    String(item.type || '').toLowerCase().includes(searchTerm) ||
                    String(item.problem || '').toLowerCase().includes(searchTerm) ||
                    String(item.responsibleTeam || '').toLowerCase().includes(searchTerm) ||
                    String(item.teamRepresentative || '').toLowerCase().includes(searchTerm) ||
                    String(item.id || '').toLowerCase().includes(searchTerm)
                );
            });

            currentPage = 1;
            updateDataTable();
        }, DEBOUNCE_DELAY);

        function searchData() {
            searchDataDebounced();
        }

        // Generate report
        function generateReport() {
            const reportStartDate = $('#reportStartDate').val();
            const reportEndDate = $('#reportEndDate').val();
            const reportType = $('#reportType').val();
            const reportSeverity = $('#reportSeverity').val();
            const reportStore = $('#reportStore').val();
            const filteredData = complainData.filter(item => {
                const matchDate = (!reportStartDate || item.date >= reportStartDate) &&
                    (!reportEndDate || item.date <= reportEndDate);
                const matchType = reportType ? item.type === reportType : true;
                const matchSeverity = reportSeverity ? item.severity === reportSeverity : true;
                const matchStore = reportStore ? item.store === reportStore : true;
                return matchDate && matchType && matchSeverity && matchStore;
            });

            // Get today's data
            const today = new Date().toISOString().split('T')[0];
            const todayData = complainData.filter(item => item.date === today);

            const $reportContent = $('#reportContent');

            // Calculate statistics
            const totalCases = filteredData.length;
            const totalValue = filteredData.reduce((sum, item) => sum + Number(item.claimValue), 0);

            const severityCount = {
                '1': filteredData.filter(item => item.severity == '1').length,
                '2': filteredData.filter(item => item.severity == '2').length,
                '3': filteredData.filter(item => item.severity == '3').length
            };

            const typeCount = {};
            $.each(filteredData, function (index, item) {
                typeCount[item.type] = (typeCount[item.type] || 0) + 1;
            });

            const createTableRows = (data) => {
                return data.map(item => {
                    let severityText, severityClass;
                    if (item.severity == '1') {
                        severityText = 'ต่ำ';
                        severityClass = 'severity-green';
                    } else if (item.severity == '2') {
                        severityText = 'ปานกลาง';
                        severityClass = 'severity-yellow';
                    } else {
                        severityText = 'สูง';
                        severityClass = 'severity-red';
                    }
                    const typeText = {
                        'A': 'Order ผิด',
                        'B': 'ส่งสินค้าไม่ครบ/ผิด',
                        'C': 'สินค้าไม่ได้คุณภาพ',
                        'D': 'ส่งไม่ถูกต้อง',
                        'E': 'เอกสารผิด',
                        'F': 'ตกเครื่อง'
                    }[item.type] || item.type;

                    return `
                        <tr class="border-b border-gray-100">
                            <td class="px-4 py-3 text-sm font-medium text-gray-800">${item.product}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${item.store}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">
                                    ${typeText}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded text-white text-xs font-semibold ${severityClass}">
                                    ${severityText}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm font-bold text-green-600">${item.claimValue.toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');
            };

            const dataTable = filteredData.length > 0 ? `
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="gray-light-bg">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">สินค้า</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">ร้านค้า</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">ประเภท</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">ความรุนแรง</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">มูลค่า (฿)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${createTableRows(filteredData)}
                        </tbody>
                    </table>
                </div>
            ` : `
                <div class="text-center py-8">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-info-circle text-lg text-gray-400"></i>
                    </div>
                    <p class="text-gray-500 text-sm">ไม่มีข้อมูลในวันที่เลือก</p>
                </div>
            `;

            if (totalCases === 0) {
                $reportContent.html(`
                    <div class="col-span-3 stat-card rounded-xl shadow-lg p-8 text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-info-circle text-2xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">ไม่พบข้อมูล</h3>
                        <p class="text-gray-500 text-sm">ไม่พบข้อมูลในวันที่เลือก</p>
                    </div>
                    
                    <div class="col-span-3 stat-card rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex w-full items-center">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-calendar-day text-white text-sm"></i>
                                </div>
                                    <h3 class="text-lg font-semibold text-gray-800">ข้อมูลตัวกรอง
                                    </h3>
                            </div>
                            <span class="ml-auto px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">${filteredData.length} เคส</span>
                        </div>
                        <div class="my-4 flex">
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">${reportStartDate || 'ไม่ระบุ'} ถึง ${reportEndDate || 'ไม่ระบุ'}</span>
                            <span class="ml-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">ประเภท: ${reportType || 'ทั้งหมด'}</span>
                            <span class="ml-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">ความรุนแรง: ${reportSeverity || 'ทั้งหมด'}</span>
                            <span class="ml-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">ร้านค้า: ${reportStore || 'ทั้งหมด'}</span>
                        </div>
                        ${dataTable}
                    </div>
                `);
            } else {
                $reportContent.html(`
                    <div class="stat-card rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-10 h-10 gray-bg rounded-lg flex items-center justify-center">
                                <i class="fas fa-clipboard-list text-white text-sm"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold gray-accent">${totalCases}</p>
                                <p class="text-gray-600 font-medium">เคส</p>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">สรุปรวม</h3>
                    </div>
                    
                    <div class="stat-card rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-white text-sm"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-green-600">${totalValue.toLocaleString()}</p>
                                <p class="text-gray-600 font-medium">บาท</p>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">มูลค่ารวม</h3>
                        <p class="text-gray-500 text-sm">ค่าเสียหายทั้งหมด</p>
                    </div>
                    
                    <div class="stat-card rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800">ความรุนแรง</h3>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                    <span class="text-gray-700 font-medium">Green</span>
                                </div>
                                <span class="font-semibold text-green-600">${severityCount['1']} เคส</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                                    <span class="text-gray-700 font-medium">Yellow</span>
                                </div>
                                <span class="font-semibold text-yellow-600">${severityCount['2']} เคส</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                                    <span class="text-gray-700 font-medium">Red</span>
                                </div>
                                <span class="font-semibold text-red-600">${severityCount['3']} เคส</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-span-3 stat-card rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex w-full items-center">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-calendar-day text-white text-sm"></i>
                                </div>
                                    <h3 class="text-lg font-semibold text-gray-800">ข้อมูลตัวกรอง
                                    </h3>
                            </div>
                            <span class="ml-auto px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">${filteredData.length} เคส</span>
                        </div>
                        <div class="my-4 flex">
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">${reportStartDate || 'ไม่ระบุ'} ถึง ${reportEndDate || 'ไม่ระบุ'}</span>
                            <span class="ml-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">ประเภท: ${reportType || 'ทั้งหมด'}</span>
                            <span class="ml-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">ความรุนแรง: ${reportSeverity || 'ทั้งหมด'}</span>
                            <span class="ml-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">ร้านค้า: ${reportStore || 'ทั้งหมด'}</span>
                        </div>
                        ${dataTable}
                    </div>
                `);
            }
        }

        // Send email report
        // function sendEmailReport() {
        //     Swal.fire({
        //         title: '📧 ส่งรายงานทางอีเมล',
        //         input: 'email',
        //         inputLabel: 'อีเมลผู้รับ',
        //         inputPlaceholder: 'example@company.com',
        //         showCancelButton: true,
        //         confirmButtonText: 'ส่งเลย',
        //         cancelButtonText: 'ยกเลิก',
        //         background: 'linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%)',
        //         color: '#1f2937',
        //         confirmButtonColor: '#374151',
        //         cancelButtonColor: '#9ca3af',
        //         inputValidator: (value) => {
        //             if (!value) {
        //                 return 'กรุณากรอกอีเมล'
        //             }
        //             if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
        //                 return 'รูปแบบอีเมลไม่ถูกต้อง'
        //             }
        //         }
        //     }).then((result) => {
        //         if (result.isConfirmed) {
        //             Swal.fire({
        //                 title: 'กำลังส่งอีเมล... 📤',
        //                 html: '<div class="pulse-animation">กรุณารอสักครู่</div>',
        //                 allowOutsideClick: false,
        //                 showConfirmButton: false,
        //                 background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        //                 color: 'white',
        //                 didOpen: () => {
        //                     Swal.showLoading();
        //                 }
        //             });

        //             setTimeout(() => {
        //                 Swal.fire({
        //                     icon: 'success',
        //                     title: 'ส่งรายงานสำเร็จ! ✅',
        //                     text: `ส่งรายงานไปยัง ${result.value} เรียบร้อยแล้ว`,
        //                     timer: 3000,
        //                     showConfirmButton: false,
        //                     background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
        //                     color: 'white'
        //                 });
        //             }, 2000);
        //         }
        //     });
        // }

        // Search input event listener
        $('#searchInput').on('keyup', function (e) {
            if (e.key === 'Enter') {
                searchData();
            }
        });

        // Add some interactive effects
        $(document).ready(function () {
            // Add hover effects to buttons
            $('button').hover(
                function () {
                    $(this).css('transform', 'translateY(-2px)');
                },
                function () {
                    $(this).css('transform', 'translateY(0)');
                }
            );
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/rangePlugin.js"></script>
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/tanaikech/ResumableUploadForGoogleDrive_js@master/resumableupload_js.min.js">
        </script>
    <script>
        const MAX_IMAGES = 3;
        const $imageLabel = $('#image-label');
        const $complainImage = $('#complainImage');
        const $tempImgs = $('#temp-imgs');
        const $imgTemplate = $('#img-template');
        const $solutionImageLabel = $('#solution-image-label');
        const $solutionImage = $('#solutionImage');
        $solutionTempImgs = $('#solution-temp-imgs');

        // Cache DOM queries
        const getImageColumns = () => $('.img-grid-col');
        const getExistingImages = () => $('.img-grid-col img').not('.isNew');
        const getNewImages = () => $('.img-grid-col .isNew');
        const getSolutionImageColumns = () => $('.solution-img-grid-col');
        const getExistingSolutionImages = () => $('.solution-img-grid-col img').not('.isNew');
        const getNewSolutionImages = () => $('.solution-img-grid-col .isNew');

        // Optimized click handler
        $imageLabel.on('click', () => {
            if (!$imageLabel.hasClass('cursor-not-allowed')) {
                $complainImage.click();
            }
        });

        $solutionImageLabel.on('click', () => {
            if (!$solutionImageLabel.hasClass('cursor-not-allowed')) {
                $solutionImage.click();
            }
        });

        // Optimized change handler with debouncing
        let changeTimeout;
        $complainImage.on('change', function (e) {
            clearTimeout(changeTimeout);
            changeTimeout = setTimeout(() => handleImageChange(e), 100);
        });

        $solutionImage.on('change', function (e) {
            clearTimeout(changeTimeout);
            changeTimeout = setTimeout(() => handleSolutionImageChange(e), 100);
        });

        function handleImageChange(e) {
            const files = Array.from(e.target.files);
            const tempFiles = Array.from($tempImgs[0].files);
            console.log('Newly selected files:', files);
            console.log('Previously selected temp files:', tempFiles);

            // Remove duplicates efficiently
            const fileMap = new Map();
            [...tempFiles, ...files].forEach(file => fileMap.set(file.name, file));
            const allFiles = Array.from(fileMap.values());
            console.log('All selected files:', allFiles);

            const existingCount = getExistingImages().length;
            const availableSlots = MAX_IMAGES - existingCount;
            console.log(availableSlots, 'available slots left');

            if (allFiles.length > availableSlots) {
                Swal.fire({
                    icon: 'warning',
                    title: 'เกินจำนวนที่กำหนด! ⚠️',
                    text: `สามารถเลือกได้สูงสุด ${MAX_IMAGES} รูปเท่านั้น`,
                    timer: 3000,
                    showConfirmButton: false,
                    timerProgressBar: true,
                    background: '#ffffff',
                    color: '#1f2937',
                    iconColor: '#f59e0b',
                    customClass: {
                        popup: 'rounded-3xl shadow-2xl',
                        title: 'text-gray-900 font-bold',
                        htmlContainer: 'text-gray-600'
                    }
                });
                return;
            }

            showLoadingSwal();

            const datatransfer = new DataTransfer();
            allFiles.forEach(file => datatransfer.items.add(file));
            $tempImgs[0].files = datatransfer.files;

            renderImagePreview(allFiles);
        }


        function handleSolutionImageChange(e) {
            const files = Array.from(e.target.files);
            const tempFiles = Array.from($solutionTempImgs[0].files);
            console.log('Newly selected solution files:', files);
            console.log('Previously selected solution temp files:', tempFiles);

            // Remove duplicates efficiently
            const fileMap = new Map();
            [...tempFiles, ...files].forEach(file => fileMap.set(file.name, file));
            const allFiles = Array.from(fileMap.values());
            console.log('All selected solution files:', allFiles);

            const existingCount = getExistingSolutionImages().length;
            const availableSlots = MAX_IMAGES - existingCount;
            console.log(availableSlots, 'available solution slots left');

            if (allFiles.length > availableSlots) {
                Swal.fire({
                    icon: 'warning',
                    title: 'เกินจำนวนที่กำหนด! ⚠️',
                    text: `สามารถเลือกได้สูงสุด ${MAX_IMAGES} รูปเท่านั้น`,
                    timer: 3000,
                    showConfirmButton: false,
                    timerProgressBar: true,
                    background: '#ffffff',
                    color: '#1f2937',
                    iconColor: '#f59e0b',
                    customClass: {
                        popup: 'rounded-3xl shadow-2xl',
                        title: 'text-gray-900 font-bold',
                        htmlContainer: 'text-gray-600'
                    }
                });
                return;
            }

            showLoadingSwal();

            const datatransfer = new DataTransfer();
            allFiles.forEach(file => datatransfer.items.add(file));
            $solutionTempImgs[0].files = datatransfer.files;

            renderSolutionImagePreview(allFiles);
        }

        function showLoadingSwal() {
            Swal.fire({
                iconHtml: '<div class="rounded-full h-12 w-12 border-b-2 border-gray-700"><i class="fas fa-image text-2xl text-gray-700"></i></div>',
                title: 'กำลังโหลดรูปภาพ...',
                html: '<p class="text-gray-600 mt-2">กรุณารอสักครู่</p>',
                allowOutsideClick: false,
                showConfirmButton: false,
                background: '#ffffff',
                color: '#1f2937',
                customClass: {
                    icon: 'border-0',
                    popup: 'rounded-3xl shadow-2xl',
                    title: 'text-gray-900 font-bold',
                    htmlContainer: 'text-gray-600'
                },
                didOpen: () => Swal.showLoading()
            });
        }

        function renderImagePreview(allFiles) {
            $('.img-grid-col .isNew').parent().remove()
            allFiles.forEach((file, i) => {
                let eq = (i + $('.img-grid-col img').not('.isNew').length) % 3;
                let reader = new FileReader();
                reader.onload = function (e) {
                    let img = $($('#img-template').html());
                    img.find('img').attr('src', e.target.result).addClass('isNew')
                    img.find('.pending-upload-overlay').removeClass('hidden')
                    img.find('span.remove-image-btn').on('click', function () {
                        let datatransfer = new DataTransfer();
                        let files = $('#temp-imgs')[0].files;
                        for (let i = 0; i < files.length; i++) {
                            if (files[i].name != file.name) {
                                datatransfer.items.add(files[i]);
                            }
                        }
                        $('#temp-imgs')[0].files = datatransfer.files;
                        renderImagePreview([...datatransfer.files]);
                    });
                    img.on('click', function () {
                        showImagePreview(img.find('img').attr('src'));
                    });
                    let div = $('.img-grid-col').eq(eq)
                    div.append(img)
                    if (i == allFiles.length - 1) {
                        Swal.close();
                    }
                    updateImageLabel();
                }
                reader.readAsDataURL(file);
            });

        }

        function renderSolutionImagePreview(allFiles) {
            $('.solution-img-grid-col .isNew').parent().remove()
            allFiles.forEach((file, i) => {
                let eq = (i + $('.solution-img-grid-col img').not('.isNew').length) % 3;
                let reader = new FileReader();
                reader.onload = function (e) {
                    let img = $($('#img-template').html());
                    img.find('img').attr('src', e.target.result).addClass('isNew')
                    img.find('.pending-upload-overlay').removeClass('hidden')
                    img.find('span.remove-image-btn').on('click', function () {
                        let datatransfer = new DataTransfer();
                        let files = $('#solution-temp-imgs')[0].files;
                        for (let i = 0; i < files.length; i++) {
                            if (files[i].name != file.name) {
                                datatransfer.items.add(files[i]);
                            }
                        }
                        $('#solution-temp-imgs')[0].files = datatransfer.files;
                        renderSolutionImagePreview([...datatransfer.files]);
                    });
                    img.on('click', function () {
                        showImagePreview(e.target.src);
                    });
                    let div = $('.solution-img-grid-col').eq(eq)
                    div.append(img)
                    if (i == allFiles.length - 1) {
                        Swal.close();
                    }
                    updateSolutionImageLabel();
                }
                reader.readAsDataURL(file);
            });

        }

        function deleteImage(url, item, type) {
            console.log('Deleting image:', url);
            Swal.fire({
                title: '⚠️ ยืนยันการลบรูปภาพ',
                html: `
                    <div class="text-center py-4">
                        <div class="w-32 h-32 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4 overflow-hidden border-2 border-gray-200">
                            <img src="${url}" alt="Thumbnail" class="w-full h-full object-cover">
                        </div>
                        <p class="text-gray-700 text-lg mb-2">คุณแน่ใจหรือไม่ว่าต้องการลบรูปภาพนี้</p>
                        <p class="text-red-500 text-sm mt-3">⚠️ การดำเนินการนี้ไม่สามารถย้อนกลับได้</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-trash mr-2"></i>ลบรูปภาพ',
                cancelButtonText: '<i class="fas fa-times mr-2"></i>ยกเลิก',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                background: '#ffffff',
                color: '#1f2937',
                iconColor: '#f59e0b',
                reverseButtons: true,
                customClass: {
                    popup: 'rounded-3xl shadow-2xl',
                    title: 'text-gray-900 font-bold',
                    htmlContainer: 'text-gray-600',
                    confirmButton: 'rounded-xl px-6 py-3 font-semibold',
                    cancelButton: 'rounded-xl px-6 py-3 font-semibold'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'กำลังลบรูปภาพ...',
                        html: '<div class="pulse-animation">กรุณารอสักครู่</div>',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        background: '#ffffff',
                        color: '#1f2937',
                        customClass: {
                            popup: 'rounded-3xl shadow-2xl',
                            title: 'text-gray-900 font-bold',
                            htmlContainer: 'text-gray-600'
                        },
                        didOpen: () => {
                            Swal.showLoading()
                        }
                    })
                    // Delete image from Google Drive
                    let fileId = url.split('/d/')[1]?.trim();
                    console.log('File ID to delete:', fileId);
                    callScript({
                        func: 'deleteFileFromDrive',
                        params: {
                            fileId: fileId
                        },
                        onSuccess: (response) => {
                            console.log("Image deleted successfully:", response);
                            Swal.close();
                            // Update local data
                            if (type == 'complain') {
                                batchDOMUpdate(() => {
                                    let images = item.images.filter(img => img != url) || [];
                                    item.images = images;
                                    complainData = complainData.map(cd => cd.id === item.id ? item : cd);
                                    filteredData = filteredData.map(fd => fd.id === item.id ? item : fd);
                                    updateDataTable();
                                    let newImages = $('.img-grid-col img.isNew').toArray().map(img => $(img).attr('src'));
                                    images = images.concat(newImages);
                                    console.log('Updated image list after deletion:', images);
                                    $('.img-grid-col').empty();
                                    if (images.length > 0) {
                                        images.forEach((img, i) => {
                                            let imgElement = $($('#img-template').html());
                                            $('.img-grid-col').eq(i % 3).prepend(imgElement)

                                            imgElement.find('img').attr('src', img);
                                            imgElement.find('span').on('click', function () {
                                                deleteImage(img, item, type);
                                            });
                                            imgElement.find('img').on('click', function () {
                                                let src = imgElement.find('img').attr('src');
                                                showImagePreview(src);
                                            });
                                        });
                                    }
                                    updateImageLabel();
                                });
                            } else if (type == 'solution') {
                                batchDOMUpdate(() => {
                                    let images = item.images || [];
                                    images = images.filter(img => img != url)
                                    item.images = images;
                                    let complainId = currentEditId
                                    complainData = complainData.map(cd => {
                                        if (cd.id === complainId) {
                                            cd.solutions = cd.solutions.map(sol => {
                                                if (sol.id === item.id) {
                                                    return item;
                                                }
                                                return sol;
                                            });
                                        }
                                    })
                                    filteredData = filteredData.map(fd => {
                                        if (fd.id === complainId) {
                                            fd.solutions = fd.solutions.map(sol => {
                                                if (sol.id === item.id) {
                                                    return item;
                                                }
                                                return sol;
                                            });
                                        }
                                    });
                                    updateDataTable();
                                    let newImages = $('.solution-img-grid-col img.isNew').toArray().map(img => $(img).attr('src'));
                                    images = images.concat(newImages);
                                    $('.solution-img-grid-col').empty();
                                    if (images.length > 0) {
                                        images.forEach((img, i) => {
                                            let imgElement = $($('#img-template').html());
                                            $('.solution-img-grid-col').eq(i % 3).prepend(imgElement)

                                            imgElement.find('img').attr('src', img);
                                            imgElement.find('span').on('click', function () {
                                                deleteImage(img, item, 'solution');
                                            });
                                            imgElement.find('img').on('click', function () {
                                                let src = imgElement.find('img').attr('src');
                                                showImagePreview(src);
                                            });
                                        });
                                    }
                                    updateSolutionImageLabel();
                                });
                            }
                        },
                        onFailure: (error) => {
                            console.error("Error deleting image:", error);
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: 'ไม่สามารถลบรูปภาพได้ กรุณาลองใหม่อีกครั้ง',
                                confirmButtonColor: '#374151',
                                customClass: {
                                    icon: 'border-0',
                                    title: 'text-danger',
                                    content: 'text-dark',
                                    popup: 'rounded-4'
                                },
                            });
                        }
                    })

                }
            });
        }

        function updateImageLabel() {
            const count = $('.img-grid-col img').length;

            if (count >= MAX_IMAGES) {
                $imageLabel
                    .html(`
                        <div class="flex flex-col items-center gap-2 opacity-50">
                            <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center">
                                <i class="fas fa-image text-xl text-gray-400"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">ครบจำนวนแล้ว</p>
                                <p class="text-xs text-gray-400">${count}/${MAX_IMAGES} รูปภาพ</p>
                            </div>
                        </div>
                    `)
                    .addClass('cursor-not-allowed')
                    .removeClass('hover:border-gray-400 hover:bg-gradient-to-br hover:from-blue-50 hover:to-gray-100');
            } else {
                $imageLabel
                    .html(`
                        <div class="flex flex-col items-center gap-2">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md group-hover:shadow-lg group-hover:scale-110 transition-all duration-300">
                                <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 group-hover:text-blue-500 transition-colors duration-300"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-700 group-hover:text-gray-900 transition-colors">
                                    คลิกเพื่อเลือกรูปภาพ
                                </p>
                                <p class="text-xs text-gray-500">${count}/${MAX_IMAGES} รูปภาพ | รองรับ JPG, PNG, GIF</p>
                            </div>
                        </div>
                    `)
                    .removeClass('cursor-not-allowed')
                    .addClass('hover:border-gray-400 hover:bg-gradient-to-br hover:from-blue-50 hover:to-gray-100');
            }
        }

        function updateSolutionImageLabel() {
            const count = $('.solution-img-grid-col img').length;

            if (count >= MAX_IMAGES) {
                $solutionImageLabel
                    .html(`
                        <div class="flex flex-col items-center gap-2 opacity-50">
                            <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center">
                                <i class="fas fa-image text-xl text-gray-400"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">ครบจำนวนแล้ว</p>
                                <p class="text-xs text-gray-400">${count}/${MAX_IMAGES} รูปภาพ</p>
                            </div>
                        </div>
                    `)
                    .addClass('cursor-not-allowed')
                    .removeClass('hover:border-gray-400 hover:bg-gradient-to-br hover:from-blue-50 hover:to-gray-100');
            } else {
                $solutionImageLabel
                    .html(`
                        <div class="flex flex-col items-center gap-2">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md group-hover:shadow-lg group-hover:scale-110 transition-all duration-300">
                                <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 group-hover:text-blue-500 transition-colors duration-300"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-700 group-hover:text-gray-900 transition-colors">
                                    คลิกเพื่อเลือกรูปภาพ
                                </p>
                                <p class="text-xs text-gray-500">${count}/${MAX_IMAGES} รูปภาพ | รองรับ JPG, PNG, GIF</p>
                            </div>
                        </div>
                    `)
                    .removeClass('cursor-not-allowed')
                    .addClass('hover:border-gray-400 hover:bg-gradient-to-br hover:from-blue-50 hover:to-gray-100');
            }
        }

        function showImagePreview(src) {
            Swal.fire({
                imageUrl: src,
                imageAlt: 'Preview',
                showConfirmButton: false,
                showCloseButton: true,
                width: '95vw',
                padding: '1rem',
                background: 'rgba(0, 0, 0, 0.95)',
                backdrop: 'rgba(0, 0, 0, 0.9)',
                customClass: {
                    popup: 'rounded-3xl shadow-2xl',
                    image: 'rounded-2xl max-h-[90vh] w-auto object-contain',
                    closeButton: 'text-white hover:text-gray-300 text-3xl'
                },
                didOpen: () => {
                    // Make image clickable to close
                    const image = Swal.getHtmlContainer().querySelector('img');
                    if (image) {
                        image.style.cursor = 'zoom-out';
                        image.style.maxHeight = '90vh';
                        image.style.width = 'auto';
                        image.style.height = 'auto';
                        image.style.objectFit = 'contain';
                        image.addEventListener('click', () => Swal.close());
                    }
                }
            });
        }


        async function uploadComplainFiles() {
            return new Promise(async (resolve, reject) => {
                try {
                    const complainId = $('#editId').val() || generateUniqueId();
                    const uploadedFileIds = await uploadToGoogleDrive(complainId, null, $tempImgs);
                    resolve(uploadedFileIds);
                } catch (error) {
                    console.error('Error uploading files:', error);
                    reject(error);
                }
            });
        }

        async function uploadSolutionFiles(complainId, solutionId) {
            return new Promise(async (resolve, reject) => {
                try {
                    const solutionIdValue = solutionId || $('#solutionId').val() || generateUniqueId();
                    const uploadedFileIds = await uploadToGoogleDrive(complainId, solutionIdValue, $solutionTempImgs);
                    resolve(uploadedFileIds);
                } catch (error) {
                    console.error('Error uploading solution files:', error);
                    reject(error);
                }
            });
        }

        async function uploadToGoogleDrive(complainId, solutionId, tempFiles) {
            const f = tempFiles[0];
            if (f.files.length == 0) {
                return []
            }
            Swal.fire({
                icon: 'info',
                title: 'กำลังอัพโหลดไฟล์',
                html: `
                    <div class="w-full">
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">ความคืบหน้าทั้งหมด</span>
                                <span id="overallPercent" class="text-sm font-bold text-blue-600">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                                <div id="overallProgress" class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                            </div>
                            <div class="mt-2 text-xs text-gray-500 text-center">
                                <span id="uploadStatus">กำลังเตรียมไฟล์...</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 text-base max-h-48 overflow-y-auto" id="progress"></div>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false,
                background: '#ffffff',
                color: '#1f2937',
                iconColor: '#3b82f6',
                customClass: {
                    popup: 'rounded-3xl shadow-2xl',
                    title: 'text-gray-900 font-bold',
                    htmlContainer: 'text-gray-600'
                },
                didOpen: () => {
                    Swal.showLoading()
                },
            })

            const { token, folderId } = await getDownloadToken(complainId, solutionId);

            let file = await new Promise((resolve, reject) => {
                let length = f.files.length;
                let count = 0;
                let uploadfiles = [];
                let totalProgress = 0;

                const updateOverallProgress = () => {
                    const percent = Math.round(totalProgress / length);
                    $('#overallProgress').css('width', percent + '%');
                    $('#overallPercent').text(percent + '%');
                    $('#uploadStatus').text(`กำลังอัพโหลด ${count} จาก ${length} ไฟล์`);
                };

                [...f.files].forEach((file, i) => {
                    let fr = new FileReader();
                    fr.fileName = file.name;
                    fr.fileSize = file.size;
                    fr.fileType = file.type;
                    fr.readAsArrayBuffer(file);
                    fr.onload = e => {
                        var id = "p" + ++i;
                        var div = $("<div>", { class: 'text-xs text-gray-700 truncate px-2 py-1 bg-gray-50 rounded-lg' });
                        div.attr("id", id);
                        $("#progress").append(div);
                        $('#' + id).html('<span class="text-blue-500">กำลังเตรียม...</span> <span class="text-gray-600">' + fr.fileName + '</span>')

                        let fileProgress = 0;

                        const f = e.target;
                        const resource = {
                            fileName: f.fileName,
                            fileSize: f.fileSize,
                            fileType: f.fileType,
                            fileBuffer: f.result,
                            accessToken: token,
                            folderId: folderId,
                            fields: "id",
                        };
                        const ru = new ResumableUploadToGoogleDrive();
                        ru.Do(resource, function (res, err) {
                            if (err) {
                                console.log(err);
                                return;
                            }
                            console.log(res);
                            let msg = "";
                            if (res.status == 'start' || res.status == 'getLocation' || res.status == 'initialize') {
                                msg = '<i class="fas fa-cloud-upload-alt text-blue-500 text-base"></i> <span class="text-gray-700">กำลังเตรียมอัพโหลด</span> <span class="text-gray-500 truncate">' + f.fileName + '</span>';
                            }
                            else if (res.status == "Uploading") {
                                const percent = Math.round((res.progressNumber.current / res.progressNumber.end) * 100);
                                totalProgress = totalProgress - fileProgress + percent;
                                fileProgress = percent;
                                updateOverallProgress();
                                msg = '<i class="fas fa-hourglass-half text-orange-500 text-base"></i> <span class="text-gray-700">กำลังอัพโหลด</span> <span class="font-semibold text-orange-600 truncate">' + percent + '%</span> <span class="text-gray-500">(' + f.fileName + ')</span>';
                            } else {
                                msg = '<i class="fas fa-check-circle text-green-500 text-base"></i> <span class="text-green-600 font-medium">อัพโหลดสำเร็จ</span> <span class="text-gray-500 truncate">(' + f.fileName + ')</span>';
                            }

                            if (res.status == "Done") {
                                totalProgress = totalProgress - fileProgress + 100;
                                fileProgress = 100;
                                count++;
                                updateOverallProgress();
                                uploadfiles.push(res.result.id);
                                if (uploadfiles.length == length) {
                                    $('#uploadStatus').text('อัพโหลดเสร็จสมบูรณ์!').addClass('text-green-600 font-semibold');
                                    resolve(uploadfiles);
                                }
                            }

                            $('#' + id).html(msg)
                        });
                    };
                });
            });
            return { imageIds: file, folderId: folderId };
        }

        function getDownloadToken(complainId, solutionId) {
            console.log("🚀 ~ getDownloadToken ~ solutionId:", solutionId)
            console.log("🚀 ~ getDownloadToken ~ complainId:", complainId)
            return new Promise((resolve, reject) => {
                callScript({
                    func: 'getDownloadToken',
                    params: {
                        complainId: complainId,
                        solutionId: solutionId
                    },
                    onSuccess: (response) => {
                        response = JSON.parse(response);
                        console.log('Received download token:', response);
                        resolve(response);
                    },
                    onFailure: (error) => {
                        error = JSON.parse(error);
                        console.error('Error getting download token:', error);
                        reject(error);
                    }
                });
            });
        }

        function generateUniqueId() {
            const timestamp = Date.now().toString(36);
            const randomNum = Math.floor(Math.random() * 1e6).toString(36);
            return `${timestamp}-${randomNum}`;
        }
    </script>
</body>

</html>