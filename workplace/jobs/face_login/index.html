<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@200;300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'Mitr', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            background-color: #f8f9fa;
        }

        .login-container {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
        }

        .login-container h2 {
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-control {
            border-radius: 4px;
        }

        /* .btn-primary {
            width: 100%;
            padding: 0.75rem;
            border-radius: 4px;
        } */

        .register-link {
            display: block;
            text-align: center;
            margin-top: 1rem;
        }

        #overlay {
            position: absolute;

            display: none;
        }
    </style>

</head>

<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 d-flex justify-content-center">
                <div class="login-container rounded-4">
                    <h2 class="text-center">
                        <span class="text-primary"><i class="bi bi-person-bounding-box"></i> Face</span>
                        Login
                    </h2>
                    <form>
                        <div id="camera" style="width: 100%;"
                            class="bg-body-secondary rounded-4 d-flex justify-content-center align-items-center mb-3">
                            <i class="bi bi-camera-video text-muted" style="font-size: 3rem;"></i>
                            <video id="video" autoplay class="d-none rounded-4" style="width: 100%;"></video>
                            <canvas id="overlay"></canvas>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" id="toggle-camera" class="btn btn-primary rounded-3 w-100">
                                <i class="bi bi-camera-fill me-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                            </button>
                        </div>
                        <div class="d-flex mt-4 justify-content-center">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ?&nbsp;<a href="register.html">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
                            <!-- Don't have an account?&nbsp;<a href="register.html">Register</a> -->
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="selfie-wrapper" class="row justify-content-center mt-3">
        </div>

    </div>
    <script>
        const script_url = 'https://script.google.com/macros/s/AKfycbxlDnwTslbj8FwKHtuDkiI8AJQpCSwhKe4SrKATqnRKh8HyVcUPoUSD4pgAOINNO2qk/exec'
        function isWebGLSupported() {
            try {
                const canvas = document.createElement('canvas');
                return !!window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
            } catch (e) {
                return false;
            }
        }

        $('#toggle-camera').on('click', function () {
            openWebcamForSelfie();
        });

        $(document).ready(function () {
            // Check if device is mobile or PC
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }

            // Display a message about device type
            const deviceType = isMobileDevice() ? 'mobile' : 'desktop';
            console.log(`Device detected: ${deviceType}`);

            // You can also adjust UI elements based on device type
            if (isMobileDevice()) {
                $('#camera, #video').css({
                    'aspect-ratio': '3/4',
                });

            } else {
                $('#camera, #video').css({
                    'aspect-ratio': '4/3',
                });
            }

            if (isWebGLSupported()) {
                Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('./models'),
                    faceapi.nets.faceLandmark68Net.loadFromUri('./models'),
                    faceapi.nets.faceRecognitionNet.loadFromUri('./models'),
                    faceapi.nets.ssdMobilenetv1.loadFromUri('./models')
                    // faceapi.nets.mtcnn.loadFromUri('./models')
                ]).then(() => {
                    console.log(`Models loaded: ${faceapi.tf.engine().state.numTensors} tensors`);
                    Swal.close();
                    console.log(faceapi.nets);
                    console.log('load model success');
                    // $('i.bi-camera-video').addClass('d-none');
                    // $('#video').removeClass('d-none');
                    // openWebcamForSelfie();
                }).catch((err) => console.log(err));
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö WebGL',
                    html: '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö WebGL ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô WebGL ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏ü‡∏•‡∏Å <code>--enable-unsafe-swiftshader</code> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏î‡πâ',
                    customClass: {
                        popup: 'rounded-4',
                    },
                    allowOutsideClick: false,
                });
            }
        });


        async function openWebcamForSelfie() {
            navigator.mediaDevices
                .getUserMedia({
                    video: {
                        facingMode: "user",
                        width: $('#video').width(),
                        height: $('#video').height(),
                        frameRate: {
                            ideal: 30,
                            min: 10
                        }
                    },
                    audio: false,
                })
                .then((stream) => {
                    video.srcObject = stream;
                })
                .catch((error) => {
                    console.error(error);
                });
        }
        let playInterval = null;
        $('#video').on('play', async function () {
            $('i.bi-camera-video').addClass('d-none');
            $('#video').removeClass('d-none');
            onPlay();
            let video = $('#video')[0];
            playInterval = setInterval(async () => {
                if (!video || (!video.paused && !video.ended)) {
                    onPlay();
                }else{
                    clearInterval(playInterval); // Clear the interval if video is paused or ended
                }
            });

        });

        const arr_descriptions = [];
        async function onPlay() {
            const video = document.querySelector('#video');
            const displaySize = $('#video')[0].getBoundingClientRect();
            const canvas = $('#overlay')[0]
            const context = canvas.getContext('2d', { willReadFrequently: true });
            faceapi.matchDimensions(canvas, displaySize);
            // const labels = ["123456"]; // Add your own label
            // const detections = await faceapi
            //     .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
            //         inputSize: 128,
            //         scoreThreshold: 0.5
            //     }))
            const options = new faceapi.TinyFaceDetectorOptions();
            const detections = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor()


            if (!detections) return;

            // Check if detection has valid coordinates before proceeding
            if (!detections.detection || !detections.detection.box) return;

            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            canvas.style.display = 'block';
            context.clearRect(0, 0, canvas.width, canvas.height);
            // Draw green rectangle around face
            context.strokeStyle = '#2ecc71';
            context.lineWidth = 3;
            const box = resizedDetections.detection.box;
            context.strokeRect(box.x, box.y, box.width, box.height);

            context.beginPath();
            context.rect(box.x, box.y, box.width, box.height);
            context.fillStyle = 'rgba(46, 204, 113, 0.3)'; // Semi-transparent green
            context.fill();
            // Optional: Add text label above the face
            context.beginPath();
            context.rect(box.x - 3, box.y - 30, box.width + 6, 30);
            context.fillStyle = '#2ecc71'; // Semi-transparent white
            context.fill();
            context.font = '16px Mitr';
            context.fillStyle = '#000000';
            context.fillText('Face Detected', box.x, box.y - 10); // Centered text


            // Alternative: still use faceapi but with custom options
            // const drawOptions = { boxColor: '#2ecc71', lineWidth: 3 };
            // faceapi.draw.drawDetections(canvas, resizedDetections, drawOptions);
            arr_descriptions.push(detections.descriptor);
            console.log(arr_descriptions.length);
            if (arr_descriptions.length === 20) {
                // pause the video stream and reset UI
                video.pause();

                // $('#video').addClass('d-none');
                // $('#camera').removeClass('d-none');
                // $('#overlay').css('display', 'none');

                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: "rounded-4",
                    }
                });
                playInterval = null; // Clear the interval to stop continuous detection
                // Calculate the average descriptor from the collected face descriptors
                let desc = averageDescriptor(arr_descriptions);
                authenFace(Array.from(desc));

            }
            // localStorage.setItem('faceDescription', JSON.stringify({ label: labels[0], descriptions: Array.from(detections.descriptor) }));
            // matchFace();
            // play video
        }

        function averageDescriptor(descriptors) {
            const avg = new Float32Array(128);
            descriptors.forEach(desc => {
                for (let i = 0; i < 128; i++) {
                    avg[i] += desc[i];
                }
            });
            for (let i = 0; i < 128; i++) {
                avg[i] /= descriptors.length;
            }
            return avg;
        }
        function authenFace(descriptions) {
            console.log("üöÄ ~ authenFace ~ descriptions:", descriptions)
            $.ajax({
                url: script_url,
                method: 'POST',
                data: {
                    descriptions: JSON.stringify(descriptions),
                    opt: 'authenFace'
                },
                success: function (response) {
                    console.log(response);
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',

                            customClass: {
                                popup: "rounded-4",
                            },
                            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                            timer: 2000,
                        }).then(() => {
                            // Stop the camera stream
                            if (video.srcObject) {
                                const tracks = video.srcObject.getTracks();
                                tracks.forEach(track => track.stop());
                                video.srcObject = null;
                                playInterval = null; // Clear the interval to stop continuous detection
                            }
                            $('body')
                                .html('<h1><i class="bi bi-check-circle-fill text-success"></i> ' +
                                    '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h1>' +
                                    '<h1 class="text-center">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ' + response.label + '</h1>').css({
                                        'display': 'flex',
                                        'justify-content': 'center',
                                        'align-items': 'center',
                                        'min-height': '100vh',
                                        'width': '100%',
                                        'background-color': '#f8f9fa',
                                    })
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏î‡πâ',
                            text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
                            customClass: {
                                popup: "rounded-4",
                            },
                            confirmButtonText: '‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà',
                            allowOutsideClick: false,
                        }).then(() => {
                            // $('#video').removeClass('d-none');
                            // $('#camera').addClass('d-none');
                            // $('#overlay').css('display', 'block');
                            arr_descriptions.length = 0; // Clear the descriptions array
                            video.play();
                            // Resume video playback
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error(error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while processing your request.',
                        customClass: {
                            popup: "rounded-4",
                        }
                    });
                }
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>