<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cafe Management System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}
@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
    body {
      font-family: "Sarabun", sans-serif;
      background-color: #f7fafc;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #06b6d4;
      animation: spin 1s ease infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
        0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    .summary-table th,
    .summary-table td {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      text-align: center;
      vertical-align: middle;
    }

    .summary-table th {
      background-color: #f8fafc;
      font-weight: 600;
    }

    .summary-table .header-group {
      background-color: #f1f5f9;
    }

    .summary-table .row-day {
      font-weight: 600;
      background-color: #fefce8;
    }

    .summary-table .row-total {
      font-weight: 700;
      background-color: #eef2ff;
    }

    .summary-table .text-left {
      text-align: left;
    }

    .modal-body::-webkit-scrollbar {
      width: 5px;
    }

    .modal-body::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .modal-body::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 5px;
    }

    .modal-body::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .sticky-col {
      position: -webkit-sticky;
      /* สำหรับ Safari */
      position: sticky;
      z-index: 10;
      /* ทำให้คอลัมน์ที่ Freeze ลอยอยู่เหนือคอลัมน์อื่น */
    }

    .first-col {
      left: 0;
      min-width: 110px;
      /* กำหนดความกว้างขั้นต่ำให้คอลัมน์แรก */
    }

    .second-col {
      left: 110px;
      /* ตำแหน่งของคอลัมน์ที่สอง (ต้องเท่ากับความกว้างของคอลัมน์แรก) */
      min-width: 60px;
    }

    /* กำหนดสีพื้นหลังให้คอลัมน์ที่ Freeze เพื่อไม่ให้มองทะลุเห็นข้อมูลข้างหลัง */
    .summary-table thead .sticky-col {
      background-color: #f8fafc;
    }

    .summary-table tbody tr:not(.row-total):not(.row-day) .sticky-col {
      background-color: #ffffff;
    }

    .summary-table .row-day .sticky-col {
      background-color: #fefce8;
    }

    .summary-table .row-total .sticky-col {
      background-color: #eef2ff;
    }

    /* --- สิ้นสุดส่วนที่เพิ่ม --- */


    /* Sticky header สำหรับตารางในหน้าตรวจสอบ */
    .verify-table-sticky thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f8fafc;
    }

    /* Collapsible supplier groups */
    .supplier-group-header {
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }

    .supplier-group-header:hover {
      background-color: #e5e7eb !important;
    }

    .supplier-content {
      transition: max-height 0.3s ease-out;
      overflow: hidden;
    }

    .supplier-content.collapsed {
      max-height: 0 !important;
    }

    .toggle-icon {
      transition: transform 0.2s;
    }

    .toggle-icon.rotated {
      transform: rotate(-90deg);
    }

    /* Summary box ที่ติดอยู่ */
    .verification-summary-box {
      position: sticky;
      bottom: 0;
      background: white;
      border-top: 2px solid #e5e7eb;
      z-index: 15;
    }
  </style>

</head>

<body class="text-gray-800">
  <div id="loading-overlay" class="loading-overlay hidden"></div>
  <div id="custom-confirm-modal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center"></div>
  <div id="custom-alert-modal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center"></div>
  <div id="verification-modal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-30 flex items-center justify-center p-4">
  </div>

  <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-20">
    <h1 id="header-title" class="text-2xl font-bold text-gray-700"></h1>
    <div id="user-info" class="text-right"></div>
  </header>

  <main id="app-container" class="w-full p-4 md:p-8"></main>

  <script>
    // --- GLOBAL VARIABLES & INITIALIZATION ---
                    let USER_DETAILS = {}, SUPPLIERS = [], PAYMENT_TYPES = [], DISCOUNT_TYPES = [], BRANCHES = [], ALL_BRANCHES = [], BRANCH_EMPLOYEES = [], itemRowCounter = 0;
                    let reportItems = [];
                    let verificationReportItems = [];
                    let BRANCH_COLORS = {};
                    window.onload = function() {
                        setTimeout(function() {
                            showLoading();
                            google.script.run.withSuccessHandler(initializeApp).withFailureHandler(handleError).getInitialDataForUser();
                        }, 200);
                    };

// === KEYBOARD SHORTCUTS ===
document.addEventListener('keydown', function(e) {
  // Ctrl+S = บันทึก/ส่งฟอร์ม
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    const submitButton = document.querySelector('button[onclick*="submitForm"], button[onclick*="handleVerifyReport"]');
    if (submitButton && !submitButton.disabled) {
      submitButton.click();
    }
  }
  
  // Tab = ย้ายระหว่างช่อง input ในแถวเดียวกัน
  if (e.key === 'Tab' && !e.shiftKey) {
    const activeElement = document.activeElement;
    if (activeElement.type === 'number' && activeElement.className.includes('rounded-md')) {
      const currentRow = activeElement.closest('tr');
      if (currentRow) {
        const inputs = currentRow.querySelectorAll('input[type="number"]:not([disabled])');
        const currentIndex = Array.from(inputs).indexOf(activeElement);
        if (currentIndex < inputs.length - 1) {
          e.preventDefault();
          inputs[currentIndex + 1].focus();
          inputs[currentIndex + 1].select();
        }
      }
    }
  }
  
  // Enter = ย้ายไปแถวถัดไป (คอลัมน์เดียวกัน)
  if (e.key === 'Enter') {
    const activeElement = document.activeElement;
    if (activeElement.type === 'number' && activeElement.className.includes('rounded-md')) {
      e.preventDefault();
      const currentRow = activeElement.closest('tr');
      const nextRow = currentRow?.nextElementSibling;
      if (nextRow && !nextRow.classList.contains('bg-gray-50')) {
        const currentCellIndex = Array.from(currentRow.cells).findIndex(cell => cell.contains(activeElement));
        const nextInput = nextRow.cells[currentCellIndex]?.querySelector('input[type="number"]');
        if (nextInput) {
          nextInput.focus();
          nextInput.select();
        }
      }
    }
  }
  
  // Ctrl+Q = เปิด Quick Add Modal
  if ((e.ctrlKey || e.metaKey) && e.key === 'q') {
    e.preventDefault();
    const quickAddButton = document.querySelector('button[onclick*="openQuickAddModal"], button[onclick*="openVerificationQuickAddModal"]');
    if (quickAddButton) {
      quickAddButton.click();
    }
  }
});

// เพิ่ม Tooltip แสดง Shortcuts
function addShortcutTooltips() {
  const style = document.createElement('style');
  style.textContent = `
    .shortcut-hint {
      position: absolute;
      background: #374151;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1000;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
    }
    .has-shortcut {
      position: relative;
    }
    .has-shortcut:hover .shortcut-hint {
      opacity: 0.9;
    }
  `;
  document.head.appendChild(style);
}

// เรียกใช้เมื่อโหลดหน้า
addShortcutTooltips();
                    function initializeApp(initialData) {
                USER_DETAILS = initialData.userDetails;
                SUPPLIERS = initialData.suppliers.sort((a, b) => a.name.localeCompare(b.name));
                PAYMENT_TYPES = initialData.paymentTypes;
                DISCOUNT_TYPES = initialData.discountTypes;
                BRANCHES = initialData.branches;
                ALL_BRANCHES = initialData.allBranches;
                BRANCH_EMPLOYEES = initialData.branchEmployees;
                // เก็บทั้งสองรูปแบบสินค้า: (1) keyed by supplierId (2) keyed by supplierName
                PRODUCTS_BY_SUPPLIER = initialData.productsBySupplier;
                // ถ้า server ส่งแบบชื่อซัพพลายเออร์ไว้แล้ว ให้ใช้เลย — fallback ไปยัง keyed-by-id เพื่อความปลอดภัย
                ALL_PRODUCTS_GROUPED = initialData.productsBySupplierByName || null;
                BRANCH_COLORS = initialData.branchColors || {};

                document.getElementById('user-info').innerHTML = `<div class="font-semibold">${USER_DETAILS.name || 'พนักงาน'}</div><div class="text-sm text-gray-500">${USER_DETAILS.branchName || 'สาขา'} (${USER_DETAILS.role})</div>`;
                showDashboard();
                hideLoading();
            }
                    // --- UI & NAVIGATION ---
                    function showDashboard() {
                        document.getElementById('header-title').innerText = 'แดชบอร์ด';
                        const container = document.getElementById('app-container');
                        const isOffice = USER_DETAILS.role === 'ออฟฟิศ';
                        const isFront = USER_DETAILS.role === 'หน้าร้าน';
                        let dashboardHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                        if (isFront) { 
                          dashboardHtml += `<div onclick="showDailyReportForm()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-cyan-700">📝 สร้างรายงานประจำวัน</h2><p class="text-gray-600 mt-2">บันทึกยอดขาย, สต็อก, สินค้าหมดอายุ และข้อมูลอื่นๆ ประจำรอบ</p></div>`; 
                        dashboardHtml += `<div onclick="showAnalyticsDashboard()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-purple-700">📊 ดูสถิติยอดขาย</h2><p class="text-gray-600 mt-2">ดูกราฟและสถิติการขายของสาขา</p></div>`;
                            dashboardHtml += `<div onclick="showComparisonDashboard()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-indigo-700">📊 เปรียบเทียบกับค่าเฉลี่ย</h2><p class="text-gray-600 mt-2">ดูผลการดำเนินงานของสาขาเทียบกับค่าเฉลี่ยรวม</p></div>`;

                            dashboardHtml += `<div onclick="showRawMaterialOrderForm()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-teal-700">📄 สร้างใบสั่งซื้อวัตถุดิบ</h2><p class="text-gray-600 mt-2">บันทึกสต็อกและส่งใบสั่งซื้อวัตถุดิบเข้าระบบ</p></div>`;


                        }
                        if (isOffice) {
                            dashboardHtml += `<div onclick="showVerifyReportsModule()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-indigo-700">✔️ ตรวจสอบรายงาน</h2><p class="text-gray-600 mt-2">ดูและยืนยันความถูกต้องของรายงานที่สาขาส่งมา</p></div>`;
                            dashboardHtml += `<div onclick="showSalesSummaryModule()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-emerald-700">💰 สรุปยอดและโอนเงิน</h2><p class="text-gray-600 mt-2">ดูสรุปยอดขายรายวันและบันทึกการโอนเงินเข้าบริษัท</p></div>`;
                            dashboardHtml += `<div onclick="showStockOverviewModule()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-blue-700">📊 ภาพรวมสต็อก</h2><p class="text-gray-600 mt-2">ตรวจสอบจำนวนสต็อกคงเหลือล่าสุดของแต่ละสาขา</p></div>`;
                            dashboardHtml += `<div onclick="showOrderClaimModule()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-orange-700">📦 สั่ง/เคลมสินค้า</h2><p class="text-gray-600 mt-2">จัดการสต็อก สั่งซื้อ และเคลมสินค้าหมดอายุ</p></div>`;
                            dashboardHtml += `<div onclick="showReconciliationModule()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-teal-700">💸 กระทบยอดออนไลน์</h2><p class="text-gray-600 mt-2">ตรวจสอบยอดโอนจากพาร์ทเนอร์เดลิเวอรี่และ QR</p></div>`;
                            dashboardHtml += `<div onclick="showAnalyticsDashboard()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-purple-700">📊 วิเคราะห์ยอดขาย</h2><p class="text-gray-600 mt-2">ดูกราฟและสถิติการขายแยกตามสาขา</p></div>`;
                                dashboardHtml += `<div onclick="showComparisonDashboard()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-indigo-700">📊 เปรียบเทียบสถิติสาขา</h2><p class="text-gray-600 mt-2">วิเคราะห์และเปรียบเทียบผลการดำเนินงานระหว่างสาขา</p></div>`;

                                    dashboardHtml += `<div onclick="showTargetMonitoring()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-amber-700">🎯 ติดตามเป้าหมาย</h2><p class="text-gray-600 mt-2">ดูสถานะการบรรลุเป้าหมายเบเกอรี่ทุกสาขา</p></div>`;


                          dashboardHtml += `<div onclick="showPendingOrdersList()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-sky-700">✔️ อนุมัติใบสั่งซื้อวัตถุดิบ</h2><p class="text-gray-600 mt-2">ตรวจสอบและอนุมัติใบสั่งซื้อจากสาขา</p></div>`;



                                    
                        }
                        if (!isFront && !isOffice) { dashboardHtml += `<div class="col-span-full bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-md" role="alert"><p class="font-bold">ไม่พบสิทธิ์ผู้ใช้งาน</p><p>ระบบไม่สามารถระบุสิทธิ์ของคุณได้ (สถานะ: Guest) กรุณาตรวจสอบว่าอีเมล <span class="font-semibold">${USER_DETAILS.email || ''}</span> ถูกเพิ่มในชีท 'Employees' และกำหนด Role เรียบร้อยแล้ว</p></div>`; }
                        dashboardHtml += `</div>`;
                        container.innerHTML = dashboardHtml;
                    }
                    function showLoading() { document.getElementById('loading-overlay').innerHTML = `<div class="spinner"></div>`; document.getElementById('loading-overlay').classList.remove('hidden'); }
                    function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
                    function handleError(error) { hideLoading(); showCustomAlert('เกิดข้อผิดพลาด', error.message, 'error'); console.error(error); }

                    // --- MODALS (ALERT & CONFIRM) ---
                    function showCustomConfirm(title, message, onOk) {
                        const modal = document.getElementById('custom-confirm-modal');
                        modal.innerHTML = `<div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><h3 class="text-lg leading-6 font-bold text-gray-900">${title}</h3><div class="mt-2 px-7 py-3"><p class="text-sm text-gray-600">${message}</p></div><div class="flex justify-center items-center px-4 py-3 space-x-4"><button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300">ยกเลิก</button><button id="confirm-ok-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-700">ตกลง</button></div></div></div>`;
                        modal.classList.remove('hidden');
                        const okBtn = document.getElementById('confirm-ok-btn'); const cancelBtn = document.getElementById('confirm-cancel-btn');
                        const handleOkClick = () => { modal.classList.add('hidden'); onOk(); };
                        const handleCancelClick = () => { modal.classList.add('hidden'); };
                        okBtn.addEventListener('click', handleOkClick, { once: true });
                        cancelBtn.addEventListener('click', handleCancelClick, { once: true });
                    }
                    function showCustomAlert(title, message, type = 'info', onOk = () => {}) {
                        const modal = document.getElementById('custom-alert-modal');
                        let iconHtml = '';
                        if (type === 'success') { iconHtml = `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100"><svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>`; }
                        else if (type === 'error') { iconHtml = `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>`; }
                        else { iconHtml = `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100"><svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>`; }
                        modal.innerHTML = `<div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white"><div class="mt-3 text-center">${iconHtml}<h3 class="text-lg leading-6 font-bold text-gray-900 mt-4">${title}</h3><div class="mt-2 px-7 py-3"><p class="text-sm text-gray-500">${message}</p></div><div class="items-center px-4 py-3"><button id="alert-ok-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700">ตกลง</button></div></div></div>`;
                        modal.classList.remove('hidden');
                        const okBtn = document.getElementById('alert-ok-btn');
                        const handleOkClick = () => { modal.classList.add('hidden'); onOk(); };
                        okBtn.addEventListener('click', handleOkClick, { once: true });
                    }

                    // --- DAILY REPORT FORM (FRONT-OF-HOUSE) ---
                    function showDailyReportForm() {
                document.getElementById('header-title').innerText = 'สร้างรายงานประจำวัน';
                const appContainer = document.getElementById('app-container');

                reportItems = [];
    itemRowCounter = 0;




                const today = new Date();
                const dateString = today.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
                let employeeOptions = ''; BRANCH_EMPLOYEES.forEach(emp => { employeeOptions += `<option value="${emp.name}" data-id="${emp.id}"></option>`; });

                // สร้างตัวเลือกสำหรับ datalist
                const reasonOptions = ['พิมพ์ซ้ำ', 'ลูกค้ายกเลิก', 'แก้ไขรายการ', 'ลืมกดBluePlus'].map(reason => `<option value="${reason}"></option>`).join('');

                appContainer.innerHTML =
                `<div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">
                    <!-- **เพิ่ม datalist ตรงนี้** -->
                    <datalist id="cancellation-reasons">${reasonOptions}</datalist>

                    <button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button>
                    <div class="border-b pb-6 mb-6"><h3 class="text-lg font-semibold text-cyan-600 mb-4">ข้อมูลทั่วไป</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">วันที่รายงาน</label><input type="text" id="report-date" value="${dateString}" class="mt-1 block w-full bg-gray-100 rounded-md border-gray-300" readonly></div><div><label class="block text-sm font-medium text-gray-700">รอบ</label><select id="time-slot" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="เช้า">เช้า</option><option value="บ่าย">บ่าย</option></select></div></div></div>

                    <div class="border-b pb-6 mb-6">
                <h3 class="text-lg font-semibold text-cyan-600 mb-4">รายการสินค้า (มีรหัสสินค้า)</h3>
                <div id="item-rows-container" class="space-y-4"></div>
                <div id="product-totals"></div>
                <button type="button" onclick="openQuickAddModal()" class="mt-4 px-4 py-2 text-sm font-medium rounded-md text-white bg-cyan-600 hover:bg-cyan-700">📋 เลือกสินค้าจากรายการ</button>
            </div>


// แทนที่ส่วน Add-on HTML เดิม
<div class="border-b pb-6 mb-6">
    <h3 class="text-lg font-semibold text-cyan-600 mb-4">รายการสั่งเพิ่ม</h3>
    <div class="space-y-4">
        <div class="p-3 border rounded-lg bg-gray-50">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-800">เปลี่ยนเป็นนมข้าวโอ๊ต (5 บาท)</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-24">
                        <label class="text-xs text-gray-600">จำนวน</label>
                        <input type="number" id="addon-5-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300" 
                               placeholder="0" min="0" oninput="calculateAddOnAmount(5)">
                    </div>
                    <div class="w-32">
                        <label class="text-xs text-gray-600">ยอดขาย (บาท)</label>
                        <input type="number" id="addon-5" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" 
                               placeholder="0.00" readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-3 border rounded-lg bg-gray-50">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-800">รายการเพิ่มราคา 10 บาท</p>
                    <p class="text-xs text-gray-500">(ช็อต / เจลลี่น้ำผึ้ง / เจลลี่กาแฟ)</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-24">
                        <label class="text-xs text-gray-600">จำนวน</label>
                        <input type="number" id="addon-10-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300" 
                               placeholder="0" min="0" oninput="calculateAddOnAmount(10)">
                    </div>
                    <div class="w-32">
                        <label class="text-xs text-gray-600">ยอดขาย (บาท)</label>
                        <input type="number" id="addon-10" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" 
                               placeholder="0.00" readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-3 border rounded-lg bg-gray-50">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-800">รายการเพิ่มราคา 15 บาท</p>
                    <p class="text-xs text-gray-500">(น้ำผึ้ง / ถั่วแดง / น้ำเชื่อมไวท์ช็อค / ซอสคาราเมล)</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-24">
                        <label class="text-xs text-gray-600">จำนวน</label>
                        <input type="number" id="addon-15-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300" 
                               placeholder="0" min="0" oninput="calculateAddOnAmount(15)">
                    </div>
                    <div class="w-32">
                        <label class="text-xs text-gray-600">ยอดขาย (บาท)</label>
                        <input type="number" id="addon-15" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" 
                               placeholder="0.00" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="addon-totals"></div>
</div>


                    <div class="border-b pb-6 mb-6"><h3 class="text-lg font-semibold text-cyan-600 mb-4">ยอดขายตามประเภทเครื่องดื่ม (ไม่มีรหัสสินค้า)</h3><div id="drink-category-container" class="space-y-3"></div><div id="drink-category-totals" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div></div>
                    <div class="border-b pb-6 mb-6"><h3 class="text-lg font-semibold text-cyan-600 mb-4">สรุปยอดขาย (ตามการชำระเงิน)</h3><div id="payment-summary-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div><div id="payment-summary-total" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div></div>
                    <div class="border-b pb-6 mb-6"><h3 class="text-lg font-semibold text-cyan-600 mb-4">สรุปส่วนลด</h3><div id="discount-summary-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div><div id="discount-summary-total" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div></div>
                    <div class="border-b pb-6 mb-6"><h3 class="text-lg font-semibold text-cyan-600 mb-4">รายการยกเลิกบิล</h3><div id="cancellation-rows-container" class="space-y-4"></div><button type="button" onclick="addCancellationRow()" class="mt-4 px-4 py-2 text-sm font-medium rounded-md text-white bg-cyan-600 hover:bg-cyan-700">+ เพิ่มรายการยกเลิกบิล</button></div>
                    <div class="border-b pb-6 mb-6 space-y-4"><div><label for="note" class="block text-sm font-medium text-gray-700">หมายเหตุ</label><textarea id="note" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea></div><div><label for="reporter-name" class="block text-sm font-medium text-gray-700">ผู้บันทึกรายงาน <span class="text-red-500">*</span></label><input type="text" id="reporter-name" list="employee-list" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="เลือกหรือพิมพ์ชื่อ..."><datalist id="employee-list">${employeeOptions}</datalist></div></div>
                    <div class="flex justify-between items-center">
  <div class="text-sm text-gray-500">
    <span class="font-medium">คีย์ลัด:</span> 
    Ctrl+S = บันทึก | Tab = ช่องถัดไป | Enter = แถวถัดไป | Ctrl+Q = เลือกสินค้า
  </div>
  <button type="button" onclick="submitForm()" class="py-3 px-6 text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">ส่งรายงาน</button>
</div>
                </div>`;
                populateDrinkCategories();
                populateSummaries('payment', PAYMENT_TYPES, 'payment-summary-container');
                populateSummaries('discount', DISCOUNT_TYPES, 'discount-summary-container');
                updateTotals('drink');
                updateTotals('payment');
                updateTotals('discount');
            }

            // --- QUICK ADD MODAL & DYNAMIC FORM RENDERING ---

            let ALL_PRODUCTS_GROUPED = null; // Cache for product list

            function openQuickAddModal() {
                const modalId = 'quick-add-modal';
                if (document.getElementById(modalId)) return;

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-xl font-bold">เลือกสินค้าและใส่จำนวน</h3>
                        <button onclick="document.getElementById('${modalId}').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div>
                        <div class="p-4 border-b bg-gray-50"><input type="text" id="product-search-input" placeholder="🔍 ค้นหาสินค้า..." onkeyup="filterQuickAddList()" class="w-full px-4 py-2 border rounded-lg"></div>
                        <div class="p-4 overflow-y-auto flex-1" id="product-list-container"><p class="text-center text-gray-500">กำลังโหลดรายการสินค้า...</p></div>
                        <div class="p-4 border-t flex justify-between items-center bg-gray-50">
                            <span class="text-sm text-gray-600">เลือกแล้ว <span id="selected-count" class="font-bold">0</span> รายการ</span>
                            <div class="space-x-2">
                                <button onclick="document.getElementById('${modalId}').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">ยกเลิก</button>
                                <button onclick="addSelectedProducts()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">เพิ่มสินค้าที่เลือก</button>

                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

if (ALL_PRODUCTS_GROUPED) {
    // ใช้ข้อมูลที่ได้จาก initializeApp โดยตรง
    renderProductList(ALL_PRODUCTS_GROUPED);
} else {
    // fallback: กรณี initialData ไม่มี ส่งคำขอไปยัง server
    google.script.run
        .withSuccessHandler(productsBySupplierByName => {
            ALL_PRODUCTS_GROUPED = productsBySupplierByName;
            renderProductList(productsBySupplierByName);
        })
        .withFailureHandler(handleError)
        .getAllProductsGroupedBySupplier();
}

                //reportItems = [];
                setTimeout(() => {
        document.querySelectorAll('.quick-input-sales, .quick-input-received, .quick-input-expired, .quick-input-stock, .quick-input-transfer').forEach(input => {
            input.value = '';
        });
    }, 100);




            }

            function openVerificationQuickAddModal() {
                syncVerificationItemsFromDOM();
                const modalId = 'verification-quick-add-modal';
                if (document.getElementById(modalId)) return;

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 z-50 flex items-center justify-center p-4';

                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[80vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-xl font-bold">เลือกสินค้าและใส่จำนวน</h3>
                            <button onclick="document.getElementById('${modalId}').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>
                        <div class="p-4 border-b bg-gray-50">
                            <input type="text" id="verify-product-search-input" placeholder="🔍 ค้นหาสินค้า..."
                                   onkeyup="filterVerificationQuickAddList()" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div class="p-4 overflow-y-auto flex-1" id="verification-product-list-container">
                            <p class="text-center text-gray-500">กำลังโหลด...</p>
                        </div>
                        <div class="p-4 border-t flex justify-between items-center bg-gray-50">
                            <span class="text-sm text-gray-600">เลือกแล้ว <span id="verify-selected-count" class="font-bold">0</span> รายการ</span>
                            <div class="space-x-2">
                                <button onclick="document.getElementById('${modalId}').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">ยกเลิก</button>
                                <button onclick="addSelectedProductsToVerification()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">เพิ่มสินค้าที่เลือก</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                renderVerificationProductList();
            }

            function renderProductList(productsBySupplier) {
                const container = document.getElementById('product-list-container');
                const existingProductIds = new Set(reportItems.map(item => item.id));

                // สร้าง branch options สำหรับ dropdown
                let branchOptionsHtml = '<option value="">เลือกสาขา</option>';
                BRANCHES.forEach(b => {
                    branchOptionsHtml += `<option value="${b.id}">${b.name}</option>`;
                });

                let html = '';
                const sortedSuppliers = Object.keys(productsBySupplier).sort();

                for (const supplierName of sortedSuppliers) {
                    const products = productsBySupplier[supplierName];
                    // คำนวณจำนวนสินค้าที่ยังไม่ได้เลือก
            const availableProducts = products.filter(p => !existingProductIds.has(p.id));

            // ถ้าไม่มีสินค้าให้เลือกแล้ว ข้ามไปเลย
            if (availableProducts.length === 0) return;

            html += `
                <div class="supplier-section mb-6">
                    <h4 class="font-bold text-gray-700 mb-2 bg-gray-100 p-2 rounded sticky top-0 z-10 flex justify-between items-center">
                        <span>${supplierName}
                            <span class="text-sm font-normal text-gray-500">
                                (${availableProducts.length} รายการ)
                            </span>
                        </span>




                                <button onclick="toggleAllSupplierProducts('${supplierName}', this)"
                                        class="text-sm text-blue-600 font-medium hover:underline">
                                    เลือกทั้งหมด
                                </button>
                            </h4>




                            <div class="space-y-2" data-supplier-name="${supplierName}">`;

                    products.sort((a,b) => a.name.localeCompare(b.name)).forEach(product => {
                const isExisting = existingProductIds.has(product.id);

                // ซ่อนสินค้าที่เลือกไปแล้ว
                if (isExisting) return;

                const disabledAttr = '';
                const containerClass = 'hover:bg-gray-50';

                        //const containerClass = isExisting ? 'opacity-50 cursor-not-allowed' : '';

                        html += `
                            <div class="product-item border rounded-lg p-3 hover:bg-gray-50 ${containerClass}"
                                 data-name="${product.name.toLowerCase()}">
                                <div class="flex items-center justify-between">
                                    <!-- ส่วนซ้าย: Checkbox และชื่อสินค้า -->
                                    <div class="flex items-center flex-1">
                                        <input type="checkbox"
                                               class="product-checkbox h-4 w-4 rounded border-gray-300 text-blue-600"
                                               data-product-id="${product.id}"
                                               data-product-name="${product.name}"
                                               data-supplier-id="${product.supplierId}"
                                               data-supplier-name="${product.supplierName}"
                                               data-product-price="${product.price}"
                                               onchange="updateSelectedCount()"
                                               ${disabledAttr}>
                                        <span class="ml-3 text-sm font-medium">${product.name}</span>
                                    </div>

                                    <!-- ส่วนขวา: Input Fields -->
                                    <div class="flex items-center gap-2 ml-4">
                                        <!-- ขาย -->
                                        <div class="flex flex-col items-center">
                                            <label class="text-xs text-gray-500">ขาย</label>
                                            <input type="number"
                                                   class="quick-input-sales w-16 px-1 py-1 text-sm border rounded text-center"
                                                   placeholder="0" min="0" ${disabledAttr}>
                                        </div>

                                        <!-- รับเข้า -->
                                        <div class="flex flex-col items-center">
                                            <label class="text-xs text-gray-500">รับ</label>
                                            <input type="number"
                                                   class="quick-input-received w-16 px-1 py-1 text-sm border rounded text-center"
                                                   placeholder="0" min="0" ${disabledAttr}>
                                        </div>

                                        <!-- หมดอายุ -->
                                        <div class="flex flex-col items-center">
                                            <label class="text-xs text-gray-500">หมด</label>

                                            
                                            <input type="number" class="quick-input-expired w-16 px-1 py-1 text-sm border rounded text-center" placeholder="0" min="0" ${disabledAttr}>



                                        </div>

                                        <!-- นับจริง -->
                                        <div class="flex flex-col items-center">
                                            <label class="text-xs text-gray-500">นับ</label>
                                            <input type="number"
                                                   class="quick-input-stock w-16 px-1 py-1 text-sm border rounded text-center"
                                                   placeholder="0" min="0" ${disabledAttr}>
                                        </div>

                                        <!-- ย้าย -->
                                        <div class="flex flex-col items-center">
                                            <label class="text-xs text-gray-500">ย้าย</label>
                                            <input type="number"
                                                   class="quick-input-transfer w-16 px-1 py-1 text-sm border rounded text-center"
                                                   placeholder="0" min="0"
                                                   oninput="toggleTransferBranch(this)"
                                                   ${disabledAttr}>
                                        </div>

                                        <!-- สาขาปลายทาง (ซ่อนไว้ก่อน) -->
                                        <div class="flex flex-col items-center transfer-branch-container hidden">
                                            <label class="text-xs text-gray-500">ไปสาขา</label>
                                            <select class="quick-input-branch w-24 px-1 py-1 text-sm border rounded"
                                                    ${disabledAttr}>
                                                ${branchOptionsHtml}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    });
                    html += '</div></div>';
                }
                container.innerHTML = html;
                updateSelectedCount();
            }

            function filterQuickAddList() {
    const searchTerm = document.getElementById('product-search-input').value.toLowerCase();
    
    // ซ่อน/แสดง products
    document.querySelectorAll('.product-item').forEach(item => {
        const isVisible = item.dataset.name.includes(searchTerm);
        item.style.display = isVisible ? '' : 'none';
    });
    
    // ซ่อน/แสดง supplier sections
    document.querySelectorAll('.supplier-section').forEach(section => {
        const visibleProducts = section.querySelectorAll('.product-item:not([style*="none"])');
        section.style.display = visibleProducts.length > 0 ? '' : 'none';
    });
}

            function updateSelectedCount() {
                const count = document.querySelectorAll('.product-checkbox:checked').length;
                document.getElementById('selected-count').textContent = count;
            }

            function toggleAllSupplierProducts(supplierName, button) {
                const checkboxes = document.querySelectorAll(`div[data-supplier-name="${supplierName}"] .product-checkbox:not(:disabled)`);
                const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !isAllChecked);
                button.textContent = isAllChecked ? 'เลือกทั้งหมด' : 'ยกเลิกทั้งหมด';
                updateSelectedCount();
            }

            function addSelectedProducts() {
    const selectedItems = document.querySelectorAll('.product-checkbox:checked');
    
    if (selectedItems.length === 0) {
        showCustomAlert('ไม่มีสินค้าที่เลือก', 'กรุณาเลือกสินค้าอย่างน้อย 1 รายการ', 'error');
        return;
    }

    selectedItems.forEach(checkbox => {
        const container = checkbox.closest('.product-item');
        
        // ดึงค่าจาก input fields
        const salesQty = container.querySelector('.quick-input-sales')?.value || '';
        const receivedQty = container.querySelector('.quick-input-received')?.value || '';
        const expiredQty = container.querySelector('.quick-input-expired')?.value || '';
        const stockQty = container.querySelector('.quick-input-stock')?.value || '';
        const transferQty = container.querySelector('.quick-input-transfer')?.value || '';
        const toBranch = container.querySelector('.quick-input-branch')?.value || '';

        const alreadyExists = reportItems.some(item => item.id === checkbox.dataset.productId);

        if (!alreadyExists) {
            reportItems.push({
                id: checkbox.dataset.productId,
                name: checkbox.dataset.productName,
                supplierId: checkbox.dataset.supplierId,
                supplierName: checkbox.dataset.supplierName,
                price: checkbox.dataset.productPrice,
                salesQuantity: salesQty,
                receivedQuantity: receivedQty,
                expiredQuantity: expiredQty,
                currentStock: stockQty,
                transferredQuantity: transferQty,
                toBranchId: toBranch
            });
        }
    });

    renderGroupedProductForm();
    calculateProductTotals();
    calculateCashAmount();
    document.getElementById('quick-add-modal').remove();
    
    const addedCount = selectedItems.length;
    if (addedCount > 0) {
        showCustomAlert('เพิ่มสินค้าสำเร็จ', `เพิ่มสินค้า ${addedCount} รายการเรียบร้อยแล้ว`, 'success');
    }
}

            function renderGroupedProductForm() {
                const container = document.getElementById('item-rows-container');
                container.innerHTML = '';
                if (reportItems.length === 0) return;

                const itemsBySupplier = reportItems.reduce((acc, item) => {
                    if (!acc[item.supplierName]) acc[item.supplierName] = [];
                    acc[item.supplierName].push(item);
                    return acc;
                }, {});

                let branchOptions = '<option value="">เลือกสาขา</option>';
                BRANCHES.forEach(b => { branchOptions += `<option value="${b.id}">${b.name}</option>`; });

                Object.keys(itemsBySupplier).sort().forEach(supplierName => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'supplier-group border rounded-lg mb-4';

                    let itemsHtml = '';
                    itemsBySupplier[supplierName].forEach(item => {
                        itemsHtml += `
                            <tr class="product-entry" data-product-id="${item.id}">
                                <td class="p-2 font-medium align-middle">${item.name}</td>
                                <td class="p-1 align-middle text-center">
                                    <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50"
                                           oninput="updateReportItem('${item.id}', 'salesQuantity', this.value)"
                                           value="${item.salesQuantity}">
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50"
                                           oninput="updateReportItem('${item.id}', 'receivedQuantity', this.value)"
                                           value="${item.receivedQuantity}">
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50"
                                           oninput="updateReportItem('${item.id}', 'expiredQuantity', this.value)"
                                           value="${item.expiredQuantity}">
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50"
                                           oninput="updateReportItem('${item.id}', 'currentStock', this.value)"
                                           value="${item.currentStock}">
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50"
                                           oninput="updateReportItem('${item.id}', 'transferredQuantity', this.value); toggleTransferBranchInGroup(this, '${item.id}')"
                                           value="${item.transferredQuantity}">
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <select class="transfer-select w-full rounded-md border-gray-300 text-sm hidden"
                                            oninput="updateReportItem('${item.id}', 'toBranchId', this.value)">
                                        ${branchOptions}
                                    </select>
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <button type="button" onclick="removeProductFromReport('${item.id}')"
                                            class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
                                </td>
                            </tr>
                        `;
                    });

                    groupDiv.innerHTML = `
                        <h4 class="font-bold text-gray-800 bg-gray-100 p-3 rounded-t-lg">${supplierName}</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm table-fixed">
                                <colgroup>
                                    <col style="width: auto; min-width: 200px;">
                                    <col style="width: 80px;">
                                    <col style="width: 80px;">
                                    <col style="width: 80px;">
                                    <col style="width: 80px;">
                                    <col style="width: 80px;">
                                    <col style="width: 120px;">
                                    <col style="width: 50px;">
                                </colgroup>
                                <thead class="text-xs text-gray-500">
                                    <tr>
                                        <th class="p-2 text-left">สินค้า</th>
                                        <th class="p-2 text-center">ขาย</th>
                                        <th class="p-2 text-center">รับเข้า</th>
                                        <th class="p-2 text-center">หมดอายุ</th>
                                        <th class="p-2 text-center">นับจริง</th>
                                        <th class="p-2 text-center">ย้าย</th>
                                        <th class="p-2 text-center">ไปสาขา</th>
                                        <th class="p-2 text-center"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">${itemsHtml}</tbody>
                            </table>
                        </div>
                    `;
                    container.appendChild(groupDiv);

                    // Set selected branch values
                    itemsBySupplier[supplierName].forEach(item => {
                        if (item.transferredQuantity > 0) {
                            const row = document.querySelector(`.product-entry[data-product-id="${item.id}"]`);
                            const select = row.querySelector('.transfer-select');
                            select.classList.remove('hidden');
                            select.value = item.toBranchId || '';
                        }
                    });
                });


                calculateProductTotals();
calculateCashAmount();

            }



            function updateReportItem(productId, field, value) {
                const item = reportItems.find(i => i.id === productId);
                if (item) {
                    item[field] = value;
                }
                if (field === 'salesQuantity') {
    calculateProductTotals();
    calculateCashAmount();
}
            }

            function removeProductFromReport(productId) {
                reportItems = reportItems.filter(item => item.id !== productId);
                renderGroupedProductForm();
                calculateProductTotals();
    calculateCashAmount();
            }

function removeProductFromVerificationReport(productId) {
    // แค่ลบ DOM element ที่ต้องการออก
    const row = document.querySelector(`.product-entry-verify[data-product-id="${productId}"]`);
    if (row) {
        // ลบแถวข้อมูลวันก่อนหน้า (ถ้ามี)
        if (row.nextElementSibling?.classList.contains('bg-gray-50')) {
            row.nextElementSibling.remove();
        }
        row.remove();
    }
    
    // อัพเดท array
    verificationReportItems = verificationReportItems.filter(item => item.id != productId);
    
    // คำนวณใหม่
    calculateVerificationProductTotals();
    calculateVerificationCashAmount();
}


            function toggleTransferBranchInGroup(input, productId) {
                const row = input.closest('.product-entry');
                // ค้นหา <select> ที่มี class 'transfer-select' ที่อยู่ในแถวเดียวกัน
                const select = row.querySelector('.transfer-select');

                // ตรวจสอบค่าที่พิมพ์ในช่อง "ย้าย"
                if (parseFloat(input.value) > 0) {
                    // ถ้ามากกว่า 0 ให้แสดง dropdown
                    select.classList.remove('hidden');
                } else {
                    // ถ้าเป็น 0 หรือว่าง ให้ซ่อน dropdown
                    select.classList.add('hidden');
                    select.value = ''; // ล้างค่าที่เคยเลือกไว้
                    updateReportItem(productId, 'toBranchId', ''); // อัปเดตข้อมูลในหน่วยความจำ
                }
            }




            function renderGroupedProductForm() {
                const container = document.getElementById('item-rows-container');
                container.innerHTML = '';
                if (reportItems.length === 0) return;

                const itemsBySupplier = reportItems.reduce((acc, item) => {
                    if (!acc[item.supplierName]) acc[item.supplierName] = [];
                    acc[item.supplierName].push(item);
                    return acc;
                }, {});

                let branchOptions = '<option value="">เลือกสาขา</option>';
                BRANCHES.forEach(b => { branchOptions += `<option value="${b.id}">${b.name}</option>`; });

                Object.keys(itemsBySupplier).sort().forEach(supplierName => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'supplier-group border rounded-lg';

                    let itemsHtml = '';
                    itemsBySupplier[supplierName].forEach(item => {
                        // --- จุดที่แก้ไข: ย้ายสีพื้นหลังไปไว้ที่ <input> และลบออกจาก <td> ---
                        itemsHtml += `
                            <tr class="product-entry" data-product-id="${item.id}">
                                <td class="p-2 font-medium align-middle">${item.name}</td>
                                <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateReportItem('${item.id}', 'salesQuantity', this.value)" value="${item.salesQuantity}"></td>
                                <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateReportItem('${item.id}', 'receivedQuantity', this.value)" value="${item.receivedQuantity}"></td>
                                <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateReportItem('${item.id}', 'expiredQuantity', this.value)" value="${item.expiredQuantity}"></td>
                                <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateReportItem('${item.id}', 'currentStock', this.value)" value="${item.currentStock}"></td>
                                <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateReportItem('${item.id}', 'transferredQuantity', this.value); toggleTransferBranchInGroup(this, '${item.id}')" value="${item.transferredQuantity}"></td>
                                <td class="p-1 align-middle transfer-cell"><select class="transfer-select w-full rounded-md border-gray-300 text-sm hidden" oninput="updateReportItem('${item.id}', 'toBranchId', this.value)">${branchOptions}</select></td>
                                <td class="p-1 align-middle text-center"><button type="button" onclick="removeProductFromReport('${item.id}')" class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></td>
                            </tr>
                        `;
                    });

                    groupDiv.innerHTML = `
                        <h4 class="font-bold text-gray-800 bg-gray-100 p-3 rounded-t-lg">${supplierName}</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="text-xs text-gray-500">
                                    <tr>
                                        <th class="p-2 text-left w-1/3">สินค้า</th>
                                        <th class="p-2 text-center">ขาย</th>
                                        <th class="p-2 text-center">รับเข้า</th>
                                        <th class="p-2 text-center">หมดอายุ</th>
                                        <th class="p-2 text-center">นับจริง</th>
                                        <th class="p-2 text-center">ย้าย</th>
                                        <th class="p-2 text-left w-1/4">ไปสาขา</th>
                                        <th class="p-2 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">${itemsHtml}</tbody>
                            </table>
                        </div>
                    `;
                    container.appendChild(groupDiv);

                    itemsBySupplier[supplierName].forEach(item => {
                        if (item.transferredQuantity > 0) {
                            const row = document.querySelector(`.product-entry[data-product-id="${item.id}"]`);
                            const select = row.querySelector('.transfer-select');
                            select.classList.remove('hidden');
                            select.value = item.toBranchId || '';
                        }
                    });
                });
            }







            function loadProductList() {
                google.script.run
                    .withSuccessHandler(productsBySupplier => {
                        renderProductList(productsBySupplier);
                    })
                    .withFailureHandler(handleError)
                    .getAllProductsGroupedBySupplier();
            }


            function addPrefilledItemRow(productInfo) {
                itemRowCounter++;
                const container = document.getElementById('item-rows-container');
                const rowDiv = document.createElement('div');
                rowDiv.className = 'p-4 border rounded-lg space-y-3';
                rowDiv.id = `item-row-${itemRowCounter}`;

                let supplierOptions = '';
                SUPPLIERS.forEach(s => {
                    const isSelected = s.id == productInfo.supplierId ? 'selected' : '';
                    supplierOptions += `<option value="${s.id}" ${isSelected}>${s.name}</option>`;
                });

                let branchOptions = '<option value="">เลือกสาขาปลายทาง</option>';
                BRANCHES.forEach(b => { branchOptions += `<option value="${b.id}">${b.name}</option>`; });

                rowDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 relative">
                        <div><label class="text-xs text-gray-600">ซัพพลายเออร์</label><select id="supplier-${itemRowCounter}" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" disabled>${supplierOptions}</select></div>
                        <div><label class="text-xs text-gray-600">สินค้า</label><select id="product-${itemRowCounter}" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" disabled><option value="${productInfo.productId}">${productInfo.productName}</option></select></div>
                        <button onclick="this.parentElement.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold">&times;</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                        <div><label class="text-xs text-gray-600">ขาย</label><input type="number" id="sales-${itemRowCounter}" placeholder="0" min="0" class="mt-1 block w-full text-sm rounded-md border-gray-300"></div>
                        <div><label class="text-xs text-gray-600">รับเข้า</label><input type="number" id="received-${itemRowCounter}" placeholder="0" min="0" class="mt-1 block w-full text-sm rounded-md border-gray-300"></div>
                        <div><label class="text-xs text-gray-600">หมดอายุ</label><input type="number" id="expired-${itemRowCounter}" placeholder="0" min="0" class="mt-1 block w-full text-sm rounded-md border-gray-300"></div>
                        <div><label class="text-xs text-gray-600">นับจริง</label><input type="number" id="stock-${itemRowCounter}" placeholder="0" min="0" class="mt-1 block w-full text-sm rounded-md border-gray-300"></div>
                        <div><label class="text-xs text-gray-600">ย้ายสาขา</label><input type="number" id="transfer-${itemRowCounter}" placeholder="0" min="0" oninput="toggleBranchDropdown(${itemRowCounter})" class="mt-1 block w-full text-sm rounded-md border-gray-300"></div>
                    </div>
                    <div id="transfer-branch-container-${itemRowCounter}" class="hidden pt-2"><label class="text-xs font-medium text-gray-700">ย้ายไปสาขา</label><select id="transfer-branch-${itemRowCounter}" class="mt-1 block w-full text-sm rounded-md border-gray-300">${branchOptions}</select></div>
                `;
                container.appendChild(rowDiv);
            }



                    function populateDrinkCategories() {
                        const container = document.getElementById('drink-category-container');
                        if (!container) return;
                        const categories = ['กาแฟ', 'ชา', 'ช็อกโกแลต', 'นม', 'น้ำผลไม้', 'NPD'];
                        let html = '';
                        categories.forEach(cat => { html += `<div class="p-3 border rounded-lg grid grid-cols-3 gap-4 items-center bg-gray-50"><label class="font-medium text-gray-800 col-span-1">${cat}</label><div class="col-span-1"><label class="text-xs text-gray-600">ยอดขาย (บาท)</label><input type="number" oninput="updateTotals('drink')" id="drink-sales-${cat}" data-category-name="${cat}" class="drink-category-sales-input mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="0.00" step="0.01" min="0"></div><div class="col-span-1"><label class="text-xs text-gray-600">จำนวน (แก้ว)</label><input type="number" oninput="updateTotals('drink')" id="drink-cups-${cat}" data-category-name="${cat}" class="drink-category-cups-input mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="0" min="0"></div></div>`; });
                        container.innerHTML = html;
                    }

                    function toggleBranchDropdown(rowId) { const transferInput = document.getElementById(`transfer-${rowId}`); const branchContainer = document.getElementById(`transfer-branch-container-${rowId}`); const transferValue = parseFloat(transferInput.value) || 0; if (transferValue > 0) { branchContainer.classList.remove('hidden'); } else { branchContainer.classList.add('hidden'); document.getElementById(`transfer-branch-${rowId}`).value = ""; } }



                    function populateSummaries(type, data, containerId) {
                        const container = document.getElementById(containerId);
                        if (!container) return;
                        container.innerHTML = '';
                        data.forEach(item => {
    const field = document.createElement('div');
    if (type === 'payment' && item.name === 'เงินสด') {
        field.innerHTML = `<label class="block text-sm font-medium text-gray-700">${item.name} (อัตโนมัติ)</label>
                          <input type="number" id="${type}-${item.id}" data-type-id="${item.id}" 
                                 class="${type}-summary-input mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" 
                                 placeholder="0.00" readonly>`;
    } else {
        field.innerHTML = `<label class="block text-sm font-medium text-gray-700">${item.name}</label>
                          <input type="number" oninput="updateTotals('${type}')" 
                                 id="${type}-${item.id}" data-type-id="${item.id}" 
                                 class="${type}-summary-input mt-1 block w-full text-sm rounded-md border-gray-300" 
                                 placeholder="0.00" step="0.01" min="0">`;
    }
    container.appendChild(field);
});
                    }
                    function updateTotals(type) {
                        if (type === 'drink') {
                            let totalSales = 0; let totalCups = 0;
                            document.querySelectorAll('.drink-category-sales-input').forEach(input => { totalSales += parseFloat(input.value) || 0; });
                            document.querySelectorAll('.drink-category-cups-input').forEach(input => { totalCups += parseInt(input.value) || 0; });
                            document.getElementById('drink-category-totals').innerHTML = `<span>ยอดขายรวม: <span class="text-cyan-700">${totalSales.toFixed(2)}</span> บาท</span> | <span>จำนวนรวม: <span class="text-cyan-700">${totalCups}</span> แก้ว</span>`;
                        } else if (type === 'payment') {
                            let totalAmount = 0;
                            document.querySelectorAll('.payment-summary-input').forEach(input => { totalAmount += parseFloat(input.value) || 0; });
                            document.getElementById('payment-summary-total').innerHTML = `<span>ยอดรวม: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> บาท</span>`;

                        } else if (type === 'discount') {
                            let totalAmount = 0;
                            document.querySelectorAll('.discount-summary-input').forEach(input => { totalAmount += parseFloat(input.value) || 0; });
                            document.getElementById('discount-summary-total').innerHTML = `<span>ยอดรวม: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> บาท</span>`;
                        }

                        calculateCashAmount();


                    }


                    function submitForm() { showCustomConfirm('ยืนยันการส่งข้อมูล', 'คุณต้องการส่งรายงานนี้ใช่หรือไม่?', proceedWithSubmission); }

                   function proceedWithSubmission() {
                showLoading();
                const reporterNameInput = document.getElementById('reporter-name');
                const reporterName = reporterNameInput.value.trim();
                if (!reporterName) {
                    showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาระบุชื่อผู้บันทึกรายงาน', 'error');
                    hideLoading();
                    return;
                }
                const selectedEmployee = BRANCH_EMPLOYEES.find(emp => emp.name === reporterName);
                const reportData = {
                timeSlot: document.getElementById('time-slot').value,
                note: document.getElementById('note').value,
                reporterInfo: { id: selectedEmployee ? selectedEmployee.id : null, name: reporterName },
                items: [], drinkCategories: [], payments: [], discounts: [], cancelledBills: [], addOns: []
            };

                // **(NEW LOGIC)** Collect data from the global reportItems array
                reportData.items = reportItems.filter(item => {
                    // Only include items that have at least one value entered
                    return item.salesQuantity || item.receivedQuantity || item.expiredQuantity || item.currentStock || item.transferredQuantity;
                }).map(item => ({ // Map to the format expected by the backend
                    productId: item.id,
                    salesQuantity: item.salesQuantity || 0,
                    receivedQuantity: item.receivedQuantity || 0,
                    expiredQuantity: item.expiredQuantity || 0,
                    currentStock: item.currentStock || 0,
                    transferredQuantity: item.transferredQuantity || 0,
                    toBranchId: item.toBranchId || null
                }));

                // Validate that all items with a transfer quantity have a destination branch
                for (const item of reportData.items) {
                    if (item.transferredQuantity > 0 && !item.toBranchId) {
                        const product = reportItems.find(p => p.id === item.productId);
                        showCustomAlert('ข้อมูลไม่ครบถ้วน', `กรุณาเลือกสาขาปลายทางสำหรับสินค้า '${product.name}'`, 'error');
                        hideLoading();
                        return;
                    }
                }
const cancelledBills = [];
let hasIncompleteCancellation = false;

                // Collect other data (same as before)
                document.querySelectorAll('.cancellation-row').forEach(row => { 
                  const billNumber = row.querySelector('.cancel-bill-number').value; 
                  const reason = row.querySelector('.cancel-reason').value; 
                  const amount = row.querySelector('.cancel-amount').value; 
                  const cancelledBy = row.querySelector('.cancel-by-name').value;


                  if (billNumber || reason || amount) { 

                    
                    
        if (!cancelledBy) {
          hasIncompleteCancellation = true;
            showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาระบุผู้ยกเลิกบิลทุกรายการ', 'error');
            hideLoading();
            row.querySelector('.cancel-by-name').style.borderColor = 'red';
            return;
        }else {
            cancelledBills.push({
                billNumber,
                reason,
                amount: parseFloat(amount) || 0,
                cancelledBy: cancelledBy,
                file: null
            });
        }

}

                  });

                  if (hasIncompleteCancellation) {
    showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาระบุผู้ยกเลิกบิลให้ครบทุกรายการ', 'error');
    hideLoading();
    return; // หยุดการทำงานและรอให้แก้ไข
}

reportData.cancelledBills = cancelledBills;


                document.querySelectorAll('.drink-category-sales-input').forEach(input => { const categoryName = input.dataset.categoryName; const salesAmount = input.value || 0; const cupQuantity = document.getElementById(`drink-cups-${categoryName}`).value || 0; reportData.drinkCategories.push({ name: categoryName, salesAmount: salesAmount, cupQuantity: cupQuantity }); });
                document.querySelectorAll('.payment-summary-input').forEach(input => { if (parseFloat(input.value) > 0) reportData.payments.push({ typeId: input.dataset.typeId, amount: input.value }); });
                document.querySelectorAll('.discount-summary-input').forEach(input => { if (parseFloat(input.value) > 0) reportData.discounts.push({ typeId: input.dataset.typeId, amount: input.value }); });

                // เก็บข้อมูล Add-on
// แทนที่ส่วนเก็บข้อมูล Add-on เดิม
const addon5Qty = document.getElementById('addon-5-qty').value;
const addon5Amount = document.getElementById('addon-5').value;
const addon10Qty = document.getElementById('addon-10-qty').value;
const addon10Amount = document.getElementById('addon-10').value;
const addon15Qty = document.getElementById('addon-15-qty').value;
const addon15Amount = document.getElementById('addon-15').value;

if (addon5Amount) reportData.addOns.push({ 
    type: '5บาท', 
    amount: parseFloat(addon5Amount),
    quantity: parseInt(addon5Qty) || 0,
    unitPrice: 5
});
if (addon10Amount) reportData.addOns.push({ 
    type: '10บาท', 
    amount: parseFloat(addon10Amount),
    quantity: parseInt(addon10Qty) || 0,
    unitPrice: 10
});
if (addon15Amount) reportData.addOns.push({ 
    type: '15บาท', 
    amount: parseFloat(addon15Amount),
    quantity: parseInt(addon15Qty) || 0,
    unitPrice: 15
});



                google.script.run.withSuccessHandler(response => { const result = JSON.parse(response); hideLoading(); if (result.status === 'success') { showCustomAlert('สำเร็จ', result.message, 'success', showDashboard); } else { showCustomAlert('เกิดข้อผิดพลาด', result.message, 'error'); } }).withFailureHandler(handleError).submitDailyReport(JSON.stringify(reportData));
            }



                  function addCancellationRow() {
                itemRowCounter++;
                const container = document.getElementById('cancellation-rows-container');
                const rowDiv = document.createElement('div');
                rowDiv.className = 'p-4 border rounded-lg bg-gray-50 relative cancellation-row';
                rowDiv.id = `cancellation-row-${itemRowCounter}`;
    let employeeOptions = '<option value="">-- เลือกหรือพิมพ์ชื่อ --</option>';
    BRANCH_EMPLOYEES.forEach(emp => {
        employeeOptions += `<option value="${emp.name}">${emp.name}</option>`;
    });
                rowDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="text-xs font-medium text-gray-700">เลขที่บิล</label>
                            <input type="text" class="cancel-bill-number mt-1 block w-full text-sm rounded-md border-gray-300">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-700">เหตุผลที่ยกเลิก</label>
                            <!-- **จุดที่แก้ไข:** เพิ่ม list="cancellation-reasons" -->
                            <input type="text" list="cancellation-reasons" class="cancel-reason mt-1 block w-full text-sm rounded-md border-gray-300">
                        </div>

                        <div>
                            <label class="text-xs font-medium text-gray-700">จำนวนเงิน (บาท)</label>
                            <input type="number" class="cancel-amount mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="0.00">
                        </div>
                    </div>

            <div>
                <label class="text-xs font-medium text-gray-700">ผู้ยกเลิกบิล <span class="text-red-500">*</span></label>
                <input type="text" list="cancel-employee-list-${itemRowCounter}" class="cancel-by-name mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="เลือกหรือพิมพ์ชื่อ">
                <datalist id="cancel-employee-list-${itemRowCounter}">${employeeOptions}</datalist>
            </div> 

                    <button onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold">&times;</button>
                `;
                container.appendChild(rowDiv);
            }



                    // --- VERIFICATION MODULE (OFFICE) ---
                    function showVerifyReportsModule() {
                        document.getElementById('header-title').innerText = 'ตรวจสอบรายงาน';
                        const appContainer = document.getElementById('app-container');
                        appContainer.innerHTML = `<div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg"><button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button><h3 class="text-lg font-semibold text-indigo-600 mb-4">รายงานที่รอการตรวจสอบ (Pending)</h3><div id="unverified-reports-list"></div></div>`;
                        const listDiv = document.getElementById('unverified-reports-list');
                        listDiv.innerHTML = `<p>กำลังโหลดรายการ...</p>`;
                        google.script.run.withSuccessHandler(reports => {
                            if (reports.length === 0) { listDiv.innerHTML = '<p>ไม่มีรายงานที่ต้องตรวจสอบ</p>'; return; }
                            let tableHtml = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">วันที่และเวลา</th><th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">รอบ</th><th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">หมายเลขรายงาน</th><th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">สาขา</th><th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">สถานะ</th><th class="px-4 py-3 bg-gray-50"></th></tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                            reports.forEach(report => { tableHtml += `<tr><td class="px-4 py-4 text-sm">${report.reportDate}</td><td class="px-4 py-4 text-sm">${report.timeSlot}</td><td class="px-4 py-4 text-sm font-mono">${report.reportId}</td><td class="px-4 py-4 text-sm">${report.branchName}</td><td class="px-4 py-4 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">${report.status}</span></td><td class="px-4 py-4 text-right text-sm"><button onclick="openVerificationPopup('${report.reportId}')" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-md text-xs">ตรวจสอบ</button></td></tr>`; });
                            tableHtml += '</tbody></table></div>';
                            listDiv.innerHTML = tableHtml;
                        }).withFailureHandler(handleError).getUnverifiedReports();
                    }
let lastOpenTime = 0;













function openVerificationPopup(reportId) {
    // ป้องกันการกดถี่เกินไป
    const now = Date.now();
    if (now - lastOpenTime < 1000) {
        console.log('Please wait before opening another popup');
        return;
    }
    lastOpenTime = now;
    
    showLoading();
    
    // Reset ข้อมูลเก่า
    verificationReportItems = [];
    
    google.script.run.withSuccessHandler(responseString => {
        const response = JSON.parse(responseString);
        if (response.status === 'error') { 
            handleError({ message: response.message }); 
            return; 
        }
        const details = response.data;
      
        // แปลงข้อมูล items
        verificationReportItems = details.items.map(item => {
            const supplier = SUPPLIERS.find(s => s.id === item.supplierId);
            const product = PRODUCTS_BY_SUPPLIER[item.supplierId]?.find(p => p.id === item.productId);
            return {
                id: item.productId,
                name: product ? product.name.split(' ').slice(1).join(' ') : 'Unknown Product',
                supplierId: item.supplierId,
                supplierName: supplier ? supplier.name : 'Unknown Supplier',
                price: product?.price || 0,
                salesQuantity: item.salesQuantity,
                receivedQuantity: item.receivedQuantity,
                expiredQuantity: item.expiredQuantity,
                currentStock: item.currentStock,
                transferredQuantity: item.transferredQuantity,
                toBranchId: item.toBranchId,
                previousData: item.previousData
            };
        });

        const modal = document.getElementById('verification-modal');
        
        // สร้าง HTML components
        let paymentHtml = ''; 
PAYMENT_TYPES.forEach(pt => { 
    const existing = details.payments.find(p => p.typeId == pt.id);
    if (pt.name === 'เงินสด') {
        paymentHtml += `<div>
            <label class="block text-sm font-medium text-gray-700">${pt.name} (อัตโนมัติ)</label>
            <input type="number" data-type-id="${pt.id}" value="${existing ? existing.amount : ''}" 
                   class="verify-payment-summary-input mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" 
                   placeholder="0.00" readonly>
        </div>`; 
    } else {
        paymentHtml += `<div>
            <label class="block text-sm font-medium text-gray-700">${pt.name}</label>
            <input type="number" oninput="updateVerificationTotals('payment'); calculateVerificationCashAmount();" 
                   data-type-id="${pt.id}" value="${existing ? existing.amount : ''}" 
                   class="verify-payment-summary-input mt-1 block w-full text-sm rounded-md border-gray-300" 
                   placeholder="0.00">
        </div>`; 
    }
});
        
        let discountHtml = ''; 
        DISCOUNT_TYPES.forEach(dt => { 
            const existing = details.discounts.find(d => d.typeId == dt.id); 
            discountHtml += `<div><label class="block text-sm font-medium text-gray-700">${dt.name}</label><input type="number" oninput="updateVerificationTotals('discount'); calculateVerificationCashAmount();" data-type-id="${dt.id}" value="${existing ? existing.amount : ''}" class="verify-discount-summary-input mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="0.00"></div>`; 
        });
        
// แทนที่ส่วน addOnHtml
let addOnHtml = `
    <div class="p-3 border rounded-lg bg-gray-50">
        <div class="flex justify-between items-center">
            <div>
                <p class="font-medium text-gray-800">เปลี่ยนเป็นนมข้าวโอ๊ต (5 บาท)</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="w-24">
                    <label class="text-xs text-gray-600">จำนวน</label>
                    <input type="number" id="verify-addon-5-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300"
                           value="${details.addOns?.find(a => a.type === '5บาท')?.quantity || ''}" placeholder="0"
                           oninput="calculateVerificationAddOnAmount(5)">
                </div>
                <div class="w-32">
                    <label class="text-xs text-gray-600">ยอดขาย (บาท)</label>
                    <input type="number" id="verify-addon-5" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100"
                           value="${details.addOns?.find(a => a.type === '5บาท')?.amount || ''}" placeholder="0.00" readonly>
                </div>
            </div>
        </div>
    </div>
    <div class="p-3 border rounded-lg bg-gray-50 mt-3">
        <div class="flex justify-between items-center">
            <div>
                <p class="font-medium text-gray-800">รายการเพิ่มราคา 10 บาท</p>
                <p class="text-xs text-gray-500">(ช็อต / เจลลี่น้ำผึ้ง / เจลลี่กาแฟ)</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="w-24">
                    <label class="text-xs text-gray-600">จำนวน</label>
                    <input type="number" id="verify-addon-10-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300"
                           value="${details.addOns?.find(a => a.type === '10บาท')?.quantity || ''}" placeholder="0"
                           oninput="calculateVerificationAddOnAmount(10)">
                </div>
                <div class="w-32">
                    <label class="text-xs text-gray-600">ยอดขาย (บาท)</label>
                    <input type="number" id="verify-addon-10" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100"
                           value="${details.addOns?.find(a => a.type === '10บาท')?.amount || ''}" placeholder="0.00" readonly>
                </div>
            </div>
        </div>
    </div>
    <div class="p-3 border rounded-lg bg-gray-50 mt-3">
        <div class="flex justify-between items-center">
            <div>
                <p class="font-medium text-gray-800">รายการเพิ่มราคา 15 บาท</p>
                <p class="text-xs text-gray-500">(น้ำผึ้ง / ถั่วแดง / น้ำเชื่อมไวท์ช็อค / ซอสคาราเมล)</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="w-24">
                    <label class="text-xs text-gray-600">จำนวน</label>
                    <input type="number" id="verify-addon-15-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300"
                           value="${details.addOns?.find(a => a.type === '15บาท')?.quantity || ''}" placeholder="0"
                           oninput="calculateVerificationAddOnAmount(15)">
                </div>
                <div class="w-32">
                    <label class="text-xs text-gray-600">ยอดขาย (บาท)</label>
                    <input type="number" id="verify-addon-15" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100"
                           value="${details.addOns?.find(a => a.type === '15บาท')?.amount || ''}" placeholder="0.00" readonly>
                </div>
            </div>
        </div>
    </div>
`;
        
        let drinkCategoryHtml = ''; 
        const categories = ['กาแฟ', 'ชา', 'ช็อกโกแลต', 'นม', 'น้ำผลไม้', 'NPD'];
        categories.forEach(cat => { 
            const existing = details.drinkCategories.find(d => d.categoryName === cat); 
            drinkCategoryHtml += `<div class="p-3 border rounded-lg grid grid-cols-3 gap-4 items-center bg-gray-50">
    <label class="font-medium text-gray-800 col-span-1">${cat}</label>
    <div class="col-span-1">
        <label class="text-xs text-gray-600">ยอดขาย (บาท)</label>
        <input type="number" oninput="updateVerificationTotals('drink'); calculateVerificationCashAmount();" 
               data-category-name="${cat}" value="${existing ? existing.salesAmount : ''}" 
               class="verify-drink-sales-input mt-1 w-full text-sm rounded-md border-gray-300" placeholder="0.00">
    </div>
    <div class="col-span-1">
        <label class="text-xs text-gray-600">จำนวน (แก้ว)</label>
        <input type="number" oninput="updateVerificationTotals('drink'); calculateVerificationCashAmount();" 
               data-category-name="${cat}" value="${existing ? existing.cupQuantity : ''}" 
               class="verify-drink-cups-input mt-1 w-full text-sm rounded-md border-gray-300" placeholder="0">
    </div>
</div>`; 
        });
        
        let cancelledBillsHtml = '';
        if (details.cancelledBills) {
            details.cancelledBills.forEach(bill => { 

let verifyEmployeeOptions = '<option value="">-- เลือกหรือพิมพ์ชื่อ --</option>';
        BRANCH_EMPLOYEES.forEach(emp => {
            verifyEmployeeOptions += `<option value="${emp.name}">${emp.name}</option>`;
        });

                cancelledBillsHtml += `
                <div class="p-3 border rounded-lg grid grid-cols-1 md:grid-cols-3 gap-4 items-center bg-gray-50 relative verify-cancellation-row">
                
                <div><label class="text-xs">เลขที่บิล</label>
                <input type="text" value="${bill.billNumber || ''}" class="verify-cancel-bill-number mt-1 w-full text-sm rounded-md"></div>
                
                <div><label class="text-xs">เหตุผล</label>
                <input type="text" list="cancellation-reasons" value="${bill.reason || ''}" class="verify-cancel-reason mt-1 w-full text-sm rounded-md"></div>
                
                <div><label class="text-xs">ผู้ยกเลิก</label>
                <input type="text" list="verify-cancel-employee-list-${bill.billNumber}" value="${bill.cancelledBy || ''}" class="verify-cancel-by-name mt-1 w-full text-sm rounded-md">
                <datalist id="verify-cancel-employee-list-${bill.billNumber}">${verifyEmployeeOptions}</datalist>
                </div>


                <div><label class="text-xs">จำนวนเงิน</label>
                <input type="number" value="${bill.amount || ''}" class="verify-cancel-amount mt-1 w-full text-sm rounded-md"></div>
                
                <button onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div>`; 
            });
        }
        
        const reasonOptions = ['พิมพ์ซ้ำ', 'ลูกค้ายกเลิก', 'แก้ไขรายการ', 'ลืมกดBluePlus'].map(reason => `<option value="${reason}"></option>`).join('');
        
        modal.innerHTML = `<div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-full max-h-[90vh] flex flex-col" data-branch-id="${details.branchId}" data-report-date="${details.rawReportDate}">
            <datalist id="cancellation-reasons">${reasonOptions}</datalist>
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">ตรวจสอบรายงาน - ${reportId}</h3>
                <button onclick="closeVerificationPopup()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto modal-body space-y-6">
                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">ข้อมูลทั่วไป</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm">วันที่รายงาน</label><input type="text" value="${details.reportDate}" class="mt-1 w-full bg-gray-100 rounded-md" readonly></div>
                        <div><label class="block text-sm">รอบ</label><select id="verify-time-slot" class="mt-1 w-full rounded-md"><option value="เช้า" ${details.timeSlot === 'เช้า' ? 'selected' : ''}>เช้า</option><option value="บ่าย" ${details.timeSlot === 'บ่าย' ? 'selected' : ''}>บ่าย</option></select></div>
                    </div>
                </div>



<div class="border-b pb-4">
    
    <div class="sticky top-0 bg-white z-20 pb-2 border-b">


    <h4 class="font-semibold text-cyan-600 mb-2">รายการสินค้า</h4>
        <div class="flex justify-between items-center">
        
            <div>
                <button type="button" onclick="openVerificationQuickAddModal()" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-cyan-600 hover:bg-cyan-700 mr-2">📋 เลือกสินค้าจากรายการ</button>
                <button type="button" onclick="toggleAllSuppliers()" class="px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">พับ/ขยายทั้งหมด</button>
            </div>

            <div id="verify-product-totals" class="p-3 font-bold text-right"></div>
        </div>
    </div>
    <div id="verification-item-rows-container" class="space-y-6 mt-4"></div>
</div>



                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">รายการสั่งเพิ่ม</h4>
                    <div class="space-y-3">${addOnHtml}</div>
                    <div id="verify-addon-totals"></div>
                </div>
                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">ยอดขายตามประเภทเครื่องดื่ม</h4>
                    <div class="space-y-3">${drinkCategoryHtml}</div>
                    <div id="verify-drink-category-totals" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div>
                </div>
                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">สรุปยอดขาย</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${paymentHtml}</div>
                    <div id="verify-payment-summary-total" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div>
                </div>
                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">สรุปส่วนลด</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${discountHtml}</div>
                    <div id="verify-discount-summary-total" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div>
                </div>
                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">รายการยกเลิกบิล</h4>
                    <div id="verify-cancellation-rows-container" class="space-y-3">${cancelledBillsHtml}</div>
                    <button type="button" onclick="addCancellationRowForVerification()" class="mt-2 px-3 py-1 text-xs rounded-md text-white bg-cyan-600 hover:bg-cyan-700">+ เพิ่มรายการยกเลิกบิล</button>
                </div>
                <div>
                    <h4 class="font-semibold text-cyan-600 mb-2">หมายเหตุ</h4>
                    <textarea id="verify-note" class="w-full rounded-md">${details.note || ''}</textarea>
                </div>
            </div>
            <div class="flex justify-between items-center p-4 border-t bg-gray-50">
                <button id="verify-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">ลบรายงาน</button>
                <button id="verify-confirm-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">ยืนยันการตรวจสอบ</button>
            </div>
        </div>`;
        
        modal.classList.remove('hidden');
        document.getElementById('verify-delete-btn').addEventListener('click', () => handleDeleteReport(reportId));
        document.getElementById('verify-confirm-btn').addEventListener('click', () => handleVerifyReport(reportId));
        renderVerificationGroupedProductForm();
        updateVerificationTotals('drink');
        updateVerificationTotals('payment');
        updateVerificationTotals('discount');
        if (typeof calculateVerificationProductTotals === 'function') {
            calculateVerificationProductTotals();
        }
        if (typeof calculateVerificationAddOnTotals === 'function') {
            calculateVerificationAddOnTotals();
        }
        if (typeof calculateVerificationCashAmount === 'function') {
    calculateVerificationCashAmount();

}


        hideLoading();
    }).withFailureHandler(handleError).getReportDetails(reportId);
}

function toggleAllSuppliers() {
    const allHeaders = document.querySelectorAll('.supplier-group-header');
    const firstContent = allHeaders[0]?.nextElementSibling;
    const shouldExpand = firstContent?.classList.contains('collapsed');
    
    allHeaders.forEach(header => {
        const content = header.nextElementSibling;
        const icon = header.querySelector('.toggle-icon');
        
        if (shouldExpand) {
            content.style.maxHeight = '5000px';
            content.classList.remove('collapsed');
            icon.classList.remove('rotated');
        } else {
            content.style.maxHeight = '0';
            content.classList.add('collapsed');
            icon.classList.add('rotated');
        }
    });
}


            






            function renderVerificationProductList() {
                const container = document.getElementById('verification-product-list-container');
                const existingProductIds = new Set(verificationReportItems.map(item => item.id));

                // สร้าง branch options สำหรับ dropdown
                let branchOptionsHtml = '<option value="">เลือกสาขา</option>';
                BRANCHES.forEach(b => {
                    branchOptionsHtml += `<option value="${b.id}">${b.name}</option>`;
                });

                // เพิ่ม CSS classes สำหรับกำหนดความกว้างคงที่
                const tableStyles = `
                    <style>
                        .quick-add-table { table-layout: fixed; width: 100%; }
                        .quick-add-table .col-checkbox { width: 40px; }
                        .quick-add-table .col-name { width: auto; min-width: 250px; }
                        .quick-add-table .col-number { width: 60px; }
                        .quick-add-table .col-branch { width: 100px; }
                        .quick-add-table input[type="number"] { width: 100%; }
                        .quick-add-table select { width: 100%; }
                    </style>
                `;

                let html = tableStyles;
                const productsToUse = PRODUCTS_BY_SUPPLIER || ALL_PRODUCTS_GROUPED;

                if (!productsToUse) {
                    container.innerHTML = '<p class="text-center text-red-500">ไม่พบข้อมูลสินค้า</p>';
                    return;
                }

                const sortedSuppliers = Object.keys(productsToUse).sort((a,b) => {
                    const supplierA = SUPPLIERS.find(s => s.id === a);
                    const supplierB = SUPPLIERS.find(s => s.id === b);
                    return (supplierA?.name || '').localeCompare(supplierB?.name || '');
                });

                for (const supplierId of sortedSuppliers) {
                    const supplierName = SUPPLIERS.find(s => s.id === supplierId)?.name || 'Unknown Supplier';
                    const products = productsToUse[supplierId];

                    // คำนวณจำนวนสินค้าที่ยังไม่ได้เลือก
                    const availableProducts = products.filter(p => !existingProductIds.has(p.id));

                    // ถ้าไม่มีสินค้าให้เลือกแล้ว ข้ามไปเลย
                    if (availableProducts.length === 0) continue;

                    html += `
                        <div class="supplier-section mb-6">
                            <h4 class="font-bold text-gray-700 mb-2 bg-gray-100 p-2 rounded sticky top-0 z-10 flex justify-between items-center">
                                <span>${supplierName}
                                    <span class="text-sm font-normal text-gray-500">
                                        (${availableProducts.length} รายการ)
                                    </span>
                                </span>
                                <button onclick="toggleAllVerificationProducts('${supplierId}', this)"
                                        class="text-sm text-blue-600 font-medium hover:underline">
                                    เลือกทั้งหมด
                                </button>
                            </h4>

                            <div class="overflow-x-auto">
                                <table class="quick-add-table">
                                    <thead>
                                        <tr class="text-xs text-gray-500 border-b">
                                            <th class="col-checkbox text-left py-2 px-2"></th>
                                            <th class="col-name text-left py-2 px-2">สินค้า</th>
                                            <th class="col-number text-center py-2 px-1">ขาย</th>
                                            <th class="col-number text-center py-2 px-1">รับ</th>
                                            <th class="col-number text-center py-2 px-1">หมด</th>
                                            <th class="col-number text-center py-2 px-1">นับ</th>
                                            <th class="col-number text-center py-2 px-1">ย้าย</th>
                                            <th class="col-branch text-center py-2 px-1">ไปสาขา</th>
                                        </tr>
                                    </thead>
                                    <tbody data-supplier-id="${supplierId}">`;

                    availableProducts.sort((a,b) => a.name.localeCompare(b.name)).forEach(product => {
                        const productName = product.name.split(' ').slice(1).join(' ');

                        html += `
                            <tr class="product-item-verify border-b hover:bg-gray-50"
                                data-name="${productName.toLowerCase()}">
                                <td class="col-checkbox py-2 px-2">
                                    <input type="checkbox"
                                           class="product-checkbox-verify h-4 w-4 rounded border-gray-300 text-blue-600"
                                           data-product-id="${product.id}"
                                           data-product-name="${productName}"
                                           data-supplier-id="${supplierId}"
                                           data-supplier-name="${supplierName}"
                                           data-product-price="${product.price || 0}"
                                           onchange="updateVerificationSelectedCount()">
                                </td>

                                <td class="col-name py-2 px-2">
                                    <span class="text-sm font-medium block">${productName}</span>
                                </td>

                                <td class="col-number py-2 px-1">
                                    <input type="number"
                                           class="verify-quick-input-sales px-1 py-1 text-sm border rounded text-center"
                                           placeholder="0" min="0">
                                </td>

                                <td class="col-number py-2 px-1">
                                    <input type="number"
                                           class="verify-quick-input-received px-1 py-1 text-sm border rounded text-center"
                                           placeholder="0" min="0">
                                </td>

                                <td class="col-number py-2 px-1">
                                    <input type="number"
                                           class="verify-quick-input-expired px-1 py-1 text-sm border rounded text-center"
                                           placeholder="0" min="0">
                                </td>

                                <td class="col-number py-2 px-1">
                                    <input type="number"
                                           class="verify-quick-input-stock px-1 py-1 text-sm border rounded text-center"
                                           placeholder="0" min="0">
                                </td>

                                <td class="col-number py-2 px-1">
                                    <input type="number"
                                           class="verify-quick-input-transfer px-1 py-1 text-sm border rounded text-center"
                                           placeholder="0" min="0"
                                           oninput="toggleVerifyTransferBranch(this)">
                                </td>

                                <td class="col-branch py-2 px-1">
                                    <select class="verify-quick-input-branch px-1 py-1 text-sm border rounded hidden">
                                        ${branchOptionsHtml}
                                    </select>
                                </td>
                            </tr>`;
                    });

                    html += '</tbody></table></div></div>';
                }

                container.innerHTML = html;
                updateVerificationSelectedCount();
            }

            function toggleVerifyTransferBranch(input) {
                const row = input.closest('tr');
                const branchSelect = row.querySelector('.verify-quick-input-branch');

                if (parseFloat(input.value) > 0) {
                    branchSelect.classList.remove('hidden');
                } else {
                    branchSelect.classList.add('hidden');
                    branchSelect.value = '';
                }
            }


            function filterVerificationQuickAddList() {
    const searchTerm = document.getElementById('verify-product-search-input').value.toLowerCase();
    
    // ซ่อน/แสดง products
    document.querySelectorAll('.product-item-verify').forEach(item => {
        item.style.display = item.dataset.name.includes(searchTerm) ? '' : 'none';
    });
    
    // ซ่อน/แสดง supplier sections
    document.querySelectorAll('.supplier-section').forEach(section => {
        const visibleProducts = section.querySelectorAll('.product-item-verify:not([style*="none"])');
        section.style.display = visibleProducts.length > 0 ? 'block' : 'none';
    });
}

            function updateVerificationSelectedCount() {
                const count = document.querySelectorAll('.product-checkbox-verify:checked').length;
                document.getElementById('verify-selected-count').textContent = count;
            }

            function toggleAllVerificationProducts(supplierId, button) {
    const checkboxes = document.querySelectorAll(`tbody[data-supplier-id="${supplierId}"] .product-checkbox-verify:not(:disabled)`);
    const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !isAllChecked);
    button.textContent = isAllChecked ? 'เลือกทั้งหมด' : 'ยกเลิกทั้งหมด';
    updateVerificationSelectedCount();
}

            function addSelectedProductsToVerification() {
    // บันทึกค่าปัจจุบันจาก form ก่อน
    const currentValues = {};
    document.querySelectorAll('.product-entry-verify').forEach(row => {
        const productId = row.dataset.productId;
        if (productId) {
            currentValues[productId] = {
                sales: row.querySelector('input[oninput*="salesQuantity"]')?.value || '',
                received: row.querySelector('input[oninput*="receivedQuantity"]')?.value || '',
                expired: row.querySelector('input[oninput*="expiredQuantity"]')?.value || '',
                stock: row.querySelector('input[oninput*="currentStock"]')?.value || '',
                transfer: row.querySelector('input[oninput*="transferredQuantity"]')?.value || '',
                branch: row.querySelector('.transfer-select-verify')?.value || ''
            };
        }
    });
    
    // อัพเดทค่าใน verificationReportItems
    verificationReportItems.forEach(item => {
        if (currentValues[item.id]) {
            item.salesQuantity = currentValues[item.id].sales;
            item.receivedQuantity = currentValues[item.id].received;
            item.expiredQuantity = currentValues[item.id].expired;
            item.currentStock = currentValues[item.id].stock;
            item.transferredQuantity = currentValues[item.id].transfer;
            item.toBranchId = currentValues[item.id].branch;
        }
    });
    
    // เพิ่มสินค้าใหม่
    const selectedItems = document.querySelectorAll('.product-checkbox-verify:checked');
    
    selectedItems.forEach(checkbox => {
        const container = checkbox.closest('.product-item-verify');
        
        const salesQty = container.querySelector('.verify-quick-input-sales')?.value || '';
        const receivedQty = container.querySelector('.verify-quick-input-received')?.value || '';
        const expiredQty = container.querySelector('.verify-quick-input-expired')?.value || '';
        const stockQty = container.querySelector('.verify-quick-input-stock')?.value || '';
        const transferQty = container.querySelector('.verify-quick-input-transfer')?.value || '';
        const toBranch = container.querySelector('.verify-quick-input-branch')?.value || '';
        
        const alreadyExists = verificationReportItems.some(item => item.id === checkbox.dataset.productId);
        
        if (!alreadyExists) {

            verificationReportItems.push({
                id: checkbox.dataset.productId,
                name: checkbox.dataset.productName,
                supplierId: checkbox.dataset.supplierId,
                supplierName: checkbox.dataset.supplierName,
                price: parseFloat(checkbox.dataset.productPrice) || 0,
                salesQuantity: salesQty,
                receivedQuantity: receivedQty,
                expiredQuantity: expiredQty,
                currentStock: stockQty,
                transferredQuantity: transferQty,
                toBranchId: toBranch,
                previousData: null
            });
        }
    });
    
    // Render ใหม่
    renderVerificationGroupedProductForm();
    calculateVerificationProductTotals();
    calculateVerificationCashAmount();
    // ปิด modal และแสดง verification modal
    document.getElementById('verification-quick-add-modal')?.remove();
}

            // ฟังก์ชันใหม่: แสดง/ซ่อน dropdown สาขาเมื่อใส่จำนวนย้าย
            function toggleTransferBranch(input) {
                const container = input.closest('.product-item');
                const branchContainer = container.querySelector('.transfer-branch-container');
                const branchSelect = container.querySelector('.quick-input-branch');

                if (parseFloat(input.value) > 0) {
                    branchContainer.classList.remove('hidden');
                } else {
                    branchContainer.classList.add('hidden');
                    branchSelect.value = ''; // Clear selection
                }
            }

            // ฟังก์ชันเสริม: ล้างข้อมูล input ทั้งหมด
            function clearAllInputs() {
                document.querySelectorAll('.product-item input[type="number"]').forEach(input => {
                    input.value = '';
                });
                document.querySelectorAll('.quick-input-branch').forEach(select => {
                    select.value = '';
                });
                document.querySelectorAll('.transfer-branch-container').forEach(container => {
                    container.classList.add('hidden');
                });
            }

function renderVerificationGroupedProductForm() {
    const container = document.getElementById('verification-item-rows-container');
    container.innerHTML = '';
    if (verificationReportItems.length === 0) return;

    const itemsBySupplier = verificationReportItems.reduce((acc, item) => {
        if (!acc[item.supplierName]) acc[item.supplierName] = [];
        acc[item.supplierName].push(item);
        return acc;
    }, {});

    let branchOptions = '<option value="">เลือกสาขา</option>';
    BRANCHES.forEach(b => { branchOptions += `<option value="${b.id}">${b.name}</option>`; });

    Object.keys(itemsBySupplier).sort().forEach((supplierName, index) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'supplier-group border rounded-lg mb-4';
        let itemsHtml = '';
        itemsBySupplier[supplierName].forEach(item => {
    const isValidStock = checkStockValidity(item);
    const rowClass = isValidStock ? '' : 'bg-red-50';

    let previousDataHtml = '';
    if (item.previousData) {
        const prev = item.previousData;
        const prevDate = new Date(prev.reportDate).toLocaleDateString('th-TH');
        previousDataHtml = `
            <tr class="bg-gray-50 text-xs">
                <td class="p-2 text-gray-500" colspan="1">ข้อมูลวันก่อนหน้า (${prevDate}):</td>
                <td class="p-2 text-center text-gray-600">${prev.salesQuantity||0}</td>
                <td class="p-2 text-center text-gray-600">${prev.receivedQuantity||0}</td>
                <td class="p-2 text-center text-gray-600">${prev.expiredQuantity||0}</td>
                <td class="p-2 text-center text-gray-600 font-bold">${prev.currentStock||0}</td>
                <td class="p-2 text-center text-gray-600">${prev.transferredQuantity||0}</td>
                <td class="p-2 text-left text-gray-600" colspan="2">${prev.toBranchName || '-'}</td>
            </tr>
        `;
    }

    itemsHtml += `
        <tr class="product-entry-verify ${rowClass}" data-product-id="${item.id}">
            <td class="p-2 font-medium align-middle">${item.name}</td>
            <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateVerificationReportItem('${item.id}', 'salesQuantity', this.value)" value="${item.salesQuantity}"></td>
            <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateVerificationReportItem('${item.id}', 'receivedQuantity', this.value)" value="${item.receivedQuantity}"></td>
            <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateVerificationReportItem('${item.id}', 'expiredQuantity', this.value)" value="${item.expiredQuantity}"></td>
            <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateVerificationReportItem('${item.id}', 'currentStock', this.value); validateStockOnChange('${item.id}')" value="${item.currentStock}"></td>
            <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateVerificationReportItem('${item.id}', 'transferredQuantity', this.value); toggleTransferBranchInVerificationGroup(this, '${item.id}'); validateStockOnChange('${item.id}')" value="${item.transferredQuantity}"></td>
            <td class="p-1 align-middle"><select class="transfer-select-verify w-full rounded-md border-gray-300 text-sm hidden" oninput="updateVerificationReportItem('${item.id}', 'toBranchId', this.value)">${branchOptions}</select></td>
            <td class="p-1 align-middle text-center"><button type="button" onclick="event.stopPropagation(); removeProductFromVerificationReport('${item.id}')" class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></td>
        </tr>
        ${previousDataHtml}

            `;
        });

        const isCollapsed = true; // พับ supplier ที่ 4 เป็นต้นไปโดยอัตโนมัติ
        
        groupDiv.innerHTML = `
            <h4 class="supplier-group-header font-bold text-gray-800 bg-gray-100 p-3 rounded-t-lg flex justify-between items-center"
                onclick="toggleSupplierGroup(this)">
                <span>${supplierName} </span>
                </span>
                <span class="toggle-icon ${isCollapsed ? 'rotated' : ''}">▼</span>
            </h4>
            <div class="supplier-content ${isCollapsed ? 'collapsed' : ''}" style="max-height: ${isCollapsed ? '0' : '2000px'};">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm verify-table-sticky">
                        <thead class="text-xs text-gray-500">
                            <tr>
                                <th class="p-2 text-left w-1/3">สินค้า</th>
                                <th class="p-2 text-center">ขาย</th>
                                <th class="p-2 text-center">รับเข้า</th>
                                <th class="p-2 text-center">หมดอายุ</th>
                                <th class="p-2 text-center">นับจริง</th>
                                <th class="p-2 text-center">ย้าย</th>
                                <th class="p-2 text-left w-1/4">ไปสาขา</th>
                                <th class="p-2 w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">${itemsHtml}</tbody>
                    </table>
                </div>
            </div>
        `;
        container.appendChild(groupDiv);
        
        // Set branch values for items with transfers
        itemsBySupplier[supplierName].forEach(item => {
            if (item.transferredQuantity > 0) {
                const row = document.querySelector(`.product-entry-verify[data-product-id="${item.id}"]`);
                const select = row.querySelector('.transfer-select-verify');
                select.classList.remove('hidden');
                select.value = item.toBranchId || '';
            }
        });
    });
}

function checkStockValidity(item) {
    // ถ้าไม่มีข้อมูลวันก่อนหน้า
    if (!item.previousData) {
        return false;
    }
    
    // ดึงค่าปัจจุบัน
    const currentStock = parseFloat(item.currentStock) || 0;
    const previousStock = parseFloat(item.previousData.currentStock) || 0;
    const sales = parseFloat(item.salesQuantity) || 0;
    const received = parseFloat(item.receivedQuantity) || 0;
    const expired = parseFloat(item.expiredQuantity) || 0;
    const transferred = parseFloat(item.transferredQuantity) || 0;
    
    // เงื่อนไข 1: นับจริงวันนี้ ≠ นับจริงเมื่อวาน
    if (currentStock !== previousStock && sales === 0 && received === 0 && expired === 0 && transferred === 0) {
        return false;
    }
    
    // เงื่อนไข 2: สูตรไม่สมดุล
    const expectedStock = previousStock - sales + received - expired - transferred;
    if (Math.abs(expectedStock - currentStock) > 0.01) { // ใช้ 0.01 เพื่อป้องกันปัญหาทศนิยม
        return false;
    }
    
    return true;
}



function toggleSupplierGroup(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');
    
    if (content.classList.contains('collapsed')) {
        // ขยาย
        content.style.maxHeight = '5000px';
        content.classList.remove('collapsed');
        icon.classList.remove('rotated');
    } else {
        // พับ
        content.style.maxHeight = '0';
        content.classList.add('collapsed');
        icon.classList.add('rotated');
    }
}

       function updateVerificationReportItem(productId, field, value) {
    const item = verificationReportItems.find(i => i.id == productId);
    
    if (item) {
        item[field] = value;
        calculateVerificationProductTotals();
        calculateVerificationCashAmount();

        validateStockOnChange(productId);
    }
}

function validateStockOnChange(productId) {
    const item = verificationReportItems.find(i => i.id == productId);
    if (!item) return;
    
    const row = document.querySelector(`.product-entry-verify[data-product-id="${productId}"]`);
    if (!row) return;
    
    const isValid = checkStockValidity(item);
    
    if (isValid) {
        row.classList.remove('bg-red-50');
    } else {
        row.classList.add('bg-red-50');
    }
}

            /**
 * ฟังก์ชันใหม่: อ่านค่าล่าสุดจากฟอร์มในตารางตรวจสอบ
 * แล้วนำไปอัปเดตข้อมูลในหน่วยความจำ (verificationReportItems)
 */
function syncVerificationItemsFromDOM() {
    const itemRows = document.querySelectorAll('#verification-item-rows-container .product-entry-verify');
    
    itemRows.forEach(row => {
        const productId = row.dataset.productId;
        const itemInMemory = verificationReportItems.find(i => i.id == productId);

        if (itemInMemory) {
            itemInMemory.salesQuantity = row.querySelector('input[oninput*="salesQuantity"]').value;
            itemInMemory.receivedQuantity = row.querySelector('input[oninput*="receivedQuantity"]').value;
            itemInMemory.expiredQuantity = row.querySelector('input[oninput*="expiredQuantity"]').value;
            itemInMemory.currentStock = row.querySelector('input[oninput*="currentStock"]').value;
            itemInMemory.transferredQuantity = row.querySelector('input[oninput*="transferredQuantity"]').value;
            itemInMemory.toBranchId = row.querySelector('.transfer-select-verify').value;
        }
    });
}



            function toggleTransferBranchInVerificationGroup(input, productId) {
                const entry = input.closest('.product-entry-verify');
                entry.querySelectorAll('.transfer-select-verify').forEach(sel => {
                    sel.classList.toggle('hidden', !(parseFloat(input.value) > 0));
                    if (!(parseFloat(input.value) > 0)) {
                        sel.value = '';
                        updateVerificationReportItem(productId, 'toBranchId', '');
                    }
                });
            }


                    function closeVerificationPopup() { 
    const modal = document.getElementById('verification-modal');
    if (modal) {
        modal.classList.add('hidden');
        // (บรรทัด modal.style.display = 'none'; ถูกลบไปแล้ว)
        // Clear data
        verificationReportItems = [];
    }
}

// ==================== ANALYTICS DASHBOARD ====================

function showAnalyticsDashboard() {
    document.getElementById('header-title').innerText = 'วิเคราะห์ยอดขาย';
    const appContainer = document.getElementById('app-container');
    
    // เช็คสิทธิ์และเตรียม branch options
    const isOffice = USER_DETAILS.role === 'ออฟฟิศ';
    let branchOptions = '';
    
    if (isOffice) {
        // ออฟฟิศเห็นทุกสาขา
        USER_DETAILS.branchesManaged.forEach(branchId => {
            const branch = ALL_BRANCHES.find(b => b.id === branchId);
            if (branch) {
                branchOptions += `<option value="${branchId}">${branch.name}</option>`;
            }
        });
    } else {
        // หน้าร้านเห็นแค่สาขาตัวเอง
        branchOptions = `<option value="${USER_DETAILS.branchIdAssigned}">${USER_DETAILS.branchName}</option>`;
    }
    
    // Default dates
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    const todayStr = today.toISOString().split('T')[0];
    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
    
    appContainer.innerHTML = `
        <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg">
            <button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button>
            
            <!-- Controls Section -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    ${isOffice ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">สาขา</label>
                        <select id="analytics-branch" class="mt-1 w-full rounded-md border-gray-300">
                            ${branchOptions}
                        </select>
                    </div>` : 
                    `<input type="hidden" id="analytics-branch" value="${USER_DETAILS.branchIdAssigned}">`}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ช่วงเวลา</label>
                        <select id="analytics-view-type" onchange="toggleDateInputs()" class="mt-1 w-full rounded-md border-gray-300">
                            <option value="daily">รายวัน</option>
                            <option value="weekly">รายสัปดาห์</option>
                            <option value="monthly">รายเดือน</option>
                        </select>
                    </div>
                    
                    <div id="date-range-inputs">
                        <label class="block text-sm font-medium text-gray-700">วันเริ่มต้น</label>
                        <input type="date" id="analytics-start-date" value="${thirtyDaysAgoStr}" 
                               class="mt-1 w-full rounded-md border-gray-300">
                    </div>
                    
                    <div id="date-end-input">
                        <label class="block text-sm font-medium text-gray-700">วันสิ้นสุด</label>
                        <input type="date" id="analytics-end-date" value="${todayStr}" 
                               class="mt-1 w-full rounded-md border-gray-300">
                    </div>
                    
                    <div id="month-input" class="hidden">
                        <label class="block text-sm font-medium text-gray-700">เดือน</label>
                        <input type="month" id="analytics-month" value="${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}" 
                               class="mt-1 w-full rounded-md border-gray-300">
                    </div>
                    
                    <button onclick="loadAnalyticsData()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">
                        แสดงข้อมูล
                    </button>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div id="summary-cards-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"></div>
            

            <!-- Charts Section -->
            <div id="charts-container" class="space-y-6 mb-6"></div>
            
            <!-- Top Products Section -->
            <div id="top-products-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    `;
    
    // Load initial data
    loadAnalyticsData();
}

function toggleDateInputs() {
    const viewType = document.getElementById('analytics-view-type').value;
    const dateRangeInputs = document.getElementById('date-range-inputs');
    const dateEndInput = document.getElementById('date-end-input');
    const monthInput = document.getElementById('month-input');
    
    if (viewType === 'monthly') {
        dateRangeInputs.classList.add('hidden');
        dateEndInput.classList.add('hidden');
        monthInput.classList.remove('hidden');
    } else {
        dateRangeInputs.classList.remove('hidden');
        dateEndInput.classList.remove('hidden');
        monthInput.classList.add('hidden');
    }
}

function loadAnalyticsData() {
    showLoading();
    
    const branchId = document.getElementById('analytics-branch').value;
    const viewType = document.getElementById('analytics-view-type').value;
    let startDate, endDate;
    
    if (viewType === 'monthly') {
        const monthValue = document.getElementById('analytics-month').value;
        const [year, month] = monthValue.split('-');
        startDate = `${year}-${month}-01`;
        
        // หาวันสุดท้ายของเดือน
        const lastDay = new Date(year, month, 0).getDate();
        endDate = `${year}-${month}-${lastDay}`;
    } else {
        startDate = document.getElementById('analytics-start-date').value;
        endDate = document.getElementById('analytics-end-date').value;
    }
    
// Clear containers
document.getElementById('summary-cards-container').innerHTML = '<p class="text-center text-gray-500">กำลังโหลดข้อมูล...</p>';
document.getElementById('charts-container').innerHTML = '<p class="text-center text-gray-500">กำลังโหลดกราฟ...</p>';
document.getElementById('top-products-container').innerHTML = '<p class="text-center text-gray-500">กำลังโหลด Top 10...</p>';
    
    // Load dashboard data
    google.script.run
        .withSuccessHandler(response => {
    const result = JSON.parse(response);
    
    if (result.status === 'success') {
        renderSummaryCards(result.summary);
        
        renderCharts(result.data, viewType);

        const isOffice = USER_DETAILS.role === 'ออฟฟิศ';


        loadTopProducts(branchId, startDate, endDate);
    } else {
        showCustomAlert('ข้อผิดพลาด', result.message, 'error');
    }
    hideLoading();
})



        .withFailureHandler(error => {
            handleError(error);
            hideLoading();
        })
        .getDashboardData(branchId, startDate, endDate, viewType);
}

function renderTargetProgress(targetData, isOffice) {
  const container = document.getElementById('target-progress-container');
  
  if (!targetData) {
    container.innerHTML = '';
    return;
  }
  
  const { 
    targetPercent, 
    targetDaily, 
    currentAverage, 
    achievementPercent, 
    tomorrowTarget,
    daysElapsed,
    totalDays,
    status
  } = targetData;
  
  // กำหนดสีตาม status
  const statusColor = {
    'achieved': 'green',
    'near': 'yellow', 
    'below': 'red'
  };
  
  const color = statusColor[status];
  const bgColor = `bg-${color}-50`;
  const textColor = `text-${color}-600`;
  const borderColor = `border-${color}-200`;
  
  let targetHtml = `
    <div class="bg-white rounded-lg shadow-md p-6 ${borderColor} border-2">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 class="text-lg font-semibold mb-2">📊 สถานะการบรรลุเป้าหมายเบเกอรี่</h3>
          <p class="text-sm text-gray-600">
            เป้าหมาย: เบเกอรี่รวม <span class="font-bold">+${targetPercent}%</span> จากเดือนก่อน
          </p>
        </div>`;
  
  // ปุ่มตั้งเป้า (เฉพาะ Office)
  if (isOffice) {
    targetHtml += `
        <button onclick="openTargetSettingModal()" 
                class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">
          ⚙️ ตั้งเป้า
        </button>`;
  }
  
  targetHtml += `
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="${bgColor} p-4 rounded-lg">
          <p class="text-sm text-gray-600">เป้าหมายรายวัน</p>
          <p class="text-2xl font-bold ${textColor}">${Math.round(targetDaily)} ชิ้น</p>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-sm text-gray-600">ค่าเฉลี่ยปัจจุบัน</p>
          <p class="text-2xl font-bold">${Math.round(currentAverage)} ชิ้น/วัน</p>
          <p class="text-xs text-gray-500">
            ${achievementPercent.toFixed(1)}% ของเป้า
          </p>
        </div>
        
        <div class="bg-blue-50 p-4 rounded-lg">
          <p class="text-sm text-gray-600">ผ่านมา/ทั้งหมด</p>
          <p class="text-2xl font-bold">${daysElapsed}/${totalDays} วัน</p>
        </div>
      </div>`;
  
  // แสดงเป้าพรุ่งนี้ถ้าต้องการ
  if (achievementPercent < 100 && daysElapsed < totalDays) {
    const isHighTarget = tomorrowTarget > targetDaily * 1.5;
    
    targetHtml += `
      <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
        <div class="flex items-center">
          <span class="text-2xl mr-2">🎯</span>
          <div>
            <p class="font-semibold text-amber-800">
              เป้าหมายพรุ่งนี้: ${tomorrowTarget} ชิ้น
            </p>
            <p class="text-sm text-amber-600">
              (เพื่อให้ค่าเฉลี่ยกลับมาที่ ${Math.round(targetDaily)} ชิ้น/วัน)
            </p>
            ${isHighTarget ? `
              <p class="text-xs text-red-600 mt-1">
                ⚠️ เป้าหมายสูงกว่าปกติ ${((tomorrowTarget/targetDaily - 1) * 100).toFixed(0)}%
              </p>` : ''}
          </div>
        </div>
      </div>`;
  } else if (achievementPercent >= 100) {
    targetHtml += `
      <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
        <div class="flex items-center">
          <span class="text-2xl mr-2">✅</span>
          <p class="font-semibold text-green-800">
            บรรลุเป้าหมายแล้ว! (${achievementPercent.toFixed(1)}%)
          </p>
        </div>
      </div>`;
  }
  
  targetHtml += '</div>';
  
  container.innerHTML = targetHtml;
}

// เพิ่มฟังก์ชัน modal สำหรับตั้งเป้า
function openTargetSettingModal() {
  const branchId = document.getElementById('analytics-branch').value;
  const branchName = document.getElementById('analytics-branch').selectedOptions[0].text;
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
      <div class="p-6">
        <h3 class="text-lg font-bold mb-4">ตั้งเป้าหมายเบเกอรี่</h3>
        <p class="text-sm text-gray-600 mb-4">สาขา: ${branchName}</p>
        
        <label class="block text-sm font-medium text-gray-700 mb-2">
          เป้าหมายการเติบโต (%)
        </label>
        <input type="number" id="new-target-percent" 
               class="w-full px-3 py-2 border rounded-lg" 
               placeholder="5" min="0" max="100" step="1">
        
        <p class="text-xs text-gray-500 mt-2">
          * เป้าหมายจะเริ่มใช้ทันที และคำนวณเทียบกับยอดเฉลี่ยเดือนก่อน
        </p>
        
        <div class="mt-6 flex justify-end space-x-3">
          <button onclick="this.closest('.fixed').remove()" 
                  class="px-4 py-2 text-gray-700 bg-gray-100 rounded hover:bg-gray-200">
            ยกเลิก
          </button>
          <button onclick="saveNewTarget('${branchId}')" 
                  class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            บันทึก
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function saveNewTarget(branchId) {
  const targetPercent = document.getElementById('new-target-percent').value;
  
  if (!targetPercent || targetPercent < 0 || targetPercent > 100) {
    showCustomAlert('ข้อมูลไม่ถูกต้อง', 'กรุณาระบุเป้าหมาย 0-100%', 'error');
    return;
  }
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();
      document.querySelector('.fixed').remove();
      
      if (result.status === 'success') {
        showCustomAlert('สำเร็จ', result.message, 'success');
        loadAnalyticsData(); // โหลดข้อมูลใหม่
      } else {
        showCustomAlert('ข้อผิดพลาด', result.message, 'error');
      }
    })
    .withFailureHandler(error => {
      hideLoading();
      handleError(error);
    })
    .saveBranchTarget(branchId, targetPercent);
}


function renderSummaryCards(summary) {
    const container = document.getElementById('summary-cards-container');
    
    container.innerHTML = `
        <!-- เครื่องดื่ม -->
        <div class="bg-blue-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">เครื่องดื่ม</h3>
                <span class="text-2xl">☕</span>
            </div>
            <p class="text-2xl font-bold text-blue-600">${summary.totalDrinkUnits.toLocaleString()} แก้ว</p>
            <p class="text-sm text-gray-500">เฉลี่ย ${summary.avgDrinkUnits} แก้ว/วัน</p>
        </div>
        
        <!-- เบเกอรี่สด -->
        <div class="bg-green-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">เบเกอรี่สด</h3>
                <span class="text-2xl">🥐</span>
            </div>
            <p class="text-2xl font-bold text-green-600">${summary.totalFreshBakeryUnits.toLocaleString()} ชิ้น</p>
            <p class="text-sm text-gray-500">เฉลี่ย ${summary.avgFreshBakeryUnits} ชิ้น/วัน</p>
        </div>
        
        <!-- เบเกอรี่แห้ง -->
        <div class="bg-yellow-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">เบเกอรี่แห้ง</h3>
                <span class="text-2xl">🍪</span>
            </div>
            <p class="text-2xl font-bold text-yellow-600">${summary.totalDryBakeryUnits.toLocaleString()} ชิ้น</p>
            <p class="text-sm text-gray-500">เฉลี่ย ${summary.avgDryBakeryUnits} ชิ้น/วัน</p>
        </div>
        
        <!-- ยอดขายรวม (เพิ่มใหม่) -->
        <div class="bg-purple-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">ยอดขายรวม</h3>
                <span class="text-2xl">💰</span>
            </div>
            <p class="text-2xl font-bold text-purple-600">${summary.totalRevenue.toLocaleString()} บาท</p>
            <p class="text-sm text-gray-500">เฉลี่ย ${summary.avgTotalRevenue.toLocaleString()} บาท/วัน</p>
        </div>
    `;
}


function renderCharts(data, viewType) {

    const container = document.getElementById('charts-container');
    
    if (data.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">ไม่พบข้อมูลในช่วงเวลาที่เลือก</p>';
        return;
    }
    
    // เตรียม labels และ data สำหรับ charts (ประกาศครั้งเดียว)
    const labels = data.map(item => {
        const date = new Date(item.date);
        if (viewType === 'daily') {
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' });
        } else if (viewType === 'weekly') {
            return `สัปดาห์ที่ ${date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' })}`;
        } else {
            return date.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
        }
    });
    
    const drinkData = data.map(item => item.drinkUnits);
    const freshBakeryData = data.map(item => item.freshBakeryUnits);
    const dryBakeryData = data.map(item => item.dryBakeryUnits);
    const revenueData = data.map(item => item.totalRevenue);
    
    // Create chart containers
container.innerHTML = `
    <div class="bg-white p-4 rounded-lg border">
        <h3 class="text-lg font-semibold mb-4">กราฟยอดขายเครื่องดื่ม(แก้ว)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="drinkChart"></canvas>
        </div>
    </div>
    
    <div class="bg-white p-4 rounded-lg border">
        <h3 class="text-lg font-semibold mb-4">กราฟยอดขายเบเกอรี่สด(ชิ้น)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="freshBakeryChart"></canvas>
        </div>
    </div>
    
    <div class="bg-white p-4 rounded-lg border">
        <h3 class="text-lg font-semibold mb-4">กราฟยอดขายเบเกอรี่แห้ง(ชิ้น)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="dryBakeryChart"></canvas>
        </div>
    </div>
    
    <div class="bg-white p-4 rounded-lg border">
        <h3 class="text-lg font-semibold mb-4">กราฟยอดขายรวม(บาท)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
`;
    
    // Wait for DOM to update
    setTimeout(() => {
    // ตรวจสอบว่า canvas elements มีอยู่จริงก่อนวาด
    if (document.getElementById('drinkChart')) {
        createLineChart('drinkChart', labels, drinkData, 'เครื่องดื่ม (แก้ว)', '#3B82F6');
    }
    if (document.getElementById('freshBakeryChart')) {
        createLineChart('freshBakeryChart', labels, freshBakeryData, 'เบเกอรี่สด (ชิ้น)', '#10B981');
    }
    if (document.getElementById('dryBakeryChart')) {
        createLineChart('dryBakeryChart', labels, dryBakeryData, 'เบเกอรี่แห้ง (ชิ้น)', '#F59E0B');
    }
    if (document.getElementById('revenueChart')) {
        createBarChart('revenueChart', labels, revenueData, 'ยอดขายรวม (บาท)', '#9333EA');
    }
}, 200); // เพิ่มเวลารอเป็น 200ms
}

function addTargetLineToChart(chart, targetValue, label = 'เป้าหมาย') {
  // เพิ่ม dataset สำหรับเส้นเป้าหมาย
  const targetData = new Array(chart.data.labels.length).fill(targetValue);
  
  chart.data.datasets.push({
    label: label,
    data: targetData,
    borderColor: 'rgba(255, 0, 0, 0.5)',
    borderDash: [5, 5],
    borderWidth: 2,
    pointRadius: 0,
    fill: false,
    tension: 0
  });
  
  chart.update();
}

function createLineChart(canvasId, labels, data, label, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                borderColor: color,
                backgroundColor: color + '20',
                borderWidth: 2,
                fill: true,
                tension: 0.1
            }]
        },

options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            display: false
        }
    },
    scales: {
        y: {
            beginAtZero: true,
            ticks: {
                stepSize: 1
            }
        }
    },
    layout: {
        padding: 10
    }
}

        
    });
}

function createBarChart(canvasId, labels, data, label, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                backgroundColor: color + '40',
                borderColor: color,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            },
            layout: {
                padding: 10
            }
        }
    });
}


function loadTopProducts(branchId, startDate, endDate) {
    const container = document.getElementById('top-products-container');
    
    // Clear container first
    container.innerHTML = '';
    
    // Load fresh bakery products
    google.script.run
        .withSuccessHandler(freshProducts => {
            renderTopProductsTable('fresh', freshProducts, container);
        })
        .withFailureHandler(handleError)
        .getTopProducts(branchId, startDate, endDate, 'fresh', 10);
    
    // Load dry bakery products
    google.script.run
        .withSuccessHandler(dryProducts => {
            renderTopProductsTable('dry', dryProducts, container);
        })
        .withFailureHandler(handleError)
        .getTopProducts(branchId, startDate, endDate, 'dry', 10);
}



function renderTopProductsTable(type, products, container) {
    const title = type === 'fresh' ? 'เบเกอรี่สด' : 'เบเกอรี่แห้ง';
    const bgColor = type === 'fresh' ? 'bg-green-50' : 'bg-yellow-50';
    
    let tableHtml = `
        <div class="bg-white rounded-lg border">
            <div class="${bgColor} p-3 rounded-t-lg">
                <h3 class="text-lg font-semibold">Top 10 ${title}</h3>
            </div>
            <div class="p-4">
    `;
    
    if (products.length === 0) {
        tableHtml += '<p class="text-center text-gray-500">ไม่มีข้อมูล</p>';
    } else {
        tableHtml += `
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-2">อันดับ</th>
                        <th class="text-left py-2">ชื่อสินค้า</th>
                        <th class="text-right py-2">จำนวน</th>
                        <th class="text-right py-2">มูลค่า</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        products.forEach((product, index) => {
            tableHtml += `
                <tr class="border-b">
                    <td class="py-2">${index + 1}</td>
                    <td class="py-2">${product.productName}</td>
                    <td class="py-2 text-right">${product.units} ชิ้น</td>
                    <td class="py-2 text-right">${product.revenue.toLocaleString()} บาท</td>
                </tr>
            `;
        });
        
        tableHtml += '</tbody></table>';
    }
    
    tableHtml += '</div></div>';
    
    // Append to container
container.innerHTML += tableHtml;

}


                    function handleDeleteReport(reportId) {
                        showCustomConfirm('ยืนยันการลบรายงาน', `คุณแน่ใจหรือไม่ว่าต้องการลบ Report ID: ${reportId}? รายงานจะถูกเปลี่ยนสถานะเป็น 'Deleted'`, () => {
                            showLoading();
                            google.script.run.withSuccessHandler(response => {
                                const result = JSON.parse(response);
                                hideLoading();
                                closeVerificationPopup();
                                showCustomAlert(result.status === 'success' ? 'สำเร็จ' : 'ผิดพลาด', result.message, result.status, showVerifyReportsModule);
                            }).withFailureHandler(handleError).markReportAsDeleted(reportId);
                        });
                    }


                   function handleVerifyReport(reportId) {
                        console.log("XXXXXXXXXXXXXXXXXXXXXXXXXXXXX");
                        showCustomConfirm('ยืนยันการตรวจสอบ', 'คุณต้องการบันทึกการเปลี่ยนแปลงและยืนยันรายงานนี้ใช่หรือไม่?', () => {
                            showLoading();
                            const reportData = {
                                reportId: reportId,
                                items: [],
                                drinkCategories: [],
                                cancelledBills: [],
                                addOns: [],
                                payments: [],
                                discounts: [],
                                timeSlot: document.getElementById('verify-time-slot').value,
                                note: document.getElementById('verify-note').value
                            };

                            // เก็บข้อมูลสินค้า
                            document.querySelectorAll('.product-entry-verify').forEach(row => {
                                const productId = row.dataset.productId;
                                const itemData = {
                                    productId: productId,
                                    salesQuantity: row.querySelector(`input[oninput*="salesQuantity"]`).value || 0,
                                    receivedQuantity: row.querySelector(`input[oninput*="receivedQuantity"]`).value || 0,
                                    expiredQuantity: row.querySelector(`input[oninput*="expiredQuantity"]`).value || 0,
                                    currentStock: row.querySelector(`input[oninput*="currentStock"]`).value || 0,
                                    transferredQuantity: row.querySelector(`input[oninput*="transferredQuantity"]`).value || 0,
                                    toBranchId: row.querySelector('.transfer-select-verify').value || null
                                };
                                reportData.items.push(itemData);
                            });

                            // ตรวจสอบว่าสินค้าที่มีการย้าย ต้องเลือกสาขาปลายทาง
                            for (const item of reportData.items) {
                                if (item.transferredQuantity > 0 && !item.toBranchId) {
                                    const product = verificationReportItems.find(p => p.id === item.productId);
                                    showCustomAlert('ข้อมูลไม่ครบถ้วน', `กรุณาเลือกสาขาปลายทางสำหรับสินค้า '${product.name}'`, 'error');
                                    hideLoading();
                                    return;
                                }
                            }

                            // เก็บข้อมูล Add-on
                            const verifyAddon5Qty = document.getElementById('verify-addon-5-qty').value;
                            const verifyAddon5Amount = document.getElementById('verify-addon-5').value;
                            const verifyAddon10Qty = document.getElementById('verify-addon-10-qty').value;
                            const verifyAddon10Amount = document.getElementById('verify-addon-10').value;
                            const verifyAddon15Qty = document.getElementById('verify-addon-15-qty').value;
                            const verifyAddon15Amount = document.getElementById('verify-addon-15').value;

                            if (verifyAddon5Amount > 0) reportData.addOns.push({
                                type: '5บาท',
                                amount: parseFloat(verifyAddon5Amount),
                                quantity: parseInt(verifyAddon5Qty) || 0,
                                unitPrice: 5
                            });
                            if (verifyAddon10Amount > 0) reportData.addOns.push({
                                type: '10บาท',
                                amount: parseFloat(verifyAddon10Amount),
                                quantity: parseInt(verifyAddon10Qty) || 0,
                                unitPrice: 10
                            });
                            if (verifyAddon15Amount > 0) reportData.addOns.push({
                                type: '15บาท',
                                amount: parseFloat(verifyAddon15Amount),
                                quantity: parseInt(verifyAddon15Qty) || 0,
                                unitPrice: 15
                            });

                            // เก็บข้อมูลบิลยกเลิก
                            document.querySelectorAll('.verify-cancellation-row').forEach(row => {
                                const billNumber = row.querySelector('.verify-cancel-bill-number').value;
                                const reason = row.querySelector('.verify-cancel-reason').value;
                                const amount = row.querySelector('.verify-cancel-amount').value;
                                const cancelledBy = row.querySelector('.verify-cancel-by-name')?.value || '';

                                if (billNumber || reason || amount) {
                                    reportData.cancelledBills.push({
                                        billNumber,
                                        reason,
                                        amount: parseFloat(amount) || 0,
                                        cancelledBy: cancelledBy || ''
                                    });
                                }
                            });

                            // เก็บข้อมูลยอดขายตามประเภทเครื่องดื่ม
                            document.querySelectorAll('.verify-drink-sales-input').forEach(input => {
                                const categoryName = input.dataset.categoryName;
                                const salesAmount = input.value || 0;
                                const cupQuantity = document.querySelector(`.verify-drink-cups-input[data-category-name="${categoryName}"]`).value || 0;
                                reportData.drinkCategories.push({
                                    name: categoryName,
                                    salesAmount: salesAmount,
                                    cupQuantity: cupQuantity
                                });
                            });

                            // เก็บข้อมูลการชำระเงิน
                            document.querySelectorAll('.verify-payment-summary-input').forEach(input => {
                                if (parseFloat(input.value) > 0) {
                                    reportData.payments.push({
                                        typeId: input.dataset.typeId,
                                        amount: input.value
                                    });
                                }
                            });

                            // เก็บข้อมูลส่วนลด
                            document.querySelectorAll('.verify-discount-summary-input').forEach(input => {
                                if (parseFloat(input.value) > 0) {
                                    reportData.discounts.push({
                                        typeId: input.dataset.typeId,
                                        amount: input.value
                                    });
                                }
                            });

                            // ส่งข้อมูลไปฝั่ง Apps Script
                            google.script.run.withSuccessHandler(response => {
                                const result = JSON.parse(response);
                                hideLoading();
                                closeVerificationPopup();
                                showCustomAlert(
                                    result.status === 'success' ? 'สำเร็จ' : 'ผิดพลาด',
                                    result.message,
                                    result.status,
                                    showVerifyReportsModule
                                );
                            }).withFailureHandler(handleError)
                              .updateAndVerifyReport(JSON.stringify(reportData));
                        });
                    }


                    function updateVerificationTotals(type) {
                        if (type === 'drink') {
                            let totalSales = 0; let totalCups = 0;
                            document.querySelectorAll('.verify-drink-sales-input').forEach(input => { totalSales += parseFloat(input.value) || 0; });
                            document.querySelectorAll('.verify-drink-cups-input').forEach(input => { totalCups += parseInt(input.value) || 0; });
                            document.getElementById('verify-drink-category-totals').innerHTML = `<span>ยอดขายรวม: <span class="text-cyan-700">${totalSales.toFixed(2)}</span> บาท</span> | <span>จำนวนรวม: <span class="text-cyan-700">${totalCups}</span> แก้ว</span>`;
                        } else if (type === 'payment') {
                            let totalAmount = 0;
                            document.querySelectorAll('.verify-payment-summary-input').forEach(input => { totalAmount += parseFloat(input.value) || 0; });
                            document.getElementById('verify-payment-summary-total').innerHTML = `<span>ยอดรวม: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> บาท</span>`;
                        } else if (type === 'discount') {
                            let totalAmount = 0;
                            document.querySelectorAll('.verify-discount-summary-input').forEach(input => { totalAmount += parseFloat(input.value) || 0; });
                            document.getElementById('verify-discount-summary-total').innerHTML = `<span>ยอดรวม: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> บาท</span>`;




                        }
                    }

                    // --- SALES SUMMARY MODULE (OFFICE) ---
                    function showSalesSummaryModule() {
                        document.getElementById('header-title').innerText = 'สรุปยอดขายและบันทึกการโอนเงิน';
                        const appContainer = document.getElementById('app-container');
                        let branchOptions = '<option value="">-- เลือกสาขา --</option>';
                        ALL_BRANCHES.forEach(b => { branchOptions += `<option value="${b.id}">${b.name}</option>`; });
                        const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0'); const todayFormatted = `${yyyy}-${mm}-${dd}`;
                        appContainer.innerHTML = `

                        <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">
            <button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">

                                    <div><label class="block text-sm font-medium">สาขา</label><select id="summary-branch" class="mt-1 w-full rounded-md">${branchOptions}</select></div>
                                    <div><label class="block text-sm font-medium">จากวันที่</label><input type="date" id="summary-start-date" value="${todayFormatted}" class="mt-1 w-full rounded-md"></div>
                                    <div><label class="block text-sm font-medium">ถึงวันที่</label><input type="date" id="summary-end-date" value="${todayFormatted}" class="mt-1 w-full rounded-md"></div>
                                    <button onclick="handleSummarySearch()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">ค้นหา</button>
                                </div>
                                <div id="summary-table-container"></div>
                            </div>`;
                    }
                    function handleSummarySearch() {
                        const branchId = document.getElementById('summary-branch').value;
                        const startDate = document.getElementById('summary-start-date').value;
                        const endDate = document.getElementById('summary-end-date').value;
                        if (!branchId || !startDate || !endDate) {
                            showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาเลือกสาขาและช่วงวันที่ให้ครบถ้วน', 'error');
                            return;
                        }
                        showLoading();
                        google.script.run.withSuccessHandler(renderSummaryTable).withFailureHandler(handleError).getSalesSummary(branchId, startDate, endDate);
                    }

function renderSummaryTable(responseString) {
    const result = JSON.parse(responseString);


    
    if (result.status === 'error') { 
        handleError({ message: result.message }); 
        return; 
    }
    const container = document.getElementById('summary-table-container');
    const { headers, data, isManager } = result;
    
    let table = `<div class="overflow-x-auto"><table class="w-full text-sm summary-table"><thead>`;
    table += `<tr>
        <th rowspan="2" class="text-left sticky-col first-col">วันที่</th>
        <th rowspan="2" class="text-left sticky-col second-col">รอบ</th>
        <th colspan="2" class="header-group">เครื่องดื่ม</th>
        <th colspan="2" class="header-group">เบเกอรี่สด</th>
        <th colspan="2" class="header-group">เบเกอรี่แห้ง</th>
        <th colspan="${headers.length + 2}" class="header-group">ประเภทการชำระเงิน (บาท)</th>
        <th rowspan="2" >โอนเงินเข้าบริษัท</th>
        <th rowspan="2" class="whitespace-nowrap" style="min-width: 150px;" >ยอดตั้งเบิกเพิ่มเติม</th>
    </tr>`;
    
    table += `<tr><th>ชิ้น</th><th>บาท</th><th>ชิ้น</th><th>บาท</th><th>ชิ้น</th><th>บาท</th>`;
    
    // แสดง payment headers ตามลำดับเดิมก่อน
    headers.forEach(h => { 
        if (h.name !== 'เงินสด') {
            table += `<th>${h.name}</th>`; 
        }
    });
    table += `<th>ส่วนลด</th>`;
    
    // แสดงเงินสดเป็นอันสุดท้ายก่อนรวม
    const cashHeader = headers.find(h => h.name === 'เงินสด');
    if (cashHeader) {
        table += `<th>${cashHeader.name}</th>`;
    }
    
    table += `<th>รวม (บาท)</th></tr></thead><tbody>`;

    data.forEach(day => {
        // Morning row
        let morningHtml = '';
        headers.forEach(h => {
            if (h.name !== 'เงินสด') {
                morningHtml += `<td>${(day.morning.payments[h.id] || 0).toFixed(2)}</td>`;
            }
        });
        morningHtml += `<td>${(day.morning.totalDiscounts || 0).toFixed(2)}</td>`;
        if (cashHeader) {
            morningHtml += `<td>${(day.morning.payments[cashHeader.id] || 0).toFixed(2)}</td>`;
        }
        
        table += `<tr>
            <td class="row-day text-left sticky-col first-col" rowspan="3">${day.date}</td>
            <td class="text-left sticky-col second-col">เช้า</td>
            <td>${day.morning.drinkUnits}</td>
            <td>${day.morning.drinkAmount.toFixed(2)}</td>
            <td>${day.morning.freshBakeryUnits}</td>
            <td>${day.morning.freshBakeryAmount.toFixed(2)}</td>
            <td>${day.morning.dryBakeryUnits}</td>
            <td>${day.morning.dryBakeryAmount.toFixed(2)}</td>
            ${morningHtml}
            <td>${day.morning.totalPayments.toFixed(2)}</td>
            <td></td>
            <td></td>
        </tr>`;

        // Afternoon row
        let afternoonHtml = '';
        headers.forEach(h => {
            if (h.name !== 'เงินสด') {
                afternoonHtml += `<td>${(day.afternoon.payments[h.id] || 0).toFixed(2)}</td>`;
            }
        });
        afternoonHtml += `<td>${(day.afternoon.totalDiscounts || 0).toFixed(2)}</td>`;
        if (cashHeader) {
            afternoonHtml += `<td>${(day.afternoon.payments[cashHeader.id] || 0).toFixed(2)}</td>`;
        }
        
        table += `<tr>
            <td class="text-left sticky-col second-col">บ่าย</td>
            <td>${day.afternoon.drinkUnits}</td>
            <td>${day.afternoon.drinkAmount.toFixed(2)}</td>
            <td>${day.afternoon.freshBakeryUnits}</td>
            <td>${day.afternoon.freshBakeryAmount.toFixed(2)}</td>
            <td>${day.afternoon.dryBakeryUnits}</td>
            <td>${day.afternoon.dryBakeryAmount.toFixed(2)}</td>
            ${afternoonHtml}
            <td>${day.afternoon.totalPayments.toFixed(2)}</td>
            <td></td>
            <td></td>
        </tr>`;

        // Total row
        table += `<tr class="row-total">
            <td class="text-left sticky-col second-col">รวม</td>
            <td>${day.total.drinkUnits}</td>
            <td>${day.total.drinkAmount.toFixed(2)}</td>
            <td>${day.total.freshBakeryUnits}</td>
            <td>${day.total.freshBakeryAmount.toFixed(2)}</td>
            <td>${day.total.dryBakeryUnits}</td>
            <td>${day.total.dryBakeryAmount.toFixed(2)}</td>`;
        
        headers.forEach(h => {
            if (h.name !== 'เงินสด') {
                table += `<td>${(day.total.payments[h.id] || 0).toFixed(2)}</td>`;
            }
        });
        table += `<td>${(day.total.totalDiscounts || 0).toFixed(2)}</td>`;
        if (cashHeader) {
            table += `<td>${(day.total.payments[cashHeader.id] || 0).toFixed(2)}</td>`;
        }
        table += `<td>${day.total.totalPayments.toFixed(2)}</td>`;

        // Transfer column
        const isSaved = day.total.bankTransfer && day.total.bankTransfer.amount;
        const isDisabled = !isManager || isSaved;
        const disabledAttribute = isDisabled ? 'disabled' : '';
        const buttonClass = isDisabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-emerald-500 hover:bg-emerald-600';
        const buttonText = isSaved ? 'บันทึกแล้ว' : 'บันทึก';
        const buttonAction = isDisabled ? '' : `onclick="handleSaveTransfer('${day.isoDate}')"`;

        table += `<td>
            <div class="flex items-center space-x-2 justify-center">
                <input type="number" placeholder="จำนวนเงิน" id="transfer-amount-${day.isoDate}" value="${day.total.bankTransfer.amount}" class="w-24 rounded-md text-right" ${disabledAttribute}>
                <input type="date" id="transfer-date-${day.isoDate}" value="${day.total.bankTransfer.transferDate}" class="w-32 rounded-md" ${disabledAttribute}>
                <input type="text" placeholder="หมายเหตุ (ถ้ามี)..." id="transfer-note-${day.isoDate}" value="${day.total.bankTransfer.note}" class="w-40 rounded-md" ${disabledAttribute}>
                <button id="transfer-btn-${day.isoDate}" ${buttonAction} class="${buttonClass} text-white text-xs px-2 py-1 rounded-md" ${disabledAttribute}>${buttonText}</button>
            </div>
        </td>`;


// Additional Withdrawal column
const withdrawal = day.total.additionalWithdrawal;
const hasWithdrawal = withdrawal && withdrawal.totalAmount > 0;
const withdrawalId = `withdrawal-${day.isoDate}`;
const currentBranchId = document.getElementById('summary-branch').value;

table += `<td>
  <div class="flex flex-col items-center space-y-1">
    ${hasWithdrawal ? `
      <div class="text-sm">
        <span class="font-medium">${withdrawal.totalAmount.toLocaleString()} บาท</span>
        <button onclick="toggleWithdrawalDetails('${withdrawalId}')" 
          class="ml-1 text-blue-600 hover:text-blue-800">
          <span id="icon-${withdrawalId}">📋</span>
        </button>
      </div>
      <div id="${withdrawalId}" class="hidden mt-2 p-2 bg-gray-50 rounded text-xs text-left w-48">
        ${(() => {
          let html = '';
          if (withdrawal.itemsByDate) {
            Object.keys(withdrawal.itemsByDate).sort().forEach(date => {
              html += `<div class="font-semibold mt-2 first:mt-0">${new Date(date).toLocaleDateString('th-TH', {day: '2-digit', month: 'short', year: '2-digit'})}:</div>`;
              withdrawal.itemsByDate[date].forEach(item => {
                html += `<div class="ml-2">${item.expenseType}: ${item.amount.toLocaleString()} บาท</div>`;
              });
            });
          } else {
            // Fallback สำหรับข้อมูลเก่า
            withdrawal.items.forEach(item => {
              html += `<div>${item.expenseType}: ${item.amount.toLocaleString()} บาท</div>`;
            });
          }
          return html;
        })()}
      </div>
    ` : ''}
    ${isManager ? `
      <button onclick="openWithdrawalModal('${currentBranchId}', '${day.isoDate}')"
        class="bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded ${hasWithdrawal ? 'mt-2' : ''}">
        + เพิ่ม
      </button>
    ` : (!hasWithdrawal ? '<span class="text-gray-400">-</span>' : '')}
  </div>
</td></tr>`;




    });
    
    table += `</tbody></table></div>`;
    container.innerHTML = table;
    hideLoading();


}





                    function handleSaveTransfer(isoDate) {
                const branchId = document.getElementById('summary-branch').value;
                const amountInput = document.getElementById(`transfer-amount-${isoDate}`);
                const dateInput = document.getElementById(`transfer-date-${isoDate}`);
                const noteInput = document.getElementById(`transfer-note-${isoDate}`); // ดึง input ของ note
                const saveButton = document.getElementById(`transfer-btn-${isoDate}`);
                const amount = amountInput.value;
                const transferDate = dateInput.value;
                const note = noteInput.value; // ดึงค่าจาก note

                if (!amount || !transferDate) { showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกจำนวนเงินและวันที่โอน', 'error'); return; }

                // --- จุดที่แก้ไข 4: เพิ่ม note เข้าไปใน object ที่จะส่งไปบันทึก ---
                const logData = {
                    branchId: branchId,
                    dateOfSale: isoDate,
                    transferDate: transferDate,
                    amount: parseFloat(amount),
                    note: note
                };

                showLoading();
                google.script.run.withSuccessHandler(response => {
                    const result = JSON.parse(response);
                    hideLoading();
                    showCustomAlert(result.status === 'success' ? 'สำเร็จ' : 'ผิดพลาด', result.message, result.status);
                    if (result.status === 'success') {
                        amountInput.disabled = true;
                        dateInput.disabled = true;
                        noteInput.disabled = true; // ปิดการใช้งานช่อง note ด้วย
                        saveButton.disabled = true;
                        saveButton.textContent = 'บันทึกแล้ว';
                        saveButton.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
                        saveButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                        saveButton.onclick = null;
                    }
                }).withFailureHandler(handleError).logBankTransfer(JSON.stringify(logData));
            }

                    // --- ORDER/CLAIM MODULE (OFFICE) ---
                function showOrderClaimModule() {
                document.getElementById('header-title').innerText = 'สั่ง/เคลมสินค้า';
                const appContainer = document.getElementById('app-container');
                let branchOptions = '<option value="">-- เลือกสาขา --</option>';
                ALL_BRANCHES.forEach(b => {
                    if (USER_DETAILS.branchesManaged.includes(String(b.id))) {
                        branchOptions += `<option value="${b.id}">${b.name}</option>`;
                    }
                });
                appContainer.innerHTML = `
                    <div class="max-w-full mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">
                                <button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-medium">เลือกสาขาที่ต้องการจัดการ</label>
                                <select id="order-claim-branch" class="mt-1 w-full rounded-md">${branchOptions}</select>
                            </div>
                            <button onclick="handleOrderClaimSearch()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md h-10">แสดงข้อมูล</button>
                        </div>
                        <div id="order-claim-table-container"></div>
                    </div>`;
            }


      function handleOrderClaimSearch() {
        return new Promise((resolve, reject) => {
          const branchId = document.getElementById('order-claim-branch').value;
          if (!branchId) {
            showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาเลือกสาขา', 'error');
            reject('branchId missing');
            return;
          }
          showLoading();
          google.script.run
            .withSuccessHandler(response => {
              try {
                renderNewClaimTable(response);
                hideLoading();
                resolve(response); // ✅ เสร็จแล้ว resolve
              } catch (err) {
                hideLoading();
                reject(err);
              }
            })
            .withFailureHandler(err => {
              hideLoading();
              handleError(err);
              reject(err);
            })
            .getClaimableReportItems(branchId);
        });
      }






let claimItems = [];

function renderOrderClaimTable(responseString) {
  const result = JSON.parse(responseString);
  
  if (result.status === 'error') {
    handleError({ message: result.message });
    return;
  }

  const container = document.getElementById('order-claim-table-container');
  const data = result.data;
  const isManager = true;

  // เก็บข้อมูลใน claimItems array
  claimItems = data.map(item => ({
    productId: item.productId,
    name: item.name,
    supplierId: item.supplierId,
    supplierName: item.supplierName,
    latestStock: item.latestStock,
    reportedExpiredQuantity: item.unclaimedExpired, // เปลี่ยนชื่อตาม DB
    claimableQuantity: 0,
    claimStatus: 'draft',
    receivedQuantity: 0,
    receivedDate: '',
    receiptStatus: 'pending'
  }));

  const groupedBySupplier = claimItems.reduce((acc, item) => {
    (acc[item.supplierName] = acc[item.supplierName] || []).push(item);
    return acc;
  }, {});

  let tableHtml = '<div class="space-y-8" id="all-suppliers-container">';

  const sortedSuppliers = Object.keys(groupedBySupplier).sort();

  for (const supplierName of sortedSuppliers) {
    tableHtml += `<div data-supplier-table="${supplierName}">
      <h3 class="text-lg font-bold text-gray-800 mb-2">${supplierName}</h3>`;

    tableHtml += '<div class="overflow-x-auto border rounded-lg"><table class="min-w-full text-sm table-fixed">';

    // Header ใหม่ตามที่ต้องการ
    tableHtml += `<thead class="bg-gray-100">
      <tr>
        <th class="px-4 py-2 text-left font-semibold w-[15%]">รหัสสินค้า</th>
        <th class="px-4 py-2 text-left font-semibold w-[25%]">ชื่อสินค้า</th>
        <th class="px-4 py-2 text-center font-semibold w-[10%]">หมดอายุ (รอเคลม)</th>
        <th class="px-4 py-2 text-center font-semibold w-[15%]">จำนวนเคลม</th>
        <th class="px-4 py-2 text-center font-semibold w-[10%]">จำนวนของเข้า</th>
        <th class="px-4 py-2 text-center font-semibold w-[15%]">วันที่ของเข้า</th>
      </tr>
    </thead>`;

    tableHtml += '<tbody class="divide-y">';

    groupedBySupplier[supplierName].sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
      const disabled = !isManager ? 'disabled' : '';
      
      tableHtml += `<tr id="claim-row-${item.productId}" data-product-id="${item.productId}">
        <td class="px-4 py-2 font-mono text-left">${item.productId}</td>
        <td class="px-4 py-2 text-left">${item.name}</td>
        <td class="px-4 py-2 text-center">${item.latestStock}</td>
        <td class="px-4 py-2 text-center font-bold text-red-600">${item.reportedExpiredQuantity}</td>
        
        <!-- จำนวนเคลม + ปุ่มบันทึก -->
        <td class="px-4 py-2 text-center">
          <div class="flex items-center gap-2 justify-center">
            <input type="number" 
              class="claim-quantity-input w-16 rounded-md border-gray-300 text-center" 
              placeholder="0" min="0" max="${item.reportedExpiredQuantity}"
              onchange="validateClaimQuantity(this, ${item.reportedExpiredQuantity}, '${item.productId}')"
              ${disabled}>
            <button class="claim-save-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs"
              onclick="saveClaim('${item.productId}')" ${disabled}>
              บันทึก
            </button>
          </div>
        </td>
        
        <!-- จำนวนของเข้า -->
        <td class="px-4 py-2 text-center">
          <input type="number" 
            class="received-quantity-input w-16 rounded-md border-gray-300 text-center" 
            placeholder="0" min="0" disabled>
        </td>
        
        <!-- วันที่ของเข้า + ปุ่มบันทึก -->
        <td class="px-4 py-2 text-center">
          <div class="flex items-center gap-2 justify-center">
            <input type="date" 
              class="received-date-input w-28 rounded-md border-gray-300 text-center text-xs" 
              disabled>
            <button class="receipt-save-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs"
              onclick="saveReceipt('${item.productId}')" disabled>
              บันทึก
            </button>
          </div>
        </td>
      </tr>`;
    });

    tableHtml += '</tbody></table></div></div>';
  }

  tableHtml += `</div>
    <div class="mt-6 pt-6 border-t">
      <div id="add-product-controls" class="hidden space-y-2">
        <p class="font-semibold">เพิ่มสินค้านอกรายการ:</p>
        <div class="flex space-x-2">
          <select id="new-supplier-select" onchange="updateNewProductDropdown()" 
            class="w-1/3 rounded-md border-gray-300 text-sm"></select>
          <select id="new-product-select" class="w-1/3 rounded-md border-gray-300 text-sm">
            <option value="">เลือกสินค้า</option>
          </select>
          <button onclick="addProductToClaimTable()" 
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md text-sm">เพิ่ม</button>
        </div>
      </div>
      
      <div class="flex justify-between items-center mt-4">
        <button onclick="showAddProductControls()" 
          class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">+ บวกเพิ่มสินค้า</button>
        <div class="text-sm text-gray-600">
          <span>หมายเหตุ: บันทึกเคลมแล้วจึงจะสามารถบันทึกของเข้าได้</span>
        </div>
      </div>
    </div>`;

  container.innerHTML = tableHtml;
  hideLoading();
}

function addProductToClaimTable() {
  const productId = document.getElementById('new-product-select').value;
  const branchId = document.getElementById('order-claim-branch').value;

  if (!productId) {
    showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาเลือกสินค้าที่ต้องการเพิ่ม', 'error');
    return;
  }

  if (document.getElementById(`claim-row-${productId}`)) {
    showCustomAlert('มีข้อมูลแล้ว', 'สินค้านี้มีอยู่ในตารางแล้ว', 'error');
    return;
  }

  showLoading();

  google.script.run.withSuccessHandler(responseString => {
    const result = JSON.parse(responseString);
    
    if (result.status === 'error') {
      handleError({ message: result.message });
      return;
    }

    const item = result.data;
    
    // เพิ่มลงใน claimItems array
    const newItem = {
      productId: item.productId,
      name: item.name,
      supplierId: item.supplierId,
      supplierName: item.supplierName,
      latestStock: item.latestStock,
      reportedExpiredQuantity: item.unclaimedExpired,
      claimableQuantity: 0,
      claimStatus: 'draft',
      receivedQuantity: 0,
      receivedDate: '',
      receiptStatus: 'pending'
    };
    
    claimItems.push(newItem);

    // ปรับปรุงประสิทธิภาพ: หา table ของ supplier โดยใช้ querySelector เดียว
    const allSuppliersContainer = document.getElementById('all-suppliers-container');
    let supplierTableBody = allSuppliersContainer.querySelector(`div[data-supplier-table="${item.supplierName}"] tbody`);

    if (!supplierTableBody) {
      // สร้าง supplier table ใหม่ (ย่อ HTML ลงให้กะทัดรัด)
      const tableHTML = `
        <h3 class="text-lg font-bold text-gray-800 mb-2">${item.supplierName}</h3>
        <div class="overflow-x-auto border rounded-lg">
          <table class="min-w-full text-sm table-fixed">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left font-semibold w-[15%]">รหัสสินค้า</th>
                <th class="px-4 py-2 text-left font-semibold w-[22%]">ชื่อสินค้า</th>
                <th class="px-4 py-2 text-center font-semibold w-[8%]">คงเหลือล่าสุด</th>
                <th class="px-4 py-2 text-center font-semibold w-[10%]">หมดอายุ (รอเคลม)</th>
                <th class="px-4 py-2 text-center font-semibold w-[15%]">จำนวนเคลม</th>
                <th class="px-4 py-2 text-center font-semibold w-[10%]">จำนวนของเข้า</th>
                <th class="px-4 py-2 text-center font-semibold w-[15%]">วันที่ของเข้า</th>
                <th class="px-4 py-2 text-center font-semibold w-[5%]">ลบ</th>
              </tr>
            </thead>
            <tbody class="divide-y"></tbody>
          </table>
        </div>`;
      
      const newTableDiv = document.createElement('div');
      newTableDiv.dataset.supplierTable = item.supplierName;
      newTableDiv.innerHTML = tableHTML;
      
      allSuppliersContainer.appendChild(newTableDiv);
      supplierTableBody = newTableDiv.querySelector('tbody');
    }

    // สร้างแถวใหม่โดยใช้ insertRow แทน innerHTML ทั้งหมด
    const newRow = supplierTableBody.insertRow();
    newRow.id = `claim-row-${item.productId}`;
    newRow.dataset.productId = item.productId;
    newRow.dataset.isOriginal = 'false'; // สินค้าที่เพิ่มใหม่

    // ใช้ template ที่กะทัดรัดขึ้น
    newRow.innerHTML = `
      <td class="px-4 py-2 font-mono text-left">${item.productId}</td>
      <td class="px-4 py-2 text-left">${item.name}</td>
      <td class="px-4 py-2 text-center">${item.latestStock}</td>
      <td class="px-4 py-2 text-center font-bold text-red-600">${item.unclaimedExpired}</td>
      <td class="px-4 py-2 text-center">
        <div class="flex items-center gap-2 justify-center">
          <input type="number" class="claim-quantity-input w-16 rounded-md border-gray-300 text-center" 
            placeholder="0" min="0" max="${item.unclaimedExpired}"
            onchange="validateClaimQuantity(this, ${item.unclaimedExpired}, '${item.productId}')">
          <button class="claim-save-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs"
            onclick="saveClaim('${item.productId}')">บันทึก</button>
        </div>
      </td>
      <td class="px-4 py-2 text-center">
        <input type="number" class="received-quantity-input w-16 rounded-md border-gray-300 text-center" 
          placeholder="0" min="0" disabled>
      </td>
      <td class="px-4 py-2 text-center">
        <div class="flex items-center gap-2 justify-center">
          <input type="date" class="received-date-input w-28 rounded-md border-gray-300 text-center text-xs" disabled>
          <button class="receipt-save-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs"
            onclick="saveReceipt('${item.productId}')" disabled>บันทึก</button>
        </div>
      </td>
      <td class="px-4 py-2 text-center">
        <button onclick="removeClaimItem('${item.productId}')" 
          class="text-red-500 hover:text-red-700 font-bold text-xl" title="ลบรายการนี้">×</button>
      </td>`;

    hideLoading();
    showCustomAlert('สำเร็จ', `เพิ่มสินค้า ${item.name} เรียบร้อยแล้ว`, 'success');

  }).withFailureHandler(handleError).getSingleProductData(productId, branchId);
}

// ฟังก์ชัน validate จำนวนเคลม
function validateClaimQuantity(input, maxQty, productId) {
  const value = parseInt(input.value) || 0;
  
  if (value > maxQty) {
    showCustomAlert('ข้อมูลผิดพลาด', `จำนวนเคลม (${value}) ไม่สามารถมากกว่าจำนวนหมดอายุ (${maxQty}) ได้`, 'error');
    input.value = maxQty;
    return false;
  }
  
  if (value < 0) {
    input.value = 0;
    return false;
  }
  
  // อัพเดทข้อมูลใน claimItems array
  const item = claimItems.find(i => i.productId === productId);
  if (item) {
    item.claimableQuantity = value;
  }
  
  return true;
}

// เพิ่มฟังก์ชันลบรายการเคลม
function removeClaimItem(productId) {
  showCustomConfirm('ยืนยันการลบ', `คุณต้องการลบสินค้า ${productId} ออกจากรายการใช่หรือไม่?`, () => {
    // ลบจาก claimItems array
    claimItems = claimItems.filter(item => item.productId !== productId);
    
    // ลบแถวจาก DOM
    const row = document.getElementById(`claim-row-${productId}`);
    if (row) {
      const table = row.closest('table');
      const tbody = row.closest('tbody');
      
      row.remove();
      
      // ตรวจสอบว่าถ้า supplier นี้ไม่มีสินค้าเหลือแล้ว ให้ลบ table ทั้งหมด
      if (tbody.children.length === 0) {
        const supplierDiv = table.closest('div[data-supplier-table]');
        if (supplierDiv) {
          supplierDiv.remove();
        }
      }
    }
    
    showCustomAlert('สำเร็จ', `ลบสินค้า ${productId} เรียบร้อยแล้ว`, 'success');
  });
} 

function saveClaim(productId) {
  const row = document.getElementById(`claim-row-${productId}`);
  const quantityInput = row.querySelector('.claim-quantity-input');
  const saveBtn = row.querySelector('.claim-save-btn');
  const quantity = parseInt(quantityInput.value) || 0;

  if (quantity <= 0) {
    showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาระบุจำนวนเคลมที่มากกว่า 0', 'error');
    return;
  }

  const branchId = document.getElementById('order-claim-branch').value;
  
  const claimData = {
    branchId: branchId,
    productId: productId,
    claimableQuantity: quantity
  };

  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();

      if (result.status === 'success') {
        // อัพเดท state
        const item = claimItems.find(i => i.productId === productId);
        if (item) {
          item.claimableQuantity = quantity;
          item.claimStatus = 'claimed';
          item.claimId = result.claimId; // เก็บ claimId สำหรับใช้ภายหลัง
        }

        // ล็อค input และปุ่ม
        quantityInput.disabled = true;
        quantityInput.classList.add('bg-gray-100');
        saveBtn.disabled = true;
        saveBtn.textContent = 'บันทึกแล้ว';
        saveBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

        // เปิดใช้งาน input ของเข้า
        const receivedInput = row.querySelector('.received-quantity-input');
        const dateInput = row.querySelector('.received-date-input');
        const receiptBtn = row.querySelector('.receipt-save-btn');

        receivedInput.disabled = false;
        receivedInput.classList.remove('bg-gray-100');
        dateInput.disabled = false;
        dateInput.classList.remove('bg-gray-100');
        receiptBtn.disabled = false;
        receiptBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        receiptBtn.classList.add('bg-green-500', 'hover:bg-green-600');

        showCustomAlert('สำเร็จ', result.message, 'success');
      } else {
        showCustomAlert('ข้อผิดพลาด', result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .saveClaim(JSON.stringify(claimData));
}

function saveReceipt(productId) {
  const row = document.getElementById(`claim-row-${productId}`);
  const receivedInput = row.querySelector('.received-quantity-input');
  const dateInput = row.querySelector('.received-date-input');
  const saveBtn = row.querySelector('.receipt-save-btn');

  const receivedQty = parseInt(receivedInput.value) || 0;
  const receivedDate = dateInput.value;

  if (receivedQty <= 0) {
    showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาระบุจำนวนของที่รับเข้า', 'error');
    return;
  }

  if (!receivedDate) {
    showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาระบุวันที่รับของ', 'error');
    return;
  }

  const branchId = document.getElementById('order-claim-branch').value;
  
  const receiptData = {
    branchId: branchId,
    productId: productId,
    receivedQuantity: receivedQty,
    receivedDate: receivedDate
  };

  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();

      if (result.status === 'success') {
        // อัพเดท state
        const item = claimItems.find(i => i.productId === productId);
        if (item) {
          item.receivedQuantity = receivedQty;
          item.receivedDate = receivedDate;
          item.receiptStatus = 'received';
        }

        // ล็อค input และปุ่ม
        receivedInput.disabled = true;
        receivedInput.classList.add('bg-gray-100');
        dateInput.disabled = true;
        dateInput.classList.add('bg-gray-100');
        saveBtn.disabled = true;
        saveBtn.textContent = 'บันทึกแล้ว';
        saveBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

        showCustomAlert('สำเร็จ', result.message, 'success');
      } else {
        showCustomAlert('ข้อผิดพลาด', result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .saveClaimReceipt(JSON.stringify(receiptData));
}

function saveReceipt(productId) {
  const row = document.getElementById(`claim-row-${productId}`);
  const receivedInput = row.querySelector('.received-quantity-input');
  const dateInput = row.querySelector('.received-date-input');
  const saveBtn = row.querySelector('.receipt-save-btn');
  
  const receivedQty = parseInt(receivedInput.value) || 0;
  const receivedDate = dateInput.value;
  
  if (receivedQty <= 0) {
    showCustomAlert('ข้อมูลไม่ครับถ้วน', 'กรุณาระบุจำนวนของที่รับเข้า', 'error');
    return;
  }
  
  if (!receivedDate) {
    showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาระบุวันที่รับของ', 'error');
    return;
  }
  
  // ตรวจสอบกับจำนวนเคลม
  const item = claimItems.find(i => i.productId === productId);
  if (item && receivedQty !== item.claimableQuantity) {
    const message = receivedQty > item.claimableQuantity 
      ? `ของเข้ามากกว่าจำนวนเคลม (${receivedQty} > ${item.claimableQuantity}) กรุณาติดต่อ Supplier เพื่อจัดการการส่งคืน`
      : `ของเข้าน้อยกว่าจำนวนเคลม (${receivedQty} < ${item.claimableQuantity}) กรุณาติดต่อ Supplier เพื่อรอของเข้าเพิ่มในรอบถัดไป`;
    
    showCustomAlert('แจ้งเตือน', message, 'info');
  }
  
  // อัพเดท state
  if (item) {
    item.receivedQuantity = receivedQty;
    item.receivedDate = receivedDate;
    item.receiptStatus = 'received';
  }
  
  // ล็อค input และปุ่ม
  receivedInput.disabled = true;
  receivedInput.classList.add('bg-gray-100');
  dateInput.disabled = true;
  dateInput.classList.add('bg-gray-100');
  saveBtn.disabled = true;
  saveBtn.textContent = 'บันทึกแล้ว';
  saveBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
  saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
  
  showCustomAlert('สำเร็จ', `บันทึกการรับของ ${receivedQty} ชิ้น ในวันที่ ${new Date(receivedDate).toLocaleDateString('th-TH')} เรียบร้อยแล้ว`, 'success');
}
                    
            function showAddProductControls() {
                const controls = document.getElementById('add-product-controls');
                controls.classList.toggle('hidden');
                if (!controls.classList.contains('hidden')) {
                    const supplierSelect = document.getElementById('new-supplier-select');
                    if (supplierSelect.options.length <= 1) {
                        let supplierOptions = '<option value="">เลือกซัพพลายเออร์</option>';
                        SUPPLIERS.forEach(s => {
                            supplierOptions += `<option value="${s.id}">${s.name}</option>`;
                        });
                        supplierSelect.innerHTML = supplierOptions;
                    }
                }
            }

                    function updateNewProductDropdown() {
                const supplierId = document.getElementById('new-supplier-select').value;
                const productDropdown = document.getElementById('new-product-select');
                productDropdown.innerHTML = '<option>กำลังโหลด...</option>';
                if (supplierId) {
                    google.script.run.withSuccessHandler(products => {
                        productDropdown.innerHTML = '<option value="">เลือกสินค้า</option>';
                        products.forEach(p => {
                            productDropdown.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                        });
                    }).withFailureHandler(handleError).getProductsBySupplier(supplierId);
                } else {
                    productDropdown.innerHTML = '<option value="">เลือกสินค้า</option>';
                }
            }



      function addCancellationRowForVerification() {
        const container = document.getElementById('verify-cancellation-rows-container');
        const rowDiv = document.createElement('div');
        rowDiv.className = 'p-3 border rounded-lg grid grid-cols-1 md:grid-cols-3 gap-4 items-center bg-gray-50 relative verify-cancellation-row';

        let verifyEmployeeOptions = '<option value="">-- เลือกหรือพิมพ์ชื่อ --</option>';
        BRANCH_EMPLOYEES.forEach(emp => {
          verifyEmployeeOptions += `<option value="${emp.name}">${emp.name}</option>`;
        });

        rowDiv.innerHTML = `
          <div>
            <label class="text-xs">เลขที่บิล</label>
            <input type="text" class="verify-cancel-bill-number mt-1 w-full text-sm rounded-md">
          </div>
          <div>
            <label class="text-xs">เหตุผล</label>
            <input type="text" list="cancellation-reasons" class="verify-cancel-reason mt-1 w-full text-sm rounded-md">
          </div>
          <div>
            <label class="text-xs">จำนวนเงิน</label>
            <input type="number" class="verify-cancel-amount mt-1 w-full text-sm rounded-md">
          </div>
          <div>
            <label class="text-xs">ผู้ยกเลิกบิล</label>
            <input type="text" list="cancel-employee-list-${itemRowCounter}" class="verify-cancel-by-name mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="เลือกหรือพิมพ์ชื่อ">
            <datalist id="cancel-employee-list-${itemRowCounter}">${verifyEmployeeOptions}</datalist>
          </div>
          <button onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button>
        `;
        container.appendChild(rowDiv);
      }



            // --- STOCK OVERVIEW MODULE (OFFICE) ---

            function showStockOverviewModule() {
                document.getElementById('header-title').innerText = 'ภาพรวมสต็อก';
                const appContainer = document.getElementById('app-container');

                // สร้าง options จากสาขาที่ user ดูแล
                let branchOptions = '<option value="">-- กรุณาเลือกสาขา --</option>';
                const managedBranchIds = USER_DETAILS.branchesManaged;
                ALL_BRANCHES.forEach(b => {
                    if (managedBranchIds.includes(String(b.id))) {
                        branchOptions += `<option value="${b.id}">${b.name}</option>`;
                    }
                });

                appContainer.innerHTML = `
                    <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">
                        <button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-medium">สาขา</label>
                                <select id="stock-branch-select" onchange="handleStockSearch()" class="mt-1 w-full rounded-md">${branchOptions}</select>
                            </div>
                        </div>
                        <div id="stock-table-container">
                            <p class="text-gray-500">กรุณาเลือกสาขาเพื่อแสดงข้อมูลสต็อก</p>
                        </div>
                    </div>`;
            }

            function handleStockSearch() {
                const branchId = document.getElementById('stock-branch-select').value;
                const tableContainer = document.getElementById('stock-table-container');

                if (!branchId) {
                    tableContainer.innerHTML = '<p class="text-gray-500">กรุณาเลือกสาขาเพื่อแสดงข้อมูลสต็อก</p>';
                    return;
                }

                showLoading();
                tableContainer.innerHTML = '<p>กำลังโหลดข้อมูลสต็อก...</p>';
                google.script.run
                    .withSuccessHandler(responseString => {
                        const result = JSON.parse(responseString);
                        if (result.status === 'success') {
                            renderStockTable(result.data);
                        } else {
                            handleError({ message: result.message });
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .getStockOverview(branchId);
            }

            function renderStockTable(data) {
                const tableContainer = document.getElementById('stock-table-container');
                if (data.length === 0) {
                    tableContainer.innerHTML = '<p class="text-center text-gray-600 bg-yellow-100 p-4 rounded-md">ไม่พบข้อมูลสต็อกที่ผ่านการตรวจสอบแล้วสำหรับสาขานี้</p>';
                    return;
                }

                const groupedBySupplier = data.reduce((acc, item) => {
                    const supplier = item.supplierName || 'Uncategorized';
                    if (!acc[supplier]) {
                        acc[supplier] = [];
                    }
                    acc[supplier].push(item);
                    return acc;
                }, {});

                let html = '<div class="space-y-8">';

                const sortedSuppliers = Object.keys(groupedBySupplier).sort();

                for (const supplierName of sortedSuppliers) {
                    html += `
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">${supplierName}</h3>
                            <div class="overflow-x-auto border rounded-lg">

                                <table class="min-w-full divide-y divide-gray-200 table-fixed">
                                    <thead class="bg-gray-50">
                                        <tr>

                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[20%]">รหัสสินค้า</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[40%]">ชื่อสินค้า</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-[15%]">สต็อกคงเหลือ</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[25%]">อัปเดตล่าสุด</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">`;

                    groupedBySupplier[supplierName].sort((a,b) => a.productName.localeCompare(b.productName)).forEach(item => {
                        html += `
                            <tr>

                                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-left">${item.productId}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-left">${item.productName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-center">${item.currentStock}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-left">${item.lastUpdate}</td>
                            </tr>`;
                    });

                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                }

                html += '</div>';
                tableContainer.innerHTML = html;
            }

            function fetchAndDisplayPreviousData(rowId) {
                const productDropdown = document.getElementById(`verify-product-${rowId}`);
                const productId = productDropdown.value;
                const container = document.querySelector(`#verify-item-row-${rowId} .previous-data-container`);

                if (!productId) {
                    container.innerHTML = ''; // ถ้าไม่เลือกสินค้า ก็ล้างข้อมูลเก่าทิ้ง
                    return;
                }

                const modalDiv = document.querySelector('#verification-modal > div');
                const branchId = modalDiv.dataset.branchId;
                const reportDate = modalDiv.dataset.reportDate;

                container.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">กำลังค้นหาข้อมูล...</p>';

                google.script.run
                    .withSuccessHandler(responseString => {
                        const result = JSON.parse(responseString);
                        if (result.status === 'success' && result.data) {
                            const prev = result.data;
                            const prevDate = new Date(prev.reportDate).toLocaleDateString('th-TH');

                            const previousDataHtml = `
                                <div class="pt-2 mt-2 border-t border-dashed">
                                    <div class="text-xs text-gray-500 mb-1"><span class="font-semibold">ข้อมูลวันก่อนหน้า (${prevDate}):</span></div>
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                        <div><label class="text-xs text-gray-500">ขาย</label><input type="number" value="${prev.salesQuantity||0}" class="mt-1 w-full text-sm rounded-md bg-gray-200" disabled></div>
                                        <div><label class="text-xs text-gray-500">รับเข้า</label><input type="number" value="${prev.receivedQuantity||0}" class="mt-1 w-full text-sm rounded-md bg-gray-200" disabled></div>
                                        <div><label class="text-xs text-gray-500">หมดอายุ</label><input type="number" value="${prev.expiredQuantity||0}" class="mt-1 w-full text-sm rounded-md bg-gray-200" disabled></div>
                                        <div><label class="text-xs text-gray-500">นับจริงฯ</label><input type="number" value="${prev.currentStock||0}" class="mt-1 w-full text-sm rounded-md bg-gray-200 font-bold" disabled></div>
                                        <div><label class="text-xs text-gray-500">ย้ายสาขา</label><input type="number" value="${prev.transferredQuantity||0}" class="mt-1 w-full text-sm rounded-md bg-gray-200" disabled></div>
                                    </div>
                                    <div class="${(prev.transferredQuantity > 0) ? '' : 'hidden'} pt-2"><label class="text-xs text-gray-500">ย้ายไปสาขา</label><select class="mt-1 block w-full text-sm rounded-md bg-gray-200" disabled><option>${prev.toBranchName||'N/A'}</option></select></div>
                                </div>`;
                            container.innerHTML = previousDataHtml;
                        } else {
                            container.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">ไม่พบข้อมูลวันก่อนหน้าสำหรับสินค้านี้</p>';
                        }
                    })
                    .withFailureHandler(error => {
                        container.innerHTML = `<p class="text-xs text-red-500 text-center py-4">เกิดข้อผิดพลาด: ${error.message}</p>`;
                    })
                    .getPreviousItemData(productId, branchId, reportDate);
            }


            // --- ONLINE RECONCILIATION MODULE (OFFICE) ---

            let ONLINE_CHANNELS = []; // เก็บข้อมูลช่องทางออนไลน์

            function showReconciliationModule() {
                document.getElementById('header-title').innerText = 'กระทบยอดชำระเงินออนไลน์';
                const appContainer = document.getElementById('app-container');
                appContainer.innerHTML = `<div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6"><p>กำลังโหลดข้อมูลช่องทาง...</p></div>`;

                if (ONLINE_CHANNELS.length === 0) {
                    google.script.run.withSuccessHandler(channels => {
                        ONLINE_CHANNELS = channels;
                        renderReconciliationModule();
                    }).withFailureHandler(handleError).getOnlinePaymentChannels();
                } else {
                    renderReconciliationModule();
                }
            }

            function renderReconciliationModule() {
                const appContainer = document.getElementById('app-container');
                let channelOptions = '<option value="">-- ทุกช่องทาง --</option>';
                ONLINE_CHANNELS.forEach(c => { channelOptions += `<option value="${c.id}">${c.name}</option>`; });

                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const todayFormatted = today.toISOString().split('T')[0];

                appContainer.innerHTML = `
                    <div class="max-w-full mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">
                        <button onclick="showDashboard()" class="text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button>
                        <div class="space-y-4 p-4 border rounded-lg bg-gray-50">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label class="block text-sm font-medium">ช่องทางการชำระเงิน</label>
                                    <select id="recon-channel" class="mt-1 w-full rounded-md">${channelOptions}</select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">จากวันที่</label>
                                    <input type="date" id="recon-start-date" value="${firstDayOfMonth}" class="mt-1 w-full rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">ถึงวันที่</label>
                                    <input type="date" id="recon-end-date" value="${todayFormatted}" class="mt-1 w-full rounded-md">
                                </div>
                                <button onclick="handleReconciliationSearch()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">ค้นหา</button>
                            </div>
                        </div>
                        <div id="recon-table-container"></div>
                    </div>`;
            }

            function handleReconciliationSearch() {
                const startDate = document.getElementById('recon-start-date').value;
                const endDate = document.getElementById('recon-end-date').value;

                if (!startDate || !endDate) {
                    showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาเลือกช่วงวันที่ให้ครบถ้วน', 'error');
                    return;
                }

                showLoading();
                const tableContainer = document.getElementById('recon-table-container');
                tableContainer.innerHTML = '<p>กำลังประมวลผลข้อมูลยอดขาย...</p>';

                google.script.run
                    .withSuccessHandler(responseString => {
                        const result = JSON.parse(responseString);
                        if (result.status === 'error') {
                            handleError({ message: result.message });
                            return;
                        }
                        renderReconciliationTable(result.data);
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .getReconciliationData(startDate, endDate);
            }

            function renderReconciliationTable(data) {
                const tableContainer = document.getElementById('recon-table-container');
                const selectedChannelId = document.getElementById('recon-channel').value;
                const filteredData = selectedChannelId ? data.filter(d => d.channelId === selectedChannelId) : data;

                if (filteredData.length === 0) {
                    tableContainer.innerHTML = '<p class="text-center text-gray-500">ไม่พบข้อมูลยอดขายออนไลน์ในช่วงวันที่และช่องทางที่เลือก</p>';
                    return;
                }

                const dataByBranch = filteredData.reduce((acc, item) => {
                    const branchName = ALL_BRANCHES.find(b => b.id == item.branchId)?.name || `สาขา ${item.branchId}`;
                    if (!acc[branchName]) acc[branchName] = [];
                    acc[branchName].push(item);
                    return acc;
                }, {});

                let finalHtml = '<div class="space-y-8">';

                for (const branchName in dataByBranch) {
                    finalHtml += `
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${branchName}</h3>
                            <div class="overflow-x-auto border rounded-lg">
                                <table class="min-w-full text-sm">
                                    <thead class="bg-gray-50 text-xs">
                                        <tr>
                                            <th class="px-2 py-2 text-left">วันที่</th>
                                            ${!selectedChannelId ? '<th class="px-2 py-2 text-left">ช่องทาง</th>' : ''}
                                            <th class="px-2 py-2 text-right">ยอดขายรวม</th>
                                            <th class="px-2 py-2 text-center bg-cyan-100">ค่าธรรมเนียม (GP)</th>
                                            <th class="px-2 py-2 text-right">VAT 7%</th>
                                            <th class="px-2 py-2 text-right">รวมหัก</th>
                                            <th class="px-2 py-2 text-right">ยอดสุทธิที่คาดไว้</th>
                                            <th class="px-2 py-2 text-center bg-cyan-100">วันที่ยอดเข้า</th>
                                            <th class="px-2 py-2 text-center bg-cyan-100">ยอดเข้าจริง</th>
                                            <th class="px-2 py-2 text-right">ผลต่าง</th>
                                            <th class="px-2 py-2 text-left bg-cyan-100">หมายเหตุ</th>
                                            <th class="px-2 py-2 text-center">บันทึก</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">`;

                    dataByBranch[branchName].sort((a,b) => new Date(a.dateOfSale) - new Date(b.dateOfSale) || a.channelName.localeCompare(b.channelName)).forEach(item => {
                        const rowId = `${item.branchId}-${item.channelId}-${item.dateOfSale}`;
                        const isSaved = item.actualDeposit || item.fee;
                        const disabledAttr = isSaved ? 'disabled' : '';
                        const buttonClass = isSaved ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700';
                        const buttonText = isSaved ? 'บันทึกแล้ว' : 'บันทึก';

                        finalHtml += `
                            <tr id="recon-row-${rowId}" class="recon-data-row" data-gross-sales="${item.grossSales}" data-is-vat-on-fee="${item.isVatOnFee}" data-branch-id="${item.branchId}" data-channel-id="${item.channelId}" data-date-of-sale="${item.dateOfSale}">
                                <td class="px-2 py-1 whitespace-nowrap">${new Date(item.dateOfSale).toLocaleDateString('th-TH', {day: '2-digit', month: '2-digit', year: '2-digit'})}</td>
                                ${!selectedChannelId ? `<td class="px-2 py-1 whitespace-nowrap">${item.channelName}</td>` : ''}
                                <td class="px-2 py-1 text-right bg-gray-100">${item.grossSales.toFixed(2)}</td>

                                <td class="px-2 py-1 w-28 bg-cyan-50"><input type="number" class="recon-fee w-full rounded-md border-gray-300 text-right text-sm p-1" value="${item.fee || ''}" oninput="updateReconciliationRow('${rowId}')" ${disabledAttr}></td>
                                <td class="px-2 py-1 text-right text-red-500 bg-gray-100 recon-vat">-</td>
                                <td class="px-2 py-1 text-right text-red-600 font-semibold bg-gray-100 recon-total-deduction">-</td>
                                <td class="px-2 py-1 text-right text-blue-600 font-bold bg-gray-100 recon-expected-net">-</td>
                                <td class="px-2 py-1 w-36 bg-cyan-50"><input type="date" class="recon-deposit-date w-full rounded-md border-gray-300 text-sm p-1" value="${item.depositDate}" ${disabledAttr}></td>
                                <td class="px-2 py-1 w-28 bg-cyan-50"><input type="number" class="recon-actual-deposit w-full rounded-md border-gray-300 text-right text-sm p-1" value="${item.actualDeposit}" oninput="updateReconciliationRow('${rowId}')" ${disabledAttr}></td>
                                <td class="px-2 py-1 text-right font-bold text-gray-500 bg-gray-100 recon-difference">-</td>
                                <td class="px-2 py-1 w-36 bg-cyan-50"><input type="text" class="recon-note w-full rounded-md border-gray-300 text-sm p-1" value="${item.note}" ${disabledAttr}></td>
                                <td class="px-2 py-1 text-center">
                                    <button id="save-btn-${rowId}" onclick="handleSaveSingleReconRow('${rowId}')" class="text-white font-bold py-1 px-3 rounded-md text-xs ${buttonClass}" ${disabledAttr}>
                                        ${buttonText}
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    finalHtml += `</tbody></table></div></div>`;
                }

                finalHtml += `</div>`;
                tableContainer.innerHTML = finalHtml;

                document.querySelectorAll('.recon-data-row').forEach(row => {
                    const rowId = row.id.replace('recon-row-', '');
                    if (row.querySelector('.recon-fee').value) {
                        updateReconciliationRow(rowId);
                    }
                });
            }



            /**
             * ฟังก์ชันใหม่: จัดการการบันทึกข้อมูลทีละแถว
             * (ให้ลบฟังก์ชัน handleSaveReconciliation เดิมทิ้ง แล้วใช้ฟังก์ชันนี้แทน)
             */
            function handleSaveSingleReconRow(rowId) {
                const row = document.getElementById(`recon-row-${rowId}`);
                const saveButton = document.getElementById(`save-btn-${rowId}`);

                const feeInput = row.querySelector('.recon-fee');
                const depositDateInput = row.querySelector('.recon-deposit-date');
                const actualDepositInput = row.querySelector('.recon-actual-deposit');

                // --- จุดที่แก้ไข: เพิ่มเงื่อนไขการตรวจสอบข้อมูล ---
                if (!feeInput.value || !depositDateInput.value || !actualDepositInput.value) {
                    showCustomAlert(
                        'ข้อมูลไม่ครบถ้วน',
                        'กรุณากรอกข้อมูล "ค่าธรรมเนียม", "วันที่ยอดเข้า", และ "ยอดเข้าจริง" ให้ครบถ้วนก่อนบันทึก',
                        'error'
                    );
                    return; // หยุดการทำงานทันทีถ้าข้อมูลไม่ครบ
                }
                // --- สิ้นสุดการแก้ไข ---

                const itemToSave = {
                    branchId: row.dataset.branchId,
                    channelId: row.dataset.channelId,
                    dateOfSale: row.dataset.dateOfSale,
                    depositDate: depositDateInput.value,
                    actualDeposit: parseFloat(actualDepositInput.value) || null,
                    note: row.querySelector('.recon-note').value,
                    fee: parseFloat(feeInput.value) || null
                };

                saveButton.textContent = 'กำลังบันทึก...';
                saveButton.disabled = true;

                google.script.run
                    .withSuccessHandler(response => {
                        const result = JSON.parse(response);
                        if (result.status === 'success') {
                            showCustomAlert('สำเร็จ', 'บันทึกข้อมูลแถวนี้เรียบร้อยแล้ว', 'success');
                            row.querySelectorAll('input').forEach(input => input.disabled = true);
                            saveButton.textContent = 'บันทึกแล้ว';
                            saveButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                            saveButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                        } else {
                            showCustomAlert('ผิดพลาด', result.message, 'error');
                            saveButton.textContent = 'บันทึก';
                            saveButton.disabled = false;
                        }
                    })
                    .withFailureHandler(error => {
                        handleError(error);
                        saveButton.textContent = 'บันทึก';
                        saveButton.disabled = false;
                    })
                    .saveReconciliationData(JSON.stringify(itemToSave));
            }




            function updateReconciliationRow(rowId) {
                const row = document.getElementById(`recon-row-${rowId}`);
                const grossSales = parseFloat(row.dataset.grossSales);
                const isVatOnFee = row.dataset.isVatOnFee === 'true';

                const feeInput = row.querySelector('.recon-fee');
                const actualDepositInput = row.querySelector('.recon-actual-deposit');

                const vatCell = row.querySelector('.recon-vat');
                const totalDeductionCell = row.querySelector('.recon-total-deduction');
                const expectedNetCell = row.querySelector('.recon-expected-net');
                const differenceCell = row.querySelector('.recon-difference');

                const fee = parseFloat(feeInput.value) || 0;
                const actualDeposit = parseFloat(actualDepositInput.value);

                const vat = isVatOnFee ? fee * 0.07 : 0;
                const totalDeduction = fee + vat;
                const expectedNet = grossSales - totalDeduction;

                vatCell.textContent = vat.toFixed(2);
                totalDeductionCell.textContent = totalDeduction.toFixed(2);
                expectedNetCell.textContent = expectedNet.toFixed(2);

                if (isNaN(actualDeposit)) {
                    differenceCell.textContent = '-';
                    differenceCell.className = 'px-2 py-1 text-right font-bold text-gray-500 recon-difference';
                    return;
                }

                const difference = actualDeposit - expectedNet;
                differenceCell.textContent = difference.toFixed(2);
                if (Math.abs(difference) < 0.01) { // ใช้ Math.abs เผื่อกรณีทศนิยมเล็กน้อย
                    differenceCell.className = 'px-2 py-1 text-right font-bold text-green-600 recon-difference';
                } else {
                    differenceCell.className = 'px-2 py-1 text-right font-bold text-red-600 recon-difference';
                }
            }

            function handleSaveReconciliation() {
                const rows = document.querySelectorAll('.recon-data-row');
                const dataToSave = [];
                rows.forEach(row => {
                    const fee = row.querySelector('.recon-fee').value;
                    const actualDeposit = row.querySelector('.recon-actual-deposit').value;

                    // บันทึกเฉพาะแถวที่มีการกรอกค่าธรรมเนียมหรือยอดเงินเข้าจริง
                    if (fee || actualDeposit) {
                        dataToSave.push({
                            branchId: row.dataset.branchId,
                            channelId: row.dataset.channelId,
                            dateOfSale: row.dataset.dateOfSale,
                            depositDate: row.querySelector('.recon-deposit-date').value,
                            actualDeposit: parseFloat(actualDeposit) || null,
                            note: row.querySelector('.recon-note').value,
                            fee: parseFloat(fee) || null
                        });
                    }
                });

                if (dataToSave.length === 0) {
                    showCustomAlert('ไม่มีข้อมูล', 'กรุณากรอกข้อมูล "ค่าธรรมเนียม" หรือ "ยอดเข้าจริง" อย่างน้อยหนึ่งรายการเพื่อบันทึก', 'info');
                    return;
                }

                showCustomConfirm('ยืนยันการบันทึก', `คุณต้องการบันทึกข้อมูลการกระทบยอด ${dataToSave.length} รายการใช่หรือไม่?`, () => {
                    showLoading();
                    google.script.run
                        .withSuccessHandler(response => {
                            const result = JSON.parse(response);
                            hideLoading();
                            showCustomAlert(result.status === 'success' ? 'สำเร็จ' : 'ผิดพลาด', result.message, result.status);
                        })
                        .withFailureHandler(handleError)
                        .saveReconciliationData(JSON.stringify(dataToSave));
                });
            }




            // ฟังก์ชันคำนวณยอดสินค้า
function calculateProductTotals() {
    let totalUnits = 0;
    let totalAmount = 0;
    
    reportItems.forEach(item => {
        const qty = parseFloat(item.salesQuantity) || 0;
        const price = parseFloat(item.price) || 0;
        totalUnits += qty;
        totalAmount += qty * price;
    });
    
    const container = document.getElementById('product-totals');
    if (container) {
        container.innerHTML = `
            <div class="mt-4 p-3 border-t-2 border-dashed text-right font-bold">
                <span>จำนวนรวม: <span class="text-cyan-700">${totalUnits}</span> ชิ้น</span> | 
                <span>ยอดขายรวม: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> บาท</span>
            </div>`;
    }
    return totalAmount;
}

// ฟังก์ชัน Add-on
function calculateAddOnTotals() {
    const addon10 = parseFloat(document.getElementById('addon-10')?.value) || 0;
    const addon15 = parseFloat(document.getElementById('addon-15')?.value) || 0;
    const total = addon10 + addon15;
    
    const container = document.getElementById('addon-totals');
    if (container) {
        container.innerHTML = `
            <div class="mt-4 p-3 border-t-2 border-dashed text-right font-bold">
                <span>ยอดรวมสั่งเพิ่ม: <span class="text-cyan-700">${total.toFixed(2)}</span> บาท</span>
            </div>`;
    }
    return total;
}

// ฟังก์ชันคำนวณเงินสด
function calculateCashAmount() {
    let totalSales = calculateProductTotals() + calculateAddOnTotals();
    // รวมยอดเครื่องดื่ม
    document.querySelectorAll('.drink-category-sales-input').forEach(input => {
        totalSales += parseFloat(input.value) || 0;
    });
    
    // หักช่องทางออนไลน์
    let onlineTotal = 0;
    PAYMENT_TYPES.forEach(pt => {
        if (pt.name !== 'เงินสด') {
            const value = parseFloat(document.getElementById(`payment-${pt.id}`)?.value) || 0;
            
            onlineTotal += value;
        }
    });
    
    // หักส่วนลด
    let discountTotal = 0;
    document.querySelectorAll('.discount-summary-input').forEach(input => {
        discountTotal += parseFloat(input.value) || 0;
    });
    
    const cashAmount = totalSales - onlineTotal - discountTotal;
    const cashPayment = PAYMENT_TYPES.find(pt => pt.name === 'เงินสด');
    if (cashPayment) {
        const cashInput = document.getElementById(`payment-${cashPayment.id}`);
        if (cashInput) {
            cashInput.value = Math.max(0, cashAmount).toFixed(2);
            updateTotals('payment');

        }
    }
}


function calculateVerificationAddOnTotals() {
    const addon10 = parseFloat(document.getElementById('verify-addon-10')?.value) || 0;
    const addon15 = parseFloat(document.getElementById('verify-addon-15')?.value) || 0;
    const total = addon10 + addon15;
    
    const container = document.getElementById('verify-addon-totals');
    if (container) {
        container.innerHTML = `
            <div class="mt-4 p-3 border-t-2 border-dashed text-right font-bold">
                <span>ยอดรวมสั่งเพิ่ม: <span class="text-cyan-700">${total.toFixed(2)}</span> บาท</span>
            </div>`;
    }
    return total;
}


function calculateVerificationProductTotals() {
    let totalUnits = 0;
    let totalAmount = 0;
    
    verificationReportItems.forEach(item => {
        const qty = parseFloat(item.salesQuantity) || 0;
        const price = parseFloat(item.price) || 0;
        totalUnits += qty;
        totalAmount += qty * price;
    });
    
    const container = document.getElementById('verify-product-totals');
    if (container) {
        container.innerHTML = totalUnits > 0 ? `
            <span>จำนวนรวม: <span class="text-cyan-700">${totalUnits}</span> ชิ้น</span> | 
            <span>ยอดขายรวม: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> บาท</span>
        ` : '';
    }
    return totalAmount;
}

function calculateVerificationCashAmount() {
    let totalSales = calculateVerificationProductTotals() + calculateVerificationAddOnTotals();
    
    document.querySelectorAll('.verify-drink-sales-input').forEach(input => {
        totalSales += parseFloat(input.value) || 0;
    });
    
    let onlineTotal = 0;
    PAYMENT_TYPES.forEach(pt => {
        if (pt.name !== 'เงินสด') {
            const input = document.querySelector(`.verify-payment-summary-input[data-type-id="${pt.id}"]`);
            if (input) {
                onlineTotal += parseFloat(input.value) || 0;
            }
        }
    });
    
    let discountTotal = 0;
    document.querySelectorAll('.verify-discount-summary-input').forEach(input => {
        discountTotal += parseFloat(input.value) || 0;
    });
    
    const cashAmount = totalSales - onlineTotal - discountTotal;
    const cashPayment = PAYMENT_TYPES.find(pt => pt.name === 'เงินสด');
    
    if (cashPayment) {
        const cashInput = document.querySelector(`.verify-payment-summary-input[data-type-id="${cashPayment.id}"]`);
        if (cashInput) {
            cashInput.value = Math.max(0, cashAmount).toFixed(2);
            updateVerificationTotals('payment');
        }
    }
}

// ==================== COMPARISON DASHBOARD ====================

function showComparisonDashboard() {
    document.getElementById('header-title').innerText = 'เปรียบเทียบสถิติระหว่างสาขา';
    const appContainer = document.getElementById('app-container');
    
    // เตรียม branch options ตามสิทธิ์
    const isOffice = USER_DETAILS.role === 'ออฟฟิศ';
    const isFront = USER_DETAILS.role === 'หน้าร้าน';
    
    let branchCheckboxes = '';
    
    if (isOffice) {
        // แสดงเฉพาะสาขาที่ดูแล
        USER_DETAILS.branchesManaged.forEach(branchId => {
            const branch = ALL_BRANCHES.find(b => b.id === branchId);
            if (branch) {
                const color = BRANCH_COLORS[branchId] || '#999';
                branchCheckboxes += `
                    <label class="flex items-center mb-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                        <input type="checkbox" value="${branchId}" class="comparison-branch-checkbox mr-2" 
                               onchange="updateComparisonCharts()">
                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span>
                        <span class="text-sm">${branch.name}</span>
                    </label>`;
            }
        });
    } else if (isFront) {
        // แสดงเฉพาะสาขาตัวเอง (ไม่สามารถเลือกได้)
        const branch = ALL_BRANCHES.find(b => b.id === USER_DETAILS.branchIdAssigned);
        if (branch) {
            const color = BRANCH_COLORS[USER_DETAILS.branchIdAssigned] || '#999';
            branchCheckboxes = `
                <label class="flex items-center mb-2 p-1">
                    <input type="checkbox" value="${USER_DETAILS.branchIdAssigned}" 
                           class="comparison-branch-checkbox mr-2" checked disabled>
                    <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span>
                    <span class="text-sm">${branch.name}</span>
                </label>
                <p class="text-xs text-gray-500 mt-2">* เปรียบเทียบกับค่าเฉลี่ยรวมทุกสาขา</p>`;
        }
    }
    
    // Default dates
    const today = new Date();
    const sevenDaysAgo = new Date(today);
    sevenDaysAgo.setDate(today.getDate() - 6);
    
    const todayStr = today.toISOString().split('T')[0];
    const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
    
    appContainer.innerHTML = `
        <div class="max-w-7xl mx-auto space-y-6">
            <button onclick="showDashboard()" class="text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button>
            
            <!-- Filter Bar -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <!-- Branch Selection -->
                    <div class="md:col-span-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">เลือกสาขา</label>
                        <div class="border rounded-lg p-3 max-h-40 overflow-y-auto">
                            ${branchCheckboxes}
                        </div>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ช่วงเวลา</label>
                        <div class="flex gap-2">
                            <button onclick="setComparisonDateRange(7)" 
                                    class="comparison-preset-btn px-3 py-2 bg-blue-600 text-white rounded text-sm">
                                7 วัน
                            </button>
                            <button onclick="setComparisonDateRange('thisWeek')" 
                                    class="comparison-preset-btn px-3 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">
                                สัปดาห์นี้
                            </button>
                            <button onclick="setComparisonDateRange('thisMonth')" 
                                    class="comparison-preset-btn px-3 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">
                                เดือนนี้
                            </button>
                        </div>
                    </div>
                    
                    <!-- Custom Date -->
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">กำหนดเอง</label>
                        <div class="flex gap-2 items-center">
                            <input type="date" id="comparison-start-date" value="${sevenDaysAgoStr}" 
                                   class="border rounded px-2 py-1 text-sm flex-1">
                            <span class="text-sm">ถึง</span>
                            <input type="date" id="comparison-end-date" value="${todayStr}" 
                                   class="border rounded px-2 py-1 text-sm flex-1">
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="md:col-span-2 flex gap-2">
                        <button onclick="loadComparisonData()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium flex-1">
                            แสดงข้อมูล
                        </button>
                        <button onclick="exportComparisonData()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium"
                                id="comparison-export-btn" disabled>
                            Export
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div id="comparison-summary-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${createComparisonSkeletonCards()}
            </div>
            
            <!-- Charts Container -->
            <div id="comparison-charts-container" class="space-y-6">
                ${createComparisonSkeletonCharts()}
            </div>
            
            <!-- Ranking Table -->
            <div id="comparison-ranking-container" class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">อันดับสาขาตามยอดขายรวม</h3>
                <div class="skeleton h-40 rounded"></div>
            </div>
        </div>
    `;
    
    // Auto-select first branch for office users
    if (isOffice) {
        const firstCheckbox = document.querySelector('.comparison-branch-checkbox');
        if (firstCheckbox) {
            firstCheckbox.checked = true;
        }
    }
    
    // Auto-load data
    setTimeout(loadComparisonData, 500);
}

// Chart instances storage
let comparisonCharts = {
    drink: null,
    freshBakery: null,
    dryBakery: null,
    revenue: null
};

function createComparisonSkeletonCards() {
    const cards = ['เครื่องดื่ม', 'เบเกอรี่สด', 'เบเกอรี่แห้ง', 'ยอดขายรวม'];
    return cards.map(title => `
        <div class="bg-white rounded-lg shadow p-4">
            <div class="skeleton h-4 w-24 mb-2 rounded"></div>
            <div class="skeleton h-8 w-32 mb-2 rounded"></div>
            <div class="skeleton h-3 w-28 rounded"></div>
        </div>
    `).join('');
}

function createComparisonSkeletonCharts() {
    const charts = ['เครื่องดื่ม', 'เบเกอรี่สด', 'เบเกอรี่แห้ง', 'ยอดขายรวม'];
    return charts.map(title => `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="skeleton h-6 w-48 mb-4 rounded"></div>
            <div class="skeleton h-64 w-full rounded"></div>
        </div>
    `).join('');
}

function setComparisonDateRange(range) {
    const startDate = document.getElementById('comparison-start-date');
    const endDate = document.getElementById('comparison-end-date');
    const today = new Date();
    
    // Reset preset buttons
    document.querySelectorAll('.comparison-preset-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    if (range === 7) {
        const start = new Date(today);
        start.setDate(today.getDate() - 6);
        startDate.value = start.toISOString().split('T')[0];
        endDate.value = today.toISOString().split('T')[0];
        event.target.classList.remove('bg-gray-200', 'text-gray-700');
        event.target.classList.add('bg-blue-600', 'text-white');
    } else if (range === 'thisWeek') {
        const start = new Date(today);
        start.setDate(today.getDate() - today.getDay());
        startDate.value = start.toISOString().split('T')[0];
        endDate.value = today.toISOString().split('T')[0];
        event.target.classList.remove('bg-gray-200', 'text-gray-700');
        event.target.classList.add('bg-blue-600', 'text-white');
    } else if (range === 'thisMonth') {
        const start = new Date(today.getFullYear(), today.getMonth(), 1);
        startDate.value = start.toISOString().split('T')[0];
        endDate.value = today.toISOString().split('T')[0];
        event.target.classList.remove('bg-gray-200', 'text-gray-700');
        event.target.classList.add('bg-blue-600', 'text-white');
    }
}

function loadComparisonData() {
    // Get selected branches
    const selectedBranches = [];
    document.querySelectorAll('.comparison-branch-checkbox:checked').forEach(cb => {
        selectedBranches.push(cb.value);
    });
    
    if (selectedBranches.length === 0) {
        showCustomAlert('กรุณาเลือกสาขา', 'เลือกอย่างน้อย 1 สาขาเพื่อแสดงข้อมูล', 'error');
        return;
    }
    
    const startDate = document.getElementById('comparison-start-date').value;
    const endDate = document.getElementById('comparison-end-date').value;
    
    if (!startDate || !endDate) {
        showCustomAlert('กรุณาเลือกวันที่', 'เลือกช่วงวันที่ที่ต้องการดูข้อมูล', 'error');
        return;
    }
    
    showLoading();
    
    // Show skeletons
    document.getElementById('comparison-summary-cards').innerHTML = createComparisonSkeletonCards();
    document.getElementById('comparison-charts-container').innerHTML = createComparisonSkeletonCharts();
    
    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            
            if (result.status === 'success') {
                renderComparisonDashboard(result.data);
                document.getElementById('comparison-export-btn').disabled = false;
            } else {
                showCustomAlert('ข้อผิดพลาด', result.message, 'error');
            }
            
            hideLoading();
        })
        .withFailureHandler(error => {
            handleError(error);
            hideLoading();
        })
        .getComparisonData(selectedBranches, startDate, endDate);
}

function renderComparisonDashboard(data) {
    // Render summary cards
    renderComparisonSummaryCards(data);
    
    // Render charts
    renderComparisonCharts(data);
    
    // Render ranking table
    renderComparisonRankingTable(data);
}

function renderComparisonSummaryCards(data) {
    const container = document.getElementById('comparison-summary-cards');
    const totals = calculateComparisonTotals(data.summary);
    const growthTotals = calculateAverageGrowth(data.growthRates);
    
    container.innerHTML = `
        <!-- เครื่องดื่ม -->
        <div class="bg-blue-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">เครื่องดื่ม</h3>
                <span class="text-2xl">☕</span>
            </div>
            <p class="text-2xl font-bold text-blue-600">${totals.drinkUnits.toLocaleString()} แก้ว</p>
            <p class="text-sm ${growthTotals.drinkUnits >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${growthTotals.drinkUnits >= 0 ? '↑' : '↓'} ${Math.abs(growthTotals.drinkUnits)}% จากช่วงก่อนหน้า
            </p>
        </div>
        
        <!-- เบเกอรี่สด -->
        <div class="bg-green-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">เบเกอรี่สด</h3>
                <span class="text-2xl">🥐</span>
            </div>
            <p class="text-2xl font-bold text-green-600">${totals.freshBakeryUnits.toLocaleString()} ชิ้น</p>
            <p class="text-sm ${growthTotals.freshBakeryUnits >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${growthTotals.freshBakeryUnits >= 0 ? '↑' : '↓'} ${Math.abs(growthTotals.freshBakeryUnits)}% จากช่วงก่อนหน้า
            </p>
        </div>
        
        <!-- เบเกอรี่แห้ง -->
        <div class="bg-yellow-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">เบเกอรี่แห้ง</h3>
                <span class="text-2xl">🍪</span>
            </div>
            <p class="text-2xl font-bold text-yellow-600">${totals.dryBakeryUnits.toLocaleString()} ชิ้น</p>
            <p class="text-sm ${growthTotals.dryBakeryUnits >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${growthTotals.dryBakeryUnits >= 0 ? '↑' : '↓'} ${Math.abs(growthTotals.dryBakeryUnits)}% จากช่วงก่อนหน้า
            </p>
        </div>
        
        <!-- ยอดขายรวม -->
        <div class="bg-purple-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">ยอดขายรวม</h3>
                <span class="text-2xl">💰</span>
            </div>
            <p class="text-2xl font-bold text-purple-600">${totals.totalRevenue.toLocaleString()} บาท</p>
            <p class="text-sm ${growthTotals.totalRevenue >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${growthTotals.totalRevenue >= 0 ? '↑' : '↓'} ${Math.abs(growthTotals.totalRevenue)}% จากช่วงก่อนหน้า
            </p>
        </div>
    `;
}

function calculateComparisonTotals(summary) {
    const totals = {
        drinkUnits: 0,
        freshBakeryUnits: 0,
        dryBakeryUnits: 0,
        totalRevenue: 0
    };
    
    Object.values(summary).forEach(branch => {
        totals.drinkUnits += branch.drinkUnits;
        totals.freshBakeryUnits += branch.freshBakeryUnits;
        totals.dryBakeryUnits += branch.dryBakeryUnits;
        totals.totalRevenue += branch.totalRevenue;
    });
    
    return totals;
}

function calculateAverageGrowth(growthRates) {
    const branches = Object.keys(growthRates);
    if (branches.length === 0) return { drinkUnits: 0, freshBakeryUnits: 0, dryBakeryUnits: 0, totalRevenue: 0 };
    
    const totals = {
        drinkUnits: 0,
        freshBakeryUnits: 0,
        dryBakeryUnits: 0,
        totalRevenue: 0
    };
    
    branches.forEach(branchId => {
        totals.drinkUnits += growthRates[branchId].drinkUnits;
        totals.freshBakeryUnits += growthRates[branchId].freshBakeryUnits;
        totals.dryBakeryUnits += growthRates[branchId].dryBakeryUnits;
        totals.totalRevenue += growthRates[branchId].totalRevenue;
    });
    
    return {
        drinkUnits: Math.round(totals.drinkUnits / branches.length * 10) / 10,
        freshBakeryUnits: Math.round(totals.freshBakeryUnits / branches.length * 10) / 10,
        dryBakeryUnits: Math.round(totals.dryBakeryUnits / branches.length * 10) / 10,
        totalRevenue: Math.round(totals.totalRevenue / branches.length * 10) / 10
    };
}

function renderComparisonCharts(data) {
    const container = document.getElementById('comparison-charts-container');
    
    container.innerHTML = `
        <!-- ยอดขายเครื่องดื่ม -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ยอดขายเครื่องดื่ม (แก้ว)</h3>
                <div id="drink-toggle-buttons" class="flex gap-2 flex-wrap"></div>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="comparison-drink-chart"></canvas>
            </div>
        </div>
        
        <!-- ยอดขายเบเกอรี่สด -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ยอดขายเบเกอรี่สด (ชิ้น)</h3>
                <div id="fresh-bakery-toggle-buttons" class="flex gap-2 flex-wrap"></div>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="comparison-fresh-bakery-chart"></canvas>
            </div>
        </div>
        
        <!-- ยอดขายเบเกอรี่แห้ง -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ยอดขายเบเกอรี่แห้ง (ชิ้น)</h3>
                <div id="dry-bakery-toggle-buttons" class="flex gap-2 flex-wrap"></div>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="comparison-dry-bakery-chart"></canvas>
            </div>
        </div>
        
        <!-- ยอดขายรวม -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ยอดขายรวม (บาท)</h3>
                <div id="revenue-toggle-buttons" class="flex gap-2 flex-wrap"></div>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="comparison-revenue-chart"></canvas>
            </div>
        </div>
    `;
    
    // Wait for DOM
    setTimeout(() => {
        createComparisonLineCharts(data);
    }, 100);
}

function createComparisonLineCharts(data) {
    const { branchColors, branches, dateRange } = data;
    
    // Prepare datasets
    const datasets = {
        drink: [],
        freshBakery: [],
        dryBakery: [],
        revenue: []
    };
    
    // Create datasets for each branch
    Object.keys(data.data).forEach(branchId => {
        const branchName = branches[branchId] || `สาขา ${branchId}`;
        const color = branchColors[branchId] || '#999';
        
        const branchData = data.data[branchId];
        
        // Prepare data for each date
        const drinkData = [];
        const freshBakeryData = [];
        const dryBakeryData = [];
        const revenueData = [];
        
        dateRange.forEach(date => {
            const dayData = branchData[date] || { drinkUnits: 0, freshBakeryUnits: 0, dryBakeryUnits: 0, totalRevenue: 0 };
            drinkData.push(dayData.drinkUnits);
            freshBakeryData.push(dayData.freshBakeryUnits);
            dryBakeryData.push(dayData.dryBakeryUnits);
            revenueData.push(dayData.totalRevenue);
        });
        
        // Add to datasets
        datasets.drink.push({
            label: branchName,
            data: drinkData,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.1,
            branchId: branchId
        });
        
        datasets.freshBakery.push({
            label: branchName,
            data: freshBakeryData,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.1,
            branchId: branchId
        });
        
        datasets.dryBakery.push({
            label: branchName,
            data: dryBakeryData,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.1,
            branchId: branchId
        });
        
        datasets.revenue.push({
            label: branchName,
            data: revenueData,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.1,
            branchId: branchId
        });
    });
    
    // Format labels
    const labels = dateRange.map(date => {
        const d = new Date(date);
        return d.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' });
    });
    
    // Create charts
    comparisonCharts.drink = createComparisonChart('comparison-drink-chart', labels, datasets.drink);
    comparisonCharts.freshBakery = createComparisonChart('comparison-fresh-bakery-chart', labels, datasets.freshBakery);
    comparisonCharts.dryBakery = createComparisonChart('comparison-dry-bakery-chart', labels, datasets.dryBakery);
    comparisonCharts.revenue = createComparisonChart('comparison-revenue-chart', labels, datasets.revenue, true);
    
    // Create toggle buttons
    createToggleButtons('drink-toggle-buttons', datasets.drink, 'drink');
    createToggleButtons('fresh-bakery-toggle-buttons', datasets.freshBakery, 'freshBakery');
    createToggleButtons('dry-bakery-toggle-buttons', datasets.dryBakery, 'dryBakery');
    createToggleButtons('revenue-toggle-buttons', datasets.revenue, 'revenue');
}

function createComparisonChart(canvasId, labels, datasets, isCurrency = false) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            
                            if (isCurrency) {
                                label += context.parsed.y.toLocaleString() + ' บาท';
                            } else {
                                label += context.parsed.y.toLocaleString();
                            }
                            
                            return label;
                        }
                    }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function createToggleButtons(containerId, datasets, chartType) {
    const container = document.getElementById(containerId);
    
    datasets.forEach((dataset, index) => {
        const button = document.createElement('button');
        button.className = 'px-3 py-1 rounded text-xs transition-colors';
        button.style.backgroundColor = dataset.borderColor;
        button.style.color = 'white';
        button.textContent = dataset.label;
        button.dataset.branchId = dataset.branchId;
        button.dataset.datasetIndex = index;
        
        button.onclick = () => toggleDataset(chartType, index, button);
        
        container.appendChild(button);
    });
}

function toggleDataset(chartType, datasetIndex, button) {
    const chart = comparisonCharts[chartType];
    const dataset = chart.data.datasets[datasetIndex];
    
    dataset.hidden = !dataset.hidden;
    
    if (dataset.hidden) {
        button.style.opacity = '0.5';
    } else {
        button.style.opacity = '1';
    }
    
    chart.update();
}

function renderComparisonRankingTable(data) {
    const container = document.getElementById('comparison-ranking-container');
    
    // Calculate rankings
    const rankings = [];
    
    Object.entries(data.summary).forEach(([branchId, summary]) => {
        rankings.push({
            branchId: branchId,
            branchName: data.branches[branchId] || `สาขา ${branchId}`,
            color: data.branchColors[branchId] || '#999',
            totalRevenue: summary.totalRevenue,
            growthRate: data.growthRates[branchId]?.totalRevenue || 0
        });
    });
    
    // Sort by revenue
    rankings.sort((a, b) => b.totalRevenue - a.totalRevenue);
    
    let tableHtml = `
        <h3 class="text-lg font-semibold mb-4">อันดับสาขาตามยอดขายรวม</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-2">อันดับ</th>
                        <th class="text-left py-2">สาขา</th>
                        <th class="text-right py-2">ยอดขายรวม</th>
                        <th class="text-right py-2">% เติบโต</th>
                        <th class="text-center py-2">แนวโน้ม</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    rankings.forEach((branch, index) => {
        const growthIcon = branch.growthRate > 0 ? '📈' : branch.growthRate < 0 ? '📉' : '➡️';
        const growthClass = branch.growthRate > 0 ? 'text-green-600' : branch.growthRate < 0 ? 'text-red-600' : 'text-gray-600';
        
        tableHtml += `
            <tr class="border-b">
                <td class="py-2">${index + 1}</td>
                <td class="py-2">
                    <span class="inline-block w-3 h-3 rounded-full mr-2" 
                          style="background-color: ${branch.color}"></span>
                    ${branch.branchName}
                </td>
                <td class="text-right py-2">${branch.totalRevenue.toLocaleString()} บาท</td>
                <td class="text-right py-2 ${growthClass}">
                    ${branch.growthRate > 0 ? '+' : ''}${branch.growthRate}%
                </td>
                <td class="text-center py-2">${growthIcon}</td>
            </tr>
        `;
    });
    
    tableHtml += '</tbody></table></div>';
    
    container.innerHTML = tableHtml;
}

function updateComparisonCharts() {
    // This function is called when branch checkboxes change
    // For now, we'll require clicking the "แสดงข้อมูล" button
    // In future, could implement live updates
}

function exportComparisonData() {
    showCustomAlert('Coming Soon', 'ฟีเจอร์ Export กำลังพัฒนา จะพร้อมใช้งานเร็วๆ นี้', 'info');
}

// ==================== TARGET MONITORING DASHBOARD ====================

function showTargetMonitoring() {
    document.getElementById('header-title').innerText = 'ติดตามเป้าหมายเบเกอรี่';
    const appContainer = document.getElementById('app-container');
    
    appContainer.innerHTML = `
        <div class="max-w-7xl mx-auto space-y-6">
            <button onclick="showDashboard()" class="text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button>
            
            <!-- Header Info -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">สถานะการบรรลุเป้าหมายเบเกอรี่</h2>
                        <p class="text-sm text-gray-600 mt-1">
                            ข้อมูล ณ วันที่ ${new Date().toLocaleDateString('th-TH', { 
                                day: 'numeric', 
                                month: 'long', 
                                year: 'numeric' 
                            })}
                        </p>
                    </div>


                    <button onclick="loadTargetMonitoringData()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        🔄 รีเฟรช
                    </button>
                </div>
                
                <!-- Legend -->
                <div class="mt-4 flex gap-4 text-sm">
                    <span class="flex items-center">
                        <span class="w-4 h-4 bg-green-100 border border-green-300 rounded mr-2"></span>
                        บรรลุเป้า (≥100%)
                    </span>
                    <span class="flex items-center">
                        <span class="w-4 h-4 bg-yellow-100 border border-yellow-300 rounded mr-2"></span>
                        ใกล้เป้า (90-99%)
                    </span>
                    <span class="flex items-center">
                        <span class="w-4 h-4 bg-red-100 border border-red-300 rounded mr-2"></span>
                        ต่ำกว่าเป้า (<90%)
                    </span>
                </div>

<div>
                        <h2 class="text-xl font-bold text-gray-800">สถานะการบรรลุเป้าหมายเบเกอรี่</h2>
                        <p class="text-sm text-gray-600 mt-1">
                            ข้อมูล ณ วันที่ ${new Date().toLocaleDateString('th-TH', { 
                                day: 'numeric', 
                                month: 'long', 
                                year: 'numeric' 
                            })}
                        </p>
                    </div>



            </div>
            
            <!-- Table Container -->
            <div id="target-monitoring-table" class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-8 text-center text-gray-500">
                    <div class="spinner mx-auto mb-4"></div>
                    กำลังโหลดข้อมูล...
                </div>
            </div>
            
            <!-- Summary Stats -->
            <div id="monitoring-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </div>
    `;
    
    // โหลดข้อมูลทันที
    loadTargetMonitoringData();
}

function loadTargetMonitoringData() {
    showLoading();
    
    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            hideLoading();
            
            if (result.status === 'success') {
                renderTargetMonitoringTable(result.data);
                renderMonitoringSummary(result.data);
            } else {
                showCustomAlert('ข้อผิดพลาด', result.message, 'error');
            }
        })
        .withFailureHandler(error => {
            hideLoading();
            handleError(error);
        })
        .getTargetMonitoringData();
}

function renderTargetMonitoringTable(data) {
    const container = document.getElementById('target-monitoring-table');
    
    if (data.length === 0) {
        container.innerHTML = `
            <div class="p-8 text-center text-gray-500">
                ไม่มีข้อมูลสาขาที่ต้องติดตาม
            </div>`;
        return;
    }
    
    let tableHtml = `
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        สาขา
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
    จำนวนขายเดือนนี้<br>
    <span class="text-xs font-normal">(ชิ้น/เดือน)</span>
</th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
    จำนวนขายเฉลี่ยเดือนนี้<br>
    <span class="text-xs font-normal">(ชิ้น/วัน)</span>
</th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        เป้าหมายรายวัน
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        สถานะ
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        เป้าหมายวันนี้<br>
                        <span class="text-xs font-normal">(เพื่อให้ค่าเฉลี่ยกลับมาตามเป้าหมาย)</span>
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">`;
    
    data.forEach(branch => {
        // กำหนดสีตามสถานะ
        const rowClass = branch.status === 'achieved' ? 'bg-green-50' : 
                        branch.status === 'near' ? 'bg-yellow-50' : 'bg-red-50';
        
        const statusIcon = branch.status === 'achieved' ? '🟢' : 
                          branch.status === 'near' ? '🟡' : '🔴';
        
        // แสดงเป้าพรุ่งนี้เฉพาะเมื่อยังไม่บรรลุและยังมีวันเหลือ
        const showTomorrow = branch.achievementPercent < 100 && 
                            branch.daysElapsed < branch.totalDays;
        const tomorrowDisplay = showTomorrow ? branch.tomorrowTarget : '-';
        
        // เพิ่ม warning ถ้าเป้าสูงเกินไป
        const isHighTarget = branch.tomorrowTarget > branch.targetDaily * 1.5;
        const tomorrowClass = isHighTarget ? 'text-red-600 font-bold' : '';
        
        tableHtml += `
            <tr class="${rowClass} hover:opacity-90 transition-opacity">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${branch.branchName}</div>
                </td>



                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm font-bold">${branch.monthTotal.toLocaleString()}</div>
                </td>

                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm">${Math.round(branch.currentAverage)}</div>
                </td>



                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm font-medium">${Math.round(branch.targetDaily)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="flex items-center justify-center">
                        <span class="mr-2">${statusIcon}</span>
                        <span class="text-sm font-medium">${branch.achievementPercent.toFixed(1)}%</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm ${tomorrowClass}">${tomorrowDisplay}</div>
                    ${isHighTarget && showTomorrow ? '<div class="text-xs text-red-500">⚠️ สูง</div>' : ''}
                </td>
            </tr>`;
    });
    
    tableHtml += `
            </tbody>
        </table>`;
    
    container.innerHTML = tableHtml;
}

function renderMonitoringSummary(data) {
    const container = document.getElementById('monitoring-summary');
    
    // คำนวณสถิติ
    const stats = {
        achieved: data.filter(b => b.status === 'achieved').length,
        near: data.filter(b => b.status === 'near').length,
        below: data.filter(b => b.status === 'below').length,
        avgAchievement: data.reduce((sum, b) => sum + b.achievementPercent, 0) / data.length
    };
    
    container.innerHTML = `
        <!-- บรรลุเป้า -->
        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-green-800">บรรลุเป้า</p>
                    <p class="text-2xl font-bold text-green-600">${stats.achieved} สาขา</p>
                </div>
                <span class="text-3xl">✅</span>
            </div>
        </div>
        
        <!-- ใกล้เป้า -->
        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-yellow-800">ใกล้เป้า</p>
                    <p class="text-2xl font-bold text-yellow-600">${stats.near} สาขา</p>
                </div>
                <span class="text-3xl">⚡</span>
            </div>
        </div>
        
        <!-- ต้องปรับปรุง -->
        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-red-800">ต้องปรับปรุง</p>
                    <p class="text-2xl font-bold text-red-600">${stats.below} สาขา</p>
                </div>
                <span class="text-3xl">🚨</span>
            </div>
        </div>`;
}
// เพิ่มฟังก์ชัน helper สำหรับจัดเรียงตาราง
function sortTargetTable(column) {
    // จะ implement ถ้าต้องการในอนาคต
    console.log('Sort by:', column);
}


function calculateAddOnAmount(price) {
    const qtyInput = document.getElementById(`addon-${price}-qty`);
    const amountInput = document.getElementById(`addon-${price}`);
    
    let qty = parseInt(qtyInput.value) || 0;
    
    // Validate ไม่ให้ติดลบ
    if (qty < 0) {
        qty = 0;
        qtyInput.value = 0;
    }
    
    const amount = qty * price;
    amountInput.value = amount > 0 ? amount.toFixed(2) : '';
    
    calculateAddOnTotals();
    calculateCashAmount();
}

function calculateAddOnTotals() {
    const addon5 = parseFloat(document.getElementById('addon-5')?.value) || 0;
    const addon10 = parseFloat(document.getElementById('addon-10')?.value) || 0;
    const addon15 = parseFloat(document.getElementById('addon-15')?.value) || 0;
    const total = addon5 + addon10 + addon15;
    
    const container = document.getElementById('addon-totals');
    if (container) {
        container.innerHTML = `
            <div class="mt-4 p-3 border-t-2 border-dashed text-right font-bold">
                <span>ยอดรวมสั่งเพิ่ม: <span class="text-cyan-700">${total.toFixed(2)}</span> บาท</span>
            </div>`;
    }
    return total;
}


function calculateVerificationAddOnAmount(price) {
    const qtyInput = document.getElementById(`verify-addon-${price}-qty`);
    const amountInput = document.getElementById(`verify-addon-${price}`);
    
    let qty = parseInt(qtyInput.value) || 0;
    
    // Validate ไม่ให้ติดลบ
    if (qty < 0) {
        qty = 0;
        qtyInput.value = 0;
    }
    
    const amount = qty * price;
    amountInput.value = amount > 0 ? amount.toFixed(2) : '';
    
    calculateVerificationAddOnTotals();
    calculateVerificationCashAmount();
}

// ==================== ADDITIONAL WITHDRAWALS FUNCTIONS ====================

function toggleWithdrawalDetails(withdrawalId) {
  const details = document.getElementById(withdrawalId);
  const icon = document.getElementById(`icon-${withdrawalId}`);
  
  if (details.classList.contains('hidden')) {
    details.classList.remove('hidden');
    icon.textContent = '📂';
    
    // Scroll the main table container to the right
    setTimeout(() => {
      // Find the parent container that has the table
      const tableContainer = details.closest('.overflow-x-auto');
      if (tableContainer) {
        tableContainer.scrollLeft = tableContainer.scrollWidth;
      } else {
        // Alternative: find the parent table's container
        const parentTable = details.closest('table');
        if (parentTable && parentTable.parentElement) {
          parentTable.parentElement.scrollLeft = parentTable.parentElement.scrollWidth;
        }
      }
    }, 100);
    
  } else {
    details.classList.add('hidden');
    icon.textContent = '📋';
  }
}

function openWithdrawalModal(branchId, dateOfSale) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4';
  modal.id = 'withdrawal-modal';
  
  const expenseTypes = [
    'ค่าธรรมเนียมฝากเงิน',
    'ค่าธรรมเนียมฝากเงินแลกทอน', 
    'ค่าน้ำมัน พนง.',
    'เปย์เงินขาย',
    'ค่าโซดา',
    'ค่าขยะ',
    'ค่ามะนาว',
    'โอนเข้าบริษัท'
  ];
  
  const today = new Date().toISOString().split('T')[0];
  
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-y-auto">
      <div class="p-6">
        <h3 class="text-xl font-bold mb-4">เพิ่มรายการเบิกเพิ่มเติม</h3>
        <p class="text-sm text-gray-600 mb-4">วันที่ขาย: ${new Date(dateOfSale).toLocaleDateString('th-TH')}</p>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">วันที่เบิก</label>
          <input type="date" id="withdrawal-date" value="${today}" 
            class="w-full px-3 py-2 border rounded-lg">
        </div>
        
        <div id="withdrawal-items" class="space-y-3 mb-4">
          <!-- Items will be added here -->
        </div>
        
        <button onclick="addWithdrawalItem()" 
          class="mb-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
          + เพิ่มรายการ
        </button>
        
        <div class="border-t pt-4">
          <div class="flex justify-between items-center mb-4">
            <span class="font-medium">ยอดรวม:</span>
            <span id="withdrawal-total" class="text-xl font-bold text-blue-600">0บาท</span>
          </div>
          
          <div class="flex justify-end space-x-3">
            <button onclick="closeWithdrawalModal()" 
              class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
              ยกเลิก
            </button>
            <button onclick="saveWithdrawal('${branchId}', '${dateOfSale}')" 
              class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
              บันทึก
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Add first item
  addWithdrawalItem();
  
  // Store expense types globally for datalist
}

let withdrawalItemCount = 0;

function addWithdrawalItem() {
  const container = document.getElementById('withdrawal-items');
  const itemId = `withdrawal-item-${++withdrawalItemCount}`;
  
  const itemDiv = document.createElement('div');
  itemDiv.id = itemId;
  itemDiv.className = 'flex gap-2 p-3 bg-gray-50 rounded';
  
  // ใช้ array โดยตรงแทนการอ้างอิง window.expenseTypesList
  const expenseTypes = [
    'ค่าธรรมเนียมฝากเงิน',
    'ค่าธรรมเนียมฝากเงินแลกทอน', 
    'ค่าน้ำมัน พนง.',
    'เปย์เงินขาย',
    'ค่าโซดา',
    'ค่าขยะ',
    'ค่ามะนาว',
    'โอนเข้าบริษัท'
  ];
  
  const datalistOptions = expenseTypes.map(type => 
    `<option value="${type}">`
  ).join('');
  
  itemDiv.innerHTML = `
    <div class="flex-1">
      <input type="text" 
        list="expense-types-${itemId}"
        placeholder="เลือกหรือพิมพ์ประเภท"
        class="withdrawal-expense-type w-full px-3 py-2 border rounded"
        onchange="calculateWithdrawalTotal()">
      <datalist id="expense-types-${itemId}">${datalistOptions}</datalist>
    </div>
    <div class="w-32">
      <input type="number" 
        placeholder="จำนวนเงิน"
        class="withdrawal-amount w-full px-3 py-2 border rounded text-right"
        onchange="calculateWithdrawalTotal()">
    </div>
    <button onclick="removeWithdrawalItem('${itemId}')"
      class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600">
      ×
    </button>
  `;
  
  container.appendChild(itemDiv);
}

function removeWithdrawalItem(itemId) {
  document.getElementById(itemId).remove();
  calculateWithdrawalTotal();
}

function calculateWithdrawalTotal() {
  let total = 0;
  document.querySelectorAll('.withdrawal-amount').forEach(input => {
    total += parseFloat(input.value) || 0;
  });
  document.getElementById('withdrawal-total').textContent = `${total.toLocaleString()}บาท`;
}

function closeWithdrawalModal() {
  document.getElementById('withdrawal-modal')?.remove();
}

function saveWithdrawal(branchId, dateOfSale) {
  const withdrawalDate = document.getElementById('withdrawal-date').value;
  const items = [];
  
  const expenseTypes = document.querySelectorAll('.withdrawal-expense-type');
  const amounts = document.querySelectorAll('.withdrawal-amount');
  
  expenseTypes.forEach((typeInput, index) => {
    const amount = parseFloat(amounts[index].value) || 0;
    if (typeInput.value && amount > 0) {
      items.push({
        expenseType: typeInput.value,
        amount: amount
      });
    }
  });
  
  if (items.length === 0) {
    showCustomAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาเพิ่มรายการอย่างน้อย 1 รายการ', 'error');
    return;
  }
  
  const data = {
    branchId: branchId,
    dateOfSale: dateOfSale,
    withdrawalDate: withdrawalDate,
    items: items
  };
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();
      
      if (result.status === 'success') {
        closeWithdrawalModal();
        showCustomAlert('สำเร็จ', result.message, 'success');
        // Reload table
        handleSummarySearch();
      } else {
        showCustomAlert('ข้อผิดพลาด', result.message, 'error');
      }
    })
    .withFailureHandler(error => {
      hideLoading();
      handleError(error);
    })
    .saveAdditionalWithdrawals(JSON.stringify(data));
}

// เพิ่มฟังก์ชันลบรายการเคลม
function removeClaimItem(productId) {
  showCustomConfirm('ยืนยันการลบ', `คุณต้องการลบสินค้า ${productId} ออกจากรายการใช่หรือไม่?`, () => {
    // ลบจาก claimItems array
    claimItems = claimItems.filter(item => item.productId !== productId);
    
    // ลบแถวจาก DOM
    const row = document.getElementById(`claim-row-${productId}`);
    if (row) {
      const table = row.closest('table');
      const tbody = row.closest('tbody');
      
      row.remove();
      
      // ตรวจสอบว่าถ้า supplier นี้ไม่มีสินค้าเหลือแล้ว ให้ลบ table ทั้งหมด
      if (tbody.children.length === 0) {
        const supplierDiv = table.closest('div[data-supplier-table]');
        if (supplierDiv) {
          supplierDiv.remove();
        }
      }
    }
    
    showCustomAlert('สำเร็จ', `ลบสินค้า ${productId} เรียบร้อยแล้ว`, 'success');
  });
}

function renderNewClaimTable(responseString) {
  const result = JSON.parse(responseString);
  if (result.status === 'error') {
    handleError({ message: result.message });
    hideLoading();
    return;
  }

  const container = document.getElementById('order-claim-table-container');
  const data = result.data;

  if (data.length === 0) {
    container.innerHTML = '<p class="text-center text-gray-500">ไม่พบรายการสินค้าที่ต้องจัดการ</p>';
    hideLoading();
    return;
  }

  // แยกข้อมูลตามประเภท
  const unclaimedItems = data.filter(item => item.itemType === 'unclaimed');
  const partialReceivedItems = data.filter(item => item.itemType === 'partial_received');

  let tableHtml = `<div class="space-y-8">`;

  // ส่วนแรก: รายการยังไม่เคลม
  if (unclaimedItems.length > 0) {
    tableHtml += `
      <div class="bg-white rounded-lg shadow-md">
        <div class="bg-red-50 px-4 py-3 border-b">
          <h3 class="text-lg font-semibold text-red-800">🔴 สินค้าหมดอายุรอเคลม (${unclaimedItems.length} รายการ)</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left font-semibold" w-[10%]>วันที่รายงาน</th>
                <th class="px-4 py-2 text-left font-semibold" w-[10%]>รหัสสินค้า</th>
                <th class="px-4 py-2 text-left font-semibold" w-[20%]>ชื่อสินค้า</th>
                <th class="px-4 py-2 text-center font-semibold" w-[35%]>หมดอายุ(รอเคลม)</th>
                <th class="px-4 py-2 text-center font-semibold" w-[35%]>จำนวนเคลม</th>
              </tr>
            </thead>
            <tbody class="divide-y">`;

    unclaimedItems.forEach(item => {
      const reportDate = new Date(item.reportDate).toLocaleDateString('th-TH');
      
      tableHtml += `
        <tr id="claim-row-${item.reportItemId}">
          <td class="px-4 py-2">${reportDate}</td>
          <td class="px-4 py-2 font-mono">${item.productId}</td>
          <td class="px-4 py-2">${item.productName}</td>
          <td class="px-4 py-2 text-center font-bold text-red-600">${item.expiredQuantity}</td>
          <td class="px-4 py-2 text-center">
            <div class="flex items-center gap-2 justify-center">
            
              <input type="number" class="claim-quantity-input w-20 rounded-md border-gray-300 text-center"
                placeholder="0" min="0" max="${item.expiredQuantity}">

              <button class="claim-save-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs"
                onclick="saveNewClaim('${item.reportItemId}', ${item.expiredQuantity})">บันทึก</button>

            </div>
          </td>
          <td class="px-4 py-2 text-center">
          </td>
          <td class="px-4 py-2 text-center">
          </td>
        </tr>`;
    });

    tableHtml += '</tbody></table></div></div>';
  }

  // ส่วนที่สอง: รายการเคลมแล้วแต่ของเข้าไม่ครบ
  if (partialReceivedItems.length > 0) {
    tableHtml += `
      <div class="bg-white rounded-lg shadow-md">
        <div class="bg-amber-50 px-4 py-3 border-b">
          <h3 class="text-lg font-semibold text-amber-800">🟡 รายการเคลมแล้วแต่ของเข้าไม่ครบ (${partialReceivedItems.length} รายการ)</h3>
          <p class="text-sm text-amber-600 mt-1">รายการที่เคลมไปแล้วแต่ยังรอของเข้าเพิ่มเติม</p>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left font-semibold w-[10%]">วันที่รายงาน</th>
                <th class="px-4 py-2 text-left font-semibold w-[10%]">รหัสสินค้า</th>
                <th class="px-4 py-2 text-left font-semibold w-[20%]">ชื่อสินค้า</th>
                <th class="px-4 py-2 text-center font-semibold w-[10%]">เคลมไป</th>
                <th class="px-4 py-2 text-center font-semibold w-[10%]">ของเข้าแล้ว</th>
                <th class="px-4 py-2 text-center font-semibold bg-yellow-100" w-[10%]>ยังรออีก</th>
                <th class="px-4 py-2 text-center font-semibold" w-[10%]>วันที่ของเข้าล่าสุด</th>
                <th class="px-4 py-2 text-center font-semibold" w-[10%]>เพิ่มของเข้า</th>
                <th class="px-4 py-2 text-center font-semibold" w-[10%]>วันที่ของเข้า</th>
              </tr>
            </thead>
            <tbody class="divide-y">`;

    partialReceivedItems.forEach(item => {
      const reportDate = new Date(item.reportDate).toLocaleDateString('th-TH');
      const lastReceivedDate = item.receivedDate ? new Date(item.receivedDate).toLocaleDateString('th-TH') : '-';
      
      tableHtml += `
        <tr id="partial-claim-row-${item.reportItemId}" class="bg-yellow-50">
          <td class="px-4 py-2">${reportDate}</td>
          <td class="px-4 py-2 font-mono">${item.productId}</td>
          <td class="px-4 py-2">${item.productName}</td>
          <td class="px-4 py-2 text-center font-bold text-blue-600">${item.claimedQuantity}</td>
          <td class="px-4 py-2 text-center text-green-600">${item.receivedQuantity}</td>
          <td class="px-4 py-2 text-center font-bold text-red-600 bg-yellow-100">${item.remainingClaim}</td>
          <td class="px-4 py-2 text-center text-gray-600">${lastReceivedDate}</td>
          <td class="px-4 py-2 text-center">
            <div class="flex items-center gap-2 justify-center">
              <input type="number" class="additional-received-input w-20 rounded-md border-gray-300 text-center"
                placeholder="0" min="0" max="${item.remainingClaim}">
              <button class="additional-receipt-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs"
                onclick="saveAdditionalReceipt('${item.reportItemId}', ${item.remainingClaim})">บันทึก</button>
            </div>
          </td>
          <td class="px-4 py-2 text-center">
            <input type="date" class="additional-received-date w-32 rounded-md border-gray-300 text-sm">
          </td>
        </tr>`;
    });

    tableHtml += '</tbody></table></div></div>';
  }

  // ส่วนสรุป
  tableHtml += `
    <div class="bg-blue-50 p-4 rounded-lg">
      <h4 class="font-semibold text-blue-800 mb-2">📊 สรุปสถานะ</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div class="flex justify-between">
          <span>🔴 รอเคลม:</span>
          <span class="font-bold text-red-600">${unclaimedItems.length} รายการ</span>
        </div>
        <div class="flex justify-between">
          <span>🟡 รอของเข้าเพิ่ม:</span>
          <span class="font-bold text-amber-600">${partialReceivedItems.length} รายการ</span>
        </div>
      </div>
    </div>
  </div>`;

  container.innerHTML = tableHtml;
  hideLoading();
}

function saveNewClaim(reportItemId, expiredQuantity) {
  const row = document.getElementById(`claim-row-${reportItemId}`);
  const quantityInput = row.querySelector('.claim-quantity-input');
  const quantity = parseInt(quantityInput.value) || 0;

  if (quantity <= 0 || quantity > expiredQuantity) {
    showCustomAlert('ข้อมูลไม่ถูกต้อง', `จำนวนเคลมต้องอยู่ระหว่าง 1-${expiredQuantity}`, 'error');
    return;
  }

  const branchId = document.getElementById('order-claim-branch').value;
  const productId = row.cells[1].textContent;

  const claimData = {
    reportItemId: reportItemId,
    branchId: branchId,
    productId: productId,
    reportedExpiredQuantity: expiredQuantity,
    claimableQuantity: quantity
  };

  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();

      if (result.status === 'success') {
        // ล็อค claim inputs
        quantityInput.disabled = true;
        row.querySelector('.claim-save-btn').disabled = true;
        row.querySelector('.claim-save-btn').textContent = 'บันทึกแล้ว';
        

        //handleOrderClaimSearch();
        //showCustomAlert('สำเร็จ', result.message, 'success');

        handleOrderClaimSearch()
        .then(() => {
          showCustomAlert('สำเร็จ', result.message, 'success');
        })
        .catch(err => {
          console.error('Error in handleOrderClaimSearch:', err);
        });


        //setTimeout(() => {
        //  handleOrderClaimSearch();
        //}, 1500);



      } else {
        showCustomAlert('ข้อผิดพลาด', result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .saveClaimItem(JSON.stringify(claimData));
}




function saveAdditionalReceipt(reportItemId, maxQuantity) {
  const row = document.getElementById(`partial-claim-row-${reportItemId}`);
  const quantityInput = row.querySelector('.additional-received-input');
  const dateInput = row.querySelector('.additional-received-date');
  const saveBtn = row.querySelector('.additional-receipt-btn');

  const additionalQty = parseInt(quantityInput.value) || 0;
  const receivedDate = dateInput.value;

  if (additionalQty <= 0) {
    showCustomAlert('ข้อมูลไม่ถูกต้อง', 'กรุณาใส่จำนวนของที่รับเข้าเพิ่มเติม', 'error');
    return;
  }

  if (additionalQty > maxQuantity) {
    showCustomAlert('ข้อมูลไม่ถูกต้อง', `จำนวนของเข้าเพิ่มเติมไม่สามารถเกิน ${maxQuantity} ชิ้น`, 'error');
    return;
  }

  if (!receivedDate) {
    showCustomAlert('ข้อมูลไม่ถูกต้อง', 'กรุณาเลือกวันที่รับของ', 'error');
    return;
  }

  const additionalReceiptData = {
    reportItemId: reportItemId,
    additionalQuantity: additionalQty,
    receivedDate: receivedDate
  };

  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();

      if (result.status === 'success') {
        // ล็อค inputs
        quantityInput.disabled = true;
        quantityInput.classList.add('bg-gray-100');
        dateInput.disabled = true;
        dateInput.classList.add('bg-gray-100');
        saveBtn.disabled = true;
        saveBtn.textContent = 'บันทึกแล้ว';
        saveBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

        // อัพเดทตัวเลขในแถว
        const receivedCell = row.cells[4]; // ของเข้าแล้ว
        const remainingCell = row.cells[5]; // ยังรออีก
        
        const currentReceived = parseInt(receivedCell.textContent);
        const newReceived = currentReceived + additionalQty;
        const newRemaining = parseInt(remainingCell.textContent) - additionalQty;

        receivedCell.textContent = newReceived;
        receivedCell.className = 'px-4 py-2 text-center text-green-600 font-bold';
        
        if (newRemaining <= 0) {
          remainingCell.textContent = '0';
          remainingCell.className = 'px-4 py-2 text-center font-bold text-green-600 bg-green-100';
          row.classList.remove('bg-yellow-50');
          row.classList.add('bg-green-50');
        } else {
          remainingCell.textContent = newRemaining;
        }

        handleOrderClaimSearch()
        .then(() => {
          showCustomAlert('สำเร็จ', result.message, 'success');
        })
        .catch(err => {
          console.error('Error in handleOrderClaimSearch:', err);
        });

        //showCustomAlert('สำเร็จ', result.message, 'success');
        
        // รีเฟรชข้อมูลใหม่หลังจาก 2 วินาที
        //setTimeout(() => {
        //  handleOrderClaimSearch();
        //}, 2000);

      } else {
        showCustomAlert('ข้อผิดพลาด', result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .saveAdditionalClaimReceipt(JSON.stringify(additionalReceiptData));
}


// ==================== RAW MATERIAL ORDERING SCRIPT ====================

let rawMaterialOrderData = { orderId: null, items: {} };

function showRawMaterialOrderForm() {
    document.getElementById('header-title').innerText = 'สร้างใบสั่งซื้อวัตถุดิบ';
    const appContainer = document.getElementById('app-container');
    appContainer.innerHTML = `<div class="text-center p-8"><div class="spinner mx-auto"></div><p>กำลังโหลดข้อมูลสินค้า...</p></div>`;
    
    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            if (result.status === 'success') {
                renderRawMaterialForm(result.data);
            } else {
                handleError({ message: result.message });
            }
        })
        .withFailureHandler(handleError)
        .getRawMaterialProducts();
}

function renderRawMaterialForm(groupedProducts) {
    const appContainer = document.getElementById('app-container');
    let formHtml = `
        <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">


<button onclick="showDashboard()" class="text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button>
<div id="auto-save-status" class="h-4"></div>

<div class="mt-4 border rounded-lg overflow-hidden">
  <div class="p-4 bg-gray-50 border-b sticky top-0">

     <input type="text" id="raw-material-search" onkeyup="searchRawMaterial()" placeholder="🔍 ค้นหารหัสหรือชื่อสินค้า..." class="w-full px-4 py-2 border rounded-lg shadow-sm">

            </div>

              <div id="product-list-container" class="space-y-6 p-4 overflow-y-auto" style="max-height: 60vh;">`;
            
    const sortedGroups = Object.keys(groupedProducts).sort();

    sortedGroups.forEach(groupName => {
        formHtml += `
            <div class="border rounded-lg product-type-group">

                <h3 class="text-lg font-bold bg-gray-100 p-3 rounded-t-lg">${groupName}</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
<th class="p-2 text-left w-[15%]">รหัสสินค้า</th>
<th class="p-2 text-left w-[25%]">ชื่อสินค้า</th>

                                <th class="p-2 text-center" colspan="2">คงเหลือปัจจุบัน</th>
                                <th class="p-2 text-center" colspan="2">จำนวนสั่ง</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">`;
        
        groupedProducts[groupName].forEach(p => {
            formHtml += `
                <tr data-product-id="${p.id}" data-product-name="${p.name.toLowerCase()}" data-product-id-search="${String(p.id).toLowerCase()}">

<td class="p-2 font-mono text-sm text-gray-700">${p.id}</td>
<td class="p-2 font-medium">${p.name}</td>
                    <td class="p-1">
                        <div class="flex items-center">
                            <input type="number" class="w-full rounded-md border-gray-300 text-center p-1" placeholder="0" data-field="currentStock_Main">
                            <span class="ml-2 text-xs text-gray-600">${p.unitMain}</span>
                        </div>
                    </td>
                    <td class="p-1">
                        <div class="flex items-center">
                             <input type="number" class="w-full rounded-md border-gray-300 text-center p-1" placeholder="0" data-field="currentStock_Sub">
                            <span class="ml-2 text-xs text-gray-600">${p.unitSub}</span>
                        </div>
                    </td>

                    <td class="p-1">
                        <div class="flex items-center">
                            <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-blue-50" placeholder="0" data-field="requestedQuantity_Main">
                             <span class="ml-2 text-xs text-gray-600">${p.unitMain}</span>
                        </div>
                    </td>
                     <td class="p-1">
                        <div class="flex items-center">
                            <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-blue-50" placeholder="0" data-field="requestedQuantity_Sub">
                             <span class="ml-2 text-xs text-gray-600">${p.unitSub}</span>
                        </div>
                    </td>
                </tr>`;
        });

        formHtml += `</tbody></table></div></div>`;
    });

    formHtml += `
            </div>
            <div class="flex justify-end items-center space-x-4 pt-4 border-t">
                <button onclick="submitRMO()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700">ส่งใบสั่งซื้อ</button>
            </div>
        </div>`;
    
    appContainer.innerHTML = formHtml;

}


function gatherRMOFormData() {
    const items = [];
    document.querySelectorAll('tr[data-product-id]').forEach(row => {
        const itemData = { productId: row.dataset.productId };
        let hasValue = false;
        row.querySelectorAll('input[type="number"]').forEach(input => {
            itemData[input.dataset.field] = input.value;
            if (input.value) hasValue = true;
        });
        if (hasValue) {
            items.push(itemData);
        }
    });
    return {
        orderId: rawMaterialOrderData.orderId,
        items: items
    };
}

function saveRawMaterialDraft(isAuto = true) {
    const statusDiv = document.getElementById('auto-save-status');
    if (isAuto) {

    } else {
        showLoading();
    }
    
    const dataToSave = gatherRMOFormData();

    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            if (result.status === 'success') {
                rawMaterialOrderData.orderId = result.orderId;
                if (isAuto) {
                    const time = new Date().toLocaleTimeString('th-TH');
                    statusDiv.innerText = `บันทึกร่างล่าสุดเมื่อ ${time}`;
                } else {
                    hideLoading();
                    showCustomAlert('สำเร็จ', 'บันทึกฉบับร่างเรียบร้อยแล้ว', 'success');
                }
            } else {
                 if (!isAuto) hideLoading();
                handleError({ message: result.message });
            }
        })
        .withFailureHandler(error => {
            if (!isAuto) hideLoading();
            handleError(error);
        })
        .saveRawMaterialOrderDraft(JSON.stringify(dataToSave));
}

function submitRMO() {
    showCustomConfirm('ยืนยันการส่ง', 'คุณต้องการส่งใบสั่งซื้อนี้ใช่หรือไม่?', () => {
        showLoading();
        const dataToSave = gatherRMOFormData();

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                const result = JSON.parse(response);
                if (result.status === 'success') {
                    showCustomAlert('สำเร็จ', result.message, 'success', showDashboard);
                } else {
                    handleError({ message: result.message });
                }
            })
            .withFailureHandler(handleError)
            .submitFinalRawMaterialOrder(JSON.stringify(dataToSave)); // <-- เรียกใช้ฟังก์ชันใหม่
    });
}

// --- Office Functions ---
function showPendingOrdersList() {
    document.getElementById('header-title').innerText = 'รายการรออนุมัติ';
    const appContainer = document.getElementById('app-container');
    appContainer.innerHTML = `<div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-4">
        <button onclick="showDashboard()" class="text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าแดชบอร์ด</button>
        <h3 class="text-xl font-bold">ใบสั่งซื้อวัตถุดิบที่รออนุมัติ</h3>
        <div id="pending-orders-container"><p>กำลังโหลด...</p></div>
    </div>`;

    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            const container = document.getElementById('pending-orders-container');
            if (result.status === 'success') {
                if (result.data.length === 0) {
                    container.innerHTML = '<p>ไม่มีรายการที่ต้องอนุมัติในขณะนี้</p>';
                    return;
                }
                let tableHtml = '<table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-4 py-3 bg-gray-50 text-left">วันที่ส่ง</th><th class="px-4 py-3 bg-gray-50 text-left">สาขา</th><th class="px-4 py-3 bg-gray-50 text-left">OrderID</th><th></th></tr></thead><tbody>';
                result.data.forEach(order => {
                    tableHtml += `<tr>
                        <td class="px-4 py-2">${order.requestedAt}</td>
                        <td class="px-4 py-2">${order.branchName}</td>
                        <td class="px-4 py-2 font-mono text-xs">${order.orderId}</td>
                        <td class="px-4 py-2 text-right"><button onclick="showRawMaterialApprovalView('${order.orderId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">ตรวจสอบ</button></td>
                    </tr>`;
                });
                tableHtml += '</tbody></table>';
                container.innerHTML = tableHtml;
            } else {
                container.innerHTML = `<p class="text-red-500">${result.message}</p>`;
            }
        })
        .withFailureHandler(handleError)
        .getPendingRawMaterialOrders();
}

function showRawMaterialApprovalView(orderId) {
    document.getElementById('header-title').innerText = 'ตรวจสอบใบสั่งซื้อ';
    const appContainer = document.getElementById('app-container');
    appContainer.innerHTML = `<div class="text-center p-8"><div class="spinner mx-auto"></div><p>กำลังโหลดข้อมูลใบสั่งซื้อและประวัติ...</p></div>`;

    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            if (result.status === 'success') {
                renderApprovalForm(result.data);
            } else {
                handleError({ message: result.message });
            }
        })
        .withFailureHandler(handleError)
        .getRawMaterialOrderWithHistory(orderId);
}

function renderApprovalForm(data) {
    const { current, history } = data;
    const appContainer = document.getElementById('app-container');
    
    let historyHeaders = '';
    history.forEach((h, index) => {
        historyHeaders += `<th colspan="2" class="p-2 text-center bg-gray-100">ครั้งที่ ${index+1} (${h.requestedAt})</th>`;
    });

    let tableHtml = `
      <div class="max-w-screen-xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">
        <button onclick="showPendingOrdersList()" class="text-sm text-blue-600 hover:underline">&larr; กลับไปรายการรออนุมัติ</button>
        <h3 class="text-xl font-bold">ตรวจสอบใบสั่งซื้อ: ${current.orderId}</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm border">


<thead class="bg-gray-50">
  <tr>

    <th rowspan="2" class="p-2 text-left">รหัสสินค้า</th>
    <th rowspan="2" class="p-2 text-left">ชื่อสินค้า</th>
    ${historyHeaders}
        <th colspan="2" class="p-2 text-center bg-blue-100">ใบปัจจุบัน</th>
  </tr>
  <tr>
    <th class="p-2 text-center bg-blue-50">คงเหลือ</th>
    <th class="p-2 text-center bg-blue-50">จำนวนสั่ง/อนุมัติ</th>
    ${history.map(h => `<th class="p-2 text-center bg-gray-50">คงเหลือ</th><th class="p-2 text-center bg-gray-50">จำนวนอนุมัติ</th>`).join('')}
  </tr>
</thead>

            
            <tbody class="divide-y">`;

    current.items.forEach(item => {
    let historyCells = '';
    history.forEach(h => {
        const historyItem = h.items[item.productId];
        if (historyItem) {
            historyCells += `
                <td class="p-2 text-center">${historyItem.currentStock_Main || 0} ${item.unitMain} ${historyItem.currentStock_Sub || 0} ${item.unitSub}</td>
                <td class="p-2 text-center">${historyItem.approvedQuantity_Main || 0} ${item.unitMain} ${historyItem.approvedQuantity_Sub || 0} ${item.unitSub}</td>`;
        } else {
            historyCells += '<td class="p-2 text-center">-</td><td class="p-2 text-center">-</td>';
        }
    });
    
    tableHtml += `
    <tr data-product-id="${item.productId}">
        <td class="p-2 font-mono text-sm">${item.productId}</td>
        <td class="p-2 font-medium">${item.productName}</td>
        ${historyCells}
        <td class="p-2 text-center bg-blue-50">${item.currentStock_Main} ${item.unitMain} ${item.currentStock_Sub} ${item.unitSub}</td>
        <td class="p-1 bg-blue-50">
            <div class="flex items-center">
                <input type="number" value="${item.requestedQuantity_Main}" class="w-full p-1 border rounded" data-field="approvedQuantity_Main">
                <span class="ml-2 text-xs">${item.unitMain}</span>
            </div>
            <div class="flex items-center mt-1">
                <input type="number" value="${item.requestedQuantity_Sub}" class="w-full p-1 border rounded" data-field="approvedQuantity_Sub">
                <span class="ml-2 text-xs">${item.unitSub}</span>
            </div>
        </td>
    </tr>`;
});

    tableHtml += `</tbody></table></div>
        <div class="flex justify-between items-center pt-4 border-t">
            <button onclick="rejectRMO('${current.orderId}')" class="px-6 py-2 bg-red-600 text-white font-bold rounded-md hover:bg-red-700">ปฏิเสธใบสั่งซื้อ</button>
            <button onclick="approveRMO('${current.orderId}')" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">อนุมัติใบสั่งซื้อ</button>
        </div>
      </div>`;
      
    appContainer.innerHTML = tableHtml;
}


function approveRMO(orderId) {
    showCustomConfirm('ยืนยันการอนุมัติ', 'คุณต้องการอนุมัติใบสั่งซื้อนี้ใช่หรือไม่?', () => {
        showLoading();
        const updatedItems = [];
        document.querySelectorAll(`tr[data-product-id]`).forEach(row => {
            updatedItems.push({
                productId: row.dataset.productId,
                approvedQuantity_Main: row.querySelector('input[data-field="approvedQuantity_Main"]').value,
                approvedQuantity_Sub: row.querySelector('input[data-field="approvedQuantity_Sub"]').value
            });
        });
        
        const dataToSave = { orderId: orderId, items: updatedItems };

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                const result = JSON.parse(response);
                if (result.status === 'success') {
                    showCustomAlert('สำเร็จ', result.message, 'success', showPendingOrdersList);
                } else {
                    handleError({ message: result.message });
                }
            })
            .withFailureHandler(handleError)
            .approveRawMaterialOrder(JSON.stringify(dataToSave));
    });
}

function rejectRMO(orderId) {
    showCustomConfirm('ยืนยันการปฏิเสธ', 'คุณต้องการปฏิเสธและส่งใบสั่งซื้อนี้กลับไปแก้ไขใช่หรือไม่?', () => {
        showLoading();
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                const result = JSON.parse(response);
                if (result.status === 'success') {
                    showCustomAlert('สำเร็จ', result.message, 'success', showPendingOrdersList);
                } else {
                    handleError({ message: result.message });
                }
            })
            .withFailureHandler(handleError)
            .rejectRawMaterialOrder(orderId);
    });
}

// --- ฟังก์ชันสำหรับ "กรอง" สินค้าในใบสั่งวัตถุดิบ ---
function searchRawMaterial() {
    const searchTerm = document.getElementById('raw-material-search').value.toLowerCase();
    const productGroups = document.querySelectorAll('.product-type-group');

    // 1. วนลูปเพื่อซ่อน/แสดง "แถวสินค้า" แต่ละแถว
    document.querySelectorAll('tr[data-product-id]').forEach(row => {
        const productName = row.dataset.productName;
        const productId = row.dataset.productIdSearch;
        const isMatch = productName.includes(searchTerm) || productId.includes(searchTerm);
        
        // ถ้าตรงเงื่อนไขให้แสดงแถว, ถ้าไม่ตรงให้ซ่อน
        row.style.display = isMatch ? '' : 'none';
    });

    // 2. วนลูปเพื่อซ่อน/แสดง "กลุ่มสินค้า" ทั้งกลุ่ม
    productGroups.forEach(group => {
        // ค้นหาว่าในกลุ่มนี้ มีแถวสินค้าที่ยังแสดงอยู่หรือไม่
        const visibleRows = group.querySelectorAll('tr[data-product-id]:not([style*="display: none"])');
        
        // ถ้าในกลุ่มมีสินค้าที่แสดงอยู่อย่างน้อย 1 แถว ให้แสดงกลุ่มนี้, ถ้าไม่เหลือเลย ให้ซ่อนทั้งกลุ่ม
        group.style.display = visibleRows.length > 0 ? '' : 'none';
    });
}

  </script>
</body>
</html>
