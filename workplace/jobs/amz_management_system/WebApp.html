<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cafe Management System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}
@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
    body {
      font-family: "Sarabun", sans-serif;
      background-color: #f7fafc;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #06b6d4;
      animation: spin 1s ease infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
        0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    .summary-table th,
    .summary-table td {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      text-align: center;
      vertical-align: middle;
    }

    .summary-table th {
      background-color: #f8fafc;
      font-weight: 600;
    }

    .summary-table .header-group {
      background-color: #f1f5f9;
    }

    .summary-table .row-day {
      font-weight: 600;
      background-color: #fefce8;
    }

    .summary-table .row-total {
      font-weight: 700;
      background-color: #eef2ff;
    }

    .summary-table .text-left {
      text-align: left;
    }

    .modal-body::-webkit-scrollbar {
      width: 5px;
    }

    .modal-body::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .modal-body::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 5px;
    }

    .modal-body::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .sticky-col {
      position: -webkit-sticky;
      /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Safari */
      position: sticky;
      z-index: 10;
      /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà Freeze ‡∏•‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô */
    }

    .first-col {
      left: 0;
      min-width: 110px;
      /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å */
    }

    .second-col {
      left: 110px;
      /* ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å) */
      min-width: 60px;
    }

    /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà Freeze ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏á‡∏ó‡∏∞‡∏•‡∏∏‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á */
    .summary-table thead .sticky-col {
      background-color: #f8fafc;
    }

    .summary-table tbody tr:not(.row-total):not(.row-day) .sticky-col {
      background-color: #ffffff;
    }

    .summary-table .row-day .sticky-col {
      background-color: #fefce8;
    }

    .summary-table .row-total .sticky-col {
      background-color: #eef2ff;
    }

    /* --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° --- */


    /* Sticky header ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö */
    .verify-table-sticky thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f8fafc;
    }

    /* Collapsible supplier groups */
    .supplier-group-header {
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }

    .supplier-group-header:hover {
      background-color: #e5e7eb !important;
    }

    .supplier-content {
      transition: max-height 0.3s ease-out;
      overflow: hidden;
    }

    .supplier-content.collapsed {
      max-height: 0 !important;
    }

    .toggle-icon {
      transition: transform 0.2s;
    }

    .toggle-icon.rotated {
      transform: rotate(-90deg);
    }

    /* Summary box ‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà */
    .verification-summary-box {
      position: sticky;
      bottom: 0;
      background: white;
      border-top: 2px solid #e5e7eb;
      z-index: 15;
    }
  </style>

</head>

<body class="text-gray-800">
  <div id="loading-overlay" class="loading-overlay hidden"></div>
  <div id="custom-confirm-modal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center"></div>
  <div id="custom-alert-modal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center"></div>
  <div id="verification-modal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-30 flex items-center justify-center p-4">
  </div>

  <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-20">
    <h1 id="header-title" class="text-2xl font-bold text-gray-700"></h1>
    <div id="user-info" class="text-right"></div>
  </header>

  <main id="app-container" class="w-full p-4 md:p-8"></main>

  <script>
    // --- GLOBAL VARIABLES & INITIALIZATION ---
                    let USER_DETAILS = {}, SUPPLIERS = [], PAYMENT_TYPES = [], DISCOUNT_TYPES = [], BRANCHES = [], ALL_BRANCHES = [], BRANCH_EMPLOYEES = [], itemRowCounter = 0;
                    let reportItems = [];
                    let verificationReportItems = [];
                    let BRANCH_COLORS = {};
                    window.onload = function() {
                        setTimeout(function() {
                            showLoading();
                            google.script.run.withSuccessHandler(initializeApp).withFailureHandler(handleError).getInitialDataForUser();
                        }, 200);
                    };

// === KEYBOARD SHORTCUTS ===
document.addEventListener('keydown', function(e) {
  // Ctrl+S = ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    const submitButton = document.querySelector('button[onclick*="submitForm"], button[onclick*="handleVerifyReport"]');
    if (submitButton && !submitButton.disabled) {
      submitButton.click();
    }
  }
  
  // Tab = ‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á input ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
  if (e.key === 'Tab' && !e.shiftKey) {
    const activeElement = document.activeElement;
    if (activeElement.type === 'number' && activeElement.className.includes('rounded-md')) {
      const currentRow = activeElement.closest('tr');
      if (currentRow) {
        const inputs = currentRow.querySelectorAll('input[type="number"]:not([disabled])');
        const currentIndex = Array.from(inputs).indexOf(activeElement);
        if (currentIndex < inputs.length - 1) {
          e.preventDefault();
          inputs[currentIndex + 1].focus();
          inputs[currentIndex + 1].select();
        }
      }
    }
  }
  
  // Enter = ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏ñ‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
  if (e.key === 'Enter') {
    const activeElement = document.activeElement;
    if (activeElement.type === 'number' && activeElement.className.includes('rounded-md')) {
      e.preventDefault();
      const currentRow = activeElement.closest('tr');
      const nextRow = currentRow?.nextElementSibling;
      if (nextRow && !nextRow.classList.contains('bg-gray-50')) {
        const currentCellIndex = Array.from(currentRow.cells).findIndex(cell => cell.contains(activeElement));
        const nextInput = nextRow.cells[currentCellIndex]?.querySelector('input[type="number"]');
        if (nextInput) {
          nextInput.focus();
          nextInput.select();
        }
      }
    }
  }
  
  // Ctrl+Q = ‡πÄ‡∏õ‡∏¥‡∏î Quick Add Modal
  if ((e.ctrlKey || e.metaKey) && e.key === 'q') {
    e.preventDefault();
    const quickAddButton = document.querySelector('button[onclick*="openQuickAddModal"], button[onclick*="openVerificationQuickAddModal"]');
    if (quickAddButton) {
      quickAddButton.click();
    }
  }
});

// ‡πÄ‡∏û‡∏¥‡πà‡∏° Tooltip ‡πÅ‡∏™‡∏î‡∏á Shortcuts
function addShortcutTooltips() {
  const style = document.createElement('style');
  style.textContent = `
    .shortcut-hint {
      position: absolute;
      background: #374151;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1000;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
    }
    .has-shortcut {
      position: relative;
    }
    .has-shortcut:hover .shortcut-hint {
      opacity: 0.9;
    }
  `;
  document.head.appendChild(style);
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
addShortcutTooltips();
                    function initializeApp(initialData) {
                USER_DETAILS = initialData.userDetails;
                SUPPLIERS = initialData.suppliers.sort((a, b) => a.name.localeCompare(b.name));
                PAYMENT_TYPES = initialData.paymentTypes;
                DISCOUNT_TYPES = initialData.discountTypes;
                BRANCHES = initialData.branches;
                ALL_BRANCHES = initialData.allBranches;
                BRANCH_EMPLOYEES = initialData.branchEmployees;
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: (1) keyed by supplierId (2) keyed by supplierName
                PRODUCTS_BY_SUPPLIER = initialData.productsBySupplier;
                // ‡∏ñ‡πâ‡∏≤ server ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢ ‚Äî fallback ‡πÑ‡∏õ‡∏¢‡∏±‡∏á keyed-by-id ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                ALL_PRODUCTS_GROUPED = initialData.productsBySupplierByName || null;
                BRANCH_COLORS = initialData.branchColors || {};

                document.getElementById('user-info').innerHTML = `<div class="font-semibold">${USER_DETAILS.name || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'}</div><div class="text-sm text-gray-500">${USER_DETAILS.branchName || '‡∏™‡∏≤‡∏Ç‡∏≤'} (${USER_DETAILS.role})</div>`;
                showDashboard();
                hideLoading();
            }
                    // --- UI & NAVIGATION ---
                    function showDashboard() {
                        document.getElementById('header-title').innerText = '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î';
                        const container = document.getElementById('app-container');
                        const isOffice = USER_DETAILS.role === '‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®';
                        const isFront = USER_DETAILS.role === '‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô';
                        let dashboardHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                        if (isFront) { 
                          dashboardHtml += `<div onclick="showDailyReportForm()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-cyan-700">üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2><p class="text-gray-600 mt-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢, ‡∏™‡∏ï‡πá‡∏≠‡∏Å, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏£‡∏≠‡∏ö</p></div>`; 
                        dashboardHtml += `<div onclick="showAnalyticsDashboard()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-purple-700">üìä ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h2><p class="text-gray-600 mt-2">‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</p></div>`;
                            dashboardHtml += `<div onclick="showComparisonDashboard()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-indigo-700">üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h2><p class="text-gray-600 mt-2">‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°</p></div>`;

                            dashboardHtml += `<div onclick="showRawMaterialOrderForm()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-teal-700">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2><p class="text-gray-600 mt-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</p></div>`;


                        }
                        if (isOffice) {
                            dashboardHtml += `<div onclick="showVerifyReportsModule()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-indigo-700">‚úîÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2><p class="text-gray-600 mt-2">‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤</p></div>`;
                            dashboardHtml += `<div onclick="showSalesSummaryModule()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-emerald-700">üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h2><p class="text-gray-600 mt-2">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</p></div>`;
                            dashboardHtml += `<div onclick="showStockOverviewModule()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-blue-700">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2><p class="text-gray-600 mt-2">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤</p></div>`;
                            dashboardHtml += `<div onclick="showOrderClaimModule()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-orange-700">üì¶ ‡∏™‡∏±‡πà‡∏á/‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2><p class="text-gray-600 mt-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</p></div>`;
                            dashboardHtml += `<div onclick="showReconciliationModule()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-teal-700">üí∏ ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2><p class="text-gray-600 mt-2">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏•‡∏∞ QR</p></div>`;
                            dashboardHtml += `<div onclick="showAnalyticsDashboard()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-purple-700">üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h2><p class="text-gray-600 mt-2">‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</p></div>`;
                                dashboardHtml += `<div onclick="showComparisonDashboard()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-indigo-700">üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏≤‡∏Ç‡∏≤</h2><p class="text-gray-600 mt-2">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</p></div>`;

                                    dashboardHtml += `<div onclick="showTargetMonitoring()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-amber-700">üéØ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h2><p class="text-gray-600 mt-2">‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</p></div>`;


                          dashboardHtml += `<div onclick="showPendingOrdersList()" class="menu-card bg-white p-6 rounded-lg shadow-md cursor-pointer"><h2 class="text-xl font-bold text-sky-700">‚úîÔ∏è ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2><p class="text-gray-600 mt-2">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</p></div>`;



                                    
                        }
                        if (!isFront && !isOffice) { dashboardHtml += `<div class="col-span-full bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-md" role="alert"><p class="font-bold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p><p>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: Guest) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏• <span class="font-semibold">${USER_DETAILS.email || ''}</span> ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó 'Employees' ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î Role ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p></div>`; }
                        dashboardHtml += `</div>`;
                        container.innerHTML = dashboardHtml;
                    }
                    function showLoading() { document.getElementById('loading-overlay').innerHTML = `<div class="spinner"></div>`; document.getElementById('loading-overlay').classList.remove('hidden'); }
                    function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
                    function handleError(error) { hideLoading(); showCustomAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error'); console.error(error); }

                    // --- MODALS (ALERT & CONFIRM) ---
                    function showCustomConfirm(title, message, onOk) {
                        const modal = document.getElementById('custom-confirm-modal');
                        modal.innerHTML = `<div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><h3 class="text-lg leading-6 font-bold text-gray-900">${title}</h3><div class="mt-2 px-7 py-3"><p class="text-sm text-gray-600">${message}</p></div><div class="flex justify-center items-center px-4 py-3 space-x-4"><button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="confirm-ok-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-700">‡∏ï‡∏Å‡∏•‡∏á</button></div></div></div>`;
                        modal.classList.remove('hidden');
                        const okBtn = document.getElementById('confirm-ok-btn'); const cancelBtn = document.getElementById('confirm-cancel-btn');
                        const handleOkClick = () => { modal.classList.add('hidden'); onOk(); };
                        const handleCancelClick = () => { modal.classList.add('hidden'); };
                        okBtn.addEventListener('click', handleOkClick, { once: true });
                        cancelBtn.addEventListener('click', handleCancelClick, { once: true });
                    }
                    function showCustomAlert(title, message, type = 'info', onOk = () => {}) {
                        const modal = document.getElementById('custom-alert-modal');
                        let iconHtml = '';
                        if (type === 'success') { iconHtml = `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100"><svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>`; }
                        else if (type === 'error') { iconHtml = `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>`; }
                        else { iconHtml = `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100"><svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>`; }
                        modal.innerHTML = `<div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white"><div class="mt-3 text-center">${iconHtml}<h3 class="text-lg leading-6 font-bold text-gray-900 mt-4">${title}</h3><div class="mt-2 px-7 py-3"><p class="text-sm text-gray-500">${message}</p></div><div class="items-center px-4 py-3"><button id="alert-ok-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700">‡∏ï‡∏Å‡∏•‡∏á</button></div></div></div>`;
                        modal.classList.remove('hidden');
                        const okBtn = document.getElementById('alert-ok-btn');
                        const handleOkClick = () => { modal.classList.add('hidden'); onOk(); };
                        okBtn.addEventListener('click', handleOkClick, { once: true });
                    }

                    // --- DAILY REPORT FORM (FRONT-OF-HOUSE) ---
                    function showDailyReportForm() {
                document.getElementById('header-title').innerText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô';
                const appContainer = document.getElementById('app-container');

                reportItems = [];
    itemRowCounter = 0;




                const today = new Date();
                const dateString = today.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
                let employeeOptions = ''; BRANCH_EMPLOYEES.forEach(emp => { employeeOptions += `<option value="${emp.name}" data-id="${emp.id}"></option>`; });

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö datalist
                const reasonOptions = ['‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥', '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏•‡∏∑‡∏°‡∏Å‡∏îBluePlus'].map(reason => `<option value="${reason}"></option>`).join('');

                appContainer.innerHTML =
                `<div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">
                    <!-- **‡πÄ‡∏û‡∏¥‡πà‡∏° datalist ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ** -->
                    <datalist id="cancellation-reasons">${reasonOptions}</datalist>

                    <button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                    <div class="border-b pb-6 mb-6"><h3 class="text-lg font-semibold text-cyan-600 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label><input type="text" id="report-date" value="${dateString}" class="mt-1 block w-full bg-gray-100 rounded-md border-gray-300" readonly></div><div><label class="block text-sm font-medium text-gray-700">‡∏£‡∏≠‡∏ö</label><select id="time-slot" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="‡πÄ‡∏ä‡πâ‡∏≤">‡πÄ‡∏ä‡πâ‡∏≤</option><option value="‡∏ö‡πà‡∏≤‡∏¢">‡∏ö‡πà‡∏≤‡∏¢</option></select></div></div></div>

                    <div class="border-b pb-6 mb-6">
                <h3 class="text-lg font-semibold text-cyan-600 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</h3>
                <div id="item-rows-container" class="space-y-4"></div>
                <div id="product-totals"></div>
                <button type="button" onclick="openQuickAddModal()" class="mt-4 px-4 py-2 text-sm font-medium rounded-md text-white bg-cyan-600 hover:bg-cyan-700">üìã ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            </div>


// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô Add-on HTML ‡πÄ‡∏î‡∏¥‡∏°
<div class="border-b pb-6 mb-6">
    <h3 class="text-lg font-semibold text-cyan-600 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</h3>
    <div class="space-y-4">
        <div class="p-3 border rounded-lg bg-gray-50">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-800">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏°‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏≠‡πä‡∏ï (5 ‡∏ö‡∏≤‡∏ó)</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-24">
                        <label class="text-xs text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                        <input type="number" id="addon-5-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300" 
                               placeholder="0" min="0" oninput="calculateAddOnAmount(5)">
                    </div>
                    <div class="w-32">
                        <label class="text-xs text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="addon-5" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" 
                               placeholder="0.00" readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-3 border rounded-lg bg-gray-50">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ 10 ‡∏ö‡∏≤‡∏ó</p>
                    <p class="text-xs text-gray-500">(‡∏ä‡πá‡∏≠‡∏ï / ‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á / ‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà‡∏Å‡∏≤‡πÅ‡∏ü)</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-24">
                        <label class="text-xs text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                        <input type="number" id="addon-10-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300" 
                               placeholder="0" min="0" oninput="calculateAddOnAmount(10)">
                    </div>
                    <div class="w-32">
                        <label class="text-xs text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="addon-10" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" 
                               placeholder="0.00" readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-3 border rounded-lg bg-gray-50">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ 15 ‡∏ö‡∏≤‡∏ó</p>
                    <p class="text-xs text-gray-500">(‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á / ‡∏ñ‡∏±‡πà‡∏ß‡πÅ‡∏î‡∏á / ‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏ß‡∏ó‡πå‡∏ä‡πá‡∏≠‡∏Ñ / ‡∏ã‡∏≠‡∏™‡∏Ñ‡∏≤‡∏£‡∏≤‡πÄ‡∏°‡∏•)</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-24">
                        <label class="text-xs text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                        <input type="number" id="addon-15-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300" 
                               placeholder="0" min="0" oninput="calculateAddOnAmount(15)">
                    </div>
                    <div class="w-32">
                        <label class="text-xs text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="addon-15" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" 
                               placeholder="0.00" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="addon-totals"></div>
</div>


                    <div class="border-b pb-6 mb-6"><h3 class="text-lg font-semibold text-cyan-600 mb-4">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</h3><div id="drink-category-container" class="space-y-3"></div><div id="drink-category-totals" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div></div>
                    <div class="border-b pb-6 mb-6"><h3 class="text-lg font-semibold text-cyan-600 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô)</h3><div id="payment-summary-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div><div id="payment-summary-total" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div></div>
                    <div class="border-b pb-6 mb-6"><h3 class="text-lg font-semibold text-cyan-600 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3><div id="discount-summary-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div><div id="discount-summary-total" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div></div>
                    <div class="border-b pb-6 mb-6"><h3 class="text-lg font-semibold text-cyan-600 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</h3><div id="cancellation-rows-container" class="space-y-4"></div><button type="button" onclick="addCancellationRow()" class="mt-4 px-4 py-2 text-sm font-medium rounded-md text-white bg-cyan-600 hover:bg-cyan-700">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</button></div>
                    <div class="border-b pb-6 mb-6 space-y-4"><div><label for="note" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="note" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea></div><div><label for="reporter-name" class="block text-sm font-medium text-gray-700">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô <span class="text-red-500">*</span></label><input type="text" id="reporter-name" list="employee-list" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..."><datalist id="employee-list">${employeeOptions}</datalist></div></div>
                    <div class="flex justify-between items-center">
  <div class="text-sm text-gray-500">
    <span class="font-medium">‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î:</span> 
    Ctrl+S = ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å | Tab = ‡∏ä‡πà‡∏≠‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ | Enter = ‡πÅ‡∏ñ‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ | Ctrl+Q = ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  </div>
  <button type="button" onclick="submitForm()" class="py-3 px-6 text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
</div>
                </div>`;
                populateDrinkCategories();
                populateSummaries('payment', PAYMENT_TYPES, 'payment-summary-container');
                populateSummaries('discount', DISCOUNT_TYPES, 'discount-summary-container');
                updateTotals('drink');
                updateTotals('payment');
                updateTotals('discount');
            }

            // --- QUICK ADD MODAL & DYNAMIC FORM RENDERING ---

            let ALL_PRODUCTS_GROUPED = null; // Cache for product list

            function openQuickAddModal() {
                const modalId = 'quick-add-modal';
                if (document.getElementById(modalId)) return;

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-xl font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h3>
                        <button onclick="document.getElementById('${modalId}').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div>
                        <div class="p-4 border-b bg-gray-50"><input type="text" id="product-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." onkeyup="filterQuickAddList()" class="w-full px-4 py-2 border rounded-lg"></div>
                        <div class="p-4 overflow-y-auto flex-1" id="product-list-container"><p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</p></div>
                        <div class="p-4 border-t flex justify-between items-center bg-gray-50">
                            <span class="text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß <span id="selected-count" class="font-bold">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                            <div class="space-x-2">
                                <button onclick="document.getElementById('${modalId}').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button onclick="addSelectedProducts()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>

                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

if (ALL_PRODUCTS_GROUPED) {
    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å initializeApp ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    renderProductList(ALL_PRODUCTS_GROUPED);
} else {
    // fallback: ‡∏Å‡∏£‡∏ì‡∏µ initialData ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á server
    google.script.run
        .withSuccessHandler(productsBySupplierByName => {
            ALL_PRODUCTS_GROUPED = productsBySupplierByName;
            renderProductList(productsBySupplierByName);
        })
        .withFailureHandler(handleError)
        .getAllProductsGroupedBySupplier();
}

                //reportItems = [];
                setTimeout(() => {
        document.querySelectorAll('.quick-input-sales, .quick-input-received, .quick-input-expired, .quick-input-stock, .quick-input-transfer').forEach(input => {
            input.value = '';
        });
    }, 100);




            }

            function openVerificationQuickAddModal() {
                syncVerificationItemsFromDOM();
                const modalId = 'verification-quick-add-modal';
                if (document.getElementById(modalId)) return;

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 z-50 flex items-center justify-center p-4';

                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[80vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-xl font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h3>
                            <button onclick="document.getElementById('${modalId}').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>
                        <div class="p-4 border-b bg-gray-50">
                            <input type="text" id="verify-product-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
                                   onkeyup="filterVerificationQuickAddList()" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div class="p-4 overflow-y-auto flex-1" id="verification-product-list-container">
                            <p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                        </div>
                        <div class="p-4 border-t flex justify-between items-center bg-gray-50">
                            <span class="text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß <span id="verify-selected-count" class="font-bold">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                            <div class="space-x-2">
                                <button onclick="document.getElementById('${modalId}').remove()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button onclick="addSelectedProductsToVerification()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                renderVerificationProductList();
            }

            function renderProductList(productsBySupplier) {
                const container = document.getElementById('product-list-container');
                const existingProductIds = new Set(reportItems.map(item => item.id));

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á branch options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dropdown
                let branchOptionsHtml = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';
                BRANCHES.forEach(b => {
                    branchOptionsHtml += `<option value="${b.id}">${b.name}</option>`;
                });

                let html = '';
                const sortedSuppliers = Object.keys(productsBySupplier).sort();

                for (const supplierName of sortedSuppliers) {
                    const products = productsBySupplier[supplierName];
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const availableProducts = products.filter(p => !existingProductIds.has(p.id));

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
            if (availableProducts.length === 0) return;

            html += `
                <div class="supplier-section mb-6">
                    <h4 class="font-bold text-gray-700 mb-2 bg-gray-100 p-2 rounded sticky top-0 z-10 flex justify-between items-center">
                        <span>${supplierName}
                            <span class="text-sm font-normal text-gray-500">
                                (${availableProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                            </span>
                        </span>




                                <button onclick="toggleAllSupplierProducts('${supplierName}', this)"
                                        class="text-sm text-blue-600 font-medium hover:underline">
                                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                            </h4>




                            <div class="space-y-2" data-supplier-name="${supplierName}">`;

                    products.sort((a,b) => a.name.localeCompare(b.name)).forEach(product => {
                const isExisting = existingProductIds.has(product.id);

                // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                if (isExisting) return;

                const disabledAttr = '';
                const containerClass = 'hover:bg-gray-50';

                        //const containerClass = isExisting ? 'opacity-50 cursor-not-allowed' : '';

                        html += `
                            <div class="product-item border rounded-lg p-3 hover:bg-gray-50 ${containerClass}"
                                 data-name="${product.name.toLowerCase()}">
                                <div class="flex items-center justify-between">
                                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ã‡πâ‡∏≤‡∏¢: Checkbox ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
                                    <div class="flex items-center flex-1">
                                        <input type="checkbox"
                                               class="product-checkbox h-4 w-4 rounded border-gray-300 text-blue-600"
                                               data-product-id="${product.id}"
                                               data-product-name="${product.name}"
                                               data-supplier-id="${product.supplierId}"
                                               data-supplier-name="${product.supplierName}"
                                               data-product-price="${product.price}"
                                               onchange="updateSelectedCount()"
                                               ${disabledAttr}>
                                        <span class="ml-3 text-sm font-medium">${product.name}</span>
                                    </div>

                                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏ß‡∏≤: Input Fields -->
                                    <div class="flex items-center gap-2 ml-4">
                                        <!-- ‡∏Ç‡∏≤‡∏¢ -->
                                        <div class="flex flex-col items-center">
                                            <label class="text-xs text-gray-500">‡∏Ç‡∏≤‡∏¢</label>
                                            <input type="number"
                                                   class="quick-input-sales w-16 px-1 py-1 text-sm border rounded text-center"
                                                   placeholder="0" min="0" ${disabledAttr}>
                                        </div>

                                        <!-- ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ -->
                                        <div class="flex flex-col items-center">
                                            <label class="text-xs text-gray-500">‡∏£‡∏±‡∏ö</label>
                                            <input type="number"
                                                   class="quick-input-received w-16 px-1 py-1 text-sm border rounded text-center"
                                                   placeholder="0" min="0" ${disabledAttr}>
                                        </div>

                                        <!-- ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ -->
                                        <div class="flex flex-col items-center">
                                            <label class="text-xs text-gray-500">‡∏´‡∏°‡∏î</label>

                                            
                                            <input type="number" class="quick-input-expired w-16 px-1 py-1 text-sm border rounded text-center" placeholder="0" min="0" ${disabledAttr}>



                                        </div>

                                        <!-- ‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á -->
                                        <div class="flex flex-col items-center">
                                            <label class="text-xs text-gray-500">‡∏ô‡∏±‡∏ö</label>
                                            <input type="number"
                                                   class="quick-input-stock w-16 px-1 py-1 text-sm border rounded text-center"
                                                   placeholder="0" min="0" ${disabledAttr}>
                                        </div>

                                        <!-- ‡∏¢‡πâ‡∏≤‡∏¢ -->
                                        <div class="flex flex-col items-center">
                                            <label class="text-xs text-gray-500">‡∏¢‡πâ‡∏≤‡∏¢</label>
                                            <input type="number"
                                                   class="quick-input-transfer w-16 px-1 py-1 text-sm border rounded text-center"
                                                   placeholder="0" min="0"
                                                   oninput="toggleTransferBranch(this)"
                                                   ${disabledAttr}>
                                        </div>

                                        <!-- ‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô) -->
                                        <div class="flex flex-col items-center transfer-branch-container hidden">
                                            <label class="text-xs text-gray-500">‡πÑ‡∏õ‡∏™‡∏≤‡∏Ç‡∏≤</label>
                                            <select class="quick-input-branch w-24 px-1 py-1 text-sm border rounded"
                                                    ${disabledAttr}>
                                                ${branchOptionsHtml}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    });
                    html += '</div></div>';
                }
                container.innerHTML = html;
                updateSelectedCount();
            }

            function filterQuickAddList() {
    const searchTerm = document.getElementById('product-search-input').value.toLowerCase();
    
    // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á products
    document.querySelectorAll('.product-item').forEach(item => {
        const isVisible = item.dataset.name.includes(searchTerm);
        item.style.display = isVisible ? '' : 'none';
    });
    
    // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á supplier sections
    document.querySelectorAll('.supplier-section').forEach(section => {
        const visibleProducts = section.querySelectorAll('.product-item:not([style*="none"])');
        section.style.display = visibleProducts.length > 0 ? '' : 'none';
    });
}

            function updateSelectedCount() {
                const count = document.querySelectorAll('.product-checkbox:checked').length;
                document.getElementById('selected-count').textContent = count;
            }

            function toggleAllSupplierProducts(supplierName, button) {
                const checkboxes = document.querySelectorAll(`div[data-supplier-name="${supplierName}"] .product-checkbox:not(:disabled)`);
                const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !isAllChecked);
                button.textContent = isAllChecked ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                updateSelectedCount();
            }

            function addSelectedProducts() {
    const selectedItems = document.querySelectorAll('.product-checkbox:checked');
    
    if (selectedItems.length === 0) {
        showCustomAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
        return;
    }

    selectedItems.forEach(checkbox => {
        const container = checkbox.closest('.product-item');
        
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å input fields
        const salesQty = container.querySelector('.quick-input-sales')?.value || '';
        const receivedQty = container.querySelector('.quick-input-received')?.value || '';
        const expiredQty = container.querySelector('.quick-input-expired')?.value || '';
        const stockQty = container.querySelector('.quick-input-stock')?.value || '';
        const transferQty = container.querySelector('.quick-input-transfer')?.value || '';
        const toBranch = container.querySelector('.quick-input-branch')?.value || '';

        const alreadyExists = reportItems.some(item => item.id === checkbox.dataset.productId);

        if (!alreadyExists) {
            reportItems.push({
                id: checkbox.dataset.productId,
                name: checkbox.dataset.productName,
                supplierId: checkbox.dataset.supplierId,
                supplierName: checkbox.dataset.supplierName,
                price: checkbox.dataset.productPrice,
                salesQuantity: salesQty,
                receivedQuantity: receivedQty,
                expiredQuantity: expiredQty,
                currentStock: stockQty,
                transferredQuantity: transferQty,
                toBranchId: toBranch
            });
        }
    });

    renderGroupedProductForm();
    calculateProductTotals();
    calculateCashAmount();
    document.getElementById('quick-add-modal').remove();
    
    const addedCount = selectedItems.length;
    if (addedCount > 0) {
        showCustomAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${addedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
    }
}

            function renderGroupedProductForm() {
                const container = document.getElementById('item-rows-container');
                container.innerHTML = '';
                if (reportItems.length === 0) return;

                const itemsBySupplier = reportItems.reduce((acc, item) => {
                    if (!acc[item.supplierName]) acc[item.supplierName] = [];
                    acc[item.supplierName].push(item);
                    return acc;
                }, {});

                let branchOptions = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';
                BRANCHES.forEach(b => { branchOptions += `<option value="${b.id}">${b.name}</option>`; });

                Object.keys(itemsBySupplier).sort().forEach(supplierName => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'supplier-group border rounded-lg mb-4';

                    let itemsHtml = '';
                    itemsBySupplier[supplierName].forEach(item => {
                        itemsHtml += `
                            <tr class="product-entry" data-product-id="${item.id}">
                                <td class="p-2 font-medium align-middle">${item.name}</td>
                                <td class="p-1 align-middle text-center">
                                    <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50"
                                           oninput="updateReportItem('${item.id}', 'salesQuantity', this.value)"
                                           value="${item.salesQuantity}">
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50"
                                           oninput="updateReportItem('${item.id}', 'receivedQuantity', this.value)"
                                           value="${item.receivedQuantity}">
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50"
                                           oninput="updateReportItem('${item.id}', 'expiredQuantity', this.value)"
                                           value="${item.expiredQuantity}">
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50"
                                           oninput="updateReportItem('${item.id}', 'currentStock', this.value)"
                                           value="${item.currentStock}">
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50"
                                           oninput="updateReportItem('${item.id}', 'transferredQuantity', this.value); toggleTransferBranchInGroup(this, '${item.id}')"
                                           value="${item.transferredQuantity}">
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <select class="transfer-select w-full rounded-md border-gray-300 text-sm hidden"
                                            oninput="updateReportItem('${item.id}', 'toBranchId', this.value)">
                                        ${branchOptions}
                                    </select>
                                </td>
                                <td class="p-1 align-middle text-center">
                                    <button type="button" onclick="removeProductFromReport('${item.id}')"
                                            class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
                                </td>
                            </tr>
                        `;
                    });

                    groupDiv.innerHTML = `
                        <h4 class="font-bold text-gray-800 bg-gray-100 p-3 rounded-t-lg">${supplierName}</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm table-fixed">
                                <colgroup>
                                    <col style="width: auto; min-width: 200px;">
                                    <col style="width: 80px;">
                                    <col style="width: 80px;">
                                    <col style="width: 80px;">
                                    <col style="width: 80px;">
                                    <col style="width: 80px;">
                                    <col style="width: 120px;">
                                    <col style="width: 50px;">
                                </colgroup>
                                <thead class="text-xs text-gray-500">
                                    <tr>
                                        <th class="p-2 text-left">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th class="p-2 text-center">‡∏Ç‡∏≤‡∏¢</th>
                                        <th class="p-2 text-center">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</th>
                                        <th class="p-2 text-center">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                        <th class="p-2 text-center">‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</th>
                                        <th class="p-2 text-center">‡∏¢‡πâ‡∏≤‡∏¢</th>
                                        <th class="p-2 text-center">‡πÑ‡∏õ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                        <th class="p-2 text-center"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">${itemsHtml}</tbody>
                            </table>
                        </div>
                    `;
                    container.appendChild(groupDiv);

                    // Set selected branch values
                    itemsBySupplier[supplierName].forEach(item => {
                        if (item.transferredQuantity > 0) {
                            const row = document.querySelector(`.product-entry[data-product-id="${item.id}"]`);
                            const select = row.querySelector('.transfer-select');
                            select.classList.remove('hidden');
                            select.value = item.toBranchId || '';
                        }
                    });
                });


                calculateProductTotals();
calculateCashAmount();

            }



            function updateReportItem(productId, field, value) {
                const item = reportItems.find(i => i.id === productId);
                if (item) {
                    item[field] = value;
                }
                if (field === 'salesQuantity') {
    calculateProductTotals();
    calculateCashAmount();
}
            }

            function removeProductFromReport(productId) {
                reportItems = reportItems.filter(item => item.id !== productId);
                renderGroupedProductForm();
                calculateProductTotals();
    calculateCashAmount();
            }

function removeProductFromVerificationReport(productId) {
    // ‡πÅ‡∏Ñ‡πà‡∏•‡∏ö DOM element ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å
    const row = document.querySelector(`.product-entry-verify[data-product-id="${productId}"]`);
    if (row) {
        // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (row.nextElementSibling?.classList.contains('bg-gray-50')) {
            row.nextElementSibling.remove();
        }
        row.remove();
    }
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó array
    verificationReportItems = verificationReportItems.filter(item => item.id != productId);
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
    calculateVerificationProductTotals();
    calculateVerificationCashAmount();
}


            function toggleTransferBranchInGroup(input, productId) {
                const row = input.closest('.product-entry');
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <select> ‡∏ó‡∏µ‡πà‡∏°‡∏µ class 'transfer-select' ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                const select = row.querySelector('.transfer-select');

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡∏¢‡πâ‡∏≤‡∏¢"
                if (parseFloat(input.value) > 0) {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á dropdown
                    select.classList.remove('hidden');
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô dropdown
                    select.classList.add('hidden');
                    select.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
                    updateReportItem(productId, 'toBranchId', ''); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
                }
            }




            function renderGroupedProductForm() {
                const container = document.getElementById('item-rows-container');
                container.innerHTML = '';
                if (reportItems.length === 0) return;

                const itemsBySupplier = reportItems.reduce((acc, item) => {
                    if (!acc[item.supplierName]) acc[item.supplierName] = [];
                    acc[item.supplierName].push(item);
                    return acc;
                }, {});

                let branchOptions = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';
                BRANCHES.forEach(b => { branchOptions += `<option value="${b.id}">${b.name}</option>`; });

                Object.keys(itemsBySupplier).sort().forEach(supplierName => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'supplier-group border rounded-lg';

                    let itemsHtml = '';
                    itemsBySupplier[supplierName].forEach(item => {
                        // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà <input> ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å <td> ---
                        itemsHtml += `
                            <tr class="product-entry" data-product-id="${item.id}">
                                <td class="p-2 font-medium align-middle">${item.name}</td>
                                <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateReportItem('${item.id}', 'salesQuantity', this.value)" value="${item.salesQuantity}"></td>
                                <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateReportItem('${item.id}', 'receivedQuantity', this.value)" value="${item.receivedQuantity}"></td>
                                <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateReportItem('${item.id}', 'expiredQuantity', this.value)" value="${item.expiredQuantity}"></td>
                                <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateReportItem('${item.id}', 'currentStock', this.value)" value="${item.currentStock}"></td>
                                <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateReportItem('${item.id}', 'transferredQuantity', this.value); toggleTransferBranchInGroup(this, '${item.id}')" value="${item.transferredQuantity}"></td>
                                <td class="p-1 align-middle transfer-cell"><select class="transfer-select w-full rounded-md border-gray-300 text-sm hidden" oninput="updateReportItem('${item.id}', 'toBranchId', this.value)">${branchOptions}</select></td>
                                <td class="p-1 align-middle text-center"><button type="button" onclick="removeProductFromReport('${item.id}')" class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></td>
                            </tr>
                        `;
                    });

                    groupDiv.innerHTML = `
                        <h4 class="font-bold text-gray-800 bg-gray-100 p-3 rounded-t-lg">${supplierName}</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="text-xs text-gray-500">
                                    <tr>
                                        <th class="p-2 text-left w-1/3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th class="p-2 text-center">‡∏Ç‡∏≤‡∏¢</th>
                                        <th class="p-2 text-center">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</th>
                                        <th class="p-2 text-center">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                        <th class="p-2 text-center">‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</th>
                                        <th class="p-2 text-center">‡∏¢‡πâ‡∏≤‡∏¢</th>
                                        <th class="p-2 text-left w-1/4">‡πÑ‡∏õ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                        <th class="p-2 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">${itemsHtml}</tbody>
                            </table>
                        </div>
                    `;
                    container.appendChild(groupDiv);

                    itemsBySupplier[supplierName].forEach(item => {
                        if (item.transferredQuantity > 0) {
                            const row = document.querySelector(`.product-entry[data-product-id="${item.id}"]`);
                            const select = row.querySelector('.transfer-select');
                            select.classList.remove('hidden');
                            select.value = item.toBranchId || '';
                        }
                    });
                });
            }







            function loadProductList() {
                google.script.run
                    .withSuccessHandler(productsBySupplier => {
                        renderProductList(productsBySupplier);
                    })
                    .withFailureHandler(handleError)
                    .getAllProductsGroupedBySupplier();
            }


            function addPrefilledItemRow(productInfo) {
                itemRowCounter++;
                const container = document.getElementById('item-rows-container');
                const rowDiv = document.createElement('div');
                rowDiv.className = 'p-4 border rounded-lg space-y-3';
                rowDiv.id = `item-row-${itemRowCounter}`;

                let supplierOptions = '';
                SUPPLIERS.forEach(s => {
                    const isSelected = s.id == productInfo.supplierId ? 'selected' : '';
                    supplierOptions += `<option value="${s.id}" ${isSelected}>${s.name}</option>`;
                });

                let branchOptions = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</option>';
                BRANCHES.forEach(b => { branchOptions += `<option value="${b.id}">${b.name}</option>`; });

                rowDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 relative">
                        <div><label class="text-xs text-gray-600">‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå</label><select id="supplier-${itemRowCounter}" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" disabled>${supplierOptions}</select></div>
                        <div><label class="text-xs text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><select id="product-${itemRowCounter}" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" disabled><option value="${productInfo.productId}">${productInfo.productName}</option></select></div>
                        <button onclick="this.parentElement.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold">&times;</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                        <div><label class="text-xs text-gray-600">‡∏Ç‡∏≤‡∏¢</label><input type="number" id="sales-${itemRowCounter}" placeholder="0" min="0" class="mt-1 block w-full text-sm rounded-md border-gray-300"></div>
                        <div><label class="text-xs text-gray-600">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</label><input type="number" id="received-${itemRowCounter}" placeholder="0" min="0" class="mt-1 block w-full text-sm rounded-md border-gray-300"></div>
                        <div><label class="text-xs text-gray-600">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="number" id="expired-${itemRowCounter}" placeholder="0" min="0" class="mt-1 block w-full text-sm rounded-md border-gray-300"></div>
                        <div><label class="text-xs text-gray-600">‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</label><input type="number" id="stock-${itemRowCounter}" placeholder="0" min="0" class="mt-1 block w-full text-sm rounded-md border-gray-300"></div>
                        <div><label class="text-xs text-gray-600">‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤</label><input type="number" id="transfer-${itemRowCounter}" placeholder="0" min="0" oninput="toggleBranchDropdown(${itemRowCounter})" class="mt-1 block w-full text-sm rounded-md border-gray-300"></div>
                    </div>
                    <div id="transfer-branch-container-${itemRowCounter}" class="hidden pt-2"><label class="text-xs font-medium text-gray-700">‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏™‡∏≤‡∏Ç‡∏≤</label><select id="transfer-branch-${itemRowCounter}" class="mt-1 block w-full text-sm rounded-md border-gray-300">${branchOptions}</select></div>
                `;
                container.appendChild(rowDiv);
            }



                    function populateDrinkCategories() {
                        const container = document.getElementById('drink-category-container');
                        if (!container) return;
                        const categories = ['‡∏Å‡∏≤‡πÅ‡∏ü', '‡∏ä‡∏≤', '‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï', '‡∏ô‡∏°', '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ', 'NPD'];
                        let html = '';
                        categories.forEach(cat => { html += `<div class="p-3 border rounded-lg grid grid-cols-3 gap-4 items-center bg-gray-50"><label class="font-medium text-gray-800 col-span-1">${cat}</label><div class="col-span-1"><label class="text-xs text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label><input type="number" oninput="updateTotals('drink')" id="drink-sales-${cat}" data-category-name="${cat}" class="drink-category-sales-input mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="0.00" step="0.01" min="0"></div><div class="col-span-1"><label class="text-xs text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÅ‡∏Å‡πâ‡∏ß)</label><input type="number" oninput="updateTotals('drink')" id="drink-cups-${cat}" data-category-name="${cat}" class="drink-category-cups-input mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="0" min="0"></div></div>`; });
                        container.innerHTML = html;
                    }

                    function toggleBranchDropdown(rowId) { const transferInput = document.getElementById(`transfer-${rowId}`); const branchContainer = document.getElementById(`transfer-branch-container-${rowId}`); const transferValue = parseFloat(transferInput.value) || 0; if (transferValue > 0) { branchContainer.classList.remove('hidden'); } else { branchContainer.classList.add('hidden'); document.getElementById(`transfer-branch-${rowId}`).value = ""; } }



                    function populateSummaries(type, data, containerId) {
                        const container = document.getElementById(containerId);
                        if (!container) return;
                        container.innerHTML = '';
                        data.forEach(item => {
    const field = document.createElement('div');
    if (type === 'payment' && item.name === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
        field.innerHTML = `<label class="block text-sm font-medium text-gray-700">${item.name} (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
                          <input type="number" id="${type}-${item.id}" data-type-id="${item.id}" 
                                 class="${type}-summary-input mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" 
                                 placeholder="0.00" readonly>`;
    } else {
        field.innerHTML = `<label class="block text-sm font-medium text-gray-700">${item.name}</label>
                          <input type="number" oninput="updateTotals('${type}')" 
                                 id="${type}-${item.id}" data-type-id="${item.id}" 
                                 class="${type}-summary-input mt-1 block w-full text-sm rounded-md border-gray-300" 
                                 placeholder="0.00" step="0.01" min="0">`;
    }
    container.appendChild(field);
});
                    }
                    function updateTotals(type) {
                        if (type === 'drink') {
                            let totalSales = 0; let totalCups = 0;
                            document.querySelectorAll('.drink-category-sales-input').forEach(input => { totalSales += parseFloat(input.value) || 0; });
                            document.querySelectorAll('.drink-category-cups-input').forEach(input => { totalCups += parseInt(input.value) || 0; });
                            document.getElementById('drink-category-totals').innerHTML = `<span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalSales.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span> | <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalCups}</span> ‡πÅ‡∏Å‡πâ‡∏ß</span>`;
                        } else if (type === 'payment') {
                            let totalAmount = 0;
                            document.querySelectorAll('.payment-summary-input').forEach(input => { totalAmount += parseFloat(input.value) || 0; });
                            document.getElementById('payment-summary-total').innerHTML = `<span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span>`;

                        } else if (type === 'discount') {
                            let totalAmount = 0;
                            document.querySelectorAll('.discount-summary-input').forEach(input => { totalAmount += parseFloat(input.value) || 0; });
                            document.getElementById('discount-summary-total').innerHTML = `<span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span>`;
                        }

                        calculateCashAmount();


                    }


                    function submitForm() { showCustomConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', proceedWithSubmission); }

                   function proceedWithSubmission() {
                showLoading();
                const reporterNameInput = document.getElementById('reporter-name');
                const reporterName = reporterNameInput.value.trim();
                if (!reporterName) {
                    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
                    hideLoading();
                    return;
                }
                const selectedEmployee = BRANCH_EMPLOYEES.find(emp => emp.name === reporterName);
                const reportData = {
                timeSlot: document.getElementById('time-slot').value,
                note: document.getElementById('note').value,
                reporterInfo: { id: selectedEmployee ? selectedEmployee.id : null, name: reporterName },
                items: [], drinkCategories: [], payments: [], discounts: [], cancelledBills: [], addOns: []
            };

                // **(NEW LOGIC)** Collect data from the global reportItems array
                reportData.items = reportItems.filter(item => {
                    // Only include items that have at least one value entered
                    return item.salesQuantity || item.receivedQuantity || item.expiredQuantity || item.currentStock || item.transferredQuantity;
                }).map(item => ({ // Map to the format expected by the backend
                    productId: item.id,
                    salesQuantity: item.salesQuantity || 0,
                    receivedQuantity: item.receivedQuantity || 0,
                    expiredQuantity: item.expiredQuantity || 0,
                    currentStock: item.currentStock || 0,
                    transferredQuantity: item.transferredQuantity || 0,
                    toBranchId: item.toBranchId || null
                }));

                // Validate that all items with a transfer quantity have a destination branch
                for (const item of reportData.items) {
                    if (item.transferredQuantity > 0 && !item.toBranchId) {
                        const product = reportItems.find(p => p.id === item.productId);
                        showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${product.name}'`, 'error');
                        hideLoading();
                        return;
                    }
                }
const cancelledBills = [];
let hasIncompleteCancellation = false;

                // Collect other data (same as before)
                document.querySelectorAll('.cancellation-row').forEach(row => { 
                  const billNumber = row.querySelector('.cancel-bill-number').value; 
                  const reason = row.querySelector('.cancel-reason').value; 
                  const amount = row.querySelector('.cancel-amount').value; 
                  const cancelledBy = row.querySelector('.cancel-by-name').value;


                  if (billNumber || reason || amount) { 

                    
                    
        if (!cancelledBy) {
          hasIncompleteCancellation = true;
            showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
            hideLoading();
            row.querySelector('.cancel-by-name').style.borderColor = 'red';
            return;
        }else {
            cancelledBills.push({
                billNumber,
                reason,
                amount: parseFloat(amount) || 0,
                cancelledBy: cancelledBy,
                file: null
            });
        }

}

                  });

                  if (hasIncompleteCancellation) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
    hideLoading();
    return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
}

reportData.cancelledBills = cancelledBills;


                document.querySelectorAll('.drink-category-sales-input').forEach(input => { const categoryName = input.dataset.categoryName; const salesAmount = input.value || 0; const cupQuantity = document.getElementById(`drink-cups-${categoryName}`).value || 0; reportData.drinkCategories.push({ name: categoryName, salesAmount: salesAmount, cupQuantity: cupQuantity }); });
                document.querySelectorAll('.payment-summary-input').forEach(input => { if (parseFloat(input.value) > 0) reportData.payments.push({ typeId: input.dataset.typeId, amount: input.value }); });
                document.querySelectorAll('.discount-summary-input').forEach(input => { if (parseFloat(input.value) > 0) reportData.discounts.push({ typeId: input.dataset.typeId, amount: input.value }); });

                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Add-on
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Add-on ‡πÄ‡∏î‡∏¥‡∏°
const addon5Qty = document.getElementById('addon-5-qty').value;
const addon5Amount = document.getElementById('addon-5').value;
const addon10Qty = document.getElementById('addon-10-qty').value;
const addon10Amount = document.getElementById('addon-10').value;
const addon15Qty = document.getElementById('addon-15-qty').value;
const addon15Amount = document.getElementById('addon-15').value;

if (addon5Amount) reportData.addOns.push({ 
    type: '5‡∏ö‡∏≤‡∏ó', 
    amount: parseFloat(addon5Amount),
    quantity: parseInt(addon5Qty) || 0,
    unitPrice: 5
});
if (addon10Amount) reportData.addOns.push({ 
    type: '10‡∏ö‡∏≤‡∏ó', 
    amount: parseFloat(addon10Amount),
    quantity: parseInt(addon10Qty) || 0,
    unitPrice: 10
});
if (addon15Amount) reportData.addOns.push({ 
    type: '15‡∏ö‡∏≤‡∏ó', 
    amount: parseFloat(addon15Amount),
    quantity: parseInt(addon15Qty) || 0,
    unitPrice: 15
});



                google.script.run.withSuccessHandler(response => { const result = JSON.parse(response); hideLoading(); if (result.status === 'success') { showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success', showDashboard); } else { showCustomAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error'); } }).withFailureHandler(handleError).submitDailyReport(JSON.stringify(reportData));
            }



                  function addCancellationRow() {
                itemRowCounter++;
                const container = document.getElementById('cancellation-rows-container');
                const rowDiv = document.createElement('div');
                rowDiv.className = 'p-4 border rounded-lg bg-gray-50 relative cancellation-row';
                rowDiv.id = `cancellation-row-${itemRowCounter}`;
    let employeeOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ --</option>';
    BRANCH_EMPLOYEES.forEach(emp => {
        employeeOptions += `<option value="${emp.name}">${emp.name}</option>`;
    });
                rowDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="text-xs font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</label>
                            <input type="text" class="cancel-bill-number mt-1 block w-full text-sm rounded-md border-gray-300">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</label>
                            <!-- **‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** ‡πÄ‡∏û‡∏¥‡πà‡∏° list="cancellation-reasons" -->
                            <input type="text" list="cancellation-reasons" class="cancel-reason mt-1 block w-full text-sm rounded-md border-gray-300">
                        </div>

                        <div>
                            <label class="text-xs font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="cancel-amount mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="0.00">
                        </div>
                    </div>

            <div>
                <label class="text-xs font-medium text-gray-700">‡∏ú‡∏π‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏• <span class="text-red-500">*</span></label>
                <input type="text" list="cancel-employee-list-${itemRowCounter}" class="cancel-by-name mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠">
                <datalist id="cancel-employee-list-${itemRowCounter}">${employeeOptions}</datalist>
            </div> 

                    <button onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold">&times;</button>
                `;
                container.appendChild(rowDiv);
            }



                    // --- VERIFICATION MODULE (OFFICE) ---
                    function showVerifyReportsModule() {
                        document.getElementById('header-title').innerText = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
                        const appContainer = document.getElementById('app-container');
                        appContainer.innerHTML = `<div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg"><button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button><h3 class="text-lg font-semibold text-indigo-600 mb-4">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Pending)</h3><div id="unverified-reports-list"></div></div>`;
                        const listDiv = document.getElementById('unverified-reports-list');
                        listDiv.innerHTML = `<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</p>`;
                        google.script.run.withSuccessHandler(reports => {
                            if (reports.length === 0) { listDiv.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>'; return; }
                            let tableHtml = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th><th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏≠‡∏ö</th><th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th><th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">‡∏™‡∏≤‡∏Ç‡∏≤</th><th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="px-4 py-3 bg-gray-50"></th></tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                            reports.forEach(report => { tableHtml += `<tr><td class="px-4 py-4 text-sm">${report.reportDate}</td><td class="px-4 py-4 text-sm">${report.timeSlot}</td><td class="px-4 py-4 text-sm font-mono">${report.reportId}</td><td class="px-4 py-4 text-sm">${report.branchName}</td><td class="px-4 py-4 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">${report.status}</span></td><td class="px-4 py-4 text-right text-sm"><button onclick="openVerificationPopup('${report.reportId}')" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-md text-xs">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button></td></tr>`; });
                            tableHtml += '</tbody></table></div>';
                            listDiv.innerHTML = tableHtml;
                        }).withFailureHandler(handleError).getUnverifiedReports();
                    }
let lastOpenTime = 0;













function openVerificationPopup(reportId) {
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
    const now = Date.now();
    if (now - lastOpenTime < 1000) {
        console.log('Please wait before opening another popup');
        return;
    }
    lastOpenTime = now;
    
    showLoading();
    
    // Reset ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
    verificationReportItems = [];
    
    google.script.run.withSuccessHandler(responseString => {
        const response = JSON.parse(responseString);
        if (response.status === 'error') { 
            handleError({ message: response.message }); 
            return; 
        }
        const details = response.data;
      
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• items
        verificationReportItems = details.items.map(item => {
            const supplier = SUPPLIERS.find(s => s.id === item.supplierId);
            const product = PRODUCTS_BY_SUPPLIER[item.supplierId]?.find(p => p.id === item.productId);
            return {
                id: item.productId,
                name: product ? product.name.split(' ').slice(1).join(' ') : 'Unknown Product',
                supplierId: item.supplierId,
                supplierName: supplier ? supplier.name : 'Unknown Supplier',
                price: product?.price || 0,
                salesQuantity: item.salesQuantity,
                receivedQuantity: item.receivedQuantity,
                expiredQuantity: item.expiredQuantity,
                currentStock: item.currentStock,
                transferredQuantity: item.transferredQuantity,
                toBranchId: item.toBranchId,
                previousData: item.previousData
            };
        });

        const modal = document.getElementById('verification-modal');
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML components
        let paymentHtml = ''; 
PAYMENT_TYPES.forEach(pt => { 
    const existing = details.payments.find(p => p.typeId == pt.id);
    if (pt.name === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
        paymentHtml += `<div>
            <label class="block text-sm font-medium text-gray-700">${pt.name} (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
            <input type="number" data-type-id="${pt.id}" value="${existing ? existing.amount : ''}" 
                   class="verify-payment-summary-input mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100" 
                   placeholder="0.00" readonly>
        </div>`; 
    } else {
        paymentHtml += `<div>
            <label class="block text-sm font-medium text-gray-700">${pt.name}</label>
            <input type="number" oninput="updateVerificationTotals('payment'); calculateVerificationCashAmount();" 
                   data-type-id="${pt.id}" value="${existing ? existing.amount : ''}" 
                   class="verify-payment-summary-input mt-1 block w-full text-sm rounded-md border-gray-300" 
                   placeholder="0.00">
        </div>`; 
    }
});
        
        let discountHtml = ''; 
        DISCOUNT_TYPES.forEach(dt => { 
            const existing = details.discounts.find(d => d.typeId == dt.id); 
            discountHtml += `<div><label class="block text-sm font-medium text-gray-700">${dt.name}</label><input type="number" oninput="updateVerificationTotals('discount'); calculateVerificationCashAmount();" data-type-id="${dt.id}" value="${existing ? existing.amount : ''}" class="verify-discount-summary-input mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="0.00"></div>`; 
        });
        
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô addOnHtml
let addOnHtml = `
    <div class="p-3 border rounded-lg bg-gray-50">
        <div class="flex justify-between items-center">
            <div>
                <p class="font-medium text-gray-800">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏°‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏≠‡πä‡∏ï (5 ‡∏ö‡∏≤‡∏ó)</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="w-24">
                    <label class="text-xs text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                    <input type="number" id="verify-addon-5-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300"
                           value="${details.addOns?.find(a => a.type === '5‡∏ö‡∏≤‡∏ó')?.quantity || ''}" placeholder="0"
                           oninput="calculateVerificationAddOnAmount(5)">
                </div>
                <div class="w-32">
                    <label class="text-xs text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="verify-addon-5" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100"
                           value="${details.addOns?.find(a => a.type === '5‡∏ö‡∏≤‡∏ó')?.amount || ''}" placeholder="0.00" readonly>
                </div>
            </div>
        </div>
    </div>
    <div class="p-3 border rounded-lg bg-gray-50 mt-3">
        <div class="flex justify-between items-center">
            <div>
                <p class="font-medium text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ 10 ‡∏ö‡∏≤‡∏ó</p>
                <p class="text-xs text-gray-500">(‡∏ä‡πá‡∏≠‡∏ï / ‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á / ‡πÄ‡∏à‡∏•‡∏•‡∏µ‡πà‡∏Å‡∏≤‡πÅ‡∏ü)</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="w-24">
                    <label class="text-xs text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                    <input type="number" id="verify-addon-10-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300"
                           value="${details.addOns?.find(a => a.type === '10‡∏ö‡∏≤‡∏ó')?.quantity || ''}" placeholder="0"
                           oninput="calculateVerificationAddOnAmount(10)">
                </div>
                <div class="w-32">
                    <label class="text-xs text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="verify-addon-10" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100"
                           value="${details.addOns?.find(a => a.type === '10‡∏ö‡∏≤‡∏ó')?.amount || ''}" placeholder="0.00" readonly>
                </div>
            </div>
        </div>
    </div>
    <div class="p-3 border rounded-lg bg-gray-50 mt-3">
        <div class="flex justify-between items-center">
            <div>
                <p class="font-medium text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ 15 ‡∏ö‡∏≤‡∏ó</p>
                <p class="text-xs text-gray-500">(‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á / ‡∏ñ‡∏±‡πà‡∏ß‡πÅ‡∏î‡∏á / ‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏ß‡∏ó‡πå‡∏ä‡πá‡∏≠‡∏Ñ / ‡∏ã‡∏≠‡∏™‡∏Ñ‡∏≤‡∏£‡∏≤‡πÄ‡∏°‡∏•)</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="w-24">
                    <label class="text-xs text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                    <input type="number" id="verify-addon-15-qty" class="mt-1 block w-full text-sm rounded-md border-gray-300"
                           value="${details.addOns?.find(a => a.type === '15‡∏ö‡∏≤‡∏ó')?.quantity || ''}" placeholder="0"
                           oninput="calculateVerificationAddOnAmount(15)">
                </div>
                <div class="w-32">
                    <label class="text-xs text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="verify-addon-15" class="mt-1 block w-full text-sm rounded-md border-gray-300 bg-gray-100"
                           value="${details.addOns?.find(a => a.type === '15‡∏ö‡∏≤‡∏ó')?.amount || ''}" placeholder="0.00" readonly>
                </div>
            </div>
        </div>
    </div>
`;
        
        let drinkCategoryHtml = ''; 
        const categories = ['‡∏Å‡∏≤‡πÅ‡∏ü', '‡∏ä‡∏≤', '‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï', '‡∏ô‡∏°', '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ', 'NPD'];
        categories.forEach(cat => { 
            const existing = details.drinkCategories.find(d => d.categoryName === cat); 
            drinkCategoryHtml += `<div class="p-3 border rounded-lg grid grid-cols-3 gap-4 items-center bg-gray-50">
    <label class="font-medium text-gray-800 col-span-1">${cat}</label>
    <div class="col-span-1">
        <label class="text-xs text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
        <input type="number" oninput="updateVerificationTotals('drink'); calculateVerificationCashAmount();" 
               data-category-name="${cat}" value="${existing ? existing.salesAmount : ''}" 
               class="verify-drink-sales-input mt-1 w-full text-sm rounded-md border-gray-300" placeholder="0.00">
    </div>
    <div class="col-span-1">
        <label class="text-xs text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÅ‡∏Å‡πâ‡∏ß)</label>
        <input type="number" oninput="updateVerificationTotals('drink'); calculateVerificationCashAmount();" 
               data-category-name="${cat}" value="${existing ? existing.cupQuantity : ''}" 
               class="verify-drink-cups-input mt-1 w-full text-sm rounded-md border-gray-300" placeholder="0">
    </div>
</div>`; 
        });
        
        let cancelledBillsHtml = '';
        if (details.cancelledBills) {
            details.cancelledBills.forEach(bill => { 

let verifyEmployeeOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ --</option>';
        BRANCH_EMPLOYEES.forEach(emp => {
            verifyEmployeeOptions += `<option value="${emp.name}">${emp.name}</option>`;
        });

                cancelledBillsHtml += `
                <div class="p-3 border rounded-lg grid grid-cols-1 md:grid-cols-3 gap-4 items-center bg-gray-50 relative verify-cancellation-row">
                
                <div><label class="text-xs">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</label>
                <input type="text" value="${bill.billNumber || ''}" class="verify-cancel-bill-number mt-1 w-full text-sm rounded-md"></div>
                
                <div><label class="text-xs">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label>
                <input type="text" list="cancellation-reasons" value="${bill.reason || ''}" class="verify-cancel-reason mt-1 w-full text-sm rounded-md"></div>
                
                <div><label class="text-xs">‡∏ú‡∏π‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</label>
                <input type="text" list="verify-cancel-employee-list-${bill.billNumber}" value="${bill.cancelledBy || ''}" class="verify-cancel-by-name mt-1 w-full text-sm rounded-md">
                <datalist id="verify-cancel-employee-list-${bill.billNumber}">${verifyEmployeeOptions}</datalist>
                </div>


                <div><label class="text-xs">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                <input type="number" value="${bill.amount || ''}" class="verify-cancel-amount mt-1 w-full text-sm rounded-md"></div>
                
                <button onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button></div>`; 
            });
        }
        
        const reasonOptions = ['‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥', '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏•‡∏∑‡∏°‡∏Å‡∏îBluePlus'].map(reason => `<option value="${reason}"></option>`).join('');
        
        modal.innerHTML = `<div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-full max-h-[90vh] flex flex-col" data-branch-id="${details.branchId}" data-report-date="${details.rawReportDate}">
            <datalist id="cancellation-reasons">${reasonOptions}</datalist>
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô - ${reportId}</h3>
                <button onclick="closeVerificationPopup()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto modal-body space-y-6">
                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label><input type="text" value="${details.reportDate}" class="mt-1 w-full bg-gray-100 rounded-md" readonly></div>
                        <div><label class="block text-sm">‡∏£‡∏≠‡∏ö</label><select id="verify-time-slot" class="mt-1 w-full rounded-md"><option value="‡πÄ‡∏ä‡πâ‡∏≤" ${details.timeSlot === '‡πÄ‡∏ä‡πâ‡∏≤' ? 'selected' : ''}>‡πÄ‡∏ä‡πâ‡∏≤</option><option value="‡∏ö‡πà‡∏≤‡∏¢" ${details.timeSlot === '‡∏ö‡πà‡∏≤‡∏¢' ? 'selected' : ''}>‡∏ö‡πà‡∏≤‡∏¢</option></select></div>
                    </div>
                </div>



<div class="border-b pb-4">
    
    <div class="sticky top-0 bg-white z-20 pb-2 border-b">


    <h4 class="font-semibold text-cyan-600 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
        <div class="flex justify-between items-center">
        
            <div>
                <button type="button" onclick="openVerificationQuickAddModal()" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-cyan-600 hover:bg-cyan-700 mr-2">üìã ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                <button type="button" onclick="toggleAllSuppliers()" class="px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>

            <div id="verify-product-totals" class="p-3 font-bold text-right"></div>
        </div>
    </div>
    <div id="verification-item-rows-container" class="space-y-6 mt-4"></div>
</div>



                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</h4>
                    <div class="space-y-3">${addOnHtml}</div>
                    <div id="verify-addon-totals"></div>
                </div>
                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</h4>
                    <div class="space-y-3">${drinkCategoryHtml}</div>
                    <div id="verify-drink-category-totals" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div>
                </div>
                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${paymentHtml}</div>
                    <div id="verify-payment-summary-total" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div>
                </div>
                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${discountHtml}</div>
                    <div id="verify-discount-summary-total" class="mt-4 p-3 border-t-2 border-dashed text-right font-bold"></div>
                </div>
                <div class="border-b pb-4">
                    <h4 class="font-semibold text-cyan-600 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</h4>
                    <div id="verify-cancellation-rows-container" class="space-y-3">${cancelledBillsHtml}</div>
                    <button type="button" onclick="addCancellationRowForVerification()" class="mt-2 px-3 py-1 text-xs rounded-md text-white bg-cyan-600 hover:bg-cyan-700">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</button>
                </div>
                <div>
                    <h4 class="font-semibold text-cyan-600 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h4>
                    <textarea id="verify-note" class="w-full rounded-md">${details.note || ''}</textarea>
                </div>
            </div>
            <div class="flex justify-between items-center p-4 border-t bg-gray-50">
                <button id="verify-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                <button id="verify-confirm-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
            </div>
        </div>`;
        
        modal.classList.remove('hidden');
        document.getElementById('verify-delete-btn').addEventListener('click', () => handleDeleteReport(reportId));
        document.getElementById('verify-confirm-btn').addEventListener('click', () => handleVerifyReport(reportId));
        renderVerificationGroupedProductForm();
        updateVerificationTotals('drink');
        updateVerificationTotals('payment');
        updateVerificationTotals('discount');
        if (typeof calculateVerificationProductTotals === 'function') {
            calculateVerificationProductTotals();
        }
        if (typeof calculateVerificationAddOnTotals === 'function') {
            calculateVerificationAddOnTotals();
        }
        if (typeof calculateVerificationCashAmount === 'function') {
    calculateVerificationCashAmount();

}


        hideLoading();
    }).withFailureHandler(handleError).getReportDetails(reportId);
}

function toggleAllSuppliers() {
    const allHeaders = document.querySelectorAll('.supplier-group-header');
    const firstContent = allHeaders[0]?.nextElementSibling;
    const shouldExpand = firstContent?.classList.contains('collapsed');
    
    allHeaders.forEach(header => {
        const content = header.nextElementSibling;
        const icon = header.querySelector('.toggle-icon');
        
        if (shouldExpand) {
            content.style.maxHeight = '5000px';
            content.classList.remove('collapsed');
            icon.classList.remove('rotated');
        } else {
            content.style.maxHeight = '0';
            content.classList.add('collapsed');
            icon.classList.add('rotated');
        }
    });
}


            






            function renderVerificationProductList() {
                const container = document.getElementById('verification-product-list-container');
                const existingProductIds = new Set(verificationReportItems.map(item => item.id));

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á branch options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dropdown
                let branchOptionsHtml = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';
                BRANCHES.forEach(b => {
                    branchOptionsHtml += `<option value="${b.id}">${b.name}</option>`;
                });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS classes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
                const tableStyles = `
                    <style>
                        .quick-add-table { table-layout: fixed; width: 100%; }
                        .quick-add-table .col-checkbox { width: 40px; }
                        .quick-add-table .col-name { width: auto; min-width: 250px; }
                        .quick-add-table .col-number { width: 60px; }
                        .quick-add-table .col-branch { width: 100px; }
                        .quick-add-table input[type="number"] { width: 100%; }
                        .quick-add-table select { width: 100%; }
                    </style>
                `;

                let html = tableStyles;
                const productsToUse = PRODUCTS_BY_SUPPLIER || ALL_PRODUCTS_GROUPED;

                if (!productsToUse) {
                    container.innerHTML = '<p class="text-center text-red-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
                    return;
                }

                const sortedSuppliers = Object.keys(productsToUse).sort((a,b) => {
                    const supplierA = SUPPLIERS.find(s => s.id === a);
                    const supplierB = SUPPLIERS.find(s => s.id === b);
                    return (supplierA?.name || '').localeCompare(supplierB?.name || '');
                });

                for (const supplierId of sortedSuppliers) {
                    const supplierName = SUPPLIERS.find(s => s.id === supplierId)?.name || 'Unknown Supplier';
                    const products = productsToUse[supplierId];

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    const availableProducts = products.filter(p => !existingProductIds.has(p.id));

                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
                    if (availableProducts.length === 0) continue;

                    html += `
                        <div class="supplier-section mb-6">
                            <h4 class="font-bold text-gray-700 mb-2 bg-gray-100 p-2 rounded sticky top-0 z-10 flex justify-between items-center">
                                <span>${supplierName}
                                    <span class="text-sm font-normal text-gray-500">
                                        (${availableProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                                    </span>
                                </span>
                                <button onclick="toggleAllVerificationProducts('${supplierId}', this)"
                                        class="text-sm text-blue-600 font-medium hover:underline">
                                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                            </h4>

                            <div class="overflow-x-auto">
                                <table class="quick-add-table">
                                    <thead>
                                        <tr class="text-xs text-gray-500 border-b">
                                            <th class="col-checkbox text-left py-2 px-2"></th>
                                            <th class="col-name text-left py-2 px-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                            <th class="col-number text-center py-2 px-1">‡∏Ç‡∏≤‡∏¢</th>
                                            <th class="col-number text-center py-2 px-1">‡∏£‡∏±‡∏ö</th>
                                            <th class="col-number text-center py-2 px-1">‡∏´‡∏°‡∏î</th>
                                            <th class="col-number text-center py-2 px-1">‡∏ô‡∏±‡∏ö</th>
                                            <th class="col-number text-center py-2 px-1">‡∏¢‡πâ‡∏≤‡∏¢</th>
                                            <th class="col-branch text-center py-2 px-1">‡πÑ‡∏õ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                        </tr>
                                    </thead>
                                    <tbody data-supplier-id="${supplierId}">`;

                    availableProducts.sort((a,b) => a.name.localeCompare(b.name)).forEach(product => {
                        const productName = product.name.split(' ').slice(1).join(' ');

                        html += `
                            <tr class="product-item-verify border-b hover:bg-gray-50"
                                data-name="${productName.toLowerCase()}">
                                <td class="col-checkbox py-2 px-2">
                                    <input type="checkbox"
                                           class="product-checkbox-verify h-4 w-4 rounded border-gray-300 text-blue-600"
                                           data-product-id="${product.id}"
                                           data-product-name="${productName}"
                                           data-supplier-id="${supplierId}"
                                           data-supplier-name="${supplierName}"
                                           data-product-price="${product.price || 0}"
                                           onchange="updateVerificationSelectedCount()">
                                </td>

                                <td class="col-name py-2 px-2">
                                    <span class="text-sm font-medium block">${productName}</span>
                                </td>

                                <td class="col-number py-2 px-1">
                                    <input type="number"
                                           class="verify-quick-input-sales px-1 py-1 text-sm border rounded text-center"
                                           placeholder="0" min="0">
                                </td>

                                <td class="col-number py-2 px-1">
                                    <input type="number"
                                           class="verify-quick-input-received px-1 py-1 text-sm border rounded text-center"
                                           placeholder="0" min="0">
                                </td>

                                <td class="col-number py-2 px-1">
                                    <input type="number"
                                           class="verify-quick-input-expired px-1 py-1 text-sm border rounded text-center"
                                           placeholder="0" min="0">
                                </td>

                                <td class="col-number py-2 px-1">
                                    <input type="number"
                                           class="verify-quick-input-stock px-1 py-1 text-sm border rounded text-center"
                                           placeholder="0" min="0">
                                </td>

                                <td class="col-number py-2 px-1">
                                    <input type="number"
                                           class="verify-quick-input-transfer px-1 py-1 text-sm border rounded text-center"
                                           placeholder="0" min="0"
                                           oninput="toggleVerifyTransferBranch(this)">
                                </td>

                                <td class="col-branch py-2 px-1">
                                    <select class="verify-quick-input-branch px-1 py-1 text-sm border rounded hidden">
                                        ${branchOptionsHtml}
                                    </select>
                                </td>
                            </tr>`;
                    });

                    html += '</tbody></table></div></div>';
                }

                container.innerHTML = html;
                updateVerificationSelectedCount();
            }

            function toggleVerifyTransferBranch(input) {
                const row = input.closest('tr');
                const branchSelect = row.querySelector('.verify-quick-input-branch');

                if (parseFloat(input.value) > 0) {
                    branchSelect.classList.remove('hidden');
                } else {
                    branchSelect.classList.add('hidden');
                    branchSelect.value = '';
                }
            }


            function filterVerificationQuickAddList() {
    const searchTerm = document.getElementById('verify-product-search-input').value.toLowerCase();
    
    // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á products
    document.querySelectorAll('.product-item-verify').forEach(item => {
        item.style.display = item.dataset.name.includes(searchTerm) ? '' : 'none';
    });
    
    // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á supplier sections
    document.querySelectorAll('.supplier-section').forEach(section => {
        const visibleProducts = section.querySelectorAll('.product-item-verify:not([style*="none"])');
        section.style.display = visibleProducts.length > 0 ? 'block' : 'none';
    });
}

            function updateVerificationSelectedCount() {
                const count = document.querySelectorAll('.product-checkbox-verify:checked').length;
                document.getElementById('verify-selected-count').textContent = count;
            }

            function toggleAllVerificationProducts(supplierId, button) {
    const checkboxes = document.querySelectorAll(`tbody[data-supplier-id="${supplierId}"] .product-checkbox-verify:not(:disabled)`);
    const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !isAllChecked);
    button.textContent = isAllChecked ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    updateVerificationSelectedCount();
}

            function addSelectedProductsToVerification() {
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å form ‡∏Å‡πà‡∏≠‡∏ô
    const currentValues = {};
    document.querySelectorAll('.product-entry-verify').forEach(row => {
        const productId = row.dataset.productId;
        if (productId) {
            currentValues[productId] = {
                sales: row.querySelector('input[oninput*="salesQuantity"]')?.value || '',
                received: row.querySelector('input[oninput*="receivedQuantity"]')?.value || '',
                expired: row.querySelector('input[oninput*="expiredQuantity"]')?.value || '',
                stock: row.querySelector('input[oninput*="currentStock"]')?.value || '',
                transfer: row.querySelector('input[oninput*="transferredQuantity"]')?.value || '',
                branch: row.querySelector('.transfer-select-verify')?.value || ''
            };
        }
    });
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô verificationReportItems
    verificationReportItems.forEach(item => {
        if (currentValues[item.id]) {
            item.salesQuantity = currentValues[item.id].sales;
            item.receivedQuantity = currentValues[item.id].received;
            item.expiredQuantity = currentValues[item.id].expired;
            item.currentStock = currentValues[item.id].stock;
            item.transferredQuantity = currentValues[item.id].transfer;
            item.toBranchId = currentValues[item.id].branch;
        }
    });
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
    const selectedItems = document.querySelectorAll('.product-checkbox-verify:checked');
    
    selectedItems.forEach(checkbox => {
        const container = checkbox.closest('.product-item-verify');
        
        const salesQty = container.querySelector('.verify-quick-input-sales')?.value || '';
        const receivedQty = container.querySelector('.verify-quick-input-received')?.value || '';
        const expiredQty = container.querySelector('.verify-quick-input-expired')?.value || '';
        const stockQty = container.querySelector('.verify-quick-input-stock')?.value || '';
        const transferQty = container.querySelector('.verify-quick-input-transfer')?.value || '';
        const toBranch = container.querySelector('.verify-quick-input-branch')?.value || '';
        
        const alreadyExists = verificationReportItems.some(item => item.id === checkbox.dataset.productId);
        
        if (!alreadyExists) {

            verificationReportItems.push({
                id: checkbox.dataset.productId,
                name: checkbox.dataset.productName,
                supplierId: checkbox.dataset.supplierId,
                supplierName: checkbox.dataset.supplierName,
                price: parseFloat(checkbox.dataset.productPrice) || 0,
                salesQuantity: salesQty,
                receivedQuantity: receivedQty,
                expiredQuantity: expiredQty,
                currentStock: stockQty,
                transferredQuantity: transferQty,
                toBranchId: toBranch,
                previousData: null
            });
        }
    });
    
    // Render ‡πÉ‡∏´‡∏°‡πà
    renderVerificationGroupedProductForm();
    calculateVerificationProductTotals();
    calculateVerificationCashAmount();
    // ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á verification modal
    document.getElementById('verification-quick-add-modal')?.remove();
}

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô dropdown ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡πâ‡∏≤‡∏¢
            function toggleTransferBranch(input) {
                const container = input.closest('.product-item');
                const branchContainer = container.querySelector('.transfer-branch-container');
                const branchSelect = container.querySelector('.quick-input-branch');

                if (parseFloat(input.value) > 0) {
                    branchContainer.classList.remove('hidden');
                } else {
                    branchContainer.classList.add('hidden');
                    branchSelect.value = ''; // Clear selection
                }
            }

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• input ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            function clearAllInputs() {
                document.querySelectorAll('.product-item input[type="number"]').forEach(input => {
                    input.value = '';
                });
                document.querySelectorAll('.quick-input-branch').forEach(select => {
                    select.value = '';
                });
                document.querySelectorAll('.transfer-branch-container').forEach(container => {
                    container.classList.add('hidden');
                });
            }

function renderVerificationGroupedProductForm() {
    const container = document.getElementById('verification-item-rows-container');
    container.innerHTML = '';
    if (verificationReportItems.length === 0) return;

    const itemsBySupplier = verificationReportItems.reduce((acc, item) => {
        if (!acc[item.supplierName]) acc[item.supplierName] = [];
        acc[item.supplierName].push(item);
        return acc;
    }, {});

    let branchOptions = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';
    BRANCHES.forEach(b => { branchOptions += `<option value="${b.id}">${b.name}</option>`; });

    Object.keys(itemsBySupplier).sort().forEach((supplierName, index) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'supplier-group border rounded-lg mb-4';
        let itemsHtml = '';
        itemsBySupplier[supplierName].forEach(item => {
    const isValidStock = checkStockValidity(item);
    const rowClass = isValidStock ? '' : 'bg-red-50';

    let previousDataHtml = '';
    if (item.previousData) {
        const prev = item.previousData;
        const prevDate = new Date(prev.reportDate).toLocaleDateString('th-TH');
        previousDataHtml = `
            <tr class="bg-gray-50 text-xs">
                <td class="p-2 text-gray-500" colspan="1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (${prevDate}):</td>
                <td class="p-2 text-center text-gray-600">${prev.salesQuantity||0}</td>
                <td class="p-2 text-center text-gray-600">${prev.receivedQuantity||0}</td>
                <td class="p-2 text-center text-gray-600">${prev.expiredQuantity||0}</td>
                <td class="p-2 text-center text-gray-600 font-bold">${prev.currentStock||0}</td>
                <td class="p-2 text-center text-gray-600">${prev.transferredQuantity||0}</td>
                <td class="p-2 text-left text-gray-600" colspan="2">${prev.toBranchName || '-'}</td>
            </tr>
        `;
    }

    itemsHtml += `
        <tr class="product-entry-verify ${rowClass}" data-product-id="${item.id}">
            <td class="p-2 font-medium align-middle">${item.name}</td>
            <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateVerificationReportItem('${item.id}', 'salesQuantity', this.value)" value="${item.salesQuantity}"></td>
            <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateVerificationReportItem('${item.id}', 'receivedQuantity', this.value)" value="${item.receivedQuantity}"></td>
            <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateVerificationReportItem('${item.id}', 'expiredQuantity', this.value)" value="${item.expiredQuantity}"></td>
            <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateVerificationReportItem('${item.id}', 'currentStock', this.value); validateStockOnChange('${item.id}')" value="${item.currentStock}"></td>
            <td class="p-1 align-middle"><input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-cyan-50" oninput="updateVerificationReportItem('${item.id}', 'transferredQuantity', this.value); toggleTransferBranchInVerificationGroup(this, '${item.id}'); validateStockOnChange('${item.id}')" value="${item.transferredQuantity}"></td>
            <td class="p-1 align-middle"><select class="transfer-select-verify w-full rounded-md border-gray-300 text-sm hidden" oninput="updateVerificationReportItem('${item.id}', 'toBranchId', this.value)">${branchOptions}</select></td>
            <td class="p-1 align-middle text-center"><button type="button" onclick="event.stopPropagation(); removeProductFromVerificationReport('${item.id}')" class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></td>
        </tr>
        ${previousDataHtml}

            `;
        });

        const isCollapsed = true; // ‡∏û‡∏±‡∏ö supplier ‡∏ó‡∏µ‡πà 4 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        
        groupDiv.innerHTML = `
            <h4 class="supplier-group-header font-bold text-gray-800 bg-gray-100 p-3 rounded-t-lg flex justify-between items-center"
                onclick="toggleSupplierGroup(this)">
                <span>${supplierName} </span>
                </span>
                <span class="toggle-icon ${isCollapsed ? 'rotated' : ''}">‚ñº</span>
            </h4>
            <div class="supplier-content ${isCollapsed ? 'collapsed' : ''}" style="max-height: ${isCollapsed ? '0' : '2000px'};">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm verify-table-sticky">
                        <thead class="text-xs text-gray-500">
                            <tr>
                                <th class="p-2 text-left w-1/3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th class="p-2 text-center">‡∏Ç‡∏≤‡∏¢</th>
                                <th class="p-2 text-center">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</th>
                                <th class="p-2 text-center">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                <th class="p-2 text-center">‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</th>
                                <th class="p-2 text-center">‡∏¢‡πâ‡∏≤‡∏¢</th>
                                <th class="p-2 text-left w-1/4">‡πÑ‡∏õ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                <th class="p-2 w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">${itemsHtml}</tbody>
                    </table>
                </div>
            </div>
        `;
        container.appendChild(groupDiv);
        
        // Set branch values for items with transfers
        itemsBySupplier[supplierName].forEach(item => {
            if (item.transferredQuantity > 0) {
                const row = document.querySelector(`.product-entry-verify[data-product-id="${item.id}"]`);
                const select = row.querySelector('.transfer-select-verify');
                select.classList.remove('hidden');
                select.value = item.toBranchId || '';
            }
        });
    });
}

function checkStockValidity(item) {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    if (!item.previousData) {
        return false;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const currentStock = parseFloat(item.currentStock) || 0;
    const previousStock = parseFloat(item.previousData.currentStock) || 0;
    const sales = parseFloat(item.salesQuantity) || 0;
    const received = parseFloat(item.receivedQuantity) || 0;
    const expired = parseFloat(item.expiredQuantity) || 0;
    const transferred = parseFloat(item.transferredQuantity) || 0;
    
    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç 1: ‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚â† ‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
    if (currentStock !== previousStock && sales === 0 && received === 0 && expired === 0 && transferred === 0) {
        return false;
    }
    
    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç 2: ‡∏™‡∏π‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏™‡∏°‡∏î‡∏∏‡∏•
    const expectedStock = previousStock - sales + received - expired - transferred;
    if (Math.abs(expectedStock - currentStock) > 0.01) { // ‡πÉ‡∏ä‡πâ 0.01 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
        return false;
    }
    
    return true;
}



function toggleSupplierGroup(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');
    
    if (content.classList.contains('collapsed')) {
        // ‡∏Ç‡∏¢‡∏≤‡∏¢
        content.style.maxHeight = '5000px';
        content.classList.remove('collapsed');
        icon.classList.remove('rotated');
    } else {
        // ‡∏û‡∏±‡∏ö
        content.style.maxHeight = '0';
        content.classList.add('collapsed');
        icon.classList.add('rotated');
    }
}

       function updateVerificationReportItem(productId, field, value) {
    const item = verificationReportItems.find(i => i.id == productId);
    
    if (item) {
        item[field] = value;
        calculateVerificationProductTotals();
        calculateVerificationCashAmount();

        validateStockOnChange(productId);
    }
}

function validateStockOnChange(productId) {
    const item = verificationReportItems.find(i => i.id == productId);
    if (!item) return;
    
    const row = document.querySelector(`.product-entry-verify[data-product-id="${productId}"]`);
    if (!row) return;
    
    const isValid = checkStockValidity(item);
    
    if (isValid) {
        row.classList.remove('bg-red-50');
    } else {
        row.classList.add('bg-red-50');
    }
}

            /**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
 * ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (verificationReportItems)
 */
function syncVerificationItemsFromDOM() {
    const itemRows = document.querySelectorAll('#verification-item-rows-container .product-entry-verify');
    
    itemRows.forEach(row => {
        const productId = row.dataset.productId;
        const itemInMemory = verificationReportItems.find(i => i.id == productId);

        if (itemInMemory) {
            itemInMemory.salesQuantity = row.querySelector('input[oninput*="salesQuantity"]').value;
            itemInMemory.receivedQuantity = row.querySelector('input[oninput*="receivedQuantity"]').value;
            itemInMemory.expiredQuantity = row.querySelector('input[oninput*="expiredQuantity"]').value;
            itemInMemory.currentStock = row.querySelector('input[oninput*="currentStock"]').value;
            itemInMemory.transferredQuantity = row.querySelector('input[oninput*="transferredQuantity"]').value;
            itemInMemory.toBranchId = row.querySelector('.transfer-select-verify').value;
        }
    });
}



            function toggleTransferBranchInVerificationGroup(input, productId) {
                const entry = input.closest('.product-entry-verify');
                entry.querySelectorAll('.transfer-select-verify').forEach(sel => {
                    sel.classList.toggle('hidden', !(parseFloat(input.value) > 0));
                    if (!(parseFloat(input.value) > 0)) {
                        sel.value = '';
                        updateVerificationReportItem(productId, 'toBranchId', '');
                    }
                });
            }


                    function closeVerificationPopup() { 
    const modal = document.getElementById('verification-modal');
    if (modal) {
        modal.classList.add('hidden');
        // (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î modal.style.display = 'none'; ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
        // Clear data
        verificationReportItems = [];
    }
}

// ==================== ANALYTICS DASHBOARD ====================

function showAnalyticsDashboard() {
    document.getElementById('header-title').innerText = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢';
    const appContainer = document.getElementById('app-container');
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° branch options
    const isOffice = USER_DETAILS.role === '‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®';
    let branchOptions = '';
    
    if (isOffice) {
        // ‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
        USER_DETAILS.branchesManaged.forEach(branchId => {
            const branch = ALL_BRANCHES.find(b => b.id === branchId);
            if (branch) {
                branchOptions += `<option value="${branchId}">${branch.name}</option>`;
            }
        });
    } else {
        // ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        branchOptions = `<option value="${USER_DETAILS.branchIdAssigned}">${USER_DETAILS.branchName}</option>`;
    }
    
    // Default dates
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    const todayStr = today.toISOString().split('T')[0];
    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
    
    appContainer.innerHTML = `
        <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg">
            <button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
            
            <!-- Controls Section -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    ${isOffice ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <select id="analytics-branch" class="mt-1 w-full rounded-md border-gray-300">
                            ${branchOptions}
                        </select>
                    </div>` : 
                    `<input type="hidden" id="analytics-branch" value="${USER_DETAILS.branchIdAssigned}">`}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <select id="analytics-view-type" onchange="toggleDateInputs()" class="mt-1 w-full rounded-md border-gray-300">
                            <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                            <option value="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                            <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        </select>
                    </div>
                    
                    <div id="date-range-inputs">
                        <label class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <input type="date" id="analytics-start-date" value="${thirtyDaysAgoStr}" 
                               class="mt-1 w-full rounded-md border-gray-300">
                    </div>
                    
                    <div id="date-end-input">
                        <label class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="date" id="analytics-end-date" value="${todayStr}" 
                               class="mt-1 w-full rounded-md border-gray-300">
                    </div>
                    
                    <div id="month-input" class="hidden">
                        <label class="block text-sm font-medium text-gray-700">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <input type="month" id="analytics-month" value="${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}" 
                               class="mt-1 w-full rounded-md border-gray-300">
                    </div>
                    
                    <button onclick="loadAnalyticsData()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">
                        ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div id="summary-cards-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"></div>
            

            <!-- Charts Section -->
            <div id="charts-container" class="space-y-6 mb-6"></div>
            
            <!-- Top Products Section -->
            <div id="top-products-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    `;
    
    // Load initial data
    loadAnalyticsData();
}

function toggleDateInputs() {
    const viewType = document.getElementById('analytics-view-type').value;
    const dateRangeInputs = document.getElementById('date-range-inputs');
    const dateEndInput = document.getElementById('date-end-input');
    const monthInput = document.getElementById('month-input');
    
    if (viewType === 'monthly') {
        dateRangeInputs.classList.add('hidden');
        dateEndInput.classList.add('hidden');
        monthInput.classList.remove('hidden');
    } else {
        dateRangeInputs.classList.remove('hidden');
        dateEndInput.classList.remove('hidden');
        monthInput.classList.add('hidden');
    }
}

function loadAnalyticsData() {
    showLoading();
    
    const branchId = document.getElementById('analytics-branch').value;
    const viewType = document.getElementById('analytics-view-type').value;
    let startDate, endDate;
    
    if (viewType === 'monthly') {
        const monthValue = document.getElementById('analytics-month').value;
        const [year, month] = monthValue.split('-');
        startDate = `${year}-${month}-01`;
        
        // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        const lastDay = new Date(year, month, 0).getDate();
        endDate = `${year}-${month}-${lastDay}`;
    } else {
        startDate = document.getElementById('analytics-start-date').value;
        endDate = document.getElementById('analytics-end-date').value;
    }
    
// Clear containers
document.getElementById('summary-cards-container').innerHTML = '<p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
document.getElementById('charts-container').innerHTML = '<p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü...</p>';
document.getElementById('top-products-container').innerHTML = '<p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Top 10...</p>';
    
    // Load dashboard data
    google.script.run
        .withSuccessHandler(response => {
    const result = JSON.parse(response);
    
    if (result.status === 'success') {
        renderSummaryCards(result.summary);
        
        renderCharts(result.data, viewType);

        const isOffice = USER_DETAILS.role === '‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®';


        loadTopProducts(branchId, startDate, endDate);
    } else {
        showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error');
    }
    hideLoading();
})



        .withFailureHandler(error => {
            handleError(error);
            hideLoading();
        })
        .getDashboardData(branchId, startDate, endDate, viewType);
}

function renderTargetProgress(targetData, isOffice) {
  const container = document.getElementById('target-progress-container');
  
  if (!targetData) {
    container.innerHTML = '';
    return;
  }
  
  const { 
    targetPercent, 
    targetDaily, 
    currentAverage, 
    achievementPercent, 
    tomorrowTarget,
    daysElapsed,
    totalDays,
    status
  } = targetData;
  
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏° status
  const statusColor = {
    'achieved': 'green',
    'near': 'yellow', 
    'below': 'red'
  };
  
  const color = statusColor[status];
  const bgColor = `bg-${color}-50`;
  const textColor = `text-${color}-600`;
  const borderColor = `border-${color}-200`;
  
  let targetHtml = `
    <div class="bg-white rounded-lg shadow-md p-6 ${borderColor} border-2">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 class="text-lg font-semibold mb-2">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà</h3>
          <p class="text-sm text-gray-600">
            ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏£‡∏ß‡∏° <span class="font-bold">+${targetPercent}%</span> ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
          </p>
        </div>`;
  
  // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Office)
  if (isOffice) {
    targetHtml += `
        <button onclick="openTargetSettingModal()" 
                class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">
          ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤
        </button>`;
  }
  
  targetHtml += `
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="${bgColor} p-4 rounded-lg">
          <p class="text-sm text-gray-600">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</p>
          <p class="text-2xl font-bold ${textColor}">${Math.round(targetDaily)} ‡∏ä‡∏¥‡πâ‡∏ô</p>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-sm text-gray-600">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
          <p class="text-2xl font-bold">${Math.round(currentAverage)} ‡∏ä‡∏¥‡πâ‡∏ô/‡∏ß‡∏±‡∏ô</p>
          <p class="text-xs text-gray-500">
            ${achievementPercent.toFixed(1)}% ‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤
          </p>
        </div>
        
        <div class="bg-blue-50 p-4 rounded-lg">
          <p class="text-sm text-gray-600">‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
          <p class="text-2xl font-bold">${daysElapsed}/${totalDays} ‡∏ß‡∏±‡∏ô</p>
        </div>
      </div>`;
  
  // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  if (achievementPercent < 100 && daysElapsed < totalDays) {
    const isHighTarget = tomorrowTarget > targetDaily * 1.5;
    
    targetHtml += `
      <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
        <div class="flex items-center">
          <span class="text-2xl mr-2">üéØ</span>
          <div>
            <p class="font-semibold text-amber-800">
              ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ: ${tomorrowTarget} ‡∏ä‡∏¥‡πâ‡∏ô
            </p>
            <p class="text-sm text-amber-600">
              (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà ${Math.round(targetDaily)} ‡∏ä‡∏¥‡πâ‡∏ô/‡∏ß‡∏±‡∏ô)
            </p>
            ${isHighTarget ? `
              <p class="text-xs text-red-600 mt-1">
                ‚ö†Ô∏è ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ${((tomorrowTarget/targetDaily - 1) * 100).toFixed(0)}%
              </p>` : ''}
          </div>
        </div>
      </div>`;
  } else if (achievementPercent >= 100) {
    targetHtml += `
      <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
        <div class="flex items-center">
          <span class="text-2xl mr-2">‚úÖ</span>
          <p class="font-semibold text-green-800">
            ‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß! (${achievementPercent.toFixed(1)}%)
          </p>
        </div>
      </div>`;
  }
  
  targetHtml += '</div>';
  
  container.innerHTML = targetHtml;
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤
function openTargetSettingModal() {
  const branchId = document.getElementById('analytics-branch').value;
  const branchName = document.getElementById('analytics-branch').selectedOptions[0].text;
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
      <div class="p-6">
        <h3 class="text-lg font-bold mb-4">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà</h3>
        <p class="text-sm text-gray-600 mb-4">‡∏™‡∏≤‡∏Ç‡∏≤: ${branchName}</p>
        
        <label class="block text-sm font-medium text-gray-700 mb-2">
          ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï (%)
        </label>
        <input type="number" id="new-target-percent" 
               class="w-full px-3 py-2 border rounded-lg" 
               placeholder="5" min="0" max="100" step="1">
        
        <p class="text-xs text-gray-500 mt-2">
          * ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        </p>
        
        <div class="mt-6 flex justify-end space-x-3">
          <button onclick="this.closest('.fixed').remove()" 
                  class="px-4 py-2 text-gray-700 bg-gray-100 rounded hover:bg-gray-200">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button onclick="saveNewTarget('${branchId}')" 
                  class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function saveNewTarget(branchId) {
  const targetPercent = document.getElementById('new-target-percent').value;
  
  if (!targetPercent || targetPercent < 0 || targetPercent > 100) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 0-100%', 'error');
    return;
  }
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();
      document.querySelector('.fixed').remove();
      
      if (result.status === 'success') {
        showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success');
        loadAnalyticsData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
      } else {
        showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error');
      }
    })
    .withFailureHandler(error => {
      hideLoading();
      handleError(error);
    })
    .saveBranchTarget(branchId, targetPercent);
}


function renderSummaryCards(summary) {
    const container = document.getElementById('summary-cards-container');
    
    container.innerHTML = `
        <!-- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° -->
        <div class="bg-blue-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</h3>
                <span class="text-2xl">‚òï</span>
            </div>
            <p class="text-2xl font-bold text-blue-600">${summary.totalDrinkUnits.toLocaleString()} ‡πÅ‡∏Å‡πâ‡∏ß</p>
            <p class="text-sm text-gray-500">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${summary.avgDrinkUnits} ‡πÅ‡∏Å‡πâ‡∏ß/‡∏ß‡∏±‡∏ô</p>
        </div>
        
        <!-- ‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î -->
        <div class="bg-green-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î</h3>
                <span class="text-2xl">ü•ê</span>
            </div>
            <p class="text-2xl font-bold text-green-600">${summary.totalFreshBakeryUnits.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô</p>
            <p class="text-sm text-gray-500">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${summary.avgFreshBakeryUnits} ‡∏ä‡∏¥‡πâ‡∏ô/‡∏ß‡∏±‡∏ô</p>
        </div>
        
        <!-- ‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á -->
        <div class="bg-yellow-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á</h3>
                <span class="text-2xl">üç™</span>
            </div>
            <p class="text-2xl font-bold text-yellow-600">${summary.totalDryBakeryUnits.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô</p>
            <p class="text-sm text-gray-500">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${summary.avgDryBakeryUnits} ‡∏ä‡∏¥‡πâ‡∏ô/‡∏ß‡∏±‡∏ô</p>
        </div>
        
        <!-- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) -->
        <div class="bg-purple-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h3>
                <span class="text-2xl">üí∞</span>
            </div>
            <p class="text-2xl font-bold text-purple-600">${summary.totalRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
            <p class="text-sm text-gray-500">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${summary.avgTotalRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô</p>
        </div>
    `;
}


function renderCharts(data, viewType) {

    const container = document.getElementById('charts-container');
    
    if (data.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
        return;
    }
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° labels ‡πÅ‡∏•‡∏∞ data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö charts (‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    const labels = data.map(item => {
        const date = new Date(item.date);
        if (viewType === 'daily') {
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' });
        } else if (viewType === 'weekly') {
            return `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' })}`;
        } else {
            return date.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
        }
    });
    
    const drinkData = data.map(item => item.drinkUnits);
    const freshBakeryData = data.map(item => item.freshBakeryUnits);
    const dryBakeryData = data.map(item => item.dryBakeryUnits);
    const revenueData = data.map(item => item.totalRevenue);
    
    // Create chart containers
container.innerHTML = `
    <div class="bg-white p-4 rounded-lg border">
        <h3 class="text-lg font-semibold mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°(‡πÅ‡∏Å‡πâ‡∏ß)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="drinkChart"></canvas>
        </div>
    </div>
    
    <div class="bg-white p-4 rounded-lg border">
        <h3 class="text-lg font-semibold mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î(‡∏ä‡∏¥‡πâ‡∏ô)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="freshBakeryChart"></canvas>
        </div>
    </div>
    
    <div class="bg-white p-4 rounded-lg border">
        <h3 class="text-lg font-semibold mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á(‡∏ä‡∏¥‡πâ‡∏ô)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="dryBakeryChart"></canvas>
        </div>
    </div>
    
    <div class="bg-white p-4 rounded-lg border">
        <h3 class="text-lg font-semibold mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°(‡∏ö‡∏≤‡∏ó)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
`;
    
    // Wait for DOM to update
    setTimeout(() => {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ canvas elements ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î
    if (document.getElementById('drinkChart')) {
        createLineChart('drinkChart', labels, drinkData, '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° (‡πÅ‡∏Å‡πâ‡∏ß)', '#3B82F6');
    }
    if (document.getElementById('freshBakeryChart')) {
        createLineChart('freshBakeryChart', labels, freshBakeryData, '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î (‡∏ä‡∏¥‡πâ‡∏ô)', '#10B981');
    }
    if (document.getElementById('dryBakeryChart')) {
        createLineChart('dryBakeryChart', labels, dryBakeryData, '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á (‡∏ä‡∏¥‡πâ‡∏ô)', '#F59E0B');
    }
    if (document.getElementById('revenueChart')) {
        createBarChart('revenueChart', labels, revenueData, '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)', '#9333EA');
    }
}, 200); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡πÄ‡∏õ‡πá‡∏ô 200ms
}

function addTargetLineToChart(chart, targetValue, label = '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢') {
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° dataset ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
  const targetData = new Array(chart.data.labels.length).fill(targetValue);
  
  chart.data.datasets.push({
    label: label,
    data: targetData,
    borderColor: 'rgba(255, 0, 0, 0.5)',
    borderDash: [5, 5],
    borderWidth: 2,
    pointRadius: 0,
    fill: false,
    tension: 0
  });
  
  chart.update();
}

function createLineChart(canvasId, labels, data, label, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                borderColor: color,
                backgroundColor: color + '20',
                borderWidth: 2,
                fill: true,
                tension: 0.1
            }]
        },

options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            display: false
        }
    },
    scales: {
        y: {
            beginAtZero: true,
            ticks: {
                stepSize: 1
            }
        }
    },
    layout: {
        padding: 10
    }
}

        
    });
}

function createBarChart(canvasId, labels, data, label, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                backgroundColor: color + '40',
                borderColor: color,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            },
            layout: {
                padding: 10
            }
        }
    });
}


function loadTopProducts(branchId, startDate, endDate) {
    const container = document.getElementById('top-products-container');
    
    // Clear container first
    container.innerHTML = '';
    
    // Load fresh bakery products
    google.script.run
        .withSuccessHandler(freshProducts => {
            renderTopProductsTable('fresh', freshProducts, container);
        })
        .withFailureHandler(handleError)
        .getTopProducts(branchId, startDate, endDate, 'fresh', 10);
    
    // Load dry bakery products
    google.script.run
        .withSuccessHandler(dryProducts => {
            renderTopProductsTable('dry', dryProducts, container);
        })
        .withFailureHandler(handleError)
        .getTopProducts(branchId, startDate, endDate, 'dry', 10);
}



function renderTopProductsTable(type, products, container) {
    const title = type === 'fresh' ? '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î' : '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á';
    const bgColor = type === 'fresh' ? 'bg-green-50' : 'bg-yellow-50';
    
    let tableHtml = `
        <div class="bg-white rounded-lg border">
            <div class="${bgColor} p-3 rounded-t-lg">
                <h3 class="text-lg font-semibold">Top 10 ${title}</h3>
            </div>
            <div class="p-4">
    `;
    
    if (products.length === 0) {
        tableHtml += '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
    } else {
        tableHtml += `
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-2">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                        <th class="text-left py-2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                        <th class="text-right py-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th class="text-right py-2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        products.forEach((product, index) => {
            tableHtml += `
                <tr class="border-b">
                    <td class="py-2">${index + 1}</td>
                    <td class="py-2">${product.productName}</td>
                    <td class="py-2 text-right">${product.units} ‡∏ä‡∏¥‡πâ‡∏ô</td>
                    <td class="py-2 text-right">${product.revenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                </tr>
            `;
        });
        
        tableHtml += '</tbody></table>';
    }
    
    tableHtml += '</div></div>';
    
    // Append to container
container.innerHTML += tableHtml;

}


                    function handleDeleteReport(reportId) {
                        showCustomConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Report ID: ${reportId}? ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô 'Deleted'`, () => {
                            showLoading();
                            google.script.run.withSuccessHandler(response => {
                                const result = JSON.parse(response);
                                hideLoading();
                                closeVerificationPopup();
                                showCustomAlert(result.status === 'success' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, result.status, showVerifyReportsModule);
                            }).withFailureHandler(handleError).markReportAsDeleted(reportId);
                        });
                    }


                   function handleVerifyReport(reportId) {
                        console.log("XXXXXXXXXXXXXXXXXXXXXXXXXXXXX");
                        showCustomConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
                            showLoading();
                            const reportData = {
                                reportId: reportId,
                                items: [],
                                drinkCategories: [],
                                cancelledBills: [],
                                addOns: [],
                                payments: [],
                                discounts: [],
                                timeSlot: document.getElementById('verify-time-slot').value,
                                note: document.getElementById('verify-note').value
                            };

                            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                            document.querySelectorAll('.product-entry-verify').forEach(row => {
                                const productId = row.dataset.productId;
                                const itemData = {
                                    productId: productId,
                                    salesQuantity: row.querySelector(`input[oninput*="salesQuantity"]`).value || 0,
                                    receivedQuantity: row.querySelector(`input[oninput*="receivedQuantity"]`).value || 0,
                                    expiredQuantity: row.querySelector(`input[oninput*="expiredQuantity"]`).value || 0,
                                    currentStock: row.querySelector(`input[oninput*="currentStock"]`).value || 0,
                                    transferredQuantity: row.querySelector(`input[oninput*="transferredQuantity"]`).value || 0,
                                    toBranchId: row.querySelector('.transfer-select-verify').value || null
                                };
                                reportData.items.push(itemData);
                            });

                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
                            for (const item of reportData.items) {
                                if (item.transferredQuantity > 0 && !item.toBranchId) {
                                    const product = verificationReportItems.find(p => p.id === item.productId);
                                    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${product.name}'`, 'error');
                                    hideLoading();
                                    return;
                                }
                            }

                            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Add-on
                            const verifyAddon5Qty = document.getElementById('verify-addon-5-qty').value;
                            const verifyAddon5Amount = document.getElementById('verify-addon-5').value;
                            const verifyAddon10Qty = document.getElementById('verify-addon-10-qty').value;
                            const verifyAddon10Amount = document.getElementById('verify-addon-10').value;
                            const verifyAddon15Qty = document.getElementById('verify-addon-15-qty').value;
                            const verifyAddon15Amount = document.getElementById('verify-addon-15').value;

                            if (verifyAddon5Amount > 0) reportData.addOns.push({
                                type: '5‡∏ö‡∏≤‡∏ó',
                                amount: parseFloat(verifyAddon5Amount),
                                quantity: parseInt(verifyAddon5Qty) || 0,
                                unitPrice: 5
                            });
                            if (verifyAddon10Amount > 0) reportData.addOns.push({
                                type: '10‡∏ö‡∏≤‡∏ó',
                                amount: parseFloat(verifyAddon10Amount),
                                quantity: parseInt(verifyAddon10Qty) || 0,
                                unitPrice: 10
                            });
                            if (verifyAddon15Amount > 0) reportData.addOns.push({
                                type: '15‡∏ö‡∏≤‡∏ó',
                                amount: parseFloat(verifyAddon15Amount),
                                quantity: parseInt(verifyAddon15Qty) || 0,
                                unitPrice: 15
                            });

                            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            document.querySelectorAll('.verify-cancellation-row').forEach(row => {
                                const billNumber = row.querySelector('.verify-cancel-bill-number').value;
                                const reason = row.querySelector('.verify-cancel-reason').value;
                                const amount = row.querySelector('.verify-cancel-amount').value;
                                const cancelledBy = row.querySelector('.verify-cancel-by-name')?.value || '';

                                if (billNumber || reason || amount) {
                                    reportData.cancelledBills.push({
                                        billNumber,
                                        reason,
                                        amount: parseFloat(amount) || 0,
                                        cancelledBy: cancelledBy || ''
                                    });
                                }
                            });

                            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°
                            document.querySelectorAll('.verify-drink-sales-input').forEach(input => {
                                const categoryName = input.dataset.categoryName;
                                const salesAmount = input.value || 0;
                                const cupQuantity = document.querySelector(`.verify-drink-cups-input[data-category-name="${categoryName}"]`).value || 0;
                                reportData.drinkCategories.push({
                                    name: categoryName,
                                    salesAmount: salesAmount,
                                    cupQuantity: cupQuantity
                                });
                            });

                            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                            document.querySelectorAll('.verify-payment-summary-input').forEach(input => {
                                if (parseFloat(input.value) > 0) {
                                    reportData.payments.push({
                                        typeId: input.dataset.typeId,
                                        amount: input.value
                                    });
                                }
                            });

                            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
                            document.querySelectorAll('.verify-discount-summary-input').forEach(input => {
                                if (parseFloat(input.value) > 0) {
                                    reportData.discounts.push({
                                        typeId: input.dataset.typeId,
                                        amount: input.value
                                    });
                                }
                            });

                            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ù‡∏±‡πà‡∏á Apps Script
                            google.script.run.withSuccessHandler(response => {
                                const result = JSON.parse(response);
                                hideLoading();
                                closeVerificationPopup();
                                showCustomAlert(
                                    result.status === 'success' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                                    result.message,
                                    result.status,
                                    showVerifyReportsModule
                                );
                            }).withFailureHandler(handleError)
                              .updateAndVerifyReport(JSON.stringify(reportData));
                        });
                    }


                    function updateVerificationTotals(type) {
                        if (type === 'drink') {
                            let totalSales = 0; let totalCups = 0;
                            document.querySelectorAll('.verify-drink-sales-input').forEach(input => { totalSales += parseFloat(input.value) || 0; });
                            document.querySelectorAll('.verify-drink-cups-input').forEach(input => { totalCups += parseInt(input.value) || 0; });
                            document.getElementById('verify-drink-category-totals').innerHTML = `<span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalSales.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span> | <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalCups}</span> ‡πÅ‡∏Å‡πâ‡∏ß</span>`;
                        } else if (type === 'payment') {
                            let totalAmount = 0;
                            document.querySelectorAll('.verify-payment-summary-input').forEach(input => { totalAmount += parseFloat(input.value) || 0; });
                            document.getElementById('verify-payment-summary-total').innerHTML = `<span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span>`;
                        } else if (type === 'discount') {
                            let totalAmount = 0;
                            document.querySelectorAll('.verify-discount-summary-input').forEach(input => { totalAmount += parseFloat(input.value) || 0; });
                            document.getElementById('verify-discount-summary-total').innerHTML = `<span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span>`;




                        }
                    }

                    // --- SALES SUMMARY MODULE (OFFICE) ---
                    function showSalesSummaryModule() {
                        document.getElementById('header-title').innerText = '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
                        const appContainer = document.getElementById('app-container');
                        let branchOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';
                        ALL_BRANCHES.forEach(b => { branchOptions += `<option value="${b.id}">${b.name}</option>`; });
                        const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0'); const todayFormatted = `${yyyy}-${mm}-${dd}`;
                        appContainer.innerHTML = `

                        <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">
            <button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">

                                    <div><label class="block text-sm font-medium">‡∏™‡∏≤‡∏Ç‡∏≤</label><select id="summary-branch" class="mt-1 w-full rounded-md">${branchOptions}</select></div>
                                    <div><label class="block text-sm font-medium">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="summary-start-date" value="${todayFormatted}" class="mt-1 w-full rounded-md"></div>
                                    <div><label class="block text-sm font-medium">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="summary-end-date" value="${todayFormatted}" class="mt-1 w-full rounded-md"></div>
                                    <button onclick="handleSummarySearch()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                                </div>
                                <div id="summary-table-container"></div>
                            </div>`;
                    }
                    function handleSummarySearch() {
                        const branchId = document.getElementById('summary-branch').value;
                        const startDate = document.getElementById('summary-start-date').value;
                        const endDate = document.getElementById('summary-end-date').value;
                        if (!branchId || !startDate || !endDate) {
                            showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                            return;
                        }
                        showLoading();
                        google.script.run.withSuccessHandler(renderSummaryTable).withFailureHandler(handleError).getSalesSummary(branchId, startDate, endDate);
                    }

function renderSummaryTable(responseString) {
    const result = JSON.parse(responseString);


    
    if (result.status === 'error') { 
        handleError({ message: result.message }); 
        return; 
    }
    const container = document.getElementById('summary-table-container');
    const { headers, data, isManager } = result;
    
    let table = `<div class="overflow-x-auto"><table class="w-full text-sm summary-table"><thead>`;
    table += `<tr>
        <th rowspan="2" class="text-left sticky-col first-col">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
        <th rowspan="2" class="text-left sticky-col second-col">‡∏£‡∏≠‡∏ö</th>
        <th colspan="2" class="header-group">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</th>
        <th colspan="2" class="header-group">‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î</th>
        <th colspan="2" class="header-group">‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á</th>
        <th colspan="${headers.length + 2}" class="header-group">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
        <th rowspan="2" >‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
        <th rowspan="2" class="whitespace-nowrap" style="min-width: 150px;" >‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</th>
    </tr>`;
    
    table += `<tr><th>‡∏ä‡∏¥‡πâ‡∏ô</th><th>‡∏ö‡∏≤‡∏ó</th><th>‡∏ä‡∏¥‡πâ‡∏ô</th><th>‡∏ö‡∏≤‡∏ó</th><th>‡∏ä‡∏¥‡πâ‡∏ô</th><th>‡∏ö‡∏≤‡∏ó</th>`;
    
    // ‡πÅ‡∏™‡∏î‡∏á payment headers ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
    headers.forEach(h => { 
        if (h.name !== '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
            table += `<th>${h.name}</th>`; 
        }
    });
    table += `<th>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th>`;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏ß‡∏°
    const cashHeader = headers.find(h => h.name === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î');
    if (cashHeader) {
        table += `<th>${cashHeader.name}</th>`;
    }
    
    table += `<th>‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th></tr></thead><tbody>`;

    data.forEach(day => {
        // Morning row
        let morningHtml = '';
        headers.forEach(h => {
            if (h.name !== '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
                morningHtml += `<td>${(day.morning.payments[h.id] || 0).toFixed(2)}</td>`;
            }
        });
        morningHtml += `<td>${(day.morning.totalDiscounts || 0).toFixed(2)}</td>`;
        if (cashHeader) {
            morningHtml += `<td>${(day.morning.payments[cashHeader.id] || 0).toFixed(2)}</td>`;
        }
        
        table += `<tr>
            <td class="row-day text-left sticky-col first-col" rowspan="3">${day.date}</td>
            <td class="text-left sticky-col second-col">‡πÄ‡∏ä‡πâ‡∏≤</td>
            <td>${day.morning.drinkUnits}</td>
            <td>${day.morning.drinkAmount.toFixed(2)}</td>
            <td>${day.morning.freshBakeryUnits}</td>
            <td>${day.morning.freshBakeryAmount.toFixed(2)}</td>
            <td>${day.morning.dryBakeryUnits}</td>
            <td>${day.morning.dryBakeryAmount.toFixed(2)}</td>
            ${morningHtml}
            <td>${day.morning.totalPayments.toFixed(2)}</td>
            <td></td>
            <td></td>
        </tr>`;

        // Afternoon row
        let afternoonHtml = '';
        headers.forEach(h => {
            if (h.name !== '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
                afternoonHtml += `<td>${(day.afternoon.payments[h.id] || 0).toFixed(2)}</td>`;
            }
        });
        afternoonHtml += `<td>${(day.afternoon.totalDiscounts || 0).toFixed(2)}</td>`;
        if (cashHeader) {
            afternoonHtml += `<td>${(day.afternoon.payments[cashHeader.id] || 0).toFixed(2)}</td>`;
        }
        
        table += `<tr>
            <td class="text-left sticky-col second-col">‡∏ö‡πà‡∏≤‡∏¢</td>
            <td>${day.afternoon.drinkUnits}</td>
            <td>${day.afternoon.drinkAmount.toFixed(2)}</td>
            <td>${day.afternoon.freshBakeryUnits}</td>
            <td>${day.afternoon.freshBakeryAmount.toFixed(2)}</td>
            <td>${day.afternoon.dryBakeryUnits}</td>
            <td>${day.afternoon.dryBakeryAmount.toFixed(2)}</td>
            ${afternoonHtml}
            <td>${day.afternoon.totalPayments.toFixed(2)}</td>
            <td></td>
            <td></td>
        </tr>`;

        // Total row
        table += `<tr class="row-total">
            <td class="text-left sticky-col second-col">‡∏£‡∏ß‡∏°</td>
            <td>${day.total.drinkUnits}</td>
            <td>${day.total.drinkAmount.toFixed(2)}</td>
            <td>${day.total.freshBakeryUnits}</td>
            <td>${day.total.freshBakeryAmount.toFixed(2)}</td>
            <td>${day.total.dryBakeryUnits}</td>
            <td>${day.total.dryBakeryAmount.toFixed(2)}</td>`;
        
        headers.forEach(h => {
            if (h.name !== '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
                table += `<td>${(day.total.payments[h.id] || 0).toFixed(2)}</td>`;
            }
        });
        table += `<td>${(day.total.totalDiscounts || 0).toFixed(2)}</td>`;
        if (cashHeader) {
            table += `<td>${(day.total.payments[cashHeader.id] || 0).toFixed(2)}</td>`;
        }
        table += `<td>${day.total.totalPayments.toFixed(2)}</td>`;

        // Transfer column
        const isSaved = day.total.bankTransfer && day.total.bankTransfer.amount;
        const isDisabled = !isManager || isSaved;
        const disabledAttribute = isDisabled ? 'disabled' : '';
        const buttonClass = isDisabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-emerald-500 hover:bg-emerald-600';
        const buttonText = isSaved ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        const buttonAction = isDisabled ? '' : `onclick="handleSaveTransfer('${day.isoDate}')"`;

        table += `<td>
            <div class="flex items-center space-x-2 justify-center">
                <input type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" id="transfer-amount-${day.isoDate}" value="${day.total.bankTransfer.amount}" class="w-24 rounded-md text-right" ${disabledAttribute}>
                <input type="date" id="transfer-date-${day.isoDate}" value="${day.total.bankTransfer.transferDate}" class="w-32 rounded-md" ${disabledAttribute}>
                <input type="text" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)..." id="transfer-note-${day.isoDate}" value="${day.total.bankTransfer.note}" class="w-40 rounded-md" ${disabledAttribute}>
                <button id="transfer-btn-${day.isoDate}" ${buttonAction} class="${buttonClass} text-white text-xs px-2 py-1 rounded-md" ${disabledAttribute}>${buttonText}</button>
            </div>
        </td>`;


// Additional Withdrawal column
const withdrawal = day.total.additionalWithdrawal;
const hasWithdrawal = withdrawal && withdrawal.totalAmount > 0;
const withdrawalId = `withdrawal-${day.isoDate}`;
const currentBranchId = document.getElementById('summary-branch').value;

table += `<td>
  <div class="flex flex-col items-center space-y-1">
    ${hasWithdrawal ? `
      <div class="text-sm">
        <span class="font-medium">${withdrawal.totalAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
        <button onclick="toggleWithdrawalDetails('${withdrawalId}')" 
          class="ml-1 text-blue-600 hover:text-blue-800">
          <span id="icon-${withdrawalId}">üìã</span>
        </button>
      </div>
      <div id="${withdrawalId}" class="hidden mt-2 p-2 bg-gray-50 rounded text-xs text-left w-48">
        ${(() => {
          let html = '';
          if (withdrawal.itemsByDate) {
            Object.keys(withdrawal.itemsByDate).sort().forEach(date => {
              html += `<div class="font-semibold mt-2 first:mt-0">${new Date(date).toLocaleDateString('th-TH', {day: '2-digit', month: 'short', year: '2-digit'})}:</div>`;
              withdrawal.itemsByDate[date].forEach(item => {
                html += `<div class="ml-2">${item.expenseType}: ${item.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>`;
              });
            });
          } else {
            // Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
            withdrawal.items.forEach(item => {
              html += `<div>${item.expenseType}: ${item.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>`;
            });
          }
          return html;
        })()}
      </div>
    ` : ''}
    ${isManager ? `
      <button onclick="openWithdrawalModal('${currentBranchId}', '${day.isoDate}')"
        class="bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded ${hasWithdrawal ? 'mt-2' : ''}">
        + ‡πÄ‡∏û‡∏¥‡πà‡∏°
      </button>
    ` : (!hasWithdrawal ? '<span class="text-gray-400">-</span>' : '')}
  </div>
</td></tr>`;




    });
    
    table += `</tbody></table></div>`;
    container.innerHTML = table;
    hideLoading();


}





                    function handleSaveTransfer(isoDate) {
                const branchId = document.getElementById('summary-branch').value;
                const amountInput = document.getElementById(`transfer-amount-${isoDate}`);
                const dateInput = document.getElementById(`transfer-date-${isoDate}`);
                const noteInput = document.getElementById(`transfer-note-${isoDate}`); // ‡∏î‡∏∂‡∏á input ‡∏Ç‡∏≠‡∏á note
                const saveButton = document.getElementById(`transfer-btn-${isoDate}`);
                const amount = amountInput.value;
                const transferDate = dateInput.value;
                const note = noteInput.value; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å note

                if (!amount || !transferDate) { showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô', 'error'); return; }

                // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 4: ‡πÄ‡∏û‡∏¥‡πà‡∏° note ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô object ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ---
                const logData = {
                    branchId: branchId,
                    dateOfSale: isoDate,
                    transferDate: transferDate,
                    amount: parseFloat(amount),
                    note: note
                };

                showLoading();
                google.script.run.withSuccessHandler(response => {
                    const result = JSON.parse(response);
                    hideLoading();
                    showCustomAlert(result.status === 'success' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, result.status);
                    if (result.status === 'success') {
                        amountInput.disabled = true;
                        dateInput.disabled = true;
                        noteInput.disabled = true; // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á note ‡∏î‡πâ‡∏ß‡∏¢
                        saveButton.disabled = true;
                        saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
                        saveButton.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
                        saveButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                        saveButton.onclick = null;
                    }
                }).withFailureHandler(handleError).logBankTransfer(JSON.stringify(logData));
            }

                    // --- ORDER/CLAIM MODULE (OFFICE) ---
                function showOrderClaimModule() {
                document.getElementById('header-title').innerText = '‡∏™‡∏±‡πà‡∏á/‡πÄ‡∏Ñ‡∏•‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                const appContainer = document.getElementById('app-container');
                let branchOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';
                ALL_BRANCHES.forEach(b => {
                    if (USER_DETAILS.branchesManaged.includes(String(b.id))) {
                        branchOptions += `<option value="${b.id}">${b.name}</option>`;
                    }
                });
                appContainer.innerHTML = `
                    <div class="max-w-full mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">
                                <button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</label>
                                <select id="order-claim-branch" class="mt-1 w-full rounded-md">${branchOptions}</select>
                            </div>
                            <button onclick="handleOrderClaimSearch()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md h-10">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                        <div id="order-claim-table-container"></div>
                    </div>`;
            }


      function handleOrderClaimSearch() {
        return new Promise((resolve, reject) => {
          const branchId = document.getElementById('order-claim-branch').value;
          if (!branchId) {
            showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤', 'error');
            reject('branchId missing');
            return;
          }
          showLoading();
          google.script.run
            .withSuccessHandler(response => {
              try {
                renderNewClaimTable(response);
                hideLoading();
                resolve(response); // ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß resolve
              } catch (err) {
                hideLoading();
                reject(err);
              }
            })
            .withFailureHandler(err => {
              hideLoading();
              handleError(err);
              reject(err);
            })
            .getClaimableReportItems(branchId);
        });
      }






let claimItems = [];

function renderOrderClaimTable(responseString) {
  const result = JSON.parse(responseString);
  
  if (result.status === 'error') {
    handleError({ message: result.message });
    return;
  }

  const container = document.getElementById('order-claim-table-container');
  const data = result.data;
  const isManager = true;

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô claimItems array
  claimItems = data.map(item => ({
    productId: item.productId,
    name: item.name,
    supplierId: item.supplierId,
    supplierName: item.supplierName,
    latestStock: item.latestStock,
    reportedExpiredQuantity: item.unclaimedExpired, // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏° DB
    claimableQuantity: 0,
    claimStatus: 'draft',
    receivedQuantity: 0,
    receivedDate: '',
    receiptStatus: 'pending'
  }));

  const groupedBySupplier = claimItems.reduce((acc, item) => {
    (acc[item.supplierName] = acc[item.supplierName] || []).push(item);
    return acc;
  }, {});

  let tableHtml = '<div class="space-y-8" id="all-suppliers-container">';

  const sortedSuppliers = Object.keys(groupedBySupplier).sort();

  for (const supplierName of sortedSuppliers) {
    tableHtml += `<div data-supplier-table="${supplierName}">
      <h3 class="text-lg font-bold text-gray-800 mb-2">${supplierName}</h3>`;

    tableHtml += '<div class="overflow-x-auto border rounded-lg"><table class="min-w-full text-sm table-fixed">';

    // Header ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    tableHtml += `<thead class="bg-gray-100">
      <tr>
        <th class="px-4 py-2 text-left font-semibold w-[15%]">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
        <th class="px-4 py-2 text-left font-semibold w-[25%]">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
        <th class="px-4 py-2 text-center font-semibold w-[10%]">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏°)</th>
        <th class="px-4 py-2 text-center font-semibold w-[15%]">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏°</th>
        <th class="px-4 py-2 text-center font-semibold w-[10%]">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</th>
        <th class="px-4 py-2 text-center font-semibold w-[15%]">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</th>
      </tr>
    </thead>`;

    tableHtml += '<tbody class="divide-y">';

    groupedBySupplier[supplierName].sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
      const disabled = !isManager ? 'disabled' : '';
      
      tableHtml += `<tr id="claim-row-${item.productId}" data-product-id="${item.productId}">
        <td class="px-4 py-2 font-mono text-left">${item.productId}</td>
        <td class="px-4 py-2 text-left">${item.name}</td>
        <td class="px-4 py-2 text-center">${item.latestStock}</td>
        <td class="px-4 py-2 text-center font-bold text-red-600">${item.reportedExpiredQuantity}</td>
        
        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏° + ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
        <td class="px-4 py-2 text-center">
          <div class="flex items-center gap-2 justify-center">
            <input type="number" 
              class="claim-quantity-input w-16 rounded-md border-gray-300 text-center" 
              placeholder="0" min="0" max="${item.reportedExpiredQuantity}"
              onchange="validateClaimQuantity(this, ${item.reportedExpiredQuantity}, '${item.productId}')"
              ${disabled}>
            <button class="claim-save-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs"
              onclick="saveClaim('${item.productId}')" ${disabled}>
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
          </div>
        </td>
        
        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ -->
        <td class="px-4 py-2 text-center">
          <input type="number" 
            class="received-quantity-input w-16 rounded-md border-gray-300 text-center" 
            placeholder="0" min="0" disabled>
        </td>
        
        <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
        <td class="px-4 py-2 text-center">
          <div class="flex items-center gap-2 justify-center">
            <input type="date" 
              class="received-date-input w-28 rounded-md border-gray-300 text-center text-xs" 
              disabled>
            <button class="receipt-save-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs"
              onclick="saveReceipt('${item.productId}')" disabled>
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
          </div>
        </td>
      </tr>`;
    });

    tableHtml += '</tbody></table></div></div>';
  }

  tableHtml += `</div>
    <div class="mt-6 pt-6 border-t">
      <div id="add-product-controls" class="hidden space-y-2">
        <p class="font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</p>
        <div class="flex space-x-2">
          <select id="new-supplier-select" onchange="updateNewProductDropdown()" 
            class="w-1/3 rounded-md border-gray-300 text-sm"></select>
          <select id="new-product-select" class="w-1/3 rounded-md border-gray-300 text-sm">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          </select>
          <button onclick="addProductToClaimTable()" 
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      </div>
      
      <div class="flex justify-between items-center mt-4">
        <button onclick="showAddProductControls()" 
          class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">+ ‡∏ö‡∏ß‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <div class="text-sm text-gray-600">
          <span>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏•‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ</span>
        </div>
      </div>
    </div>`;

  container.innerHTML = tableHtml;
  hideLoading();
}

function addProductToClaimTable() {
  const productId = document.getElementById('new-product-select').value;
  const branchId = document.getElementById('order-claim-branch').value;

  if (!productId) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°', 'error');
    return;
  }

  if (document.getElementById(`claim-row-${productId}`)) {
    showCustomAlert('‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'error');
    return;
  }

  showLoading();

  google.script.run.withSuccessHandler(responseString => {
    const result = JSON.parse(responseString);
    
    if (result.status === 'error') {
      handleError({ message: result.message });
      return;
    }

    const item = result.data;
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô claimItems array
    const newItem = {
      productId: item.productId,
      name: item.name,
      supplierId: item.supplierId,
      supplierName: item.supplierName,
      latestStock: item.latestStock,
      reportedExpiredQuantity: item.unclaimedExpired,
      claimableQuantity: 0,
      claimStatus: 'draft',
      receivedQuantity: 0,
      receivedDate: '',
      receiptStatus: 'pending'
    };
    
    claimItems.push(newItem);

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û: ‡∏´‡∏≤ table ‡∏Ç‡∏≠‡∏á supplier ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ querySelector ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    const allSuppliersContainer = document.getElementById('all-suppliers-container');
    let supplierTableBody = allSuppliersContainer.querySelector(`div[data-supplier-table="${item.supplierName}"] tbody`);

    if (!supplierTableBody) {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á supplier table ‡πÉ‡∏´‡∏°‡πà (‡∏¢‡πà‡∏≠ HTML ‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î)
      const tableHTML = `
        <h3 class="text-lg font-bold text-gray-800 mb-2">${item.supplierName}</h3>
        <div class="overflow-x-auto border rounded-lg">
          <table class="min-w-full text-sm table-fixed">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left font-semibold w-[15%]">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="px-4 py-2 text-left font-semibold w-[22%]">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="px-4 py-2 text-center font-semibold w-[8%]">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                <th class="px-4 py-2 text-center font-semibold w-[10%]">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏°)</th>
                <th class="px-4 py-2 text-center font-semibold w-[15%]">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏°</th>
                <th class="px-4 py-2 text-center font-semibold w-[10%]">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th class="px-4 py-2 text-center font-semibold w-[15%]">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th class="px-4 py-2 text-center font-semibold w-[5%]">‡∏•‡∏ö</th>
              </tr>
            </thead>
            <tbody class="divide-y"></tbody>
          </table>
        </div>`;
      
      const newTableDiv = document.createElement('div');
      newTableDiv.dataset.supplierTable = item.supplierName;
      newTableDiv.innerHTML = tableHTML;
      
      allSuppliersContainer.appendChild(newTableDiv);
      supplierTableBody = newTableDiv.querySelector('tbody');
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ insertRow ‡πÅ‡∏ó‡∏ô innerHTML ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const newRow = supplierTableBody.insertRow();
    newRow.id = `claim-row-${item.productId}`;
    newRow.dataset.productId = item.productId;
    newRow.dataset.isOriginal = 'false'; // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà

    // ‡πÉ‡∏ä‡πâ template ‡∏ó‡∏µ‡πà‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
    newRow.innerHTML = `
      <td class="px-4 py-2 font-mono text-left">${item.productId}</td>
      <td class="px-4 py-2 text-left">${item.name}</td>
      <td class="px-4 py-2 text-center">${item.latestStock}</td>
      <td class="px-4 py-2 text-center font-bold text-red-600">${item.unclaimedExpired}</td>
      <td class="px-4 py-2 text-center">
        <div class="flex items-center gap-2 justify-center">
          <input type="number" class="claim-quantity-input w-16 rounded-md border-gray-300 text-center" 
            placeholder="0" min="0" max="${item.unclaimedExpired}"
            onchange="validateClaimQuantity(this, ${item.unclaimedExpired}, '${item.productId}')">
          <button class="claim-save-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs"
            onclick="saveClaim('${item.productId}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </td>
      <td class="px-4 py-2 text-center">
        <input type="number" class="received-quantity-input w-16 rounded-md border-gray-300 text-center" 
          placeholder="0" min="0" disabled>
      </td>
      <td class="px-4 py-2 text-center">
        <div class="flex items-center gap-2 justify-center">
          <input type="date" class="received-date-input w-28 rounded-md border-gray-300 text-center text-xs" disabled>
          <button class="receipt-save-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs"
            onclick="saveReceipt('${item.productId}')" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </td>
      <td class="px-4 py-2 text-center">
        <button onclick="removeClaimItem('${item.productId}')" 
          class="text-red-500 hover:text-red-700 font-bold text-xl" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ">√ó</button>
      </td>`;

    hideLoading();
    showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${item.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');

  }).withFailureHandler(handleError).getSingleProductData(productId, branchId);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô validate ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏°
function validateClaimQuantity(input, maxQty, productId) {
  const value = parseInt(input.value) || 0;
  
  if (value > maxQty) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏° (${value}) ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (${maxQty}) ‡πÑ‡∏î‡πâ`, 'error');
    input.value = maxQty;
    return false;
  }
  
  if (value < 0) {
    input.value = 0;
    return false;
  }
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô claimItems array
  const item = claimItems.find(i => i.productId === productId);
  if (item) {
    item.claimableQuantity = value;
  }
  
  return true;
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°
function removeClaimItem(productId) {
  showCustomConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${productId} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => {
    // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å claimItems array
    claimItems = claimItems.filter(item => item.productId !== productId);
    
    // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏à‡∏≤‡∏Å DOM
    const row = document.getElementById(`claim-row-${productId}`);
    if (row) {
      const table = row.closest('table');
      const tbody = row.closest('tbody');
      
      row.remove();
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤ supplier ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏•‡∏ö table ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      if (tbody.children.length === 0) {
        const supplierDiv = table.closest('div[data-supplier-table]');
        if (supplierDiv) {
          supplierDiv.remove();
        }
      }
    }
    
    showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${productId} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
  });
} 

function saveClaim(productId) {
  const row = document.getElementById(`claim-row-${productId}`);
  const quantityInput = row.querySelector('.claim-quantity-input');
  const saveBtn = row.querySelector('.claim-save-btn');
  const quantity = parseInt(quantityInput.value) || 0;

  if (quantity <= 0) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
    return;
  }

  const branchId = document.getElementById('order-claim-branch').value;
  
  const claimData = {
    branchId: branchId,
    productId: productId,
    claimableQuantity: quantity
  };

  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();

      if (result.status === 'success') {
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó state
        const item = claimItems.find(i => i.productId === productId);
        if (item) {
          item.claimableQuantity = quantity;
          item.claimStatus = 'claimed';
          item.claimId = result.claimId; // ‡πÄ‡∏Å‡πá‡∏ö claimId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
        }

        // ‡∏•‡πá‡∏≠‡∏Ñ input ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°
        quantityInput.disabled = true;
        quantityInput.classList.add('bg-gray-100');
        saveBtn.disabled = true;
        saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
        saveBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô input ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤
        const receivedInput = row.querySelector('.received-quantity-input');
        const dateInput = row.querySelector('.received-date-input');
        const receiptBtn = row.querySelector('.receipt-save-btn');

        receivedInput.disabled = false;
        receivedInput.classList.remove('bg-gray-100');
        dateInput.disabled = false;
        dateInput.classList.remove('bg-gray-100');
        receiptBtn.disabled = false;
        receiptBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        receiptBtn.classList.add('bg-green-500', 'hover:bg-green-600');

        showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success');
      } else {
        showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .saveClaim(JSON.stringify(claimData));
}

function saveReceipt(productId) {
  const row = document.getElementById(`claim-row-${productId}`);
  const receivedInput = row.querySelector('.received-quantity-input');
  const dateInput = row.querySelector('.received-date-input');
  const saveBtn = row.querySelector('.receipt-save-btn');

  const receivedQty = parseInt(receivedInput.value) || 0;
  const receivedDate = dateInput.value;

  if (receivedQty <= 0) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤', 'error');
    return;
  }

  if (!receivedDate) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á', 'error');
    return;
  }

  const branchId = document.getElementById('order-claim-branch').value;
  
  const receiptData = {
    branchId: branchId,
    productId: productId,
    receivedQuantity: receivedQty,
    receivedDate: receivedDate
  };

  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();

      if (result.status === 'success') {
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó state
        const item = claimItems.find(i => i.productId === productId);
        if (item) {
          item.receivedQuantity = receivedQty;
          item.receivedDate = receivedDate;
          item.receiptStatus = 'received';
        }

        // ‡∏•‡πá‡∏≠‡∏Ñ input ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°
        receivedInput.disabled = true;
        receivedInput.classList.add('bg-gray-100');
        dateInput.disabled = true;
        dateInput.classList.add('bg-gray-100');
        saveBtn.disabled = true;
        saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
        saveBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

        showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success');
      } else {
        showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .saveClaimReceipt(JSON.stringify(receiptData));
}

function saveReceipt(productId) {
  const row = document.getElementById(`claim-row-${productId}`);
  const receivedInput = row.querySelector('.received-quantity-input');
  const dateInput = row.querySelector('.received-date-input');
  const saveBtn = row.querySelector('.receipt-save-btn');
  
  const receivedQty = parseInt(receivedInput.value) || 0;
  const receivedDate = dateInput.value;
  
  if (receivedQty <= 0) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤', 'error');
    return;
  }
  
  if (!receivedDate) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á', 'error');
    return;
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏°
  const item = claimItems.find(i => i.productId === productId);
  if (item && receivedQty !== item.claimableQuantity) {
    const message = receivedQty > item.claimableQuantity 
      ? `‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏° (${receivedQty} > ${item.claimableQuantity}) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Supplier ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô`
      : `‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏° (${receivedQty} < ${item.claimableQuantity}) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Supplier ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`;
    
    showCustomAlert('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', message, 'info');
  }
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó state
  if (item) {
    item.receivedQuantity = receivedQty;
    item.receivedDate = receivedDate;
    item.receiptStatus = 'received';
  }
  
  // ‡∏•‡πá‡∏≠‡∏Ñ input ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°
  receivedInput.disabled = true;
  receivedInput.classList.add('bg-gray-100');
  dateInput.disabled = true;
  dateInput.classList.add('bg-gray-100');
  saveBtn.disabled = true;
  saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
  saveBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
  saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
  
  showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á ${receivedQty} ‡∏ä‡∏¥‡πâ‡∏ô ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date(receivedDate).toLocaleDateString('th-TH')} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
}
                    
            function showAddProductControls() {
                const controls = document.getElementById('add-product-controls');
                controls.classList.toggle('hidden');
                if (!controls.classList.contains('hidden')) {
                    const supplierSelect = document.getElementById('new-supplier-select');
                    if (supplierSelect.options.length <= 1) {
                        let supplierOptions = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå</option>';
                        SUPPLIERS.forEach(s => {
                            supplierOptions += `<option value="${s.id}">${s.name}</option>`;
                        });
                        supplierSelect.innerHTML = supplierOptions;
                    }
                }
            }

                    function updateNewProductDropdown() {
                const supplierId = document.getElementById('new-supplier-select').value;
                const productDropdown = document.getElementById('new-product-select');
                productDropdown.innerHTML = '<option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
                if (supplierId) {
                    google.script.run.withSuccessHandler(products => {
                        productDropdown.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>';
                        products.forEach(p => {
                            productDropdown.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                        });
                    }).withFailureHandler(handleError).getProductsBySupplier(supplierId);
                } else {
                    productDropdown.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>';
                }
            }



      function addCancellationRowForVerification() {
        const container = document.getElementById('verify-cancellation-rows-container');
        const rowDiv = document.createElement('div');
        rowDiv.className = 'p-3 border rounded-lg grid grid-cols-1 md:grid-cols-3 gap-4 items-center bg-gray-50 relative verify-cancellation-row';

        let verifyEmployeeOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ --</option>';
        BRANCH_EMPLOYEES.forEach(emp => {
          verifyEmployeeOptions += `<option value="${emp.name}">${emp.name}</option>`;
        });

        rowDiv.innerHTML = `
          <div>
            <label class="text-xs">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</label>
            <input type="text" class="verify-cancel-bill-number mt-1 w-full text-sm rounded-md">
          </div>
          <div>
            <label class="text-xs">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label>
            <input type="text" list="cancellation-reasons" class="verify-cancel-reason mt-1 w-full text-sm rounded-md">
          </div>
          <div>
            <label class="text-xs">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
            <input type="number" class="verify-cancel-amount mt-1 w-full text-sm rounded-md">
          </div>
          <div>
            <label class="text-xs">‡∏ú‡∏π‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</label>
            <input type="text" list="cancel-employee-list-${itemRowCounter}" class="verify-cancel-by-name mt-1 block w-full text-sm rounded-md border-gray-300" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠">
            <datalist id="cancel-employee-list-${itemRowCounter}">${verifyEmployeeOptions}</datalist>
          </div>
          <button onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">&times;</button>
        `;
        container.appendChild(rowDiv);
      }



            // --- STOCK OVERVIEW MODULE (OFFICE) ---

            function showStockOverviewModule() {
                document.getElementById('header-title').innerText = '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å';
                const appContainer = document.getElementById('app-container');

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á options ‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà user ‡∏î‡∏π‡πÅ‡∏•
                let branchOptions = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';
                const managedBranchIds = USER_DETAILS.branchesManaged;
                ALL_BRANCHES.forEach(b => {
                    if (managedBranchIds.includes(String(b.id))) {
                        branchOptions += `<option value="${b.id}">${b.name}</option>`;
                    }
                });

                appContainer.innerHTML = `
                    <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">
                        <button onclick="showDashboard()" class="mb-4 text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-medium">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                                <select id="stock-branch-select" onchange="handleStockSearch()" class="mt-1 w-full rounded-md">${branchOptions}</select>
                            </div>
                        </div>
                        <div id="stock-table-container">
                            <p class="text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
                        </div>
                    </div>`;
            }

            function handleStockSearch() {
                const branchId = document.getElementById('stock-branch-select').value;
                const tableContainer = document.getElementById('stock-table-container');

                if (!branchId) {
                    tableContainer.innerHTML = '<p class="text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>';
                    return;
                }

                showLoading();
                tableContainer.innerHTML = '<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å...</p>';
                google.script.run
                    .withSuccessHandler(responseString => {
                        const result = JSON.parse(responseString);
                        if (result.status === 'success') {
                            renderStockTable(result.data);
                        } else {
                            handleError({ message: result.message });
                        }
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .getStockOverview(branchId);
            }

            function renderStockTable(data) {
                const tableContainer = document.getElementById('stock-table-container');
                if (data.length === 0) {
                    tableContainer.innerHTML = '<p class="text-center text-gray-600 bg-yellow-100 p-4 rounded-md">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ</p>';
                    return;
                }

                const groupedBySupplier = data.reduce((acc, item) => {
                    const supplier = item.supplierName || 'Uncategorized';
                    if (!acc[supplier]) {
                        acc[supplier] = [];
                    }
                    acc[supplier].push(item);
                    return acc;
                }, {});

                let html = '<div class="space-y-8">';

                const sortedSuppliers = Object.keys(groupedBySupplier).sort();

                for (const supplierName of sortedSuppliers) {
                    html += `
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">${supplierName}</h3>
                            <div class="overflow-x-auto border rounded-lg">

                                <table class="min-w-full divide-y divide-gray-200 table-fixed">
                                    <thead class="bg-gray-50">
                                        <tr>

                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[20%]">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[40%]">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-[15%]">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[25%]">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">`;

                    groupedBySupplier[supplierName].sort((a,b) => a.productName.localeCompare(b.productName)).forEach(item => {
                        html += `
                            <tr>

                                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-left">${item.productId}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-left">${item.productName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-center">${item.currentStock}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-left">${item.lastUpdate}</td>
                            </tr>`;
                    });

                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                }

                html += '</div>';
                tableContainer.innerHTML = html;
            }

            function fetchAndDisplayPreviousData(rowId) {
                const productDropdown = document.getElementById(`verify-product-${rowId}`);
                const productId = productDropdown.value;
                const container = document.querySelector(`#verify-item-row-${rowId} .previous-data-container`);

                if (!productId) {
                    container.innerHTML = ''; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡πá‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á
                    return;
                }

                const modalDiv = document.querySelector('#verification-modal > div');
                const branchId = modalDiv.dataset.branchId;
                const reportDate = modalDiv.dataset.reportDate;

                container.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';

                google.script.run
                    .withSuccessHandler(responseString => {
                        const result = JSON.parse(responseString);
                        if (result.status === 'success' && result.data) {
                            const prev = result.data;
                            const prevDate = new Date(prev.reportDate).toLocaleDateString('th-TH');

                            const previousDataHtml = `
                                <div class="pt-2 mt-2 border-t border-dashed">
                                    <div class="text-xs text-gray-500 mb-1"><span class="font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (${prevDate}):</span></div>
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                        <div><label class="text-xs text-gray-500">‡∏Ç‡∏≤‡∏¢</label><input type="number" value="${prev.salesQuantity||0}" class="mt-1 w-full text-sm rounded-md bg-gray-200" disabled></div>
                                        <div><label class="text-xs text-gray-500">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</label><input type="number" value="${prev.receivedQuantity||0}" class="mt-1 w-full text-sm rounded-md bg-gray-200" disabled></div>
                                        <div><label class="text-xs text-gray-500">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="number" value="${prev.expiredQuantity||0}" class="mt-1 w-full text-sm rounded-md bg-gray-200" disabled></div>
                                        <div><label class="text-xs text-gray-500">‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Ø</label><input type="number" value="${prev.currentStock||0}" class="mt-1 w-full text-sm rounded-md bg-gray-200 font-bold" disabled></div>
                                        <div><label class="text-xs text-gray-500">‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤</label><input type="number" value="${prev.transferredQuantity||0}" class="mt-1 w-full text-sm rounded-md bg-gray-200" disabled></div>
                                    </div>
                                    <div class="${(prev.transferredQuantity > 0) ? '' : 'hidden'} pt-2"><label class="text-xs text-gray-500">‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏™‡∏≤‡∏Ç‡∏≤</label><select class="mt-1 block w-full text-sm rounded-md bg-gray-200" disabled><option>${prev.toBranchName||'N/A'}</option></select></div>
                                </div>`;
                            container.innerHTML = previousDataHtml;
                        } else {
                            container.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>';
                        }
                    })
                    .withFailureHandler(error => {
                        container.innerHTML = `<p class="text-xs text-red-500 text-center py-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
                    })
                    .getPreviousItemData(productId, branchId, reportDate);
            }


            // --- ONLINE RECONCILIATION MODULE (OFFICE) ---

            let ONLINE_CHANNELS = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå

            function showReconciliationModule() {
                document.getElementById('header-title').innerText = '‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
                const appContainer = document.getElementById('app-container');
                appContainer.innerHTML = `<div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6"><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á...</p></div>`;

                if (ONLINE_CHANNELS.length === 0) {
                    google.script.run.withSuccessHandler(channels => {
                        ONLINE_CHANNELS = channels;
                        renderReconciliationModule();
                    }).withFailureHandler(handleError).getOnlinePaymentChannels();
                } else {
                    renderReconciliationModule();
                }
            }

            function renderReconciliationModule() {
                const appContainer = document.getElementById('app-container');
                let channelOptions = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á --</option>';
                ONLINE_CHANNELS.forEach(c => { channelOptions += `<option value="${c.id}">${c.name}</option>`; });

                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const todayFormatted = today.toISOString().split('T')[0];

                appContainer.innerHTML = `
                    <div class="max-w-full mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">
                        <button onclick="showDashboard()" class="text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                        <div class="space-y-4 p-4 border rounded-lg bg-gray-50">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label class="block text-sm font-medium">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                                    <select id="recon-channel" class="mt-1 w-full rounded-md">${channelOptions}</select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <input type="date" id="recon-start-date" value="${firstDayOfMonth}" class="mt-1 w-full rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <input type="date" id="recon-end-date" value="${todayFormatted}" class="mt-1 w-full rounded-md">
                                </div>
                                <button onclick="handleReconciliationSearch()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                            </div>
                        </div>
                        <div id="recon-table-container"></div>
                    </div>`;
            }

            function handleReconciliationSearch() {
                const startDate = document.getElementById('recon-start-date').value;
                const endDate = document.getElementById('recon-end-date').value;

                if (!startDate || !endDate) {
                    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                    return;
                }

                showLoading();
                const tableContainer = document.getElementById('recon-table-container');
                tableContainer.innerHTML = '<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢...</p>';

                google.script.run
                    .withSuccessHandler(responseString => {
                        const result = JSON.parse(responseString);
                        if (result.status === 'error') {
                            handleError({ message: result.message });
                            return;
                        }
                        renderReconciliationTable(result.data);
                        hideLoading();
                    })
                    .withFailureHandler(handleError)
                    .getReconciliationData(startDate, endDate);
            }

            function renderReconciliationTable(data) {
                const tableContainer = document.getElementById('recon-table-container');
                const selectedChannelId = document.getElementById('recon-channel').value;
                const filteredData = selectedChannelId ? data.filter(d => d.channelId === selectedChannelId) : data;

                if (filteredData.length === 0) {
                    tableContainer.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                    return;
                }

                const dataByBranch = filteredData.reduce((acc, item) => {
                    const branchName = ALL_BRANCHES.find(b => b.id == item.branchId)?.name || `‡∏™‡∏≤‡∏Ç‡∏≤ ${item.branchId}`;
                    if (!acc[branchName]) acc[branchName] = [];
                    acc[branchName].push(item);
                    return acc;
                }, {});

                let finalHtml = '<div class="space-y-8">';

                for (const branchName in dataByBranch) {
                    finalHtml += `
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${branchName}</h3>
                            <div class="overflow-x-auto border rounded-lg">
                                <table class="min-w-full text-sm">
                                    <thead class="bg-gray-50 text-xs">
                                        <tr>
                                            <th class="px-2 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                            ${!selectedChannelId ? '<th class="px-2 py-2 text-left">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>' : ''}
                                            <th class="px-2 py-2 text-right">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                                            <th class="px-2 py-2 text-center bg-cyan-100">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (GP)</th>
                                            <th class="px-2 py-2 text-right">VAT 7%</th>
                                            <th class="px-2 py-2 text-right">‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏Å</th>
                                            <th class="px-2 py-2 text-right">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡πÑ‡∏ß‡πâ</th>
                                            <th class="px-2 py-2 text-center bg-cyan-100">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤</th>
                                            <th class="px-2 py-2 text-center bg-cyan-100">‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á</th>
                                            <th class="px-2 py-2 text-right">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th>
                                            <th class="px-2 py-2 text-left bg-cyan-100">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                            <th class="px-2 py-2 text-center">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">`;

                    dataByBranch[branchName].sort((a,b) => new Date(a.dateOfSale) - new Date(b.dateOfSale) || a.channelName.localeCompare(b.channelName)).forEach(item => {
                        const rowId = `${item.branchId}-${item.channelId}-${item.dateOfSale}`;
                        const isSaved = item.actualDeposit || item.fee;
                        const disabledAttr = isSaved ? 'disabled' : '';
                        const buttonClass = isSaved ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700';
                        const buttonText = isSaved ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

                        finalHtml += `
                            <tr id="recon-row-${rowId}" class="recon-data-row" data-gross-sales="${item.grossSales}" data-is-vat-on-fee="${item.isVatOnFee}" data-branch-id="${item.branchId}" data-channel-id="${item.channelId}" data-date-of-sale="${item.dateOfSale}">
                                <td class="px-2 py-1 whitespace-nowrap">${new Date(item.dateOfSale).toLocaleDateString('th-TH', {day: '2-digit', month: '2-digit', year: '2-digit'})}</td>
                                ${!selectedChannelId ? `<td class="px-2 py-1 whitespace-nowrap">${item.channelName}</td>` : ''}
                                <td class="px-2 py-1 text-right bg-gray-100">${item.grossSales.toFixed(2)}</td>

                                <td class="px-2 py-1 w-28 bg-cyan-50"><input type="number" class="recon-fee w-full rounded-md border-gray-300 text-right text-sm p-1" value="${item.fee || ''}" oninput="updateReconciliationRow('${rowId}')" ${disabledAttr}></td>
                                <td class="px-2 py-1 text-right text-red-500 bg-gray-100 recon-vat">-</td>
                                <td class="px-2 py-1 text-right text-red-600 font-semibold bg-gray-100 recon-total-deduction">-</td>
                                <td class="px-2 py-1 text-right text-blue-600 font-bold bg-gray-100 recon-expected-net">-</td>
                                <td class="px-2 py-1 w-36 bg-cyan-50"><input type="date" class="recon-deposit-date w-full rounded-md border-gray-300 text-sm p-1" value="${item.depositDate}" ${disabledAttr}></td>
                                <td class="px-2 py-1 w-28 bg-cyan-50"><input type="number" class="recon-actual-deposit w-full rounded-md border-gray-300 text-right text-sm p-1" value="${item.actualDeposit}" oninput="updateReconciliationRow('${rowId}')" ${disabledAttr}></td>
                                <td class="px-2 py-1 text-right font-bold text-gray-500 bg-gray-100 recon-difference">-</td>
                                <td class="px-2 py-1 w-36 bg-cyan-50"><input type="text" class="recon-note w-full rounded-md border-gray-300 text-sm p-1" value="${item.note}" ${disabledAttr}></td>
                                <td class="px-2 py-1 text-center">
                                    <button id="save-btn-${rowId}" onclick="handleSaveSingleReconRow('${rowId}')" class="text-white font-bold py-1 px-3 rounded-md text-xs ${buttonClass}" ${disabledAttr}>
                                        ${buttonText}
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    finalHtml += `</tbody></table></div></div>`;
                }

                finalHtml += `</div>`;
                tableContainer.innerHTML = finalHtml;

                document.querySelectorAll('.recon-data-row').forEach(row => {
                    const rowId = row.id.replace('recon-row-', '');
                    if (row.querySelector('.recon-fee').value) {
                        updateReconciliationRow(rowId);
                    }
                });
            }



            /**
             * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß
             * (‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleSaveReconciliation ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏¥‡πâ‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô)
             */
            function handleSaveSingleReconRow(rowId) {
                const row = document.getElementById(`recon-row-${rowId}`);
                const saveButton = document.getElementById(`save-btn-${rowId}`);

                const feeInput = row.querySelector('.recon-fee');
                const depositDateInput = row.querySelector('.recon-deposit-date');
                const actualDepositInput = row.querySelector('.recon-actual-deposit');

                // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
                if (!feeInput.value || !depositDateInput.value || !actualDepositInput.value) {
                    showCustomAlert(
                        '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                        '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤", ‡πÅ‡∏•‡∏∞ "‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                        'error'
                    );
                    return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                }
                // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

                const itemToSave = {
                    branchId: row.dataset.branchId,
                    channelId: row.dataset.channelId,
                    dateOfSale: row.dataset.dateOfSale,
                    depositDate: depositDateInput.value,
                    actualDeposit: parseFloat(actualDepositInput.value) || null,
                    note: row.querySelector('.recon-note').value,
                    fee: parseFloat(feeInput.value) || null
                };

                saveButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                saveButton.disabled = true;

                google.script.run
                    .withSuccessHandler(response => {
                        const result = JSON.parse(response);
                        if (result.status === 'success') {
                            showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                            row.querySelectorAll('input').forEach(input => input.disabled = true);
                            saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
                            saveButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                            saveButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                        } else {
                            showCustomAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error');
                            saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                            saveButton.disabled = false;
                        }
                    })
                    .withFailureHandler(error => {
                        handleError(error);
                        saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                        saveButton.disabled = false;
                    })
                    .saveReconciliationData(JSON.stringify(itemToSave));
            }




            function updateReconciliationRow(rowId) {
                const row = document.getElementById(`recon-row-${rowId}`);
                const grossSales = parseFloat(row.dataset.grossSales);
                const isVatOnFee = row.dataset.isVatOnFee === 'true';

                const feeInput = row.querySelector('.recon-fee');
                const actualDepositInput = row.querySelector('.recon-actual-deposit');

                const vatCell = row.querySelector('.recon-vat');
                const totalDeductionCell = row.querySelector('.recon-total-deduction');
                const expectedNetCell = row.querySelector('.recon-expected-net');
                const differenceCell = row.querySelector('.recon-difference');

                const fee = parseFloat(feeInput.value) || 0;
                const actualDeposit = parseFloat(actualDepositInput.value);

                const vat = isVatOnFee ? fee * 0.07 : 0;
                const totalDeduction = fee + vat;
                const expectedNet = grossSales - totalDeduction;

                vatCell.textContent = vat.toFixed(2);
                totalDeductionCell.textContent = totalDeduction.toFixed(2);
                expectedNetCell.textContent = expectedNet.toFixed(2);

                if (isNaN(actualDeposit)) {
                    differenceCell.textContent = '-';
                    differenceCell.className = 'px-2 py-1 text-right font-bold text-gray-500 recon-difference';
                    return;
                }

                const difference = actualDeposit - expectedNet;
                differenceCell.textContent = difference.toFixed(2);
                if (Math.abs(difference) < 0.01) { // ‡πÉ‡∏ä‡πâ Math.abs ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
                    differenceCell.className = 'px-2 py-1 text-right font-bold text-green-600 recon-difference';
                } else {
                    differenceCell.className = 'px-2 py-1 text-right font-bold text-red-600 recon-difference';
                }
            }

            function handleSaveReconciliation() {
                const rows = document.querySelectorAll('.recon-data-row');
                const dataToSave = [];
                rows.forEach(row => {
                    const fee = row.querySelector('.recon-fee').value;
                    const actualDeposit = row.querySelector('.recon-actual-deposit').value;

                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á
                    if (fee || actualDeposit) {
                        dataToSave.push({
                            branchId: row.dataset.branchId,
                            channelId: row.dataset.channelId,
                            dateOfSale: row.dataset.dateOfSale,
                            depositDate: row.querySelector('.recon-deposit-date').value,
                            actualDeposit: parseFloat(actualDeposit) || null,
                            note: row.querySelector('.recon-note').value,
                            fee: parseFloat(fee) || null
                        });
                    }
                });

                if (dataToSave.length === 0) {
                    showCustomAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á" ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'info');
                    return;
                }

                showCustomConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î ${dataToSave.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => {
                    showLoading();
                    google.script.run
                        .withSuccessHandler(response => {
                            const result = JSON.parse(response);
                            hideLoading();
                            showCustomAlert(result.status === 'success' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, result.status);
                        })
                        .withFailureHandler(handleError)
                        .saveReconciliationData(JSON.stringify(dataToSave));
                });
            }




            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
function calculateProductTotals() {
    let totalUnits = 0;
    let totalAmount = 0;
    
    reportItems.forEach(item => {
        const qty = parseFloat(item.salesQuantity) || 0;
        const price = parseFloat(item.price) || 0;
        totalUnits += qty;
        totalAmount += qty * price;
    });
    
    const container = document.getElementById('product-totals');
    if (container) {
        container.innerHTML = `
            <div class="mt-4 p-3 border-t-2 border-dashed text-right font-bold">
                <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalUnits}</span> ‡∏ä‡∏¥‡πâ‡∏ô</span> | 
                <span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span>
            </div>`;
    }
    return totalAmount;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Add-on
function calculateAddOnTotals() {
    const addon10 = parseFloat(document.getElementById('addon-10')?.value) || 0;
    const addon15 = parseFloat(document.getElementById('addon-15')?.value) || 0;
    const total = addon10 + addon15;
    
    const container = document.getElementById('addon-totals');
    if (container) {
        container.innerHTML = `
            <div class="mt-4 p-3 border-t-2 border-dashed text-right font-bold">
                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°: <span class="text-cyan-700">${total.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span>
            </div>`;
    }
    return total;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
function calculateCashAmount() {
    let totalSales = calculateProductTotals() + calculateAddOnTotals();
    // ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°
    document.querySelectorAll('.drink-category-sales-input').forEach(input => {
        totalSales += parseFloat(input.value) || 0;
    });
    
    // ‡∏´‡∏±‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
    let onlineTotal = 0;
    PAYMENT_TYPES.forEach(pt => {
        if (pt.name !== '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
            const value = parseFloat(document.getElementById(`payment-${pt.id}`)?.value) || 0;
            
            onlineTotal += value;
        }
    });
    
    // ‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
    let discountTotal = 0;
    document.querySelectorAll('.discount-summary-input').forEach(input => {
        discountTotal += parseFloat(input.value) || 0;
    });
    
    const cashAmount = totalSales - onlineTotal - discountTotal;
    const cashPayment = PAYMENT_TYPES.find(pt => pt.name === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î');
    if (cashPayment) {
        const cashInput = document.getElementById(`payment-${cashPayment.id}`);
        if (cashInput) {
            cashInput.value = Math.max(0, cashAmount).toFixed(2);
            updateTotals('payment');

        }
    }
}


function calculateVerificationAddOnTotals() {
    const addon10 = parseFloat(document.getElementById('verify-addon-10')?.value) || 0;
    const addon15 = parseFloat(document.getElementById('verify-addon-15')?.value) || 0;
    const total = addon10 + addon15;
    
    const container = document.getElementById('verify-addon-totals');
    if (container) {
        container.innerHTML = `
            <div class="mt-4 p-3 border-t-2 border-dashed text-right font-bold">
                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°: <span class="text-cyan-700">${total.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span>
            </div>`;
    }
    return total;
}


function calculateVerificationProductTotals() {
    let totalUnits = 0;
    let totalAmount = 0;
    
    verificationReportItems.forEach(item => {
        const qty = parseFloat(item.salesQuantity) || 0;
        const price = parseFloat(item.price) || 0;
        totalUnits += qty;
        totalAmount += qty * price;
    });
    
    const container = document.getElementById('verify-product-totals');
    if (container) {
        container.innerHTML = totalUnits > 0 ? `
            <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalUnits}</span> ‡∏ä‡∏¥‡πâ‡∏ô</span> | 
            <span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <span class="text-cyan-700">${totalAmount.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span>
        ` : '';
    }
    return totalAmount;
}

function calculateVerificationCashAmount() {
    let totalSales = calculateVerificationProductTotals() + calculateVerificationAddOnTotals();
    
    document.querySelectorAll('.verify-drink-sales-input').forEach(input => {
        totalSales += parseFloat(input.value) || 0;
    });
    
    let onlineTotal = 0;
    PAYMENT_TYPES.forEach(pt => {
        if (pt.name !== '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
            const input = document.querySelector(`.verify-payment-summary-input[data-type-id="${pt.id}"]`);
            if (input) {
                onlineTotal += parseFloat(input.value) || 0;
            }
        }
    });
    
    let discountTotal = 0;
    document.querySelectorAll('.verify-discount-summary-input').forEach(input => {
        discountTotal += parseFloat(input.value) || 0;
    });
    
    const cashAmount = totalSales - onlineTotal - discountTotal;
    const cashPayment = PAYMENT_TYPES.find(pt => pt.name === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î');
    
    if (cashPayment) {
        const cashInput = document.querySelector(`.verify-payment-summary-input[data-type-id="${cashPayment.id}"]`);
        if (cashInput) {
            cashInput.value = Math.max(0, cashAmount).toFixed(2);
            updateVerificationTotals('payment');
        }
    }
}

// ==================== COMPARISON DASHBOARD ====================

function showComparisonDashboard() {
    document.getElementById('header-title').innerText = '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤';
    const appContainer = document.getElementById('app-container');
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° branch options ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    const isOffice = USER_DETAILS.role === '‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®';
    const isFront = USER_DETAILS.role === '‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô';
    
    let branchCheckboxes = '';
    
    if (isOffice) {
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•
        USER_DETAILS.branchesManaged.forEach(branchId => {
            const branch = ALL_BRANCHES.find(b => b.id === branchId);
            if (branch) {
                const color = BRANCH_COLORS[branchId] || '#999';
                branchCheckboxes += `
                    <label class="flex items-center mb-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                        <input type="checkbox" value="${branchId}" class="comparison-branch-checkbox mr-2" 
                               onchange="updateComparisonCharts()">
                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span>
                        <span class="text-sm">${branch.name}</span>
                    </label>`;
            }
        });
    } else if (isFront) {
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
        const branch = ALL_BRANCHES.find(b => b.id === USER_DETAILS.branchIdAssigned);
        if (branch) {
            const color = BRANCH_COLORS[USER_DETAILS.branchIdAssigned] || '#999';
            branchCheckboxes = `
                <label class="flex items-center mb-2 p-1">
                    <input type="checkbox" value="${USER_DETAILS.branchIdAssigned}" 
                           class="comparison-branch-checkbox mr-2" checked disabled>
                    <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span>
                    <span class="text-sm">${branch.name}</span>
                </label>
                <p class="text-xs text-gray-500 mt-2">* ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</p>`;
        }
    }
    
    // Default dates
    const today = new Date();
    const sevenDaysAgo = new Date(today);
    sevenDaysAgo.setDate(today.getDate() - 6);
    
    const todayStr = today.toISOString().split('T')[0];
    const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
    
    appContainer.innerHTML = `
        <div class="max-w-7xl mx-auto space-y-6">
            <button onclick="showDashboard()" class="text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
            
            <!-- Filter Bar -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <!-- Branch Selection -->
                    <div class="md:col-span-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <div class="border rounded-lg p-3 max-h-40 overflow-y-auto">
                            ${branchCheckboxes}
                        </div>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <div class="flex gap-2">
                            <button onclick="setComparisonDateRange(7)" 
                                    class="comparison-preset-btn px-3 py-2 bg-blue-600 text-white rounded text-sm">
                                7 ‡∏ß‡∏±‡∏ô
                            </button>
                            <button onclick="setComparisonDateRange('thisWeek')" 
                                    class="comparison-preset-btn px-3 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">
                                ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ
                            </button>
                            <button onclick="setComparisonDateRange('thisMonth')" 
                                    class="comparison-preset-btn px-3 py-2 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">
                                ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                            </button>
                        </div>
                    </div>
                    
                    <!-- Custom Date -->
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</label>
                        <div class="flex gap-2 items-center">
                            <input type="date" id="comparison-start-date" value="${sevenDaysAgoStr}" 
                                   class="border rounded px-2 py-1 text-sm flex-1">
                            <span class="text-sm">‡∏ñ‡∏∂‡∏á</span>
                            <input type="date" id="comparison-end-date" value="${todayStr}" 
                                   class="border rounded px-2 py-1 text-sm flex-1">
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="md:col-span-2 flex gap-2">
                        <button onclick="loadComparisonData()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium flex-1">
                            ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button onclick="exportComparisonData()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium"
                                id="comparison-export-btn" disabled>
                            Export
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div id="comparison-summary-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${createComparisonSkeletonCards()}
            </div>
            
            <!-- Charts Container -->
            <div id="comparison-charts-container" class="space-y-6">
                ${createComparisonSkeletonCharts()}
            </div>
            
            <!-- Ranking Table -->
            <div id="comparison-ranking-container" class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h3>
                <div class="skeleton h-40 rounded"></div>
            </div>
        </div>
    `;
    
    // Auto-select first branch for office users
    if (isOffice) {
        const firstCheckbox = document.querySelector('.comparison-branch-checkbox');
        if (firstCheckbox) {
            firstCheckbox.checked = true;
        }
    }
    
    // Auto-load data
    setTimeout(loadComparisonData, 500);
}

// Chart instances storage
let comparisonCharts = {
    drink: null,
    freshBakery: null,
    dryBakery: null,
    revenue: null
};

function createComparisonSkeletonCards() {
    const cards = ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î', '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á', '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°'];
    return cards.map(title => `
        <div class="bg-white rounded-lg shadow p-4">
            <div class="skeleton h-4 w-24 mb-2 rounded"></div>
            <div class="skeleton h-8 w-32 mb-2 rounded"></div>
            <div class="skeleton h-3 w-28 rounded"></div>
        </div>
    `).join('');
}

function createComparisonSkeletonCharts() {
    const charts = ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î', '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á', '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°'];
    return charts.map(title => `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="skeleton h-6 w-48 mb-4 rounded"></div>
            <div class="skeleton h-64 w-full rounded"></div>
        </div>
    `).join('');
}

function setComparisonDateRange(range) {
    const startDate = document.getElementById('comparison-start-date');
    const endDate = document.getElementById('comparison-end-date');
    const today = new Date();
    
    // Reset preset buttons
    document.querySelectorAll('.comparison-preset-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    if (range === 7) {
        const start = new Date(today);
        start.setDate(today.getDate() - 6);
        startDate.value = start.toISOString().split('T')[0];
        endDate.value = today.toISOString().split('T')[0];
        event.target.classList.remove('bg-gray-200', 'text-gray-700');
        event.target.classList.add('bg-blue-600', 'text-white');
    } else if (range === 'thisWeek') {
        const start = new Date(today);
        start.setDate(today.getDate() - today.getDay());
        startDate.value = start.toISOString().split('T')[0];
        endDate.value = today.toISOString().split('T')[0];
        event.target.classList.remove('bg-gray-200', 'text-gray-700');
        event.target.classList.add('bg-blue-600', 'text-white');
    } else if (range === 'thisMonth') {
        const start = new Date(today.getFullYear(), today.getMonth(), 1);
        startDate.value = start.toISOString().split('T')[0];
        endDate.value = today.toISOString().split('T')[0];
        event.target.classList.remove('bg-gray-200', 'text-gray-700');
        event.target.classList.add('bg-blue-600', 'text-white');
    }
}

function loadComparisonData() {
    // Get selected branches
    const selectedBranches = [];
    document.querySelectorAll('.comparison-branch-checkbox:checked').forEach(cb => {
        selectedBranches.push(cb.value);
    });
    
    if (selectedBranches.length === 0) {
        showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        return;
    }
    
    const startDate = document.getElementById('comparison-start-date').value;
    const endDate = document.getElementById('comparison-end-date').value;
    
    if (!startDate || !endDate) {
        showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        return;
    }
    
    showLoading();
    
    // Show skeletons
    document.getElementById('comparison-summary-cards').innerHTML = createComparisonSkeletonCards();
    document.getElementById('comparison-charts-container').innerHTML = createComparisonSkeletonCharts();
    
    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            
            if (result.status === 'success') {
                renderComparisonDashboard(result.data);
                document.getElementById('comparison-export-btn').disabled = false;
            } else {
                showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error');
            }
            
            hideLoading();
        })
        .withFailureHandler(error => {
            handleError(error);
            hideLoading();
        })
        .getComparisonData(selectedBranches, startDate, endDate);
}

function renderComparisonDashboard(data) {
    // Render summary cards
    renderComparisonSummaryCards(data);
    
    // Render charts
    renderComparisonCharts(data);
    
    // Render ranking table
    renderComparisonRankingTable(data);
}

function renderComparisonSummaryCards(data) {
    const container = document.getElementById('comparison-summary-cards');
    const totals = calculateComparisonTotals(data.summary);
    const growthTotals = calculateAverageGrowth(data.growthRates);
    
    container.innerHTML = `
        <!-- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° -->
        <div class="bg-blue-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</h3>
                <span class="text-2xl">‚òï</span>
            </div>
            <p class="text-2xl font-bold text-blue-600">${totals.drinkUnits.toLocaleString()} ‡πÅ‡∏Å‡πâ‡∏ß</p>
            <p class="text-sm ${growthTotals.drinkUnits >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${growthTotals.drinkUnits >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(growthTotals.drinkUnits)}% ‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            </p>
        </div>
        
        <!-- ‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î -->
        <div class="bg-green-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î</h3>
                <span class="text-2xl">ü•ê</span>
            </div>
            <p class="text-2xl font-bold text-green-600">${totals.freshBakeryUnits.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô</p>
            <p class="text-sm ${growthTotals.freshBakeryUnits >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${growthTotals.freshBakeryUnits >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(growthTotals.freshBakeryUnits)}% ‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            </p>
        </div>
        
        <!-- ‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á -->
        <div class="bg-yellow-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á</h3>
                <span class="text-2xl">üç™</span>
            </div>
            <p class="text-2xl font-bold text-yellow-600">${totals.dryBakeryUnits.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô</p>
            <p class="text-sm ${growthTotals.dryBakeryUnits >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${growthTotals.dryBakeryUnits >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(growthTotals.dryBakeryUnits)}% ‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            </p>
        </div>
        
        <!-- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° -->
        <div class="bg-purple-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-medium text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h3>
                <span class="text-2xl">üí∞</span>
            </div>
            <p class="text-2xl font-bold text-purple-600">${totals.totalRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
            <p class="text-sm ${growthTotals.totalRevenue >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${growthTotals.totalRevenue >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(growthTotals.totalRevenue)}% ‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            </p>
        </div>
    `;
}

function calculateComparisonTotals(summary) {
    const totals = {
        drinkUnits: 0,
        freshBakeryUnits: 0,
        dryBakeryUnits: 0,
        totalRevenue: 0
    };
    
    Object.values(summary).forEach(branch => {
        totals.drinkUnits += branch.drinkUnits;
        totals.freshBakeryUnits += branch.freshBakeryUnits;
        totals.dryBakeryUnits += branch.dryBakeryUnits;
        totals.totalRevenue += branch.totalRevenue;
    });
    
    return totals;
}

function calculateAverageGrowth(growthRates) {
    const branches = Object.keys(growthRates);
    if (branches.length === 0) return { drinkUnits: 0, freshBakeryUnits: 0, dryBakeryUnits: 0, totalRevenue: 0 };
    
    const totals = {
        drinkUnits: 0,
        freshBakeryUnits: 0,
        dryBakeryUnits: 0,
        totalRevenue: 0
    };
    
    branches.forEach(branchId => {
        totals.drinkUnits += growthRates[branchId].drinkUnits;
        totals.freshBakeryUnits += growthRates[branchId].freshBakeryUnits;
        totals.dryBakeryUnits += growthRates[branchId].dryBakeryUnits;
        totals.totalRevenue += growthRates[branchId].totalRevenue;
    });
    
    return {
        drinkUnits: Math.round(totals.drinkUnits / branches.length * 10) / 10,
        freshBakeryUnits: Math.round(totals.freshBakeryUnits / branches.length * 10) / 10,
        dryBakeryUnits: Math.round(totals.dryBakeryUnits / branches.length * 10) / 10,
        totalRevenue: Math.round(totals.totalRevenue / branches.length * 10) / 10
    };
}

function renderComparisonCharts(data) {
    const container = document.getElementById('comparison-charts-container');
    
    container.innerHTML = `
        <!-- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° (‡πÅ‡∏Å‡πâ‡∏ß)</h3>
                <div id="drink-toggle-buttons" class="flex gap-2 flex-wrap"></div>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="comparison-drink-chart"></canvas>
            </div>
        </div>
        
        <!-- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏î (‡∏ä‡∏¥‡πâ‡∏ô)</h3>
                <div id="fresh-bakery-toggle-buttons" class="flex gap-2 flex-wrap"></div>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="comparison-fresh-bakery-chart"></canvas>
            </div>
        </div>
        
        <!-- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á (‡∏ä‡∏¥‡πâ‡∏ô)</h3>
                <div id="dry-bakery-toggle-buttons" class="flex gap-2 flex-wrap"></div>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="comparison-dry-bakery-chart"></canvas>
            </div>
        </div>
        
        <!-- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</h3>
                <div id="revenue-toggle-buttons" class="flex gap-2 flex-wrap"></div>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="comparison-revenue-chart"></canvas>
            </div>
        </div>
    `;
    
    // Wait for DOM
    setTimeout(() => {
        createComparisonLineCharts(data);
    }, 100);
}

function createComparisonLineCharts(data) {
    const { branchColors, branches, dateRange } = data;
    
    // Prepare datasets
    const datasets = {
        drink: [],
        freshBakery: [],
        dryBakery: [],
        revenue: []
    };
    
    // Create datasets for each branch
    Object.keys(data.data).forEach(branchId => {
        const branchName = branches[branchId] || `‡∏™‡∏≤‡∏Ç‡∏≤ ${branchId}`;
        const color = branchColors[branchId] || '#999';
        
        const branchData = data.data[branchId];
        
        // Prepare data for each date
        const drinkData = [];
        const freshBakeryData = [];
        const dryBakeryData = [];
        const revenueData = [];
        
        dateRange.forEach(date => {
            const dayData = branchData[date] || { drinkUnits: 0, freshBakeryUnits: 0, dryBakeryUnits: 0, totalRevenue: 0 };
            drinkData.push(dayData.drinkUnits);
            freshBakeryData.push(dayData.freshBakeryUnits);
            dryBakeryData.push(dayData.dryBakeryUnits);
            revenueData.push(dayData.totalRevenue);
        });
        
        // Add to datasets
        datasets.drink.push({
            label: branchName,
            data: drinkData,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.1,
            branchId: branchId
        });
        
        datasets.freshBakery.push({
            label: branchName,
            data: freshBakeryData,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.1,
            branchId: branchId
        });
        
        datasets.dryBakery.push({
            label: branchName,
            data: dryBakeryData,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.1,
            branchId: branchId
        });
        
        datasets.revenue.push({
            label: branchName,
            data: revenueData,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.1,
            branchId: branchId
        });
    });
    
    // Format labels
    const labels = dateRange.map(date => {
        const d = new Date(date);
        return d.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' });
    });
    
    // Create charts
    comparisonCharts.drink = createComparisonChart('comparison-drink-chart', labels, datasets.drink);
    comparisonCharts.freshBakery = createComparisonChart('comparison-fresh-bakery-chart', labels, datasets.freshBakery);
    comparisonCharts.dryBakery = createComparisonChart('comparison-dry-bakery-chart', labels, datasets.dryBakery);
    comparisonCharts.revenue = createComparisonChart('comparison-revenue-chart', labels, datasets.revenue, true);
    
    // Create toggle buttons
    createToggleButtons('drink-toggle-buttons', datasets.drink, 'drink');
    createToggleButtons('fresh-bakery-toggle-buttons', datasets.freshBakery, 'freshBakery');
    createToggleButtons('dry-bakery-toggle-buttons', datasets.dryBakery, 'dryBakery');
    createToggleButtons('revenue-toggle-buttons', datasets.revenue, 'revenue');
}

function createComparisonChart(canvasId, labels, datasets, isCurrency = false) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            
                            if (isCurrency) {
                                label += context.parsed.y.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
                            } else {
                                label += context.parsed.y.toLocaleString();
                            }
                            
                            return label;
                        }
                    }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function createToggleButtons(containerId, datasets, chartType) {
    const container = document.getElementById(containerId);
    
    datasets.forEach((dataset, index) => {
        const button = document.createElement('button');
        button.className = 'px-3 py-1 rounded text-xs transition-colors';
        button.style.backgroundColor = dataset.borderColor;
        button.style.color = 'white';
        button.textContent = dataset.label;
        button.dataset.branchId = dataset.branchId;
        button.dataset.datasetIndex = index;
        
        button.onclick = () => toggleDataset(chartType, index, button);
        
        container.appendChild(button);
    });
}

function toggleDataset(chartType, datasetIndex, button) {
    const chart = comparisonCharts[chartType];
    const dataset = chart.data.datasets[datasetIndex];
    
    dataset.hidden = !dataset.hidden;
    
    if (dataset.hidden) {
        button.style.opacity = '0.5';
    } else {
        button.style.opacity = '1';
    }
    
    chart.update();
}

function renderComparisonRankingTable(data) {
    const container = document.getElementById('comparison-ranking-container');
    
    // Calculate rankings
    const rankings = [];
    
    Object.entries(data.summary).forEach(([branchId, summary]) => {
        rankings.push({
            branchId: branchId,
            branchName: data.branches[branchId] || `‡∏™‡∏≤‡∏Ç‡∏≤ ${branchId}`,
            color: data.branchColors[branchId] || '#999',
            totalRevenue: summary.totalRevenue,
            growthRate: data.growthRates[branchId]?.totalRevenue || 0
        });
    });
    
    // Sort by revenue
    rankings.sort((a, b) => b.totalRevenue - a.totalRevenue);
    
    let tableHtml = `
        <h3 class="text-lg font-semibold mb-4">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-2">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                        <th class="text-left py-2">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                        <th class="text-right py-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                        <th class="text-right py-2">% ‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</th>
                        <th class="text-center py-2">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    rankings.forEach((branch, index) => {
        const growthIcon = branch.growthRate > 0 ? 'üìà' : branch.growthRate < 0 ? 'üìâ' : '‚û°Ô∏è';
        const growthClass = branch.growthRate > 0 ? 'text-green-600' : branch.growthRate < 0 ? 'text-red-600' : 'text-gray-600';
        
        tableHtml += `
            <tr class="border-b">
                <td class="py-2">${index + 1}</td>
                <td class="py-2">
                    <span class="inline-block w-3 h-3 rounded-full mr-2" 
                          style="background-color: ${branch.color}"></span>
                    ${branch.branchName}
                </td>
                <td class="text-right py-2">${branch.totalRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                <td class="text-right py-2 ${growthClass}">
                    ${branch.growthRate > 0 ? '+' : ''}${branch.growthRate}%
                </td>
                <td class="text-center py-2">${growthIcon}</td>
            </tr>
        `;
    });
    
    tableHtml += '</tbody></table></div>';
    
    container.innerHTML = tableHtml;
}

function updateComparisonCharts() {
    // This function is called when branch checkboxes change
    // For now, we'll require clicking the "‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" button
    // In future, could implement live updates
}

function exportComparisonData() {
    showCustomAlert('Coming Soon', '‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå Export ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ', 'info');
}

// ==================== TARGET MONITORING DASHBOARD ====================

function showTargetMonitoring() {
    document.getElementById('header-title').innerText = '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà';
    const appContainer = document.getElementById('app-container');
    
    appContainer.innerHTML = `
        <div class="max-w-7xl mx-auto space-y-6">
            <button onclick="showDashboard()" class="text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
            
            <!-- Header Info -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà</h2>
                        <p class="text-sm text-gray-600 mt-1">
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH', { 
                                day: 'numeric', 
                                month: 'long', 
                                year: 'numeric' 
                            })}
                        </p>
                    </div>


                    <button onclick="loadTargetMonitoringData()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>
                
                <!-- Legend -->
                <div class="mt-4 flex gap-4 text-sm">
                    <span class="flex items-center">
                        <span class="w-4 h-4 bg-green-100 border border-green-300 rounded mr-2"></span>
                        ‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤ (‚â•100%)
                    </span>
                    <span class="flex items-center">
                        <span class="w-4 h-4 bg-yellow-100 border border-yellow-300 rounded mr-2"></span>
                        ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤ (90-99%)
                    </span>
                    <span class="flex items-center">
                        <span class="w-4 h-4 bg-red-100 border border-red-300 rounded mr-2"></span>
                        ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤ (<90%)
                    </span>
                </div>

<div>
                        <h2 class="text-xl font-bold text-gray-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà</h2>
                        <p class="text-sm text-gray-600 mt-1">
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH', { 
                                day: 'numeric', 
                                month: 'long', 
                                year: 'numeric' 
                            })}
                        </p>
                    </div>



            </div>
            
            <!-- Table Container -->
            <div id="target-monitoring-table" class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-8 text-center text-gray-500">
                    <div class="spinner mx-auto mb-4"></div>
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                </div>
            </div>
            
            <!-- Summary Stats -->
            <div id="monitoring-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </div>
    `;
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    loadTargetMonitoringData();
}

function loadTargetMonitoringData() {
    showLoading();
    
    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            hideLoading();
            
            if (result.status === 'success') {
                renderTargetMonitoringTable(result.data);
                renderMonitoringSummary(result.data);
            } else {
                showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error');
            }
        })
        .withFailureHandler(error => {
            hideLoading();
            handleError(error);
        })
        .getTargetMonitoringData();
}

function renderTargetMonitoringTable(data) {
    const container = document.getElementById('target-monitoring-table');
    
    if (data.length === 0) {
        container.innerHTML = `
            <div class="p-8 text-center text-gray-500">
                ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
            </div>`;
        return;
    }
    
    let tableHtml = `
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ‡∏™‡∏≤‡∏Ç‡∏≤
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ<br>
    <span class="text-xs font-normal">(‡∏ä‡∏¥‡πâ‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</span>
</th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ<br>
    <span class="text-xs font-normal">(‡∏ä‡∏¥‡πâ‡∏ô/‡∏ß‡∏±‡∏ô)</span>
</th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ<br>
                        <span class="text-xs font-normal">(‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢)</span>
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">`;
    
    data.forEach(branch => {
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const rowClass = branch.status === 'achieved' ? 'bg-green-50' : 
                        branch.status === 'near' ? 'bg-yellow-50' : 'bg-red-50';
        
        const statusIcon = branch.status === 'achieved' ? 'üü¢' : 
                          branch.status === 'near' ? 'üü°' : 'üî¥';
        
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        const showTomorrow = branch.achievementPercent < 100 && 
                            branch.daysElapsed < branch.totalDays;
        const tomorrowDisplay = showTomorrow ? branch.tomorrowTarget : '-';
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° warning ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
        const isHighTarget = branch.tomorrowTarget > branch.targetDaily * 1.5;
        const tomorrowClass = isHighTarget ? 'text-red-600 font-bold' : '';
        
        tableHtml += `
            <tr class="${rowClass} hover:opacity-90 transition-opacity">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${branch.branchName}</div>
                </td>



                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm font-bold">${branch.monthTotal.toLocaleString()}</div>
                </td>

                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm">${Math.round(branch.currentAverage)}</div>
                </td>



                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm font-medium">${Math.round(branch.targetDaily)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="flex items-center justify-center">
                        <span class="mr-2">${statusIcon}</span>
                        <span class="text-sm font-medium">${branch.achievementPercent.toFixed(1)}%</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm ${tomorrowClass}">${tomorrowDisplay}</div>
                    ${isHighTarget && showTomorrow ? '<div class="text-xs text-red-500">‚ö†Ô∏è ‡∏™‡∏π‡∏á</div>' : ''}
                </td>
            </tr>`;
    });
    
    tableHtml += `
            </tbody>
        </table>`;
    
    container.innerHTML = tableHtml;
}

function renderMonitoringSummary(data) {
    const container = document.getElementById('monitoring-summary');
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    const stats = {
        achieved: data.filter(b => b.status === 'achieved').length,
        near: data.filter(b => b.status === 'near').length,
        below: data.filter(b => b.status === 'below').length,
        avgAchievement: data.reduce((sum, b) => sum + b.achievementPercent, 0) / data.length
    };
    
    container.innerHTML = `
        <!-- ‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤ -->
        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-green-800">‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤</p>
                    <p class="text-2xl font-bold text-green-600">${stats.achieved} ‡∏™‡∏≤‡∏Ç‡∏≤</p>
                </div>
                <span class="text-3xl">‚úÖ</span>
            </div>
        </div>
        
        <!-- ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤ -->
        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-yellow-800">‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤</p>
                    <p class="text-2xl font-bold text-yellow-600">${stats.near} ‡∏™‡∏≤‡∏Ç‡∏≤</p>
                </div>
                <span class="text-3xl">‚ö°</span>
            </div>
        </div>
        
        <!-- ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á -->
        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-red-800">‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</p>
                    <p class="text-2xl font-bold text-red-600">${stats.below} ‡∏™‡∏≤‡∏Ç‡∏≤</p>
                </div>
                <span class="text-3xl">üö®</span>
            </div>
        </div>`;
}
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function sortTargetTable(column) {
    // ‡∏à‡∏∞ implement ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
    console.log('Sort by:', column);
}


function calculateAddOnAmount(price) {
    const qtyInput = document.getElementById(`addon-${price}-qty`);
    const amountInput = document.getElementById(`addon-${price}`);
    
    let qty = parseInt(qtyInput.value) || 0;
    
    // Validate ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏•‡∏ö
    if (qty < 0) {
        qty = 0;
        qtyInput.value = 0;
    }
    
    const amount = qty * price;
    amountInput.value = amount > 0 ? amount.toFixed(2) : '';
    
    calculateAddOnTotals();
    calculateCashAmount();
}

function calculateAddOnTotals() {
    const addon5 = parseFloat(document.getElementById('addon-5')?.value) || 0;
    const addon10 = parseFloat(document.getElementById('addon-10')?.value) || 0;
    const addon15 = parseFloat(document.getElementById('addon-15')?.value) || 0;
    const total = addon5 + addon10 + addon15;
    
    const container = document.getElementById('addon-totals');
    if (container) {
        container.innerHTML = `
            <div class="mt-4 p-3 border-t-2 border-dashed text-right font-bold">
                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°: <span class="text-cyan-700">${total.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</span>
            </div>`;
    }
    return total;
}


function calculateVerificationAddOnAmount(price) {
    const qtyInput = document.getElementById(`verify-addon-${price}-qty`);
    const amountInput = document.getElementById(`verify-addon-${price}`);
    
    let qty = parseInt(qtyInput.value) || 0;
    
    // Validate ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏•‡∏ö
    if (qty < 0) {
        qty = 0;
        qtyInput.value = 0;
    }
    
    const amount = qty * price;
    amountInput.value = amount > 0 ? amount.toFixed(2) : '';
    
    calculateVerificationAddOnTotals();
    calculateVerificationCashAmount();
}

// ==================== ADDITIONAL WITHDRAWALS FUNCTIONS ====================

function toggleWithdrawalDetails(withdrawalId) {
  const details = document.getElementById(withdrawalId);
  const icon = document.getElementById(`icon-${withdrawalId}`);
  
  if (details.classList.contains('hidden')) {
    details.classList.remove('hidden');
    icon.textContent = 'üìÇ';
    
    // Scroll the main table container to the right
    setTimeout(() => {
      // Find the parent container that has the table
      const tableContainer = details.closest('.overflow-x-auto');
      if (tableContainer) {
        tableContainer.scrollLeft = tableContainer.scrollWidth;
      } else {
        // Alternative: find the parent table's container
        const parentTable = details.closest('table');
        if (parentTable && parentTable.parentElement) {
          parentTable.parentElement.scrollLeft = parentTable.parentElement.scrollWidth;
        }
      }
    }, 100);
    
  } else {
    details.classList.add('hidden');
    icon.textContent = 'üìã';
  }
}

function openWithdrawalModal(branchId, dateOfSale) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4';
  modal.id = 'withdrawal-modal';
  
  const expenseTypes = [
    '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô',
    '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏Å‡∏ó‡∏≠‡∏ô', 
    '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô ‡∏û‡∏ô‡∏á.',
    '‡πÄ‡∏õ‡∏¢‡πå‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≤‡∏¢',
    '‡∏Ñ‡πà‡∏≤‡πÇ‡∏ã‡∏î‡∏≤',
    '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏¢‡∏∞',
    '‡∏Ñ‡πà‡∏≤‡∏°‡∏∞‡∏ô‡∏≤‡∏ß',
    '‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'
  ];
  
  const today = new Date().toISOString().split('T')[0];
  
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-y-auto">
      <div class="p-6">
        <h3 class="text-xl font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3>
        <p class="text-sm text-gray-600 mb-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢: ${new Date(dateOfSale).toLocaleDateString('th-TH')}</p>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</label>
          <input type="date" id="withdrawal-date" value="${today}" 
            class="w-full px-3 py-2 border rounded-lg">
        </div>
        
        <div id="withdrawal-items" class="space-y-3 mb-4">
          <!-- Items will be added here -->
        </div>
        
        <button onclick="addWithdrawalItem()" 
          class="mb-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
          + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </button>
        
        <div class="border-t pt-4">
          <div class="flex justify-between items-center mb-4">
            <span class="font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
            <span id="withdrawal-total" class="text-xl font-bold text-blue-600">0‡∏ö‡∏≤‡∏ó</span>
          </div>
          
          <div class="flex justify-end space-x-3">
            <button onclick="closeWithdrawalModal()" 
              class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button onclick="saveWithdrawal('${branchId}', '${dateOfSale}')" 
              class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Add first item
  addWithdrawalItem();
  
  // Store expense types globally for datalist
}

let withdrawalItemCount = 0;

function addWithdrawalItem() {
  const container = document.getElementById('withdrawal-items');
  const itemId = `withdrawal-item-${++withdrawalItemCount}`;
  
  const itemDiv = document.createElement('div');
  itemDiv.id = itemId;
  itemDiv.className = 'flex gap-2 p-3 bg-gray-50 rounded';
  
  // ‡πÉ‡∏ä‡πâ array ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á window.expenseTypesList
  const expenseTypes = [
    '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô',
    '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏Å‡∏ó‡∏≠‡∏ô', 
    '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô ‡∏û‡∏ô‡∏á.',
    '‡πÄ‡∏õ‡∏¢‡πå‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≤‡∏¢',
    '‡∏Ñ‡πà‡∏≤‡πÇ‡∏ã‡∏î‡∏≤',
    '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏¢‡∏∞',
    '‡∏Ñ‡πà‡∏≤‡∏°‡∏∞‡∏ô‡∏≤‡∏ß',
    '‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'
  ];
  
  const datalistOptions = expenseTypes.map(type => 
    `<option value="${type}">`
  ).join('');
  
  itemDiv.innerHTML = `
    <div class="flex-1">
      <input type="text" 
        list="expense-types-${itemId}"
        placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"
        class="withdrawal-expense-type w-full px-3 py-2 border rounded"
        onchange="calculateWithdrawalTotal()">
      <datalist id="expense-types-${itemId}">${datalistOptions}</datalist>
    </div>
    <div class="w-32">
      <input type="number" 
        placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"
        class="withdrawal-amount w-full px-3 py-2 border rounded text-right"
        onchange="calculateWithdrawalTotal()">
    </div>
    <button onclick="removeWithdrawalItem('${itemId}')"
      class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600">
      √ó
    </button>
  `;
  
  container.appendChild(itemDiv);
}

function removeWithdrawalItem(itemId) {
  document.getElementById(itemId).remove();
  calculateWithdrawalTotal();
}

function calculateWithdrawalTotal() {
  let total = 0;
  document.querySelectorAll('.withdrawal-amount').forEach(input => {
    total += parseFloat(input.value) || 0;
  });
  document.getElementById('withdrawal-total').textContent = `${total.toLocaleString()}‡∏ö‡∏≤‡∏ó`;
}

function closeWithdrawalModal() {
  document.getElementById('withdrawal-modal')?.remove();
}

function saveWithdrawal(branchId, dateOfSale) {
  const withdrawalDate = document.getElementById('withdrawal-date').value;
  const items = [];
  
  const expenseTypes = document.querySelectorAll('.withdrawal-expense-type');
  const amounts = document.querySelectorAll('.withdrawal-amount');
  
  expenseTypes.forEach((typeInput, index) => {
    const amount = parseFloat(amounts[index].value) || 0;
    if (typeInput.value && amount > 0) {
      items.push({
        expenseType: typeInput.value,
        amount: amount
      });
    }
  });
  
  if (items.length === 0) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
    return;
  }
  
  const data = {
    branchId: branchId,
    dateOfSale: dateOfSale,
    withdrawalDate: withdrawalDate,
    items: items
  };
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();
      
      if (result.status === 'success') {
        closeWithdrawalModal();
        showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success');
        // Reload table
        handleSummarySearch();
      } else {
        showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error');
      }
    })
    .withFailureHandler(error => {
      hideLoading();
      handleError(error);
    })
    .saveAdditionalWithdrawals(JSON.stringify(data));
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°
function removeClaimItem(productId) {
  showCustomConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${productId} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => {
    // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å claimItems array
    claimItems = claimItems.filter(item => item.productId !== productId);
    
    // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏à‡∏≤‡∏Å DOM
    const row = document.getElementById(`claim-row-${productId}`);
    if (row) {
      const table = row.closest('table');
      const tbody = row.closest('tbody');
      
      row.remove();
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤ supplier ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏•‡∏ö table ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      if (tbody.children.length === 0) {
        const supplierDiv = table.closest('div[data-supplier-table]');
        if (supplierDiv) {
          supplierDiv.remove();
        }
      }
    }
    
    showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${productId} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
  });
}

function renderNewClaimTable(responseString) {
  const result = JSON.parse(responseString);
  if (result.status === 'error') {
    handleError({ message: result.message });
    hideLoading();
    return;
  }

  const container = document.getElementById('order-claim-table-container');
  const data = result.data;

  if (data.length === 0) {
    container.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</p>';
    hideLoading();
    return;
  }

  // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
  const unclaimedItems = data.filter(item => item.itemType === 'unclaimed');
  const partialReceivedItems = data.filter(item => item.itemType === 'partial_received');

  let tableHtml = `<div class="space-y-8">`;

  // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏£‡∏Å: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏•‡∏°
  if (unclaimedItems.length > 0) {
    tableHtml += `
      <div class="bg-white rounded-lg shadow-md">
        <div class="bg-red-50 px-4 py-3 border-b">
          <h3 class="text-lg font-semibold text-red-800">üî¥ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏° (${unclaimedItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left font-semibold" w-[10%]>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th>
                <th class="px-4 py-2 text-left font-semibold" w-[10%]>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="px-4 py-2 text-left font-semibold" w-[20%]>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="px-4 py-2 text-center font-semibold" w-[35%]>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏(‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏°)</th>
                <th class="px-4 py-2 text-center font-semibold" w-[35%]>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏°</th>
              </tr>
            </thead>
            <tbody class="divide-y">`;

    unclaimedItems.forEach(item => {
      const reportDate = new Date(item.reportDate).toLocaleDateString('th-TH');
      
      tableHtml += `
        <tr id="claim-row-${item.reportItemId}">
          <td class="px-4 py-2">${reportDate}</td>
          <td class="px-4 py-2 font-mono">${item.productId}</td>
          <td class="px-4 py-2">${item.productName}</td>
          <td class="px-4 py-2 text-center font-bold text-red-600">${item.expiredQuantity}</td>
          <td class="px-4 py-2 text-center">
            <div class="flex items-center gap-2 justify-center">
            
              <input type="number" class="claim-quantity-input w-20 rounded-md border-gray-300 text-center"
                placeholder="0" min="0" max="${item.expiredQuantity}">

              <button class="claim-save-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs"
                onclick="saveNewClaim('${item.reportItemId}', ${item.expiredQuantity})">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

            </div>
          </td>
          <td class="px-4 py-2 text-center">
          </td>
          <td class="px-4 py-2 text-center">
          </td>
        </tr>`;
    });

    tableHtml += '</tbody></table></div></div>';
  }

  // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
  if (partialReceivedItems.length > 0) {
    tableHtml += `
      <div class="bg-white rounded-lg shadow-md">
        <div class="bg-amber-50 px-4 py-3 border-b">
          <h3 class="text-lg font-semibold text-amber-800">üü° ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (${partialReceivedItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
          <p class="text-sm text-amber-600 mt-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏•‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left font-semibold w-[10%]">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th>
                <th class="px-4 py-2 text-left font-semibold w-[10%]">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="px-4 py-2 text-left font-semibold w-[20%]">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="px-4 py-2 text-center font-semibold w-[10%]">‡πÄ‡∏Ñ‡∏•‡∏°‡πÑ‡∏õ</th>
                <th class="px-4 py-2 text-center font-semibold w-[10%]">‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</th>
                <th class="px-4 py-2 text-center font-semibold bg-yellow-100" w-[10%]>‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏≠‡∏µ‡∏Å</th>
                <th class="px-4 py-2 text-center font-semibold" w-[10%]>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                <th class="px-4 py-2 text-center font-semibold" w-[10%]>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th class="px-4 py-2 text-center font-semibold" w-[10%]>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</th>
              </tr>
            </thead>
            <tbody class="divide-y">`;

    partialReceivedItems.forEach(item => {
      const reportDate = new Date(item.reportDate).toLocaleDateString('th-TH');
      const lastReceivedDate = item.receivedDate ? new Date(item.receivedDate).toLocaleDateString('th-TH') : '-';
      
      tableHtml += `
        <tr id="partial-claim-row-${item.reportItemId}" class="bg-yellow-50">
          <td class="px-4 py-2">${reportDate}</td>
          <td class="px-4 py-2 font-mono">${item.productId}</td>
          <td class="px-4 py-2">${item.productName}</td>
          <td class="px-4 py-2 text-center font-bold text-blue-600">${item.claimedQuantity}</td>
          <td class="px-4 py-2 text-center text-green-600">${item.receivedQuantity}</td>
          <td class="px-4 py-2 text-center font-bold text-red-600 bg-yellow-100">${item.remainingClaim}</td>
          <td class="px-4 py-2 text-center text-gray-600">${lastReceivedDate}</td>
          <td class="px-4 py-2 text-center">
            <div class="flex items-center gap-2 justify-center">
              <input type="number" class="additional-received-input w-20 rounded-md border-gray-300 text-center"
                placeholder="0" min="0" max="${item.remainingClaim}">
              <button class="additional-receipt-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs"
                onclick="saveAdditionalReceipt('${item.reportItemId}', ${item.remainingClaim})">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </td>
          <td class="px-4 py-2 text-center">
            <input type="date" class="additional-received-date w-32 rounded-md border-gray-300 text-sm">
          </td>
        </tr>`;
    });

    tableHtml += '</tbody></table></div></div>';
  }

  // ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ
  tableHtml += `
    <div class="bg-blue-50 p-4 rounded-lg">
      <h4 class="font-semibold text-blue-800 mb-2">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div class="flex justify-between">
          <span>üî¥ ‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏°:</span>
          <span class="font-bold text-red-600">${unclaimedItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <div class="flex justify-between">
          <span>üü° ‡∏£‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°:</span>
          <span class="font-bold text-amber-600">${partialReceivedItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
      </div>
    </div>
  </div>`;

  container.innerHTML = tableHtml;
  hideLoading();
}

function saveNewClaim(reportItemId, expiredQuantity) {
  const row = document.getElementById(`claim-row-${reportItemId}`);
  const quantityInput = row.querySelector('.claim-quantity-input');
  const quantity = parseInt(quantityInput.value) || 0;

  if (quantity <= 0 || quantity > expiredQuantity) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1-${expiredQuantity}`, 'error');
    return;
  }

  const branchId = document.getElementById('order-claim-branch').value;
  const productId = row.cells[1].textContent;

  const claimData = {
    reportItemId: reportItemId,
    branchId: branchId,
    productId: productId,
    reportedExpiredQuantity: expiredQuantity,
    claimableQuantity: quantity
  };

  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();

      if (result.status === 'success') {
        // ‡∏•‡πá‡∏≠‡∏Ñ claim inputs
        quantityInput.disabled = true;
        row.querySelector('.claim-save-btn').disabled = true;
        row.querySelector('.claim-save-btn').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
        

        //handleOrderClaimSearch();
        //showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success');

        handleOrderClaimSearch()
        .then(() => {
          showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success');
        })
        .catch(err => {
          console.error('Error in handleOrderClaimSearch:', err);
        });


        //setTimeout(() => {
        //  handleOrderClaimSearch();
        //}, 1500);



      } else {
        showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .saveClaimItem(JSON.stringify(claimData));
}




function saveAdditionalReceipt(reportItemId, maxQuantity) {
  const row = document.getElementById(`partial-claim-row-${reportItemId}`);
  const quantityInput = row.querySelector('.additional-received-input');
  const dateInput = row.querySelector('.additional-received-date');
  const saveBtn = row.querySelector('.additional-receipt-btn');

  const additionalQty = parseInt(quantityInput.value) || 0;
  const receivedDate = dateInput.value;

  if (additionalQty <= 0) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°', 'error');
    return;
  }

  if (additionalQty > maxQuantity) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Å‡∏¥‡∏ô ${maxQuantity} ‡∏ä‡∏¥‡πâ‡∏ô`, 'error');
    return;
  }

  if (!receivedDate) {
    showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á', 'error');
    return;
  }

  const additionalReceiptData = {
    reportItemId: reportItemId,
    additionalQuantity: additionalQty,
    receivedDate: receivedDate
  };

  showLoading();

  google.script.run
    .withSuccessHandler(response => {
      const result = JSON.parse(response);
      hideLoading();

      if (result.status === 'success') {
        // ‡∏•‡πá‡∏≠‡∏Ñ inputs
        quantityInput.disabled = true;
        quantityInput.classList.add('bg-gray-100');
        dateInput.disabled = true;
        dateInput.classList.add('bg-gray-100');
        saveBtn.disabled = true;
        saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
        saveBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
        const receivedCell = row.cells[4]; // ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
        const remainingCell = row.cells[5]; // ‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏≠‡∏µ‡∏Å
        
        const currentReceived = parseInt(receivedCell.textContent);
        const newReceived = currentReceived + additionalQty;
        const newRemaining = parseInt(remainingCell.textContent) - additionalQty;

        receivedCell.textContent = newReceived;
        receivedCell.className = 'px-4 py-2 text-center text-green-600 font-bold';
        
        if (newRemaining <= 0) {
          remainingCell.textContent = '0';
          remainingCell.className = 'px-4 py-2 text-center font-bold text-green-600 bg-green-100';
          row.classList.remove('bg-yellow-50');
          row.classList.add('bg-green-50');
        } else {
          remainingCell.textContent = newRemaining;
        }

        handleOrderClaimSearch()
        .then(() => {
          showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success');
        })
        .catch(err => {
          console.error('Error in handleOrderClaimSearch:', err);
        });

        //showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success');
        
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        //setTimeout(() => {
        //  handleOrderClaimSearch();
        //}, 2000);

      } else {
        showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .saveAdditionalClaimReceipt(JSON.stringify(additionalReceiptData));
}


// ==================== RAW MATERIAL ORDERING SCRIPT ====================

let rawMaterialOrderData = { orderId: null, items: {} };

function showRawMaterialOrderForm() {
    document.getElementById('header-title').innerText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö';
    const appContainer = document.getElementById('app-container');
    appContainer.innerHTML = `<div class="text-center p-8"><div class="spinner mx-auto"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</p></div>`;
    
    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            if (result.status === 'success') {
                renderRawMaterialForm(result.data);
            } else {
                handleError({ message: result.message });
            }
        })
        .withFailureHandler(handleError)
        .getRawMaterialProducts();
}

function renderRawMaterialForm(groupedProducts) {
    const appContainer = document.getElementById('app-container');
    let formHtml = `
        <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">


<button onclick="showDashboard()" class="text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
<div id="auto-save-status" class="h-4"></div>

<div class="mt-4 border rounded-lg overflow-hidden">
  <div class="p-4 bg-gray-50 border-b sticky top-0">

     <input type="text" id="raw-material-search" onkeyup="searchRawMaterial()" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="w-full px-4 py-2 border rounded-lg shadow-sm">

            </div>

              <div id="product-list-container" class="space-y-6 p-4 overflow-y-auto" style="max-height: 60vh;">`;
            
    const sortedGroups = Object.keys(groupedProducts).sort();

    sortedGroups.forEach(groupName => {
        formHtml += `
            <div class="border rounded-lg product-type-group">

                <h3 class="text-lg font-bold bg-gray-100 p-3 rounded-t-lg">${groupName}</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
<th class="p-2 text-left w-[15%]">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
<th class="p-2 text-left w-[25%]">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>

                                <th class="p-2 text-center" colspan="2">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                                <th class="p-2 text-center" colspan="2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">`;
        
        groupedProducts[groupName].forEach(p => {
            formHtml += `
                <tr data-product-id="${p.id}" data-product-name="${p.name.toLowerCase()}" data-product-id-search="${String(p.id).toLowerCase()}">

<td class="p-2 font-mono text-sm text-gray-700">${p.id}</td>
<td class="p-2 font-medium">${p.name}</td>
                    <td class="p-1">
                        <div class="flex items-center">
                            <input type="number" class="w-full rounded-md border-gray-300 text-center p-1" placeholder="0" data-field="currentStock_Main">
                            <span class="ml-2 text-xs text-gray-600">${p.unitMain}</span>
                        </div>
                    </td>
                    <td class="p-1">
                        <div class="flex items-center">
                             <input type="number" class="w-full rounded-md border-gray-300 text-center p-1" placeholder="0" data-field="currentStock_Sub">
                            <span class="ml-2 text-xs text-gray-600">${p.unitSub}</span>
                        </div>
                    </td>

                    <td class="p-1">
                        <div class="flex items-center">
                            <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-blue-50" placeholder="0" data-field="requestedQuantity_Main">
                             <span class="ml-2 text-xs text-gray-600">${p.unitMain}</span>
                        </div>
                    </td>
                     <td class="p-1">
                        <div class="flex items-center">
                            <input type="number" class="w-full rounded-md border-gray-300 text-center p-1 bg-blue-50" placeholder="0" data-field="requestedQuantity_Sub">
                             <span class="ml-2 text-xs text-gray-600">${p.unitSub}</span>
                        </div>
                    </td>
                </tr>`;
        });

        formHtml += `</tbody></table></div></div>`;
    });

    formHtml += `
            </div>
            <div class="flex justify-end items-center space-x-4 pt-4 border-t">
                <button onclick="submitRMO()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>
        </div>`;
    
    appContainer.innerHTML = formHtml;

}


function gatherRMOFormData() {
    const items = [];
    document.querySelectorAll('tr[data-product-id]').forEach(row => {
        const itemData = { productId: row.dataset.productId };
        let hasValue = false;
        row.querySelectorAll('input[type="number"]').forEach(input => {
            itemData[input.dataset.field] = input.value;
            if (input.value) hasValue = true;
        });
        if (hasValue) {
            items.push(itemData);
        }
    });
    return {
        orderId: rawMaterialOrderData.orderId,
        items: items
    };
}

function saveRawMaterialDraft(isAuto = true) {
    const statusDiv = document.getElementById('auto-save-status');
    if (isAuto) {

    } else {
        showLoading();
    }
    
    const dataToSave = gatherRMOFormData();

    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            if (result.status === 'success') {
                rawMaterialOrderData.orderId = result.orderId;
                if (isAuto) {
                    const time = new Date().toLocaleTimeString('th-TH');
                    statusDiv.innerText = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${time}`;
                } else {
                    hideLoading();
                    showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            } else {
                 if (!isAuto) hideLoading();
                handleError({ message: result.message });
            }
        })
        .withFailureHandler(error => {
            if (!isAuto) hideLoading();
            handleError(error);
        })
        .saveRawMaterialOrderDraft(JSON.stringify(dataToSave));
}

function submitRMO() {
    showCustomConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
        showLoading();
        const dataToSave = gatherRMOFormData();

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                const result = JSON.parse(response);
                if (result.status === 'success') {
                    showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success', showDashboard);
                } else {
                    handleError({ message: result.message });
                }
            })
            .withFailureHandler(handleError)
            .submitFinalRawMaterialOrder(JSON.stringify(dataToSave)); // <-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    });
}

// --- Office Functions ---
function showPendingOrdersList() {
    document.getElementById('header-title').innerText = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
    const appContainer = document.getElementById('app-container');
    appContainer.innerHTML = `<div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-4">
        <button onclick="showDashboard()" class="text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
        <h3 class="text-xl font-bold">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
        <div id="pending-orders-container"><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
    </div>`;

    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            const container = document.getElementById('pending-orders-container');
            if (result.status === 'success') {
                if (result.data.length === 0) {
                    container.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>';
                    return;
                }
                let tableHtml = '<table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-4 py-3 bg-gray-50 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</th><th class="px-4 py-3 bg-gray-50 text-left">‡∏™‡∏≤‡∏Ç‡∏≤</th><th class="px-4 py-3 bg-gray-50 text-left">OrderID</th><th></th></tr></thead><tbody>';
                result.data.forEach(order => {
                    tableHtml += `<tr>
                        <td class="px-4 py-2">${order.requestedAt}</td>
                        <td class="px-4 py-2">${order.branchName}</td>
                        <td class="px-4 py-2 font-mono text-xs">${order.orderId}</td>
                        <td class="px-4 py-2 text-right"><button onclick="showRawMaterialApprovalView('${order.orderId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button></td>
                    </tr>`;
                });
                tableHtml += '</tbody></table>';
                container.innerHTML = tableHtml;
            } else {
                container.innerHTML = `<p class="text-red-500">${result.message}</p>`;
            }
        })
        .withFailureHandler(handleError)
        .getPendingRawMaterialOrders();
}

function showRawMaterialApprovalView(orderId) {
    document.getElementById('header-title').innerText = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠';
    const appContainer = document.getElementById('app-container');
    appContainer.innerHTML = `<div class="text-center p-8"><div class="spinner mx-auto"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</p></div>`;

    google.script.run
        .withSuccessHandler(response => {
            const result = JSON.parse(response);
            if (result.status === 'success') {
                renderApprovalForm(result.data);
            } else {
                handleError({ message: result.message });
            }
        })
        .withFailureHandler(handleError)
        .getRawMaterialOrderWithHistory(orderId);
}

function renderApprovalForm(data) {
    const { current, history } = data;
    const appContainer = document.getElementById('app-container');
    
    let historyHeaders = '';
    history.forEach((h, index) => {
        historyHeaders += `<th colspan="2" class="p-2 text-center bg-gray-100">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${index+1} (${h.requestedAt})</th>`;
    });

    let tableHtml = `
      <div class="max-w-screen-xl mx-auto bg-white p-6 rounded-xl shadow-lg space-y-6">
        <button onclick="showPendingOrdersList()" class="text-sm text-blue-600 hover:underline">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
        <h3 class="text-xl font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${current.orderId}</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm border">


<thead class="bg-gray-50">
  <tr>

    <th rowspan="2" class="p-2 text-left">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
    <th rowspan="2" class="p-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
    ${historyHeaders}
        <th colspan="2" class="p-2 text-center bg-blue-100">‡πÉ‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
  </tr>
  <tr>
    <th class="p-2 text-center bg-blue-50">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
    <th class="p-2 text-center bg-blue-50">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
    ${history.map(h => `<th class="p-2 text-center bg-gray-50">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th class="p-2 text-center bg-gray-50">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>`).join('')}
  </tr>
</thead>

            
            <tbody class="divide-y">`;

    current.items.forEach(item => {
    let historyCells = '';
    history.forEach(h => {
        const historyItem = h.items[item.productId];
        if (historyItem) {
            historyCells += `
                <td class="p-2 text-center">${historyItem.currentStock_Main || 0} ${item.unitMain} ${historyItem.currentStock_Sub || 0} ${item.unitSub}</td>
                <td class="p-2 text-center">${historyItem.approvedQuantity_Main || 0} ${item.unitMain} ${historyItem.approvedQuantity_Sub || 0} ${item.unitSub}</td>`;
        } else {
            historyCells += '<td class="p-2 text-center">-</td><td class="p-2 text-center">-</td>';
        }
    });
    
    tableHtml += `
    <tr data-product-id="${item.productId}">
        <td class="p-2 font-mono text-sm">${item.productId}</td>
        <td class="p-2 font-medium">${item.productName}</td>
        ${historyCells}
        <td class="p-2 text-center bg-blue-50">${item.currentStock_Main} ${item.unitMain} ${item.currentStock_Sub} ${item.unitSub}</td>
        <td class="p-1 bg-blue-50">
            <div class="flex items-center">
                <input type="number" value="${item.requestedQuantity_Main}" class="w-full p-1 border rounded" data-field="approvedQuantity_Main">
                <span class="ml-2 text-xs">${item.unitMain}</span>
            </div>
            <div class="flex items-center mt-1">
                <input type="number" value="${item.requestedQuantity_Sub}" class="w-full p-1 border rounded" data-field="approvedQuantity_Sub">
                <span class="ml-2 text-xs">${item.unitSub}</span>
            </div>
        </td>
    </tr>`;
});

    tableHtml += `</tbody></table></div>
        <div class="flex justify-between items-center pt-4 border-t">
            <button onclick="rejectRMO('${current.orderId}')" class="px-6 py-2 bg-red-600 text-white font-bold rounded-md hover:bg-red-700">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            <button onclick="approveRMO('${current.orderId}')" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
      </div>`;
      
    appContainer.innerHTML = tableHtml;
}


function approveRMO(orderId) {
    showCustomConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
        showLoading();
        const updatedItems = [];
        document.querySelectorAll(`tr[data-product-id]`).forEach(row => {
            updatedItems.push({
                productId: row.dataset.productId,
                approvedQuantity_Main: row.querySelector('input[data-field="approvedQuantity_Main"]').value,
                approvedQuantity_Sub: row.querySelector('input[data-field="approvedQuantity_Sub"]').value
            });
        });
        
        const dataToSave = { orderId: orderId, items: updatedItems };

        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                const result = JSON.parse(response);
                if (result.status === 'success') {
                    showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success', showPendingOrdersList);
                } else {
                    handleError({ message: result.message });
                }
            })
            .withFailureHandler(handleError)
            .approveRawMaterialOrder(JSON.stringify(dataToSave));
    });
}

function rejectRMO(orderId) {
    showCustomConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
        showLoading();
        google.script.run
            .withSuccessHandler(response => {
                hideLoading();
                const result = JSON.parse(response);
                if (result.status === 'success') {
                    showCustomAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success', showPendingOrdersList);
                } else {
                    handleError({ message: result.message });
                }
            })
            .withFailureHandler(handleError)
            .rejectRawMaterialOrder(orderId);
    });
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏Å‡∏£‡∏≠‡∏á" ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö ---
function searchRawMaterial() {
    const searchTerm = document.getElementById('raw-material-search').value.toLowerCase();
    const productGroups = document.querySelectorAll('.product-type-group');

    // 1. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á "‡πÅ‡∏ñ‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß
    document.querySelectorAll('tr[data-product-id]').forEach(row => {
        const productName = row.dataset.productName;
        const productId = row.dataset.productIdSearch;
        const isMatch = productName.includes(searchTerm) || productId.includes(searchTerm);
        
        // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ß, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô
        row.style.display = isMatch ? '' : 'none';
    });

    // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
    productGroups.forEach(group => {
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ ‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const visibleRows = group.querySelectorAll('tr[data-product-id]:not([style*="display: none"])');
        
        // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
        group.style.display = visibleRows.length > 0 ? '' : 'none';
    });
}

  </script>
</body>
</html>
