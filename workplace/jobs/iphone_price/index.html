<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mobile Price Checker</title>

  <!-- Tailwind CSS Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy: {
              950: '#030712',
              900: '#0a0f1e',
              850: '#0d1528',
              800: '#111827',
              700: '#1a2540',
              600: '#1e3a5f',
              500: '#1d4ed8',
            }
          },
          fontFamily: {
            sans: ['Noto Sans Thai', 'Sarabun', 'sans-serif'],
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease forwards',
            'slide-up': 'slideUp 0.4s ease forwards',
          },
          keyframes: {
            fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
            slideUp: { from: { opacity: 0, transform: 'translateY(24px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
          }
        }
      }
    };
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Moment.js -->
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/locale/th.js"></script>
  <script>moment.locale('th');</script>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    * {
      font-family: 'Noto Sans Thai', sans-serif;
    }

    body {
      background-color: #020617;
      color: #f8fafc;
    }

    /* Glass card - Dark Theme */
    .glass {
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.7), 0 20px 40px -8px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }

    /* Input styling - Dark Theme */
    .inp {
      background: #1e293b;
      border: 1px solid #334155;
      color: #f1f5f9;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      width: 100%;
      transition: all 0.2s;
      outline: none;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
    }

    .inp:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
      background: #0f172a;
    }

    .inp:disabled {
      background: #0f172a;
      cursor: not-allowed;
      color: #64748b;
      border-color: #1e293b;
    }

    .inp option {
      background: #1e293b;
      color: #f1f5f9;
    }

    /* Button */
    .btn-primary {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: #fff;
      font-weight: 600;
      border-radius: 0.75rem;
      padding: 0.875rem 1.5rem;
      width: 100%;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5);
    }

    .btn-primary:active {
      transform: translateY(0px);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      background: #334155;
      box-shadow: none;
      color: #94a3b8;
    }

    /* Tab active */
    .tab-active {
      border-bottom: 3px solid #3b82f6;
      color: #3b82f6 !important;
    }

    /* Loader */
    .spinner {
      width: 22px;
      height: 22px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Section transition */
    .section {
      display: none;
    }

    .section.active {
      display: block;
      animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* Fix for flex containers that are also sections */
    .section.active.flex {
      display: flex;
    }

    /* Result card */
    .result-card {
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 10px 30px -6px rgba(0, 0, 0, 0.7), inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    /* Step badge */
    .step-badge {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      color: #60a5fa;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      flex-shrink: 0;
      border: 1px solid #334155;
    }

    /* SweetAlert2 theme overrides */
    .swal-mpc-popup {
      background: #0f172a !important;
      border: 1px solid rgba(148, 163, 184, 0.18) !important;
      border-radius: 1.25rem !important;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.85) !important;
      font-family: 'Noto Sans Thai', sans-serif !important;
      color: #f1f5f9 !important;
    }

    .swal-mpc-title {
      color: #f1f5f9 !important;
      font-size: 1rem !important;
      font-weight: 600 !important;
    }

    .swal-mpc-html {
      color: #94a3b8 !important;
      font-size: 0.875rem !important;
    }

    .swal-mpc-confirm {
      background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
      border-radius: 0.6rem !important;
      font-family: 'Noto Sans Thai', sans-serif !important;
      font-size: 0.875rem !important;
      box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4) !important;
    }

    .swal-mpc-timer-bar {
      background: rgba(148, 163, 184, 0.25) !important;
    }

    /* Badge vn */
    .badge-vn {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      padding: 0.35rem 1rem;
      border-radius: 2rem;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
    }
    .badge-sc {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      padding: 0.35rem 1rem;
      border-radius: 2rem;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
    }


    /* Select2-like none arrow fix for dark bg -> light arrow */
    select.inp {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
    }
  </style>
</head>

<body class="min-h-screen bg-slate-950 relative text-slate-200 selection:bg-blue-500 selection:text-white">

  <!-- Ambient blobs - Dark theme -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none" aria-hidden="true">
    <div
      class="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] rounded-full bg-blue-600/20 blur-3xl mix-blend-screen filter">
    </div>
    <div
      class="absolute top-[20%] -right-[10%] w-[40%] h-[40%] rounded-full bg-indigo-600/20 blur-3xl mix-blend-screen filter">
    </div>
    <div
      class="absolute -bottom-[20%] left-[20%] w-[40%] h-[40%] rounded-full bg-purple-600/20 blur-3xl mix-blend-screen filter">
    </div>
  </div>

  <!-- ============================================================
       SECTION 1 : AUTH (Login / Register)
  ============================================================ -->
  <div id="sec-auth" class="section active min-h-screen flex items-center justify-center px-4 py-10">
    <div class="w-full max-w-md">

      <!-- Logo -->
      <div class="text-center mb-10">
        <img src="<?!= logoB64 ?>" alt="VN Phone Logo"
          class="h-28 mx-auto mb-6 drop-shadow-2xl hover:scale-105 transition-transform duration-300 rounded-lg" />
        <h1 class="text-3xl font-bold text-white tracking-tight">Mobile Price Checker</h1>
        <p class="text-slate-400 text-sm mt-2 font-medium">ตรวจสอบง่าย รู้ผลไว ในไม่กี่วินาที</p>
      </div>

      <!-- Card -->
      <div class="glass rounded-3xl p-8">

        <!-- Tabs -->
        <div class="flex border-b border-slate-700 mb-6">
          <button id="tab-login" class="tab-active flex-1 pb-3 text-sm font-semibold text-blue-400 transition-all"
            onclick="switchTab('login')">เข้าสู่ระบบ</button>
          <button id="tab-register" class="flex-1 pb-3 text-sm font-semibold text-slate-400 transition-all"
            onclick="switchTab('register')">สมัครสมาชิก</button>
        </div>

        <!-- LOGIN FORM -->
        <div id="form-login">
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-semibold text-slate-400 mb-2 tracking-wide">อีเมล</label>
              <input id="login-email" type="email" class="inp" placeholder="hello@example.com" />
            </div>
            <div>
              <label class="block text-sm font-semibold text-slate-400 mb-2 tracking-wide">เบอร์โทรศัพท์</label>
              <input id="login-phone" type="tel" class="inp" placeholder="08xxxxxxxx" />
            </div>
            <button class="btn-primary mt-4 py-3.5 text-base shadow-lg shadow-blue-900/40 hover:shadow-blue-800/50"
              onclick="doLogin()">
              <span id="login-btn-text">เข้าสู่ระบบ</span>
            </button>
            <p class="text-center text-sm text-slate-500 mt-4">
              ยังไม่มีบัญชี?
              <span class="text-blue-400 font-semibold cursor-pointer hover:underline"
                onclick="switchTab('register')">สมัครสมาชิกฟรี</span>
            </p>
          </div>
        </div>

        <!-- REGISTER FORM -->
        <div id="form-register" class="hidden">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-slate-400 mb-1.5 uppercase tracking-wide">บริษัท /
                ร้านค้า</label>
              <select id="reg-company" class="inp">
                <option value="">-- เลือกบริษัท --</option>
                <option value="VN Phone">VN Phone</option>
                <option value="สยามชัย">สยามชัย</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wider">ชื่อ</label>
                <input id="reg-firstname" type="text" class="inp" placeholder="ชื่อจริง" />
              </div>
              <div>
                <label
                  class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wider">นามสกุล</label>
                <input id="reg-lastname" type="text" class="inp" placeholder="นามสกุล" />
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wider">ชื่อเล่น</label>
              <input id="reg-nickname" type="text" class="inp" placeholder="เช่น พี่เอ" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wider">อีเมล</label>
              <input id="reg-email" type="email" class="inp" placeholder="hello@example.com" />
            </div>
            <div>
              <label
                class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wider">เบอร์โทรศัพท์</label>
              <input id="reg-phone" type="tel" class="inp" placeholder="08xxxxxxxx" />
            </div>
            <button class="btn-primary mt-4 py-3 text-base shadow-lg shadow-blue-900/40" onclick="doRegister()">
              <span id="reg-btn-text">สมัครสมาชิก</span>
            </button>
            <p class="text-center text-sm text-slate-500 mt-4">
              มีบัญชีแล้ว?
              <span class="text-blue-400 font-semibold cursor-pointer hover:underline"
                onclick="switchTab('login')">เข้าสู่ระบบ</span>
            </p>
          </div>
        </div>

      </div><!-- /card -->
    </div>
  </div>

  <!-- ============================================================
       SECTION 2 : VN PHONE (ราคาผ่อน)
  ============================================================ -->
  <div id="sec-vn" class="section min-h-screen px-4 py-8">
    <div class="max-w-lg mx-auto">

      <!-- Header -->
      <div class="glass rounded-2xl p-6 mb-8 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-4">
          <div
            class="w-12 h-12 p-1.5 rounded-2xl flex items-center justify-center bg-[#ffcc00] shadow-lg shadow-blue-900/20 text-white">
            <img src="<?!= logoB64 ?>" alt="VN Phone Logo" class="h-8 w-auto rounded-md" />
          </div>
          <div>
            <div class="text-xs font-semibold text-slate-400 uppercase tracking-wide">ยินดีต้อนรับ</div>
            <div class="font-bold text-slate-100 text-lg" id="vn-welcome">—</div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span class="badge-vn">VN Phone</span>
          <button onclick="doLogout()" title="ออกจากระบบ"
            class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-800 text-slate-400 hover:bg-red-900/20 hover:text-red-400 transition shadow-sm border border-slate-700">
            <i data-lucide="log-out" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <div class="mb-6 px-1">
        <h2 class="text-2xl font-bold text-slate-100 mb-2">ค้นหาราคาผ่อนชำระ</h2>
        <p class="text-slate-400 text-sm">เลือกรุ่นมือถือและจำนวนงวดที่ต้องการเพื่อคำนวณราคา</p>
      </div>

      <!-- Steps Card -->
      <div class="glass rounded-3xl p-8 space-y-6 shadow-xl shadow-black/40">

        <!-- Step 1: Brand -->
        <div class="flex gap-4 items-start group">
          <div
            class="step-badge shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">1
          </div>
          <div class="flex-1">
            <label class="block text-sm font-bold text-slate-300 mb-2">ยี่ห้อโทรศัพท์</label>
            <select id="vn-brand" class="inp py-3" onchange="vnLoadModels()">
              <option value="">-- เลือกยี่ห้อ --</option>
            </select>
          </div>
        </div>

        <!-- Step 2: Model -->
        <div class="flex gap-4 items-start group">
          <div
            class="step-badge shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">2
          </div>
          <div class="flex-1">
            <label class="block text-sm font-bold text-slate-300 mb-2">รุ่น</label>
            <select id="vn-model" class="inp py-3" onchange="vnLoadStorages()" disabled>
              <option value="">-- เลือกรุ่น --</option>
            </select>
          </div>
        </div>

        <!-- Step 3: Storage -->
        <div class="flex gap-4 items-start group">
          <div
            class="step-badge shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">3
          </div>
          <div class="flex-1">
            <label class="block text-sm font-bold text-slate-300 mb-2">รอม / ความจุ</label>
            <select id="vn-storage" class="inp py-3" onchange="vnLoadDownPayments()" disabled>
              <option value="">-- เลือกความจุ --</option>
            </select>
          </div>
        </div>

        <!-- Step 4: Down payment -->
        <div class="flex gap-4 items-start group">
          <div
            class="step-badge shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">4
          </div>
          <div class="flex-1">
            <label class="block text-sm font-bold text-slate-300 mb-2">เงินดาวน์</label>
            <select id="vn-down" class="inp py-3" onchange="vnTrySearch()" disabled>
              <option value="">-- เลือกราคาดาวน์ --</option>
            </select>
          </div>
        </div>

        <!-- Step 5: Months -->
        <div class="flex gap-4 items-start group">
          <div
            class="step-badge shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">5
          </div>
          <div class="flex-1">
            <label class="block text-sm font-bold text-slate-300 mb-2">จำนวนงวดผ่อนชำระ</label>
            <div class="grid grid-cols-4 gap-3" id="vn-months-group">
                <button
                class="month-btn inp text-center py-3 cursor-pointer hover:border-blue-500 hover:bg-blue-900/20 transition shadow-sm font-medium text-slate-400 flex flex-col items-center justify-center"
                data-months="6"><span class="text-2xl font-bold leading-tight">6</span><span class="text-xs">เดือน</span></button>
                <button
                class="month-btn inp text-center py-3 cursor-pointer hover:border-blue-500 hover:bg-blue-900/20 transition shadow-sm font-medium text-slate-400 flex flex-col items-center justify-center"
                data-months="8"><span class="text-2xl font-bold leading-tight">8</span><span class="text-xs">เดือน</span></button>
                <button
                class="month-btn inp text-center py-3 cursor-pointer hover:border-blue-500 hover:bg-blue-900/20 transition shadow-sm font-medium text-slate-400 flex flex-col items-center justify-center"
                data-months="10"><span class="text-2xl font-bold leading-tight">10</span><span class="text-xs">เดือน</span></button>
                <button
                class="month-btn inp text-center py-3 cursor-pointer hover:border-blue-500 hover:bg-blue-900/20 transition shadow-sm font-medium text-slate-400 flex flex-col items-center justify-center"
                data-months="12"><span class="text-2xl font-bold leading-tight">12</span><span class="text-xs">เดือน</span></button>
            </div>
            <input type="hidden" id="vn-months" value="" />
          </div>
        </div>

      </div>

      <!-- VN Result -->
      <div id="vn-result" class="mt-8 hidden animate-fade-in mb-12">
        <div id="vn-result-card" class="result-card ring-1 ring-blue-900/50">
          <div class="flex items-center gap-2 mb-5 pb-4 border-b border-slate-700">
            <div class="w-8 h-8 p-1 rounded-lg flex items-center justify-center bg-[#ffcc00]">
              <img src="<?!= logoB64 ?>" alt="VN Phone Logo" class="h-5 w-auto" />
            </div>
            <span class="font-bold text-slate-200 text-lg">สรุปรายการผ่อนชำระ</span>
          </div>
          <div class="space-y-2" id="vn-result-body"></div>
        </div>
        <button onclick="downloadCard('vn-result-card', 'ผ่อน')" class="w-full mt-3 flex items-center justify-center gap-2 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 text-white transition font-semibold text-sm shadow-lg shadow-indigo-900/40">
          <i data-lucide="image-down" class="w-4 h-4"></i> ดาวน์โหลดรูปภาพ
        </button>
      </div>

    </div>
  </div>

  <!-- ============================================================
       SECTION 3 : สยามชัย (ราคาซื้อสด)
  ============================================================ -->
  <div id="sec-sc" class="section min-h-screen px-4 py-8">
    <div class="max-w-lg mx-auto">

      <!-- Header -->
      <div class="glass rounded-2xl p-6 mb-8 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-4">
            <div
            class="w-12 h-12 p-1.5 rounded-2xl flex items-center justify-center bg-[#ffcc00] shadow-lg shadow-blue-900/20 text-white">
            <img src="<?!= logoB64 ?>" alt="VN Phone Logo" class="h-8 w-auto rounded-md" />
            </div>
          <div>
            <div class="text-xs font-semibold text-slate-400 uppercase tracking-wide">ยินดีต้อนรับ</div>
            <div class="font-bold text-slate-100 text-lg" id="sc-welcome">—</div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span class="badge-sc">สยามชัย</span>
          <button onclick="doLogout()" title="ออกจากระบบ"
            class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-800 text-slate-400 hover:bg-red-900/20 hover:text-red-400 transition shadow-sm border border-slate-700">
            <i data-lucide="log-out" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <div class="mb-6 px-1">
        <h2 class="text-2xl font-bold text-slate-100 mb-2">ค้นหาราคาซื้อสด</h2>
        <p class="text-slate-400 text-sm mb-6">เลือกรุ่นมือถือเพื่อเช็คราคาโปรโมชั่น</p>
      </div>

      <!-- Steps Card -->
      <div class="glass rounded-3xl p-8 space-y-6 shadow-xl shadow-black/40">

        <!-- Step 1: Brand -->
        <div class="flex gap-4 items-start group">
          <div
            class="step-badge shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">1
          </div>
          <div class="flex-1">
            <label class="block text-sm font-bold text-slate-300 mb-2">ยี่ห้อโทรศัพท์</label>
            <select id="sc-brand" class="inp py-3" onchange="scLoadModels()">
              <option value="">-- เลือกยี่ห้อ --</option>
            </select>
          </div>
        </div>

        <!-- Step 2: Model -->
        <div class="flex gap-4 items-start group">
          <div
            class="step-badge shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">2
          </div>
          <div class="flex-1">
            <label class="block text-sm font-bold text-slate-300 mb-2">รุ่น</label>
            <select id="sc-model" class="inp py-3" onchange="scLoadStorages()" disabled>
              <option value="">-- เลือกรุ่น --</option>
            </select>
          </div>
        </div>

        <!-- Step 3: Storage -->
        <div class="flex gap-4 items-start group">
          <div
            class="step-badge shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">3
          </div>
          <div class="flex-1">
            <label class="block text-sm font-bold text-slate-300 mb-2">รอม / ความจุ</label>
            <select id="sc-storage" class="inp py-3" onchange="scTrySearch()" disabled>
              <option value="">-- เลือกความจุ --</option>
            </select>
          </div>
        </div>

      </div>

      <!-- SC Result -->
      <div id="sc-result" class="mt-8 hidden animate-fade-in mb-12">
        <div id="sc-result-card" class="result-card ring-1 ring-blue-900/50">
          <div class="flex items-center gap-2 mb-5 pb-4 border-b border-slate-700">
            <div class="w-8 h-8 p-1 rounded-lg flex items-center justify-center bg-[#ffcc00]">
              <img src="<?!= logoB64 ?>" alt="VN Phone Logo" class="h-5 w-auto" />
            </div>
            <span class="font-bold text-slate-200 text-lg">สรุปราคาเครื่องเปล่า</span>
          </div>
          <div id="sc-result-body" class="space-y-2"></div>
        </div>
        <button onclick="downloadCard('sc-result-card', 'ซื้อสด')" class="w-full mt-3 flex items-center justify-center gap-2 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 text-white transition font-semibold text-sm shadow-lg shadow-indigo-900/40">
          <i data-lucide="image-down" class="w-4 h-4"></i> ดาวน์โหลดรูปภาพ
        </button>
      </div>

    </div>
  </div>

  <!-- ============================================================
     JAVASCRIPT
============================================================ -->
  <!-- Pre-loaded price data injected by GAS template -->
  <script>
    var PRICE_DATA = <?!= priceData ?>;
  </script>
  <script>
    // ── Session Management ────────────────────────────────────────
    var SESSION_DURATION = 60 * 60 * 1000; // 1 hour in ms
    var SESSION_KEY = 'mpc_session';
    var _autoLogoutTimer = null;

    function saveSession(user) {
      var expiresAt = Date.now() + SESSION_DURATION;
      try {
        localStorage.setItem(SESSION_KEY, JSON.stringify({ user: user, expiresAt: expiresAt }));
      } catch (e) { }
      return expiresAt;
    }

    function loadSession() {
      try {
        var raw = localStorage.getItem(SESSION_KEY);
        if (!raw) return null;
        var session = JSON.parse(raw);
        if (!session || !session.expiresAt || Date.now() >= session.expiresAt) {
          clearSession();
          return null;
        }
        return session;
      } catch (e) { return null; }
    }

    function clearSession() {
      try { localStorage.removeItem(SESSION_KEY); } catch (e) { }
      if (_autoLogoutTimer) { clearTimeout(_autoLogoutTimer); _autoLogoutTimer = null; }
    }

    function startAutoLogout(expiresAt) {
      if (_autoLogoutTimer) clearTimeout(_autoLogoutTimer);
      var remaining = expiresAt - Date.now();
      if (remaining <= 0) { doLogout(); return; }
      _autoLogoutTimer = setTimeout(function () {
        showToast('เซสชันหมดอายุ กรุณาเข้าสู่ระบบใหม่', 'error');
        doLogout();
      }, remaining);
    }

    // ── Utility ──────────────────────────────────────────────────
    var currentUser = null;

    function fmt(n) {
      return Number(n).toLocaleString('th-TH', { minimumFractionDigits: 0 });
    }

    var _swalDefaults = {
      toast: true,
      position: 'top',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true,
      customClass: {
        popup: 'swal-mpc-popup',
        title: 'swal-mpc-title',
        htmlContainer: 'swal-mpc-html',
        timerProgressBar: 'swal-mpc-timer-bar'
      }
    };

    function showToast(msg, type) {
      type = type || 'success';
      var iconMap = { success: 'success', error: 'error', warning: 'warning', info: 'info' };
      Swal.fire(Object.assign({}, _swalDefaults, {
        icon: iconMap[type] || 'success',
        title: msg
      }));
    }

    function gasCall(func, payload, cb) {
      if (typeof google === 'undefined') {
        // Dev preview – return mock empty
        console.warn('GAS not available. Mock response.');
        cb({ status: 'error', message: 'ทดสอบในเบราว์เซอร์ไม่ได้ กรุณา Deploy บน Google Apps Script' });
        return;
      }
      google.script.run
        .withSuccessHandler(function (raw) {
          try { cb(JSON.parse(raw)); }
          catch (e) { cb({ status: 'error', message: 'Parse error' }); }
        })
        .withFailureHandler(function (e) {
          cb({ status: 'error', message: e.message });
        })
      [func](payload);
    }

    function setLoading(btnTextId, loading) {
      if (loading) {
        $('#' + btnTextId).html('<span class="spinner"></span>').addClass('pointer-events-none opacity-70');
      } else {
        var defaults = {
          'login-btn-text': 'เข้าสู่ระบบ',
          'reg-btn-text': 'สมัครสมาชิก',
          'vn-search-text': 'ค้นหาราคา',
          'sc-search-text': 'ค้นหาราคา'
        };
        $('#' + btnTextId).text(defaults[btnTextId] || 'ดำเนินการ').removeClass('pointer-events-none opacity-70');
      }
    }

    function showSection(id) {
      $('.section').removeClass('active').hide();
      var target = $('#' + id);
      target.addClass('active');
      if (id === 'sec-auth') {
        target.css('display', 'flex');
      } else {
        target.css('display', 'block');
      }
      window.scrollTo(0, 0);
    }

    // ── Tabs ─────────────────────────────────────────────────────
    function switchTab(tab) {
      if (tab === 'login') {
        $('#form-login').show();
        $('#form-register').hide();
        $('#tab-login').addClass('tab-active').removeClass('text-slate-500');
        $('#tab-register').removeClass('tab-active').addClass('text-slate-500');
      } else {
        $('#form-register').show();
        $('#form-login').hide();
        $('#tab-register').addClass('tab-active').removeClass('text-slate-500');
        $('#tab-login').removeClass('tab-active').addClass('text-slate-500');
      }
    }

    // ── Auth ──────────────────────────────────────────────────────
    function doLogin() {
      var email = $('#login-email').val().trim();
      var phone = $('#login-phone').val().trim();
      if (!email || !phone) { showToast('กรุณากรอกอีเมลและเบอร์โทร', 'error'); return; }
      setLoading('login-btn-text', true);
      gasCall('loginUser', JSON.stringify({ email: email, phone: phone }), function (res) {
        console.log('Login response', res);
        setLoading('login-btn-text', false);
        if (res.status === 'ok') {
          currentUser = res.data;
          var expiresAt = saveSession(currentUser);
          startAutoLogout(expiresAt);
          showToast('ยินดีต้อนรับ คุณ' + currentUser.nickname + ' 👋');
          afterLogin();
        } else {
          showToast(res.message, 'error');
        }
      });
    }

    function doRegister() {
      var payload = {
        company: $('#reg-company').val(),
        firstName: $('#reg-firstname').val().trim(),
        lastName: $('#reg-lastname').val().trim(),
        nickname: $('#reg-nickname').val().trim(),
        email: $('#reg-email').val().trim(),
        phone: $('#reg-phone').val().trim()
      };
      if (!payload.company || !payload.firstName || !payload.lastName ||
        !payload.nickname || !payload.email || !payload.phone) {
        showToast('กรุณากรอกข้อมูลให้ครบทุกช่อง', 'error'); return;
      }
      setLoading('reg-btn-text', true);
      gasCall('registerUser', JSON.stringify(payload), function (res) {
        setLoading('reg-btn-text', false);
        if (res.status === 'ok') {
          showToast('สมัครสมาชิกสำเร็จ! กรุณาเข้าสู่ระบบ');
          switchTab('login');
          $('#login-email').val(payload.email);
          $('#login-phone').val(payload.phone);
        } else {
          showToast(res.message, 'error');
        }
      });
    }

    function afterLogin() {
      if (currentUser.company === 'VN Phone') {
        $('#vn-welcome').text('คุณ' + currentUser.nickname + ' (' + currentUser.firstName + ')');
        showSection('sec-vn');
        vnInit();
      } else {
        $('#sc-welcome').text('คุณ' + currentUser.nickname + ' (' + currentUser.firstName + ')');
        showSection('sec-sc');
        scInit();
      }
    }

    function doLogout() {
      showToast('กำลังออกจากระบบ...', 'info');
      if (currentUser) {
        gasCall('logLogout', JSON.stringify(currentUser), function (res) {
          console.log('Logout logged', res);
        });
      }
      clearSession();
      currentUser = null;
      showSection('sec-auth');
      showToast('ออกจากระบบแล้ว', 'info');
      // reset
      $('#vn-brand, #vn-model, #vn-storage, #vn-down').val('');
      $('#vn-months').val('');
      $('.month-btn').removeClass('border-blue-500 ring-2 ring-blue-500/50 bg-blue-600 text-white font-bold');
      $('#vn-result').addClass('hidden');
      $('#sc-brand, #sc-model, #sc-storage').val('');
      $('#sc-result').addClass('hidden');
    }

    // ── helpers ─────────────────────────────────────────────────
    function autoSelect(selectId, nextFn) {
      var $sel = $(selectId);
      var realOpts = $sel.find('option').filter(function () { return $(this).val() !== ''; });
      if (realOpts.length === 1) {
        $sel.val(realOpts.first().val());
        if (nextFn) nextFn();
      }
    }

    // ── VN Phone ─────────────────────────────────────────────────
    function _vnSheet() { return (PRICE_DATA && PRICE_DATA.data) ? PRICE_DATA.data['ผ่อน'] : {}; }

    function vnInit() {
      var pd = _vnSheet();
      var brands = Object.keys(pd).sort();
      var opts = '<option value="">-- เลือกยี่ห้อ --</option>';
      brands.forEach(function (b) { opts += '<option value="' + b + '">' + b + '</option>'; });
      $('#vn-brand').html(opts);
      autoSelect('#vn-brand', vnLoadModels);
    }

    function vnLoadModels() {
      var brand = $('#vn-brand').val(), pd = _vnSheet();
      $('#vn-model').html('<option value="">-- เลือกรุ่น --</option>').prop('disabled', true);
      $('#vn-storage').html('<option value="">-- เลือกความจุ --</option>').prop('disabled', true);
      $('#vn-down').html('<option value="">-- เลือกราคาดาวน์ --</option>').prop('disabled', true);
      $('#vn-result').addClass('hidden');
      if (!brand) return;
      var models = Object.keys((pd[brand]) || {}).sort();
      var opts = '<option value="">-- เลือกรุ่น --</option>';
      models.forEach(function (m) { opts += '<option value="' + m + '">' + m + '</option>'; });
      $('#vn-model').html(opts).prop('disabled', false);
      autoSelect('#vn-model', vnLoadStorages);
    }

    function vnLoadStorages() {
      var brand = $('#vn-brand').val(), model = $('#vn-model').val(), pd = _vnSheet();
      $('#vn-storage').html('<option value="">-- เลือกความจุ --</option>').prop('disabled', true);
      $('#vn-down').html('<option value="">-- เลือกราคาดาวน์ --</option>').prop('disabled', true);
      $('#vn-result').addClass('hidden');
      if (!brand || !model) return;
      var storages = Object.keys(((pd[brand] || {})[model]) || {});
      var opts = '<option value="">-- เลือกความจุ --</option>';
      storages.forEach(function (s) { opts += '<option value="' + s + '">' + s + '</option>'; });
      $('#vn-storage').html(opts).prop('disabled', false);
      autoSelect('#vn-storage', vnLoadDownPayments);
    }

    function vnLoadDownPayments() {
      var brand = $('#vn-brand').val(), model = $('#vn-model').val(), storage = $('#vn-storage').val();
      var pd = _vnSheet();
      $('#vn-down').html('<option value="">-- เลือกราคาดาวน์ --</option>').prop('disabled', true);
      $('#vn-result').addClass('hidden');
      if (!brand || !model || !storage) return;
      var entries = ((pd[brand] || {})[model] || {})[storage] || [];
      var downs = entries.map(function (e) { return e.down; }).sort(function (a, b) { return a - b; });
      var opts = '<option value="">-- เลือกราคาดาวน์ --</option>';
      downs.forEach(function (d) { opts += '<option value="' + d + '">' + fmt(d) + ' บาท</option>'; });
      $('#vn-down').html(opts).prop('disabled', false);
      autoSelect('#vn-down', vnTrySearch);
    }

    // Month picker
    $(document).on('click', '.month-btn', function () {
      $('.month-btn').removeClass('border-blue-500 ring-2 ring-blue-500/50 bg-blue-600 text-white font-bold');
      $(this).addClass('border-blue-500 ring-2 ring-blue-500/50 bg-blue-600 text-white font-bold');
      $('#vn-months').val($(this).data('months'));
      vnTrySearch();
    });


    function vnTrySearch() {
      if ($('#vn-brand').val() && $('#vn-model').val() && $('#vn-storage').val() && $('#vn-down').val() && $('#vn-months').val()) vnSearch();
    }
    function scTrySearch() {
      if ($('#sc-brand').val() && $('#sc-model').val() && $('#sc-storage').val()) scSearch();
    }

    function vnSearch() {
      var brand = $('#vn-brand').val(), model = $('#vn-model').val(),
        storage = $('#vn-storage').val(), down = $('#vn-down').val(),
        months = $('#vn-months').val();
      if (!brand || !model || !storage || !down || !months) { return; }
      var colMap = { '6': 'm6', '8': 'm8', '10': 'm10', '12': 'm12' };
      var mKey = colMap[String(months)];
      var pd = _vnSheet();
      var entries = ((pd[brand] || {})[model] || {})[storage] || [];
      var entry = null;
      for (var i = 0; i < entries.length; i++) {
        if (Number(entries[i].down) === Number(down)) { entry = entries[i]; break; }
      }
      if (!entry || !mKey) { showToast('ไม่พบข้อมูลราคา', 'error'); return; }
      var installment = entry[mKey];
      var total = Number(down) + installment * Number(months);
      var html = [
        row(icon('store') + ' ร้าน', currentUser.company || '-'),
        row(icon('user') + ' พนักงาน', 'คุณ' + (currentUser.nickname || currentUser.firstName || '-')),
        row(icon('smartphone') + ' ยี่ห้อ / รุ่น', brand + ' ' + model),
        row(icon('hard-drive') + ' ความจุ', storage),
        row(icon('banknote') + ' เงินดาวน์', fmt(down) + ' บาท'),
        row(icon('calendar-days') + ' จำนวนงวด', months + ' เดือน'),
        '<div class="border-t border-slate-600 my-3"></div>',
        rowHighlight(icon('credit-card') + ' ค่างวดต่อเดือน', fmt(installment) + ' บาท/เดือน'),
        rowHighlight(icon('tag') + ' ราคารวมทั้งหมด', fmt(total) + ' บาท'),
        '<div class="mt-4 text-xs text-slate-500 inline-flex items-center justify-end w-full"><i data-lucide="clock" class="w-3 h-3 inline-block -translate-y-px mr-1"></i>ราคา ณ วันที่ ' + moment().format('LLL') + '</div>',
      ].join('');
      $('#vn-result-body').html(html);
      lucide.createIcons({ el: document.getElementById('vn-result-body') });
      $('#vn-result').removeClass('hidden');
      $('#vn-result')[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
      gasCall('logSearch', JSON.stringify({
        type: 'ผ่อน', company: currentUser.company, nickname: currentUser.nickname,
        firstName: currentUser.firstName, email: currentUser.email,
        brand: brand, model: model, storage: storage,
        down: Number(down), months: Number(months), installment: installment, total: total
      }), function () {});
    }

    // ── สยามชัย ──────────────────────────────────────────────────
    function _scSheet() { return (PRICE_DATA && PRICE_DATA.data) ? PRICE_DATA.data['ซื้อสด'] : {}; }

    function scInit() {
      var pd = _scSheet();
      var brands = Object.keys(pd).sort();
      var opts = '<option value="">-- เลือกยี่ห้อ --</option>';
      brands.forEach(function (b) { opts += '<option value="' + b + '">' + b + '</option>'; });
      $('#sc-brand').html(opts);
      autoSelect('#sc-brand', scLoadModels);
    }

    function scLoadModels() {
      var brand = $('#sc-brand').val(), pd = _scSheet();
      $('#sc-model').html('<option value="">-- เลือกรุ่น --</option>').prop('disabled', true);
      $('#sc-storage').html('<option value="">-- เลือกความจุ --</option>').prop('disabled', true);
      $('#sc-result').addClass('hidden');
      if (!brand) return;
      var models = Object.keys((pd[brand]) || {}).sort();
      var opts = '<option value="">-- เลือกรุ่น --</option>';
      models.forEach(function (m) { opts += '<option value="' + m + '">' + m + '</option>'; });
      $('#sc-model').html(opts).prop('disabled', false);
      autoSelect('#sc-model', scLoadStorages);
    }

    function scLoadStorages() {
      var brand = $('#sc-brand').val(), model = $('#sc-model').val(), pd = _scSheet();
      $('#sc-storage').html('<option value="">-- เลือกความจุ --</option>').prop('disabled', true);
      $('#sc-result').addClass('hidden');
      if (!brand || !model) return;
      var storages = Object.keys(((pd[brand] || {})[model]) || {});
      var opts = '<option value="">-- เลือกความจุ --</option>';
      storages.forEach(function (s) { opts += '<option value="' + s + '">' + s + '</option>'; });
      $('#sc-storage').html(opts).prop('disabled', false);
      autoSelect('#sc-storage', scTrySearch);
    }

    function scSearch() {
      var brand = $('#sc-brand').val(), model = $('#sc-model').val(), storage = $('#sc-storage').val();
      if (!brand || !model || !storage) { return; }
      var pd = _scSheet();
      var price = ((pd[brand] || {})[model] || {})[storage];
      if (price === undefined || price === null) { showToast('ไม่พบข้อมูลราคา', 'error'); return; }
      var html = [
        row(icon('store') + ' ร้าน', currentUser.company || '-'),
        row(icon('user') + ' พนักงาน', 'คุณ' + (currentUser.nickname || currentUser.firstName || '-')),
        row(icon('smartphone') + ' ยี่ห้อ / รุ่น', brand + ' ' + model),
        row(icon('hard-drive') + ' ความจุ', storage),
        '<div class="border-t border-slate-600 my-3"></div>',
        rowHighlight(icon('tag') + ' ราคาซื้อสด', fmt(price) + ' บาท'),
        '<div class="mt-4 text-xs text-slate-500 inline-flex items-center justify-end w-full"><i data-lucide="clock" class="w-3 h-3 inline-block -translate-y-px mr-1"></i>ราคา ณ วันที่ ' + moment().format('LLL') + '</div>',
      ].join('');
      $('#sc-result-body').html(html);
      lucide.createIcons({ el: document.getElementById('sc-result-body') });
      $('#sc-result').removeClass('hidden');
      $('#sc-result')[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
      gasCall('logSearch', JSON.stringify({
        type: 'ซื้อสด', company: currentUser.company, nickname: currentUser.nickname,
        firstName: currentUser.firstName, email: currentUser.email,
        brand: brand, model: model, storage: storage, price: price
      }), function () {});
    }

    // ── Row helpers ───────────────────────────────────────────────
    function row(label, value) {
      return '<div class="flex justify-between items-center py-2 border-b border-slate-700 last:border-0">'
        + '<span class="text-slate-400 text-sm font-medium inline-flex items-center">' + label + '</span>'
        + '<span class="text-slate-200 text-sm font-semibold">' + value + '</span>'
        + '</div>';
    }
    function icon(name) {
      return '<i data-lucide="' + name + '" class="w-3.5 h-3.5 inline-block -translate-y-px mr-1.5"></i>';
    }

    function downloadCard(cardId, type) {
      var el = document.getElementById(cardId);
      if (!el) return;
      html2canvas(el, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        onclone: function (clonedDoc) {
          var c = clonedDoc.getElementById(cardId);
          c.style.borderRadius = '0';
          c.style.background = '#ffffff';
          c.style.border = '1px solid #e2e8f0';
          c.style.boxShadow = 'none';
          c.style.padding = '1.5rem';
          // inject overrides as a style tag
          var s = clonedDoc.createElement('style');
          s.textContent = [
            '#' + cardId + ' { color: #1e293b !important; }',
            '#' + cardId + ' .border-slate-700 { border-color: #e2e8f0 !important; }',
            '#' + cardId + ' .border-slate-600 { border-color: #e2e8f0 !important; }',
            '#' + cardId + ' .text-slate-400 { color: #64748b !important; }',
            '#' + cardId + ' .text-slate-200 { color: #1e293b !important; }',
            '#' + cardId + ' .text-slate-500 { color: #94a3b8 !important; }',
            '#' + cardId + ' .text-slate-300 { color: #475569 !important; }',
            '#' + cardId + ' .text-blue-400 { color: #2563eb !important; }',
            '#' + cardId + ' .text-blue-100 { color: #1e40af !important; }',
            '#' + cardId + ' .bg-blue-900\\/50 { background: #dbeafe !important; }',
            '#' + cardId + ' .bg-blue-900\\/30 { background: #eff6ff !important; }',
            '#' + cardId + ' .ring-blue-900\\/50 { --tw-ring-color: #bfdbfe !important; }',
          
          ].join('\n');
          clonedDoc.head.appendChild(s);

          var svgs = c.querySelectorAll('svg');
          for (var i = 0; i < svgs.length; i++) {
            svgs[i].style.transform = 'none';
            svgs[i].style.verticalAlign = 'middle';
            svgs[i].style.display = 'inline-block';
            svgs[i].style.position = 'static';
          }

        }
      }).then(function (canvas) {
        var fname = 'price_' + type + '_' + moment().format('YYYYMMDD_HHmm') + '.png';
        var link = document.createElement('a');
        link.download = fname;
        link.href = canvas.toDataURL('image/png');
        link.click();
        var extra = type === 'ผ่อน'
          ? { brand: $('#vn-brand').val(), model: $('#vn-model').val(), storage: $('#vn-storage').val(),
              down: Number($('#vn-down').val()), months: Number($('#vn-months').val()) }
          : { brand: $('#sc-brand').val(), model: $('#sc-model').val(), storage: $('#sc-storage').val() };
        gasCall('logSearch', JSON.stringify(Object.assign({
          type: 'ดาวน์โหลด ' + type,
          nickname: currentUser.nickname, firstName: currentUser.firstName, email: currentUser.email
        }, extra)), function () {});
      });
    }
    function rowHighlight(label, value) {
      return '<div class="flex justify-between items-center py-3 px-4 rounded-xl bg-blue-900/30 mt-2">'
        + '<span class="text-blue-400 text-sm font-bold inline-flex items-center">' + label + '</span>'
        + '<span class="text-blue-100 font-extrabold text-base">' + value + '</span>'
        + '</div>';
    }

    // ── Restore session on page load ──────────────────────────────
    $(document).ready(function () {
      if (typeof lucide !== 'undefined') lucide.createIcons();

      // Enter key submits login form
      $('#login-email, #login-phone').on('keydown', function (e) {
        if (e.key === 'Enter') doLogin();
      });

      var session = loadSession();
      if (session) {
        currentUser = session.user;
        startAutoLogout(session.expiresAt);
        afterLogin();
      }
    });
  </script>
</body>

</html>