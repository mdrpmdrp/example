<!DOCTYPE html>
<html lang="en">

<head>
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ACC maintenance work list</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .section-card {
            transition: all 0.3s ease;
        }

        .section-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .spare-parts-container {
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden-section {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/rangePlugin.js"></script>
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/tanaikech/ResumableUploadForGoogleDrive_js@master/resumableupload_js.min.js">
        </script>

    <!-- Main Container -->
    <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-8 px-4 sm:px-6 lg:px-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-tools text-red-600 mr-3"></i>
                            Maintenance Work Order
                        </h1>
                        <p class="text-gray-600 mt-2 flex items-center">
                            <i class="fas fa-info-circle text-red-500 mr-2"></i>
                            Create and manage maintenance work orders
                        </p>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="mb-6 border-b-2 border-gray-300">
                <div class="flex space-x-2">
                    <!-- Dashboard Tab -->
                    <button type="button" id="dashboardTab" class="tab-nav-btn px-6 py-3 font-semibold text-gray-700 border-b-4 border-red-600 text-red-600 transition hover:text-red-700" data-tab="dashboard">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </button>
                    
                    <!-- Create/Update Tab -->
                    <button type="button" id="createUpdateTab" class="tab-nav-btn px-6 py-3 font-semibold text-gray-700 border-b-4 border-transparent hover:border-gray-400 transition" data-tab="create-update">
                        <i class="fas fa-plus-circle mr-2"></i>Create / Update
                    </button>
                </div>
            </div>

            <!-- Create/Update Tab Content -->
            <div id="createUpdateTabContent" class="tab-content-section hidden">
            <!-- Form Container -->
            <form id="workOrderForm" class="space-y-6">
                <!-- 1. SUPERVISOR DETAILS SECTION -->
                <div class="section-card bg-white rounded-xl shadow-md border-l-4 border-red-600 p-6">
                    <div class="flex items-center mb-6 pb-4 border-b-2 border-gray-200">
                        <i class="fas fa-user-tie text-red-600 mr-3 text-xl"></i>
                        <h2 class="text-2xl font-bold text-gray-900">Supervisor Details</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- User ID -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-id-card text-gray-500 mr-2"></i>User ID
                            </label>
                            <input type="text" id="supervisorUserId" placeholder="Enter User ID"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition">
                        </div>

                        <!-- Name -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-user text-gray-500 mr-2"></i>Name
                            </label>
                            <input type="text" id="supervisorName" placeholder="Enter Full Name"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <!-- Plan (Start and Finish Time) -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-calendar-alt text-gray-500 mr-2"></i>Plan Date
                            </label>
                            <input type="text" id="supervisorPlanDate" placeholder="Select date"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition"
                                readonly>
                        </div>
                        <!-- Start Time -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-play-circle text-green-500 mr-2"></i>Start Time
                            </label>
                            <input type="time" id="supervisorStartTime"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition">
                        </div>

                        <!-- Finish Time -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-stop-circle text-red-500 mr-2"></i>Finish Time
                            </label>
                            <input type="time" id="supervisorFinishTime"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition">
                        </div>
                    </div>
                </div>

                <!-- 2. WORK ORDER DETAILS SECTION -->
                <div class="section-card bg-white rounded-xl shadow-md border-l-4 border-gray-600 p-6">
                    <div class="flex items-center mb-6 pb-4 border-b-2 border-gray-200">
                        <i class="fas fa-clipboard-list text-gray-600 mr-3 text-xl"></i>
                        <h2 class="text-2xl font-bold text-gray-900">Work Order Details</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                        <!-- Work Order ID input -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-hashtag text-gray-500 mr-2"></i>Work Order ID
                            </label>
                            <input type="text" id="workOrderID" placeholder="Enter Work Order ID"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition">
                        </div>

                        <!-- Date (Auto to today) -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-calendar text-gray-500 mr-2"></i>Date (Auto to today)
                            </label>
                            <input type="text" id="workOrderDate" placeholder="Today's Date"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 outline-none"
                                readonly>
                        </div>

                        <!-- Has Work Order Checkbox
                        <div class="flex items-end">
                            <label class="flex items-center space-x-3 cursor-pointer group">
                                <div class="relative">
                                    <input type="checkbox" id="hasWorkOrderCheckbox" checked
                                        class="w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500 cursor-pointer">
                                </div>
                                <span class="text-sm font-semibold text-gray-700 group-hover:text-red-600">
                                    </i>Has Work Order
                                </span>
                            </label>
                        </div> -->
                    </div>

                    <!-- Work Order Details (Textarea) - Shown when checked -->
                    <div id="workOrderDetailsContainer" class="mt-6 spare-parts-container hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-pen-square text-gray-500 mr-2"></i>Work Order Details
                        </label>
                        <textarea id="workOrderDetailsText" placeholder="Enter work order details here..." rows="5"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition resize-none"></textarea>
                    </div>

                    <!-- Spare Parts Section - Hidden initially -->
                    <div id="sparePartDetailsContainer" class="mt-6">
                        <div class="spare-parts-container">
                                <div class="flex items-center justify-between text-sm mb-3">
                                    <div class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-box mr-3"></i>
                                        <span class="">Spare Parts List</span>
                                    </div>
                                </div>

                                <div id="partsListContainer" class="space-y-4">
                                    <!-- Part Item Template -->
                                    <div class="part-item bg-gray-50 p-4 rounded-lg border-2 border-gray-200 hover:border-gray-400 transition"
                                        data-part-index="0">
                                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                                            <!-- Part ID -->
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                    <i class="fas fa-barcode text-gray-500 mr-2"></i>Part ID
                                                </label>
                                                <input type="text"
                                                    class="part-id w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-200 outline-none transition"
                                                    placeholder="Enter Part ID">
                                            </div>

                                            <!-- Size -->
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                    <i class="fas fa-ruler text-gray-500 mr-2"></i>Size
                                                </label>
                                                <input type="text"
                                                    class="part-size w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-200 outline-none transition"
                                                    placeholder="e.g., 100mm">
                                            </div>

                                            <!-- Unit -->
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                    <i class="fas fa-cube text-gray-500 mr-2"></i>Unit
                                                </label>
                                                <select
                                                    class="part-unit w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-200 outline-none transition">
                                                    <option value="">-- Select Unit --</option>
                                                    <option value="pcs">Pieces (pcs)</option>
                                                    <option value="set">Set</option>
                                                    <option value="box">Box</option>
                                                    <option value="meter">Meter</option>
                                                    <option value="kg">Kilogram (kg)</option>
                                                </select>
                                            </div>

                                            <!-- Quantity -->
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                    <i class="fas fa-sort-numeric-up text-gray-500 mr-2"></i>Quantity
                                                </label>
                                                <input type="number"
                                                    class="part-quantity w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-200 outline-none transition"
                                                    placeholder="0" min="0">
                                            </div>

                                            <!-- Delete Button -->
                                            <div class="flex gap-2">
                                                <button type="button"
                                                    class="delete-part-btn flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg transition transform hover:scale-105">
                                                    <i class="fas fa-trash mr-2"></i>Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Add More Parts Button -->
                                <button type="button" id="addMorePartsBtn"
                                    class="mt-4 w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-2 px-4 rounded-lg transition transform flex items-center justify-center">
                                    <i class="fas fa-plus mr-2"></i>Add More Spare Parts
                                </button>
                            </div>
                    </div>
                </div>

                <!-- 3. CONTRACTOR INFORMATION SECTION -->
                <div class="section-card bg-white rounded-xl shadow-md border-l-4 border-red-600 p-6">
                    <div class="flex items-center mb-6 pb-4 border-b-2 border-gray-200">
                        <i class="fas fa-building text-red-600 mr-3 text-xl"></i>
                        <h2 class="text-2xl font-bold text-gray-900">Contractor Information</h2>
                    </div>

                    <div id="contractorListContainer" class="space-y-4">
                        <!-- Contractor Item Template -->
                        <div class="contractor-item bg-gray-50 p-4 rounded-lg border-2 border-gray-200 hover:border-red-300 transition" data-contractor-index="0">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <!-- Contractor Type -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-layer-group text-gray-500 mr-2"></i>Type
                                    </label>
                                    <select class="contractor-type w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition">
                                        <option value="">-- Select Type --</option>
                                        <option value="internal">Internal</option>
                                        <option value="external">External</option>
                                    </select>
                                </div>
                                <!-- Contractor Selection -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-briefcase text-gray-500 mr-2"></i>Contractor
                                    </label>
                                    <select class="contractor-select w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition">
                                        <option value="">-- Select Contractor --</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end mt-4">

                                <!-- Custom Contractor Name (shown when external "other" selected) -->
                                <div class="contractor-custom-name-div hidden">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-pen text-gray-500 mr-2"></i>Contractor Name
                                    </label>
                                    <input type="text" class="contractor-custom-name w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition" placeholder="Enter contractor name">
                                </div>

                                <!-- Quantity -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-sort-numeric-up text-gray-500 mr-2"></i>Quantity
                                    </label>
                                    <input type="number" class="contractor-quantity w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition" placeholder="0" min="0">
                                </div>

                                <!-- Plan Date -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-calendar-alt text-gray-500 mr-2"></i>Plan Date
                                    </label>
                                    <input type="text" class="contractor-plan-date w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition" placeholder="Select date" readonly>
                                </div>
                                <!-- Start Time -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-play-circle text-green-500 mr-2"></i>Start Time
                                    </label>
                                    <input type="time" class="contractor-start-time w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition">
                                </div>

                                <!-- Finish Time -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-stop-circle text-red-500 mr-2"></i>Finish Time
                                    </label>
                                    <input type="time" class="contractor-finish-time w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition">
                                </div>

                                <!-- Delete Button -->
                                <div>
                                    <button type="button" class="delete-contractor-btn w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg transition transform hover:scale-105">
                                        <i class="fas fa-trash mr-2"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add More Contractors Button -->
                    <button type="button" id="addMoreContractorBtn" class="mt-4 w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-2 px-4 rounded-lg transition transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i>Add More Contractor
                    </button>
                </div>

                <!-- Form Action Buttons -->
                <div class="flex gap-4 justify-end pt-8">
                    <button type="reset"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-8 rounded-lg transition transform hover:scale-105">
                        <i class="fas fa-redo mr-2"></i>Reset
                    </button>
                    <button type="submit"
                        class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-8 rounded-lg transition transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i>Save Work Order
                    </button>
                </div>
            </form>
            </div>

            <!-- Dashboard Tab Content -->
            <div id="dashboardTabContent" class="tab-content-section">
                <div class="bg-white rounded-xl shadow-md p-8 border-l-4 border-red-600">
                    <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-200">
                        <div class="flex items-center">
                            <i class="fas fa-chart-line text-red-600 mr-3 text-2xl"></i>
                            <h2 class="text-2xl font-bold text-gray-900">Dashboard</h2>
                        </div>
                        
                        <!-- Department Selector -->
                        <div class="flex items-center space-x-3">
                            <label class="text-sm font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-building text-red-600 mr-2"></i>Department:
                            </label>
                            <select id="departmentSelector" class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition font-semibold text-gray-700 bg-white cursor-pointer">
                                <option value="">-- All Departments --</option>
                                <option value="M1">M1</option>
                                <option value="M2">M2</option>
                                <option value="M3">M3</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <!-- Placeholder Cards -->
                        <div class="bg-gradient-to-br from-red-50 to-gray-50 rounded-lg p-6 border-l-4 border-red-600">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-semibold">Total Work Orders</p>
                                    <p class="text-3xl font-bold text-red-600 mt-2">--</p>
                                </div>
                                <i class="fas fa-file-alt text-red-200 text-4xl"></i>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-red-50 to-gray-50 rounded-lg p-6 border-l-4 border-gray-600">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-semibold">Contractors</p>
                                    <p class="text-3xl font-bold text-gray-600 mt-2">--</p>
                                </div>
                                <i class="fas fa-users text-gray-200 text-4xl"></i>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-red-50 to-gray-50 rounded-lg p-6 border-l-4 border-red-600">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-semibold">Spare Parts</p>
                                    <p class="text-3xl font-bold text-red-600 mt-2">--</p>
                                </div>
                                <i class="fas fa-box text-red-200 text-4xl"></i>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-red-50 to-gray-50 rounded-lg p-6 border-l-4 border-gray-600">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-semibold">This Month</p>
                                    <p class="text-3xl font-bold text-gray-600 mt-2">--</p>
                                </div>
                                <i class="fas fa-calendar text-gray-200 text-4xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Coming Soon Message -->
                    <div class="bg-gradient-to-r from-red-100 to-gray-100 rounded-lg p-8 text-center border-2 border-red-300">
                        <i class="fas fa-chart-bar text-red-600 text-5xl mb-4 opacity-50"></i>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Dashboard Features Coming Soon</h3>
                        <p class="text-gray-700">
                            Advanced analytics, charts, and statistics will be implemented in the next update.
                        </p>
                        <p class="text-gray-600 text-sm mt-4">
                            <i class="fas fa-info-circle mr-2"></i>
                            Check back later for detailed insights and reports.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // get dashboard data
            loadDashboardData();
            // Initialize date fields to today
            const today = new Date().toLocaleDateString('en-CA');
            $('#workOrderDate').val(moment().format('DD/MM/YYYY')).data('alt-date', today);

            // Initialize flatpickr for date selectors (Thai locale)
            flatpickr('#supervisorPlanDate', {
                locale: 'th',
                dateFormat: 'Y-m-d',
                altFormat: 'd/m/Y',
                altInput: true,
                defaultDate: today
            });

            // Initialize first contractor date picker
            flatpickr('.contractor-plan-date', {
                locale: 'th',
                dateFormat: 'Y-m-d',
                altFormat: 'd/m/Y',
                altInput: true,
                defaultDate: today
            });
            flatpickr('.contractor-start-time', {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true,
                time_24hr: true,
                defaultDate: "08:00"
            });
            flatpickr('.contractor-finish-time', {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true,
                time_24hr: true,
                defaultDate: "17:00"
            });

            flatpickr('#supervisorStartTime', {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true,
                time_24hr: true,
                defaultDate: "08:00"
            });
            flatpickr('#supervisorFinishTime', {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true,
                time_24hr: true,
                defaultDate: "17:00"
            });

            // Handle Work Order Checkbox - Toggle between work order details and spare parts
            $('#workOrderID').on('keyup', function () {
                if ($(this).val().trim() !== '') {
                    // Show work order details, hide spare parts
                    $('#workOrderDetailsContainer').removeClass('hidden');
                    $('#workOrderDetailsText').val('');
                    $('#sparePartDetailsContainer').addClass('hidden');
                    $('.part-item').not(':first').remove();
                    $('.part-id, .part-size, .part-unit, .part-quantity').val('');
                } else {
                    // Hide work order details, show spare parts
                    $('#workOrderDetailsContainer').addClass('hidden');
                    $('#spareParts').removeClass('hidden').addClass('spare-parts-container');
                    $('#sparePartDetailsContainer').removeClass('hidden');
                }
            });

            // Contractor type and selection options
            const contractorOptions = {
                internal: [
                    { value: 'EME', label: 'EME' },
                    { value: 'BKS', label: 'BKS' },
                    { value: 'PC-Plus', label: 'PC-Plus' },
                    { value: 'LM', label: 'LM' }
                ],
                external: [
                    { value: 'P.Con', label: 'P.Con' },
                    { value: 'AP Machine', label: 'AP Machine' },
                    { value: 'other', label: 'อื่นๆ (กรอกเอง)' }
                ]
            };

            // Handle Contractor Tab Switching
            $('.tab-button').click(function (e) {
                e.preventDefault();
                const tab = $(this).data('tab');

                // Update active tab styling
                $('.tab-button').removeClass('border-purple-500').addClass('border-transparent');
                $(this).removeClass('border-transparent').addClass('border-purple-500');

                // Show/hide tab content
                if (tab === 'internal') {
                    $('#internalContractorSection').removeClass('hidden');
                    $('#externalContractorSection').addClass('hidden');
                } else {
                    $('#internalContractorSection').addClass('hidden');
                    $('#externalContractorSection').removeClass('hidden');
                }
            });

            // Update contractor options when type changes
            $(document).on('change', '.contractor-type', function() {
                const type = $(this).val();
                const $contractorItem = $(this).closest('.contractor-item');
                const $contractorSelect = $contractorItem.find('.contractor-select');
                const $customNameDiv = $contractorItem.find('.contractor-custom-name-div');

                // Clear and update options
                $contractorSelect.html('<option value="">-- Select Contractor --</option>');

                if (type) {
                    const options = contractorOptions[type] || [];
                    options.forEach(option => {
                        $contractorSelect.append(`<option value="${option.value}">${option.label}</option>`);
                    });
                }

                // Hide custom name div initially
                $customNameDiv.addClass('hidden');
            });

            // Handle external contractor custom name visibility
            $(document).on('change', '.contractor-select', function() {
                const $contractorItem = $(this).closest('.contractor-item');
                const type = $contractorItem.find('.contractor-type').val();
                const value = $(this).val();
                const $customNameDiv = $contractorItem.find('.contractor-custom-name-div');

                if (type === 'external' && value === 'other') {
                    $customNameDiv.removeClass('hidden');
                } else {
                    $customNameDiv.addClass('hidden');
                }
            });

            // Add More Contractors
            let contractorIndex = 1;
            $('#addMoreContractorBtn').click(function(e) {
                e.preventDefault();
                const newContractorHTML = `
                    <div class="contractor-item bg-gray-50 p-4 rounded-lg border-2 border-gray-200 hover:border-red-300 transition" data-contractor-index="${contractorIndex}">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <!-- Contractor Type -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-layer-group text-gray-500 mr-2"></i>Type
                                </label>
                                <select class="contractor-type w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none transition">
                                    <option value="">-- Select Type --</option>
                                    <option value="internal">Internal</option>
                                    <option value="external">External</option>
                                </select>
                            </div>
                            <!-- Contractor Selection -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-briefcase text-gray-500 mr-2"></i>Contractor
                                </label>
                                <select class="contractor-select w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                                    <option value="">-- Select Contractor --</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end mt-4">

                            <!-- Custom Contractor Name (shown when external "other" selected) -->
                            <div class="contractor-custom-name-div hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-pen text-gray-500 mr-2"></i>Contractor Name
                                </label>
                                <input type="text" class="contractor-custom-name w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition" placeholder="Enter contractor name">
                            </div>
                            <!-- Quantity -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-sort-numeric-up text-gray-500 mr-2"></i>Quantity
                                </label>
                                <input type="number" class="contractor-quantity w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition" placeholder="0" min="0">   
                            </div>
                            <!-- Plan Date -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt text-gray-500 mr-2"></i>Plan Date
                                </label>
                                <input type="text" class="contractor-plan-date w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition" placeholder="Select date" readonly>
                            </div>
                            <!-- Start Time -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-play-circle text-green-500 mr-2"></i>Start Time
                                </label>
                                <input type="time" class="contractor-start-time w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                            </div>
                            <!-- Finish Time -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-stop-circle text-red-500 mr-2"></i>Finish Time
                                </label>
                                <input type="time" class="contractor-finish-time w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                            </div>
                            <!-- Delete Button -->
                            <div>
                                <button type="button" class="delete-contractor-btn w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg transition transform hover:scale-105">
                                    <i class="fas fa-trash mr-2"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                $('#contractorListContainer').append(newContractorHTML);
                
                // Initialize flatpickr for new date field
                const newDateInput = $(`[data-contractor-index="${contractorIndex}"] .contractor-plan-date`);
                flatpickr(newDateInput[0], {
                    locale: 'th',
                    dateFormat: 'Y-m-d',
                    altFormat: 'd/m/Y',
                    altInput: true,
                    defaultDate: today
                });
                flatpickr($(`[data-contractor-index="${contractorIndex}"] .contractor-start-time`)[0], {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "H:i",
                    allowInput: true,
                    time_24hr: true,
                    defaultDate: "08:00"
                });
                flatpickr($(`[data-contractor-index="${contractorIndex}"] .contractor-finish-time`)[0], {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "H:i",
                    allowInput: true,
                    time_24hr: true,
                    defaultDate: "17:00"
                });
                
                contractorIndex++;
            });

            // Delete Contractor
            $(document).on('click', '.delete-contractor-btn', function(e) {
                e.preventDefault();
                $(this).closest('.contractor-item').fadeOut(300, function() {
                    $(this).remove();
                });
            });

            // Add More Spare Parts
            let partIndex = 1;
            $('#addMorePartsBtn').click(function (e) {
                e.preventDefault();
                const newPartHTML = `
                    <div class="part-item bg-gray-50 p-4 rounded-lg border-2 border-gray-200 hover:border-orange-300 transition animate-in" data-part-index="${partIndex}">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-barcode text-gray-500 mr-2"></i>Part ID
                                </label>
                                <input type="text" class="part-id w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 outline-none transition" placeholder="Enter Part ID">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-ruler text-gray-500 mr-2"></i>Size
                                </label>
                                <input type="text" class="part-size w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 outline-none transition" placeholder="e.g., 100mm">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-cube text-gray-500 mr-2"></i>Unit
                                </label>
                                <select class="part-unit w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 outline-none transition">
                                    <option value="">-- Select Unit --</option>
                                    <option value="pcs">Pieces (pcs)</option>
                                    <option value="set">Set</option>
                                    <option value="box">Box</option>
                                    <option value="meter">Meter</option>
                                    <option value="kg">Kilogram (kg)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-sort-numeric-up text-gray-500 mr-2"></i>Quantity
                                </label>
                                <input type="number" class="part-quantity w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 outline-none transition" placeholder="0" min="0">
                            </div>

                            <div class="flex gap-2">
                                <button type="button" class="delete-part-btn flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg transition transform hover:scale-105">
                                    <i class="fas fa-trash mr-2"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                $('#partsListContainer').append(newPartHTML);
                partIndex++;
            });

            // Delete Spare Part
            $(document).on('click', '.delete-part-btn', function (e) {
                e.preventDefault();
                $(this).closest('.part-item').fadeOut(300, function () {
                    $(this).remove();
                });
            });

            // Form Submission
            $('#workOrderForm').submit(function (e) {
                e.preventDefault();

                // Show loading spinner
                Swal.fire({
                    title: 'Processing...',
                    text: 'Saving work order...',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Collect contractors data
                const contractors = [];
                $('.contractor-item').each(function() {
                    const type = $(this).find('.contractor-type').val();
                    let contractor = $(this).find('.contractor-select').val();
                    
                    // Use custom name if external "other" is selected
                    if (type === 'external' && contractor === 'other') {
                        contractor = $(this).find('.contractor-custom-name').val();
                    }

                    contractors.push({
                        type: type,
                        contractor: contractor,
                        quantity: $(this).find('.contractor-quantity').val(),
                        planDate: $(this).find('.contractor-plan-date').val(),
                        startTime: $(this).find('.contractor-start-time').val(),
                        finishTime: $(this).find('.contractor-finish-time').val()
                    });
                });

                // Collect form data
                const formData = {
                    supervisor: {
                        userId: $('#supervisorUserId').val(),
                        name: $('#supervisorName').val(),
                        planDate: $('#supervisorPlanDate').val(),
                        startTime: $('#supervisorStartTime').val(),
                        finishTime: $('#supervisorFinishTime').val()
                    },
                    workOrder: {
                        date: $('#workOrderDate').val(),
                        workOrderID: $('#workOrderID').val(),
                        details: $('#workOrderDetailsText').val()
                    },
                    contractors: contractors,
                    spareParts: []
                };

                // Collect spare parts
                $('.part-item').each(function () {
                    const part = {
                        id: $(this).find('.part-id').val(),
                        size: $(this).find('.part-size').val(),
                        unit: $(this).find('.part-unit').val(),
                        quantity: $(this).find('.part-quantity').val()
                    };
                    formData.spareParts.push(part);
                });

                console.log('Form Data:', formData);

                // Call backend function
                google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).submitWorkOrder(formData);
            });

            /**
             * Success handler for form submission
             */
            function onSuccess(response) {
                console.log('Response:', response);
                
                if (response.success) {
                    Swal.fire({
                        title: 'Success!',
                        html: `Work Order <strong>${response.workOrderId}</strong> has been saved successfully!<br><small>${response.timestamp}</small>`,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Reset form
                        $('#workOrderForm')[0].reset();
                        // Reset date fields
                        $('#workOrderDate').val(moment().format('DD/MM/YYYY'));
                        // Reset contractors to show only first item
                        $('.contractor-item').not(':first').remove();
                        $('.contractor-type, .contractor-select').val('');
                        $('.contractor-custom-name-div').addClass('hidden');
                        $('.contractor-quantity, .contractor-start-time, .contractor-finish-time').val('');
                        flatpickr('.contractor-plan-date', {
                            locale: 'th',
                            dateFormat: 'Y-m-d',
                            altFormat: 'd/m/Y',
                            altInput: true
                        });
                        // Reset spare parts
                        $('.part-item').not(':first').remove();
                        $('.part-id, .part-size, .part-unit, .part-quantity').val('');
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: response.message || 'An error occurred while saving the work order',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            }

            /**
             * Error handler for form submission
             */
            function onFailure(error) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to save work order: ' + error.toString(),
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }

            /**
             * Load work orders from backend
             */
            function loadWorkOrders() {
                google.script.run.withSuccessHandler(function(response) {
                    console.log('Work Orders:', response);
                    if (response.success) {
                        console.log('Loaded ' + response.count + ' work orders');
                    }
                }).getWorkOrders(100);
            }

            /**
             * Get work order details by ID
             */
            function loadWorkOrderDetails(workOrderId) {
                google.script.run.withSuccessHandler(function(response) {
                    console.log('Work Order Details:', response);
                    if (response.success) {
                        populateFormWithData(response.workOrder, response.contractors, response.spareParts);
                    }
                }).getWorkOrderDetails(workOrderId);
            }

            /**
             * Populate form with existing data
             */
            function populateFormWithData(workOrder, contractors, spareParts) {
                // Populate supervisor details
                $('#supervisorUserId').val(workOrder['Supervisor User ID'] || '');
                $('#supervisorName').val(workOrder['Supervisor Name'] || '');
                $('#supervisorPlanDate').val(workOrder['Supervisor Plan Date'] || '');
                $('#supervisorStartTime').val(workOrder['Supervisor Start Time'] || '');
                $('#supervisorFinishTime').val(workOrder['Supervisor Finish Time'] || '');

                // Populate work order details
                $('#workOrderID').val(workOrder['Work Order ID'] || '');
                $('#workOrderDetailsText').val(workOrder['Work Order Details'] || '');

                // Clear and repopulate contractors
                $('.contractor-item').not(':first').remove();
                if (contractors && contractors.length > 0) {
                    contractors.forEach((contractor, index) => {
                        if (index === 0) {
                            // Populate first contractor
                            const $firstContractor = $('.contractor-item:first');
                            $firstContractor.find('.contractor-type').val(contractor['Contractor Type'] || '').trigger('change');
                            setTimeout(() => {
                                $firstContractor.find('.contractor-select').val(contractor['Contractor Name'] || '').trigger('change');
                                $firstContractor.find('.contractor-quantity').val(contractor['Quantity'] || '');
                                $firstContractor.find('.contractor-plan-date').val(contractor['Plan Date'] || '');
                                $firstContractor.find('.contractor-start-time').val(contractor['Start Time'] || '');
                                $firstContractor.find('.contractor-finish-time').val(contractor['Finish Time'] || '');
                            }, 100);
                        } else {
                            // Add additional contractors
                            $('#addMoreContractorBtn').click();
                            const $newContractor = $('.contractor-item:last');
                            $newContractor.find('.contractor-type').val(contractor['Contractor Type'] || '').trigger('change');
                            setTimeout(() => {
                                $newContractor.find('.contractor-select').val(contractor['Contractor Name'] || '').trigger('change');
                                $newContractor.find('.contractor-quantity').val(contractor['Quantity'] || '');
                                $newContractor.find('.contractor-plan-date').val(contractor['Plan Date'] || '');
                                $newContractor.find('.contractor-start-time').val(contractor['Start Time'] || '');
                                $newContractor.find('.contractor-finish-time').val(contractor['Finish Time'] || '');
                            }, 100);
                        }
                    });
                }

                // Clear and repopulate spare parts
                $('.part-item').not(':first').remove();
                if (spareParts && spareParts.length > 0) {
                    spareParts.forEach((part, index) => {
                        if (index === 0) {
                            // Populate first part
                            const $firstPart = $('.part-item:first');
                            $firstPart.find('.part-id').val(part['Part ID'] || '');
                            $firstPart.find('.part-size').val(part['Size'] || '');
                            $firstPart.find('.part-unit').val(part['Unit'] || '');
                            $firstPart.find('.part-quantity').val(part['Quantity'] || '');
                        } else {
                            // Add additional parts
                            $('#addMorePartsBtn').click();
                            const $newPart = $('.part-item:last');
                            $newPart.find('.part-id').val(part['Part ID'] || '');
                            $newPart.find('.part-size').val(part['Size'] || '');
                            $newPart.find('.part-unit').val(part['Unit'] || '');
                            $newPart.find('.part-quantity').val(part['Quantity'] || '');
                        }
                    });
                }
            }

            // Tab Navigation Handler
            $('.tab-nav-btn').click(function(e) {
                e.preventDefault();
                const tabName = $(this).data('tab');

                // Update tab buttons
                $('.tab-nav-btn').removeClass('border-red-600 text-red-600').addClass('border-transparent');
                $(this).removeClass('border-transparent').addClass('border-red-600 text-red-600');

                // Hide all tab contents
                $('.tab-content-section').addClass('hidden');

                // Show selected tab content
                if (tabName === 'create-update') {
                    $('#createUpdateTabContent').removeClass('hidden');
                } else if (tabName === 'dashboard') {
                    $('#dashboardTabContent').removeClass('hidden');
                }
            });

            // Department Selector Change Handler
            $('#departmentSelector').change(function() {
                const selectedDepartment = $(this).val();
                console.log('Selected Department:', selectedDepartment);
                
                // Here you can add logic to filter dashboard data based on selected department
                // This will be implemented when backend functions are added
                
                if (selectedDepartment) {
                    console.log('Loading dashboard data for department:', selectedDepartment);
                    // Future: Call backend function to fetch department-specific data
                    // Example: google.script.run.withSuccessHandler(callback).getDashboardData(selectedDepartment);
                } else {
                    console.log('Loading all departments data');
                    // Future: Call backend function to fetch all departments data
                }
            });
        });

        function loadDashboardData() {
            Swal.fire({
                title: 'Loading Dashboard...',
                text: 'Fetching dashboard data, please wait...',
                icon: 'info',
                allowOutsideClick: false,
                allowEscapeKey: false,
                customClass: {
                    popup: 'rounded-xl'
                },
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            const department = $('#departmentSelector').val();
            google.script.run.withSuccessHandler(function(response) {
                Swal.close();
                console.log('Dashboard Data:', response);
                if (response.success) {
                    // Future: Populate dashboard with data
                    console.log('Dashboard data loaded successfully');
                    updateDashboardUI(response.data);
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: response.message || 'An error occurred while loading dashboard data',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            }).getDashboardData(department);
        }

        function updateDashboardUI(data) {
            // Future: Implement UI updates based on dashboard data
            console.log('Updating dashboard UI with data:', data);
        }
    </script>
</body>

</html>