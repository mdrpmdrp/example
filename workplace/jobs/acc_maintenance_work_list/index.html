<!DOCTYPE html>
<html lang="en">

<head>
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACC maintenance work list</title>

    <!-- Preconnect to improve loading speed -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <!-- jQuery must load synchronously as inline scripts depend on it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'red': {
                            50: '#E6F2ED',
                            100: '#CCE5DB',
                            200: '#99CBB7',
                            300: '#66B193',
                            400: '#33976F',
                            500: '#014E2C',
                            600: '#014E2C',
                            700: '#013F23',
                            800: '#012F1A',
                            900: '#012011',
                            950: '#001008'
                        },
                        'danger': {
                            50: '#FEE2E2',
                            100: '#FECACA',
                            200: '#FCA5A5',
                            300: '#F87171',
                            400: '#EF4444',
                            500: '#DC2626',
                            600: '#B91C1C',
                            700: '#991B1B',
                            800: '#7F1D1D',
                            900: '#6B1C1C'
                        },
                        'gray': {
                            50: '#F9F9F9',
                            100: '#F3F3F3',
                            200: '#E0E0E0',
                            300: '#CCCCCC',
                            400: '#999999',
                            500: '#808080',
                            600: '#4B4B4B',
                            700: '#4B4B4B',
                            800: '#3A3A3A',
                            900: '#2A2A2A'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"
        media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .section-card {
            transition: all 0.3s ease;
            will-change: box-shadow;
            contain: layout style paint;
        }

        .section-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .spare-parts-container {
            animation: slideDown 0.3s ease;
            contain: layout style;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden-section {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
    </style>
</head>

<body class="bg-gray-50">

    <!-- Main Container -->
    <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-4 md:py-8 px-4 sm:px-6 lg:px-8">
        <div class="max-w-10xl mx-auto">
            <!-- Modern Header & Navigation Area -->
            <div
                class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 mb-6 hide-on-fullscreen lg:sticky lg:top-4 z-50">
                <div class="flex flex-col lg:flex-row items-center justify-between gap-4">
                    <!-- Brand / Title -->
                    <div class="flex items-center gap-4 w-full lg:w-auto">
                        <div
                            class="bg-gradient-to-br from-red-600 to-red-700 text-white p-3 rounded-xl shadow-lg shadow-red-200">
                            <i class="fas fa-tools text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900 tracking-tight">ACC Maintenance work list</h1>
                            <p class="text-sm text-gray-500 font-medium">Create and manage maintenance jobs</p>
                        </div>
                    </div>

                    <!-- Navigation Tabs -->
                    <div class="flex p-2 bg-gray-100 rounded-xl flex-col md:flex-row justify-between w-auto">
                        <button type="button" id="createUpdateTab"
                            class="tab-nav-btn flex-1 lg:flex-none px-6 py-2.5 rounded-lg text-sm font-bold transition-all duration-200 flex items-center justify-center gap-2 whitespace-nowrap bg-gradient-to-r from-danger-500 to-danger-600 text-white shadow-md"
                            data-tab="create-update">
                            <i class="fas fa-plus-circle"></i>Create / Update
                        </button>
                        <div class="flex">
                            <button type="button"
                                class="tab-nav-btn flex-1 lg:flex-none px-6 py-2.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-900 transition-all duration-200 flex items-center justify-center gap-2 whitespace-nowrap"
                                data-tab="dashboard-me1">
                                <i class="fas fa-chart-line"></i>ME-1
                            </button>
                            <button type="button"
                                class="tab-nav-btn flex-1 lg:flex-none px-6 py-2.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-900 transition-all duration-200 flex items-center justify-center gap-2 whitespace-nowrap"
                                data-tab="dashboard-me2">
                                <i class="fas fa-chart-line"></i>ME-2
                            </button>
                            <button type="button"
                                class="tab-nav-btn flex-1 lg:flex-none px-6 py-2.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-900 transition-all duration-200 flex items-center justify-center gap-2 whitespace-nowrap"
                                data-tab="dashboard-me3">
                                <i class="fas fa-chart-line"></i>ME-3
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create/Update Tab Content -->
            <div id="createUpdateTabContent" class="tab-content-section">
                <!-- Form Container -->
                <form id="workOrderForm" class="space-y-6">
                    <input type="hidden" id="recordId" value="">
                    <!-- 1. SUPERVISOR DETAILS SECTION -->
                    <div
                        class="section-card bg-white rounded-xl shadow-sm border border-gray-200 p-5 md:p-8 transition-all hover:shadow-md">
                        <div class="flex items-center gap-4 mb-8 pb-4 border-b border-gray-100">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg shadow-red-100">
                                <i class="fas fa-user-tie text-xl text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">Supervisor Details</h2>
                                <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Plan & Schedule
                                    Information</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- User ID -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-id-card text-red-500 w-5"></i>User ID
                                </label>
                                <input type="text" id="supervisorUserId" placeholder="Enter ID"
                                    class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200"
                                    required>
                            </div>

                            <!-- Name -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-user text-red-500 w-5"></i>Name
                                </label>
                                <input type="text" id="supervisorName" placeholder="Supervisor name"
                                    class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200"
                                    required>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                            <!-- Plan Date -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-calendar-alt text-red-500 w-5"></i>Plan Date
                                </label>
                                <input type="text" id="supervisorPlanDate" placeholder="Select date"
                                    class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200 cursor-pointer"
                                    readonly required>
                            </div>

                            <!-- Start Time -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-play-circle text-green-500 w-5"></i>Start Time
                                </label>
                                <input type="time" id="supervisorStartTime"
                                    class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200"
                                    required>
                            </div>

                            <!-- Finish Time -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-stop-circle text-red-500 w-5"></i>Finish Time
                                </label>
                                <input type="time" id="supervisorFinishTime"
                                    class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200"
                                    required>
                            </div>
                        </div>

                        <!-- Status Field (shown only on update) -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 hidden border-t border-gray-100 pt-6"
                            id="statusFieldContainer">
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-flag text-yellow-500 w-5"></i>Current Status
                                </label>
                                <select id="recordStatus"
                                    class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200 bg-white">
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 2. WORK ORDER DETAILS SECTION -->
                    <div
                        class="section-card bg-white rounded-xl shadow-sm border border-gray-200 p-5 md:p-8 transition-all hover:shadow-md">
                        <div class="flex items-center gap-4 mb-8 pb-4 border-b border-gray-100">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-gray-700 to-gray-800 rounded-xl flex items-center justify-center shadow-lg shadow-gray-100">
                                <i class="fas fa-clipboard-list text-xl text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">Work Order Details</h2>
                                <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Asset &
                                    Maintenance Scope</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6">
                            <!-- Work Order ID -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-hashtag text-gray-400 w-5"></i>Work Order ID
                                </label>
                                <input type="text" id="workOrderID" placeholder="Enter WO#"
                                    class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-gray-500 focus:ring-4 focus:ring-gray-500/10 outline-none transition-all duration-200 uppercase font-mono tracking-wider">
                            </div>

                            <!-- Date (Auto) -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-calendar text-gray-400 w-5"></i>Generation Date
                                </label>
                                <input type="text" id="workOrderDate"
                                    class="w-full px-4 py-2.5 bg-gray-100 border border-gray-200 rounded-xl text-gray-500 cursor-not-allowed outline-none font-medium"
                                    readonly>
                            </div>
                        </div>

                        <!-- Details Textarea -->
                        <div id="workOrderDetailsContainer" class="mt-4 pt-6 border-t border-gray-50 hidden">
                            <label class="flex items-center text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-pen-nib text-gray-400 w-5"></i>Task Description
                            </label>
                            <textarea id="workOrderDetailsText" placeholder="Describe the maintenance task in detail..."
                                rows="4"
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200 resize-none"></textarea>
                        </div>

                        <!-- Spare Parts Section -->
                        <div id="sparePartDetailsContainer" class="mt-4">
                            <div class="flex items-center justify-between mb-4">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-box-open text-gray-400 w-5"></i>Spare Parts Inventory
                                </label>
                            </div>

                            <div id="partsListContainer" class="space-y-3">
                                <!-- Part Item Template -->
                                <div class="material-item bg-gray-50 p-4 md:p-6 rounded-2xl border border-gray-100 hover:border-gray-300 transition-all group"
                                    data-part-index="0">
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                        <!-- Part ID -->
                                        <div class="md:col-span-4 space-y-1.5">
                                            <span
                                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Material
                                                ID</span>
                                            <input type="text"
                                                class="material-id w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition"
                                                placeholder="Enter ID" required>
                                        </div>

                                        <!-- Size -->
                                        <div class="md:col-span-2 space-y-1.5">
                                            <span
                                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Size</span>
                                            <input type="text"
                                                class="material-size w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition"
                                                placeholder="eg. 100mm, etc.">
                                        </div>

                                        <!-- Unit -->
                                        <div class="md:col-span-2 space-y-1.5">
                                            <span
                                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Unit</span>
                                            <input type="text"
                                                class="material-unit w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition"
                                                placeholder="eg. pcs, etc.">
                                        </div>

                                        <!-- Qty -->
                                        <div class="md:col-span-2 space-y-1.5">
                                            <span
                                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Qty</span>
                                            <input type="number"
                                                class="material-quantity w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition"
                                                placeholder="0" min="0">
                                        </div>

                                        <!-- Action -->
                                        <div class="md:col-span-2">
                                            <button type="button"
                                                class="delete-material-btn w-full bg-white hover:bg-red-50 text-danger-400 hover:text-danger-600 border border-gray-200 hover:border-red-200 py-2 rounded-lg transition-all duration-200 flex items-center justify-center h-10">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="button" id="addMorePartsBtn"
                                class="mt-4 w-full py-3 border-2 border-dashed border-gray-200 rounded-2xl text-gray-400 font-bold hover:border-gray-400 hover:text-gray-600 hover:bg-gray-50 transition-all flex items-center justify-center gap-2 group">
                                <div
                                    class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-white transition-colors">
                                    <i class="fas fa-plus text-xs"></i>
                                </div>
                                Add Spare Part
                            </button>
                        </div>
                    </div>

                    <!-- 3. CONTRACTOR INFORMATION SECTION -->
                    <div
                        class="section-card bg-white rounded-xl shadow-sm border border-gray-200 p-5 md:p-8 transition-all hover:shadow-md">
                        <div class="flex items-center gap-4 mb-8 pb-4 border-b border-gray-100">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-green-600 to-green-700 rounded-xl flex items-center justify-center shadow-lg shadow-green-100">
                                <i class="fas fa-hammer text-xl text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">Contractor Execution</h2>
                                <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Labor & Manpower
                                    Assignment</p>
                            </div>
                        </div>

                        <div id="contractorListContainer" class="space-y-4">
                            <!-- Contractor Item Template -->
                            <div class="contractor-item bg-gray-50 p-5 md:p-6 rounded-2xl border border-gray-100 hover:border-green-200 transition-all group"
                                data-contractor-index="0">
                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end pb-4 border-b border-gray-200/50">
                                    <!-- Contractor Type -->
                                    <div class="space-y-1.5">
                                        <label class="flex items-center text-sm font-bold text-gray-700">
                                            <i class="fas fa-layer-group text-green-500 w-5"></i>Contractor Type
                                        </label>
                                        <select
                                            class="contractor-type w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-500/10 outline-none transition-all duration-200">
                                            <option value="">-- Select Type --</option>
                                            <option value="internal">Internal Team</option>
                                            <option value="external">External Vendor</option>
                                        </select>
                                    </div>
                                    <!-- Contractor Selection -->
                                    <div class="space-y-1.5">
                                        <label class="flex items-center text-sm font-bold text-gray-700">
                                            <i class="fas fa-briefcase text-green-500 w-5"></i>Contractor Name
                                        </label>
                                        <select
                                            class="contractor-select w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-500/10 outline-none transition-all duration-200">
                                            <option value="">-- Select Contractor --</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mt-6 items-end">
                                    <!-- Custom Name (Hidden until 'other') -->
                                    <div
                                        class="contractor-custom-name-div hidden md:col-span-12 space-y-1.5 bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-2">
                                        <label
                                            class="flex items-center text-xs font-bold text-yellow-700 uppercase tracking-wider">
                                            <i class="fas fa-pen text-yellow-500 mr-2"></i>Specify Other Contractor
                                        </label>
                                        <input type="text"
                                            class="contractor-custom-name w-full px-4 py-2 bg-white border border-yellow-200 rounded-lg focus:ring-2 focus:ring-yellow-200 outline-none transition"
                                            placeholder="Enter vendor name">
                                    </div>

                                    <!-- Manpower -->
                                    <div class="md:col-span-3 space-y-1.5">
                                        <label
                                            class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Manpower</label>
                                        <div class="relative">
                                            <input type="number"
                                                class="contractor-quantity w-full px-3 py-2 pl-8 bg-white border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition"
                                                placeholder="0" min="1">
                                            <i class="fas fa-users text-gray-300 absolute left-3 top-3 text-xs"></i>
                                        </div>
                                    </div>

                                    <!-- Execution Date -->
                                    <div class="md:col-span-4 space-y-1.5">
                                        <label
                                            class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Execution
                                            Date</label>
                                        <input type="text"
                                            class="contractor-plan-date w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition cursor-pointer"
                                            placeholder="Pick Date" readonly>
                                    </div>

                                    <!-- Start Time -->
                                    <div class="md:col-span-2 space-y-1.5">
                                        <label
                                            class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Start</label>
                                        <input type="time"
                                            class="contractor-start-time w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition">
                                    </div>

                                    <!-- Finish Time -->
                                    <div class="md:col-span-2 space-y-1.5">
                                        <label
                                            class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">End</label>
                                        <input type="time"
                                            class="contractor-finish-time w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition">
                                    </div>

                                    <!-- Delete -->
                                    <div class="md:col-span-1">
                                        <button type="button"
                                            class="delete-contractor-btn w-full h-10 bg-white hover:bg-red-50 text-danger-400 hover:text-danger-500 border border-gray-200 hover:border-red-200 rounded-lg transition-all flex items-center justify-center">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" id="addMoreContractorBtn"
                            class="mt-6 w-full py-4 border-2 border-dashed border-gray-200 rounded-2xl text-gray-400 font-bold hover:border-green-400 hover:text-green-600 hover:bg-green-50 transition-all flex items-center justify-center gap-3 group">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-white transition-colors">
                                <i class="fas fa-plus"></i>
                            </div>
                            Assign Another Contractor
                        </button>
                    </div>

                    <!-- Form Action Buttons -->
                    <div class="flex flex-col md:flex-row gap-4 justify-end pt-10">
                        <button type="reset"
                            class="group flex items-center justify-center gap-2 px-8 py-3.5 bg-white border border-gray-200 text-gray-500 font-bold rounded-2xl hover:bg-gray-50 hover:text-gray-700 hover:border-gray-300 transition-all duration-200 shadow-sm">
                            <i
                                class="fas fa-redo-alt text-xs group-hover:rotate-180 transition-transform duration-500"></i>
                            Reset Form
                        </button>
                        <button type="submit"
                            class="flex items-center justify-center gap-2 px-10 py-3.5 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold rounded-2xl hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg shadow-red-200 group">
                            <i class="fas fa-save"></i>
                            Save Work Order
                            <i
                                class="fas fa-arrow-right text-xs opacity-50 group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Dashboard Tab Content -->
            <div id="dashboardTabContent-ME1" class="tab-content-section h-dvh hidden">
                <div class="space-y-6">
                    <!-- Top Stats & Capacity Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 md:gap-6">
                        <!-- Stats Column -->
                        <div class="space-y-6">
                            <!-- Department Info Card -->
                            <div
                                class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl shadow-lg p-5 text-white relative overflow-hidden h-full flex flex-col justify-between">
                                <div class="absolute top-0 right-0 -mt-2 -mr-2 opacity-10">
                                    <i class="fas fa-building text-8xl"></i>
                                </div>
                                <div class="flex justify-between items-center">
                                    <h3 class="text-sm font-medium opacity-90">Department</h3>
                                    <div
                                        class="flex items-center gap-2 text-white/90 text-base font-medium bg-black/10 px-2 py-1.5 rounded-lg backdrop-blur-md border border-white/10">
                                        <i class="far fa-calendar-alt"></i>
                                        <span class="currentDate"></span>
                                    </div>

                                </div>
                                <div class="mt-2 mb-4">
                                    <h2
                                        class="text-3xl md:text-4xl lg:text-6xl font-bold department-name tracking-tight">
                                        --</h2>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div
                                        class="inline-flex items-center px-2.5 py-1 bg-white/20 rounded-full text-xs backdrop-blur-sm">
                                        <i class="fas fa-circle text-[10px] text-green-300 mr-1.5"></i> Active
                                    </div>
                                    <div class="flex gap-3 items-center">

                                        <button onclick="loadDashboardData()"
                                            class="text-gray-300 hover:text-green-100 transition p-1 hover:bg-white/10 rounded-full ratio-1x1"
                                            title="Reload Data">
                                            <i class="fas fa-sync-alt text-lg reload-icon"></i>
                                        </button>
                                        <button id="fullscreenToggleBtn" onclick="toggleFullscreen()"
                                            class="transition hover:transform-scale-105 text-gray-300 hover:bg-white/50 rounded-full"
                                            title="Toggle Fullscreen">
                                            <i class="fas fa-expand text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">

                            <!-- Total Jobs Card -->
                            <div
                                class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 flex items-center justify-between h-[100px]">
                                <div>
                                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Work Orders
                                    </p>
                                    <h3 class="text-3xl font-bold text-gray-800 stat-total-wo">0</h3>
                                </div>
                                <div
                                    class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                                    <i class="fas fa-clipboard-list text-xl"></i>
                                </div>
                            </div>

                            <!-- Total Manpower Card -->
                            <div
                                class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 flex items-center justify-between h-[100px]">
                                <div>
                                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Total
                                        Manpower</p>
                                    <h3 class="text-3xl font-bold text-gray-800 stat-total-manpower">0</h3>
                                </div>
                                <div
                                    class="w-12 h-12 rounded-full bg-orange-50 flex items-center justify-center text-orange-600">
                                    <i class="fas fa-hard-hat text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Contractor Capacity Card -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 md:p-6 lg:col-span-2">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-users-cog text-gray-400 mr-2"></i>Contractor Capacity
                            </h3>
                            <div>
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-gray-500 uppercase bg-gray-50/50">
                                        <tr>
                                            <th class="px-4 py-3 font-medium rounded-l-lg">Contractor</th>
                                            <th class="px-4 py-3 font-medium text-center">Used</th>
                                            <th class="px-4 py-3 font-medium text-center">Capacity</th>
                                        </tr>
                                    </thead>
                                    <tbody class="contractor-capacity-table-body divide-y divide-gray-100">
                                        <!-- Will be populated by updateDashboard function -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Grid -->
                    <div class="grid grid-cols-1 xl:grid-cols-4 gap-4 md:gap-6">
                        <!-- Sidebar: Functional Locations -->
                        <div class="xl:col-span-1 space-y-4">
                            <div class="section-cards-container grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-1 gap-4">
                                <!-- Will be populated by updateDashboard function -->
                            </div>
                        </div>

                        <!-- Main: Work Orders Table -->
                        <div class="xl:col-span-3 mb-8">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full">
                                <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                                    <h3 class="font-bold text-gray-800 flex items-center">
                                        <i class="fas fa-list-alt text-red-500 mr-2"></i> Work Orders
                                    </h3>
                                </div>
                                <div class="overflow-x-auto flex-grow">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3">Supervisor</th>
                                                <th scope="col" class="px-6 py-3">Work Order</th>
                                                <th scope="col" class="px-6 py-3">Description</th>
                                                <th scope="col" class="px-6 py-3">Contractor</th>
                                                <th scope="col" class="px-6 py-3 text-center">Quantity</th>
                                                <th scope="col" class="px-6 py-3 text-center">Working time</th>
                                                <th scope="col" class="px-6 py-3 text-center">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="work-orders-table-body divide-y divide-gray-100">
                                            <!-- Will be populated by updateDashboard function -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts at end for better performance -->
    <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <!-- <script defer src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script> -->
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/rangePlugin.js"></script>
    <script defer src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script defer
        src="https://cdn.jsdelivr.net/gh/tanaikech/ResumableUploadForGoogleDrive_js@master/resumableupload_js.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <script>
        var contractorList = <?!= JSON.stringify(contractorList) ?>;
        var supervisorList = <?!= JSON.stringify(supervisorList) ?>;
        var preDefinedWorkOrders = <?!= JSON.stringify(preDefinedWorkOrders) ?>;
        var isLoadingDashboard = false, reloadInterval = 60000; // default 1 minute
        setInterval(() => {
            const activeTab = $('.tab-content-section:not(.hidden)').attr('id');
            const currentHour = new Date().getHours();
            let reloadInterval;

            if (currentHour >= 7 && currentHour < 9) {
                reloadInterval = 60000; // 1 minute
            } else if (currentHour >= 9 && currentHour < 18) {
                reloadInterval = 600000; // 10 minutes
            } else {
                reloadInterval = 3600000; // 1 hour
            }
            console.log(`Auto-reload interval set to ${reloadInterval / 1000 / 60} minutes.`);

            // Only reload if a dashboard tab is active (not the create-update form)
            if (activeTab && activeTab !== 'createUpdateTabContent') {
                loadDashboardData();
            }
        }, reloadInterval);

        // Cache frequently used DOM elements
        const DOMCache = {
            init: function () {
                this.$body = $('body');
                this.$currentDate = $('.currentDate');
                this.$workOrderDate = $('#workOrderDate');
                this.$supervisorPlanDate = $('#supervisorPlanDate');
                this.$supervisorUserId = $('#supervisorUserId');
                this.$supervisorName = $('#supervisorName');
                this.$supervisorStartTime = $('#supervisorStartTime');
                this.$supervisorFinishTime = $('#supervisorFinishTime');
                this.$workOrderID = $('#workOrderID');
                this.$workOrderDetailsContainer = $('#workOrderDetailsContainer');
                this.$workOrderDetailsText = $('#workOrderDetailsText');
                this.$sparePartDetailsContainer = $('#sparePartDetailsContainer');
                this.$contractorListContainer = $('#contractorListContainer');
                this.$partsListContainer = $('#partsListContainer');
                this.$workOrderForm = $('#workOrderForm');
                this.$reloadIcon = $('.reload-icon');
                this.$createUpdateTab = $('#createUpdateTab');
            }
        };

        // Fullscreen toggle function
        function toggleFullscreen() {
            $('.hide-on-fullscreen').toggleClass('hidden');
        }

        // Listen for fullscreen changes (for ESC key or F11)
        document.addEventListener('fullscreenchange', function () {
            const fullscreenBtn = document.getElementById('fullscreenToggleBtn');
            if (fullscreenBtn) {
                const icon = fullscreenBtn.querySelector('i');
                if (!document.fullscreenElement) {
                    icon.classList.remove('fa-compress');
                    icon.classList.add('fa-expand');
                    icon.title = 'Toggle Fullscreen';
                }
            }
        });

        $(document).ready(function () {
            // Initialize DOM cache
            DOMCache.init();

            // Initialize current date in dashboard header
            const todayStr = moment().format('DD MMM YYYY');
            DOMCache.$currentDate.text(todayStr);

            // get dashboard data
            loadDashboardData();
            // Initialize date fields to today
            const today = new Date().toLocaleDateString('en-CA');
            DOMCache.$workOrderDate.val(moment().format('DD/MM/YYYY')).data('alt-date', today);

            // Initialize flatpickr for date selectors (Thai locale)
            flatpickr('#supervisorPlanDate', {
                locale: 'th',
                dateFormat: 'Y-m-d',
                altFormat: 'd/m/Y',
                altInput: true,
                defaultDate: today
            });

            // Initialize first contractor date picker
            flatpickr('.contractor-plan-date', {
                locale: 'th',
                dateFormat: 'Y-m-d',
                altFormat: 'd/m/Y',
                altInput: true,
                defaultDate: today
            });
            flatpickr('.contractor-start-time', {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true,
                time_24hr: true,
                defaultDate: "08:00"
            });

            flatpickr('.contractor-finish-time', {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true,
                time_24hr: true,
                defaultDate: "17:00"
            });

            flatpickr('#supervisorStartTime', {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true,
                time_24hr: true,
                defaultDate: "08:00"
            });
            flatpickr('#supervisorFinishTime', {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true,
                time_24hr: true,
                defaultDate: "17:00"
            });

            // Handle Work Order Checkbox - Toggle between work order details and spare parts (optimized)
            $('#workOrderID').on('keyup', _.debounce(function () {
                const workOrderId = $(this).val().trim();
                const $detailsContainer = $('#workOrderDetailsContainer');
                const $detailsText = $('#workOrderDetailsText');
                const $spareContainer = $('#sparePartDetailsContainer');
                const $materialItems = $('.material-item');

                if (workOrderId !== '') {
                    // Batch DOM updates for better performance
                    requestAnimationFrame(() => {
                        $detailsContainer.removeClass('hidden').find('textarea').attr('required', true);
                        $detailsText.val('');
                        $spareContainer.addClass('hidden');
                        $materialItems.not(':first').remove();
                        $materialItems.find('input').val('').attr('required', false);

                        let wo = preDefinedWorkOrders.find(pre_wo => pre_wo.workOrderID == workOrderId);
                        if (wo) {
                            $detailsText.val(wo.description);
                        }
                    });
                } else {
                    // Batch DOM updates
                    requestAnimationFrame(() => {
                        $detailsContainer.addClass('hidden').find('textarea').attr('required', false);
                        $spareContainer.removeClass('hidden');
                        $materialItems.find('input').val('').attr('required', true);
                    });
                }
            }, 300));


            // Handle Contractor Tab Switching
            $('.tab-button').click(function (e) {
                e.preventDefault();
                const tab = $(this).data('tab');

                // Update active tab styling
                $('.tab-button').removeClass('border-purple-500').addClass('border-transparent');
                $(this).removeClass('border-transparent').addClass('border-purple-500');

                // Show/hide tab content
                if (tab === 'internal') {
                    $('#internalContractorSection').removeClass('hidden');
                    $('#externalContractorSection').addClass('hidden');
                } else {
                    $('#internalContractorSection').addClass('hidden');
                    $('#externalContractorSection').removeClass('hidden');
                }
            });

            // Update contractor options when type changes (optimized with caching)
            $(document).on('change', '.contractor-type', function () {
                const type = $(this).val();
                const $contractorItem = $(this).closest('.contractor-item');
                const $contractorSelect = $contractorItem.find('.contractor-select');
                const $customNameDiv = $contractorItem.find('.contractor-custom-name-div');
                const supervisorUserId = $('#supervisorUserId').val().trim();
                const supervisor = supervisorList.find(s => String(s.userId) == supervisorUserId);
                console.log('Selected Contractor Type:', type);
                console.log('Supervisor Info:', supervisor);
                // Build options HTML efficiently
                let optionsHTML = '<option value="">-- Select Contractor --</option>';

                if (type && supervisor) {
                    const uniqueContractors = new Set();
                    const options = contractorList
                        .filter(c => {
                            return c.type === type && (c.me === supervisor.me || c.me === 'All')
                        })
                        .reduce((acc, c) => {
                            if (!uniqueContractors.has(c.contractor)) {
                                uniqueContractors.add(c.contractor);
                                acc.push(`<option value="${c.contractor}">${c.contractor}</option>`);
                            }
                            return acc;
                        }, []);

                    optionsHTML += options.join('');
                    $contractorItem.find('input,select').attr('required', true);
                } else {
                    $contractorItem.find('input,select').attr('required', false);
                }

                // Single DOM update
                $contractorSelect.html(optionsHTML);
                $customNameDiv.addClass('hidden');
            });

            // Handle external contractor custom name visibility (use event delegation)
            $(document).on('change', '.contractor-select', function () {
                const $contractorItem = $(this).closest('.contractor-item');
                const type = $contractorItem.find('.contractor-type').val();
                const value = $(this).val();
                const $customNameDiv = $contractorItem.find('.contractor-custom-name-div');

                if (type === 'external' && value === ' ()') {
                    $customNameDiv.removeClass('hidden').find('input').val('').prop('required', true);
                } else {
                    $customNameDiv.addClass('hidden').find('input').val('').prop('required', false);
                }
            });

            $(document).on('keyup', '#supervisorUserId', _.debounce(function () {
                const userId = $(this).val().trim();
                const $supervisorName = $('#supervisorName');
                const supervisor = supervisorList.find(s => s.userId == userId);

                if (supervisor) {
                    $supervisorName.val(supervisor.name).prop('readonly', true);
                } else {
                    $supervisorName.val('').prop('readonly', false);
                }
            }, 300));


            // Add More Contractors
            let contractorIndex = 1;
            $('#addMoreContractorBtn').click(function (e) {
                e.preventDefault();
                const newContractorHTML = `
                    <div class="contractor-item bg-gray-50 p-5 md:p-6 rounded-2xl border border-gray-100 hover:border-green-200 transition-all group" data-contractor-index="${contractorIndex}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end pb-4 border-b border-gray-200/50">
                            <!-- Contractor Type -->
                            <div class="space-y-1.5">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-layer-group text-green-500 w-5"></i>Contractor Type
                                </label>
                                <select class="contractor-type w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-500/10 outline-none transition-all duration-200" required>
                                    <option value="">-- Select Type --</option>
                                    <option value="internal">Internal Team</option>
                                    <option value="external">External Vendor</option>
                                </select>
                            </div>
                            <!-- Contractor Selection -->
                            <div class="space-y-1.5">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-briefcase text-green-500 w-5"></i>Contractor Name
                                </label>
                                <select class="contractor-select w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 outline-none transition-all duration-200">
                                    <option value="">-- Select Contractor --</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mt-6 items-end">
                            <!-- Custom Name (Hidden until 'other') -->
                            <div class="contractor-custom-name-div hidden md:col-span-12 space-y-1.5 bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-2">
                                <label class="flex items-center text-xs font-bold text-yellow-700 uppercase tracking-wider">
                                    <i class="fas fa-pen text-yellow-500 mr-2"></i>Specify Other Contractor
                                </label>
                                <input type="text" class="contractor-custom-name w-full px-4 py-2 bg-white border border-yellow-200 rounded-lg focus:ring-2 focus:ring-yellow-200 outline-none transition" placeholder="Enter vendor name">
                            </div>

                            <!-- Manpower -->
                            <div class="md:col-span-3 space-y-1.5">
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Manpower</label>
                                <div class="relative">
                                    <input type="number" class="contractor-quantity w-full px-3 py-2 pl-8 bg-white border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition" placeholder="0" min="1">
                                    <i class="fas fa-users text-gray-300 absolute left-3 top-3 text-xs"></i>
                                </div>
                            </div>

                            <!-- Execution Date -->
                            <div class="md:col-span-4 space-y-1.5">
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Execution Date</label>
                                <input type="text" class="contractor-plan-date w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition cursor-pointer" placeholder="Pick Date" readonly>
                            </div>

                            <!-- Start Time -->
                            <div class="md:col-span-2 space-y-1.5">
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Start</label>
                                <input type="time" class="contractor-start-time w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition">
                            </div>

                            <!-- Finish Time -->
                            <div class="md:col-span-2 space-y-1.5">
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">End</label>
                                <input type="time" class="contractor-finish-time w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none transition">
                            </div>

                            <!-- Delete -->
                            <div class="md:col-span-1">
                                <button type="button" class="delete-contractor-btn w-full h-10 bg-white hover:bg-danger-50 text-danger-400 hover:text-danger-500 border border-gray-200 hover:border-danger-200 rounded-lg transition-all flex items-center justify-center">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                $('#contractorListContainer').append(newContractorHTML);

                // Initialize flatpickr for new date field
                const newDateInput = $(`[data-contractor-index="${contractorIndex}"] .contractor-plan-date`);
                flatpickr(newDateInput[0], {
                    locale: 'th',
                    dateFormat: 'Y-m-d',
                    altFormat: 'd/m/Y',
                    altInput: true,
                    defaultDate: today
                });
                flatpickr($(`[data-contractor-index="${contractorIndex}"] .contractor-start-time`)[0], {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "H:i",
                    allowInput: true,
                    time_24hr: true,
                    defaultDate: "08:00"
                });
                flatpickr($(`[data-contractor-index="${contractorIndex}"] .contractor-finish-time`)[0], {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "H:i",
                    allowInput: true,
                    time_24hr: true,
                    defaultDate: "17:00"
                });

                contractorIndex++;
            });

            // Delete Contractor
            $(document).on('click', '.delete-contractor-btn', function (e) {
                e.preventDefault();
                $(this).closest('.contractor-item').fadeOut(300, function () {
                    $(this).remove();
                });
            });

            // Add More Spare Parts
            let partIndex = 1;
            $('#addMorePartsBtn').click(function (e) {
                e.preventDefault();
                const newPartHTML = `
                    <div class="material-item bg-gray-50 p-4 md:p-6 rounded-2xl border border-gray-100 hover:border-gray-300 transition-all group animate-in slide-in-from-top-2 duration-300" data-part-index="${partIndex}">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                            <!-- Part ID -->
                            <div class="md:col-span-4 space-y-1.5">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Material ID</span>
                                <input type="text" class="material-id w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition" placeholder="Enter ID">
                            </div>

                            <!-- Size -->
                            <div class="md:col-span-2 space-y-1.5">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Size</span>
                                <input type="text" class="material-size w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition" placeholder="eg. 100mm, etc.">
                            </div>

                            <!-- Unit -->
                            <div class="md:col-span-2 space-y-1.5">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Unit</span>
                                <input type="text" class="material-unit w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition" placeholder="eg. pcs, etc.">
                            </div>

                            <!-- Qty -->
                            <div class="md:col-span-2 space-y-1.5">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Qty</span>
                                <input type="number" class="material-quantity w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition" placeholder="0" min="0">
                            </div>

                            <!-- Action -->
                            <div class="md:col-span-2">
                                <button type="button" class="delete-material-btn w-full bg-white hover:bg-red-50 text-danger-400 hover:text-danger-600 border border-gray-200 hover:border-red-200 py-2 rounded-lg transition-all duration-200 flex items-center justify-center h-10">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                $('#partsListContainer').append(newPartHTML);
                partIndex++;
            });

            // Delete Spare Part
            $(document).on('click', '.delete-material-btn', function (e) {
                e.preventDefault();
                $(this).closest('.material-item').fadeOut(300, function () {
                    $(this).remove();
                });
            });

            // Form Submission
            $('#workOrderForm').submit(function (e) {
                e.preventDefault();
                Swal.fire({
                    title: `Confirm ${$('#recordId').val() ? 'Update' : 'Submit'}`,
                    text: 'Are you sure you want to ' + ($('#recordId').val() ? 'update' : 'submit') + ' this work order?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: `Yes, ${$('#recordId').val() ? 'Update' : 'Submit'}`,
                    cancelButtonText: 'Cancel',
                    customClass: {
                        popup: 'rounded-xl',
                        confirmButton: 'bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg',
                        cancelButton: 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded-lg'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        submitWorkOrderForm();
                    }
                });
            });
            function submitWorkOrderForm() {
                // Show loading spinner
                Swal.fire({
                    title: 'Processing...',
                    text: 'Saving work order...',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: 'rounded-xl',
                        confirmButton: 'bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg',
                        cancelButton: 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded-lg'
                    }
                });

                // Collect contractors data
                const contractors = [];
                $('.contractor-item').each(function () {
                    const type = $(this).find('.contractor-type').val();
                    if (!type) return; // Skip if type not selected
                    let contractor = $(this).find('.contractor-select').val();


                    contractors.push({
                        type: type,
                        contractor: contractor,
                        customName: $(this).find('.contractor-custom-name').val() || '',
                        quantity: $(this).find('.contractor-quantity').val(),
                        planDate: $(this).find('.contractor-plan-date').val(),
                        startTime: $(this).find('.contractor-start-time').val(),
                        finishTime: $(this).find('.contractor-finish-time').val()
                    });
                });

                // Collect form data
                const formData = {
                    recordId: $('#recordId').val(),
                    status: $('#recordStatus').val(),
                    supervisor: {
                        userId: $('#supervisorUserId').val(),
                        name: $('#supervisorName').val(),
                        planDate: $('#supervisorPlanDate').val(),
                        startTime: $('#supervisorStartTime').val(),
                        finishTime: $('#supervisorFinishTime').val()
                    },
                    workOrder: {
                        date: $('#workOrderDate').val(),
                        workOrderID: $('#workOrderID').val(),
                        details: $('#workOrderDetailsText').val()
                    },
                    contractors: contractors,
                    spareParts: []
                };

                // Collect spare parts
                $('.material-item').each(function () {
                    const part = {
                        id: $(this).find('.material-id').val(),
                        size: $(this).find('.material-size').val(),
                        unit: $(this).find('.material-unit').val(),
                        quantity: $(this).find('.material-quantity').val()
                    };
                    formData.spareParts.push(part);
                });


                if (formData.recordId) {
                    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).updateWorkOrder(formData);
                } else {
                    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).submitWorkOrder(formData);
                }
                // Call backend function
            }

            $('#workOrderForm').on('reset', function (e) {
                $('#supervisorName').prop('readonly', false);
                // Hide status field on reset (create mode)
                $('#statusFieldContainer').addClass('hidden');
                $('#recordStatus').val('');
                $('#recordId').val('');
                setTimeout(() => {
                    DOMCache.$supervisorPlanDate[0]._flatpickr.setDate(moment().format('YYYY-MM-DD'));
                    $('#supervisorStartTime')[0]._flatpickr.setDate("08:00");
                    $('#supervisorFinishTime')[0]._flatpickr.setDate("17:00");
                    $('#contractorListContainer').find('.contractor-plan-date')[0]._flatpickr.setDate(moment().format('YYYY-MM-DD'));
                    $('#contractorListContainer').find('.contractor-start-time')[0]._flatpickr.setDate("08:00");
                    $('#contractorListContainer').find('.contractor-finish-time')[0]._flatpickr.setDate("17:00");
                    $('#contractorListContainer').find('.contractor-item').not(':first').remove();
                    DOMCache.$workOrderDate.val(moment().format('DD/MM/YYYY'));
                    DOMCache.$workOrderDetailsContainer.addClass('hidden').find('textarea').attr('required', false);
                    DOMCache.$sparePartDetailsContainer.removeClass('hidden').find('textarea').attr('required', true);
                    // scroll to top
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 300);
                }, 200);
            });

            /**
             * Success handler for form submission
             */
            function onSuccess(response) {
                response = JSON.parse(response);

                isLoadingDashboard = false;
                loadDashboardData();
                if (response.success) {
                    Swal.fire({
                        title: 'Success!',
                        html: `Work Order has been saved successfully!<br><small>${moment().format('YYYY-MM-DD HH:mm:ss')}</small>`,
                        icon: 'success',
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'rounded-xl',
                            confirmButton: 'bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg'
                        }
                    }).then(() => {
                        // Reset form
                        $('#workOrderForm')[0].reset();

                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: response.message || 'An error occurred while saving the work order',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'rounded-xl',
                            confirmButton: 'bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg'
                        }
                    });
                }
            }

            /**
             * Error handler for form submission
             */
            function onFailure(error) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to save work order: ' + error.toString(),
                    icon: 'error',
                    confirmButtonText: 'OK',
                    customClass: {
                        popup: 'rounded-xl',
                        confirmButton: 'bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg'
                    }
                });
            }

            /**
             * Load work orders from backend
             */
            function loadWorkOrders() {
                google.script.run.withSuccessHandler(function (response) {

                    if (response.success) {

                    }
                }).getWorkOrders(100);
            }

            /**
             * Get work order details by ID
             */
            function loadWorkOrderDetails(workOrderId) {
                google.script.run.withSuccessHandler(function (response) {

                    if (response.success) {
                        populateFormWithData(response.workOrder, response.contractors, response.spareParts);
                    }
                }).getWorkOrderDetails(workOrderId);
            }

            $('#dashboardDepartmentSelector').change(function () {
                updateDashboardUI();
            });

            // Tab Navigation Handler
            $('.tab-nav-btn').click(function (e) {
                e.preventDefault();
                const tabName = $(this).data('tab');

                // Update tab buttons
                $('.tab-nav-btn').removeClass('bg-gradient-to-r from-danger-500 to-danger-600 text-white shadow-md').addClass('text-gray-500 hover:text-gray-900');
                $(this).removeClass('text-gray-500 hover:text-gray-900').addClass('bg-gradient-to-r from-danger-500 to-danger-600 text-white shadow-md');

                // Hide all tab contents
                $('.tab-content-section').addClass('hidden');

                switch (tabName) {
                    case 'create-update':
                        $('#createUpdateTabContent').removeClass('hidden');
                        break;
                    case 'dashboard-me1':
                        $('#dashboardTabContent-ME1').removeClass('hidden');
                        $('#workOrderForm')[0].reset();
                        break;
                    case 'dashboard-me2':
                        $('#dashboardTabContent-ME2').removeClass('hidden');
                        $('#workOrderForm')[0].reset();
                        break;
                    case 'dashboard-me3':
                        $('#dashboardTabContent-ME3').removeClass('hidden');
                        $('#workOrderForm')[0].reset();
                        break;
                    default:
                        console.warn('Unknown tab:', tabName);
                }

                if (tabName.startsWith('dashboard-')) {
                    setTimeout(() => {
                        loadDashboardData();
                    }, 500);
                }
            });

            // Department Selector Change Handler
            $('#departmentSelector').change(function () {
                const selectedDepartment = $(this).val();


                // Here you can add logic to filter dashboard data based on selected department
                // This will be implemented when backend functions are added

                if (selectedDepartment) {

                    // Future: Call backend function to fetch department-specific data
                    // Example: google.script.run.withSuccessHandler(callback).getDashboardData(selectedDepartment);
                } else {

                    // Future: Call backend function to fetch all departments data
                }
            });

            $(document).on('click', '.status-btn', function () {
                const recordId = $(this).data('recordid');
                updateWorkOrder(recordId);
            })
        });

        function loadDashboardData() {
            if (isLoadingDashboard) {
                return;
            }
            isLoadingDashboard = true;

            const $icons = $('.reload-icon');
            $icons.addClass('fa-spin')
            const department = $('#dashboardDepartmentSelector').val();

            google.script.run.withSuccessHandler(function (response) {
                isLoadingDashboard = false;
                Swal.close();
                // Parse response if it's a string
                response = JSON.parse(response);

                window.dashboardData = response.data // Store globally for debugging

                if (response.success) {

                    updateDashboardUI();
                    $icons.removeClass('fa-spin');
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: response.message || 'An error occurred while loading dashboard data',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'rounded-xl',
                            confirmButton: 'bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg'
                        }
                    });
                }
            }).getDashboardData(department);
        }

        function updateDashboardUI(data) {
            data = data || window.dashboardData;

            // Use DocumentFragment for better performance with large DOM operations
            const fragment = document.createDocumentFragment();

            // Cache supervisor lookups for better performance
            const supervisorLookup = new Map(supervisorList.map(s => [String(s.userId), s]));

            data = data.map(item => {
                let sup_id = item.supervisor.userId;
                let supervisor = supervisorLookup.get(String(sup_id));
                let me = supervisor?.me || 'Unknown';
                let mainDuty = supervisor?.mainDuty || 'Unknown';
                let wo_count = data.filter(d => String(d.supervisor.userId) === String(sup_id)).length;
                let hasWorkOrder = wo_count > 0;
                item.supervisor = { ...item.supervisor, me: me, mainDuty: mainDuty, hasWorkOrder: hasWorkOrder, wo_count: wo_count };
                return item;
            });

            const meGrouped = Object.groupBy(data, (item) => item.supervisor.me || 'Unknown');

            [...new Set(supervisorList.map(s => s.me))].forEach(me => {
                if (!meGrouped[me]) {
                    meGrouped[me] = [];
                }
            });

            for (const me in meGrouped) {
                const meData = meGrouped[me];
                const $container = $('#dashboardTabContent-' + me.replace(/-/g, ''));
                $container.find('.department-name').text(me);

                // Calculate & Update Summary Stats
                const totalWorkOrders = meData.length;
                const totalManpower = meData.reduce((sum, item) => {
                    const contractors = item.contractors || [];
                    const itemManpower = contractors.reduce((cSum, c) => cSum + (parseInt(c.quantity) || 0), 0);
                    return sum + itemManpower;
                }, 0);

                $container.find('.stat-total-wo').text(totalWorkOrders);
                $container.find('.stat-total-manpower').text(totalManpower);

                const contractorStats = calculateContractorStats(meData, me);
                populateContractorCapacity($container, contractorStats, me);
                const sectionGroups = Object.groupBy(meData, (item) => item.mainDuty || 'Other');
                populateSectionCards($container, meData, me);
                populateWorkOrdersTable($container, meData);
            }
        }

        function calculateContractorStats(data, me) {
            const stats = { external: { used: 0, capacity: 0 } };

            // Create a lookup map for faster access
            const contractorMap = new Map();
            contractorList
                .filter(c => c.me === me || c.me === 'All')
                .forEach(c => {
                    if (!contractorMap.has(c.contractor)) {
                        contractorMap.set(c.contractor, c);
                    }
                });

            // Process each contractor once
            contractorMap.forEach((contractorInfo, contractorName) => {

                const used = data.reduce((sum, item) => {
                    if (item.contractors?.length) {
                        const entry = item.contractors.find(c => c.contractor === contractorName);

                        return sum + (entry ? parseInt(entry.quantity) || 0 : 0);
                    }
                    return sum;
                }, 0);

                if (contractorInfo.type === 'external') {
                    stats.external.used += used;
                } else {
                    stats[contractorName] = {
                        used,
                        capacity: parseInt(contractorInfo.capacity) || 0
                    };
                }
            });

            return stats;
        }

        function populateContractorCapacity($section, stats, me) {
            const $tbody = $section.find('.contractor-capacity-table-body');
            const contractorOfDepartment = supervisorList
                .filter(s => s.me === me)
                .flatMap(s => s.contractors)
                .filter((value, index, self) => self.indexOf(value) === index); // Unique contractors
            for (const contractorName of contractorOfDepartment) {
                if (!stats[contractorName]) {
                    stats[contractorName] = { used: 0, capacity: '-' };
                }
            }

            // Build all rows at once for better performance
            const internalRows = Object.keys(stats)
                .filter(contractorName => contractorName !== 'external' && contractorName !== '')
                .sort((a, b) => a.localeCompare(b))
                .map(contractorName => {
                    const contractorStats = stats[contractorName];
                    const used = parseInt(contractorStats.used) || 0;
                    const capacity = parseInt(contractorStats.capacity);
                    let utilization = 0;
                    let progressColor = 'bg-green-500';
                    let progressWidth = 0;

                    if (!isNaN(capacity) && capacity > 0) {
                        utilization = Math.round((used / capacity) * 100);
                        progressWidth = Math.min(utilization, 100);
                        if (utilization > 80) progressColor = 'bg-yellow-500';
                        if (utilization > 100) progressColor = 'bg-red-500';
                    }

                    return `<tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 font-medium text-gray-900 border-b border-gray-100">
                            ${contractorName}
                        </td>
                        <td class="px-4 py-3 text-center text-gray-600 font-semibold border-b border-gray-100">
                            ${used}
                        </td>
                        <td class="px-4 py-3 text-center text-gray-500 border-b border-gray-100">
                            ${isNaN(capacity) ? '-' : capacity}
                        </td>
                        <td class="px-4 py-3 text-center border-b border-gray-100">
                           ${!isNaN(capacity) && capacity > 0 ?
                            `<div class="flex items-center gap-2">
                                <div class="w-full bg-gray-200 rounded-full h-2 hidden md:block">
                                    <div class="${progressColor} h-2 rounded-full" style="width: ${progressWidth}%"></div>
                                </div>
                                <span class="text-xs text-gray-500 w-8 text-right">${utilization}%</span>
                              </div>`
                            : '<span class="text-xs text-gray-400">N/A</span>'}
                        </td>
                    </tr>`;
                }).join('');

            // External contractor row
            const externalUsed = stats.external ? (stats.external.used || 0) : 0;
            const externalRow = `<tr class="bg-gray-50/50">
                <td class="px-4 py-3 font-medium text-gray-700 border-b border-gray-100">
                    <span class="flex items-center"><i class="fas fa-external-link-alt text-xs mr-2 text-gray-400"></i> External</span>
                </td>
                <td class="px-4 py-3 text-center text-gray-700 font-bold border-b border-gray-100">
                    ${externalUsed}
                </td>
                <td class="px-4 py-3 text-center text-gray-400 border-b border-gray-100">-</td>
                <td class="px-4 py-3 text-center border-b border-gray-100">
                   <span class="text-xs text-gray-400">N/A</span>
                </td>
            </tr>`;

            // Single DOM update
            $tbody.html(internalRows + externalRow);
        }


        function populateSectionCards($section, data, me) {
            const $container = $section.find('.section-cards-container');
            const sectionGroups = Object.groupBy(data, (item) => item.supervisor.mainDuty || 'Other');
            const sectionNames = [...new Set(supervisorList.filter(s => s.me === me).map(s => s.mainDuty || 'Other'))];

            // Build all HTML at once using array join for better performance
            const cardsHTML = sectionNames.map(section => {
                const sectionData = sectionGroups[section] || [{ supervisor: {} }];
                const supervisorsInSection = supervisorList.filter(s => s.me === me && (s.mainDuty || 'Other') === section);

                let hasWorkSupervisor = [];
                let noWorkSupervisor = [];

                supervisorsInSection.forEach(supervisor => {
                    const supervisorName = supervisor.name;
                    const supervisorInfo = sectionData.find(item => String(item.supervisor.userId) === String(supervisor.userId))?.supervisor || { hasWorkOrder: false, wo_count: 0 };
                    const hasWorkOrder = supervisorInfo.hasWorkOrder || false;
                    const wo_count = supervisorInfo.wo_count || 0;

                    if (hasWorkOrder) {
                        hasWorkSupervisor.push({ name: supervisorName, count: wo_count });
                    } else {
                        noWorkSupervisor.push({ name: supervisorName });
                    }
                });

                const pillsHTML = [
                    ...hasWorkSupervisor
                        .sort((a, b) => b.count - a.count)
                        .map(sup => {
                            const countBadge = sup.count > 0 ?
                                `<span class="bg-green-700 text-white ml-2 px-1.5 py-0.5 rounded text-xs font-bold">${sup.count}</span>` : '';
                            return `<div class="bg-green-100 border border-green-300 text-green-800 px-3 py-1.5 rounded-lg text-sm font-medium flex items-center shadow-sm">
                                <span>${sup.name}</span>${countBadge}
                            </div>`;
                        }),
                    ...noWorkSupervisor
                        .sort((a, b) => a.name.localeCompare(b.name))
                        .map(sup =>
                            `<div class="bg-danger-400 border border-danger-200 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center shadow-sm">
                                <span>${sup.name}</span>
                            </div>`
                        )
                ].join('');

                return `<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3 pb-2 border-b border-gray-100">${section}</h3>
                    <div class="flex flex-wrap gap-2 section-pills-container">
                        ${pillsHTML}
                    </div>
                </div>`;
            }).join('');

            // Single DOM update
            $container.html(cardsHTML);
        }

        function populateWorkOrdersTable($section, data) {
            const $tbody = $section.find('.work-orders-table-body');

            if (data.length === 0) {
                $tbody.html(`
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No work orders found</p>
                        </td>
                    </tr>
                `);
                return;
            }

            const workOrders = data.sort((a, b) => {
                const dateA = a.workOrder.date ? moment(a.workOrder.date, 'DD/MM/YYYY').toDate() : new Date(0);
                const dateB = b.workOrder.date ? moment(b.workOrder.date, 'DD/MM/YYYY').toDate() : new Date(0);
                return dateB - dateA;
            });

            // Build all rows at once for better performance
            const rowsHTML = workOrders.map(item => {
                const contractors = item.contractors || [];
                const contractorNames = [...new Set(contractors.map(c => {
                    if (c.contractor.includes('')) {
                        return c.customName || c.contractor;
                    }
                    return c.contractor;
                }))].join(', ');
                const totalQuantity = contractors.reduce((sum, c) => sum + (parseInt(c.quantity) || 0), 0);
                const workingTime = item.supervisor.startTime && item.supervisor.finishTime ?
                    `${moment(item.supervisor.startTime).format('HH:mm')} - ${moment(item.supervisor.finishTime).format('HH:mm')}` : '-';
                const status = item.status || 'Unknown';

                const statusConfig = {
                    completed: {
                        element: '<div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 cursor-pointer status-btn text-nowrap" data-recordId="' + item.recordId + '"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-check w-3 h-3" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>Completed</div>',
                        dot: '<div class="mt-1.5 w-2 h-2 rounded-full bg-green-500"></div>'
                    },
                    progress: {
                        element: '<div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 cursor-pointer status-btn text-nowrap" data-recordId="' + item.recordId + '"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock w-3 h-3" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>In Progress</div>',
                        dot: '<div class="mt-1.5 w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]"></div>'
                    },
                    cancelled: {
                        element: '<div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-danger-100 text-danger-700 cursor-pointer status-btn text-nowrap" data-recordId="' + item.recordId + '"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle w-3 h-3" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>Cancelled</div>',
                        dot: '<div class="mt-1.5 w-2 h-2 rounded-full bg-red-300"></div>'
                    },
                    default: {
                        element: null,
                        dot: '<div class="mt-1.5 w-2 h-2 rounded-full bg-gray-400"></div>'
                    }
                };

                const statusLower = status.toLowerCase();
                const config = statusLower === 'completed' ? statusConfig.completed
                    : statusLower.includes('progress') ? statusConfig.progress
                        : statusLower === 'cancelled' ? statusConfig.cancelled
                            : statusConfig.default;

                const statusElement = config.element;
                const dotStatus = config.dot;


                return `<tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="px-4 py-3 font-bold text-green-800">
                        <div class="flex items-start gap-3">
                            ${dotStatus}
                            <div><p class="font-bold text-slate-900">${item.supervisor?.name || '-'}</p></div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="font-mono font-bold px-2 py-1 rounded ${item.workOrder?.workOrderID ? 'text-slate-600 bg-slate-100 ' : 'text-danger-500 bg-danger-100'} cursor-pointer status-btn text-nowrap" data-recordId="${item.recordId}">${item.workOrder?.workOrderID || '<i class="fas fa-exclamation-triangle mr-1"></i> No ID'}</span>
                    </td>
                    <td class="px-4 py-3">${item.workOrder?.details || '-'}</td>
                    <td class="px-4 py-3">${contractorNames || '-'}</td>
                    <td class="px-4 py-3 text-center">${totalQuantity}</td>
                    <td class="px-4 py-3 text-center">${workingTime}</td>
                    <td class="px-4 py-3 text-center">
                        ${statusElement || `<span class="text-gray-500">Unknown</span>`}
                        ${item.timestamp ? '<p class="text-[10px] text-slate-400 mt-1 ml-1">' + moment(item.timestamp).fromNow() + '</p>' : ''}
                    </td>
                </tr>`;
            }).join('');

            // Single DOM update
            $tbody.html(rowsHTML);
        }

        function updateWorkOrder(recordId) {
            let wo_data = window.dashboardData.find(item => item.recordId === recordId);
            if (!wo_data) {
                Swal.fire({
                    title: 'Error!',
                    text: 'Work order data not found',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    customClass: {
                        popup: 'rounded-xl',
                        confirmButton: 'bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg',
                        cancelButton: 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded-lg'
                    }
                });
                return;
            }
            populateFormWithData(wo_data);
        }

        function populateFormWithData(wo_data) {

            $('#recordId').val(wo_data.recordId || '');

            // Show status field when updating
            if (wo_data.recordId) {
                $('#statusFieldContainer').removeClass('hidden');
                $('#recordStatus').val(wo_data.status || 'pending');
            }

            // Populate supervisor details
            $('#supervisorUserId').val(wo_data.supervisor.userId || '');
            $('#supervisorName').val(wo_data.supervisor.name || '');
            $('#supervisorPlanDate').val(wo_data.supervisor.planDate || '');
            $('#supervisorStartTime').val(moment(wo_data.supervisor.startTime).format('HH:mm') || '');
            $('#supervisorFinishTime').val(moment(wo_data.supervisor.finishTime).format('HH:mm') || '');
            $('#recordStatus').val(wo_data.status || 'in-progress');

            // Populate work order details
            $('#workOrderDate').val(moment(new Date(wo_data.workOrder.date)).format('DD/MM/YYYY') || '');
            $('#workOrderID').val(wo_data.workOrder.workOrderID || '').trigger('change');
            $('#workOrderDetailsText').val(wo_data.workOrder.details || '');
            if (wo_data.workOrder.workOrderID) {
                $('#workOrderID').trigger('keyup');
            }

            // Clear and repopulate contractors
            $('.contractor-item').not(':first').remove();
            if (wo_data.contractors && wo_data.contractors.length > 0) {
                wo_data.contractors.forEach((contractor, index) => {
                    if (index === 0) {
                        // Populate first contractor
                        const $firstContractor = $('.contractor-item:first');
                        $firstContractor.find('.contractor-type').val(contractor.type || '').trigger('change');
                        setTimeout(() => {
                            $firstContractor.find('.contractor-select').val(contractor.contractor || '').trigger('change');
                            if (contractor.contractor === " ()") {
                                $firstContractor.find('.contractor-custom-name').val(contractor.customName || '').removeClass('hidden').attr('required', true);
                            }
                            $firstContractor.find('.contractor-quantity').val(contractor.quantity || '');
                            $firstContractor.find('.contractor-plan-date')[0]._flatpickr.setDate(contractor.planDate || '');
                            $firstContractor.find('.contractor-start-time').val(contractor.startTime || '');
                            $firstContractor.find('.contractor-finish-time').val(contractor.finishTime || '');
                        }, 100);
                    } else {
                        // Add additional contractors
                        $('#addMoreContractorBtn').click();
                        console.log('Adding contractor:', contractor);
                        const $newContractor = $('.contractor-item:last');
                        $newContractor.find('.contractor-type').val(contractor.type || '').trigger('change');
                        setTimeout(() => {
                            $newContractor.find('.contractor-select').val(contractor.contractor || '').trigger('change');
                            if (contractor.contractor === " ()") {

                                $newContractor.find('.contractor-custom-name').val(contractor.customName || '').removeClass('hidden').attr('required', true);
                            }
                            $newContractor.find('.contractor-quantity').val(contractor.quantity || '');
                            $newContractor.find('.contractor-plan-date')[0]._flatpickr.setDate(contractor.planDate || '');
                            $newContractor.find('.contractor-start-time').val(contractor.startTime || '');
                            $newContractor.find('.contractor-finish-time').val(contractor.finishTime || '');
                        }, 100);
                    }
                });
            }
            // Clear and repopulate spare parts
            $('.material-item').not(':first').remove();
            if (wo_data.spareParts && wo_data.spareParts.length > 0) {
                wo_data.spareParts.forEach((part, index) => {
                    if (index === 0) {
                        // Populate first part
                        const $firstPart = $('.material-item:first');
                        $firstPart.find('.material-id').val(part.id || '');
                        $firstPart.find('.material-size').val(part.size || '');
                        $firstPart.find('.material-unit').val(part.unit || '');
                        $firstPart.find('.material-quantity').val(part.quantity || '');
                    } else {
                        // Add additional parts
                        $('#addMorePartsBtn').click();
                        const $newPart = $('.material-item:last');
                        $newPart.find('.material-id').val(part.id || '');
                        $newPart.find('.material-size').val(part.size || '');
                        $newPart.find('.material-unit').val(part.unit || '');
                        $newPart.find('.material-quantity').val(part.quantity || '');
                    }
                });
            }

            $('#createUpdateTab').click();
        }
    </script>
</body>

</html>