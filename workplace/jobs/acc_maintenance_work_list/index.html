<!DOCTYPE html>
<html lang="en">

<head>
    <base target="_top">
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACC maintenance work list</title>

    <!-- Preconnect to improve loading speed -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">


    <!-- jQuery must load synchronously as inline scripts depend on it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'red': {
                            50: '#E6F2ED',
                            100: '#CCE5DB',
                            200: '#99CBB7',
                            300: '#66B193',
                            400: '#33976F',
                            500: '#014E2C',
                            600: '#014E2C',
                            700: '#013F23',
                            800: '#012F1A',
                            900: '#012011',
                            950: '#001008'
                        },
                        'danger': {
                            50: '#FEE2E2',
                            100: '#FECACA',
                            200: '#FCA5A5',
                            300: '#F87171',
                            400: '#EF4444',
                            500: '#DC2626',
                            600: '#B91C1C',
                            700: '#991B1B',
                            800: '#7F1D1D',
                            900: '#6B1C1C'
                        },
                        'gray': {
                            50: '#F9F9F9',
                            100: '#F3F3F3',
                            200: '#E0E0E0',
                            300: '#CCCCCC',
                            400: '#999999',
                            500: '#808080',
                            600: '#4B4B4B',
                            700: '#4B4B4B',
                            800: '#3A3A3A',
                            900: '#2A2A2A'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"
        media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans Thai', sans-serif;
            -webkit-overflow-scrolling: touch;
        }

        .section-card {
            transition: box-shadow 0.3s ease;
            contain: layout style paint;
        }

        /* Disable hover effects on touch devices for better performance */
        @media (hover: hover) and (pointer: fine) {
            .section-card:hover {
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }
        }

        .spare-parts-container {
            animation: slideDown 0.3s ease;
            contain: layout style;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate3d(0, -10px, 0);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        .hidden-section {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }

            to {
                opacity: 0;
                transform: translate3d(0, -10px, 0);
            }
        }

        .required-update-field {
            background-color: #FEE2E2 !important;
            border-color: #EF4444 !important;
        }

        .required-update-field:focus {
            background-color: #FEE2E2 !important;
            border-color: #DC2626 !important;
            /* ring-color: rgba(239, 68, 68, 0.1) !important; */
        }
    </style>
</head>

<body class="bg-gray-50">

    <!-- Main Container -->
    <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-4 md:py-8 px-4 sm:px-6 lg:px-8">
        <div class="max-w-10xl mx-auto">
            <!-- Modern Header & Navigation Area -->
            <div
                class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 mb-6 hide-on-fullscreen lg:sticky lg:top-4 z-50">
                <div class="flex flex-col lg:flex-row items-center justify-between gap-4">
                    <!-- Brand / Title -->
                    <div class="flex items-center gap-4 w-full lg:w-auto">
                        <div
                            class="bg-gradient-to-br from-red-600 to-red-700 text-white p-3 rounded-xl shadow-lg shadow-red-200">
                            <i class="fas fa-tools text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900 tracking-tight">ACC Maintenance work list</h1>
                            <p class="text-sm text-gray-500 font-medium">Create and manage maintenance jobs</p>
                        </div>
                    </div>

                    <!-- Navigation Tabs -->
                    <div class="flex p-2 bg-gray-100 rounded-xl flex-col gap-3 md:flex-row justify-between w-auto">
                        <button type="button" id="createUpdateTab"
                            class="tab-nav-btn flex-1 lg:flex-none px-6 py-2.5 rounded-lg text-sm font-bold transition-colors duration-200 flex items-center justify-center gap-2 whitespace-nowrap bg-gradient-to-r from-danger-500 to-danger-600 text-white shadow-md"
                            data-tab="create-update">
                            <i class="fas fa-plus-circle"></i>Create / Update
                        </button>
                        <div class="flex">
                            <button type="button"
                                class="tab-nav-btn flex-1 lg:flex-none px-6 py-2.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-900 transition-colors duration-200 flex items-center justify-center gap-2 whitespace-nowrap"
                                data-tab="dashboard-me1">
                                <i class="fas fa-chart-line"></i>ME-1
                            </button>
                            <button type="button"
                                class="tab-nav-btn flex-1 lg:flex-none px-6 py-2.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-900 transition-colors duration-200 flex items-center justify-center gap-2 whitespace-nowrap"
                                data-tab="dashboard-me2">
                                <i class="fas fa-chart-line"></i>ME-2
                            </button>
                            <button type="button"
                                class="tab-nav-btn flex-1 lg:flex-none px-6 py-2.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-900 transition-colors duration-200 flex items-center justify-center gap-2 whitespace-nowrap"
                                data-tab="dashboard-me3">
                                <i class="fas fa-chart-line"></i>ME-3
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================================================================
                 CREATE/UPDATE TAB - Work Order Form
                 ================================================================ -->
            <div id="createUpdateTabContent" class="tab-content-section">
                <!-- Form Container -->
                <form id="workOrderForm" class="space-y-6">
                    <input type="hidden" id="recordId" value="">

                    <!-- 1. SUPERVISOR DETAILS SECTION -->
                    <div
                        class="section-card bg-white rounded-xl shadow-sm border border-gray-200 p-5 md:p-8 transition-all hover:shadow-md">
                        <div class="flex items-center gap-4 mb-8 pb-4 border-b border-gray-100">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg shadow-red-100">
                                <i class="fas fa-user-tie text-xl text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">Supervisor Details</h2>
                                <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Plan & Schedule
                                    Information</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- User ID -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-id-card text-red-500 w-5"></i>User ID
                                </label>
                                <input type="text" id="supervisorUserId" placeholder="Enter ID"
                                    class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200"
                                    required>
                            </div>

                            <!-- Name -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-user text-red-500 w-5"></i>Name
                                </label>
                                <input type="text" id="supervisorName" placeholder="Supervisor name"
                                    class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200"
                                    required>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                            <!-- Plan Date -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-calendar-alt text-red-500 w-5"></i>Plan Date
                                </label>
                                <input type="text" id="supervisorPlanDate" placeholder="Select date"
                                    class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200 cursor-pointer"
                                    readonly required>
                            </div>

                            <!-- Start Time -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-play-circle text-green-500 w-5"></i>Start Time
                                </label>
                                <input type="time" id="supervisorStartTime"
                                    class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200"
                                    required>
                            </div>

                            <!-- Finish Time -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-stop-circle text-red-500 w-5"></i>Finish Time
                                </label>
                                <input type="time" id="supervisorFinishTime"
                                    class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200"
                                    required>
                            </div>
                        </div>

                        <!-- Status Field (shown only on update) -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 hidden border-t border-gray-100 pt-6"
                            id="statusFieldContainer">
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-flag text-yellow-500 w-5"></i>Current Status
                                </label>
                                <select id="recordStatus"
                                    class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200">
                                    <option value="in-progress">⏳ In Progress</option>
                                    <option value="completed">✅ Completed</option>
                                    <option value="cancelled">❌ Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 2. WORK ORDER DETAILS SECTION -->
                    <div
                        class="section-card bg-white rounded-xl shadow-sm border border-gray-200 p-5 md:p-8 transition-all hover:shadow-md">
                        <div class="flex items-center gap-4 mb-8 pb-4 border-b border-gray-100">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-gray-700 to-gray-800 rounded-xl flex items-center justify-center shadow-lg shadow-gray-100">
                                <i class="fas fa-clipboard-list text-xl text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">Work Order Details</h2>
                                <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Asset &
                                    Maintenance Scope</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6">
                            <!-- Work Order ID -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-hashtag text-gray-400 w-5"></i>Work Order ID
                                </label>
                                <input type="text" id="workOrderID" placeholder="Enter WO#"
                                    class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-gray-500 focus:ring-4 focus:ring-gray-500/10 outline-none transition-all duration-200 uppercase font-mono tracking-wider">
                            </div>
                        </div>

                        <!-- Details Textarea -->
                        <div id="workOrderDetailsContainer" class="border-t border-gray-50">
                            <label class="flex items-center text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-pen-nib text-gray-400 w-5"></i>Task Description
                            </label>
                            <textarea id="workOrderDetailsText" placeholder="Describe the maintenance task in detail..."
                                rows="4"
                                class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-500/10 outline-none transition-all duration-200 resize-none"></textarea>
                        </div>

                        <!-- Spare Parts Section -->
                        <div id="sparePartDetailsContainer" class="mt-4 mb-4">
                            <div class="flex items-center justify-between mb-4">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-box-open text-gray-400 w-5"></i>Spare Parts Inventory
                                </label>
                            </div>

                            <div id="partsListContainer" class="space-y-3">
                                <!-- Part Item Template -->
                                <div class="material-item bg-gray-50 p-4 md:p-6 rounded-2xl border border-gray-100 hover:border-gray-300 transition-all group"
                                    data-part-index="0">
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                        <!-- Part ID -->
                                        <div class="md:col-span-4 space-y-1.5">
                                            <span
                                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Material
                                                ID</span>
                                            <input type="text"
                                                class="material-id w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition"
                                                placeholder="Enter ID" required>
                                        </div>

                                        <!-- Size -->
                                        <!-- <div class="md:col-span-2 space-y-1.5">
                                            <span
                                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Size</span>
                                            <input type="text"
                                                class="material-size w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition"
                                                placeholder="eg. 100mm, etc.">
                                        </div> -->

                                        <!-- Unit -->
                                        <!-- <div class="md:col-span-2 space-y-1.5">
                                            <span
                                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Unit</span>
                                            <input type="text"
                                                class="material-unit w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition"
                                                placeholder="eg. pcs, etc.">
                                        </div> -->

                                        <!-- Qty -->
                                        <div class="md:col-span-3 space-y-1.5">
                                            <span
                                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest pl-1">Qty</span>
                                            <input type="number"
                                                class="material-quantity w-full px-3 py-2 bg-white border border-gray-200 rounded-lg focus:border-gray-500 focus:ring-2 focus:ring-gray-100 outline-none transition"
                                                placeholder="0" min="0">
                                        </div>

                                        <!-- Action -->
                                        <div class="md:col-span-2">
                                            <button type="button"
                                                class="delete-material-btn w-full bg-white hover:bg-red-50 text-danger-400 hover:text-danger-600 border border-gray-200 hover:border-red-200 py-2 rounded-lg transition-all duration-200 flex items-center justify-center h-10">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="button" id="addMorePartsBtn"
                                class="mt-4 w-full py-3 border-2 border-dashed border-gray-200 rounded-2xl text-gray-400 font-bold hover:border-gray-400 hover:text-gray-600 hover:bg-gray-50 transition-all flex items-center justify-center gap-2 group">
                                <div
                                    class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-white transition-colors">
                                    <i class="fas fa-plus text-xs"></i>
                                </div>
                                Add Spare Part
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6">
                            <!-- Work Order ID -->
                            <div class="space-y-2">
                                <label class="flex items-center text-sm font-bold text-gray-700">
                                    <i class="fas fa-dollar-sign text-gray-400 w-5">
                                    </i>External cost
                                </label>
                                <input type="number" min="0" id="externalCost" placeholder="Enter Cost"
                                    class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-gray-500 focus:ring-4 focus:ring-gray-500/10 outline-none transition-all duration-200 uppercase font-mono tracking-wider">

                            </div>
                        </div>
                    </div>

                    <!-- 3. CONTRACTOR INFORMATION SECTION -->
                    <div
                        class="section-card bg-white rounded-xl shadow-sm border border-gray-200 p-5 md:p-8 transition-all hover:shadow-md">
                        <div class="flex items-center gap-4 mb-8 pb-4 border-b border-gray-100">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-green-600 to-green-700 rounded-xl flex items-center justify-center shadow-lg shadow-green-100">
                                <i class="fas fa-hammer text-xl text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">Contractor Execution</h2>
                                <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Labor & Quantity
                                    Assignment</p>
                            </div>
                        </div>

                        <div id="contractorListContainer" class="space-y-4">
                            <!-- Contractor Item Template -->
                            <div class="contractor-item bg-gray-50 p-5 md:p-6 rounded-2xl border border-gray-100 hover:border-green-200 transition-all group"
                                data-contractor-index="0">
                                <div
                                    class="grid grid-cols-1 md:grid-cols-10 gap-6 items-end pb-4 border-b border-gray-200/50">
                                    <!-- Contractor Type -->
                                    <div class="space-y-1.5 md:col-span-3">
                                        <label class="flex items-center text-sm font-bold text-gray-700">
                                            <i class="fas fa-layer-group text-green-500 w-5"></i>Contractor Type
                                        </label>
                                        <select
                                            class="contractor-type w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-500/10 outline-none transition-all duration-200 w-full">
                                            <option value="">-- Select Type --</option>
                                            <option value="no-contractor">No Contractor</option>
                                            <option value="internal">Internal</option>
                                            <option value="external">External</option>
                                        </select>
                                    </div>
                                    <!-- Contractor Selection -->
                                    <div class="space-y-1.5 md:col-span-3">
                                        <label class="flex items-center text-sm font-bold text-gray-700">
                                            <i class="fas fa-briefcase text-green-500 w-5"></i>Contractor Name
                                        </label>
                                        <select
                                            class="contractor-select w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-500/10 outline-none transition-all duration-200 w-full">
                                            <option value="">-- Select Contractor --</option>
                                        </select>
                                    </div>
                                    <div class="space-y-1.5 md:col-span-2 contractor-custom-name-div hidden">
                                        <label class="flex items-center text-sm font-bold text-gray-700">
                                            <i class="fas fa-user-edit text-green-500 w-5"></i>
                                            Contractor Custom Name
                                        </label>
                                        <input type="text"
                                            class="contractor-custom-name px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-gray-500 focus:ring-4 focus:ring-gray-500/10 outline-none transition-all duration-200 uppercase font-mono tracking-wider w-full">
                                    </div>
                                    <!-- Quantity -->
                                    <div class="space-y-1.5 md:col-span-3">
                                        <label class="flex items-center text-sm font-bold text-gray-700">
                                            <i class="fas fa-users text-green-500 w-5"></i>Quantity
                                        </label>
                                        <input type="text"
                                            class="contractor-quantity px-4 py-2.5 bg-white border border-gray-200 rounded-xl focus:bg-white focus:border-gray-500 focus:ring-4 focus:ring-gray-500/10 outline-none transition-all duration-200 uppercase font-mono tracking-wider w-full">
                                    </div>
                                    <!-- delete button -->
                                    <div class="md:col-span-1">
                                        <button type="button"
                                            class="delete-contractor-btn w-full h-10 bg-white hover:bg-red-50 text-danger-400 hover:text-danger-500 border border-gray-200 hover:border-red-200 rounded-lg transition-all flex items-center justify-center w-full">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" id="addMoreContractorBtn"
                            class="mt-6 w-full py-4 border-2 border-dashed border-gray-200 rounded-2xl text-gray-400 font-bold hover:border-green-400 hover:text-green-600 hover:bg-green-50 transition-all flex items-center justify-center gap-3 group">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-white transition-colors">
                                <i class="fas fa-plus"></i>
                            </div>
                            Assign Another Contractor
                        </button>
                    </div>

                    <!-- Form Action Buttons -->
                    <div class="flex flex-col md:flex-row gap-4 justify-end pt-10">
                        <button type="button" id="resetBtn"
                            class="group flex items-center justify-center gap-2 px-8 py-3.5 bg-white border border-gray-200 text-gray-500 font-bold rounded-2xl hover:bg-gray-50 hover:text-gray-700 hover:border-gray-300 transition-all duration-200 shadow-sm">
                            <i
                                class="fas fa-redo-alt text-xs group-hover:rotate-180 transition-transform duration-500"></i>
                            Reset Form
                        </button>
                        <button type="submit"
                            class="flex items-center justify-center gap-2 px-10 py-3.5 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold rounded-2xl hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg shadow-red-200 group">
                            <i class="fas fa-save"></i>
                            Save Work Order
                            <i
                                class="fas fa-arrow-right text-xs opacity-50 group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- ================================================================
                 DASHBOARD TABS - ME1, ME2, ME3
                 ================================================================ -->
            <div id="dashboardTabContent-ME1" class="tab-content-section h-dvh hidden">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 h-full">
                    <!-- Left Sidebar Column -->
                    <div class="lg:col-span-1 space-y-4 h-full">
                        <!-- Department Info Card -->
                        <div
                            class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl shadow-lg p-5 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 -mt-2 -mr-2 opacity-10">
                                <i class="fas fa-building text-8xl"></i>
                            </div>
                            <div class="flex justify-between items-center">
                                <h3 class="text-sm font-medium opacity-90">Department</h3>
                                <div
                                    class="flex items-center gap-2 text-white/90 text-xs font-medium bg-black/10 px-2 py-1.5 rounded-lg backdrop-blur-md border border-white/10">
                                    <i class="far fa-calendar-alt"></i>
                                    <span class="currentDate"></span>
                                </div>
                            </div>
                            <div class="mt-2 mb-4">
                                <h2 class="text-3xl md:text-4xl font-bold department-name tracking-tight">--</h2>
                            </div>
                            <div class="flex justify-between items-center">
                                <div
                                    class="inline-flex items-center px-2.5 py-1 bg-white/20 rounded-full text-xs backdrop-blur-sm">
                                    <i class="fas fa-circle text-[10px] text-green-300 mr-1.5"></i> Active
                                </div>
                                <div class="flex gap-2 items-center">
                                    <button onclick="loadDashboardData()"
                                        class="text-gray-300 hover:text-green-100 transition p-1 hover:bg-white/10 rounded-full"
                                        title="Reload Data">
                                        <i class="fas fa-sync-alt text-sm reload-icon"></i>
                                    </button>
                                    <button id="fullscreenToggleBtn" onclick="toggleFullscreen()"
                                        class="transition text-gray-300 hover:bg-white/50 rounded-full"
                                        title="Toggle Fullscreen">
                                        <i class="fas fa-expand text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Section Card Container -->
                        <div class="section-cards-container space-y-4">
                            <!-- Will be populated by updateDashboard function -->
                        </div>

                        <!-- Contractor Capacity Card -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-users-cog text-gray-400 mr-2"></i>Contractor Capacity
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs text-left">
                                    <thead class="text-[10px] text-gray-500 uppercase bg-gray-50/50">
                                        <tr>
                                            <th class="px-2 py-2 font-medium">Contractor</th>
                                            <th class="px-2 py-2 font-medium text-center">Used</th>
                                            <th class="px-2 py-2 font-medium text-center">Cap.</th>
                                        </tr>
                                    </thead>
                                    <tbody class="contractor-capacity-table-body divide-y divide-gray-100">
                                        <!-- Will be populated by updateDashboard function -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column: Work Orders Table -->
                    <div class="md:col-span-3 h-full">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col">
                            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                                <h3 class="font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-list-alt text-red-500 mr-2"></i> Work Orders
                                </h3>
                            </div>
                            <div class="overflow-x-auto flex-grow">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Supervisor</th>
                                            <th scope="col" class="px-6 py-3">Work Order</th>
                                            <th scope="col" class="px-6 py-3">Description</th>
                                            <th scope="col" class="px-6 py-3">Contractor</th>
                                            <th scope="col" class="px-6 py-3 text-center">Quantity</th>
                                            <th scope="col" class="px-6 py-3 text-center">Working time</th>
                                            <th scope="col" class="px-6 py-3 text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="work-orders-table-body divide-y divide-gray-100">
                                        <!-- Will be populated by updateDashboard function -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="dashboardTabContent-ME2" class="tab-content-section h-dvh hidden">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 h-full">
                    <!-- Left Sidebar Column -->
                    <div class="lg:col-span-1 space-y-4 h-full">
                        <!-- Department Info Card -->
                        <div
                            class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl shadow-lg p-5 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 -mt-2 -mr-2 opacity-10">
                                <i class="fas fa-building text-8xl"></i>
                            </div>
                            <div class="flex justify-between items-center">
                                <h3 class="text-sm font-medium opacity-90">Department</h3>
                                <div
                                    class="flex items-center gap-2 text-white/90 text-xs font-medium bg-black/10 px-2 py-1.5 rounded-lg backdrop-blur-md border border-white/10">
                                    <i class="far fa-calendar-alt"></i>
                                    <span class="currentDate"></span>
                                </div>
                            </div>
                            <div class="mt-2 mb-4">
                                <h2 class="text-3xl md:text-4xl font-bold department-name tracking-tight">--</h2>
                            </div>
                            <div class="flex justify-between items-center">
                                <div
                                    class="inline-flex items-center px-2.5 py-1 bg-white/20 rounded-full text-xs backdrop-blur-sm">
                                    <i class="fas fa-circle text-[10px] text-green-300 mr-1.5"></i> Active
                                </div>
                                <div class="flex gap-2 items-center">
                                    <button onclick="loadDashboardData()"
                                        class="text-gray-300 hover:text-green-100 transition p-1 hover:bg-white/10 rounded-full"
                                        title="Reload Data">
                                        <i class="fas fa-sync-alt text-sm reload-icon"></i>
                                    </button>
                                    <button id="fullscreenToggleBtn" onclick="toggleFullscreen()"
                                        class="transition text-gray-300 hover:bg-white/50 rounded-full"
                                        title="Toggle Fullscreen">
                                        <i class="fas fa-expand text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Section Card Container -->
                        <div class="section-cards-container space-y-4">
                            <!-- Will be populated by updateDashboard function -->
                        </div>

                        <!-- Contractor Capacity Card -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-users-cog text-gray-400 mr-2"></i>Contractor Capacity
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs text-left">
                                    <thead class="text-[10px] text-gray-500 uppercase bg-gray-50/50">
                                        <tr>
                                            <th class="px-2 py-2 font-medium">Contractor</th>
                                            <th class="px-2 py-2 font-medium text-center">Used</th>
                                            <th class="px-2 py-2 font-medium text-center">Cap.</th>
                                        </tr>
                                    </thead>
                                    <tbody class="contractor-capacity-table-body divide-y divide-gray-100">
                                        <!-- Will be populated by updateDashboard function -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column: Work Orders Table -->
                    <div class="md:col-span-3 h-full">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col">
                            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                                <h3 class="font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-list-alt text-red-500 mr-2"></i> Work Orders
                                </h3>
                            </div>
                            <div class="overflow-x-auto flex-grow">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Supervisor</th>
                                            <th scope="col" class="px-6 py-3">Work Order</th>
                                            <th scope="col" class="px-6 py-3">Description</th>
                                            <th scope="col" class="px-6 py-3">Contractor</th>
                                            <th scope="col" class="px-6 py-3 text-center">Quantity</th>
                                            <th scope="col" class="px-6 py-3 text-center">Working time</th>
                                            <th scope="col" class="px-6 py-3 text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="work-orders-table-body divide-y divide-gray-100">
                                        <!-- Will be populated by updateDashboard function -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="dashboardTabContent-ME3" class="tab-content-section h-dvh hidden">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 h-full">
                    <!-- Left Sidebar Column -->
                    <div class="lg:col-span-1 space-y-4 h-full">
                        <!-- Department Info Card -->
                        <div
                            class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl shadow-lg p-5 text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 -mt-2 -mr-2 opacity-10">
                                <i class="fas fa-building text-8xl"></i>
                            </div>
                            <div class="flex justify-between items-center">
                                <h3 class="text-sm font-medium opacity-90">Department</h3>
                                <div
                                    class="flex items-center gap-2 text-white/90 text-xs font-medium bg-black/10 px-2 py-1.5 rounded-lg backdrop-blur-md border border-white/10">
                                    <i class="far fa-calendar-alt"></i>
                                    <span class="currentDate"></span>
                                </div>
                            </div>
                            <div class="mt-2 mb-4">
                                <h2 class="text-3xl md:text-4xl font-bold department-name tracking-tight">--</h2>
                            </div>
                            <div class="flex justify-between items-center">
                                <div
                                    class="inline-flex items-center px-2.5 py-1 bg-white/20 rounded-full text-xs backdrop-blur-sm">
                                    <i class="fas fa-circle text-[10px] text-green-300 mr-1.5"></i> Active
                                </div>
                                <div class="flex gap-2 items-center">
                                    <button onclick="loadDashboardData()"
                                        class="text-gray-300 hover:text-green-100 transition p-1 hover:bg-white/10 rounded-full"
                                        title="Reload Data">
                                        <i class="fas fa-sync-alt text-sm reload-icon"></i>
                                    </button>
                                    <button id="fullscreenToggleBtn" onclick="toggleFullscreen()"
                                        class="transition text-gray-300 hover:bg-white/50 rounded-full"
                                        title="Toggle Fullscreen">
                                        <i class="fas fa-expand text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Section Card Container -->
                        <div class="section-cards-container space-y-4">
                            <!-- Will be populated by updateDashboard function -->
                        </div>

                        <!-- Contractor Capacity Card -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-users-cog text-gray-400 mr-2"></i>Contractor Capacity
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs text-left">
                                    <thead class="text-[10px] text-gray-500 uppercase bg-gray-50/50">
                                        <tr>
                                            <th class="px-2 py-2 font-medium">Contractor</th>
                                            <th class="px-2 py-2 font-medium text-center">Used</th>
                                            <th class="px-2 py-2 font-medium text-center">Cap.</th>
                                        </tr>
                                    </thead>
                                    <tbody class="contractor-capacity-table-body divide-y divide-gray-100">
                                        <!-- Will be populated by updateDashboard function -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column: Work Orders Table -->
                    <div class="md:col-span-3 h-full">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col">
                            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                                <h3 class="font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-list-alt text-red-500 mr-2"></i> Work Orders
                                </h3>
                            </div>
                            <div class="overflow-x-auto flex-grow">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Supervisor</th>
                                            <th scope="col" class="px-6 py-3">Work Order</th>
                                            <th scope="col" class="px-6 py-3">Description</th>
                                            <th scope="col" class="px-6 py-3">Contractor</th>
                                            <th scope="col" class="px-6 py-3 text-center">Quantity</th>
                                            <th scope="col" class="px-6 py-3 text-center">Working time</th>
                                            <th scope="col" class="px-6 py-3 text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="work-orders-table-body divide-y divide-gray-100">
                                        <!-- Will be populated by updateDashboard function -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts at end for better performance -->
    <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <!-- <script defer src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script> -->
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/rangePlugin.js"></script>
    <script defer src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script defer
        src="https://cdn.jsdelivr.net/gh/tanaikech/ResumableUploadForGoogleDrive_js@master/resumableupload_js.min.js">
        </script>
    <script defer src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <script>
        /* ============================================================================
               GLOBAL VARIABLES & CONFIGURATION
               ============================================================================ */

        var contractorList = <?!= JSON.stringify(contractorList) ?>;
        var supervisorList = <?!= JSON.stringify(supervisorList) ?>;
        var preDefinedWorkOrders = <?!= JSON.stringify(preDefinedWorkOrders) ?>;
        var isLoadingDashboard = false, reloadInterval = 60000; // default 1 minute
        let reloadIntervalId = null;

        /* ============================================================================
           DOM CACHE - Performance Optimization
           ============================================================================ */

        const DOMCache = {
            init: function () {
                this.$body = $('body');
                this.$currentDate = $('.currentDate');
                this.$supervisorPlanDate = $('#supervisorPlanDate');
                this.$supervisorUserId = $('#supervisorUserId');
                this.$supervisorName = $('#supervisorName');
                this.$supervisorStartTime = $('#supervisorStartTime');
                this.$supervisorFinishTime = $('#supervisorFinishTime');
                this.$workOrderID = $('#workOrderID');
                this.$workOrderDetailsContainer = $('#workOrderDetailsContainer');
                this.$workOrderDetailsText = $('#workOrderDetailsText');
                this.$sparePartDetailsContainer = $('#sparePartDetailsContainer');
                this.$contractorListContainer = $('#contractorListContainer');
                this.$partsListContainer = $('#partsListContainer');
                this.$workOrderForm = $('#workOrderForm');
                this.$reloadIcon = $('.reload-icon');
                this.$createUpdateTab = $('#createUpdateTab');
            }
        };

        /* ============================================================================
           AUTO-RELOAD FUNCTIONALITY
           ============================================================================ */

        function startAutoReload() {
            // Clear existing interval if any
            if (reloadIntervalId) {
                clearInterval(reloadIntervalId);
            }

            const checkAndReload = () => {
                const activeTab = $('.tab-content-section:not(.hidden)').attr('id');
                const currentHour = new Date().getHours();
                let currentReloadInterval;

                // if (currentHour >= 0 && currentHour < 24) {
                //     currentReloadInterval = 60000; // 1 minute
                // } 

                if (currentHour >= 7 && currentHour < 9) {
                    currentReloadInterval = 60000; // 1 minute
                }
                else if (currentHour >= 9 && currentHour < 18) {
                    currentReloadInterval = 600000; // 10 minutes
                } else {
                    currentReloadInterval = 3600000; // 1 hour
                }

                console.log(`Auto-reload interval: ${currentReloadInterval / 1000 / 60} minutes. Active tab: ${activeTab}`);

                // Only reload if a dashboard tab is active
                if (activeTab && activeTab !== 'createUpdateTabContent') {
                    loadDashboardData();
                }
            };

            // Check every minute if interval needs to change
            reloadIntervalId = setInterval(checkAndReload, 60000);

            // Run immediately on start
            checkAndReload();
        }

        /* ============================================================================
           UI UTILITIES
           ============================================================================ */

        // Fullscreen toggle function
        function toggleFullscreen() {
            $('.hide-on-fullscreen').toggleClass('hidden');
        }

        // Listen for fullscreen changes (for ESC key or F11)
        document.addEventListener('fullscreenchange', function () {
            const fullscreenBtn = document.getElementById('fullscreenToggleBtn');
            if (fullscreenBtn) {
                const icon = fullscreenBtn.querySelector('i');
                if (!document.fullscreenElement) {
                    icon.classList.remove('fa-compress');
                    icon.classList.add('fa-expand');
                    icon.title = 'Toggle Fullscreen';
                }
            }
        });

        /* ============================================================================
           INITIALIZATION
           ============================================================================ */

        $(document).ready(function () {
            // Initialize DOM cache
            DOMCache.init();

            // Initialize current date in dashboard header
            const todayStr = moment().format('DD MMM YYYY');
            DOMCache.$currentDate.text(todayStr);
            DOMCache.$supervisorPlanDate.val(new Date().toLocaleDateString('en-CA'));

            // get dashboard data
            loadDashboardData();
            // Initialize date fields to today
            const today = new Date().toLocaleDateString('en-CA');


            flatpickr('#supervisorStartTime', {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true,
                time_24hr: true,
                defaultDate: "08:00"
            });
            flatpickr('#supervisorFinishTime', {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true,
                time_24hr: true,
                defaultDate: "17:00"
            });

            // Handle Work Order Checkbox - Toggle between work order details and spare parts (optimized)
            $('#workOrderID').on('keyup', _.debounce(function () {
                const workOrderId = $(this).val().trim();
                const $detailsContainer = $('#workOrderDetailsContainer');
                const $spareContainer = $('#sparePartDetailsContainer');
                const $materialItems = $('.material-item');
                const isUpdate = $('#recordId').val().trim() !== '';
                const $detailsText = $('#workOrderDetailsText');
                if (workOrderId !== '') {
                    // Batch DOM updates for better performance
                    requestAnimationFrame(() => {
                        $detailsContainer.find('textarea').attr('required', true);
                        $materialItems.find('input').attr('required', false);
                        $('#externalCost').attr('required', false);

                        let wo = preDefinedWorkOrders.find(pre_wo => pre_wo.workOrderID == workOrderId);
                        if (wo) {
                            $detailsText.val(wo.description);
                        }
                    });
                } else {
                    // Batch DOM updates
                    requestAnimationFrame(() => {
                        $detailsContainer.find('textarea').attr('required', false);
                        $materialItems.find('input').attr('required', true);
                        $('#externalCost').attr('required', true);
                    });
                }
            }, 300));

            $('#resetBtn').click(function (e) {
                window.open('<?!= ScriptApp.getService().getUrl() ?>', '_top');
                Swal.fire({
                    title: 'Form Reset',
                    text: 'please wait while the form is resetting...',
                    icon: 'info',
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    customClass: {
                        popup: 'rounded-2xl',
                    },
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            });

            /* ================================================================
               CONTRACTOR MANAGEMENT
               ================================================================ */

            // Handle Contractor Tab Switching
            $('.tab-button').click(function (e) {
                e.preventDefault();
                const tab = $(this).data('tab');

                // Update active tab styling
                $('.tab-button').removeClass('border-purple-500').addClass('border-transparent');
                $(this).removeClass('border-transparent').addClass('border-purple-500');

                // Show/hide tab content
                if (tab === 'internal') {
                    $('#internalContractorSection').removeClass('hidden');
                    $('#externalContractorSection').addClass('hidden');
                } else {
                    $('#internalContractorSection').addClass('hidden');
                    $('#externalContractorSection').removeClass('hidden');
                }
            });

            // Update contractor options when type changes (optimized with caching)
            $(document).on('change', '.contractor-type', function () {
                const type = $(this).val();
                if(!type || type === 'no-contractor') {
                    // If no valid type is selected, reset the contractor select and hide custom name
                    const $contractorItem = $(this).closest('.contractor-item');
                    $contractorItem.find('.contractor-select').html('<option value="">-- Select Contractor --</option>').end()
                        .find('.contractor-custom-name-div').addClass('hidden').find('input').val('').prop('required', false);
                    $contractorItem.find('input,select').attr('required', false);
                    return;
                }
                const $contractorItem = $(this).closest('.contractor-item');
                const $contractorSelect = $contractorItem.find('.contractor-select');
                console.log('Contractor type changed:', type);
                const $customNameDiv = $contractorItem.find('.contractor-custom-name-div');
                const supervisorUserId = $('#supervisorUserId').val().trim();
                const supervisor = supervisorList.find(s => String(s.userId) == supervisorUserId);
                console.log('Selected Contractor Type:', type);
                console.log('Supervisor Info:', supervisor);
                // Build options HTML efficiently
                let optionsHTML = '<option value="">-- Select Contractor --</option>';

                if (type && supervisor) {
                    const uniqueContractors = new Set();
                    const options = contractorList
                        .filter(c => {
                            return c.type === type && (c.me === supervisor.me || c.me === 'All')
                        })
                        .reduce((acc, c) => {
                            if (!uniqueContractors.has(c.contractor)) {
                                uniqueContractors.add(c.contractor);
                                acc.push(`<option value="${c.contractor}">${c.contractor}</option>`);
                            }
                            return acc;
                        }, []);

                    optionsHTML += options.join('');
                    $contractorItem.find('input,select').attr('required', true);
                } else {
                    $contractorItem.find('input,select').attr('required', false);
                }

                // Single DOM update
                $contractorSelect.html(optionsHTML);
                $customNameDiv.addClass('hidden');
            });

            // Handle external contractor custom name visibility (use event delegation)
            $(document).on('change', '.contractor-select', function () {
                const $contractorItem = $(this).closest('.contractor-item');
                const type = $contractorItem.find('.contractor-type').val();
                const select = $contractorItem.find('.contractor-select');
                const quantity = $contractorItem.find('.contractor-quantity');
                const value = $(this).val();
                const $customNameDiv = $contractorItem.find('.contractor-custom-name-div');

                if (type === 'external' && value === 'อื่นๆ (กรอกเอง)') {
                    $customNameDiv.removeClass('hidden').find('input').val('').prop('required', true);
                    select.parent().removeClass('md:col-span-3').addClass('md:col-span-2');
                    quantity.parent().removeClass('md:col-span-3').addClass('md:col-span-2');
                } else {
                    $customNameDiv.addClass('hidden').find('input').val('').prop('required', false);
                    select.parent().removeClass('md:col-span-2').addClass('md:col-span-3');
                    quantity.parent().removeClass('md:col-span-2').addClass('md:col-span-3');
                }
            });

            $(document).on('keyup', '#supervisorUserId', _.debounce(function () {
                const userId = $(this).val().trim();
                const $supervisorName = $('#supervisorName');
                const supervisor = supervisorList.find(s => s.userId == userId);

                if (supervisor) {
                    $supervisorName.val(supervisor.name).prop('readonly', true);
                } else {
                    $supervisorName.val('').prop('readonly', false);
                }
            }, 300));


            // Add More Contractors
            let contractorIndex = 1;
            $('#addMoreContractorBtn').click(function (e) {
                e.preventDefault();
                const $newContractorHTML = $('.contractor-item').first().clone();
                $newContractorHTML.find('input, select').val('');
                $newContractorHTML.attr('data-contractor-index', contractorIndex);
                $('#contractorListContainer').append($newContractorHTML);
                contractorIndex++;
            });

            // Delete Contractor
            $(document).on('click', '.delete-contractor-btn', function (e) {
                e.preventDefault();
                if ($('.contractor-item').length <= 1) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Cannot Delete',
                        text: 'At least one contractor is required.',
                        customClass: {
                            popup: 'rounded-2xl',
                            confirmButton: 'bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg'
                        }
                    });
                    return;
                }
                $(this).closest('.contractor-item').fadeOut(300, function () {
                    $(this).remove();
                });
            });

            // Add More Spare Parts
            let partIndex = 1;
            $('#addMorePartsBtn').click(function (e) {
                e.preventDefault();
                const $newPartHTML = $('.material-item').first().clone();
                $newPartHTML.find('input, select').val('');
                $newPartHTML.attr('data-part-index', partIndex);
                $('#partsListContainer').append($newPartHTML);
                partIndex++;
            });

            // Delete Spare Part
            $(document).on('click', '.delete-material-btn', function (e) {
                e.preventDefault();
                if ($('.material-item').length <= 1) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Cannot Delete',
                        text: 'At least one spare part is required.',
                        customClass: {
                            popup: 'rounded-2xl',
                            confirmButton: 'bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg'
                        }
                    });
                    return;
                }
                $(this).closest('.material-item').fadeOut(300, function () {
                    $(this).remove();
                });
            });

            // Handle Spare Part ID input to toggle required fields (optimized)
            $(document).on('keyup', '.material-id', _.debounce(function () {
                const partId = $(this).val().trim();
                const $detailsContainer = $('#sparePartDetailsContainer');
                const $workOrderDetailsContainer = $('#workOrderDetailsContainer');
                const $workOrderDetailsText = $('#workOrderDetailsText');
                const $externalCost = $('#externalCost');
                if (partId !== '') {
                    // Batch DOM updates for better performance
                    requestAnimationFrame(() => {
                        $detailsContainer.find('input').attr('required', true);
                        $workOrderDetailsContainer.find('textarea').attr('required', false);
                        $externalCost.attr('required', true);
                    });
                } else {
                    // Batch DOM updates
                    requestAnimationFrame(() => {
                        $detailsContainer.find('input').attr('required', false);
                        $workOrderDetailsContainer.find('textarea').attr('required', true);
                        $externalCost.attr('required', false);
                    });
                }
            }, 300));

            /* ================================================================
               FORM SUBMISSION & DATA HANDLING
               ================================================================ */

            // Form Submission
            $('#workOrderForm').submit(function (e) {
                e.preventDefault();
                Swal.fire({
                    title: `Confirm ${$('#recordId').val() ? 'Update' : 'Submit'}`,
                    text: 'Are you sure you want to ' + ($('#recordId').val() ? 'update' : 'submit') + ' this work order?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: `Yes, ${$('#recordId').val() ? 'Update' : 'Submit'}`,
                    cancelButtonText: 'Cancel',
                    customClass: {
                        popup: 'rounded-2xl',
                        confirmButton: 'bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg',
                        cancelButton: 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded-lg'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        submitWorkOrderForm();
                    }
                });
            });

            // Submit Work Order Form Function
            function submitWorkOrderForm() {
                // Show loading spinner
                Swal.fire({
                    title: 'Processing...',
                    text: 'Saving work order...',
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: 'rounded-2xl',
                        confirmButton: 'bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg',
                        cancelButton: 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded-lg'
                    }
                });

                // Collect contractors data
                const contractors = [];
                $('.contractor-item').each(function () {
                    const type = $(this).find('.contractor-type').val();
                    if (!type) return; // Skip if type not selected
                    let contractor = $(this).find('.contractor-select').val();


                    contractors.push({
                        type: type,
                        contractor: contractor,
                        customName: $(this).find('.contractor-custom-name').val() || '',
                        quantity: $(this).find('.contractor-quantity').val(),
                    });
                });

                // Collect form data
                const formData = {
                    recordId: $('#recordId').val(),
                    status: $('#recordStatus').val(),
                    supervisor: {
                        userId: $('#supervisorUserId').val(),
                        name: $('#supervisorName').val(),
                        planDate: $('#supervisorPlanDate').val(),
                        startTime: $('#supervisorStartTime').val(),
                        finishTime: $('#supervisorFinishTime').val()
                    },
                    workOrder: {
                        date: $('#supervisorPlanDate').val(),
                        workOrderID: $('#workOrderID').val(),
                        details: $('#workOrderDetailsText').val()
                    },
                    contractors: contractors,
                    spareParts: [],
                    externalCost: $('#externalCost').val()
                };

                // Collect spare parts
                $('.material-item').each(function () {
                    const part = {
                        id: $(this).find('.material-id').val(),
                        size: $(this).find('.material-size').val(),
                        unit: $(this).find('.material-unit').val(),
                        quantity: $(this).find('.material-quantity').val()
                    };
                    formData.spareParts.push(part);
                });


                if (formData.recordId) {
                    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).updateWorkOrder(formData);
                } else {
                    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).submitWorkOrder(formData);
                }
                // Call backend function
            }

            /**
             * Form Reset Handler
             */
            $('#workOrderForm').on('reset', function (e) {

                $('#supervisorName').prop('readonly', false);
                // Hide status field on reset (create mode)
                $('#statusFieldContainer').addClass('hidden');
                $('#recordStatus').val('');
                $('#recordId').val('');
                // Remove required field highlighting
                $('#supervisorFinishTime').removeClass('required-update-field');
                $('#recordStatus').removeClass('required-update-field');
                setTimeout(() => {
                    DOMCache.$supervisorPlanDate.val(new Date().toLocaleDateString('en-CA'));
                    $('#supervisorStartTime')[0]._flatpickr.setDate("08:00");
                    $('#supervisorFinishTime')[0]._flatpickr.setDate("17:00");
                    $('.contractor-item').not(':first').remove();
                    $('.material-item').not(':first').remove();
                    DOMCache.$workOrderDetailsContainer.find('textarea').attr('required', false);
                    DOMCache.$sparePartDetailsContainer.find('input').attr('required', true);
                    // scroll to top
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 300);
                }, 200);

            });

            /**
             * Success handler for form submission
             */
            function onSuccess(response) {
                response = JSON.parse(response);

                isLoadingDashboard = false;
                loadDashboardData();
                if (response.success) {
                    Swal.fire({
                        title: 'Success!',
                        html: `Work Order has been saved successfully!<br><small>${moment().format('YYYY-MM-DD HH:mm:ss')}</small>`,
                        icon: 'success',
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'rounded-xl',
                            confirmButton: 'bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg'
                        }
                    }).then(() => {
                        // Reset form
                        $('#workOrderForm')[0].reset();

                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        html: response.message + '<br>' +
                            `<ul class="text-left mt-2 text-sm text-red-600">${response.errors.map(err => `<li>• ${err}</li>`).join('')}</ul>`,
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'rounded-xl',
                            confirmButton: 'bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg'
                        }
                    });
                }
            }

            /**
             * Error handler for form submission
             */
            function onFailure(error) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to save work order: ' + error.toString(),
                    icon: 'error',
                    confirmButtonText: 'OK',
                    customClass: {
                        popup: 'rounded-2xl',
                        confirmButton: 'bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg'
                    }
                });
            }

            /**
             * Load work orders from backend
             */
            function loadWorkOrders() {
                google.script.run.withSuccessHandler(function (response) {

                    if (response.success) {

                    }
                }).getWorkOrders(100);
            }

            /**
             * Get work order details by ID
             */
            function loadWorkOrderDetails(workOrderId) {
                google.script.run.withSuccessHandler(function (response) {

                    if (response.success) {
                        populateFormWithData(response.workOrder, response.contractors, response.spareParts);
                    }
                }).getWorkOrderDetails(workOrderId);
            }

            /**
             * Department Selector Change Handler for Dashboard
             */
            $('#dashboardDepartmentSelector').change(function () {
                updateDashboardUI();
            });

            /**
             * Tab Navigation Handler
             */
            $('.tab-nav-btn').click(function (e) {
                e.preventDefault();
                const tabName = $(this).data('tab');

                // Update tab buttons
                $('.tab-nav-btn').removeClass('bg-gradient-to-r from-danger-500 to-danger-600 text-white shadow-md').addClass('text-gray-500 hover:text-gray-900');
                $(this).removeClass('text-gray-500 hover:text-gray-900').addClass('bg-gradient-to-r from-danger-500 to-danger-600 text-white shadow-md');

                // Hide all tab contents
                $('.tab-content-section').addClass('hidden');

                switch (tabName) {
                    case 'create-update':
                        $('#createUpdateTabContent').removeClass('hidden');
                        break;
                    case 'dashboard-me1':
                        $('#dashboardTabContent-ME1').removeClass('hidden');
                        $('#workOrderForm')[0].reset();
                        break;
                    case 'dashboard-me2':
                        $('#dashboardTabContent-ME2').removeClass('hidden');
                        $('#workOrderForm')[0].reset();
                        break;
                    case 'dashboard-me3':
                        $('#dashboardTabContent-ME3').removeClass('hidden');
                        $('#workOrderForm')[0].reset();
                        break;
                    default:
                        console.warn('Unknown tab:', tabName);
                }

                if (tabName.startsWith('dashboard-')) {
                    setTimeout(() => {
                        loadDashboardData();
                    }, 500);
                }
            });


            /**
             * Work Order Status Update Handler
             */
            $(document).on('click', '.status-btn', function () {
                const recordId = $(this).data('recordid');
                updateWorkOrder(recordId);
            });

            /**
             * Mobile Performance Optimizations
             */
            // Add passive event listeners for better scroll performance on mobile
            if (typeof window !== 'undefined') {
                const passiveSupported = (() => {
                    let passive = false;
                    try {
                        const options = {
                            get passive() {
                                passive = true;
                                return false;
                            }
                        };
                        window.addEventListener('test', null, options);
                        window.removeEventListener('test', null, options);
                    } catch (err) {
                        passive = false;
                    }
                    return passive;
                })();

                if (passiveSupported) {
                    // Add passive listeners for touch events to improve scroll performance
                    document.addEventListener('touchstart', function () { }, { passive: true });
                    document.addEventListener('touchmove', function () { }, { passive: true });
                    document.addEventListener('touchend', function () { }, { passive: true });
                    document.addEventListener('wheel', function () { }, { passive: true });
                }

                // Optimize scrolling on iOS devices
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    document.body.style.webkitOverflowScrolling = 'touch';
                }

                // Debounce resize events for better performance
                let resizeTimer;
                window.addEventListener('resize', function () {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(function () {
                        // Handle resize if needed
                    }, 250);
                }, { passive: true });
            }
        });

        /* ============================================================================
           DASHBOARD FUNCTIONS
           ============================================================================ */
        /**
         * Load dashboard data from backend
         */
        function loadDashboardData() {
            if (isLoadingDashboard) {
                return;
            }
            isLoadingDashboard = true;

            const $icons = $('.reload-icon');
            $icons.addClass('fa-spin')
            const department = $('#dashboardDepartmentSelector').val();

            google.script.run.withSuccessHandler(function (response) {
                isLoadingDashboard = false;
                Swal.close();
                // Parse response if it's a string
                response = JSON.parse(response);

                window.dashboardData = response.data // Store globally for debugging

                if (response.success) {

                    updateDashboardUI();
                    $icons.removeClass('fa-spin');
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: response.message || 'An error occurred while loading dashboard data',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'rounded-xl',
                            confirmButton: 'bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg'
                        }
                    });
                }
            }).getDashboardData(department);
        }

        /**
         * Update Dashboard UI with data
         */
        function updateDashboardUI(data) {
            data = data || window.dashboardData;

            // Use DocumentFragment for better performance with large DOM operations
            const fragment = document.createDocumentFragment();

            // Cache supervisor lookups for better performance
            const supervisorLookup = new Map(supervisorList.map(s => [String(s.userId), s]));

            data = data.map(item => {
                let sup_id = item.supervisor.userId;
                let supervisor = supervisorLookup.get(String(sup_id));
                let me = supervisor?.me || 'Unknown';
                let mainDuty = supervisor?.mainDuty || 'Unknown';
                let wo_count = data.filter(d => String(d.supervisor.userId) === String(sup_id)).length;
                let hasWorkOrder = wo_count > 0;
                item.supervisor = { ...item.supervisor, me: me, mainDuty: mainDuty, hasWorkOrder: hasWorkOrder, wo_count: wo_count };
                return item;
            });

            const meGrouped = Object.groupBy(data, (item) => item.supervisor.me || 'Unknown');

            [...new Set(supervisorList.map(s => s.me))].forEach(me => {
                if (!meGrouped[me]) {
                    meGrouped[me] = [];
                }
            });

            for (const me in meGrouped) {
                const meData = meGrouped[me];
                const $container = $('#dashboardTabContent-' + me.replace(/-/g, ''));
                $container.find('.department-name').text(me);

                // Calculate & Update Summary Stats
                const totalWorkOrders = meData.length;
                const totalQuantity = meData.reduce((sum, item) => {
                    const contractors = item.contractors || [];
                    const itemQuantity = contractors.reduce((cSum, c) => cSum + (parseInt(c.quantity) || 0), 0);
                    return sum + itemQuantity;
                }, 0);

                const contractorStats = calculateContractorStats(meData, me);
                populateContractorCapacity($container, contractorStats, me);
                const sectionGroups = Object.groupBy(meData, (item) => item.mainDuty || 'Other');
                populateSectionCards($container, meData, me);
                populateWorkOrdersTable($container, meData);
            }
        }

        /**
         * Calculate Contractor Statistics
         */
        function calculateContractorStats(data, me) {
            const stats = { external: { used: 0, capacity: 0 } };

            // Create a lookup map for faster access
            const contractorMap = new Map();
            contractorList
                .filter(c => c.me === me || c.me === 'All')
                .forEach(c => {
                    if (!contractorMap.has(c.contractor)) {
                        contractorMap.set(c.contractor, c);
                    }
                });

            // Process each contractor once
            contractorMap.forEach((contractorInfo, contractorName) => {

                const used = data.reduce((sum, item) => {
                    if (item.contractors?.length) {
                        const entry = item.contractors.find(c => c.contractor === contractorName);

                        return sum + (entry ? parseInt(entry.quantity) || 0 : 0);
                    }
                    return sum;
                }, 0);

                if (contractorInfo.type === 'external') {
                    stats.external.used += used;
                } else {
                    stats[contractorName] = {
                        used,
                        capacity: parseInt(contractorInfo.capacity) || 0
                    };
                }
            });

            return stats;
        }

        /**
         * Populate Contractor Capacity Table
         */
        function populateContractorCapacity($section, stats, me) {
            const $tbody = $section.find('.contractor-capacity-table-body');
            const contractorOfDepartment = supervisorList
                .filter(s => s.me === me)
                .flatMap(s => s.contractors)
                .filter((value, index, self) => self.indexOf(value) === index); // Unique contractors
            for (const contractorName of contractorOfDepartment) {
                if (!stats[contractorName]) {
                    stats[contractorName] = { used: 0, capacity: '-' };
                }
            }

            // Build all rows at once for better performance
            const internalRows = Object.keys(stats)
                .filter(contractorName => contractorName !== 'external' && contractorName !== '')
                .sort((a, b) => a.localeCompare(b))
                .map(contractorName => {
                    const contractorStats = stats[contractorName];
                    const used = parseInt(contractorStats.used) || 0;
                    const capacity = parseInt(contractorStats.capacity);
                    let utilization = 0;
                    let progressColor = 'bg-green-500';
                    let progressWidth = 0;

                    if (!isNaN(capacity) && capacity > 0) {
                        utilization = Math.round((used / capacity) * 100);
                        progressWidth = Math.min(utilization, 100);
                        if (utilization > 80) progressColor = 'bg-yellow-500';
                        if (utilization > 100) progressColor = 'bg-red-500';
                    }

                    return `<tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-2 py-2 text-xs font-medium text-gray-900 border-b border-gray-100">
                            ${contractorName}
                        </td>
                        <td class="px-2 py-2 text-xs text-center text-gray-600 font-semibold border-b border-gray-100">
                            ${used}
                        </td>
                        <td class="px-2 py-2 text-xs text-center text-gray-500 border-b border-gray-100">
                            ${isNaN(capacity) ? '-' : capacity}
                        </td>
                    </tr>`;
                }).join('');

            // External contractor row
            const externalUsed = stats.external ? (stats.external.used || 0) : 0;
            const externalRow = `<tr class="bg-gray-50/50">
                <td class="px-2 py-2 text-xs font-medium text-gray-700 border-b border-gray-100">
                    <span class="flex items-center"><i class="fas fa-external-link-alt text-[10px] mr-1 text-gray-400"></i> External</span>
                </td>
                <td class="px-2 py-2 text-xs text-center text-gray-700 font-bold border-b border-gray-100">
                    ${externalUsed}
                </td>
                <td class="px-2 py-2 text-xs text-center text-gray-400 border-b border-gray-100">-</td>
            </tr>`;

            // Single DOM update
            $tbody.html(internalRows + externalRow);
        }


        /**
         * Populate Section Cards
         */
        function populateSectionCards($section, data, me) {
            const $container = $section.find('.section-cards-container');
            const sectionGroups = Object.groupBy(data, (item) => item.supervisor.mainDuty || 'Other');
            const sectionNames = [...new Set(supervisorList.filter(s => s.me === me).map(s => s.mainDuty || 'Other'))];

            // Build all HTML at once using array join for better performance
            const cardsHTML = sectionNames.map(section => {
                const sectionData = sectionGroups[section] || [{ supervisor: {} }];
                const supervisorsInSection = supervisorList.filter(s => s.me === me && (s.mainDuty || 'Other') === section);

                let hasWorkSupervisor = [];
                let noWorkSupervisor = [];

                supervisorsInSection.forEach(supervisor => {
                    const supervisorName = supervisor.name;
                    const supervisorInfo = sectionData.find(item => String(item.supervisor.userId) === String(supervisor.userId))?.supervisor || { hasWorkOrder: false, wo_count: 0 };
                    const hasWorkOrder = supervisorInfo.hasWorkOrder || false;
                    const wo_count = supervisorInfo.wo_count || 0;

                    if (hasWorkOrder) {
                        hasWorkSupervisor.push({ name: supervisorName, count: wo_count });
                    } else {
                        noWorkSupervisor.push({ name: supervisorName });
                    }
                });

                const pillsHTML = [
                    ...hasWorkSupervisor
                        .sort((a, b) => b.count - a.count)
                        .map(sup => {
                            const countBadge = sup.count > 0 ?
                                `<span class="bg-green-700 text-white ml-1 px-1 py-0.5 rounded text-[10px] font-bold">${sup.count}</span>` : '';
                            return `<div class="bg-green-100 border border-green-300 text-green-800 px-2 py-1 rounded-lg text-xs font-medium flex items-center shadow-sm">
                                <span>${sup.name}</span>${countBadge}
                            </div>`;
                        }),
                    ...noWorkSupervisor
                        .sort((a, b) => a.name.localeCompare(b.name))
                        .map(sup =>
                            `<div class="bg-danger-400 border border-danger-200 text-white px-2 py-1 rounded-lg text-xs font-medium flex items-center shadow-sm">
                                <span>${sup.name}</span>
                            </div>`
                        )
                ].join('');

                return `<div class="bg-white rounded-lg border border-gray-200 p-3">
                    <h4 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">${section}</h4>
                    <div class="flex flex-wrap gap-1.5 section-pills-container">
                        ${pillsHTML}
                    </div>
                </div>`;
            }).join('');

            // Single DOM update
            $container.html(cardsHTML);
        }

        /**
         * Populate Work Orders Table
         */
        function populateWorkOrdersTable($section, data) {
            const $tbody = $section.find('.work-orders-table-body');

            if (data.length === 0) {
                $tbody.html(`
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No work orders found</p>
                        </td>
                    </tr>
                `);
                return;
            }

            const workOrders = data.sort((a, b) => {
                const dateA = a.workOrder.date ? moment(a.workOrder.date, 'DD/MM/YYYY').toDate() : new Date(0);
                const dateB = b.workOrder.date ? moment(b.workOrder.date, 'DD/MM/YYYY').toDate() : new Date(0);
                return dateB - dateA;
            });

            // Build all rows at once for better performance
            const rowsHTML = workOrders.map(item => {
                const contractors = item.contractors || [];
                const contractorNames = [...new Set(contractors.map(c => {
                    if (c.contractor.includes('อื่นๆ')) {
                        return c.customName || c.contractor;
                    }
                    return c.contractor;
                }))].join(', ');
                const totalQuantity = contractors.reduce((sum, c) => sum + (parseInt(c.quantity) || 0), 0);
                const workingTime = item.supervisor.startTime && item.supervisor.finishTime ?
                    `${moment(item.supervisor.startTime).format('HH:mm')} - ${moment(item.supervisor.finishTime).format('HH:mm')}` : '-';
                const status = item.status || 'Unknown';

                const statusConfig = {
                    completed: {
                        element: '<div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 cursor-pointer status-btn text-nowrap" data-recordId="' + item.recordId + '"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-check w-3 h-3" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>Completed</div>',
                        dot: '<div class="mt-1.5 w-2 h-2 rounded-full bg-green-500"></div>'
                    },
                    progress: {
                        element: '<div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 cursor-pointer status-btn text-nowrap" data-recordId="' + item.recordId + '"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock w-3 h-3" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>In Progress</div>',
                        dot: '<div class="mt-1.5 w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]"></div>'
                    },
                    cancelled: {
                        element: '<div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-danger-100 text-danger-700 cursor-pointer status-btn text-nowrap" data-recordId="' + item.recordId + '"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle w-3 h-3" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>Cancelled</div>',
                        dot: '<div class="mt-1.5 w-2 h-2 rounded-full bg-danger-500"></div>'
                    },
                    default: {
                        element: null,
                        dot: '<div class="mt-1.5 w-2 h-2 rounded-full bg-gray-400"></div>'
                    }
                };

                const statusLower = status.toLowerCase();
                const config = statusLower === 'completed' ? statusConfig.completed
                    : statusLower.includes('progress') ? statusConfig.progress
                        : statusLower === 'cancelled' ? statusConfig.cancelled
                            : statusConfig.default;

                const statusElement = config.element;
                const dotStatus = config.dot;


                return `<tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="px-4 py-3 font-bold text-green-800">
                        <div class="flex items-start gap-3 text-nowrap">
                            ${dotStatus}
                            <div><p class="font-bold text-slate-900">${item.supervisor?.name || '-'}</p></div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="font-mono font-bold px-2 py-1 rounded ${item.workOrder?.workOrderID ? 'text-slate-600 bg-slate-100 ' : 'text-danger-500 bg-danger-100'} cursor-pointer status-btn text-nowrap" data-recordId="${item.recordId}">${item.workOrder?.workOrderID || '<i class="fas fa-exclamation-triangle mr-1 font mono"></i> No ID'}</span>
                    </td>
                    <td class="px-4 py-3">${item.workOrder?.details || '-'}</td>
                    <td class="px-4 py-3">${contractorNames || '-'}</td>
                    <td class="px-4 py-3 text-center">${totalQuantity}</td>
                    <td class="px-4 py-3 text-center">${workingTime}</td>
                    <td class="px-4 py-3 text-center">
                        ${statusElement || `<span class="text-gray-500">Unknown</span>`}
                    </td>
                </tr>`;
            }).join('');

            // Single DOM update
            $tbody.html(rowsHTML);
        }

        /* ============================================================================
           WORK ORDER UPDATE & FORM POPULATION
           ============================================================================ */
        /**
         * Update Work Order - Populate form with existing data
         */
        function updateWorkOrder(recordId) {
            let wo_data = window.dashboardData.find(item => item.recordId === recordId);
            if (!wo_data) {
                Swal.fire({
                    title: 'Error!',
                    text: 'Work order data not found',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    customClass: {
                        popup: 'rounded-2xl',
                        confirmButton: 'bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg',
                        cancelButton: 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded-lg'
                    }
                });
                return;
            }
            populateFormWithData(wo_data);
        }

        /**
         * Populate form with existing work order data
         */
        async function populateFormWithData(wo_data) {
            console.log('Populating form with data:', wo_data);
            $('#createUpdateTab').click();
            await new Promise(resolve => setTimeout(resolve, 300)); // Wait for tab switch animation
            $('#recordId').val(wo_data.recordId || '');

            // Show status field when updating
            if (wo_data.recordId) {
                $('#statusFieldContainer').removeClass('hidden');
                $('#recordStatus').val(wo_data.status || 'pending');
                // Highlight required fields in update mode
                $('#supervisorFinishTime').addClass('required-update-field');
                $('#recordStatus').addClass('required-update-field');
            }

            // Populate supervisor details
            $('#supervisorUserId').val(wo_data.supervisor.userId || '');
            $('#supervisorName').val(wo_data.supervisor.name || '');
            $('#supervisorPlanDate').val(moment(wo_data.supervisor.planDate).format('YYYY-MM-DD') || '');
            $('#supervisorStartTime').val(moment(wo_data.supervisor.startTime).format('HH:mm') || '');
            $('#supervisorFinishTime').val(moment(wo_data.supervisor.finishTime).format('HH:mm') || '');
            $('#recordStatus').val(wo_data.status || 'in-progress');

            // Populate work order details
            $('#externalCost').val(wo_data.externalCost && wo_data.externalCost > 0 ? wo_data.externalCost : '');
            $('#workOrderID').val(wo_data.workOrder.workOrderID || '').trigger('keyup');
            $('#workOrderID').trigger('keyup');
            setTimeout(() => {
                $('#workOrderDetailsText').val(wo_data.workOrder.details || '');
            }, 100);

            // Clear and repopulate contractors
            $('.contractor-item').not(':first').remove();
            if (wo_data.contractors && wo_data.contractors.length > 0) {
                wo_data.contractors.forEach((contractor, index) => {
                    if (index === 0) {
                        // Populate first contractor
                        const $firstContractor = $('.contractor-item:first');
                        $firstContractor.find('.contractor-type').val(contractor.type || '').trigger('change');
                        setTimeout(() => {
                            $firstContractor.find('.contractor-select').val(contractor.contractor || '').trigger('change');
                            if (contractor.contractor === "อื่นๆ (กรอกเอง)") {
                                $firstContractor.find('.contractor-custom-name').val(contractor.customName || '').removeClass('hidden').attr('required', true);
                            }
                            $firstContractor.find('.contractor-quantity').val(contractor.quantity || '');
                        }, 100);
                    } else {
                        // Add additional contractors
                        $('#addMoreContractorBtn').click();
                        console.log('Adding contractor:', contractor);
                        const $newContractor = $('.contractor-item:last');
                        $newContractor.find('.contractor-type').val(contractor.type || '').trigger('change');
                        setTimeout(() => {
                            $newContractor.find('.contractor-select').val(contractor.contractor || '').trigger('change');
                            if (contractor.contractor === "อื่นๆ (กรอกเอง)") {

                                $newContractor.find('.contractor-custom-name').val(contractor.customName || '').removeClass('hidden').attr('required', true);
                            }
                            $newContractor.find('.contractor-quantity').val(contractor.quantity || '');
                        }, 100);
                    }
                });
            }
            // Clear and repopulate spare parts
            $('.material-item').not(':first').remove();
            if (wo_data.spareParts && wo_data.spareParts.length > 0) {
                wo_data.spareParts.forEach((part, index) => {
                    if (index === 0) {
                        // Populate first part
                        const $firstPart = $('.material-item:first');
                        $firstPart.find('.material-id').val(part.id || '');
                        $firstPart.find('.material-size').val(part.size || '');
                        $firstPart.find('.material-unit').val(part.unit || '');
                        $firstPart.find('.material-quantity').val(part.quantity || '');
                    } else {
                        // Add additional parts
                        $('#addMorePartsBtn').click();
                        const $newPart = $('.material-item:last');
                        $newPart.find('.material-id').val(part.id || '');
                        $newPart.find('.material-size').val(part.size || '');
                        $newPart.find('.material-unit').val(part.unit || '');
                        $newPart.find('.material-quantity').val(part.quantity || '');
                    }
                });
            }


        }
    </script>
</body>

</html>