<!DOCTYPE html>
<html lang="th">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Order File</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* SweetAlert2 Customizations */
        .swal2-popup {
            border-radius: 1.5rem !important;
            padding: 2rem !important;
        }

        .swal2-title {
            font-family: 'Noto Sans Thai', sans-serif !important;
            font-size: 1.5rem !important;
        }

        .swal2-html-container {
            font-family: 'Noto Sans Thai', sans-serif !important;
        }
    </style>

</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-8 px-4">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-file-upload text-indigo-600 mr-2"></i>
                จัดการไฟล์ Order
            </h1>
            <p class="text-gray-600">กรุณาเลือกร้านค้าและอัพโหลดไฟล์ของคุณ</p>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-4xl mx-auto">
            <form id="uploadForm" class="space-y-6">

                <!-- Store Dropdown -->
                <div class="form-group">
                    <label for="storeName" class="block text-sm font-semibold text-gray-700 mb-2">
                        ชื่อร้านค้า <span class="text-red-500">*</span>
                    </label>
                    <select id="storeName" name="storeName" required
                        class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none appearance-none bg-white cursor-pointer">
                        <option value="" selected disabled>-- เลือกร้านค้า --</option>
                        <option value="FRF">FRF</option>
                        <option value="BOKO">BOKO</option>
                    </select>
                </div>

                <!-- File Upload Areas - Grid Layout -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-cloud-upload-alt text-indigo-600 mr-2"></i>
                            อัพโหลดไฟล์
                        </h3>
                        <a href="https://docs.google.com/spreadsheets/d/1hadGQxdktpvdV_ROmdt3lKDaijeej7Q2f6D9eMKx_pA/edit"
                            target="_blank" rel="noopener noreferrer"
                            class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all">
                            <i class="fas fa-table mr-2"></i>
                            <span>เปิด Matcher Database</span>
                            <i class="fas fa-external-link-alt ml-2 text-xs"></i>
                        </a>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- Order File Upload -->
                        <div class="form-group">
                            <label class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                <span
                                    class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold mr-2">1</span>
                                ไฟล์ Order จากลูกค้า
                                <span class="text-red-500 ml-1">*</span>
                            </label>

                            <!-- Drag and Drop Zone -->
                            <div id="dropZone"
                                class="relative border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer transition-all duration-300 hover:border-indigo-500 hover:bg-gradient-to-br hover:from-indigo-50 hover:to-purple-50 hover:shadow-md group"
                                style="pointer-events: none; opacity: 0.5;" id="dropZone">

                                <input type="file" id="fileInput" name="file" class="hidden" disabled>

                                <div id="uploadPrompt" class="space-y-2">
                                    <!-- Upload Icon -->
                                    <div
                                        class="mx-auto w-16 h-16 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-file-excel text-3xl text-indigo-600"></i>
                                    </div>

                                    <div>
                                        <p class="text-sm font-semibold text-gray-700">
                                            ลากไฟล์มาวางที่นี่
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            หรือ <span class="text-indigo-600 font-semibold">คลิก</span> เพื่อเลือก
                                        </p>
                                    </div>

                                    <div class="flex items-center justify-center gap-1 text-xs text-gray-400 mt-2">
                                        <i class="fas fa-info-circle"></i>เฉพาะ
                                        <span id="accept-label" class="ml-1">XLSX, XLS, CSV, PDF, JPEG (สูงสุด
                                            10MB)</span>
                                    </div>
                                </div>

                                <!-- File Preview -->
                                <div id="filePreview" class="hidden animate-fadeIn">
                                    <div
                                        class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4">
                                        <div class="flex items-center space-x-3">
                                            <div class="flex-1 min-w-0 text-left">
                                                <p id="filesNameWrapper"
                                                    class="text-sm font-semibold text-gray-800 truncate">
                                                </p>
                                            </div>
                                            <!-- <button type="button" id="removeFile"
                                                class="flex-shrink-0 p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors">
                                                <i class="fas fa-times text-lg"></i>
                                            </button> -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Database File Upload -->
                        <div class="form-group">
                            <label class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                <span
                                    class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-purple-100 text-purple-600 text-xs font-bold mr-2">2</span>
                                List Database
                                <span class="text-red-500 ml-1">*</span>
                            </label>

                            <!-- Drag and Drop Zone -->
                            <div id="dropZoneDb"
                                class="relative border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer transition-all duration-300 hover:border-purple-500 hover:bg-gradient-to-br hover:from-purple-50 hover:to-pink-50 hover:shadow-md group"
                                style="pointer-events: none; opacity: 0.5;" id="dropZoneDb">

                                <input type="file" id="fileInputDb" name="fileDb" accept=".xlsx,.xls,.csv"
                                    class="hidden" disabled>

                                <div id="uploadPromptDb" class="space-y-2">
                                    <!-- Upload Icon -->
                                    <div
                                        class="mx-auto w-16 h-16 bg-gradient-to-br from-purple-100 to-pink-100 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-database text-3xl text-purple-600"></i>
                                    </div>

                                    <div>
                                        <p class="text-sm font-semibold text-gray-700">
                                            ลากไฟล์มาวางที่นี่
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            หรือ <span class="text-purple-600 font-semibold">คลิก</span> เพื่อเลือก
                                        </p>
                                    </div>

                                    <div class="flex items-center justify-center gap-1 text-xs text-gray-400 mt-2">
                                        <i class="fas fa-info-circle"></i>
                                        <span>XLSX, XLS, CSV (สูงสุด 10MB)</span>
                                    </div>
                                </div>

                                <!-- File Preview -->
                                <div id="filePreviewDb" class="hidden animate-fadeIn">
                                    <div
                                        class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4">
                                        <div class="flex items-center space-x-3">
                                            <!-- File Icon -->
                                            <div class="flex-shrink-0">
                                                <div
                                                    class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                                    <i class="fas fa-file-excel text-2xl text-green-600"></i>
                                                </div>
                                            </div>
                                            <div class="flex-1 min-w-0 text-left">
                                                <p id="fileNameDb" class="text-sm font-semibold text-gray-800 truncate">
                                                </p>
                                                <p id="fileSizeDb" class="text-xs text-gray-600 mt-0.5"></p>
                                            </div>
                                            <button type="button" id="removeFileDb"
                                                class="flex-shrink-0 p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors">
                                                <i class="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="pt-4">
                    <button type="submit"
                        class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold py-4 rounded-lg hover:from-indigo-600 hover:to-purple-700 transform hover:scale-[1.02] transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <span class="flex items-center justify-center space-x-2">
                            <i class="fas fa-upload"></i>
                            <span>อัพโหลดไฟล์</span>
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Info Box -->
        <div class="mt-6 bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg max-w-4xl mx-auto">
            <div class="flex">
                <i class="fas fa-info-circle text-blue-500 mr-3 text-lg"></i>
                <div class="text-sm text-blue-700">
                    <p class="font-semibold mb-1">คำแนะนำ:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>กรุณาเลือกร้านค้าก่อนอัพโหลดไฟล์</li>
                        <li>ตรวจสอบให้แน่ใจว่าไฟล์เป็นรูปแบบที่ถูกต้อง</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Table Preview Section -->
        <div id="tablePreviewSection" class="hidden mt-8">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-table text-indigo-600 mr-2"></i>
                        ตัวอย่างข้อมูล Transaction
                    </h2>
                    <button id="downloadBtn"
                        class="px-6 py-3 text-white font-semibold rounded-lg h transform hover:scale-105 transition-all shadow-lg hover:shadow-xl bg-green-700">
                        <i class="fas fa-download mr-2"></i>
                        ดาวน์โหลดไฟล์
                    </button>
                </div>

                <!-- Tab Navigation -->
                <div class="mb-6 border-b border-gray-200 overflow-x-auto">
                    <div id="tabNavigation" class="flex gap-1 -mb-px pb-2"
                        style="overflow-x: auto; scrollbar-width: thin; scrollbar-color: #6366f1 #e5e7eb;">
                        <!-- Tabs will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Tab Content Info -->
                <div id="tabInfo" class="mb-4 p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg">
                    <div class="flex items-center justify-between text-sm">
                        <span class="font-semibold text-gray-700">
                            สาขา: <span id="currentTabName" class="text-indigo-600">-</span>
                        </span>
                        <span class="text-gray-600">
                            <i class="fas fa-box mr-2"></i>
                            รายการสินค้า: <span id="currentItemCount" class="font-semibold">0</span> รายการ
                        </span>
                    </div>
                </div>

                <!-- Table Container with Scroll -->
                <div class="overflow-x-auto border rounded-lg">
                    <table id="tablePreview" class="min-w-full bg-white">
                        <!-- Table content will be dynamically inserted here -->
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden text-center py-12">
                    <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">ไม่มีข้อมูลในสาขานี้</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const acceptedFileTypes = {
            database: ['xlsx', 'xls', 'csv'],
            order: {
                frf: ['xlsx', 'xls', 'csv'],
                boko: ['pdf']
            }
        }
        const acceptMultipleFiles = {
            database: false,
            order: {
                frf: false,
                boko: true,
            }
        }
        const fileIcons = {
            xlsx: '<i class="fas fa-file-excel text-green-600"></i>',
            xls: '<i class="fas fa-file-excel text-green-600"></i>',
            csv: '<i class="fas fa-file-csv text-green-600"></i>',
            pdf: '<i class="fas fa-file-pdf text-red-600"></i>',
            jpg: '<i class="fas fa-file-image text-blue-600"></i>',
            jpeg: '<i class="fas fa-file-image text-blue-600"></i>',
            png: '<i class="fas fa-file-image text-blue-600"></i>'
        };

        let mainTableObject = null
        let mainProductMapErrors = null;
        let mainBranchMapErrors = null;

        // jQuery element references
        const $storeName = $('#storeName');
        const $dropZone = $('#dropZone');
        const $fileInput = $('#fileInput');
        const $acceptLabel = $('#accept-label');
        const $uploadPrompt = $('#uploadPrompt');
        const $filePreview = $('#filePreview');
        const $filesNameWrapper = $('#filesNameWrapper');
        const $fileSize = $('#fileSize');
        const $uploadForm = $('#uploadForm');

        // Database elements
        const $dropZoneDb = $('#dropZoneDb');
        const $fileInputDb = $('#fileInputDb');
        const $uploadPromptDb = $('#uploadPromptDb');
        const $filePreviewDb = $('#filePreviewDb');
        const $fileNameDb = $('#fileNameDb');
        const $fileSizeDb = $('#fileSizeDb');
        const $removeFileBtnDb = $('#removeFileDb');

        // Table preview elements
        const $tablePreviewSection = $('#tablePreviewSection');
        const $tablePreview = $('#tablePreview');
        const $tabNavigation = $('#tabNavigation');
        const $currentTabName = $('#currentTabName');
        const $currentItemCount = $('#currentItemCount');
        const $emptyState = $('#emptyState');
        const $downloadBtn = $('#downloadBtn');

        $(document).ready(function () {

            // Helper to enable/disable upload areas
            function setUploadEnabled(enabled) {
                if (enabled) {
                    $dropZone.css({ 'pointer-events': '', 'opacity': '' });
                    $fileInput.prop('disabled', false);
                    $dropZoneDb.css({ 'pointer-events': '', 'opacity': '' });
                    $fileInputDb.prop('disabled', false);
                } else {
                    $dropZone.css({ 'pointer-events': 'none', 'opacity': 0.5 });
                    $fileInput.prop('disabled', true);
                    $dropZoneDb.css({ 'pointer-events': 'none', 'opacity': 0.5 });
                    $fileInputDb.prop('disabled', true);
                }
            }
            // Initial state: disabled
            setUploadEnabled(false);

            // Prevent default drag behaviors
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            $storeName.on('change', function () {
                setUploadEnabled(!!$storeName.val());
                // Reset file inputs and previews when store changes
                $fileInput.val('').attr({
                    'multiple': acceptMultipleFiles.order[$('#storeName').val().toLowerCase()] ? true : false,
                    'accept': acceptedFileTypes.order[$('#storeName').val().toLowerCase()].map(ext => '.' + ext.toUpperCase()).join(',')
                });
                $acceptLabel.text(acceptedFileTypes.order[$('#storeName').val().toLowerCase()].map(ext => ext.toUpperCase()).join(', ') + ' (สูงสุด 10MB)');
                $uploadPrompt.removeClass('hidden');
                $filePreview.addClass('hidden');

                $uploadPromptDb.removeClass('hidden');
                $filePreviewDb.addClass('hidden');


            });

            $downloadBtn.on('click', function () {
                if (mainTableObject) {
                    downloadExcel(mainTableObject);
                }
            });

            // Setup drag and drop for Order file
            $dropZone.on('click', function (e) {
                // Prevent triggering if click came from the file input itself
                if (e.target !== $fileInput[0]) {
                    $fileInput[0].click(); // Use native click to avoid event bubbling
                }
            });

            $dropZone.on('dragenter dragover', function (e) {
                preventDefaults(e);
                $(this).addClass('border-indigo-500 bg-indigo-50 scale-105');
            });

            $dropZone.on('dragleave drop', function (e) {
                preventDefaults(e);
                $(this).removeClass('border-indigo-500 bg-indigo-50 scale-105');
            });

            $dropZone.on('drop', function (e) {
                const files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    $fileInput[0].files = files;
                    handleFiles(files);
                }
            });

            $fileInput.on('change', function (e) {
                handleFiles(e.target.files);
            });

            // Setup drag and drop for Database file
            $dropZoneDb.on('click', function (e) {
                // Prevent triggering if click came from the file input itself
                if (e.target !== $fileInputDb[0]) {
                    $fileInputDb[0].click(); // Use native click to avoid event bubbling
                }
            });

            $dropZoneDb.on('dragenter dragover', function (e) {
                preventDefaults(e);
                $(this).addClass('border-indigo-500 bg-indigo-50 scale-105');
            });

            $dropZoneDb.on('dragleave drop', function (e) {
                preventDefaults(e);
                $(this).removeClass('border-indigo-500 bg-indigo-50 scale-105');
            });

            $dropZoneDb.on('drop', function (e) {
                const files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    $fileInputDb[0].files = files;
                    handleFilesDb(files);
                }
            });

            $fileInputDb.on('change', function (e) {
                handleFilesDb(e.target.files);
            });

            // Prevent default drag on body
            $(document).on('dragenter dragover dragleave drop', function (e) {
                preventDefaults(e);
            });

            // Handle Order file upload
            let orderFileData = []
            function handleFiles(files) {
                if (files.length === 0) return;

                let notAcceptedFiles = [];
                let oversizedFiles = [];
                let processingFiles = [];
                const isMultiple = acceptMultipleFiles.order[$('#storeName').val().toLowerCase()];
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    if (!acceptedFileTypes.order[$('#storeName').val().toLowerCase()].includes(fileExtension)) {
                        notAcceptedFiles.push(file.name);
                    }
                    else if (file.size > 10 * 1024 * 1024) {
                        oversizedFiles.push(file.name + ` (${formatFileSize(file.size)})`);
                    } else {
                        processingFiles.push(file);
                    }
                }
                console.log(notAcceptedFiles);
                if (notAcceptedFiles.length > 0) {
                    Swal.fire({
                        iconHtml: '<i class="fas fa-times-circle"></i>',
                        title: 'ไฟล์ไม่ถูกต้อง',
                        html: `
                            <div class="text-left">
                                <div class="flex items-center mb-3">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl mr-3"></i>
                                    <span class="font-semibold text-red-700 text-lg">ไฟล์ไม่ถูกต้อง</span>
                                </div>
                                <div class="mb-2 text-gray-700">
                                    กรุณาอัพโหลดไฟล์ที่มีนามสกุล: 
                                    <span class="font-semibold text-indigo-600">
                                        ${acceptedFileTypes.order[$('#storeName').val().toLowerCase()].map(ext => ext.toUpperCase()).join(', ')}
                                    </span>
                                </div>
                                <div class="bg-red-50 border-l-4 border-red-400 p-3 rounded-lg text-sm text-red-700">
                                    <div class="font-semibold mb-1">ไฟล์ที่ไม่ถูกต้อง:</div>
                                    <ul class="list-disc list-inside">
                                        ${notAcceptedFiles.map(f => `<li>${f}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `,
                        confirmButtonColor: '#6366f1',
                        customClass: {
                            icon: 'text-xl border-none text-red-600'
                        }
                    });
                    $fileInput.val('');
                    return;
                }
                if (oversizedFiles.length > 0) {
                    Swal.fire({
                        iconHtml: '<i class="fas fa-times-circle"></i>',
                        title: 'ไฟล์ใหญ่เกินไป',
                        html: `
                            <div class="text-left">
                                <div class="flex items-center mb-3">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl mr-3"></i>
                                    <span class="font-semibold text-red-700 text-lg">ไฟล์ใหญ่เกินไป</span>
                                </div>
                                <div class="mb-2 text-gray-700">
                                    กรุณาอัพโหลดไฟล์ที่มีขนาดไม่เกิน 10MB
                                </div>
                                <div class="bg-red-50 border-l-4 border-red-400 p-3 rounded-lg text-sm text-red-700">
                                    <div class="font-semibold mb-1">ไฟล์ที่มีขนาดเกิน:</div>
                                    <ul class="list-disc list-inside">
                                        ${oversizedFiles.map(f => `<li>${f}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `,
                        confirmButtonColor: '#6366f1',
                        customClass: {
                            icon: 'text-xl border-none text-red-600'
                        }
                    });
                    $fileInput.val('');
                    return;
                }

                // Show file preview
                // Show preview for multiple files
                let names = [];
                let sizes = [];
                for (let i = 0; i < processingFiles.length; i++) {
                    names.push(processingFiles[i].name);
                    sizes.push(formatFileSize(processingFiles[i].size));
                }
                const truncateName = (name) => {
                    const maxLength = 30;
                    if (name.length <= maxLength) return name;
                    return name.slice(0, 15) + '...' + name.slice(-10);
                };
                $filesNameWrapper.html(names.map((name, index) =>
                    `<div class="flex items-center justify-between mb-1 hover:bg-gray-100 hover:text-red-600 hover:text-xlp-2 rounded-lg cursor-pointer">
                        ${fileIcons[name.split('.').pop().toLowerCase()] || '<i class="fas fa-file text-gray-600"></i>'}
                            <div class="">
                                <span class="truncate text-xs" title="${name}">
                                    ${truncateName(name)}
                                </span>
                                <span class="text-xs text-gray-600">(${sizes[index]})</span>
                            </div>
                            <i class="fas fa-times text-lg text-red-600 removeFileBtn hover:text-xl" data-index="${index}" title="ลบไฟล์ ${name}"></i>    
                        </div>`
                ).join(''));

                $('.removeFileBtn').on('click', function (e) {
                    e.stopPropagation();
                    console.log('remove clicked');
                    let index = $(this).data('index');
                    if (index !== undefined) {
                        console.log('index to remove:', index);
                        let dt = new DataTransfer();
                        let files = $fileInput[0].files;
                        for (let i = 0; i < files.length; i++) {
                            if (i !== index) {
                                dt.items.add(files[i]);
                            }
                        }
                        console.log('new files:', dt.files);
                        $fileInput[0].files = dt.files;
                        if ($fileInput[0].files.length > 0) {
                            handleFiles($fileInput[0].files);
                        } else {
                            $fileInput.val('');
                            $uploadPrompt.removeClass('hidden');
                            $filePreview.addClass('hidden');
                            $filesNameWrapper.html('');
                        }
                    } else {
                        $fileInput.val('');
                        $uploadPrompt.removeClass('hidden');
                        $filePreview.addClass('hidden');
                    }
                });
                $uploadPrompt.addClass('hidden');
                $filePreview.removeClass('hidden');

            }

            // Handle Database file upload
            function handleFilesDb(files) {
                if (files.length === 0) return;

                const file = files[0];
                const fileExtension = file.name.split('.').pop().toLowerCase();

                if (!acceptedFileTypes.database.includes(fileExtension)) {
                    Swal.fire({
                        iconHtml: '<i class="fas fa-times-circle"></i>',
                        title: 'ไฟล์ไม่ถูกต้อง',
                        text: 'กรุณาอัพโหลดไฟล์ XLSX, XLS หรือ CSV เท่านั้น',
                        confirmButtonColor: '#6366f1',
                        customClass: {
                            icon: 'text-xl border-none text-red-600'
                        }
                    });
                    $fileInputDb.val('');
                    return;
                }

                const maxSize = 10 * 1024 * 1024;
                if (file.size > maxSize) {
                    Swal.fire({
                        iconHtml: '<i class="fas fa-times-circle"></i>',
                        title: 'ไฟล์ใหญ่เกินไป',
                        text: 'กรุณาอัพโหลดไฟล์ที่มีขนาดไม่เกิน 10MB',
                        confirmButtonColor: '#6366f1',
                        customClass: {
                            icon: 'text-xl border-none text-red-600'
                        }
                    });
                    $fileInputDb.val('');
                    return;
                }

                // Show file preview
                $fileNameDb.text(file.name);
                $fileSizeDb.text(formatFileSize(file.size));
                $uploadPromptDb.addClass('hidden');
                $filePreviewDb.removeClass('hidden');
            }

            // Remove Database file
            $removeFileBtnDb.on('click', function (e) {
                e.stopPropagation();
                $fileInputDb.val('');
                $uploadPromptDb.removeClass('hidden');
                $filePreviewDb.addClass('hidden');
            });

            // Format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            }

            // Form submission
            $uploadForm.on('submit', async function (e) {
                e.preventDefault();
                const storeName = $('#storeName').val();
                if (!storeName) {
                    Swal.fire({
                        iconHtml: '<i class="fas fa-exclamation-triangle"></i>',
                        title: 'กรุณาเลือกร้านค้า',
                        text: 'โปรดเลือกร้านค้าก่อนอัพโหลดไฟล์',
                        confirmButtonColor: '#6366f1'
                    });
                    return;
                }

                if ($fileInput[0].files.length === 0) {
                    Swal.fire({
                        iconHtml: '<i class="fas fa-exclamation-triangle"></i>',
                        title: 'กรุณาเลือกไฟล์',
                        text: 'โปรดเลือกไฟล์ Order ที่ต้องการอัพโหลด',
                        confirmButtonColor: '#6366f1',
                        customClass: {
                            icon: 'text-xl border-none text-red-600'
                        }
                    });
                    return;
                }

                if ($fileInputDb[0].files.length === 0) {
                    Swal.fire({
                        iconHtml: '<i class="fas fa-exclamation-triangle"></i>',
                        title: 'กรุณาเลือกไฟล์',
                        text: 'โปรดเลือกไฟล์ List Database ที่ต้องการอัพโหลด',
                        confirmButtonColor: '#6366f1',
                        ciustomClass: {
                            icon: 'text-xl border-none text-red-600'
                        }
                    });
                    return;
                }

                // Read order file - check if Excel/CSV or other format
                let filesOrderData = [];
                for (let i = 0; i < $fileInput[0].files.length; i++) {
                    const orderFile = $fileInput[0].files[i];
                    const orderFileExt = orderFile.name.split('.').pop().toLowerCase();
                    const isOrderExcel = ['xlsx', 'xls', 'csv'].includes(orderFileExt);

                    if (isOrderExcel) {
                        // Read as Excel/CSV and parse to JSON array
                        filesOrderData.push({ isExcel: true, name: orderFile.name, data: await readFileAsJson(orderFile, orderFileExt) });
                    } else {
                        // Read as DataURL for other formats (PDF, JPEG, etc.)
                        filesOrderData.push({
                            isExcel: false,
                            name: orderFile.name,
                            data: await new Promise((resolve) => {
                                let fr = new FileReader();
                                fr.onload = function (e) {
                                    resolve(e.target.result);
                                };
                                fr.readAsDataURL(orderFile);
                            })
                        });
                    }
                }

                // Read database file - check if Excel/CSV
                const dbFile = $fileInputDb[0].files[0];
                const dbFileExt = dbFile.name.split('.').pop().toLowerCase();
                const isDbExcel = ['xlsx', 'xls', 'csv'].includes(dbFileExt);

                let fileDbData;
                fileDbData = await readFileAsJson(dbFile, dbFileExt, "list");

                // Show loading
                Swal.fire({
                    iconHtml: '<i class="fas fa-spinner fa-pulse"></i>',
                    title: 'กำลังดึงข้อมูล...',
                    html:
                        `
                    <div class="w-full bg-gray-200 rounded-full h-4 mb-4 animate-pulse-slow">
                        <div class="process-progress-bar bg-indigo-500 h-4 rounded-full" style="width: 0%; transition: width 0.5s;"></div>
                    </div>
                    <p class="text-gray-700 text-center text-sm mt-2">กำลังประมวลผลไฟล์ กรุณารอสักครู่...</p>
                    `,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    customClass: {
                        icon: 'text-xl border-none text-indigo-600'
                    }
                });

                // let { orderRows, dbRows } = await getOrderData(storeName, fileOrderData, fileDbData);
                var dbRows = fileDbData;
                var { orderRows } = await getOrderData(storeName, filesOrderData, dbRows);
                // if (isOrderExcel && isDbExcel) {
                //     var orderRows = fileOrderData;
                //     var dbRows = fileDbData;
                // } else {
                // }
                mainTableObject = null;
                Swal.fire({
                    iconHtml: '<i class="fas fa-table"></i>',
                    title: 'กำลังสร้างตัวอย่างข้อมูล...',
                    text: 'กรุณารอสักครู่',
                    confirmButtonColor: '#6366f1',
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        icon: 'text-xl border-none text-indigo-600'
                    }
                });
                let { tableObjects, productMapErrors, branchMapErrors } = await generateTransactionJSON(storeName, orderRows, dbRows);
                mainTableObject = tableObjects;
                mainProductMapErrors = productMapErrors;
                mainBranchMapErrors = branchMapErrors;
                console.log(tableObjects)
                showTablePreview();

            });
        });

        // Helper function to read Excel/CSV files as JSON array
        function readFileAsJson(file, fileExtension, tabName) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function (e) {
                    try {
                        if (fileExtension === 'csv') {
                            // Parse CSV
                            const text = e.target.result;
                            const rows = text.split('\n').map(row => {
                                // Handle CSV with quoted values that may contain commas
                                const regex = /(".*?"|[^",\s]+)(?=\s*,|\s*$)/g;
                                const matches = [];
                                let match;
                                while ((match = regex.exec(row)) !== null) {
                                    matches.push(match[1].replace(/^"|"$/g, ''));
                                }
                                return matches;
                            }).filter(row => row.length > 0);
                            resolve(rows);
                        } else {
                            // Parse Excel (xlsx, xls)
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            if (tabName) {
                                const worksheet = workbook.Sheets[tabName];
                                if (!worksheet) {
                                    Swal.fire({
                                        iconHtml: '<i class="fas fa-times-circle"></i>',
                                        title: 'เกิดข้อผิดพลาด',
                                        text: `ไม่พบแผ่นงานชื่อ "${tabName}" ในไฟล์ฐานข้อมูล`,
                                        confirmButtonColor: '#6366f1',
                                        customClass: {
                                            icon: 'text-xl border-none text-red-600',
                                        }
                                    })
                                    throw new Error(`ไม่พบแผ่นงานชื่อ "${tabName}" ในไฟล์ฐานข้อมูล`);
                                }
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                                resolve(jsonData);
                            } else {
                                const firstSheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[firstSheetName];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                                resolve(jsonData);
                            }
                        }
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = function (error) {
                    reject(error);
                };

                if (fileExtension === 'csv') {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        function getOrderData(storeName, filesOrderData, fileDbArray) {
            // return new Promise((resolve, reject) => {
            //     google.script.run.withSuccessHandler(function (response) {
            //         response = JSON.parse(response);
            //         Swal.close();
            //         Swal.fire({
            //             iconHtml: '<i class="fas fa-check-circle"></i>',
            //             title: 'อัพโหลดสำเร็จ',
            //             text: response,
            //             confirmButtonColor: '#6366f1',
            //             customClass: {
            //                 icon: 'text-xl border-none text-green-600'
            //             }
            //         });
            //         resolve(response);
            //         // Reset form
            //         // $uploadForm[0].reset();
            //         // $fileInput.val('');
            //         // $uploadPrompt.removeClass('hidden');
            //         // $filePreview.addClass('hidden');
            //         // $fileInputDb.val('');
            //         // $uploadPromptDb.removeClass('hidden');
            //         // $filePreviewDb.addClass('hidden');
            //     }).withFailureHandler(function (error) {
            //         Swal.close();
            //         Swal.fire({
            //             iconHtml: '<i class="fas fa-times-circle"></i>',
            //             title: 'เกิดข้อผิดพลาด',
            //             text: error.message,
            //             confirmButtonColor: '#6366f1',
            //             customClass: {
            //                 icon: 'text-xl border-none text-red-600'
            //             }
            //         });
            //         reject(error);
            //     }).processOrder({ storeName, fileOrderDataURL, fileDbDataURL });
            // });
            let files_length = filesOrderData.length;
            let success_count = 0;
            let percent_complete = 0;
            const updateProgress = (completed, total) => {
                percent_complete = (completed / total) * 100;
                // Update progress bar width
                document.querySelector('.process-progress-bar').style.width = percent_complete + '%';
            };
            // Helper to process chunks sequentially
            const processChunksSequentially = async (chunks) => {
                let combinedOrderRows = [];
                for (let chunkIndex = 0; chunkIndex < chunks.length; chunkIndex++) {
                    const chunk = chunks[chunkIndex];
                    const results = await Promise.all(
                        chunk.map(fileOrderData => {
                            if (fileOrderData.isExcel) {
                                updateProgress(++success_count, files_length);
                                return Promise.resolve({ orderRows: fileOrderData.data, dbRows: fileDbArray });
                            }
                            return new Promise((resolve, reject) => {
                                google.script.run.withSuccessHandler(function (response) {
                                    response = JSON.parse(response);
                                    updateProgress(++success_count, files_length);
                                    resolve(response);
                                }).withFailureHandler(function (error) {
                                    Swal.close();
                                    Swal.fire({
                                        iconHtml: '<i class="fas fa-times-circle"></i>',
                                        title: 'เกิดข้อผิดพลาด',
                                        text: error.message,
                                        confirmButtonColor: '#6366f1',
                                        customClass: {
                                            icon: 'text-xl border-none text-red-600'
                                        }
                                    });
                                    reject(error);
                                }).processOrder({ storeName, fileOrderDataURL: fileOrderData.data, fileDbArray, fileOrderName: fileOrderData.name });
                            });
                        })
                    );
                    results.forEach(result => {
                        combinedOrderRows = combinedOrderRows.concat(result.orderRows);
                    });
                }
                return { orderRows: combinedOrderRows };
            }

            // Chunk filesOrderData if needed
            const chunkSize = 15;
            let chunks = [];
            while (filesOrderData.length > 0) {
                chunks.push(filesOrderData.splice(0, chunkSize));
            }
            return processChunksSequentially(chunks);
        }

        function generateTransactionJSON(storeName, orderRows, dbRows) {
            return new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(function (json) {
                    resolve(JSON.parse(json));
                }).withFailureHandler(function (error) {
                    Swal.close();
                    Swal.fire({
                        iconHtml: '<i class="fas fa-times-circle"></i>',
                        title: 'เกิดข้อผิดพลาด',
                        text: error.message,
                        confirmButtonColor: '#6366f1',
                        customClass: {
                            icon: 'text-xl border-none text-red-600'
                        }
                    });
                    reject(error);
                }).generateTransactionJSON({ storeName, orderRows, dbRows });
            });
        }

        function generateTransactionFile(storeName, orderRows, dbRows) {
            console.log("🚀 ~ generateTransactionFile ~ orderRows:", orderRows)
            return new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(function (dataURL) {
                    Swal.close();
                    Swal.fire({
                        iconHtml: '<i class="fas fa-check-circle"></i>',
                        title: 'สร้างไฟล์สำเร็จ',
                        text: 'ไฟล์ Transaction ถูกสร้างเรียบร้อยแล้ว',
                        confirmButtonColor: '#6366f1',
                        customClass: {
                            icon: 'text-xl border-none text-green-600'
                        }
                    });
                    resolve(dataURL);
                }).withFailureHandler(function (error) {
                    Swal.close();
                    Swal.fire({
                        iconHtml: '<i class="fas fa-times-circle"></i>',
                        title: 'เกิดข้อผิดพลาด',
                        text: error.message,
                        confirmButtonColor: '#6366f1',
                        customClass: {
                            icon: 'text-xl border-none text-red-600'
                        }
                    });
                    reject(error);
                }).generateTransactionFile({ storeName, orderRows, dbRows });
            });
        }

        function showTablePreview() {
            if ((mainProductMapErrors && mainProductMapErrors.length > 0) || (mainBranchMapErrors && mainBranchMapErrors.length > 0)) {
                let errorHtml = '<div class="text-left space-y-4">';

                if (mainProductMapErrors && mainProductMapErrors.length > 0) {
                    errorHtml += `
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                            <div class="flex items-start">
                                <i class="fas fa-box-open text-red-500 mt-1 mr-3"></i>
                                <div class="flex-1">
                                    <p class="font-semibold text-red-800 mb-2">รายการสินค้าที่ไม่มีในฐานข้อมูล:</p>
                                    <ul class="list-disc list-inside text-sm text-red-700 space-y-1">
                                        ${mainProductMapErrors.map(error => `
                                            <li>${error}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (mainBranchMapErrors && mainBranchMapErrors.length > 0) {
                    errorHtml += `
                        <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r-lg">
                            <div class="flex items-start">
                                <i class="fas fa-box-open text-red-500 mt-1 mr-3"></i>
                                <div class="flex-1">
                                    <p class="font-semibold text-red-800 mb-2">รายการสาขาที่ไม่มีในฐานข้อมูล:</p>
                                    <ul class="list-disc list-inside text-sm text-red-700 space-y-1">
                                        ${mainBranchMapErrors.map(error => `
                                            <li>${error}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }

                errorHtml += '</div>';

                Swal.hideLoading()
                Swal.fire({
                    iconHtml: '<i class="fas fa-exclamation-triangle"></i>',
                    title: 'พบข้อผิดพลาดในการแมปข้อมูล',
                    html: `
                        <p class="text-gray-600 mb-4">กรุณาตรวจสอบข้อมูลต่อไปนี้:</p>
                        ${errorHtml}
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-1"></i>
                                ข้อมูลที่แสดงจะถูกแมปเป็น "UNKNOWN" ในไฟล์ผลลัพธ์
                            </p>
                        </div>
                    `,
                    width: '600px',
                    confirmButtonColor: '#6366f1',
                    confirmButtonText: '<i class="fas fa-check mr-2"></i>เข้าใจแล้ว',
                    customClass: {
                        icon: 'text-xl border-none text-yellow-500',
                        popup: 'rounded-2xl',
                        confirmButton: 'rounded-lg px-6 py-3 font-semibold'
                    },
                    didOpen: () => {
                        Swal.hideLoading()
                    }
                })
            } else {
                Swal.close()
            }
            // Clear previous content
            $tablePreview.empty();
            $tabNavigation.empty();

            if (!mainTableObject || !mainTableObject.tabs || mainTableObject.tabs.length === 0) {
                $tablePreviewSection.addClass('hidden');
                return;
            }

            // Create table header
            let thead = '<thead class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white sticky top-0"><tr>';
            mainTableObject.header.forEach(header => {
                thead += `<th class="px-4 py-3 text-left font-semibold">${header}</th>`;
            });
            thead += '</tr></thead>';
            $tablePreview.append(thead);
            mainTableObject.tabs.sort((a, b) => {
                const nameA = a.tabName.toUpperCase();
                const nameB = b.tabName.toUpperCase();
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            })
            // Create tabs
            mainTableObject.tabs.forEach((tab, index) => {
                const itemCount = tab.rows.length;
                const tabBtn = $(`
                    <button class="tab-btn px-4 py-2 font-semibold rounded-t-lg transition-all whitespace-nowrap flex-shrink-0 ${index === 0 ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'} ${itemCount === 0 ? 'hidden' : ''}" 
                            data-tab-index="${index}">
                        ${tab.tabName}
                        <span class="ml-2 px-2 py-0.5 text-xs rounded-full ${index === 0 ? 'bg-white text-indigo-600' : 'bg-gray-300 text-gray-700'}">
                            ${itemCount}
                        </span>
                    </button>
                `);

                tabBtn.on('click', function () {
                    const tabIndex = $(this).data('tab-index');
                    switchTab(tabIndex);
                });

                $tabNavigation.append(tabBtn);
            });

            // Show first tab by default
            switchTab(0);

            // Show table preview section
            $tablePreviewSection.removeClass('hidden');

            // Scroll to table preview
            setTimeout(() => {
                $tablePreviewSection[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 200);
        }

        function switchTab(tabIndex) {
            if (!mainTableObject || !mainTableObject.tabs[tabIndex]) return;

            const currentTab = mainTableObject.tabs[tabIndex];

            // Update active tab styling
            $('.tab-btn').each(function () {
                const $btn = $(this);
                const btnIndex = $btn.data('tab-index');
                const itemCount = mainTableObject.tabs[btnIndex].rows.length;

                if (btnIndex === tabIndex) {
                    $btn.removeClass('bg-gray-100 text-gray-600 hover:bg-gray-200')
                        .addClass('bg-indigo-600 text-white');
                    $btn.find('span').removeClass('bg-gray-300 text-gray-700')
                        .addClass('bg-white text-indigo-600');
                } else {
                    $btn.removeClass('bg-indigo-600 text-white')
                        .addClass('bg-gray-100 text-gray-600 hover:bg-gray-200');
                    $btn.find('span').removeClass('bg-white text-indigo-600')
                        .addClass('bg-gray-300 text-gray-700');
                }
            });

            // Update tab info
            $currentTabName.text(currentTab.tabName);
            $currentItemCount.text(currentTab.rows.length);

            // Remove existing tbody
            $tablePreview.find('tbody').remove();

            // Create table body with current tab's data
            if (currentTab.rows.length === 0) {
                $tablePreview.addClass('hidden');
                $emptyState.removeClass('hidden');
            } else {
                $tablePreview.removeClass('hidden');
                $emptyState.addClass('hidden');

                let tbody = '<tbody>';
                currentTab.rows.forEach((row, rowIndex) => {
                    tbody += `<tr class="${rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-indigo-50 transition-colors">`;
                    row.forEach(cell => {
                        tbody += `<td class="px-4 py-3 border-b border-gray-200 text-sm text-gray-700">${cell == "null" ? "" : (cell || '')}</td>`;
                    });
                    tbody += '</tr>';
                });
                tbody += '</tbody>';
                $tablePreview.append(tbody);
            }
        }

        function downloadExcel(tableObject) {
            if (!tableObject || !tableObject.tabs || tableObject.tabs.length === 0) {
                Swal.fire({
                    iconHtml: '<i class="fas fa-exclamation-triangle"></i>',
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลสำหรับดาวน์โหลด',
                    confirmButtonColor: '#6366f1',
                    customClass: {
                        icon: 'text-xl border-none text-yellow-500'
                    }
                });
                return;
            }

            try {
                // Show loading
                Swal.fire({
                    iconHtml: '<i class="fas fa-spinner fa-pulse"></i>',
                    title: 'กำลังสร้างไฟล์...',
                    text: 'กรุณารอสักครู่',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    customClass: {
                        icon: 'text-xl border-none text-indigo-600'
                    }
                });

                // Create a new workbook
                const workbook = XLSX.utils.book_new();

                // Process each tab
                tableObject.tabs.filter(tab => tab.rows.length > 0).forEach(tab => {
                    // Skip empty tabs if desired, or include them
                    const worksheetData = [];

                    // Add header row
                    worksheetData.push(tableObject.header);

                    // Add data rows
                    tab.rows.forEach(row => {
                        console.log("🚀 ~ file: upload.html:2493 ~ tab.rows.forEach ~ row:", row)
                        // Replace null values with empty strings
                        const cleanedRow = row.map(cell => cell === null || cell === "null" ? "" : cell);
                        worksheetData.push(cleanedRow);
                    });

                    // Create worksheet from data
                    const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

                    // Set column widths for better readability
                    const columnWidths = tableObject.header.map(() => ({ wch: 20 }));
                    worksheet['!cols'] = columnWidths;

                    // Sanitize sheet name (Excel has restrictions on sheet names)
                    let sheetName = tab.tabName.toString()
                        .replace(/[:\\/?*\[\]]/g, '-') // Replace invalid characters
                        .substring(0, 31); // Excel sheet names max 31 characters

                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                });

                // Generate Excel file
                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                // Create download link
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;

                // Generate filename with timestamp
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                const storeName = ($('#storeName').val() || 'Store').toUpperCase()
                link.download = `Transaction_${storeName}_${timestamp}.xlsx`;

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                // Show success message
                Swal.fire({
                    iconHtml: '<i class="fas fa-check-circle"></i>',
                    title: 'ดาวน์โหลดสำเร็จ',
                    text: 'ไฟล์ Excel ถูกดาวน์โหลดเรียบร้อยแล้ว',
                    confirmButtonColor: '#6366f1',
                    timer: 2000,
                    customClass: {
                        icon: 'text-xl border-none text-green-600'
                    }
                });

            } catch (error) {
                console.error('Error generating Excel:', error);
                Swal.fire({
                    iconHtml: '<i class="fas fa-times-circle"></i>',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถสร้างไฟล์ Excel ได้',
                    confirmButtonColor: '#6366f1',
                    customClass: {
                        icon: 'text-xl border-none text-red-600'
                    }
                });
            }
        }
    </script>

</body>

</html>