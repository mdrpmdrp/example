<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.23.2/dist/bootstrap-table.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link
        href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/all.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/sharp-regular.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/sharp-solid.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/sharp-light.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.6.0/css/sharp-thin.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link href="https://cdn.jsdelivr.net/npm/tree-multiselect@2.5.0/dist/jquery.tree-multiselect.min.css"
        rel="stylesheet">
    <style>
        :root {
            --prompt: 'Prompt', sans-serif;
            --light: #FFF;
            --grey: #F6F6F6;
            --blue: #5d87ff;
            --light-blue: #eef3ff;
            --red: #DB504A;
            --orange: #FF6600;
            --dark-grey: #AAAAAA;
            --green: #21dd21;
            --darkback: #FFF;
            --yellow: #FFB22B;
            --box1: #3c8cf3;
            --box2: #06d79c;
            --box3: #745af2;
            --box4: #ef5350;
            --shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--prompt);
        }

        body {
            font-family: var(--prompt);
            font-weight: 400;
            background: var(--grey);
        }

        .menu-container {
            width: 100%;
            border-radius: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .menu-item.active {
            background-color: #d4bf9c;
            color: #005f3b;
            font-size: 18px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .input-group {
            margin-bottom: 15px;
        }

        textarea {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            box-sizing: border-box;
        }

        button {
            background: #00B900;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #009900;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        #loadingSpinner {
            display: none;
            margin-left: 10px;
        }

        .menu-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid #eaeaea;
            text-decoration: none;
            color: #d4bf9c;
            background-color: var(--light);
            transition: background-color 0.3s;
        }

        .menu-item:hover {
            cursor: pointer;
            transform: scale(1.03);
        }

        .menu-item img {
            margin-right: 10px;
            width: 30px;
            height: 30px;
        }

        .title-package {
            overflow: hidden;
            height: 44px;
        }

        .btn-custom {
            background-color: #c2a472;
            color: #FFF;
        }

        .btn-custom:hover {
            background-color: #005f3b;
            color: #c2a472;
        }

        .text-green {
            color: #c2a472;
        }

        .btn-move {
            width: 100px;
        }

        .toast-container {
            right: 20px;
            bottom: 20px;
            z-index: 4000;
        }

        .toast-onload.hide {
            opacity: 0;
        }

        .toast-onload.show {
            opacity: 1;
        }

        .toast-onload h5 {
            font-size: 0.875rem;
        }

        .toast-onload h6 {
            font-size: 0.75rem;
            font-weight: 400;
        }

        .bg-green {
            background-color: #06d79c !important;
        }

        .bg-red {
            background-color: #ef5350 !important;
        }

        .bg-violet {
            background-color: #745af2 !important;
        }

        .bg-yellow {
            background-color: #FFB22B !important;
        }

        .bg-blue {
            background-color: #3c8cf3 !important;
        }

        .burger-menu {
            display: none;
            flex-direction: column;
            cursor: pointer;
        }

        .bar {
            width: 25px;
            height: 3px;
            background-color: #359381;
            margin: 3px 0;
            transition: 0.4s;
        }

        .btn-pagination {
            width: 40px;
        }

        .modal {
            backdrop-filter: blur(2px);
        }

        .badge-custom {
            font-size: 12px;
            border-radius: 4px;
            display: inline-block;
            line-height: 1.3;
            margin-right: 3px;
            padding: 0 8px;
            transition: all .2s ease-in-out;
            background-color: #e0e0e0;
        }

        @media screen and (max-width: 768px) {
            ::-webkit-scrollbar {
                display: none;
            }

            .menu-list {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 80px;
                left: 0;
                width: 100%;
                background-color: white;
                padding: 10px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                z-index: 9999;
            }

            .menu-list.show {
                display: flex;
            }

            .burger-menu {
                display: flex;
            }
        }

        .header .login-header a,
        .header .login-header .w-login-header,
        .flex-center,
        .title-list a,
        .title-list a i,
        .category .promotion-cat a.active:before,
        .doctor-list .doctor-wrap li a .button-reserve,
        .box-doctor .btn-xl .btn-detail,
        .header-service aside,
        .header-service .btn-detail,
        .btn-share,
        .page,
        .page>a,
        .page ul a {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page {
            margin-top: 30px;
        }

        .page>a {
            border-radius: 100%;
            width: 35px;
            height: 35px;
            text-decoration: none;
            color: #005f3b;
            cursor: pointer;
        }

        .page>a.active {
            background: #e5d2b2;
            color: #005f3b;
            text-decoration: none;
        }

        .page ul {
            display: flex;
            margin-left: 5px;
            border-radius: .8em;
            overflow: hidden;
        }

        .page ul a {
            background: #eaeaea;
            color: #acacac;
            padding: 10px 15px;
            text-decoration: none;
            cursor: pointer;
        }

        .page ul a.active {
            background: #005f3b;
            color: #fff;
        }

        .page li {
            margin-bottom: 0 !important;
            list-style: none;
        }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
    <div class="container-fluid p-3">
        <div class="row" id="packagepage1">
            <div class="col-sm-3">
                <div class="burger-menu">
                    <div class="bar rounded-pill"></div>
                    <div class="bar rounded-pill"></div>
                    <div class="bar rounded-pill"></div>
                </div>
                <div class="menu-container">
                    <ul class="menu-list" id="menu-list-package">
                        <li>
                            <a class="menu-item active"><img
                                    src="https://www.samitivejchonburi.com/html/images/icon-cat-02.png">
                                แพ็กเกจทั้งหมด</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-9">
                <div class="container-fluid px-4 py-0">
                    <h2 class="mb-4 fw-semibold" style="color: #005f3b" id="head-list-package">แพ็กเกจทั้งหมด</h2>
                    <div class="d-flex justify-content-between mb-4">
                        <h5 style="color: #005f3b">
                            <span id="count-list-package">
                                <!-- loader -->
                                <div class="spinner-border spinner-border-sm text-dark" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span style="font-weight:300;">กำลังโหลดแพ็กเกจ...</span>
                            </span>
                        </h5>
                        <button class="btn btn-custom rounded-4 btm-sm px-3 d-none" data-bs-toggle="modal"
                            data-bs-target="#questionnaireModal"><i class="fa-solid fa-heart fa-beat"
                                style="color: #ca2f2f;"></i> เลือกแพ็กเกจโดนใจ</button>
                    </div>
                    <div class="page mt-4 text-center paginationControls"></div>
                    <div id="insertPackage" class="row row-cols-1 row-cols-md-4 g-3 mt-2"></div>
                    <!-- <div id="paginationControls" class="mt-4 text-center">
                        <button class="btn btn-outline-secondary me-2" disabled="">Previous</button>
                        <button class="btn btn-pagination btn-primary me-2">1</button>
                        <button class="btn btn-pagination btn-outline-secondary me-2">2</button>
                        <button class="btn btn-outline-secondary">Next</button>
                    </div> -->
                    <div class="page mt-4 text-center paginationControls"></div>
                </div>
            </div>
        </div>
        <div aria-live="polite" aria-atomic="true" class="position-relative">
            <div id="toast-container" class="toast-container position-fixed"></div>
        </div>
    </div>
    <div class="modal fade" id="questionnaireModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-dialog-centered" style="max-width:550px">
            <div class="modal-content" style="border-radius: 35px;">
                <div class="modal-body p-0">
                    <div class="position-relative w-100">
                        <div class="position-absolute" style="bottom: -30px; right: 15">
                            <i class="fa-solid fa-circle-xmark fa-xl" style="color: #db1f1f;" role="button"
                                data-bs-dismiss="modal"></i>
                        </div>
                    </div>
                    <div class="p-4">
                        <h4 class="text-center text-green mb-3 fw-medium">สำรวจความต้องการของท่าน</h4>
                        <div class="progress my-3" style="height: 15px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 20%;" aria-valuenow="20" aria-valuemin="0"
                                aria-valuemax="100"></div>
                        </div>
                        <div id="insertQuestion">
                            <!-- Question will be inserted here -->
                        </div>
                        <div class="text-center mt-4">
                            <button id="prevBtn" class="btn btn-secondary rounded-4 me-2 btn-move" onclick="prevStep()"
                                style="display: none;">ย้อนกลับ</button>
                            <button id="nextBtn" class="btn btn-primary rounded-4 btn-move"
                                onclick="nextStep()">ถัดไป</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="packagesModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        aria-labelledby="packagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="border-radius: 20px;">
                <div class="modal-header">
                    <h5 class="modal-title text-center text-green mb-3 fw-medium" id="packagesModalLabel">
                        แพ็กเกจที่เหมาะกับคุณ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="packagesContent"></div>
                    <div class="row justify-content-center">
                        <div class="col-md-4">
                            <button id="sendPackagesBtn" class="w-100 rounded-3"
                                onclick="sendPackages()">สอบถามรายละเอียด</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        $(document).ready(function () {
            // liff.init({ liffId: '1655873446-MpmBPPzl' })
            setUpAPIKeyAndFetchData();
            liff.ready.then(async () => {
                if (liff.isLoggedIn()) {
                    let isFriend = await liff.getFriendship()
                    if (!isFriend.friendFlag) {
                        Swal.fire({
                            icon: 'error',
                            title: 'ยังไม่เพิ่มเพื่อน',
                            html: 'กรุณาเพิ่มเพื่อนกับ Line Official Account ก่อนใช้งาน' +
                                '<br><br><a id="addfriend-btn"><img src="https://scdn.line-apps.com/n/line_add_friends/btn/th.png" alt="เพิ่มเพื่อน" height="36" border="0"></a>',
                            showConfirmButton: false,
                            allowOutsideClick: false,
                            willOpen: () => {
                                $('#registerForm, #infoCard').addClass('d-none')
                                $('body').removeClass('d-none')
                                $('#addfriend-btn').click(() => {
                                    location.href = 'https://lin.ee/NxCf8qd'
                                })
                            }
                        })
                        return
                    }
                    setUpAPIKeyAndFetchData();
                } else {
                    liff.login({
                        redirectUri: window.location.href
                    });
                }
            });
            $('#questionnaireModal').on('hidden.bs.modal', function (e) {
                currentStep = 0;
                userAnswers = [];
                renderQuestion(currentStep, false);
            });
        });
    </script>
    <script>
        let questions = [];
        const fetchQuestionsFromAPI = (sheet) => {
            return $.getJSON(scriptURL, {
                opt: 'questions', sheet
            }, function (data) {
                questions = data.questions;
                return questions;
            }).fail(function (error) {
                toastAlert(0, 'เกิดข้อผิดพลาดในการดึงข้อมูล');
                console.error('Error fetching data:', error);
            });
        };
        let userAnswers = [];
        let filter_packages_final = [];
        let currentStep = 0;
        function renderQuestion(step, will_show = true) {
            const questionDiv = $("#insertQuestion");
            questionDiv.empty();
            const questionText = $("<h5></h5>").text(questions[step].question);
            questionDiv.append(questionText);
            let opts = questions[step].options;
            if (step == 2) {
                let filter_packages = allData.filter(package =>
                    package[9].split(',').map(x => x.trim()).includes(userAnswers[0][0]) &&
                    package[10].split(',').map(x => x.trim()).some(x => userAnswers[1].includes(x))
                );
                if (filter_packages.length == 1) {
                    userAnswers[2] = filter_packages[0][11].split(',').map(x => x.trim());
                    userAnswers[3] = filter_packages[0][12].split(',').map(x => x.trim());
                    filter_packages_final = filter_packages;
                    showPackages();
                    return;
                }
                opts = [...new Set(filter_packages.map(package => package[11].split(',').map(x => x.trim())).flat())];
            } else if (step == 3) {
                let filter_packages = allData.filter(package =>
                    package[9].split(',').map(x => x.trim()).includes(userAnswers[0][0]) &&
                    package[10].split(',').map(x => x.trim()).some(x => userAnswers[1].includes(x)) &&
                    package[11].split(',').map(x => x.trim()).some(tag => userAnswers[2].includes(tag))
                );
                if (filter_packages.length == 1) {
                    userAnswers[3] = filter_packages[0][12].split(',').map(x => x.trim());
                    filter_packages_final = filter_packages2;
                    showPackages();
                    return;
                }
                filter_packages_final = filter_packages;
                opts = [...new Set(filter_packages.map(package => package[12].split(',').map(x => x.trim())).flat())];
            }
            if (opts.length < 1) {
                questionDiv.append('ยังไม่มีแพคเกจที่ตรงกับคุณ');
                $("#nextBtn").hide()
            } else {
                opts.forEach((option, index) => {
                    const optionLabel = $("<label></label>").addClass("form-check-label").attr("role", "button");
                    const optionInput = $("<input>").attr({
                        type: questions[step].type,
                        name: `question${step}`,
                        class: "form-check-input",
                        value: option
                    });
                    optionLabel.append(optionInput).append(option);
                    const optionDiv = $("<div></div>").addClass("form-check my-2").append(optionLabel);
                    questionDiv.append(optionDiv);
                });
                $("#nextBtn").show()
            }
            $("#prevBtn").toggle(step !== 0);
            $("#nextBtn").text(step === questions.length - 1 ? "ส่งคำตอบ" : "ถัดไป");
            updateProgressBar(step);
            if (userAnswers[step] !== undefined) {
                userAnswers[step].forEach(selectedOption => {
                    $(`input[name="question${step}"][value="${selectedOption}"]`).prop("checked", true);
                });
            }
            if (will_show) {
                $('#questionnaireModal').modal('show');
            }
        }
        function nextStep() {
            const selectedOptions = Array.from(document.querySelectorAll(`input[name="question${currentStep}"]:checked`))
                .map(checkbox => checkbox.value);
            if (selectedOptions.length === 0) {
                toastAlert(0, "กรุณาเลือกคำตอบก่อนที่จะไปยังขั้นตอนถัดไป");
                return;
            }
            userAnswers[currentStep] = [...new Set(selectedOptions)];
            if (currentStep < questions.length - 1) {
                currentStep++;
                renderQuestion(currentStep);
            } else {
                saveAnswers();
                showPackages();
            }
        }
        function showPackages() {
            // toastAlert(1, "แบบสอบถามของคุณได้ส่งแล้ว!");
            let filter_packages = filter_packages_final.filter(package => {
                return package[12].split(',').map(x => x.trim()).some(tag => {
                    return userAnswers[3].includes(tag);
                });
            });
            showPackagesModal(filter_packages)
            $('#questionnaireModal').modal('hide');
        }
        function saveAnswers() {
            const answers = {}
            userAnswers.forEach((answerSet, i) => {
                answers[questions[i].question] = answerSet;
            });
            $.post(scriptURL, {
                opt: 'saveAnswers',
                answers: JSON.stringify(answers)
            }, function (data) {
            }).fail(function (error) {
                console.error('Error saving answers:', error);
            });
        }
        function selectPackages(userAnswers, allData) {
            let selectedData = [...allData];
            const mainAnswers = userAnswers[0];
            const genderAnswers = userAnswers[1];
            const ageAnswers = userAnswers[2];
            const scoredPackages = [];
            allData.forEach(row => {
                let score = 0;
                let isMainMatched = false;
                mainAnswers.forEach(mainAnswer => {
                    row.forEach(tag => {
                        if (tag.toString().includes(mainAnswer) && matchGender(genderAnswers, row) && matchAge(ageAnswers, row)) {
                            isMainMatched = true;
                            score++;
                        }
                    });
                });
                if (isMainMatched) {
                    userAnswers.slice(3).forEach((answerSet, i) => {
                        if (i === 4) {
                            let price = parseFloat(row[5].toString().replace(/,/g, ''));
                            let select_price = answerSet[0]
                            if (select_price.includes('ไม่เกิน')) {
                                if (price < parseInt(select_price.replace('ไม่เกิน', '').replace('บาท', '').replace(/,/g, '').trim())) {
                                    score++;
                                }
                            } else if (select_price.includes('-')) {
                                let min = parseInt(select_price.split('-')[0].replace('บาท', '').replace(/,/g, '').trim());
                                let max = parseInt(select_price.split('-')[1].replace('บาท', '').replace(/,/g, '').trim());
                                if (price >= min && price <= max) {
                                    score++;
                                }
                            } else if (select_price.includes('มากกว่า') || select_price.includes('ชึ้นไป')) {
                                if (price >= parseInt(select_price.replace('มากกว่า', '').replace('ชึ้นไป', '').replace('บาท', '').replace(/,/g, '').trim())) {
                                    score++;
                                }
                            } else {
                                if (price == parseInt(select_price.replace('บาท', '').replace(/,/g, '').trim())) {
                                    score++;
                                }
                            }
                        }
                        answerSet.forEach(answer => {
                            row.forEach(tag => {
                                if (tag.toString().includes('และ')) {
                                    const tags = tag.toString().split('และ');
                                    tags.forEach(tag => {
                                        if (tag.toString().includes(answer)) {
                                            score++;
                                        }
                                    });
                                } else if (tag.toString().includes(answer)) {
                                    score++;
                                }
                            });
                        });
                    });
                    scoredPackages.push({ row, score });
                }
            });
            scoredPackages
                .filter(a => a.score > 0)
                .sort((a, b) => b.score - a.score);
            return scoredPackages;
        };
        function matchGender(genderAnswers, row) {
            let sel_gender = genderAnswers[0].split(/และ|หรือ/).map(g => g.trim());
            if (sel_gender.length == 1) {
                return sel_gender == row[9];
            } else {
                return sel_gender.some(g => row[9].includes(g));
            }
        }
        function matchAge(ageAnswers, row) {
            let sel_age = ageAnswers[0]
            return row[10] == sel_age;
        }
        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderQuestion(currentStep);
            }
        };
        function updateProgressBar(step) {
            const progress = ((step + 1) / questions.length) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
        };
        function sendPackages() {
            let current_carousel = $('#packagesContent').find('.carousel-item.active');
            if (current_carousel.length == 0) {
                $('#packagesModal').modal('hide');
                currentStep = 0;
                userAnswers = []
                $('#questionnaireModal').modal('show');
                renderQuestion(currentStep);
                return
            }
            const { cid, cname, pid, pname, normal_price, discount_price, unit, poster, url } = current_carousel.data();
            let message = `สนใจแพ็กเกจ:
${pname} (${pid})
หมวดหมู่: ${cname} (${cid})
ราคาปกติ: ${isNaN(normal_price) ? normal_price : (parseFloat(normal_price).toLocaleString() + ' บาท/ ' + unit)}
ราคาพิเศษ: ${parseFloat(discount_price).toLocaleString()} บาท/ ${unit}
รายละเอียด:
${url}`;
            let image = {
                type: "image",
                originalContentUrl: poster,
                previewImageUrl: poster
            }
            let messages = [
                image,
                {
                    type: "text",
                    text: message
                }
            ]
            toastAlert(3, 'กำลังส่งข้อมูลให้เจ้าหน้าที่');
            Promise.all([
                new Promise((resolve, reject) => {
                    if (liff.isInClient()) {
                        liff.sendMessages(messages).then(() => {
                            // toastAlert(1, 'ส่งข้อมูลแพ็กเกจใหเแอดมินเรียบร้อยแล้ว กรุณารอการติดต่อกลับจากเจ้าหน้าที่');
                            resolve();
                        }).catch((error) => {
                            // console.error('Error sending message:', error);
                            // toastAlert(0, 'เกิดข้อผิดพลาดในการส่งข้อมูล');
                            reject();
                        });
                    } else {
                        $.post(scriptURL, {
                            opt: 'sendLineMessage',
                            messages: JSON.stringify(messages),
                            uid: liff.getDecodedIDToken().sub
                        }, function (data) {
                            // 
                            // toastAlert(1, 'ส่งข้อมูลแพ็กเกจใหเแอดมินเรียบร้อยแล้ว กรุณารอการติดต่อกลับจากเจ้าหน้าที่');
                            resolve();
                        }).fail(function (error) {
                            console.error('Error sending message:', error);
                            // toastAlert(0, 'เกิดข้อผิดพลาดในการส่งข้อมูล');
                            reject();
                        });
                    }
                }),
                new Promise((resolve, reject) => {
                    let messages2 = [
                        messages[0],
                        {
                            type: "text",
                            text: 'ลูกค้า ' + liff.getDecodedIDToken().name + ' ' + messages[1].text
                        }
                    ]
                    $.post(scriptURL, {
                        opt: 'sendLineToAdmin',
                        messages: JSON.stringify(messages2),
                    }, function (data) {
                        resolve();
                    }).fail(function (error) {
                        console.error('Error saving packages:', error);
                        reject();
                    });
                })
            ])
                .then(() => {
                    toastAlert(1, 'ส่งข้อมูลแพ็กเกจเรียบร้อยแล้ว กรุณารอการติดต่อกลับจากเจ้าหน้าที่');
                    let alreadySent = sessionStorage.getItem('alreadySentPackages');
                    if (!alreadySent) {
                        sessionStorage.setItem('alreadySentPackages', JSON.stringify([pid]));
                    } else {
                        let sentPackages = JSON.parse(alreadySent);
                        sentPackages.push(pid);
                        sessionStorage.setItem('alreadySentPackages', JSON.stringify(sentPackages));
                    }
                })
                .catch(() => {
                    toastAlert(0, 'เกิดข้อผิดพลาดในการส่งข้อมูล');
                })
        };
    </script>
    <script>
        let allData = null;
        let allCategory = null;
        let previousData = null;
        let previousSelectData = null;
        let apiKey = null;
        let idsheet = null;
        let currentPage = 1;
        const itemsPerPage = 8;
        const fetchDataFromAPI = (sheet) => {
            return $.getJSON(scriptURL, {
                opt: 'data', sheet
            }).fail(function (error) {
                toastAlert(0, 'เกิดข้อผิดพลาดในการดึงข้อมูล');
                console.error('Error fetching data:', error);
            }).done(function (data) {
                allData = data.data.filter((row) => row[0] != '');
                return allData;
            });
        };
        const fetchSelectFromAPI = (sheet) => {
            return $.getJSON(scriptURL, {
                opt: 'data', sheet
            }, function (data) {
                allCategory = data.data.filter((row) => row[0] != '');
                return allCategory;
            }).fail(function (error) {
                toastAlert(0, 'เกิดข้อผิดพลาดในการดึงข้อมูล');
                console.error('Error fetching category data:', error);
            });
        };
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyPuEYaxymY63BUD_svH74Vm3q3_B-9PL_PeJPlDH1MAGrR64NVzJxGyZ1q3YazdeA/exec'
        const setUpAPIKeyAndFetchData = () => {
            fetchQuestionsFromAPI('Questions').then(function () {
                renderQuestion(currentStep);
            });
            fetchDataFromAPI('Packages').then((newData) => {
                if (!isEqual(previousData, newData)) {
                    previousData = newData;
                    insertPackageData();
                }
            });
            fetchSelectFromAPI('Category').then((newSelectData) => {
                if (!isEqual(previousSelectData, newSelectData)) {
                    previousSelectData = newSelectData;
                    insertPackagefilter();
                }
            });
        };
        const isEqual = (data1, data2) => {
            return JSON.stringify(data1) === JSON.stringify(data2);
        };
        document.addEventListener('DOMContentLoaded', () => {
            const burgerMenu = document.querySelector('.burger-menu');
            const navLinks = document.querySelector('.menu-list');
            burgerMenu.addEventListener('click', () => {
                navLinks.classList.toggle('show');
            });
        });
        const insertPackagefilter = () => {
            const dataContainer = document.getElementById('menu-list-package');
            dataContainer.innerHTML = "";
            var li = document.createElement("li");
            li.innerHTML = `
    <a class="menu-item active" data-cid="0" data-name="แพ็กเกจทั้งหมด"><img src="https://www.samitivejchonburi.com/html/images/icon-cat-02.png"> แพ็กเกจทั้งหมด</a>`;
            dataContainer.appendChild(li);
            if (allCategory.length === 0) {
                var noDataText = document.createElement("p");
                noDataText.innerHTML = '<i class="fa-solid fa-circle-info"></i> ไม่พบข้อมูล !';
                noDataText.className = "fw-medium text-danger fs-4 text-center p-5";
                dataContainer.appendChild(noDataText);
                return;
            }
            allCategory.forEach(function (item) {
                const li = $("<li></li>");
                const a = $("<a></a>").addClass("menu-item").attr({
                    'data-cid': item[0],
                    'data-name': item[1],
                    'data-url': item[2]
                }).html(`<img src="https://www.samitivejchonburi.com/html/images/icon-cat-02.png"> ${item[1]}`);
                li.append(a);
                $("#menu-list-package").append(li);
            });
            $('.menu-item').on('click', function (event) {
                event.preventDefault();
                $('.menu-item').removeClass('active');
                $(this).addClass('active');
                const text = $(this).data('name');
                $('#head-list-package').text(text);
                currentPage = 1;
                insertPackageData();
                $('.menu-list').removeClass('show');
            });
        }
        let packageDataAll;
        const insertPackageData = () => {
            const dataContainer = document.getElementById('insertPackage');
            dataContainer.innerHTML = "";
            if (!allData) return;
            packageDataAll = allData
            let filter;
            if ($('#head-list-package').text().trim() === "แพ็กเกจทั้งหมด") {
                filter = "แสดงทั้งหมด";
            } else {
                filter = $('#head-list-package').text().trim();
            }
            const filteredData = filter === "แสดงทั้งหมด"
                ? packageDataAll
                : packageDataAll.filter((row) => row[1] === filter);
            $('#count-list-package').text(filteredData.length + ' แพ็กเกจ');
            if (filteredData.length === 0) {
                const noDataText = document.createElement("p");
                noDataText.innerHTML = '';
                noDataText.className = "fw-bold text-danger fs-4 text-center p-5";
                $('.paginationControls').hide();
                dataContainer.appendChild(noDataText);
                return;
            }
            $('.paginationControls').show();
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);
            paginatedData.forEach((item) => {
                const col = $("<div></div>").addClass("col").css("cursor", "pointer");
                col.html(`
        <div class="card h-100 rounded-4 overflow-hidden shadow card-package" data-cid="${item[0]}" data-cname="${item[1]}" data-pid="${item[2]}" data-pname="${item[3]}" data-normal_price="${item[4]}" data-discount_price="${item[5]}" data-unit="${item[6]}" data-poster="${item[7]}" data-url="${item[8]}" data-gender="${item[9]}" data-age="${item[10]}" data-organ="${item[11]}" data-tool="${item[12]}" data-special="${item[13]}">
            <div class="ratio ratio-1x1">
                <img src="${item[7]}" class="w-100 h-100 object-fit-cover mb-2" style="object-position: top;">
            </div>
            <div class="p-3">
                <h5 class="mb-3 title-package" style="color: #0d7574; font-size: 18px;">${item[3]}</h5>
                <h4 style="color: #b99b6a"><span>${parseInt(item[5]).toLocaleString()}</span> <span style="color: #000; font-size:20px; font-weight: 400;">/${item[6]}</span></h4>
                <h6 style="color: #9f9f9f; font-size:14px; font-weight: 300;">${isNaN(item[4]) ? item[4] : ("ราคาปกติ <span class='text-decoration-line-through'>" + parseInt(item[5]).toLocaleString() + ' บาท</span>')}</h6>
            </div>
        </div>
    `);
                $("#insertPackage").append(col);
            });
            $('.card-package').off('click').on('click', function () {
                const { cid, cname, pid, pname, normal_price, discount_price, unit, poster, url, gender, age, organ, tool, special } = $(this).data();
                showPackagesModal([[cid, cname, pid, pname, normal_price, discount_price, unit, poster, url, gender, age, organ, tool, special]]);
            })
            renderPagination(filteredData.length);
            $('button[data-bs-target="#questionnaireModal"]').removeClass('d-none');
        };
        const renderPagination = (totalItems) => {
            // const paginationContainer = document.getElementById('paginationControls');
            // paginationContainer.innerHTML = "";
            // const totalPages = Math.ceil(totalItems / itemsPerPage);
            // const prevButton = document.createElement('button');
            // prevButton.className = 'btn btn-outline-secondary me-2';
            // prevButton.disabled = currentPage === 1;
            // prevButton.textContent = 'Previous';
            // prevButton.onclick = () => {
            //     if (currentPage > 1) {
            //         currentPage--;
            //         insertPackageData();
            //     }
            // };
            // paginationContainer.appendChild(prevButton);
            // for (let i = 1; i <= totalPages; i++) {
            //     const pageButton = document.createElement('button');
            //     pageButton.className = `btn btn-pagination ${currentPage === i ? 'btn-primary' : 'btn-outline-secondary'} me-2`;
            //     pageButton.textContent = i;
            //     pageButton.onclick = () => {
            //         currentPage = i;
            //         insertPackageData();
            //     };
            //     paginationContainer.appendChild(pageButton);
            // }
            // const nextButton = document.createElement('button');
            // nextButton.className = 'btn btn-outline-secondary';
            // nextButton.disabled = currentPage === totalPages;
            // nextButton.textContent = 'Next';
            // nextButton.onclick = () => {
            //     if (currentPage < totalPages) {
            //         currentPage++;
            //         insertPackageData();
            //         scrollToTop();
            //     }
            // };
            // paginationContainer.appendChild(nextButton);
            let pagination = $(".paginationControls");
            pagination.html("");
            // <div class="page mt-4 text-center id="paginationControls">
            //         <a class="active">1</a>
            //         <a>2</a>
            //         <a>3</a>
            //         <ul class="mb-0">
            //             <li>
            //                 <a>
            //                     <i class="fa fa-caret-left me-2"></i>ก่อนหน้า</a>
            //             </li>
            //             <li>
            //                 <a class="active">ต่อไป
            //                     <i class="fa fa-caret-right ms-2"></i></a>
            //             </li>
            //         </ul>
            //     </div>
            let totalPages = Math.ceil(totalItems / itemsPerPage);
            let prevButton = $("<a></a>")
                .attr('href', '#')
                .append($("<i class='fa fa-caret-left me-2'></i>")).append("ก่อนหน้า")
                .click(() => {
                    if (currentPage > 1) {
                        currentPage--;
                        insertPackageData();
                        $('html, body').animate({
                            scrollTop: 0
                        }, 0);
                    }
                });
            let nextButton = $("<a></a>")
                .attr('href', '#')
                .append("ต่อไป").append($("<i class='fa fa-caret-right ms-2'></i>"))
                .click(() => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        insertPackageData();
                        $('html, body').animate({
                            scrollTop: 0
                        }, 0);
                    }
                });
            if (currentPage == 1) {
                nextButton.addClass("active");
                prevButton.removeClass("active");
            } else if (currentPage > 1 && currentPage < totalPages) {
                prevButton.addClass("active");
                nextButton.addClass("active");
            } else if (currentPage == totalPages) {
                prevButton.addClass("active");
                nextButton.removeClass("active");
            }
            let ul = $("<ul class='mb-0'></ul>");
            for (let i = 1; i <= totalPages; i++) {
                let page = $("<a></a>")
                    .attr('href', '#')
                    .text(i).addClass('pe-auto');
                if (i === currentPage) {
                    page.addClass("active");
                }
                page.click(() => {
                    currentPage = i;
                    insertPackageData();
                    $('html, body').animate({
                        scrollTop: 0
                    }, 0);
                });
                pagination.append(page);
            }
            ul
                .append($('<li></li>').addClass('page-prev').append(prevButton))
                .append($('<li></li>').addClass('page-next').append(nextButton));
            pagination.append(ul);
        };
        const scrollToTop = () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        };
        const toastAlert = (type, text, delay = 3000) => {
            const toast = document.createElement('div');
            toast.className = 'toast toast-onload align-items-center border-0 rounded-4 shadow-lg fade show';
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.setAttribute('data-bs-delay', delay);
            let textStatus = "";
            let iconStatus = "";
            let bgColorClass = "";
            switch (type) {
                case 1:
                    textStatus = "<i class='fa-duotone fa-thumbs-up'></i> สำเร็จ";
                    iconStatus = "https://cdn.lordicon.com/oqdmuxru.json";
                    bgColorClass = "bg-green";
                    break;
                case 0:
                    textStatus = "<i class='fa-duotone fa-triangle-exclamation'></i> ผิดพลาด";
                    iconStatus = "https://cdn.lordicon.com/vihyezfv.json";
                    bgColorClass = "bg-red";
                    break;
                case 2:
                    textStatus = "<i class='fa-duotone fa-cloud-question'></i> รายละเอียด";
                    iconStatus = "https://cdn.lordicon.com/axteoudt.json";
                    bgColorClass = "bg-violet";
                    break;
                case 3:
                    textStatus = "<i class='fa-duotone fa-bell'></i> แจ้งเตือน";
                    iconStatus = "https://cdn.lordicon.com/vspbqszr.json";
                    bgColorClass = "bg-yellow";
                    break;
                default:
                    textStatus = "<i class='fa-duotone fa-bullhorn'></i> ประกาศ";
                    iconStatus = "https://cdn.lordicon.com/lecprnjb.json";
                    bgColorClass = "bg-blue";
            }
            toast.classList.add(bgColorClass);
            toast.innerHTML = `
    <div class="toast-body d-flex align-items-center">
        <lord-icon
            src="${iconStatus}"
            trigger="loop"
            state="morph-check-in-1"
            colors="primary:#ffffff"
            style="width:50px;height:50px;margin-right:10px;">
        </lord-icon>
        <div>
            <h5 class="text-white mb-1">${textStatus}</h5>
            <h6 class="text-white mb-0">${text}</h6>
        </div>
        <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
`;
            document.getElementById('toast-container').appendChild(toast);
            const bootstrapToast = new bootstrap.Toast(toast);
            bootstrapToast.show();
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        };
        function showPackagesModal(recommendedPackages) {
            const packagesContent = document.getElementById("packagesContent");
            packagesContent.innerHTML = "";
            let carouselIndicators = "";
            let carouselItems = "";
            if (recommendedPackages.length === 0) {
                $(packagesContent).html('<p class="text-center">ยังไม่พบแพ็กเกจที่เหมาะกับคุณ</p> <p class="text-center">กรุณาลองเลือกคำตอบใหม่อีกครั้ง</p>');
                $('#packagesModal').modal('show');
                $('#sendPackagesBtn').text('ลองเลือกคำตอบใหม่').removeClass('btn-primary').addClass('btn-danger');
                return;
            }
            recommendedPackages.forEach((row, index) => {
                console.log(row);
                let Duration = [];
                let item7Text = row[7];
                let item7Array = item7Text.split(", ");
                item7Array.forEach((word) => {
                    let trimmedWord = word.trim();
                    Duration.push(
                        `<span class="p-1 badge-custom rounded-2">${trimmedWord}</span>`
                    );
                });
                let durationHTML = Duration.join("");
                // Add carousel indicator
                carouselIndicators += `
        <button type="button" data-bs-target="#packagesCarousel" data-bs-slide-to="${index}" class="${index === 0 ? "active" : ""}" aria-current="${index === 0 ? "true" : ""}" aria-label="Slide ${index + 1}"></button>
    `;
                // Add carousel item
                carouselItems += `
        <div class="carousel-item ${index === 0 ? "active" : ""}" data-bs-interval="5000" data-bs-ride="carousel" data-cid="${row[0]}" data-cname="${row[1]}" data-pid="${row[2]}" data-pname="${row[3]}" data-normal_price="${row[4]}" data-discount_price="${row[5]}" data-unit="${row[6]}" data-poster="${row[7]}" data-url="${row[8]}">
            <div class="card mb-3 rounded-4 overflow-hidden">
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="${row[7]}" class="img-fluid rounded-start" alt="${row[3]}">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h5 class="card-title">${row[3]}</h5>
                            <p class="card-text"><strong>Gender:</strong> ${row[9]}</p>
                            <p class="card-text"><strong>Category:</strong> ${row[1]}</p>
                            <p class="card-text"><strong>Price:</strong> ${isNaN(row[4]) ? row[4] : (parseInt(row[4]).toLocaleString() + ' บาท')}</p>   
                            <p class="card-text"><strong>Discount:</strong> ${parseInt(row[5]).toLocaleString()} บาท</p>\
                            ${row[8] == '' ? '' : ` <p class="card-text w-100 text-center"><strong><a href="${row[8]}" target="_blank" class="text-decoration-none">รายละเอียดเพิ่มเติม</a></strong></p>`}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
            });
            const carouselHTML = `
    <div id="packagesCarousel" class="carousel carousel-dark slide" data-bs-ride="carousel">
        <div class="carousel-indicators">
            ${carouselIndicators}
        </div>
        <div class="carousel-inner">
            ${carouselItems}
        </div>
        ${carouselItems.length > 1 ? `<button class="carousel-control-prev" type="button" data-bs-target="#packagesCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#packagesCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>` : ''}
    </div>
`;
            packagesContent.innerHTML = carouselHTML;
            $('#packagesModal').modal('show');
            setTimeout(() => {
                $('#packagesCarousel').carousel({
                    interval: 5000
                });
                $('#packagesCarousel').on('slid.bs.carousel', function (e) {
                    const thisItem = $(e.relatedTarget);
                    sessionStorage.setItem('currentItem', JSON.stringify(thisItem.data()));
                    let alreadySentPackages = sessionStorage.getItem('alreadySentPackages');
                    if (alreadySentPackages) {
                        let sentPackages = JSON.parse(alreadySentPackages);
                        if (sentPackages.includes(thisItem.data('pid'))) {
                            $('#sendPackagesBtn').prop('disabled', true).text('ส่งข้อมูลแพ็กเกจเรียบร้อยแล้ว กรุณารอการติดต่อกลับจากเจ้าหน้าที่').removeClass('btn-primary').addClass('btn-secondary');
                        } else {
                            $('#sendPackagesBtn').prop('disabled', false).text('สอบถามรายละเอียด').removeClass('btn-secondary').addClass('btn-primary');
                        }
                    }
                });
            }, 1000);
            userAnswers = [];
            currentStep = 0;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>