<!DOCTYPE html>
<html lang="th">

<head>
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>พอร์ทัลธนาคารครอบครัว</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@200;300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/v/bs5/dt-2.3.1/date-1.5.5/fh-4.0.2/r-3.0.4/datatables.min.css"
        rel="stylesheet" integrity="sha384-LfbfDVLN0/59QW2jVDnjC/2vimtfSwUhBUjeFnwmOdxm+Z8apU/mW/C/p+mBzMDn"
        crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            font-family: 'Mitr', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Additional styles */
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-university me-2"></i>พอร์ทัลธนาคารครอบครัว</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#"><i class="fas fa-tachometer-alt me-1"></i>แดชบอร์ด</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal"><i class="fas fa-sign-in-alt me-1"></i>เข้าสู่ระบบ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#registerModal"><i class="fas fa-user-plus me-1"></i>ลงทะเบียน</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Child Selector -->
        <section class="mb-4" data-aos="fade-down">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label for="childSelector" class="form-label">ดูบัญชีสำหรับ:</label>
                    <select id="childSelector" class="form-select">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
        </section>

        <!-- Dashboard Header -->
        <header class="dashboard-header" data-aos="fade-down" data-aos-delay="100">
            <h1><i class="fas fa-users me-2"></i>แดชบอร์ดครอบครัว</h1>
            <p>จัดการบัญชีธนาคารโรงเรียนของบุตรหลาน</p>
        </header>

        <!-- Dashboard Cards -->
        <section class="dashboard-cards" data-aos="zoom-in-right">
            <div class="card">
                <div class="card-body">
                    <div class="card-icon icon-balance"><i class="fas fa-wallet"></i></div>
                    <div>
                        <h5 class="card-title">ยอดเงินปัจจุบัน</h5>
                        <p class="card-text" id="currentBalance">฿0.00</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="card-icon icon-deposit"><i class="fas fa-arrow-down"></i></div>
                    <div>
                        <h5 class="card-title">เงินฝากทั้งหมด</h5>
                        <p class="card-text" id="totalDeposits">฿0.00</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="card-icon icon-withdrawal"><i class="fa-solid fa-arrow-up"></i></div>
                    <div>
                        <h5 class="card-title">การถอนทั้งหมด</h5>
                        <p class="card-text" id="totalWithdrawals">฿0.00</p>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="card-icon icon-students"><i class="fas fa-users"></i></div>
                    <div>
                        <h5 class="card-title">จำนวนบุตรหลาน</h5>
                        <p class="card-text" id="activeChildren">0</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Transaction History Table -->
        <section class="transaction-table-container mt-5" data-aos="zoom-in-right">
            <h2><i class="fas fa-history me-2"></i>ประวัติการทำธุรกรรม</h2>
            <form id="dateFilterForm" class="row g-3 mb-3 align-items-end">
                <div class="col-md-4">
                    <label for="startDate" class="form-label">วันที่เริ่มต้น:</label>
                    <input type="date" id="startDate" class="form-control">
                </div>
                <div class="col-md-4">
                    <label for="endDate" class="form-label">วันที่สิ้นสุด:</label>
                    <input type="date" id="endDate" class="form-control">
                </div>
                <div class="col-md-2">
                    <button type="button" id="filterBtn" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i>กรอง</button>
                </div>
                 <div class="col-md-2">
                    <button type="button" id="resetFilterBtn" class="btn btn-secondary w-100"><i class="fas fa-undo me-1"></i>รีเซ็ต</button>
                </div>
            </form>
            <div class="table-responsive">
                <table id="transactionTable" class="table table-striped table-bordered table-hover" width="100%">
                    <thead>
                        <tr>
                            <th>วันที่</th>
                            <th>บุตรหลาน</th>
                            <th>รายละเอียด</th>
                            <th>ประเภท</th>
                            <th>จำนวนเงิน (฿)</th>
                            <th>ยอดคงเหลือ (฿)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sample Data (dynamically populated) -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel"><i class="fas fa-sign-in-alt me-2"></i>เข้าสู่ระบบธนาคารโรงเรียน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">ชื่อผู้ใช้/รหัสนักเรียน</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">รหัสผ่าน</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-paper-plane me-1"></i>เข้าสู่ระบบ</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <p class="text-muted me-auto">ยังไม่มีบัญชี? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal" data-bs-dismiss="modal">ลงทะเบียนที่นี่</a></p>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel"><i class="fas fa-user-plus me-2"></i>ลงทะเบียนธนาคารโรงเรียน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerFullName" class="form-label">ชื่อ-นามสกุลเต็ม</label>
                            <input type="text" class="form-control" id="registerFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerStudentID" class="form-label">รหัสนักเรียน</label>
                            <input type="text" class="form-control" id="registerStudentID" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">รหัสผ่าน</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerConfirmPassword" class="form-label">ยืนยันรหัสผ่าน</label>
                            <input type="password" class="form-control" id="registerConfirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-check-circle me-1"></i>ลงทะเบียน</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <p class="text-muted me-auto">มีบัญชีอยู่แล้ว? <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">เข้าสู่ระบบที่นี่</a></p>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2568 ระบบธนาคารโรงเรียน สงวนลิขสิทธิ์</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/locale/th.js"></script>
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.datatables.net/v/bs5/dt-2.3.1/date-1.5.5/fh-4.0.2/r-3.0.4/datatables.min.js"
        integrity="sha384-FJ7itb/lT4Gi2fUN6KcJK1uMlpyPlcPeRBgX9/3Q+Q1z+3BvjcXaxIuVgpMFike/"
        crossorigin="anonymous"></script>

    <script>
        AOS.init(); // Initialize Animate On Scroll
        NProgress.configure({ showSpinner: false }); // Configure NProgress (optional)
        moment.locale('th'); // Set moment locale to Thai

        document.addEventListener("DOMContentLoaded", function () {
            NProgress.start();

            // --- Family and Transaction Data ---
            const familyAccount = {
                children: [
                    { name: "อเล็กซ์ มิลเลอร์", id: "alex" },
                    { name: "เบลล่า มิลเลอร์", id: "bella" },
                    { name: "ชาร์ลี มิลเลอร์", id: "charlie" }
                ],
                transactions: [
                    // Alex's Transactions
                    { childName: "อเล็กซ์ มิลเลอร์", date: "2025-05-01", description: "Pocket Money", type: "เงินฝาก", amount: 500, balance: 500 },
                    { childName: "อเล็กซ์ มิลเลอร์", date: "2025-05-03", description: "Book Purchase", type: "การถอน", amount: 150, balance: 350 },
                    { childName: "อเล็กซ์ มิลเลอร์", date: "2025-05-10", description: "Canteen Top-up", type: "เงินฝาก", amount: 200, balance: 550 },
                    { childName: "อเล็กซ์ มิลเลอร์", date: "2025-05-15", description: "School Trip Fee", type: "การถอน", amount: 300, balance: 250 },
                    
                    // Bella's Transactions
                    { childName: "เบลล่า มิลเลอร์", date: "2025-05-02", description: "Initial Deposit", type: "เงินฝาก", amount: 1000, balance: 1000 },
                    { childName: "เบลล่า มิลเลอร์", date: "2025-05-05", description: "Art Supplies", type: "การถอน", amount: 250, balance: 750 },
                    { childName: "เบลล่า มิลเลอร์", date: "2025-05-12", description: "Savings Goal", type: "เงินฝาก", amount: 100, balance: 850 },
                    { childName: "เบลล่า มิลเลอร์", date: "2025-05-20", description: "Lunch Money", type: "การถอน", amount: 80, balance: 770 },

                    // Charlie's Transactions
                    { childName: "ชาร์ลี มิลเลอร์", date: "2025-04-28", description: "Birthday Money", type: "เงินฝาก", amount: 750, balance: 750 },
                    { childName: "ชาร์ลี มิลเลอร์", date: "2025-05-06", description: "Snacks", type: "การถอน", amount: 50, balance: 700 },
                    { childName: "ชาร์ลี มิลเลอร์", date: "2025-05-18", description: "Gift Card Load", type: "เงินฝาก", amount: 150, balance: 850 },
                    { childName: "ชาร์ลี มิลเลอร์", date: "2025-05-24", description: "Book Fair", type: "การถอน", amount: 120, balance: 730 },
                ]
            };

            const childSelector = document.getElementById('childSelector');
            const currentBalanceEl = document.getElementById('currentBalance');
            const totalDepositsEl = document.getElementById('totalDeposits');
            const totalWithdrawalsEl = document.getElementById('totalWithdrawals');
            const activeChildrenEl = document.getElementById('activeChildren');

            // --- Populate Child Selector ---
            function populateChildSelector() {
                childSelector.innerHTML = '<option value="all">บุตรหลานทั้งหมด</option>'; // Default option
                familyAccount.children.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child.name; // Using name as value for simplicity
                    option.textContent = child.name;
                    childSelector.appendChild(option);
                });
            }

            // --- Update Dashboard ---
            function updateDashboard(transactionsToDisplay, selectedChildName) {
                let currentBalance = 0;
                let totalDeposits = 0;
                let totalWithdrawals = 0;

                if (selectedChildName === "all") {
                    familyAccount.children.forEach(child => {
                        const childTransactions = transactionsToDisplay.filter(t => t.childName === child.name);
                        if (childTransactions.length > 0) {
                            // Find the latest transaction for this child to get their current balance
                            const latestTransaction = childTransactions.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                            currentBalance += latestTransaction.balance;
                        }
                    });
                    totalDeposits = transactionsToDisplay.filter(t => t.type === 'เงินฝาก').reduce((sum, t) => sum + t.amount, 0);
                    totalWithdrawals = transactionsToDisplay.filter(t => t.type === 'การถอน').reduce((sum, t) => sum + t.amount, 0);
                    activeChildrenEl.textContent = familyAccount.children.length;
                } else {
                    const childTransactions = transactionsToDisplay.filter(t => t.childName === selectedChildName);
                    if (childTransactions.length > 0) {
                        const latestTransaction = childTransactions.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                        currentBalance = latestTransaction.balance;
                    }
                    totalDeposits = childTransactions.filter(t => t.type === 'เงินฝาก').reduce((sum, t) => sum + t.amount, 0);
                    totalWithdrawals = childTransactions.filter(t => t.type === 'การถอน').reduce((sum, t) => sum + t.amount, 0);
                    activeChildrenEl.textContent = '1'; // Viewing one child
                }
                
                currentBalanceEl.textContent = `฿${currentBalance.toFixed(2)}`;
                totalDepositsEl.textContent = `฿${totalDeposits.toFixed(2)}`;
                totalWithdrawalsEl.textContent = `฿${totalWithdrawals.toFixed(2)}`;
            }

            // --- Initialize DataTable --- 
            const transactionTable = new DataTable('#transactionTable', {
                responsive: true,
                order: [[0, 'desc']], // Default sort by date descending
                columns: [
                    { 
                        data: 'date',
                        render: function(data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                return moment(data).format('LL'); // Format date as 'MMMM D, YYYY' in Thai
                            }
                            return data;
                        }
                    },
                    { data: 'childName'},
                    { data: 'description' },
                    {
                        data: 'type',
                        render: function (data, type, row) {
                            const badgeClass = data === 'เงินฝาก' ? 'bg-success' : 'bg-danger';
                            return `<span class="badge ${badgeClass}">${data}</span>`;
                        }
                    },
                    { data: 'amount', render: DataTable.render.number(null, null, 2, null) },
                    { data: 'balance', render: DataTable.render.number(null, null, 2, null) }
                ],
                data: [], // Initially empty, will be populated based on selection
                language: {
                    "emptyTable": "ไม่พบข้อมูลในตาราง",
                    "info": "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                    "infoEmpty": "แสดง 0 ถึง 0 จาก 0 รายการ",
                    "infoFiltered": "(กรองจากทั้งหมด _MAX_ รายการ)",
                    "lengthMenu": "แสดง _MENU_ รายการ",
                    "loadingRecords": "กำลังโหลด...",
                    "processing": "กำลังประมวลผล...",
                    "search": "ค้นหา:",
                    "zeroRecords": "ไม่พบรายการที่ตรงกัน",
                    "paginate": {
                        "first": "หน้าแรก",
                        "last": "หน้าสุดท้าย",
                        "next": "ถัดไป",
                        "previous": "ก่อนหน้า"
                    },
                    "aria": {
                        "sortAscending": ": เปิดใช้งานเพื่อจัดเรียงคอลัมน์จากน้อยไปมาก",
                        "sortDescending": ": เปิดใช้งานเพื่อจัดเรียงคอลัมน์จากมากไปน้อย"
                    }
                }
            });

            // --- Update Table and Dashboard based on selection ---
            function displayDataForSelection() {
                NProgress.start();
                const selectedChildName = childSelector.value;
                let transactionsToDisplay = familyAccount.transactions;

                if (selectedChildName !== "all") {
                    transactionsToDisplay = familyAccount.transactions.filter(t => t.childName === selectedChildName);
                }
                
                // Apply date filters if they are set
                const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

                if (startDate || endDate) {
                    transactionsToDisplay = transactionsToDisplay.filter(t => {
                        const transactionDate = new Date(t.date);
                        if (startDate && transactionDate < startDate) return false;
                        if (endDate && transactionDate > endDate) return false;
                        return true;
                    });
                }

                transactionTable.clear().rows.add(transactionsToDisplay).draw();
                updateDashboard(transactionsToDisplay, selectedChildName);
                NProgress.done();
            }

            // --- Event Listeners ---
            childSelector.addEventListener('change', displayDataForSelection);

            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const filterBtn = document.getElementById('filterBtn');
            const resetFilterBtn = document.getElementById('resetFilterBtn');

            // Set default date values (optional) - e.g., last 30 days
            endDateInput.valueAsDate = new Date(); 
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            startDateInput.valueAsDate = oneMonthAgo; 

            filterBtn.addEventListener('click', displayDataForSelection);
            
            resetFilterBtn.addEventListener('click', function() {
                endDateInput.valueAsDate = new Date();
                oneMonthAgo.setDate(new Date().getDate() - 30); // Reset to last 30 days for example
                startDateInput.valueAsDate = oneMonthAgo;
                childSelector.value = 'all'; // Reset child selector to 'All Children'
                displayDataForSelection();
            });

            // Initial Population
            populateChildSelector();
            displayDataForSelection(); // Display data for 'All Children' and default date range on load

            // --- Modal Forms (Login/Register - unchanged for now) --- 
            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', function(event) {
                event.preventDefault();
                NProgress.start();
                // Simulate login
                setTimeout(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'เข้าสู่ระบบสำเร็จ!',
                        text: 'ยินดีต้อนรับกลับมา, ผู้ปกครอง!',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    NProgress.done();
                }, 1000);
            });

            const registerForm = document.getElementById('registerForm');
            registerForm.addEventListener('submit', function(event) {
                event.preventDefault();
                NProgress.start();
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;

                if (password !== confirmPassword) {
                    Swal.fire(
                        'รหัสผ่านไม่ตรงกัน',
                        'โปรดตรวจสอบให้แน่ใจว่ารหัสผ่านของคุณตรงกัน',
                        'error'
                    );
                    NProgress.done();
                    return;
                }
                // Simulate registration
                setTimeout(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'ลงทะเบียนสำเร็จ!',
                        text: 'ตอนนี้คุณสามารถเข้าสู่ระบบด้วยบัญชีใหม่ของคุณได้แล้ว',
                        timer: 2500,
                        showConfirmButton: false
                    });
                    bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
                    NProgress.done();
                }, 1000);
            });
        });

        window.addEventListener("load", function () {
            NProgress.done();
        });
    </script>
</body>

</html>