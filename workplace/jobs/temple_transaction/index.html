<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>สมุดเงินสด รับ-จ่าย ประจำวันของวัด</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* โค้ดสำหรับซ่อนกล่องแสดง 3 กล่องด้านบนสุด */
    .flex.flex-wrap.mb-6 {
      display: none;
      /* ซ่อนกล่องสรุปยอดทั้งหมด */
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #fccaf9;
    }

    .temple-header {
      background: linear-gradient(135deg, #f97316 30%, #ea580c 100%);
    }

    .form-section {
      background-color: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #4338ca 0%, #2563eb 100%);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-1px);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      transition: all 0.3s ease;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-1px);
    }

    .table-header {
      background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
    }

    .income {
      color: #10b981;
      font-weight: 600;
    }

    .expense {
      color: #ef4444;
      font-weight: 600;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .image-preview {
      width: 150px;
      height: 150px;
      border: 2px dashed #cbd5e1;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 100%;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 1rem;
      width: 80%;
      max-width: 500px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .tab-active {
      background-color: #4f46e5;
      color: white;
    }

    .tab {
      transition: all 0.3s ease;
    }

    .tab:hover:not(.tab-active) {
      background-color: #4f46e5;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* เพิ่มสีพื้นหลังสำหรับฟอร์มรายรับ */
    #incomeForm {
      background-color: #f0fdf4;
      /* สีเขียวอ่อน */
      padding: 1.5rem;
      border-radius: 0.5rem;
      border-left: 4px solid #10b981;
      /* เส้นขอบซ้ายสีเขียว */
    }

    /* เพิ่มสีพื้นหลังสำหรับฟอร์มรายจ่าย */
    #expenseForm {
      background-color: #fef2f2;
      /* สีแดงอ่อน */
      padding: 1.5rem;
      border-radius: 0.5rem;
      border-left: 4px solid #ef4444;
      /* เส้นขอบซ้ายสีแดง */
    }

    /* ปรับแต่งเพิ่มเติมสำหรับหัวข้อ */
    #incomeForm h2 {
      color: #10b981;
      /* สีเขียวสำหรับหัวข้อรายรับ */
    }

    #expenseForm h2 {
      color: #ef4444;
      /* สีแดงสำหรับหัวข้อรายจ่าย */
    }

    .temple-header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      position: relative;
    }

    .header-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.2;
      z-index: 1;
    }

    .header-content {
      position: relative;
      z-index: 2;
    }

    /* สำหรับแสดงวันที่และเวลาจริง */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .datetime-display {
      animation: fadeIn 1s ease-in-out;
    }


    /* เพิ่มสไตล์สำหรับตารางสรุป */
    #summaryReportResult table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    #summaryReportResult th {
      background-color: #f3f4f6;
      font-weight: 600;
      text-align: left;
    }

    #summaryReportResult td,
    #summaryReportResult th {
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
    }

    #summaryReportResult tfoot {
      background-color: #f9fafb;
      font-weight: 600;
    }

    /* แบบที่ 3 สมุดแยกประเภทรายรับ */
    /* สไตล์สำหรับตารางรายงานรายรับ */
    #incomeReportResult table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    #incomeReportResult th {
      background-color: #f3f4f6;
      font-weight: 600;
      text-align: left;
    }

    #incomeReportResult td,
    #incomeReportResult th {
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
    }

    #incomeReportResult tfoot {
      background-color: #f9fafb;
      font-weight: 600;
    }

    /* แบบที่ 4 สไตล์สำหรับตารางรายงานรายจ่าย */
    #expenseReportResult table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    #expenseReportResult th {
      background-color: #f3f4f6;
      font-weight: 600;
      text-align: left;
    }

    #expenseReportResult td,
    #expenseReportResult th {
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
    }

    #expenseReportResult tfoot {
      background-color: #f9fafb;
      font-weight: 600;
    }

    /* แบบที่ 1 */
    .monthly-cash-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .monthly-cash-table th {
      background-color: #f3f4f6;
      font-weight: 600;
      text-align: center;
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
    }

    .monthly-cash-table td {
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
    }

    .monthly-cash-table .income {
      color: #10b981;
      font-weight: 600;
    }

    .monthly-cash-table .expense {
      color: #ef4444;
      font-weight: 600;
    }

    .monthly-cash-table tfoot {
      background-color: #f9fafb;
      font-weight: 600;
    }

    .month-detail-section {
      margin-bottom: 2rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      overflow: hidden;
    }

    .month-detail-header {
      background-color: #e0e7ff;
      padding: 0.75rem 1rem;
      font-weight: 600;
    }

    /* สรุปบัญชีธนาคาร  */
    .bank-account-card {
      transition: all 0.3s ease;
      border-left: 4px solid;
    }

    .bank-account-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .bank-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: 50%;
      background-color: white;
      padding: 2px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .bank-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      background-color: #e0e7ff;
      color: #4f46e5;
    }

    /* เพิ่มในส่วน style */
    .group:hover .group-hover\:block {
      display: block;
    }

    /* ปรับสไตล์เมนู dropdown */
    .absolute {
      display: none;
    }

    .group:hover .absolute {
      display: block;
      animation: fadeIn 0.2s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ในส่วน style ที่มีอยู่แล้ว */
    .balance-summary-card {
      transition: all 0.3s ease;
      border-left: 4px solid;
    }

    .balance-summary-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* สีสำหรับการ์ดสรุปยอด */
    .summary-card-cash {
      border-left-color: #3b82f6;
    }

    .summary-card-bank {
      border-left-color: #8b5cf6;
    }

    .summary-card-total {
      border-left-color: #10b981;
    }


    .bank-account-item {
      transition: all 0.2s ease;
    }

    .bank-account-item:hover {
      background-color: #f8fafc;
    }

    .account-number {
      font-family: monospace;
      letter-spacing: 0.05em;
    }

    /* วันที่/เดือน/ปี ให้มีขนาดเท่ากัน */
    #incomeDay,
    #incomeMonth,
    #incomeYear,
    #expenseDay,
    #expenseMonth,
    #expenseYear {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
    }

    /* ปี พ.ศ. ให้มีลูกศรควบคุมตัวเลข */
    input[type="number"] {
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* ตั้งค่าตารางให้เต็มความกว้างและจัดคอลัมน์ให้ตรงกัน */
    table {
      table-layout: fixed;
      /* กำหนดให้คอลัมน์มีความกว้างคงที่ */
      width: 100%;
    }

    /* กำหนดความกว้างคอลัมน์ */
    th.w-3/4,
    td.w-3/4 {
      width: 75%;
    }

    th.w-1/4,
    td.w-1/4 {
      width: 25%;
    }

    /* จัดตำแหน่งข้อความในเซลล์ */
    .text-left {
      text-align: left;
      padding-left: 1rem;
    }

    .text-right {
      text-align: right;
      padding-right: 1rem;
    }

    /* เส้นกรอบและระยะห่าง */
    th,
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 0.75rem 1rem;
      vertical-align: middle;
    }

    /* สีพื้นหัวตาราง */
    .table-header {
      background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
    }

    /* Tab Navigation Styles */
    .tab {
      transition: all 0.3s ease;
      position: relative;
    }

    .tab.tab-active {
      background-color: #4f46e5;
      color: white;
    }

    .tab.tab-active i {
      color: white !important;
    }

    .tab.tab-active:hover {
      background-color: #4338ca;
    }

    /* Dropdown Animation */
    .absolute {
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      pointer-events: none;
    }

    .group:hover .absolute {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    /* Hover Effects */
    .hover\:bg-indigo-50:hover {
      background-color: #f0f5ff;
    }

    .hover\:text-indigo-700:hover {
      color: #4338ca;
    }

    /* Transition Effects */
    .transition-colors {
      transition-property: background-color, color;
      transition-duration: 0.2s;
      transition-timing-function: ease;
    }

    /* เพิ่มสไตล์สำหรับหน้า Balance Summary */
    .balance-card {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .balance-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    .balance-icon {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    /* สไตล์ตาราง */
    .detail-table th {
      background-color: #f8fafc;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.75rem;
    }

    .detail-table td,
    .detail-table th {
      padding: 0.75rem 1.5rem;
      vertical-align: middle;
    }

    .detail-table tr:not(:last-child) {
      border-bottom: 1px solid #edf2f7;
    }

    /* ปุ่มรีเฟรช */
    .refresh-btn {
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      transform: rotate(180deg);
    }
  </style>
</head>

<body class="min-h-screen">
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
  </div>
  <header class="temple-header text-white shadow-lg relative overflow-hidden">
    <!-- ภาพพื้นหลังส่วนหัว -->
    <div class="absolute inset-0">
      <img
        src="https://images.unsplash.com/photo-1605244475641-4b228fd9fa88?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80"
        alt="วัดไทย" class="w-full h-full object-cover opacity-20">
      <div class="absolute inset-0 bg-gradient-to-r from-indigo-900 to-purple-900 mix-blend-multiply"></div>
    </div>

    <div class="container mx-auto relative z-10">
      <div class="flex flex-col md:flex-row items-center justify-between p-6">
        <!-- โลโก้และชื่อวัด -->
        <div class="flex items-center mb-4 md:mb-0">
          <div class="mr-4">
            <div class="bg-white rounded-full p-2 shadow-lg">
              <img src="https://onab.go.th/cms/s1/u560/onab/budget.png" alt="โลโก้วัด" class="w-12 h-12 object-contain">
            </div>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold">ระบบบัญชีรับจ่ายเงินสำหรับวัด</h1>
            <!-- <p class="text-indigo-200 text-sm md:text-base">วัดทดสอบ อำเภอทดสอบ จังหวัดทดสอบ</p> -->
          </div>
        </div>

        <!-- ข้อมูลวันที่และเวลา และปุ่มกลับหน้าหลัก -->
        <div class="flex items-center gap-4">
          <!-- เพิ่มปุ่มกลับหน้าหลัก -->
          <button id="homeButton"
            class="bg-white text-indigo-700 px-4 py-2 rounded-md hover:bg-indigo-50 transition flex items-center">
            <i class="fas fa-home mr-2"></i> กลับหน้าหลัก
          </button>

          <!-- ข้อมูลวันที่และเวลา -->
          <div class="text-center md:text-right bg-white bg-opacity-10 p-3 rounded-lg backdrop-blur-sm">
            <div class="text-xl font-semibold" id="currentDate">วันเสาร์ ที่ 15 มิถุนายน 2567</div>
            <div class="text-indigo-100 flex justify-center md:justify-end items-center mt-1">
              <i class="far fa-clock mr-2"></i>
              <span id="currentTime">00:00:00 น.</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container mx-auto p-4 md:p-6">
    <div class="flex flex-wrap mb-6">
      <div class="w-full md:w-1/3 p-2">
        <div class="bg-white rounded-lg shadow-md p-4 flex flex-col items-center">
          <h3 class="text-lg font-semibold text-gray-700">รายการรับเข้าทั้งหมด</h3>
          <p class="text-2xl font-bold income" id="totalIncome">0.00 บาท</p>
        </div>
      </div>
      <div class="w-full md:w-1/3 p-2">
        <div class="bg-white rounded-lg shadow-md p-4 flex flex-col items-center">
          <h3 class="text-lg font-semibold text-gray-700">รายการจ่ายออกทั้งหมด</h3>
          <p class="text-2xl font-bold expense" id="totalExpense">0.00 บาท</p>
        </div>
      </div>
      <div class="w-full md:w-1/3 p-2">
        <div class="bg-white rounded-lg shadow-md p-4 flex flex-col items-center">
          <h3 class="text-lg font-semibold text-gray-700">รวมเงินสดคงเหลือ</h3>
          <p class="text-2xl font-bold text-blue-600" id="balance">0.00 บาท</p>
        </div>
      </div>
    </div>

    <nav class="mt-4 pb-2">
      <div class="flex flex-wrap justify-center gap-2">
        <!-- กลุ่มที่ 1: บันทึกและแก้ไขเงินสดในมือ -->
        <div class="flex items-center bg-white rounded-lg shadow-sm overflow-hidden">
          <button id="formTab"
            class="tab group flex items-center px-4 py-2 font-medium transition-colors hover:bg-indigo-50">
            <i class="fas fa-plus mr-2 text-indigo-600 group-hover:text-indigo-800"></i>
            <span>บันทึกรับ-จ่าย</span>
            <span class="ml-1 text-xs text-gray-500">(เงินสดในมือ)</span>
          </button>
          <div class="h-6 w-px bg-gray-200"></div>
          <button id="dataTab"
            class="tab group flex items-center px-4 py-2 font-medium transition-colors hover:bg-indigo-50">
            <i class="fa-regular fa-pen-to-square mr-2 text-indigo-600 group-hover:text-indigo-800"></i>
            <span>แก้ไขรับ-จ่าย</span>
            <span class="ml-1 text-xs text-gray-500">(เงินสดในมือ)</span>
          </button>
        </div>

        <!-- กลุ่มที่ 2: บันทึกและแก้ไขโอนเข้าบัญชีธนาคาร -->
        <div class="flex items-center bg-white rounded-lg shadow-sm overflow-hidden">
          <button id="transferTab"
            class="tab group flex items-center px-4 py-2 font-medium transition-colors hover:bg-indigo-50">
            <i class="fas fa-exchange-alt mr-2 text-green-600 group-hover:text-green-800"></i>
            <span>บันทึกการโอน</span>
            <span class="ml-1 text-xs text-gray-500">(เข้าบัญชีธนาคารโดยตรง)</span>
          </button>
          <div class="h-6 w-px bg-gray-200"></div>
          <button id="transferDataTab"
            class="tab group flex items-center px-4 py-2 font-medium transition-colors hover:bg-indigo-50">
            <i class="fas fa-edit mr-2 text-green-600 group-hover:text-green-800"></i>
            <span>แก้ไข</span>
            <span class="ml-1 text-xs text-gray-500">(เข้าบัญชีธนาคารโดยตรง)</span>
          </button>
        </div>


        <!-- กลุ่มที่ 4: ตัดโอนจากบัญชีธนาคาร -->
        <div class="flex items-center bg-white rounded-lg shadow-sm overflow-hidden">
          <button id="withdrawTab"
            class="tab group flex items-center px-4 py-2 font-medium transition-colors hover:bg-indigo-50">
            <i class="fas fa-money-bill-wave mr-2 text-orange-600 group-hover:text-orange-800"></i>
            <span>ตัดโอนจากบัญชีธนาคาร</span>
            <span class="ml-1 text-xs text-gray-500">(โอนเงินออก)</span>
          </button>
          <div class="h-6 w-px bg-gray-200"></div>
          <button id="withdrawDataTab"
            class="tab group flex items-center px-4 py-2 font-medium transition-colors hover:bg-indigo-50">
            <i class="fas fa-edit mr-2 text-orange-600 group-hover:text-orange-800"></i>
            <span>แก้ไข</span>
            <span class="ml-1 text-xs text-gray-500">(โอนเงินออก)</span>
          </button>
        </div>

        <!-- กลุ่มที่ 3: รายงานต่างๆ -->
        <div class="relative group">
          <button id="reportsMainTab"
            class="tab flex items-center px-4 py-2 font-medium bg-white rounded-lg shadow-sm hover:bg-indigo-50 transition-colors">
            <i class="fas fa-chart-pie mr-2 text-purple-600 group-hover:text-purple-800"></i>
            <span>แบบรายงานต่าง ๆ</span>
            <i class="fas fa-chevron-down ml-2 text-sm text-gray-500 transition-transform group-hover:rotate-180"></i>
          </button>
          <!-- เมนูย่อย -->
          <div
            class="absolute left-0 mt-1 w-64 bg-white shadow-lg rounded-lg z-50 hidden group-hover:block border border-gray-200">
            <div class="p-2">
              <button id="form1Tab"
                class="w-full flex items-center px-3 py-2 text-sm rounded-md hover:bg-indigo-50 text-gray-700 hover:text-indigo-700">
                <i class="fas fa-file-invoice mr-2 text-blue-500"></i>
                <span>1. รับ-จ่ายประจำวัน</span>
              </button>
              <button id="bankAccountTab"
                class="w-full flex items-center px-3 py-2 text-sm rounded-md hover:bg-indigo-50 text-gray-700 hover:text-indigo-700">
                <i class="fas fa-university mr-2 text-blue-500"></i>
                <span>2. บัญชีธนาคาร</span>
              </button>
              <button id="form3Tab"
                class="w-full flex items-center px-3 py-2 text-sm rounded-md hover:bg-indigo-50 text-gray-700 hover:text-indigo-700">
                <i class="fas fa-money-bill-wave mr-2 text-green-500"></i>
                <span>3. แยกประเภทรายรับ</span>
              </button>
              <button id="form4Tab"
                class="w-full flex items-center px-3 py-2 text-sm rounded-md hover:bg-indigo-50 text-gray-700 hover:text-indigo-700">
                <i class="fas fa-receipt mr-2 text-red-500"></i>
                <span>4. แยกประเภทรายจ่าย</span>
              </button>
              <button id="form5Tab"
                class="w-full flex items-center px-3 py-2 text-sm rounded-md hover:bg-indigo-50 text-gray-700 hover:text-indigo-700">
                <i class="fas fa-balance-scale mr-2 text-purple-500"></i>
                <span>5. สรุปงบรับ-จ่าย</span>
              </button>
              <button id="balanceSummaryTab"
                class="w-full flex items-center px-3 py-2 text-sm rounded-md hover:bg-indigo-50 text-gray-700 hover:text-indigo-700">
                <i class="fas fa-coins mr-2 text-yellow-500"></i>
                <span>6. สรุปยอดเงินคงเหลือ</span>
              </button>
              <div class="border-t border-gray-200 my-1"></div>
              <button id="reportTab"
                class="w-full flex items-center px-3 py-2 text-sm rounded-md hover:bg-indigo-50 text-gray-700 hover:text-indigo-700">
                <i class="fas fa-chart-bar mr-2 text-indigo-500"></i>
                <span>รายงานอื่น ๆ</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div id="formSection" class="form-section p-6 mb-8">
      <div class="flex flex-wrap -mx-2">
        <div class="w-full md:w-1/2 px-2 mb-6">
          <h2 class="text-xl font-bold mb-4 text-indigo-700">บันทึกรายการรับ (รับเงินสด / ถอนเงินจากธนาคาร)</h2>
          <form id="incomeForm" class="space-y-4">
            <input type="hidden" id="incomeId" name="id">
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">วันที่
                  <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
                <select id="incomeDay" name="day"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  required>
                  <option value="">เลือกวัน</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">เดือน
                  <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
                <select id="incomeMonth" name="month"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  required>
                  <option value="">เลือกเดือน</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ปี พ.ศ.
                  <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
                <input type="number" id="incomeYear" name="year"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="2567" required>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">เลขที่เอกสาร</label>
              <input type="text" id="incomeDocNo" name="docNo"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="เลขที่เอกสาร">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">รูปภาพเอกสาร</label>
              <div class="flex items-start space-x-4">
                <div class="image-preview" id="incomeImagePreview">
                  <i class="fas fa-image text-gray-400 text-4xl"></i>
                </div>
                <div class="flex-1">
                  <div class="file-input-wrapper">
                    <button type="button" class="btn-primary text-white px-4 py-2 rounded-md">
                      <i class="fas fa-upload mr-2"></i>แนบเอกสารหลักฐาน
                    </button>
                    <input type="file" id="incomeImage" name="image" accept="image/*" class="cursor-pointer">
                  </div>
                  <p class="text-sm text-gray-500 mt-2">รองรับไฟล์ JPG, PNG ขนาดไม่เกิน 5MB</p>
                  <input type="hidden" id="incomeImageBase64" name="imageBase64">
                  <input type="hidden" id="incomeImageName" name="imageName">
                  <input type="hidden" id="incomeImageType" name="imageType">
                  <input type="hidden" id="incomeImageUrl" name="imageUrl">
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">รายการรับ
                <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
              <input type="text" id="incomeDescription" name="description"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="ระบุรายการรับอย่างละเอียด" required>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">รหัสรายรับ
                <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
              <select id="incomeCode" name="code"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                required>
                <option value="">เลือกรหัสรายรับ</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงิน (บาท)
                <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
              <input type="number" id="incomeAmount" name="amount" step="0.01"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="0.00" required>
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" id="resetIncomeForm"
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">ล้างข้อมูล</button>
              <button type="submit" class="btn-success text-white px-6 py-2 rounded-md">
                <i class="fas fa-save mr-2"></i>บันทึกข้อมูล
              </button>
            </div>
          </form>
        </div>

        <div class="w-full md:w-1/2 px-2 mb-6">
          <h2 class="text-xl font-bold mb-4 text-indigo-700">บันทึกรายการจ่าย (จ่ายเงินสด / เอาเงินสดฝากเข้าธนาคาร)</h2>
          <form id="expenseForm" class="space-y-4">
            <input type="hidden" id="expenseId" name="id">
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">วันที่
                  <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
                <select id="expenseDay" name="day"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  required>
                  <option value="">เลือกวัน</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">เดือน
                  <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
                <select id="expenseMonth" name="month"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  required>
                  <option value="">เลือกเดือน</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ปี พ.ศ.
                  <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
                <input type="number" id="expenseYear" name="year"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="2567" required>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">เลขที่เอกสาร</label>
              <input type="text" id="expenseDocNo" name="docNo"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="เลขที่เอกสาร">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">รูปภาพเอกสาร</label>
              <div class="flex items-start space-x-4">
                <div class="image-preview" id="expenseImagePreview">
                  <i class="fas fa-image text-gray-400 text-4xl"></i>
                </div>
                <div class="flex-1">
                  <div class="file-input-wrapper">
                    <button type="button" class="btn-primary text-white px-4 py-2 rounded-md">
                      <i class="fas fa-upload mr-2"></i>แนบเอกสารหลักฐาน
                    </button>
                    <input type="file" id="expenseImage" name="image" accept="image/*" class="cursor-pointer">
                  </div>
                  <p class="text-sm text-gray-500 mt-2">รองรับไฟล์ JPG, PNG ขนาดไม่เกิน 5MB</p>
                  <input type="hidden" id="expenseImageBase64" name="imageBase64">
                  <input type="hidden" id="expenseImageName" name="imageName">
                  <input type="hidden" id="expenseImageType" name="imageType">
                  <input type="hidden" id="expenseImageUrl" name="imageUrl">
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">รายการจ่าย
                <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
              <input type="text" id="expenseDescription" name="description"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="ระบุรายการจ่ายอย่างละเอียด" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">รหัสรายจ่าย
                <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
              <select id="expenseCode" name="code"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                required>
                <option value="">เลือกรหัสรายจ่าย</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงิน (บาท)
                <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
              <input type="number" id="expenseAmount" name="amount" step="0.01"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="0.00" required>
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" id="resetExpenseForm"
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">ล้างข้อมูล</button>
              <button type="submit" class="btn-success text-white px-6 py-2 rounded-md">
                <i class="fas fa-save mr-2"></i>บันทึกข้อมูล
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="dataSection" class="form-section p-6 mb-8" style="display: none;">
      <div class="mb-6">
        <h2 class="text-xl font-bold mb-4 text-indigo-700">ข้อมูลทั้งหมด</h2>

        <div class="flex flex-wrap items-center mb-4 gap-4">
          <!-- ตัวกรองเดิมที่มีอยู่แล้ว -->
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">ประเภท:</label>
            <select id="filterType"
              class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="all">ทั้งหมด</option>
              <option value="income">รายรับ</option>
              <option value="expense">รายจ่าย</option>
            </select>
          </div>
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">เดือน:</label>
            <select id="filterMonth"
              class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="all">ทั้งหมด</option>
            </select>
          </div>


          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">ปี:</label>
            <select id="filterYear"
              class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="all">ทั้งหมด</option>
            </select>
          </div>

          <!-- เพิ่มตัวกรองรหัสรายรับ (จะแสดงเมื่อเลือกประเภทเป็นรายรับ) -->
          <div class="flex items-center space-x-2" id="incomeCodeFilterContainer" style="display: none;">
            <label class="text-sm font-medium text-gray-700">รหัสรายรับ:</label>
            <select id="filterIncomeCode"
              class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="all">ทั้งหมด</option>
            </select>
          </div>

          <!-- เพิ่มตัวกรองรหัสรายจ่าย (จะแสดงเมื่อเลือกประเภทเป็นรายจ่าย) -->
          <div class="flex items-center space-x-2" id="expenseCodeFilterContainer" style="display: none;">
            <label class="text-sm font-medium text-gray-700">รหัสรายจ่าย:</label>
            <select id="filterExpenseCode"
              class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="all">ทั้งหมด</option>
            </select>
          </div>

          <button id="applyFilter" class="btn-primary text-white px-4 py-2 rounded-md">
            <i class="fas fa-filter mr-2"></i>กรอง
          </button>
          <button id="resetFilter" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">
            <i class="fas fa-redo mr-2"></i>รีเซ็ต
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg overflow-hidden">
            <thead class="table-header text-white">
              <tr>
                <th class="px-4 py-3 text-left">วันที่</th>
                <th class="px-4 py-3 text-left">เลขที่เอกสาร</th>
                <th class="px-4 py-3 text-left">รายการ</th>
                <th class="px-4 py-3 text-left">รหัส</th>
                <th class="px-4 py-3 text-right">จำนวนเงิน</th>
                <th class="px-4 py-3 text-center">เอกสาร</th>
                <th class="px-4 py-3 text-center">จัดการ</th>
              </tr>
            </thead>
            <tbody id="dataTable">
              <!-- Data will be loaded here -->
            </tbody>
          </table>
        </div>
        <div id="paginationControls" class="flex justify-between items-center mt-4">
          <div class="text-sm text-gray-600">
            แสดง <span id="startRecord">0</span> ถึง <span id="endRecord">0</span> จาก
            <span id="totalRecords">0</span>
            รายการ
          </div>
          <div class="flex space-x-2">
            <button id="prevPage"
              class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition disabled:opacity-50">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="currentPage" class="px-3 py-1 bg-indigo-600 text-white rounded-md">1</span>
            <button id="nextPage"
              class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition disabled:opacity-50">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab ตัดโอนจากบัญชีธนาคาร -->
    <div id="withdrawSection" class="form-section p-6 mb-8" style="display: none;">
      <div class="w-full px-2 mb-6">
        <h2 class="text-xl font-bold mb-4 text-indigo-700">บันทึกรายการตัดโอนเงินจากบัญชีธนาคาร</h2>
        <form id="withdrawForm" class="space-y-4">
          <input type="hidden" id="withdrawId" name="id">
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">วันที่
                <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
              <select id="withdrawDay" name="day"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                required>
                <option value="">เลือกวัน</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">เดือน
                <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
              <select id="withdrawMonth" name="month"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                required>
                <option value="">เลือกเดือน</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ปี พ.ศ.
                <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
              <input type="number" id="withdrawYear" name="year"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="2567" required>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">เลขที่เอกสาร</label>
            <input type="text" id="withdrawDocNo" name="docNo"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="เลขที่เอกสาร">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">รูปภาพเอกสาร</label>
            <div class="flex items-start space-x-4">
              <div class="image-preview" id="withdrawImagePreview">
                <i class="fas fa-image text-gray-400 text-4xl"></i>
              </div>
              <div class="flex-1">
                <div class="file-input-wrapper">
                  <button type="button" class="btn-primary text-white px-4 py-2 rounded-md">
                    <i class="fas fa-upload mr-2"></i>แนบเอกสารหลักฐาน
                  </button>
                  <input type="file" id="withdrawImage" name="image" accept="image/*" class="cursor-pointer">
                </div>
                <p class="text-sm text-gray-500 mt-2">รองรับไฟล์ JPG, PNG ขนาดไม่เกิน 5MB</p>
                <input type="hidden" id="withdrawImageBase64" name="imageBase64">
                <input type="hidden" id="withdrawImageName" name="imageName">
                <input type="hidden" id="withdrawImageType" name="imageType">
                <input type="hidden" id="withdrawImageUrl" name="imageUrl">
              </div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">รายการตัดโอน
              <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
            <input type="text" id="withdrawDescription" name="description"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="ระบุรายการตัดโอนอย่างละเอียด" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">รหัสการตัดโอน
              <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
            <select id="withdrawCode" name="code"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="">เลือกรหัสการตัดโอน</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงิน (บาท)
              <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
            <input type="number" id="withdrawAmount" name="amount" step="0.01"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="0.00" required>
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" id="resetWithdrawForm"
              class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">ล้างข้อมูล</button>
            <button type="submit" class="btn-success text-white px-6 py-2 rounded-md">
              <i class="fas fa-save mr-2"></i>บันทึกข้อมูล
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="withdrawDataSection" class="form-section p-6 mb-8" style="display: none;">
      <div class="mb-6">
        <h2 class="text-xl font-bold mb-4 text-indigo-700">จัดการข้อมูลการตัดโอนจากบัญชี</h2>

        <div class="flex flex-wrap items-center mb-4 gap-4">
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">ช่วงเดือน:</label>
            <select id="withdrawFilterMonth"
              class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="all">ทั้งหมด</option>
            </select>
          </div>
          <div class="flex items-center space-x-2">
            <label class="text-sm font-medium text-gray-700">ปี:</label>
            <select id="withdrawFilterYear"
              class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="all">ทั้งหมด</option>
            </select>
          </div>
          <button id="applyWithdrawFilter" class="btn-primary text-white px-4 py-2 rounded-md">
            <i class="fas fa-filter mr-2"></i>กรอง
          </button>
          <button id="resetWithdrawFilter"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">
            <i class="fas fa-redo mr-2"></i>รีเซ็ต
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg overflow-hidden">
            <thead class="table-header text-white">
              <tr>
                <th class="px-4 py-3 text-left">วันที่</th>
                <th class="px-4 py-3 text-left">เลขที่เอกสาร</th>
                <th class="px-4 py-3 text-left">รายการ</th>
                <th class="px-4 py-3 text-left">รหัส</th>
                <th class="px-4 py-3 text-right">จำนวนเงิน</th>
                <th class="px-4 py-3 text-center">เอกสาร</th>
                <th class="px-4 py-3 text-center">จัดการ</th>
              </tr>
            </thead>
            <tbody id="withdrawDataTable">
              <!-- Data will be loaded here -->
            </tbody>
          </table>
        </div>
        <div id="withdrawPaginationControls" class="flex justify-between items-center mt-4">
          <div class="text-sm text-gray-600">
            แสดง <span id="withdrawStartRecord">0</span> ถึง <span id="withdrawEndRecord">0</span> จาก
            <span id="withdrawTotalRecords">0</span> รายการ
          </div>
          <div class="flex space-x-2">
            <button id="withdrawPrevPage"
              class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition disabled:opacity-50">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="withdrawCurrentPage" class="px-3 py-1 bg-indigo-600 text-white rounded-md">1</span>
            <button id="withdrawNextPage"
              class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition disabled:opacity-50">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="reportSection" class="form-section p-6 mb-8" style="display: none;">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">รายงาน</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <div class="bg-white p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-3">รายงานรายเดือน</h3>
          <div class="space-y-4">
            <div class="flex flex-wrap items-center gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">เดือน</label>
                <select id="reportMonth"
                  class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                  <!-- Months will be loaded here -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ปี พ.ศ.</label>
                <select id="reportMonthYear"
                  class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                  <!-- Years will be loaded here -->
                </select>
              </div>
            </div>
            <button id="generateMonthlyReport" class="btn-primary text-white px-6 py-2 rounded-md">
              <i class="fas fa-file-excel mr-2"></i>สร้างรายงาน XLS
            </button>
          </div>
        </div>


        <div class="bg-white p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-3">รายงานรายปี</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ปี พ.ศ.</label>
              <select id="reportYear"
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <!-- Years will be loaded here -->
              </select>
            </div>
            <button id="generateYearlyReport" class="btn-primary text-white px-6 py-2 rounded-md">
              <i class="fas fa-file-excel mr-2"></i>สร้างรายงาน XLS
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- แบบที่ 1 - สมุดเงินสดประจำเดือน -->
    <div id="form1Section" class="form-section p-6 mb-8" style="display: none;">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">แบบที่ 1 สมุดเงินสดประจำเดือน</h2>

      <div class="bg-white p-4 rounded-lg shadow">
        <h3 class="text-lg font-semibold mb-3">สรุปยอดเงินสดประจำเดือน</h3>
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ปี พ.ศ.</label>
              <select id="yearSelect"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <!-- ปีจะถูกโหลดจาก JavaScript -->
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ช่วงเดือน</label>
              <select id="monthRangeSelect"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="all">ทั้งหมด</option>
                <option value="1-6">ครึ่งปีแรก (ม.ค.-มิ.ย.)</option>
                <option value="7-12">ครึ่งปีหลัง (ก.ค.-ธ.ค.)</option>
                <option value="custom">กำหนดเอง</option>
              </select>
            </div>
          </div>

          <div id="customMonthRange" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ตั้งแต่เดือน</label>
              <select id="startMonthSelect"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <!-- เดือนจะถูกโหลดจาก JavaScript -->
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ถึงเดือน</label>
              <select id="endMonthSelect"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <!-- เดือนจะถูกโหลดจาก JavaScript -->
              </select>
            </div>
          </div>

          <button id="generateMonthlyCashReport" class="btn-primary text-white px-6 py-2 rounded-md">
            <i class="fas fa-file-alt mr-2"></i>สร้างรายงาน
          </button>

          <div id="monthlyCashReportResult" class="hidden">
            <!-- ผลลัพธ์จะแสดงที่นี่ -->
          </div>
        </div>
      </div>
    </div>

    <!-- แบบที่ 3 -->
    <div id="form3Section" class="form-section p-6 mb-8" style="display: none;">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">แบบที่ 3 สมุดแยกประเภทรายรับ</h2>

      <div class="grid grid-cols-1 md:grid-cols-1 gap-6">

        <div class="bg-white p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-3">สรุปสมุดแยกประเภทรายรับ</h3>
          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">วันที่เริ่มต้น</label>
                <input type="date" id="incomeStartDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">วันที่สิ้นสุด</label>
                <input type="date" id="incomeEndDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <button id="generateIncomeReport" class="btn-primary text-white px-6 py-2 rounded-md">
              <i class="fas fa-file-alt mr-2"></i>สร้างรายงาน
            </button>
            <div id="incomeReportResult" class="mt-4 hidden">
              <!-- ผลลัพธ์จะแสดงที่นี่ -->
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- แบบที่ 4 -->
    <div id="form4Section" class="form-section p-6 mb-8" style="display: none;">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">แบบที่ 4 สมุดแยกประเภทรายจ่าย</h2>

      <div class="grid grid-cols-1 md:grid-cols-1 gap-6">

        <div class="bg-white p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-3">สรุปสมุดแยกประเภทรายจ่าย</h3>
          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">วันที่เริ่มต้น</label>
                <input type="date" id="expenseStartDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">วันที่สิ้นสุด</label>
                <input type="date" id="expenseEndDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <button id="generateExpenseReport" class="btn-primary text-white px-6 py-2 rounded-md">
              <i class="fas fa-file-alt mr-2"></i>สร้างรายงาน
            </button>
            <div id="expenseReportResult" class="mt-4 hidden">
              <!-- ผลลัพธ์จะแสดงที่นี่ -->
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- แบบที่ 5 -->
    <div id="form5Section" class="form-section p-6 mb-8" style="display: none;">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">แบบที่ 5 งบรายรับและรายจ่าย</h2>

      <div class="grid grid-cols-1 md:grid-cols-1 gap-6">

        <div class="bg-white p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-3">สรุปงบรายรับ-รายจ่าย</h3>
          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">วันที่เริ่มต้น</label>
                <input type="date" id="startDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">วันที่สิ้นสุด</label>
                <input type="date" id="endDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <button id="generateSummaryReport" class="btn-primary text-white px-6 py-2 rounded-md">
              <i class="fas fa-file-alt mr-2"></i>สร้างรายงานสรุป
            </button>
            <div id="summaryReportResult" class="mt-4 hidden">
              <!-- ผลลัพธ์จะแสดงที่นี่ -->
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3 class="text-xl font-bold mb-4 text-gray-800">ยืนยันการลบข้อมูล</h3>
      <p class="mb-6 text-gray-600">คุณต้องการลบข้อมูลนี้ใช่หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้</p>
      <div class="flex justify-end space-x-3">
        <button id="cancelDelete"
          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">ยกเลิก</button>
        <button id="confirmDelete" class="btn-danger text-white px-4 py-2 rounded-md">ยืนยันการลบ</button>
      </div>
    </div>
  </div>

  <!-- Image Preview Modal -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">รูปภาพเอกสาร</h3>
        <button id="closeImageModal" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="flex justify-center">
        <img id="modalImage" src="" alt="เอกสาร" class="max-w-full max-h-[70vh]">
      </div>
    </div>
  </div>

  <!-- สรุปข้อมูลบัญชีธนาคาร -->
  <div id="bankAccountSection" class="form-section p-6 mb-8" style="display: none;">
    <h2 class="text-xl font-bold mb-4 text-indigo-700">แบบที่ 2 สรุปยอดเงินคงเหลือบัญชีธนาคาร</h2>

    <div class="bg-white p-4 rounded-lg shadow">
      <div class="flex flex-wrap justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">ยอดเงินในบัญชีธนาคารทั้งหมด</h3>
        <button id="refreshBankAccounts" class="btn-primary text-white px-4 py-2 rounded-md">
          <i class="fas fa-sync-alt mr-2"></i>รีเฟรชข้อมูล
        </button>
      </div>

      <!-- สรุปยอดรวม -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
          <div class="text-blue-600 text-sm font-medium">ยอดฝากรวมทั้งหมด</div>
          <div class="text-2xl font-bold text-blue-800" id="totalDeposits">0.00 บาท</div>
        </div>
        <div class="bg-red-50 p-4 rounded-lg border border-red-100">
          <div class="text-red-600 text-sm font-medium">ยอดถอนรวมทั้งหมด</div>
          <div class="text-2xl font-bold text-red-800" id="totalWithdrawals">0.00 บาท</div>
        </div>
        <div class="bg-green-50 p-4 rounded-lg border border-green-100">
          <div class="text-green-600 text-sm font-medium">ยอดคงเหลือรวม</div>
          <div class="text-2xl font-bold text-green-800" id="totalBankBalance">0.00 บาท</div>
        </div>
      </div>

      <!-- ตารางบัญชีธนาคาร -->
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg overflow-hidden">
          <thead class="table-header text-white">
            <tr>
              <th class="px-4 py-3 text-left">รหัสบัญชี</th>
              <th class="px-4 py-3 text-left">ชื่อบัญชี</th>
              <th class="px-4 py-3 text-left">ธนาคาร</th>
              <th class="px-4 py-3 text-left">เลขที่บัญชี</th>
              <th class="px-4 py-3 text-right">ยอดฝาก</th>
              <th class="px-4 py-3 text-right">ยอดถอน</th>
              <th class="px-4 py-3 text-right">ยอดคงเหลือ</th>
            </tr>
          </thead>
          <tbody id="bankAccountsTable">
            <!-- ข้อมูลจะถูกโหลดที่นี่ -->
            <tr>
              <td colspan="7" class="px-4 py-3 text-center text-gray-500">กำลังโหลดข้อมูล...</td>
            </tr>
          </tbody>
        </table>
      </div>


      <div class="flex justify-end space-x-3">
        <button onclick="printBankAccountSummary()" class="btn-primary text-white px-4 py-2 rounded-md">
          <i class="fas fa-print mr-2"></i>พิมพ์รายงาน
        </button>
        <button id="exportBankAccounts" class="btn-success text-white px-4 py-2 rounded-md">
          <i class="fas fa-file-excel mr-2"></i>Export เป็น Excel
        </button>
      </div>
    </div>
  </div>


  <!-- รายงานเงินคงเหลือ -->
  <div id="balanceSummarySection" class="form-section p-6 mb-8" style="display: none;">
    <div class="max-w-6xl mx-auto">
      <!-- หัวข้อหลัก -->
      <div class="text-center mb-8">
        <h2 class="text-2xl font-bold text-indigo-800 mb-2">แบบที่ 6 สรุปยอดเงินคงเหลือทั้งหมด</h2>
        <div class="text-lg text-gray-600" id="balanceSummaryDate"></div>
      </div>

      <!-- การ์ดสรุปยอดรวม -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- เงินสดในมือ -->
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl shadow-md p-6 border-l-4 border-blue-500">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-semibold text-blue-600 uppercase tracking-wider">เงินสดในมือ</h3>
              <p class="text-2xl font-bold text-blue-800 mt-2" id="cashOnHandAmount">0.00 บาท</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
              <i class="fas fa-wallet text-blue-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 text-sm text-blue-700">
            <i class="fas fa-info-circle mr-1"></i> เงินสดที่อยู่ในมือทั้งหมด
          </div>
        </div>

        <!-- เงินในบัญชีธนาคาร -->
        <div
          class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-md p-6 border-l-4 border-purple-500">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-semibold text-purple-600 uppercase tracking-wider">เงินในบัญชีธนาคาร</h3>
              <p class="text-2xl font-bold text-purple-800 mt-2" id="bankBalanceAmount">0.00 บาท</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
              <i class="fas fa-university text-purple-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 text-sm text-purple-700">
            <i class="fas fa-info-circle mr-1"></i> ยอดเงินในบัญชีธนาคารทั้งหมด
          </div>
        </div>

        <!-- ยอดรวมทั้งหมด -->
        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl shadow-md p-6 border-l-4 border-green-500">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-semibold text-green-600 uppercase tracking-wider">รวมเงินคงเหลือทั้งหมด</h3>
              <p class="text-2xl font-bold text-green-800 mt-2" id="totalBalanceAmount">0.00 บาท</p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
              <i class="fas fa-coins text-green-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4 text-sm text-green-700">
            <i class="fas fa-info-circle mr-1"></i> เงินสดและเงินฝากธนาคารรวมกัน
          </div>
        </div>
      </div>

      <!-- ตารางแสดงรายละเอียด -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
          <h3 class="text-lg font-semibold text-gray-800">รายละเอียดยอดเงินคงเหลือ</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                  รายการ
                </th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
                  จำนวนเงิน (บาท)
                </th>
              </tr>
            </thead>
            <tbody id="balanceSummaryTable" class="bg-white divide-y divide-gray-200">
              <!-- ข้อมูลจะถูกเติมโดย JavaScript -->
              <tr>
                <td colspan="2" class="px-6 py-4 text-center text-gray-500">กำลังโหลดข้อมูล...</td>
              </tr>
            </tbody>
            <!-- <tfoot class="bg-gray-50">
            <tr>
              <td class="px-6 py-3 text-right font-semibold text-gray-800">รวมทั้งหมด</td>
              <td class="px-6 py-3 text-right font-bold text-green-600" id="totalBalanceAmount">0.00 บาท</td>
            </tr>
          </tfoot> -->
          </table>
        </div>
      </div>

      <!-- ส่วนของปุ่มจัดการ -->
      <div class="flex flex-wrap justify-end gap-4 mt-6">
        <button id="refreshBalanceSummary"
          class="flex items-center px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition">
          <i class="fas fa-sync-alt mr-2"></i>รีเฟรชข้อมูล
        </button>
        <button id="printBalanceSummary"
          class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
          <i class="fas fa-print mr-2"></i>พิมพ์รายงาน
        </button>
        <button id="exportBalanceSummary"
          class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
          <i class="fas fa-file-excel mr-2"></i>Export เป็น Excel
        </button>
      </div>
    </div>
  </div>

  <!-- //Tab การโอนเงินเข้าบัญชีโดยตรง -->
  <div id="transferSection" class="form-section p-6 mb-8" style="display: none;">
    <div class="w-full px-2 mb-6">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">บันทึกรายการโอนเงินเข้าบัญชีธนาคารโดยตรง</h2>
      <form id="transferForm" class="space-y-4">
        <input type="hidden" id="transferId" name="id">
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">วันที่
              <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
            <select id="transferDay" name="day"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              required>
              <option value="">เลือกวัน</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">เดือน
              <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
            <select id="transferMonth" name="month"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              required>
              <option value="">เลือกเดือน</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ปี พ.ศ.
              <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
            <input type="number" id="transferYear" name="year"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="2567" required>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">เลขที่เอกสาร</label>
          <input type="text" id="transferDocNo" name="docNo"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="เลขที่เอกสาร">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">รูปภาพเอกสาร</label>
          <div class="flex items-start space-x-4">
            <div class="image-preview" id="transferImagePreview">
              <i class="fas fa-image text-gray-400 text-4xl"></i>
            </div>
            <div class="flex-1">
              <div class="file-input-wrapper">
                <button type="button" class="btn-primary text-white px-4 py-2 rounded-md">
                  <i class="fas fa-upload mr-2"></i>แนบเอกสารหลักฐาน
                </button>
                <input type="file" id="transferImage" name="image" accept="image/*" class="cursor-pointer">
              </div>
              <p class="text-sm text-gray-500 mt-2">รองรับไฟล์ JPG, PNG ขนาดไม่เกิน 5MB</p>
              <input type="hidden" id="transferImageBase64" name="imageBase64">
              <input type="hidden" id="transferImageName" name="imageName">
              <input type="hidden" id="transferImageType" name="imageType">
              <input type="hidden" id="transferImageUrl" name="imageUrl">
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">รายการโอน
            <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
          <input type="text" id="transferDescription" name="description"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="ระบุรายการโอนอย่างละเอียด" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">รหัสการโอน
            <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
          <select id="transferCode" name="code"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
            required>
            <option value="">เลือกรหัสการโอน</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงิน (บาท)
            <span class="text-red-600 font-bold text-lg align-middle ml-1">*</span></label>
          <input type="number" id="transferAmount" name="amount" step="0.01"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="0.00" required>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" id="resetTransferForm"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">ล้างข้อมูล</button>
          <button type="submit" class="btn-success text-white px-6 py-2 rounded-md">
            <i class="fas fa-save mr-2"></i>บันทึกข้อมูล
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="transferDataSection" class="form-section p-6 mb-8" style="display: none;">
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">จัดการข้อมูลการโอนเข้าบัญชี</h2>

      <div class="flex flex-wrap items-center mb-4 gap-4">
        <div class="flex items-center space-x-2">
          <label class="text-sm font-medium text-gray-700">ช่วงเดือน:</label>
          <select id="transferFilterMonth"
            class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="all">ทั้งหมด</option>
          </select>
        </div>
        <div class="flex items-center space-x-2">
          <label class="text-sm font-medium text-gray-700">ปี:</label>
          <select id="transferFilterYear"
            class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="all">ทั้งหมด</option>
          </select>
        </div>
        <button id="applyTransferFilter" class="btn-primary text-white px-4 py-2 rounded-md">
          <i class="fas fa-filter mr-2"></i>กรอง
        </button>
        <button id="resetTransferFilter"
          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">
          <i class="fas fa-redo mr-2"></i>รีเซ็ต
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg overflow-hidden">
          <thead class="table-header text-white">
            <tr>
              <th class="px-4 py-3 text-left">วันที่</th>
              <th class="px-4 py-3 text-left">เลขที่เอกสาร</th>
              <th class="px-4 py-3 text-left">รายการ</th>
              <th class="px-4 py-3 text-left">รหัส</th>
              <th class="px-4 py-3 text-right">จำนวนเงิน</th>
              <th class="px-4 py-3 text-center">เอกสาร</th>
              <th class="px-4 py-3 text-center">จัดการ</th>
            </tr>
          </thead>
          <tbody id="transferDataTable">
            <!-- Data will be loaded here -->
          </tbody>
        </table>
      </div>
      <div id="transferPaginationControls" class="flex justify-between items-center mt-4">
        <div class="text-sm text-gray-600">
          แสดง <span id="transferStartRecord">0</span> ถึง <span id="transferEndRecord">0</span> จาก
          <span id="transferTotalRecords">0</span> รายการ
        </div>
        <div class="flex space-x-2">
          <button id="transferPrevPage"
            class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition disabled:opacity-50">
            <i class="fas fa-chevron-left"></i>
          </button>
          <span id="transferCurrentPage" class="px-3 py-1 bg-indigo-600 text-white rounded-md">1</span>
          <button id="transferNextPage"
            class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition disabled:opacity-50">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  <footer
    class="mt-12 py-6 bg-white/80 backdrop-blur-md border-t border-gray-200/60 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
    <div class="container mx-auto px-4 text-center">
      <div class="flex flex-col md:flex-row justify-center items-center gap-4">
        <div class="text-amber-700 font-medium flex items-center">
          <i class="fas fa-temple text-xl mr-2"></i>
          สำนักงานพระพุทธศาสนาแห่งชาติ
        </div>
        <div class="hidden md:block h-5 w-px bg-gray-300"></div>
        <div class="text-gray-600">
          <i class="fas fa-map-marker-alt mr-1"></i>
          อำเภอพุทธมณฑล จังหวัดนครปฐม
        </div>
      </div>
      <div class="mt-4 text-gray-500 text-sm">
        <p>ระบบบัญชีรับจ่ายเงินสำหรับวัด © 2568 | พัฒนาระบบโดย นายวัชระ มั่นยืน ผู้อำนวยการกลุ่มเทคโนโลยีสารสนเทศ
          <br>สำนักงานเลขานุการกรม
          สำนักงานพระพุทธศาสนาแห่งชาติ
        </p>
      </div>
    </div>
  </footer>



  <script>
    // Constants
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbximktDGKDGG6BSsg92AZdVn4KZIh4ksf4E3kXDwwRgXD9d-Zl1uLEvg6GghGdcuPs/exec'; //exec บันทึกข้อมูล (Database)
    const SHEET_ID = '1WClE8Nicl8enmodKLWkBENPNz_ABQckqQsQN7UK1oQQ'; //SHEET_ID บันทึกข้อมูล (Database)
    const FOLDER_ID = '1CEWlvFURW0X6uRa_uAAPDjyczE5cr329'; //โฟลเดตอร์เก็บเอกสาร
    const BANK_ACCOUNT_SHEET_NAME = 'บัญชีธนาคาร';
    const BALANCE_SHEET_NAME = 'รายงานเงินคงเหลือ';

    // Global variables
    let allData = [];
    let incomeCodes = [];
    let expenseCodes = [];
    let transferCodes = [];
    let withdrawCodes = [];
    let transferData = [];
    let filteredTransferData = [];
    let transferCurrentPage = 1;
    const transferRecordsPerPage = 10;
    let currentPage = 1;
    let recordsPerPage = 10;
    let currentDeleteId = null;
    let currentDeleteType = null;
    let filteredData = [];
    let years = new Set();
    let withdrawData = [];
    let filteredWithdrawData = [];
    let withdrawCurrentPage = 1;
    const withdrawRecordsPerPage = 10;

    // Thai month names
    const thaiMonths = [
      'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
      'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function () {
      initializeDayDropdowns();
      initializeMonthDropdowns();
      setCurrentDateToForms(); // เพิ่มบรรทัดนี้
      setCurrentDateToTransferForm(); // สำหรับฟอร์มโอนเงิน
      loadData(); // โหลดข้อมูลก่อน
      loadIncomeCodes(); // แล้วโหลดรหัสรายรับ
      loadExpenseCodes(); // แล้วโหลดรหัสรายจ่าย
      //loadTransferCodes(); 
      setupEventListeners();
      setupTabNavigation();
    });

    // ตั้งค่าวันที่ปัจจุบันเป็นค่าเริ่มต้น
    function setCurrentDateToForms() {
      try {
        const now = new Date();
        const currentDay = now.getDate();
        const currentMonth = now.getMonth() + 1;
        const currentYear = now.getFullYear() + 543;
        // ตั้งค่ารายรับ
        const incomeDay = document.getElementById('incomeDay');
        const incomeMonth = document.getElementById('incomeMonth');
        const incomeYear = document.getElementById('incomeYear');
        if (incomeDay && incomeMonth && incomeYear) {
          incomeDay.value = currentDay;
          incomeMonth.value = currentMonth;
          incomeYear.value = currentYear;
        }
        // ตั้งค่ารายจ่าย
        const expenseDay = document.getElementById('expenseDay');
        const expenseMonth = document.getElementById('expenseMonth');
        const expenseYear = document.getElementById('expenseYear');

        if (expenseDay && expenseMonth && expenseYear) {
          expenseDay.value = currentDay;
          expenseMonth.value = currentMonth;
          expenseYear.value = currentYear;
        }

        // ตรวจสอบว่ามีวันที่ใน dropdown หรือไม่
        setTimeout(() => {
          if (incomeDay && incomeDay.value === "" && incomeDay.options.length > currentDay) {
            incomeDay.selectedIndex = currentDay; // เลือกวันที่ปัจจุบัน
          }
          if (expenseDay && expenseDay.value === "" && expenseDay.options.length > currentDay) {
            expenseDay.selectedIndex = currentDay;
          }
        }, 100);

      } catch (error) {
        console.error('Error setting current date:', error);
      }
    }
    // Initialize day dropdowns
    function initializeDayDropdowns() {
      const dayDropdowns = [
        document.getElementById('incomeDay'),
        document.getElementById('expenseDay'),
        document.getElementById('transferDay'),
        document.getElementById('withdrawDay')
      ];

      dayDropdowns.forEach(dropdown => {
        if (!dropdown) return;

        // ล้างตัวเลือกเก่า (เก็บเฉพาะตัวเลือกแรกถ้ามี)
        while (dropdown.options.length > 1) {
          dropdown.remove(1);
        }

        // เพิ่มตัวเลือกวันที่ 1-31
        for (let i = 1; i <= 31; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = i;
          dropdown.appendChild(option);
        }
      });
    }

    // Initialize month dropdowns
    function initializeMonthDropdowns() {
      const monthDropdowns = [
        document.getElementById('incomeMonth'),
        document.getElementById('expenseMonth'),
        document.getElementById('filterMonth'),
        document.getElementById('reportMonth'),
        document.getElementById('transferMonth'),
        document.getElementById('withdrawMonth'),
        document.getElementById('withdrawFilterMonth')
      ];

      monthDropdowns.forEach(dropdown => {
        thaiMonths.forEach((month, index) => {
          const option = document.createElement('option');
          option.value = index + 1;
          option.textContent = month;
          dropdown.appendChild(option);
        });
      });
    }

    // Set current year in year inputs
    function setCurrentYear() {
      const currentYear = new Date().getFullYear() + 543; // Convert to Buddhist Era
      document.getElementById('incomeYear').value = currentYear;
      document.getElementById('expenseYear').value = currentYear;
    }

    // Load income codes from Google Sheet
    function loadIncomeCodes() {
      showLoading();
      fetch(`${SCRIPT_URL}?action=getIncomeCodes`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            incomeCodes = data.data;
            const dropdown = document.getElementById('incomeCode');

            // ล้างตัวเลือกเก่า
            while (dropdown.options.length > 1) {
              dropdown.remove(1);
            }

            incomeCodes.forEach(code => {
              const option = document.createElement('option');
              option.value = code.code;
              option.textContent = `${code.code} - ${code.description}`;
              dropdown.appendChild(option);
            });

            // อัปเดต dropdown กรอง
            populateCodeDropdowns();
          } else {
            showError('ไม่สามารถโหลดรหัสรายรับได้');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error loading income codes:', error);
          showError('เกิดข้อผิดพลาดในการโหลดรหัสรายรับ');
          hideLoading();
        });
    }

    function loadExpenseCodes() {
      showLoading();
      fetch(`${SCRIPT_URL}?action=getExpenseCodes`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            expenseCodes = data.data;
            const dropdown = document.getElementById('expenseCode');

            // ล้างตัวเลือกเก่า
            while (dropdown.options.length > 1) {
              dropdown.remove(1);
            }

            expenseCodes.forEach(code => {
              const option = document.createElement('option');
              option.value = code.code;
              option.textContent = `${code.code} - ${code.description}`;
              dropdown.appendChild(option);
            });

            // อัปเดต dropdown กรอง
            populateCodeDropdowns();
          } else {
            showError('ไม่สามารถโหลดรหัสรายจ่ายได้');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error loading expense codes:', error);
          showError('เกิดข้อผิดพลาดในการโหลดรหัสรายจ่าย');
          hideLoading();
        });
    }

    // Load all data from Google Sheet
    function loadData() {
      showLoading();
      fetch(`${SCRIPT_URL}?action=getData`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            allData = data.data;

            // Extract unique years for filters
            years = new Set();
            allData.forEach(item => {
              if (item.year) {
                years.add(parseInt(item.year));
              }
            });

            // เรียกใช้ฟังก์ชันเตรียมข้อมูลปีและเดือน
            populateYearDropdowns(Array.from(years).sort((a, b) => b - a));
            initializeMonthCashReport(); // เรียกฟังก์ชันนี้หลังจากมีข้อมูล

            // เรียกโหลดข้อมูลตัดโอน
            loadWithdrawData();
            setCurrentDateToWithdrawForm();

            // เรียกโหลดรหัสการโอนและข้อมูลโอน
            loadTransferCodes();
            loadTransferData();  // <-- เพิ่มบรรทัดนี้
            loadWithdrawCodes();  // <-- เพิ่มบรรทัดนี้
            loadWithdrawData();   // <-- เพิ่มบรรทัดนี้
            setCurrentDateToTransferForm();
            setCurrentDateToWithdrawForm(); // <-- เพิ่มบรรทัดนี้

            // ตั้งค่าวันที่เริ่มต้นและสิ้นสุดเป็นเดือนปัจจุบัน
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            document.getElementById('startDate').valueAsDate = firstDay;
            document.getElementById('endDate').valueAsDate = lastDay;

            // Apply filters and display data
            applyFilters();
            updateSummary();

          } else {
            showError('ไม่สามารถโหลดข้อมูลได้');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error loading data:', error);
          showError('เกิดข้อผิดพลาดในการโหลดข้อมูล');
          hideLoading();
        });
    }

    // ฟังก์ชันสำหรับโหลดรหัสลงใน dropdown
    function populateCodeDropdowns() {
      const incomeCodeDropdown = document.getElementById('filterIncomeCode');
      const expenseCodeDropdown = document.getElementById('filterExpenseCode');

      // ล้างตัวเลือกเก่า (เก็บเฉพาะตัวเลือก "ทั้งหมด" ไว้)
      while (incomeCodeDropdown.options.length > 1) {
        incomeCodeDropdown.remove(1);
      }
      while (expenseCodeDropdown.options.length > 1) {
        expenseCodeDropdown.remove(1);
      }
      // โหลดรหัสรายรับ
      incomeCodes.forEach(code => {
        const option = document.createElement('option');
        option.value = code.code;
        option.textContent = `${code.code} - ${code.description}`;
        incomeCodeDropdown.appendChild(option);
      });

      // โหลดรหัสรายจ่าย
      expenseCodes.forEach(code => {
        const option = document.createElement('option');
        option.value = code.code;
        option.textContent = `${code.code} - ${code.description}`;
        expenseCodeDropdown.appendChild(option);
      });
    }

    // Populate year dropdowns with available years
    function populateYearDropdowns(years) {
      const yearDropdowns = [
        document.getElementById('filterYear'),
        document.getElementById('reportMonthYear'),
        document.getElementById('reportYear'),
        document.getElementById('yearSelect') // เพิ่ม dropdown ปีของ form1Section
      ];

      yearDropdowns.forEach(dropdown => {
        if (!dropdown) return; // ตรวจสอบว่ามี element นี้จริง

        // ล้างตัวเลือกเก่า
        dropdown.innerHTML = '';
        // สำหรับ dropdown กรองข้อมูล
        if (dropdown.id === 'filterYear') {
          const defaultOption = document.createElement('option');
          defaultOption.value = 'all';
          defaultOption.textContent = 'ทั้งหมด';
          dropdown.appendChild(defaultOption);
        }

        // เพิ่มตัวเลือกปี (เรียงจากใหม่ไปเก่า)
        if (years && years.length > 0) {
          years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            dropdown.appendChild(option);
          });

          // เลือกปีปัจจุบันเป็นค่าเริ่มต้น (ถ้ามี)
          const currentYear = new Date().getFullYear() + 543;
          if (years.includes(currentYear)) {
            dropdown.value = currentYear;
          } else if (years.length > 0) {
            dropdown.value = years[0]; // เลือกปีล่าสุด
          }
        } else {
          // ถ้าไม่มีข้อมูลปี ให้ใช้ปีปัจจุบัน
          const currentYear = new Date().getFullYear() + 543;
          const option = document.createElement('option');
          option.value = currentYear;
          option.textContent = currentYear;
          dropdown.appendChild(option);
          dropdown.value = currentYear;
        }
      });
    }
    // Apply filters to the data
    function applyFilters() {
      const typeFilter = document.getElementById('filterType').value;
      const monthFilter = document.getElementById('filterMonth').value;
      const yearFilter = document.getElementById('filterYear').value;
      const incomeCodeFilter = document.getElementById('filterIncomeCode').value;
      const expenseCodeFilter = document.getElementById('filterExpenseCode').value;

      filteredData = allData.filter(item => {
        if (typeFilter !== 'all' && item.type !== typeFilter) return false;
        if (monthFilter !== 'all' && parseInt(item.month) !== parseInt(monthFilter)) return false;
        if (yearFilter !== 'all' && parseInt(item.year) !== parseInt(yearFilter)) return false;

        // กรองตามรหัสรายรับหรือรายจ่าย
        if (typeFilter === 'income' && incomeCodeFilter !== 'all' && item.code !== incomeCodeFilter) return false;
        if (typeFilter === 'expense' && expenseCodeFilter !== 'all' && item.code !== expenseCodeFilter) return false;

        return true;
      });

      currentPage = 1;
      displayData();
    }

    // Display data in the table
    function displayData() {
      const tableBody = document.getElementById('dataTable');
      tableBody.innerHTML = '';
      if (filteredData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
                    <td colspan="7" class="px-4 py-3 text-center text-gray-500">ไม่พบข้อมูล</td>
                `;
        tableBody.appendChild(row);

        updatePagination(0, 0, 0);
        return;
      }

      const startIndex = (currentPage - 1) * recordsPerPage;
      const endIndex = Math.min(startIndex + recordsPerPage, filteredData.length);
      const pageData = filteredData.slice(startIndex, endIndex);

      pageData.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';

        const date = `${item.day} ${thaiMonths[parseInt(item.month) - 1]} ${item.year}`;
        const amountClass = item.type === 'income' ? 'income' : 'expense';
        const formattedAmount = parseFloat(item.amount).toLocaleString('th-TH', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });

        row.innerHTML = `
                    <td class="px-4 py-3">${date}</td>
                    <td class="px-4 py-3">${item.docNo || '-'}</td>
                    <td class="px-4 py-3">${item.description}</td>
                    <td class="px-4 py-3">${item.code || '-'}</td>
                    <td class="px-4 py-3 text-right ${amountClass}">${formattedAmount}</td>
                    <td class="px-4 py-3 text-center">
                        ${item.imageUrl ?
            `<button class="view-image text-blue-600 hover:text-blue-800" data-url="${item.imageUrl}">
                                <i class="fas fa-image"></i>
                            </button>` :
            '<span class="text-gray-400">-</span>'
          }
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button class="edit-item text-blue-600 hover:text-blue-800 mx-1" data-id="${item.id}" data-type="${item.type}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-item text-red-600 hover:text-red-800 mx-1" data-id="${item.id}" data-type="${item.type}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
        tableBody.appendChild(row);
      });
      updatePagination(startIndex + 1, endIndex, filteredData.length);
      // Add event listeners to the buttons
      document.querySelectorAll('.view-image').forEach(button => {
        button.addEventListener('click', function () {
          const imageUrl = this.getAttribute('data-url');
          openImageModal(imageUrl);
        });
      });
      document.querySelectorAll('.edit-item').forEach(button => {
        button.addEventListener('click', function () {
          const id = this.getAttribute('data-id');
          const type = this.getAttribute('data-type');
          editItem(id, type);
        });
      });
      document.querySelectorAll('.delete-item').forEach(button => {
        button.addEventListener('click', function () {
          const id = this.getAttribute('data-id');
          const type = this.getAttribute('data-type');
          openDeleteModal(id, type);
        });
      });
    }

    // Update pagination controls
    function updatePagination(start, end, total) {
      document.getElementById('startRecord').textContent = total > 0 ? start : 0;
      document.getElementById('endRecord').textContent = end;
      document.getElementById('totalRecords').textContent = total;
      document.getElementById('currentPage').textContent = currentPage;

      const totalPages = Math.ceil(total / recordsPerPage);
      document.getElementById('prevPage').disabled = currentPage <= 1;
      document.getElementById('nextPage').disabled = currentPage >= totalPages;
    }

    // Update financial summary
    function updateSummary() {
      let totalIncome = 0;
      let totalExpense = 0;

      allData.forEach(item => {
        const amount = parseFloat(item.amount) || 0;
        if (item.type === 'income') {
          totalIncome += amount;
        } else if (item.type === 'expense') {
          totalExpense += amount;
        }
      });

      const balance = totalIncome - totalExpense;

      document.getElementById('totalIncome').textContent = totalIncome.toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + ' บาท';

      document.getElementById('totalExpense').textContent = totalExpense.toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + ' บาท';

      document.getElementById('balance').textContent = balance.toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + ' บาท';
    }

    // Handle file input change for image upload
    function handleFileInputChange(event, previewId, base64Id, nameId, typeId) {
      const file = event.target.files[0];
      if (!file) return;
      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showError('ขนาดไฟล์ต้องไม่เกิน 5MB');
        event.target.value = '';
        return;
      }
      // Check file type
      if (!file.type.match('image.*')) {
        showError('กรุณาเลือกไฟล์รูปภาพเท่านั้น');
        event.target.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        const base64String = e.target.result;
        document.getElementById(base64Id).value = base64String;
        document.getElementById(nameId).value = file.name;
        document.getElementById(typeId).value = file.type;

        const preview = document.getElementById(previewId);
        preview.innerHTML = '';
        preview.style.backgroundImage = `url(${base64String})`;
      };
      reader.readAsDataURL(file);
    }

    // Submit form data
    function submitForm(formId, type) {
      const form = document.getElementById(formId);
      const formData = new FormData(form);
      const id = formData.get('id');

      // Create URL parameters
      const params = new URLSearchParams();
      params.append('action', id ? 'updateData' : 'addData');
      params.append('type', type);
      params.append('sheetId', SHEET_ID);
      params.append('folderId', FOLDER_ID);
      // Add form data to parameters
      for (const [key, value] of formData.entries()) {
        params.append(key, value);
      }
      showLoading();
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: params
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'สำเร็จ',
              text: id ? 'อัปเดตข้อมูลเรียบร้อยแล้ว' : 'บันทึกข้อมูลเรียบร้อยแล้ว',
              confirmButtonText: 'ตกลง',
              confirmButtonColor: '#4f46e5'
            });
            resetForm(formId);
            loadData();
          } else {
            showError(data.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error submitting form:', error);
          showError('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
          hideLoading();
        });
    }

    // Reset form fields
    // แก้ไขฟังก์ชัน resetForm
    function resetForm(formId) {
      const form = document.getElementById(formId);
      form.reset();

      // รีเซ็ตวันที่เป็นปัจจุบันเมื่อล้างฟอร์ม
      if (formId === 'incomeForm' || formId === 'expenseForm') {
        setCurrentDateToForms();
      } else if (formId === 'transferForm') {
        setCurrentDateToTransferForm();
      } else if (formId === 'withdrawForm') { // <-- เพิ่มเงื่อนไขนี้
        setCurrentDateToWithdrawForm();
      }

      // Reset hidden fields
      form.querySelector('input[name="id"]').value = '';
      form.querySelector('input[name="imageBase64"]').value = '';
      form.querySelector('input[name="imageName"]').value = '';
      form.querySelector('input[name="imageType"]').value = '';
      form.querySelector('input[name="imageUrl"]').value = '';

      // Reset image preview
      let previewId;
      if (formId === 'incomeForm') {
        previewId = 'incomeImagePreview';
      } else if (formId === 'expenseForm') {
        previewId = 'expenseImagePreview';
      } else if (formId === 'transferForm') {
        previewId = 'transferImagePreview';
      } else if (formId === 'withdrawForm') { // <-- เพิ่มเงื่อนไขนี้
        previewId = 'withdrawImagePreview';
      }
      const preview = document.getElementById(previewId);
      if (preview) {
        preview.style.backgroundImage = '';
        preview.innerHTML = '<i class="fas fa-image text-gray-400 text-4xl"></i>';
      }
      // Set current year
      if (formId === 'incomeForm') {
        document.getElementById('incomeYear').value = new Date().getFullYear() + 543;
      } else if (formId === 'expenseForm') {
        document.getElementById('expenseYear').value = new Date().getFullYear() + 543;
      } else if (formId === 'transferForm') {
        document.getElementById('transferYear').value = new Date().getFullYear() + 543;
      } else if (formId === 'withdrawForm') { // <-- เพิ่มเงื่อนไขนี้
        document.getElementById('withdrawYear').value = new Date().getFullYear() + 543;
      }
    }

    // Edit item
    function editItem(id, type) {
      const item = allData.find(item => item.id === id);
      if (!item) return;
      // Switch to form tab
      document.getElementById('formTab').click();
      const formId = type === 'income' ? 'incomeForm' : 'expenseForm';
      const form = document.getElementById(formId);
      // Fill form fields
      form.querySelector('input[name="id"]').value = item.id;
      form.querySelector('select[name="day"]').value = item.day;
      form.querySelector('select[name="month"]').value = item.month;
      form.querySelector('input[name="year"]').value = item.year;
      form.querySelector('input[name="docNo"]').value = item.docNo || '';
      form.querySelector('input[name="description"]').value = item.description || '';
      form.querySelector('select[name="code"]').value = item.code || '';
      form.querySelector('input[name="amount"]').value = item.amount || '';
      form.querySelector('input[name="imageUrl"]').value = item.imageUrl || '';
      // Update image preview if available
      const previewId = type === 'income' ? 'incomeImagePreview' : 'expenseImagePreview';
      const preview = document.getElementById(previewId);
      if (item.imageUrl) {
        preview.innerHTML = '';
        preview.style.backgroundImage = `url(${item.imageUrl})`;
      } else {
        preview.style.backgroundImage = '';
        preview.innerHTML = '<i class="fas fa-image text-gray-400 text-4xl"></i>';
      }
    }

    // แก้ไขฟังก์ชันเปิด modal ลบข้อมูลปกติ
    // แก้ไขฟังก์ชันเปิด modal ลบข้อมูลปกติ
    function openDeleteModal(id, type) {
      currentDeleteId = id;
      currentDeleteType = type;
      document.getElementById('deleteModal').style.display = 'block';
      // ตั้งค่าข้อความใน modal ตามประเภท
      const modalTitle = document.querySelector('#deleteModal h3');
      const modalMessage = document.querySelector('#deleteModal p');
      if (type === 'income') {
        modalTitle.textContent = 'ยืนยันการลบข้อมูลรายรับ';
        modalMessage.textContent = 'คุณต้องการลบข้อมูลรายรับนี้ใช่หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้';
      } else if (type === 'expense') {
        modalTitle.textContent = 'ยืนยันการลบข้อมูลรายจ่าย';
        modalMessage.textContent = 'คุณต้องการลบข้อมูลรายจ่ายนี้ใช่หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้';
      } else if (type === null) {
        // สำหรับการลบข้อมูลโอนหรือตัดโอน
        modalTitle.textContent = 'ยืนยันการลบข้อมูลการโอน';
        modalMessage.textContent = 'คุณต้องการลบข้อมูลการโอนนี้ใช่หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้';
      } else {
        modalTitle.textContent = 'ยืนยันการลบข้อมูล';
        modalMessage.textContent = 'คุณต้องการลบข้อมูลนี้ใช่หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้';
      }
    }

    // Close delete confirmation modal
    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      currentDeleteId = null;
      currentDeleteType = null;
    }

    // แก้ไขฟังก์ชันลบข้อมูล
    // แก้ไขฟังก์ชันลบข้อมูล
    function deleteItem() {
      if (!currentDeleteId) return;
      const params = new URLSearchParams();
      // ตรวจสอบว่าเป็นการลบข้อมูลประเภทไหน
      if (currentDeleteType === 'income' || currentDeleteType === 'expense') {
        // ลบข้อมูลปกติ (รายรับ/รายจ่าย)
        params.append('action', 'deleteData');
        params.append('type', currentDeleteType);
      } else if (currentDeleteType === null) {
        // ตรวจสอบว่าเป็นการลบข้อมูลโอนเข้าหรือตัดโอนออก
        // โดยตรวจสอบจากข้อมูลที่มีอยู่ใน transferData หรือ withdrawData
        const isTransferItem = transferData.some(item => item.id === currentDeleteId);
        const isWithdrawItem = withdrawData.some(item => item.id === currentDeleteId);
        if (isTransferItem) {
          params.append('action', 'deleteTransferData');
        } else if (isWithdrawItem) {
          params.append('action', 'deleteWithdrawData');
        } else {
          showError('ไม่พบข้อมูลที่ต้องการลบ');
          closeDeleteModal();
          return;
        }
      } else {
        showError('ประเภทข้อมูลไม่ถูกต้อง');
        closeDeleteModal();
        return;
      }
      params.append('id', currentDeleteId);
      showLoading();
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: params
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'สำเร็จ',
              text: getDeleteSuccessMessage(currentDeleteType),
              confirmButtonText: 'ตกลง',
              confirmButtonColor: '#4f46e5'
            });

            // โหลดข้อมูลใหม่ตามประเภท
            if (currentDeleteType === 'income' || currentDeleteType === 'expense') {
              loadData(); // โหลดข้อมูลปกติ
            } else if (currentDeleteType === null) {
              const isTransferItem = transferData.some(item => item.id === currentDeleteId);
              const isWithdrawItem = withdrawData.some(item => item.id === currentDeleteId);

              if (isTransferItem) {
                loadTransferData(); // โหลดข้อมูลโอน
              } else if (isWithdrawItem) {
                loadWithdrawData(); // โหลดข้อมูลตัดโอน
              }
            }
          } else {
            showError(data.message || 'เกิดข้อผิดพลาดในการลบข้อมูล');
          }
          closeDeleteModal();
          hideLoading();
        })
        .catch(error => {
          console.error('Error deleting item:', error);
          showError('เกิดข้อผิดพลาดในการลบข้อมูล');
          closeDeleteModal();
          hideLoading();
        });
    }

    // ฟังก์ชันช่วยเหลือสำหรับข้อความสำเร็จ
    function getDeleteSuccessMessage(type) {
      if (type === 'income') return 'ลบข้อมูลรายรับเรียบร้อยแล้ว';
      if (type === 'expense') return 'ลบข้อมูลรายจ่ายเรียบร้อยแล้ว';
      // ตรวจสอบว่าเป็นการลบข้อมูลโอนเข้าหรือตัดโอนออก
      const isTransferItem = transferData.some(item => item.id === currentDeleteId);
      const isWithdrawItem = withdrawData.some(item => item.id === currentDeleteId);
      if (isTransferItem) return 'ลบข้อมูลการโอนเข้าบัญชีเรียบร้อยแล้ว';
      if (isWithdrawItem) return 'ลบข้อมูลการตัดโอนจากบัญชีเรียบร้อยแล้ว';
      return 'ลบข้อมูลเรียบร้อยแล้ว';
    }
    // Open image modal
    function openImageModal(imageUrl) {
      document.getElementById('modalImage').src = imageUrl;
      document.getElementById('imageModal').style.display = 'block';
    }
    // Close image modal
    function closeImageModal() {
      document.getElementById('imageModal').style.display = 'none';
    }
    // Generate Excel report
    function generateReport(type, period, value) {
      showLoading();
      // Filter data based on report type
      let reportData = [];
      if (type === 'monthly') {
        reportData = allData.filter(item =>
          parseInt(item.month) === parseInt(period) &&
          parseInt(item.year) === parseInt(value)
        );
      } else if (type === 'yearly') {
        reportData = allData.filter(item =>
          parseInt(item.year) === parseInt(value)
        );
      }
      if (reportData.length === 0) {
        showError('ไม่พบข้อมูลสำหรับรายงานนี้');
        hideLoading();
        return;
      }
      // Sort data by date
      reportData.sort((a, b) => {
        if (parseInt(a.year) !== parseInt(b.year)) {
          return parseInt(a.year) - parseInt(b.year);
        }
        if (parseInt(a.month) !== parseInt(b.month)) {
          return parseInt(a.month) - parseInt(b.month);
        }
        return parseInt(a.day) - parseInt(b.day);
      });
      // Prepare data for Excel
      const excelData = [];

      // Add header row
      excelData.push([
        'วันที่', 'เลขที่เอกสาร', 'รายการ', 'รหัส', 'รายรับ', 'รายจ่าย', 'คงเหลือ']);
      // Add data rows
      let balance = 0;
      reportData.forEach(item => {
        const date = `${item.day}/${item.month}/${item.year}`;
        const amount = parseFloat(item.amount) || 0;

        if (item.type === 'income') {
          balance += amount;
          excelData.push([
            date, item.docNo || '', item.description, item.code || '', amount.toFixed(2), '', balance.toFixed(2)
          ]);
        } else {
          balance -= amount;
          excelData.push([
            date, item.docNo || '', item.description, item.code || '', '', amount.toFixed(2), balance.toFixed(2)
          ]);
        }
      });


      // Add summary row
      const totalIncome = reportData
        .filter(item => item.type === 'income')
        .reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
      const totalExpense = reportData
        .filter(item => item.type === 'expense')
        .reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
      excelData.push([
        'รวม', '', '', '', totalIncome.toFixed(2), totalExpense.toFixed(2), balance.toFixed(2)
      ]);
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      // Set column widths
      const colWidths = [
        { wch: 15 }, // วันที่
        { wch: 15 }, // เลขที่เอกสาร
        { wch: 30 }, // รายการ
        { wch: 10 }, // รหัส
        { wch: 15 }, // รายรับ
        { wch: 15 }, // รายจ่าย
        { wch: 15 }  // คงเหลือ
      ];
      ws['!cols'] = colWidths;
      // Create workbook
      const wb = XLSX.utils.book_new();
      // Generate report title
      let reportTitle = '';
      if (type === 'monthly') {
        reportTitle = `รายงานประจำเดือน${thaiMonths[period - 1]} ${value}`;
      } else {
        reportTitle = `รายงานประจำปี ${value}`;
      }
      XLSX.utils.book_append_sheet(wb, ws, reportTitle);
      // Generate Excel file
      XLSX.writeFile(wb, `${reportTitle}.xlsx`);
      hideLoading();
    }
    // Show loading overlay
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }
    // Hide loading overlay
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
    // Show error message using SweetAlert
    function showError(message) {
      Swal.fire({
        icon: 'error',
        title: 'ข้อผิดพลาด',
        text: message,
        confirmButtonText: 'ตกลง',
        confirmButtonColor: '#4f46e5'
      });
    }


    // Setup tab navigation
    function setupTabNavigation() {
      const tabs = {
        'formTab': 'formSection',
        'dataTab': 'dataSection',
        'reportTab': 'reportSection',
        'form3Tab': 'form3Section',
        'form4Tab': 'form4Section',
        'form5Tab': 'form5Section',
        'form1Tab': 'form1Section', // เพิ่มแท็บ form1Section
        'bankAccountTab': 'bankAccountSection', // เพิ่มแท็บ บัญชีธนาคาร
        'balanceSummaryTab': 'balanceSummarySection', // เพิ่มแท็บ รายงานเงินคงเหลือ
        'transferTab': 'transferSection',
        'transferDataTab': 'transferDataSection',
        'withdrawTab': 'withdrawSection',
        'withdrawDataTab': 'withdrawDataSection'
      };


      Object.keys(tabs).forEach(tabId => {
        document.getElementById(tabId).addEventListener('click', function () {
          // Hide all sections
          Object.values(tabs).forEach(sectionId => {
            document.getElementById(sectionId).style.display = 'none';
          });
          // Remove active class from all tabs
          document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('tab-active');
          });
          // Show selected section and activate tab
          document.getElementById(tabs[tabId]).style.display = 'block';
          // เปิดแท็บหลักด้วยถ้าเป็นรายงานย่อย
          if (tabId !== 'formTab' && tabId !== 'dataTab') {
            document.getElementById('reportsMainTab').classList.add('tab-active');
          } else {
            this.classList.add('tab-active');
          }
          // เพิ่มโค้ดนี้สำหรับการรีเฟรชข้อมูลเมื่อคลิกแท็บ form1Tab
          if (tabId === 'form1Tab') {
            initializeMonthCashReport(); // รีเฟรชข้อมูลปีเมื่อเปิดแท็บ
          }
        });
      });
      // เพิ่มการจัดการคลิกที่แท็บหลัก
      document.getElementById('reportsMainTab').addEventListener('click', function () {
        // ไม่ต้องทำอะไรเมื่อคลิกแท็บหลัก เพราะมีเมนูย่อยแล้ว
      });
    }

    // Setup all event listeners
    function setupEventListeners() {
      // Form submissions
      document.getElementById('incomeForm').addEventListener('submit', function (e) {
        e.preventDefault();
        submitForm('incomeForm', 'income');
      });
      document.getElementById('expenseForm').addEventListener('submit', function (e) {
        e.preventDefault();
        submitForm('expenseForm', 'expense');
      });

      // เพิ่ม event listeners สำหรับ withdraw form
      document.getElementById('withdrawForm').addEventListener('submit', function (e) {
        e.preventDefault();
        submitWithdrawForm();
      });

      document.getElementById('withdrawImage').addEventListener('change', function (e) {
        handleFileInputChange(e, 'withdrawImagePreview', 'withdrawImageBase64', 'withdrawImageName', 'withdrawImageType');
      });

      document.getElementById('resetWithdrawForm').addEventListener('click', function () {
        resetForm('withdrawForm');
      });
      // Reset form buttons
      document.getElementById('resetIncomeForm').addEventListener('click', function () {
        resetForm('incomeForm');
      });
      document.getElementById('resetExpenseForm').addEventListener('click', function () {
        resetForm('expenseForm');
      });

      // File input change events
      document.getElementById('incomeImage').addEventListener('change', function (e) {
        handleFileInputChange(e, 'incomeImagePreview', 'incomeImageBase64', 'incomeImageName', 'incomeImageType');
      });

      document.getElementById('expenseImage').addEventListener('change', function (e) {
        handleFileInputChange(e, 'expenseImagePreview', 'expenseImageBase64', 'expenseImageName', 'expenseImageType');
      });

      // Filter controls
      document.getElementById('applyFilter').addEventListener('click', function () {
        applyFilters();
      });

      document.getElementById('generateIncomeReport').addEventListener('click', generateIncomeReport);
      document.getElementById('generateExpenseReport').addEventListener('click', generateExpenseReport);
      document.getElementById('resetFilter').addEventListener('click', function () {
        document.getElementById('filterType').value = 'all';
        document.getElementById('filterMonth').value = 'all';
        document.getElementById('filterYear').value = 'all';
        document.getElementById('filterIncomeCode').value = 'all';
        document.getElementById('filterExpenseCode').value = 'all';
        document.getElementById('incomeCodeFilterContainer').style.display = 'none';
        document.getElementById('expenseCodeFilterContainer').style.display = 'none';
        applyFilters();
      });

      // เมื่อเปลี่ยนประเภท ให้แสดง dropdown รหัสที่เกี่ยวข้อง
      document.getElementById('filterType').addEventListener('change', function () {
        const type = this.value;
        document.getElementById('incomeCodeFilterContainer').style.display =
          type === 'income' ? 'flex' : 'none';
        document.getElementById('expenseCodeFilterContainer').style.display =
          type === 'expense' ? 'flex' : 'none';

        // รีเซ็ตรหัสเมื่อเปลี่ยนประเภท
        document.getElementById('filterIncomeCode').value = 'all';
        document.getElementById('filterExpenseCode').value = 'all';
      });

      // Pagination controls
      document.getElementById('prevPage').addEventListener('click', function () {
        if (currentPage > 1) {
          currentPage--;
          displayData();
        }
      });
      document.getElementById('nextPage').addEventListener('click', function () {
        const totalPages = Math.ceil(filteredData.length / recordsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          displayData();
        }
      });

      // Delete modal controls
      document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
      document.getElementById('confirmDelete').addEventListener('click', deleteItem);
      // Image modal controls
      document.getElementById('closeImageModal').addEventListener('click', closeImageModal);
      // Report generation
      document.getElementById('generateMonthlyReport').addEventListener('click', function () {
        const month = document.getElementById('reportMonth').value;
        const year = document.getElementById('reportMonthYear').value;
        if (!month || !year) {
          showError('กรุณาเลือกเดือนและปีที่ต้องการสร้างรายงาน');
          return;
        }
        generateReport('monthly', month, year);
      });
      document.getElementById('generateYearlyReport').addEventListener('click', function () {
        const year = document.getElementById('reportYear').value;
        if (!year) {
          showError('กรุณาเลือกปีที่ต้องการสร้างรายงาน');
          return;
        }
        generateReport('yearly', null, year);
      });

      // Tab navigation
      setupTabNavigation();
      // อัพเดทวันที่และเวลา
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // สำหรับบัญชีธนาคาร
      document.getElementById('refreshBankAccounts').addEventListener('click', loadBankAccounts);
      document.getElementById('exportBankAccounts').addEventListener('click', exportBankAccountsToExcel);
      document.getElementById('bankAccountTab').addEventListener('click', loadBankAccounts);

      // สำหรับรายงานเงินคงเหลือ
      document.getElementById('balanceSummaryTab').addEventListener('click', loadBalanceSummary);
      document.getElementById('refreshBalanceSummary').addEventListener('click', loadBalanceSummary);
      document.getElementById('printBalanceSummary').addEventListener('click', printBalanceSummary);
      document.getElementById('exportBalanceSummary').addEventListener('click', exportBalanceSummaryToExcel);
      document.getElementById('transferForm').addEventListener('submit', function (e) {
        e.preventDefault();
        submitTransferForm();
      });

      document.getElementById('transferImage').addEventListener('change', function (e) {
        handleFileInputChange(e, 'transferImagePreview', 'transferImageBase64', 'transferImageName', 'transferImageType');
      });

      // ในส่วน setupEventListeners()
      document.getElementById('resetTransferForm').addEventListener('click', function () {
        resetForm('transferForm');
      });

      // สำหรับแท็บจัดการข้อมูลโอน
      document.getElementById('applyTransferFilter').addEventListener('click', applyTransferFilters);
      document.getElementById('resetTransferFilter').addEventListener('click', function () {
        document.getElementById('transferFilterMonth').value = 'all';
        document.getElementById('transferFilterYear').value = 'all';
        applyTransferFilters();
      });

      document.getElementById('transferPrevPage').addEventListener('click', function () {
        if (transferCurrentPage > 1) {
          transferCurrentPage--;
          displayTransferData();
        }
      });

      document.getElementById('transferNextPage').addEventListener('click', function () {
        const totalPages = Math.ceil(filteredTransferData.length / transferRecordsPerPage);
        if (transferCurrentPage < totalPages) {
          transferCurrentPage++;
          displayTransferData();
        }
      });



      // สำหรับแท็บจัดการข้อมูลตัดโอน
      document.getElementById('applyWithdrawFilter').addEventListener('click', applyWithdrawFilters);
      document.getElementById('resetWithdrawFilter').addEventListener('click', function () {
        document.getElementById('withdrawFilterMonth').value = 'all';
        document.getElementById('withdrawFilterYear').value = 'all';
        applyWithdrawFilters();
      });

      document.getElementById('withdrawPrevPage').addEventListener('click', function () {
        if (withdrawCurrentPage > 1) {
          withdrawCurrentPage--;
          displayWithdrawData();
        }
      });

      document.getElementById('withdrawNextPage').addEventListener('click', function () {
        const totalPages = Math.ceil(filteredWithdrawData.length / withdrawRecordsPerPage);
        if (withdrawCurrentPage < totalPages) {
          withdrawCurrentPage++;
          displayWithdrawData();
        }
      });






      document.getElementById('homeButton').addEventListener('click', function () {
        window.open(
          'https://script.google.com/macros/s/AKfycbwFA6jhJouZR13riKKscAXx1t7SxPwyTaObHV9rDPvemu_GKyEsE8SOEeWHxHtUsw/exec', //exec แบบที่ 3 + Login
          '_self',
          'noopener,noreferrer' // เพิ่มเพื่อความปลอดภัย
        );

        // ปิดหน้าปัจจุบันหลังจากเปิดลิงก์ใหม่ (optional)
        // window.close(); // หมายเหตุ: ทำงานได้เฉพาะหน้าต่างที่เปิดด้วย script เท่านั้น
      });
    }

    // อัพเดทวันที่และเวลา
    function updateDateTime() {
      const now = new Date();
      const thaiMonths = [
        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน',
        'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม',
        'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
      ];
      const thaiDays = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'];

      const day = thaiDays[now.getDay()];
      const date = now.getDate();
      const month = thaiMonths[now.getMonth()];
      const year = now.getFullYear() + 543;
      const time = now.toLocaleTimeString('th-TH');

      document.getElementById('currentDate').textContent = `วัน${day} ที่ ${date} ${month} ${year}`;
      document.getElementById('currentTime').textContent = time + ' น.';
    }

    // อัพเดททุก 1 วินาที
    updateDateTime();
    setInterval(updateDateTime, 1000);









    //แบบที่ 3
    // ฟังก์ชันสร้างรายงานแยกประเภทรายรับ
    function generateIncomeReport() {
      const startDateInput = document.getElementById('incomeStartDate').value;
      const endDateInput = document.getElementById('incomeEndDate').value;

      // ตรวจสอบการเลือกวันที่
      if (!startDateInput || !endDateInput) {
        showError('กรุณาเลือกวันที่เริ่มต้นและวันที่สิ้นสุด');
        return;
      }

      const startDate = new Date(startDateInput);
      const endDate = new Date(endDateInput);

      if (startDate > endDate) {
        showError('วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด');
        return;
      }

      showLoading();

      // กรองข้อมูลรายรับตามช่วงวันที่ (แก้ไขส่วนนี้)
      const filteredIncomeData = allData.filter(item => {
        if (item.type !== 'income') return false;

        const itemDate = parseThaiDate(`${item.day} ${thaiMonths[parseInt(item.month) - 1]} ${item.year}`);

        // ตั้งเวลา startDate เป็น 00:00:00 และ endDate เป็น 23:59:59
        const adjustedStartDate = new Date(startDate);
        adjustedStartDate.setHours(0, 0, 0, 0);

        const adjustedEndDate = new Date(endDate);
        adjustedEndDate.setHours(23, 59, 59, 999);

        return itemDate >= adjustedStartDate && itemDate <= adjustedEndDate;
      });

      if (filteredIncomeData.length === 0) {
        hideLoading();
        showError('ไม่พบข้อมูลรายรับในช่วงวันที่ที่เลือก');
        return;
      }

      // สรุปยอดตามรหัสรายรับ
      const incomeSummary = {};
      let totalIncome = 0;

      filteredIncomeData.forEach(item => {
        const amount = parseFloat(item.amount) || 0;
        incomeSummary[item.code] = incomeSummary[item.code] || {
          description: incomeCodes.find(c => c.code === item.code)?.description || 'ไม่ทราบรายการ',
          total: 0,
          transactions: []
        };

        incomeSummary[item.code].total += amount;
        incomeSummary[item.code].transactions.push(item);
        totalIncome += amount;
      });

      // สร้าง HTML สำหรับแสดงผล
      let html = `
    <div class="bg-white p-4 rounded-lg shadow">
      <h4 class="text-lg font-semibold mb-4">สรุปสมุดแยกประเภทรายรับ วันที่ ${formatDateForDisplay(startDate)} ถึง ${formatDateForDisplay(endDate)}</h4>
      
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg overflow-hidden mb-6">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left">รหัส</th>
              <th class="px-4 py-2 text-left">รายการ</th>
              <th class="px-4 py-2 text-right">จำนวนเงิน (บาท)</th>
            </tr>
          </thead>
          <tbody>
  `;

      // แสดงสรุปตามรหัส
      Object.keys(incomeSummary).sort().forEach(code => {
        const { description, total } = incomeSummary[code];
        html += `
      <tr class="border-b hover:bg-gray-50">
        <td class="px-4 py-2">${code}</td>
        <td class="px-4 py-2">${description}</td>
        <td class="px-4 py-2 text-right income">${formatCurrency(total)}</td>
      </tr>
    `;
      });

      html += `
          </tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="2" class="px-4 py-2 font-semibold text-right">รวมรายรับทั้งหมด</td>
              <td class="px-4 py-2 text-right font-semibold income">${formatCurrency(totalIncome)}</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- แสดงรายละเอียดแต่ละรหัส -->
      ${generateIncomeDetails(incomeSummary)}

      <!-- Certification section -->
      <div class="mt-8 text-center">
        <p class="mb-8 font-medium">รับรองข้อมูลตามนี้</p>
        
        <div class="flex justify-between mt-6">
          <!-- Left signature (Accountant) -->
          <div class="w-1/2 text-center">
            <div class="mb-2">(  <?!= settings['ชื่อผู้จัดทำบัญชี'] ?> )</div>
            <div class="mb-2">ตำแหน่ง..........................................................</div>
            <div class="mb-2">ผู้จัดทำบัญชี</div>
            <div>วันที่......./................./............</div>           
          </div>

          <br><br><br>

          <!-- Right signature (Auditor) -->
          <div class="w-1/2 text-center">
            <div class="mb-2">(  <?!= settings['ชื่อเจ้าอาวาส'] ?> )</div>
            <div class="mb-2">ตำแหน่ง.........................................................</div>
            <div class="mb-2">ผู้ตรวจสอบบัญชี</div>
            <div>วันที่......./................../...........</div>
          </div>
        </div>
      </div>
    </div>


      <div class="flex justify-between mt-4">
        <button id="printIncomeReport" class="btn-primary text-white px-4 py-2 rounded-md">
          <i class="fas fa-print mr-2"></i>พิมพ์รายงาน
        </button>
        <button id="exportIncomeExcel" class="btn-success text-white px-4 py-2 rounded-md">
          <i class="fas fa-file-excel mr-2"></i>Export เป็น Excel
        </button>
      </div>
    </div>
  `;

      // แสดงผลลัพธ์
      const resultDiv = document.getElementById('incomeReportResult');
      resultDiv.innerHTML = html;
      resultDiv.classList.remove('hidden');

      // เพิ่ม Event Listeners สำหรับปุ่มพิมพ์และ Export
      document.getElementById('printIncomeReport').addEventListener('click', () => printIncomeReport(incomeSummary, startDate, endDate));
      document.getElementById('exportIncomeExcel').addEventListener('click', () => exportIncomeToExcel(incomeSummary, totalIncome, startDateInput, endDateInput));

      hideLoading();
    }

    // ฟังก์ชันสร้างรายละเอียดแต่ละรหัส
    function generateIncomeDetails(incomeSummary) {
      let html = '';

      Object.keys(incomeSummary).sort().forEach(code => {
        const { description, total, transactions } = incomeSummary[code];

        html += `
      <div class="mb-8">
        <h5 class="text-md font-semibold mb-2">รหัส ${code} - ${description} (รวม ${formatCurrency(total)})</h5>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg overflow-hidden mb-4">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left">วันที่</th>
                <th class="px-4 py-2 text-left">เลขที่เอกสาร</th>
                <th class="px-4 py-2 text-left">รายละเอียด</th>
                <th class="px-4 py-2 text-right">จำนวนเงิน (บาท)</th>
              </tr>
            </thead>
            <tbody>
    `;

        transactions.forEach(transaction => {
          const date = `${transaction.day} ${thaiMonths[parseInt(transaction.month) - 1]} ${transaction.year}`;
          html += `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2">${date}</td>
          <td class="px-4 py-2">${transaction.docNo || '-'}</td>
          <td class="px-4 py-2">${transaction.description}</td>
          <td class="px-4 py-2 text-right income">${formatCurrency(parseFloat(transaction.amount))}</td>
        </tr>
      `;
        });

        html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
      });

      return html;
    }

    // ฟังก์ชันพิมพ์รายงาน
    // แบบที่ 3 - รายงานแยกประเภทรายการรับ
    function printIncomeReport(incomeSummary, startDate, endDate) {
      const printWindow = window.open('', '_blank');
      const printContent = document.getElementById('incomeReportResult').innerHTML;
      // Remove all buttons from the print content before printing
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = printContent;
      tempDiv.querySelectorAll('button').forEach(btn => btn.remove());
      const cleanedContent = tempDiv.innerHTML;
      printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>รายงานแยกประเภทรายการรับ</title>
      <style>
        body { font-family: 'Sarabun', sans-serif; padding: 20px; }
        h4, h5 { text-align: center; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .income { color: #28a745; font-weight: bold; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .code-detail { margin-bottom: 30px; }
        .w-full { width: 100%; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .mt-8 { margin-top: 2rem; }
        .mb-8 { margin-bottom: 2rem; }
        .signature { text-align: center; margin-top: 50px; }
        .text-center { text-align: center; }
      </style>
    </head>
    <body>
      <h4>สรุปสมุดแยกประเภทรายการรับ</h4>
      <h5>วันที่ ${formatDateForDisplay(startDate)} ถึง ${formatDateForDisplay(endDate)}</h5>
      <div>
        ${cleanedContent}
      </div>
    </body>
    </html>
  `);

      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }

    // ฟังก์ชัน Export เป็น Excel
    function exportIncomeToExcel(incomeSummary, totalIncome, startDate, endDate) {
      // สร้างข้อมูลสำหรับ Excel
      const excelData = [
        ['สรุปสมุดแยกประเภทรายรับ'],
        [`วันที่ ${formatDateForExport(startDate)} ถึง ${formatDateForExport(endDate)}`],
        [],
        ['รหัส', 'รายการ', 'จำนวนเงิน (บาท)']
      ];

      // เพิ่มข้อมูลสรุป
      Object.keys(incomeSummary).sort().forEach(code => {
        const { description, total } = incomeSummary[code];
        excelData.push([code, description, total]);
      });

      excelData.push(['รวมรายรับทั้งหมด', '', totalIncome]);
      excelData.push([], [], ['รายละเอียดรายการ'], []);

      // เพิ่มข้อมูลรายละเอียดแต่ละรหัส
      Object.keys(incomeSummary).sort().forEach(code => {
        const { description, total, transactions } = incomeSummary[code];

        excelData.push([`รหัส ${code} - ${description}`, `รวม ${formatCurrency(total)}`]);
        excelData.push(['วันที่', 'เลขที่เอกสาร', 'รายละเอียด', 'จำนวนเงิน (บาท)']);

        transactions.forEach(transaction => {
          const date = `${transaction.day}/${transaction.month}/${transaction.year}`;
          excelData.push([date, transaction.docNo || '-', transaction.description, transaction.amount]);
        });

        excelData.push([]);
      });


      // เพิ่มส่วนรับรองข้อมูล
      excelData.push([], [], ['รับรองข้อมูลตามนี้'], []);
      excelData.push(['(  <?!= settings['ชื่อผู้จัดทำบัญชี'] ?> )', '(  <?!= settings['ชื่อเจ้าอาวาส'] ?> )']);
      excelData.push(['ตำแหน่ง...................................', 'ตำแหน่ง...................................']);
      excelData.push(['ผู้จัดทำบัญชี', 'ผู้ตรวจสอบบัญชี']);
      excelData.push(['วันที่..../................/.............', 'วันที่..../................/.............']);


      // สร้างไฟล์ Excel
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "รายงานรายรับ");

      // กำหนดความกว้างของคอลัมน์
      ws['!cols'] = [
        { wch: 15 }, // รหัส/วันที่
        { wch: 25 }, // รายการ/เลขที่เอกสาร
        { wch: 40 }, // รายละเอียด
        { wch: 20 }  // จำนวนเงิน
      ];

      // Export ไฟล์
      const dateRange = `${formatDateForExport(startDate)}_to_${formatDateForExport(endDate)}`.replace(/\//g, '-');
      XLSX.writeFile(wb, `รายงานแยกประเภทรายรับ_${dateRange}.xlsx`);
    }










    //แบบที่ 4
    // ฟังก์ชันสร้างรายงานแยกประเภทรายรับ
    function generateExpenseReport() {
      const startDateInput = document.getElementById('expenseStartDate').value;
      const endDateInput = document.getElementById('expenseEndDate').value;

      // ตรวจสอบการเลือกวันที่
      if (!startDateInput || !endDateInput) {
        showError('กรุณาเลือกวันที่เริ่มต้นและวันที่สิ้นสุด');
        return;
      }

      const startDate = new Date(startDateInput);
      const endDate = new Date(endDateInput);

      if (startDate > endDate) {
        showError('วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด');
        return;
      }

      showLoading();

      // กรองข้อมูลรายจ่ายตามช่วงวันที่ (แก้ไขส่วนนี้)
      const filteredExpenseData = allData.filter(item => {
        if (item.type !== 'expense') return false;

        const itemDate = parseThaiDate(`${item.day} ${thaiMonths[parseInt(item.month) - 1]} ${item.year}`);

        // ตั้งเวลา startDate เป็น 00:00:00 และ endDate เป็น 23:59:59
        const adjustedStartDate = new Date(startDate);
        adjustedStartDate.setHours(0, 0, 0, 0);

        const adjustedEndDate = new Date(endDate);
        adjustedEndDate.setHours(23, 59, 59, 999);

        return itemDate >= adjustedStartDate && itemDate <= adjustedEndDate;
      });

      if (filteredExpenseData.length === 0) {
        hideLoading();
        showError('ไม่พบข้อมูลรายจ่ายในช่วงวันที่ที่เลือก');
        return;
      }

      // สรุปยอดตามรหัสรายรับ
      const expenseSummary = {};
      let totalExpense = 0;

      filteredExpenseData.forEach(item => {
        const amount = parseFloat(item.amount) || 0;
        expenseSummary[item.code] = expenseSummary[item.code] || {
          description: expenseCodes.find(c => c.code === item.code)?.description || 'ไม่ทราบรายการ',
          total: 0,
          transactions: []
        };

        expenseSummary[item.code].total += amount;
        expenseSummary[item.code].transactions.push(item);
        totalExpense += amount;
      });

      // สร้าง HTML สำหรับแสดงผล
      let html = `
    <div class="bg-white p-4 rounded-lg shadow">
      <h4 class="text-lg font-semibold mb-4">สรุปสมุดแยกประเภทรายจ่าย วันที่ ${formatDateForDisplay(startDate)} ถึง ${formatDateForDisplay(endDate)}</h4>
      
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg overflow-hidden mb-6">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left">รหัส</th>
              <th class="px-4 py-2 text-left">รายการ</th>
              <th class="px-4 py-2 text-right">จำนวนเงิน (บาท)</th>
            </tr>
          </thead>
          <tbody>
  `;

      // แสดงสรุปตามรหัส
      Object.keys(expenseSummary).sort().forEach(code => {
        const { description, total } = expenseSummary[code];
        html += `
      <tr class="border-b hover:bg-gray-50">
        <td class="px-4 py-2">${code}</td>
        <td class="px-4 py-2">${description}</td>
        <td class="px-4 py-2 text-right expense">${formatCurrency(total)}</td>
      </tr>
    `;
      });

      html += `
          </tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="2" class="px-4 py-2 font-semibold text-right">รวมรายจ่ายทั้งหมด</td>
              <td class="px-4 py-2 text-right font-semibold expense">${formatCurrency(totalExpense)}</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- แสดงรายละเอียดแต่ละรหัส -->
      ${generateExpenseDetails(expenseSummary)}


      <!-- Certification section -->
      <div class="mt-8 text-center">
        <p class="mb-8 font-medium">รับรองข้อมูลตามนี้</p>
        
        <div class="flex justify-between mt-6">
          <!-- Left signature (Accountant) -->
          <div class="w-1/2 text-center">
            <div class="mb-2">(  <?!= settings['ชื่อผู้จัดทำบัญชี'] ?>  )</div>
            <div class="mb-2">ตำแหน่ง..........................................................</div>
            <div class="mb-2">ผู้จัดทำบัญชี</div>
            <div>วันที่....../................./............</div>           
          </div>

          <br><br><br>

          <!-- Right signature (Auditor) -->
          <div class="w-1/2 text-center">
            <div class="mb-2">(  <?!= settings['ชื่อเจ้าอาวาส'] ?>  )</div>
            <div class="mb-2">ตำแหน่ง.........................................................</div>
            <div class="mb-2">ผู้ตรวจสอบบัญชี</div>
            <div>วันที่......./................../........</div>
          </div>
        </div>
      </div>
    </div>


      <div class="flex justify-between mt-4">
        <button id="printExpenseReport" class="btn-primary text-white px-4 py-2 rounded-md">
          <i class="fas fa-print mr-2"></i>พิมพ์รายงาน
        </button>
        <button id="exportExpenseExcel" class="btn-success text-white px-4 py-2 rounded-md">
          <i class="fas fa-file-excel mr-2"></i>Export เป็น Excel
        </button>
      </div>
    </div>
  `;

      // แสดงผลลัพธ์
      const resultDiv = document.getElementById('expenseReportResult');
      resultDiv.innerHTML = html;
      resultDiv.classList.remove('hidden');

      // เพิ่ม Event Listeners สำหรับปุ่มพิมพ์และ Export
      document.getElementById('printExpenseReport').addEventListener('click', () => printExpenseReport(expenseSummary, startDate, endDate));
      document.getElementById('exportExpenseExcel').addEventListener('click', () => exportExpenseToExcel(expenseSummary, totalExpense, startDateInput, endDateInput));

      hideLoading();
    }

    // ฟังก์ชันสร้างรายละเอียดแต่ละรหัส
    function generateExpenseDetails(expenseSummary) {
      let html = '';

      Object.keys(expenseSummary).sort().forEach(code => {
        const { description, total, transactions } = expenseSummary[code];

        html += `
      <div class="mb-8">
        <h5 class="text-md font-semibold mb-2">รหัส ${code} - ${description} (รวม ${formatCurrency(total)})</h5>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg overflow-hidden mb-4">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left">วันที่</th>
                <th class="px-4 py-2 text-left">เลขที่เอกสาร</th>
                <th class="px-4 py-2 text-left">รายละเอียด</th>
                <th class="px-4 py-2 text-right">จำนวนเงิน (บาท)</th>
              </tr>
            </thead>
            <tbody>
    `;

        transactions.forEach(transaction => {
          const date = `${transaction.day} ${thaiMonths[parseInt(transaction.month) - 1]} ${transaction.year}`;
          html += `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2">${date}</td>
          <td class="px-4 py-2">${transaction.docNo || '-'}</td>
          <td class="px-4 py-2">${transaction.description}</td>
          <td class="px-4 py-2 text-right expense">${formatCurrency(parseFloat(transaction.amount))}</td>
        </tr>
      `;
        });

        html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
      });

      return html;
    }

    // ฟังก์ชันพิมพ์รายงาน
    // แบบที่ 4 - รายงานแยกประเภทรายการจ่าย
    function printExpenseReport(expenseSummary, startDate, endDate) {
      const printWindow = window.open('', '_blank');
      const printContent = document.getElementById('expenseReportResult').innerHTML;
      // Remove all buttons from the print content before printing
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = printContent;
      tempDiv.querySelectorAll('button').forEach(btn => btn.remove());
      const cleanedContent = tempDiv.innerHTML;
      printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>รายงานแยกประเภทรายการจ่าย</title>
      <style>
        body { font-family: 'Sarabun', sans-serif; padding: 20px; }
        h4, h5 { text-align: center; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .expense { color: #dc3545; font-weight: bold; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .code-detail { margin-bottom: 30px; }
        .w-full { width: 100%; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .mt-8 { margin-top: 2rem; }
        .mb-8 { margin-bottom: 2rem; }
        .signature { text-align: center; margin-top: 50px; }
        .text-center { text-align: center; }
      </style>
    </head>
    <body>
      <h4>สรุปสมุดแยกประเภทรายการจ่าย</h4>
      <h5>วันที่ ${formatDateForDisplay(startDate)} ถึง ${formatDateForDisplay(endDate)}</h5>
      <div>
        ${cleanedContent}
      </div>
    </body>
    </html>
  `);

      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }

    // ฟังก์ชัน Export เป็น Excel
    function exportExpenseToExcel(expenseSummary, totalExpense, startDate, endDate) {
      // สร้างข้อมูลสำหรับ Excel
      const excelData = [
        ['สรุปสมุดแยกประเภทรายจ่าย'],
        [`วันที่ ${formatDateForExport(startDate)} ถึง ${formatDateForExport(endDate)}`],
        [],
        ['รหัส', 'รายการ', 'จำนวนเงิน (บาท)']
      ];

      // เพิ่มข้อมูลสรุป
      Object.keys(expenseSummary).sort().forEach(code => {
        const { description, total } = expenseSummary[code];
        excelData.push([code, description, total]);
      });

      excelData.push(['รวมรายจ่ายทั้งหมด', '', totalExpense]);
      excelData.push([], [], ['รายละเอียดรายการ'], []);

      // เพิ่มข้อมูลรายละเอียดแต่ละรหัส
      Object.keys(expenseSummary).sort().forEach(code => {
        const { description, total, transactions } = expenseSummary[code];

        excelData.push([`รหัส ${code} - ${description}`, `รวม ${formatCurrency(total)}`]);
        excelData.push(['วันที่', 'เลขที่เอกสาร', 'รายละเอียด', 'จำนวนเงิน (บาท)']);

        transactions.forEach(transaction => {
          const date = `${transaction.day}/${transaction.month}/${transaction.year}`;
          excelData.push([date, transaction.docNo || '-', transaction.description, transaction.amount]);
        });

        excelData.push([]);
      });

      // เพิ่มส่วนรับรองข้อมูล
      excelData.push([], [], ['รับรองข้อมูลตามนี้'], []);
      excelData.push(['(  <?!= settings['ชื่อผู้จัดทำบัญชี'] ?>  )', '(  <?!= settings['ชื่อเจ้าอาวาส'] ?>  )']);
      excelData.push(['ตำแหน่ง...................................', 'ตำแหน่ง...................................']);
      excelData.push(['ผู้จัดทำบัญชี', 'ผู้ตรวจสอบบัญชี']);
      excelData.push(['วันที่..../................/...........', 'วันที่..../................/............']);



      // สร้างไฟล์ Excel
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "รายงานรายจ่าย");

      // กำหนดความกว้างของคอลัมน์
      ws['!cols'] = [
        { wch: 15 }, // รหัส/วันที่
        { wch: 25 }, // รายการ/เลขที่เอกสาร
        { wch: 40 }, // รายละเอียด
        { wch: 20 }  // จำนวนเงิน
      ];

      // Export ไฟล์
      const dateRange = `${formatDateForExport(startDate)}_to_${formatDateForExport(endDate)}`.replace(/\//g, '-');
      XLSX.writeFile(wb, `รายงานแยกประเภทรายจ่าย_${dateRange}.xlsx`);
    }
















    // แบบที่ 5 - งบรายรับและรายจ่าย
    function generateSummaryReport() {
      const startDateInput = document.getElementById('startDate').value;
      const endDateInput = document.getElementById('endDate').value;

      // ตรวจสอบการเลือกวันที่
      if (!startDateInput || !endDateInput) {
        showError('กรุณาเลือกวันที่เริ่มต้นและวันที่สิ้นสุด');
        return;
      }

      const startDate = new Date(startDateInput);
      const endDate = new Date(endDateInput);

      if (startDate > endDate) {
        showError('วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด');
        return;
      }

      showLoading();

      // กรองข้อมูลตามช่วงวันที่ และไม่รวมรายการที่มีรหัสขึ้นต้นด้วย "Bank"
      const filteredData = allData.filter(item => {
        const itemDate = parseThaiDate(`${item.day} ${thaiMonths[parseInt(item.month) - 1]} ${item.year}`);

        // ตั้งเวลา startDate เป็น 00:00:00 และ endDate เป็น 23:59:59
        const adjustedStartDate = new Date(startDate);
        adjustedStartDate.setHours(0, 0, 0, 0);

        const adjustedEndDate = new Date(endDate);
        adjustedEndDate.setHours(23, 59, 59, 999);

        // ไม่รวมรายการที่มีรหัสขึ้นต้นด้วย "Bank"
        const isBankTransaction = item.code && item.code.toString().toLowerCase().startsWith('bank');

        return itemDate >= adjustedStartDate &&
          itemDate <= adjustedEndDate &&
          !isBankTransaction;
      });

      // กรองข้อมูลโอนเงินเข้าบัญชีธนาคารในช่วงวันที่เดียวกัน
      const filteredTransferData = transferData.filter(item => {
        const itemDate = parseThaiDate(`${item.day} ${thaiMonths[parseInt(item.month) - 1]} ${item.year}`);

        // ตั้งเวลา startDate เป็น 00:00:00 และ endDate เป็น 23:59:59
        const adjustedStartDate = new Date(startDate);
        adjustedStartDate.setHours(0, 0, 0, 0);

        const adjustedEndDate = new Date(endDate);
        adjustedEndDate.setHours(23, 59, 59, 999);

        return itemDate >= adjustedStartDate && itemDate <= adjustedEndDate;
      });

      if (filteredData.length === 0 && filteredTransferData.length === 0) {
        hideLoading();
        showError('ไม่พบข้อมูลในช่วงวันที่ที่เลือก');
        return;
      }

      // สรุปยอดตามรหัส
      const incomeSummary = {};
      const expenseSummary = {};
      let totalIncome = 0;
      let totalExpense = 0;

      // 1. คำนวณจากข้อมูลเดิม (ไม่รวมรหัส Bank)
      filteredData.forEach(item => {
        const amount = parseFloat(item.amount) || 0;
        if (item.type === 'income') {
          incomeSummary[item.code] = (incomeSummary[item.code] || 0) + amount;
          totalIncome += amount;
        } else {
          expenseSummary[item.code] = (expenseSummary[item.code] || 0) + amount;
          totalExpense += amount;
        }
      });

      // 2. เพิ่มรายการโอนเงินเข้าบัญชีธนาคารเป็นรายรับ
      const transferIncomeSummary = {};
      let totalTransferIncome = 0;

      filteredTransferData.forEach(item => {
        const amount = parseFloat(item.amount) || 0;
        transferIncomeSummary[item.code] = (transferIncomeSummary[item.code] || 0) + amount;
        totalTransferIncome += amount;
      });

      // รวมยอดรายรับทั้งหมด (รายรับเดิม + รายรับจากการโอน)
      const combinedTotalIncome = totalIncome + totalTransferIncome;
      const balance = combinedTotalIncome - totalExpense;
      const balanceClass = balance >= 0 ? 'income' : 'expense';
      const balanceText = balance >= 0 ? 'รายรับสูงกว่ารายจ่าย' : 'รายจ่ายสูงกว่ารายรับ';

      // สร้าง HTML สำหรับแสดงผล
      let html = `
    <div class="bg-white p-4 rounded-lg shadow">
      <h4 class="text-lg font-semibold mb-4">สรุปงบประมาณ วันที่ ${formatDateForDisplay(startDate)} ถึง ${formatDateForDisplay(endDate)}</h4>
      <p class="text-sm text-gray-600 mb-4">* ไม่รวมรายการนำเงินสดฝากเข้าบัญชีธนาคาร และรายการถอนเงินจากบัญชีธนาคารมาเป็นเงินสดในมือ</p>
      
      <div class="overflow-x-auto">
        <h5 class="text-md font-semibold mb-2 text-green-600">รายรับ (เงินสดในมือ)</h5>
        <table class="min-w-full bg-white rounded-lg overflow-hidden mb-6">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left">รหัส</th>
              <th class="px-4 py-2 text-left">รายการ</th>
              <th class="px-4 py-2 text-right">จำนวนเงิน (บาท)</th>
            </tr>
          </thead>
          <tbody>
  `;

      // แสดงรายรับ (ไม่รวมรหัส Bank)
      Object.keys(incomeSummary)
        .filter(code => !code.toString().toLowerCase().startsWith('bank'))
        .sort()
        .forEach(code => {
          const codeInfo = incomeCodes.find(c => c.code === code) || { description: 'ไม่ทราบรายการ' };
          html += `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2">${code}</td>
          <td class="px-4 py-2">${codeInfo.description}</td>
          <td class="px-4 py-2 text-right income">${formatCurrency(incomeSummary[code])}</td>
        </tr>
      `;
        });

      html += `
          </tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="2" class="px-4 py-2 font-semibold text-right">รวมรายรับ (เงินสดในมือ)</td>
              <td class="px-4 py-2 text-right font-semibold income">${formatCurrency(totalIncome)}</td>
            </tr>
          </tfoot>
        </table>

        <!-- เพิ่มตารางรายรับจากการโอนเงินเข้าบัญชีธนาคาร -->
        <h5 class="text-md font-semibold mb-2 text-blue-600">รายรับจากการโอนเข้าบัญชีธนาคารโดยตรง</h5>
        <table class="min-w-full bg-white rounded-lg overflow-hidden mb-6">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left">รหัส</th>
              <th class="px-4 py-2 text-left">รายการ</th>
              <th class="px-4 py-2 text-right">จำนวนเงิน (บาท)</th>
            </tr>
          </thead>
          <tbody>
  `;

      // แสดงรายรับจากการโอนเงินเข้าบัญชีธนาคาร
      Object.keys(transferIncomeSummary)
        .sort()
        .forEach(code => {
          const codeInfo = transferCodes.find(c => c.code === code) || { description: 'ไม่ทราบรายการ' };
          html += `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2">${code}</td>
          <td class="px-4 py-2">${codeInfo.description}</td>
          <td class="px-4 py-2 text-right income">${formatCurrency(transferIncomeSummary[code])}</td>
        </tr>
      `;
        });

      html += `
          </tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="2" class="px-4 py-2 font-semibold text-right">รวมรายรับจากการโอนเข้าบัญชีธนาคารโดยตรง</td>
              <td class="px-4 py-2 text-right font-semibold income">${formatCurrency(totalTransferIncome)}</td>
            </tr>
            <tr>
              <td colspan="2" class="px-4 py-2 font-semibold text-right">รวมรายรับทั้งหมด</td>
              <td class="px-4 py-2 text-right font-semibold income">${formatCurrency(combinedTotalIncome)}</td>
            </tr>
          </tfoot>
        </table>

        <h5 class="text-md font-semibold mb-2 text-red-600">รายจ่าย</h5>
        <table class="min-w-full bg-white rounded-lg overflow-hidden mb-6">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left">รหัส</th>
              <th class="px-4 py-2 text-left">รายการ</th>
              <th class="px-4 py-2 text-right">จำนวนเงิน (บาท)</th>
            </tr>
          </thead>
          <tbody>
  `;

      // แสดงรายจ่าย (ไม่รวมรหัส Bank)
      Object.keys(expenseSummary)
        .filter(code => !code.toString().toLowerCase().startsWith('bank'))
        .sort()
        .forEach(code => {
          const codeInfo = expenseCodes.find(c => c.code === code) || { description: 'ไม่ทราบรายการ' };
          html += `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2">${code}</td>
          <td class="px-4 py-2">${codeInfo.description}</td>
          <td class="px-4 py-2 text-right expense">${formatCurrency(expenseSummary[code])}</td>
        </tr>
      `;
        });

      html += `
          </tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="2" class="px-4 py-2 font-semibold text-right">รวมรายจ่าย</td>
              <td class="px-4 py-2 text-right font-semibold expense">${formatCurrency(totalExpense)}</td>
            </tr>
            <tr>
              <td colspan="2" class="px-4 py-2 font-semibold text-right">${balanceText}</td>
              <td class="px-4 py-2 text-right font-semibold ${balanceClass}">${formatCurrency(balance)}</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Certification section -->
      <div class="mt-8 text-center">
        <p class="mb-8 font-medium">รับรองข้อมูลตามนี้</p>
        
        <div class="flex justify-between mt-6">
          <!-- Left signature (Accountant) -->
          <div class="w-1/2 text-center">
            <div class="mb-2">(  <?!= settings['ชื่อผู้จัดทำบัญชี'] ?>)</div>
            <div class="mb-2">ตำแหน่ง..........................................................</div>
            <div class="mb-2">ผู้จัดทำบัญชี</div>
            <div>วันที่......./.................../..............</div>           
          </div>

          <br><br><br>

          <!-- Right signature (Auditor) -->
          <div class="w-1/2 text-center">
            <div class="mb-2">(  <?!= settings['ชื่อเจ้าอาวาส'] ?>)</div>
            <div class="mb-2">ตำแหน่ง.........................................................</div>
            <div class="mb-2">ผู้ตรวจสอบบัญชี</div>
            <div>วันที่......../................./.............</div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex justify-between mt-4">
      <button id="printSummary" class="btn-primary text-white px-4 py-2 rounded-md">
        <i class="fas fa-print mr-2"></i>พิมพ์รายงาน
      </button>
      <button id="exportSummaryExcel" class="btn-success text-white px-4 py-2 rounded-md">
        <i class="fas fa-file-excel mr-2"></i>Export เป็น Excel
      </button>
    </div>
  `;

      // แสดงผลลัพธ์
      const resultDiv = document.getElementById('summaryReportResult');
      resultDiv.innerHTML = html;
      resultDiv.classList.remove('hidden');

      // เพิ่ม Event Listeners สำหรับปุ่มพิมพ์และ Export
      document.getElementById('printSummary').addEventListener('click', printSummaryReport);
      document.getElementById('exportSummaryExcel').addEventListener('click', () => exportSummaryToExcel(
        filteredData,
        incomeSummary,
        expenseSummary,
        combinedTotalIncome,
        totalExpense,
        startDateInput,
        endDateInput,
        filteredTransferData,
        transferIncomeSummary,
        totalTransferIncome
      ));

      hideLoading();
    }




    // ฟังก์ชันช่วยเหลือ
    // แปลงวันที่ไทยเป็น Date object (รวมเวลา 00:00:00)
    function parseThaiDate(dateStr) {
      if (!dateStr) return null;
      const [day, month, year] = dateStr.split(' ');
      const monthIndex = thaiMonths.findIndex(m => m === month) + 1;
      return new Date(parseInt(year) - 543, monthIndex - 1, parseInt(day), 0, 0, 0);
    }


    function formatDateForDisplay(date) {
      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543;
      return `${day} ${month} ${year}`;
    }

    function formatCurrency(amount) {
      return parseFloat(amount).toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // แบบที่ 5 - รายงานสรุปงบประมาณ
    function printSummaryReport() {
      const printWindow = window.open('', '_blank');
      const printContent = document.getElementById('summaryReportResult').innerHTML;
       // Remove all buttons from the print content before printing
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = printContent;
      tempDiv.querySelectorAll('button').forEach(btn => btn.remove());
      const cleanedContent = tempDiv.innerHTML;
      const startDate = document.getElementById('startDate').valueAsDate;
      const endDate = document.getElementById('endDate').valueAsDate;

      printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>รายงานสรุปงบประมาณ</title>
      <style>
        body { font-family: 'Sarabun', sans-serif; padding: 20px; }
        h4, h5 { text-align: center; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .income { color: #28a745; font-weight: bold; }
        .expense { color: #dc3545; font-weight: bold; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .note { font-size: 0.9em; color: #666; text-align: center; margin-bottom: 15px; }
        .w-full { width: 100%; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .mt-8 { margin-top: 2rem; }
        .mb-8 { margin-bottom: 2rem; }
        .signature { text-align: center; margin-top: 50px; }
      </style>
    </head>
    <body>
      <div>
        ${cleanedContent}
      </div>
    </body>
    </html>
  `);

      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }


    function exportSummaryToExcel(
      filteredData,
      incomeSummary,
      expenseSummary,
      totalIncome,
      totalExpense,
      startDate,
      endDate,
      filteredTransferData,
      transferIncomeSummary,
      totalTransferIncome
    ) {
      // สร้างข้อมูลสำหรับ Excel
      const excelData = [
        ['รายงานสรุปงบประมาณ'],
        [`วันที่ ${formatDateForExport(startDate)} ถึง ${formatDateForExport(endDate)}`],
        ['* ไม่รวมรายการนำเงินสดฝากเข้าบัญชีธนาคาร และรายการถอนเงินจากบัญชีธนาคารมาเป็นเงินสดในมือ'],
        [],
        ['รายรับ (เงินสดในมือ)', '', ''],
        ['รหัส', 'รายการ', 'จำนวนเงิน (บาท)']
      ];

      // เพิ่มข้อมูลรายรับ (ไม่รวมรหัส Bank)
      Object.keys(incomeSummary)
        .filter(code => !code.toString().toLowerCase().startsWith('bank'))
        .sort()
        .forEach(code => {
          const codeInfo = incomeCodes.find(c => c.code === code) || { description: 'ไม่ทราบรายการ' };
          excelData.push([code, codeInfo.description, incomeSummary[code]]);
        });

      excelData.push(['รวมรายรับ (เงินสดในมือ)', '', totalIncome - totalTransferIncome]);
      excelData.push([], [], ['รายรับจากการโอนเข้าบัญชีธนาคารโดยตรง'], []);
      excelData.push(['รหัส', 'รายการ', 'จำนวนเงิน (บาท)']);

      // เพิ่มข้อมูลรายรับจากการโอน
      Object.keys(transferIncomeSummary)
        .sort()
        .forEach(code => {
          const codeInfo = transferCodes.find(c => c.code === code) || { description: 'ไม่ทราบรายการ' };
          excelData.push([code, codeInfo.description, transferIncomeSummary[code]]);
        });

      excelData.push(['รวมรายรับจากการโอนเข้าบัญชีธนาคารโดยตรง', '', totalTransferIncome]);
      excelData.push(['รวมรายรับทั้งหมด', '', totalIncome]);
      excelData.push([]);

      // เพิ่มข้อมูลรายจ่าย (ไม่รวมรหัส Bank)
      excelData.push(['รายจ่าย', '', '']);
      excelData.push(['รหัส', 'รายการ', 'จำนวนเงิน (บาท)']);

      Object.keys(expenseSummary)
        .filter(code => !code.toString().toLowerCase().startsWith('bank'))
        .sort()
        .forEach(code => {
          const codeInfo = expenseCodes.find(c => c.code === code) || { description: 'ไม่ทราบรายการ' };
          excelData.push([code, codeInfo.description, expenseSummary[code]]);
        });

      excelData.push(['รวมรายจ่าย', '', totalExpense]);

      // เพิ่มยอดคงเหลือตามเงื่อนไข
      const balance = totalIncome - totalExpense;
      const balanceText = balance >= 0 ? 'รายรับสูงกว่ารายจ่าย' : 'รายจ่ายสูงกว่ารายรับ';
      excelData.push([balanceText, '', balance]);

      // เพิ่มส่วนรับรองข้อมูล
      excelData.push([], [], ['รับรองข้อมูลตามนี้'], []);
      excelData.push(['(  <?!= settings['ชื่อผู้จัดทำบัญชี'] ?>)', '(  <?!= settings['ชื่อเจ้าอาวาส'] ?>)']);
      excelData.push(['ตำแหน่ง...................................', 'ตำแหน่ง...................................']);
      excelData.push(['ผู้จัดทำบัญชี', 'ผู้ตรวจสอบบัญชี']);
      excelData.push(['วันที่....../............../...........', 'วันที่....../............../............']);

      // สร้างไฟล์ Excel
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "สรุปงบประมาณ");

      // กำหนดความกว้างของคอลัมน์
      ws['!cols'] = [
        { wch: 25 }, // รหัส/รายการ
        { wch: 40 }, // รายละเอียด
        { wch: 20 }  // จำนวนเงิน
      ];

      // Export ไฟล์
      const dateRange = `${formatDateForExport(startDate)}_to_${formatDateForExport(endDate)}`.replace(/\//g, '-');
      XLSX.writeFile(wb, `สรุปงบประมาณ_${dateRange}.xlsx`);
    }

    function formatDateForExport(dateStr) {
      const date = new Date(dateStr);
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // เพิ่ม Event Listener สำหรับปุ่มสร้างรายงานสรุป
    document.getElementById('generateSummaryReport').addEventListener('click', generateSummaryReport);

    function isDateInRange(date, startDate, endDate) {
      // ตั้งเวลา startDate เป็น 00:00:00 และ endDate เป็น 23:59:59
      const start = new Date(startDate);
      start.setHours(0, 0, 0, 0);

      const end = new Date(endDate);
      end.setHours(23, 59, 59, 999);

      return date >= start && date <= end;
    }















    //แบบที่ 1

    // ในส่วน initialize ให้เพิ่มการโหลดปีและเดือน
    function initializeMonthCashReport() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelects = [
        document.getElementById('startMonthSelect'),
        document.getElementById('endMonthSelect')
      ];

      // ล้างข้อมูลเดิม
      yearSelect.innerHTML = '';

      // เพิ่มตัวเลือกปี (เรียงจากใหม่ไปเก่า)
      const uniqueYears = Array.from(years).sort((a, b) => b - a);

      if (uniqueYears.length === 0) {
        // ถ้ายังไม่มีข้อมูลปี ให้ใช้ปีปัจจุบันเป็นค่าเริ่มต้น
        const currentYear = new Date().getFullYear() + 543;
        const option = document.createElement('option');
        option.value = currentYear;
        option.textContent = currentYear;
        yearSelect.appendChild(option);
      } else {
        uniqueYears.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });
      }

      // โหลดเดือน
      monthSelects.forEach(select => {
        select.innerHTML = '';
        thaiMonths.forEach((month, index) => {
          const option = document.createElement('option');
          option.value = index + 1;
          option.textContent = month;
          select.appendChild(option);
        });

        // ตั้งค่าเดือนเริ่มต้นและสิ้นสุด
        if (select.id === 'startMonthSelect') {
          select.value = 1; // มกราคม
        } else {
          select.value = 12; // ธันวาคม
        }
      });

      // เมื่อเลือกช่วงเดือนเป็นกำหนดเอง
      document.getElementById('monthRangeSelect').addEventListener('change', function () {
        document.getElementById('customMonthRange').classList.toggle('hidden', this.value !== 'custom');
      });
    }

    // ฟังก์ชันสร้างรายงานประจำเดือน
    function generateMonthlyCashReport() {
      const year = document.getElementById('yearSelect').value;
      const monthRange = document.getElementById('monthRangeSelect').value;

      if (!year) {
        showError('กรุณาเลือกปีที่ต้องการสร้างรายงาน');
        return;
      }

      let startMonth, endMonth;

      if (monthRange === 'custom') {
        startMonth = parseInt(document.getElementById('startMonthSelect').value);
        endMonth = parseInt(document.getElementById('endMonthSelect').value);

        if (startMonth > endMonth) {
          showError('เดือนเริ่มต้นต้องไม่เกินเดือนสิ้นสุด');
          return;
        }
      } else if (monthRange === '1-6') {
        startMonth = 1;
        endMonth = 6;
      } else if (monthRange === '7-12') {
        startMonth = 7;
        endMonth = 12;
      } else { // all
        startMonth = 1;
        endMonth = 12;
      }

      showLoading();

      // กรองข้อมูลตามปีและเดือนที่เลือก
      const filteredData = allData.filter(item => {
        return parseInt(item.year) === parseInt(year) &&
          parseInt(item.month) >= startMonth &&
          parseInt(item.month) <= endMonth;
      });

      if (filteredData.length === 0) {
        hideLoading();
        showError('ไม่พบข้อมูลในช่วงเวลาที่เลือก');
        return;
      }

      // สรุปยอดแต่ละเดือน
      const monthlySummary = {};
      let cumulativeBalance = 0;

      // คำนวณยอดยกมาจากปีก่อนหน้า (สำหรับเดือนมกราคม)
      if (startMonth === 1) {
        cumulativeBalance = calculatePreviousYearBalance(year);
      }

      // สร้างโครงสรุปสำหรับแต่ละเดือน
      for (let month = startMonth; month <= endMonth; month++) {
        const monthData = filteredData.filter(item => parseInt(item.month) === month);

        let monthIncome = 0;
        let monthExpense = 0;

        monthData.forEach(item => {
          const amount = parseFloat(item.amount) || 0;
          if (item.type === 'income') {
            monthIncome += amount;
          } else {
            monthExpense += amount;
          }
        });

        const monthBalance = monthIncome - monthExpense;
        const openingBalance = cumulativeBalance;
        cumulativeBalance += monthBalance;

        monthlySummary[month] = {
          name: thaiMonths[month - 1],
          income: monthIncome,
          expense: monthExpense,
          openingBalance: openingBalance,
          closingBalance: cumulativeBalance,
          transactions: monthData
        };
      }

      // สร้าง HTML สำหรับแสดงผล
      let html = `
    <div class="bg-white p-4 rounded-lg shadow mt-4">
      <h4 class="text-xl font-bold mb-4 text-center">สรุปยอดเงินสดประจำเดือน</h4>
      <h5 class="text-lg mb-4 text-center">ปี ${year} (${thaiMonths[startMonth - 1]} - ${thaiMonths[endMonth - 1]})</h5>
      
      <!-- สรุปยอดแต่ละเดือน -->
      <div class="overflow-x-auto mb-8">
        <table class="min-w-full bg-white rounded-lg overflow-hidden">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-center">เดือน</th>
              <th class="px-4 py-2 text-center">ยอดยกมา</th>
              <th class="px-4 py-2 text-center">รวมรายรับ</th>
              <th class="px-4 py-2 text-center">รวมรายจ่าย</th>
              <th class="px-4 py-2 text-center">ยอดยกไป</th>
            </tr>
          </thead>
          <tbody>
  `;

      // แสดงสรุปยอดแต่ละเดือน
      for (let month = startMonth; month <= endMonth; month++) {
        const summary = monthlySummary[month];
        html += `
      <tr class="border-b hover:bg-gray-50">
        <td class="px-4 py-2 text-center">${summary.name}</td>
        <td class="px-4 py-2 text-right">${formatCurrency(summary.openingBalance)}</td>
        <td class="px-4 py-2 text-right income">${formatCurrency(summary.income)}</td>
        <td class="px-4 py-2 text-right expense">${formatCurrency(summary.expense)}</td>
        <td class="px-4 py-2 text-right">${formatCurrency(summary.closingBalance)}</td>
      </tr>
        `;
      }

      // เพิ่ม CSS สำหรับการพิมพ์: ขึ้นหน้าใหม่ทุกเดือนในรายละเอียด
      html += `
      <style>
        @media print {
          .monthly-detail-print-page { page-break-before: always; }
          .monthly-detail-print-page:first-child { page-break-before: auto; }
        }
      </style>
      `;

      // ฟังก์ชัน generateMonthlyTransactionTables จะถูกเรียกต่อไป

      html += `
          </tbody>
        </table>
      </div>
      
      <!-- แสดงตารางรายละเอียดแต่ละเดือน -->
      ${generateMonthlyTransactionTables(monthlySummary, startMonth, endMonth)}
      


   <!-- Certification section -->
      <div class="mt-8 text-center">
        <p class="mb-8 font-medium">รับรองข้อมูลตามนี้</p>
        
        <div class="flex justify-between mt-6 w-full">
          <!-- Left signature (Accountant) -->
          <div class="w-1/2 text-center">
            <div class="mb-2">(  <?!= settings['ชื่อผู้จัดทำบัญชี'] ?>  )</div>
            <div class="mb-2">ตำแหน่ง..........................................................</div>
            <div class="mb-2">ผู้จัดทำบัญชี</div>
            <div>วันที่......../................../.............</div>           
          </div>

          <br><br><br>

          <!-- Right signature (Auditor) -->
          <div class="w-1/2 text-center">
            <div class="mb-2">(  <?!= settings['ชื่อเจ้าอาวาส'] ?>  )</div>
            <div class="mb-2">ตำแหน่ง.........................................................</div>
            <div class="mb-2">ผู้ตรวจสอบบัญชี</div>
            <div>วันที่......./...................../.............</div>
          </div>
        </div>
      </div>
    </div>


          <div class="flex justify-between mt-6">
        <button id="printMonthlyCashReport" class="btn-primary text-white px-4 py-2 rounded-md">
          <i class="fas fa-print mr-2"></i>พิมพ์รายงาน
        </button>
        <button id="exportMonthlyCashExcel" class="btn-success text-white px-4 py-2 rounded-md">
          <i class="fas fa-file-excel mr-2"></i>Export เป็น Excel
        </button>
      </div>
  `;

      // แสดงผลลัพธ์
      const resultDiv = document.getElementById('monthlyCashReportResult');
      resultDiv.innerHTML = html;
      resultDiv.classList.remove('hidden');

      // เพิ่ม Event Listeners สำหรับปุ่มพิมพ์และ Export
      document.getElementById('printMonthlyCashReport').addEventListener('click', () => printMonthlyCashReport(monthlySummary, year, startMonth, endMonth));
      document.getElementById('exportMonthlyCashExcel').addEventListener('click', () => exportMonthlyCashToExcel(monthlySummary, year, startMonth, endMonth));

      hideLoading();
    }

    // ฟังก์ชันคำนวณยอดยกมาจากปีก่อนหน้า
    function calculatePreviousYearBalance(year) {
      const prevYear = parseInt(year) - 1;
      const prevYearData = allData.filter(item => parseInt(item.year) === prevYear);

      let balance = 0;
      prevYearData.forEach(item => {
        const amount = parseFloat(item.amount) || 0;
        if (item.type === 'income') {
          balance += amount;
        } else {
          balance -= amount;
        }
      });

      return balance;
    }

    // ฟังก์ชันสร้างตารางรายละเอียดแต่ละเดือน
    function generateMonthlyTransactionTables(monthlySummary, startMonth, endMonth) {
      let html = '';

      for (let month = startMonth; month <= endMonth; month++) {
        const summary = monthlySummary[month];

        html += `
      <div class="mb-8 monthly-detail-print-page">
        <h5 class="text-md font-semibold mb-2">รายละเอียดเดือน ${summary.name}</h5>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg overflow-hidden mb-4">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left">วันที่</th>
                <th class="px-4 py-2 text-left">เลขที่เอกสาร</th>
                <th class="px-4 py-2 text-left">รายการ</th>
                <th class="px-4 py-2 text-left">รหัส</th>
                <th class="px-4 py-2 text-right">จำนวนเงิน</th>
                <th class="px-4 py-2 text-right">ยอดสะสม</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" class="px-4 py-2 font-semibold">ยอดยกมา</td>
                <td class="px-4 py-2 text-right font-semibold">${formatCurrency(summary.openingBalance)}</td>
              </tr>
    `;

        let runningBalance = summary.openingBalance;

        // เรียงข้อมูลตามวันที่
        const sortedTransactions = [...summary.transactions].sort((a, b) => parseInt(a.day) - parseInt(b.day));

        sortedTransactions.forEach(item => {
          const amount = parseFloat(item.amount) || 0;
          const dateStr = `${item.day} ${thaiMonths[parseInt(item.month) - 1]} ${item.year}`;
          const amountClass = item.type === 'income' ? 'income' : 'expense';

          if (item.type === 'income') {
            runningBalance += amount;
          } else {
            runningBalance -= amount;
          }

          html += `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2">${dateStr}</td>
          <td class="px-4 py-2">${item.docNo || '-'}</td>
          <td class="px-4 py-2">${item.description}</td>
          <td class="px-4 py-2">${item.code || '-'}</td>
          <td class="px-4 py-2 text-right ${amountClass}">${formatCurrency(amount)}</td>
          <td class="px-4 py-2 text-right">${formatCurrency(runningBalance)}</td>
        </tr>
      `;
        });

        html += `
              <tr class="border-t-2 border-gray-300">
                <td colspan="4" class="px-4 py-2 font-semibold">รวมเดือน ${summary.name}</td>
                <td class="px-4 py-2 text-right font-semibold">${formatCurrency(summary.income - summary.expense)}</td>
                <td class="px-4 py-2 text-right font-semibold">${formatCurrency(summary.closingBalance)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    `;
      }

      return html;
    }

    // ฟังก์ชันพิมพ์รายงานประจำเดือน
    function printMonthlyCashReport(monthlySummary, year, startMonth, endMonth) {
      const printWindow = window.open('', '_blank');
      const printContent = document.getElementById('monthlyCashReportResult').innerHTML;
      // Remove all buttons from the print content before printing
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = printContent;
      tempDiv.querySelectorAll('button').forEach(btn => btn.remove());
      const cleanedContent = tempDiv.innerHTML;
      printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>รายงานบัญชีธนาคารประจำเดือน</title>
      <style>
        body { font-family: 'Sarabun', sans-serif; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .income { color: green; }
        .expense { color: red; }
        .w-full { width: 100%; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .text-center { text-align: center; }
        .mt-8 { margin-top: 2rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-8 { margin-bottom: 2rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
      </style>
    </head>
    <body>
      <div class="p-4">
        ${cleanedContent}
      </div>
    </body>
    </html>
  `);

      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }

    // ฟังก์ชัน Export เป็น Excel สำหรับรายงานประจำเดือน
    function exportMonthlyCashToExcel(monthlySummary, year, startMonth, endMonth) {
      // สร้างข้อมูลสำหรับ Excel
      const excelData = [
        ['สรุปยอดเงินสดประจำเดือน'],
        [`ปี ${year} (${thaiMonths[startMonth - 1]} - ${thaiMonths[endMonth - 1]})`],
        [],
        ['เดือน', 'ยอดยกมา', 'รวมรายรับ', 'รวมรายจ่าย', 'ยอดยกไป']
      ];

      // เพิ่มข้อมูลสรุปแต่ละเดือน
      for (let month = startMonth; month <= endMonth; month++) {
        const summary = monthlySummary[month];
        excelData.push([
          summary.name,
          summary.openingBalance,
          summary.income,
          summary.expense,
          summary.closingBalance
        ]);
      }

      excelData.push([], [], ['รายละเอียดรายการแต่ละเดือน'], []);

      // เพิ่มข้อมูลรายละเอียดแต่ละเดือน
      for (let month = startMonth; month <= endMonth; month++) {
        const summary = monthlySummary[month];

        excelData.push([`เดือน ${summary.name}`]);
        excelData.push(['วันที่', 'เลขที่เอกสาร', 'รายการ', 'รหัส', 'ประเภท', 'จำนวนเงิน', 'ยอดสะสม']);

        let runningBalance = summary.openingBalance;
        excelData.push(['ยอดยกมา', '', '', '', '', '', runningBalance]);

        // เรียงข้อมูลตามวันที่
        const sortedTransactions = [...summary.transactions].sort((a, b) => parseInt(a.day) - parseInt(b.day));

        sortedTransactions.forEach(item => {
          const amount = parseFloat(item.amount) || 0;
          const dateStr = `${item.day}/${item.month}/${item.year}`;

          if (item.type === 'income') {
            runningBalance += amount;
          } else {
            runningBalance -= amount;
          }

          excelData.push([
            dateStr,
            item.docNo || '-',
            item.description,
            item.code || '-',
            item.type === 'income' ? 'รายรับ' : 'รายจ่าย',
            amount,
            runningBalance
          ]);
        });

        excelData.push([]);
      }

      // เพิ่มส่วนรับรองข้อมูล
      excelData.push([], [], ['รับรองข้อมูลตามนี้'], []);
      excelData.push(['(..................................)', '(..................................)']);
      excelData.push(['ตำแหน่ง...................................', 'ตำแหน่ง...................................']);
      excelData.push(['ผู้จัดทำบัญชี', 'ผู้ตรวจสอบบัญชี']);
      excelData.push(['วันที่......./................/............', 'วันที่......./.............../............']);

      // สร้างไฟล์ Excel
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "สมุดเงินสดประจำเดือน");

      // กำหนดความกว้างของคอลัมน์
      ws['!cols'] = [
        { wch: 15 }, // เดือน/วันที่
        { wch: 15 }, // เลขที่เอกสาร
        { wch: 30 }, // รายการ
        { wch: 10 }, // รหัส
        { wch: 10 }, // ประเภท
        { wch: 15 }, // จำนวนเงิน
        { wch: 15 }  // ยอดสะสม
      ];

      // Export ไฟล์
      XLSX.writeFile(wb, `สมุดเงินสดประจำเดือน_${year}_${startMonth}-${endMonth}.xlsx`);
    }

    // ในส่วน setupEventListeners ให้เพิ่ม
    document.getElementById('generateMonthlyCashReport').addEventListener('click', generateMonthlyCashReport);



    // ในส่วน loadData ให้เรียก initializeMonthCashReport
    initializeMonthCashReport();
















    // แบบที่ 2 ฟังก์ชันโหลดข้อมูลบัญชีธนาคาร
    function loadBankAccounts() {
      showLoading();

      fetch(`${SCRIPT_URL}?action=getBankAccounts&sheetName=${encodeURIComponent(BANK_ACCOUNT_SHEET_NAME)}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayBankAccounts(data.data);
          } else {
            showError('ไม่สามารถโหลดข้อมูลบัญชีธนาคารได้');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error loading bank accounts:', error);
          showError('เกิดข้อผิดพลาดในการโหลดข้อมูลบัญชีธนาคาร');
          hideLoading();
        });
    }

    // ฟังก์ชันแสดงข้อมูลบัญชีธนาคาร
    function displayBankAccounts(accounts) {
      const tableBody = document.getElementById('bankAccountsTable');

      if (!accounts || accounts.length === 0) {
        tableBody.innerHTML = `
      <tr>
        <td colspan="7" class="px-4 py-3 text-center text-gray-500">ไม่พบข้อมูลบัญชีธนาคาร</td>
      </tr>
    `;
        return;
      }

      let html = '';
      let totalDeposits = 0;
      let totalWithdrawals = 0;
      let totalBalance = 0;

      // เรียงบัญชีตามรหัสบัญชี
      accounts.sort((a, b) => a['รหัสบัญชีธนาคาร'].localeCompare(b['รหัสบัญชีธนาคาร']));

      accounts.forEach(account => {
        const deposits = parseFloat(account['ฝากทั้งหมด']) || 0;
        const withdrawals = parseFloat(account['ถอนทั้งหมด']) || 0;
        const balance = parseFloat(account['คงเหลือ']) || 0;

        totalDeposits += deposits;
        totalWithdrawals += withdrawals;
        totalBalance += balance;

        // สร้าง HTML สำหรับแต่ละบัญชี
        html += `
      <tr class="border-b hover:bg-gray-50">
        <td class="px-4 py-3">
          <span class="bank-badge">${account['รหัสบัญชีธนาคาร']}</span>
        </td>
        <td class="px-4 py-3 font-medium">${account['ชื่อบัญชี']}</td>
        <td class="px-4 py-3"><div class="flex items-center">${account['ชื่อธนาคาร']}</div></td>
        <td class="px-4 py-3 font-mono">${formatAccountNumber(account['เลขที่บัญชี'])}</td>
        <td class="px-4 py-3 text-right text-green-600">${formatCurrency(deposits)}</td>
        <td class="px-4 py-3 text-right text-red-600">${formatCurrency(withdrawals)}</td>
        <td class="px-4 py-3 text-right font-semibold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}">
          ${formatCurrency(balance)}
        </td>
      </tr>
    `;
      });

      tableBody.innerHTML = html;
      // อัปเดตยอดรวม
      document.getElementById('totalDeposits').textContent = formatCurrency(totalDeposits) + ' บาท';
      document.getElementById('totalWithdrawals').textContent = formatCurrency(totalWithdrawals) + ' บาท';
      document.getElementById('totalBankBalance').textContent = formatCurrency(totalBalance) + ' บาท';
    }

    // ฟังก์ชันช่วยเหลือสำหรับบัญชีธนาคาร
    function getBankDomain(bankName) {
      const bankMap = {
        'กรุงเทพ': 'bbl.co.th',
        'กรุงไทย': 'ktb.co.th',
        'กสิกรไทย': 'kasikornbank.com',
        'ไทยพาณิชย์': 'scb.co.th',
        'ทหารไทย': 'tmb.co.th',
        'กรุงศรีอยุธยา': 'krungsri.com',
        'ออมสิน': 'gsb.or.th',
        'เกียรตินาคิน': 'kiatnakinbank.co.th',
        'ซีไอเอ็มบี': 'cimbthai.com',
        'ธนชาต': 'thanachartbank.co.th',
        'ยูโอบี': 'uob.co.th',
        'แลนด์ แอนด์ เฮาส์': 'lhbank.co.th'
      };
      return bankMap[bankName] || 'bank.co.th';
    }

    function formatAccountNumber(accountNumber) {
      if (!accountNumber) return '-';
      // 格式化银行账号显示，每4位用-分隔
      return accountNumber.toString()
        .replace(/\s+/g, '') // 移除所有空格
        .replace(/(\d{4})(?=\d)/g, '$1-');
    }

    function printBankAccountSummary() {
      const printWindow = window.open('', '_blank');
      const now = new Date();
      const formattedDate = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;
      // 1. 获取页面显示数据
      const totalDeposits = document.getElementById('totalDeposits').textContent;
      const totalWithdrawals = document.getElementById('totalWithdrawals').textContent;
      const totalBankBalance = document.getElementById('totalBankBalance').textContent;
      // 2. 收集所有银行账户数据
      const bankAccounts = [];
      document.querySelectorAll('#bankAccountsTable tr').forEach((row, index) => {
        // ข้ามเฉพาะแถวหัวตาราง (ถ้ามี)
        if (index === 0 && row.querySelector('th')) return;
        // ตรวจสอบว่าแถวมีข้อมูล
        if (row.cells.length > 0) {
          // ใช้เซลล์ที่มีอยู่
          const cells = row.cells;
          // ถ้ามีเซลล์น้อยกว่า 7 ก็ใช้เท่าที่มี
          bankAccounts.push({
            code: cells[0]?.textContent || '',
            name: cells[1]?.textContent || '',
            bank: cells[2]?.textContent || '',
            accountNo: cells[3]?.textContent || '',
            deposits: cells[4]?.textContent || '',
            withdrawals: cells[5]?.textContent || '',
            balance: cells[6]?.textContent || ''
          });
        }
      });

      // 3. 构建打印内容
      printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>รายงานสรุปยอดบัญชีธนาคาร</title>
      <style>
        body {
          font-family: 'Sarabun', sans-serif;
          padding: 20px;
          color: #333;
        }
        .header {
          text-align: center;
          margin-bottom: 30px;
        }
        .header h1 {
          font-size: 22px;
          margin-bottom: 5px;
        }
        .header h2 {
          font-size: 18px;
          font-weight: normal;
          margin-bottom: 20px;
        }
        .summary-cards {
          display: flex;
          justify-content: space-between;
          margin-bottom: 30px;
        }
        .summary-card {
          border: 1px solid #ddd;
          border-radius: 5px;
          padding: 15px;
          width: 32%;
          text-align: center;
        }
        .summary-card h3 {
          font-size: 16px;
          margin-bottom: 10px;
          color: #555;
        }
        .summary-card p {
          font-size: 18px;
          font-weight: bold;
          margin: 0;
        }
        .deposit {
          color: #28a745;
        }
        .withdrawal {
          color: #dc3545;
        }
        .balance {
          color: #17a2b8;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 30px;
        }
        th, td {
          border: 1px solid #ddd;
          padding: 10px;
          text-align: left;
        }
        th {
          background-color: #f5f5f5;
          font-weight: bold;
        }
        .text-right {
          text-align: right;
        }
        .signature-section {
          margin-top: 50px;
        }
        .signature-row {
          display: flex;
          justify-content: space-between;
          margin-top: 80px;
        }
        .signature-box {
          width: 45%;
          text-align: center;
        }
        .signature-line {
          border-top: 1px solid #333;
          width: 80%;
          margin: 0 auto;
          padding-top: 20px;
          margin-top: 60px;
        }

      </style>
    </head>
    <body>
      <div class="header">
        <h1>รายงานสรุปยอดบัญชีธนาคาร</h1>
        <h2>ณ วันที่ ${formattedDate}</h2>
      </div>
      
      <!-- สรุปยอดรวม -->
      <div class="summary-cards">
        <div class="summary-card">
          <h3>ยอดฝากรวมทั้งหมด</h3>
          <p class="deposit">${totalDeposits}</p>
        </div>
        <div class="summary-card">
          <h3>ยอดถอนรวมทั้งหมด</h3>
          <p class="withdrawal">${totalWithdrawals}</p>
        </div>
        <div class="summary-card">
          <h3>ยอดคงเหลือรวม</h3>
          <p class="balance">${totalBankBalance}</p>
        </div>
      </div>
      
      <!-- ตารางบัญชีธนาคาร -->
      <table>
        <thead>
          <tr>
            <th width="15%">รหัสบัญชี</th>
            <th width="20%">ชื่อบัญชี</th>
            <th width="20%">ธนาคาร</th>
            <th width="15%">เลขที่บัญชี</th>
            <th width="10%" class="text-right">ยอดฝาก</th>
            <th width="10%" class="text-right">ยอดถอน</th>
            <th width="10%" class="text-right">ยอดคงเหลือ</th>
          </tr>
        </thead>
        <tbody>
  `);

      // เพิ่มข้อมูลแต่ละบัญชี
      bankAccounts.forEach(account => {
        printWindow.document.write(`
      <tr>
        <td>${account.code}</td>
        <td>${account.name}</td>
        <td>${account.bank}</td>
        <td>${account.accountNo}</td>
        <td class="text-right deposit">${account.deposits}</td>
        <td class="text-right withdrawal">${account.withdrawals}</td>
        <td class="text-right balance">${account.balance}</td>
      </tr>
    `);
      });

      // ปิดตารางและเพิ่มส่วนลายเซ็น
      printWindow.document.write(`
        </tbody>
      </table>
      
      <!-- ส่วนลายเซ็น -->
      <div class="signature-section">
        <div class="signature-row">
          <div class="signature-box">
            <div>(  <?!= settings['ชื่อผู้จัดทำบัญชี'] ?>  )</div>
            <div>ตำแหน่ง..........................................................</div>
            <div>ผู้จัดทำบัญชี</div>
            <div class="signature-line">วันที่......../.................../...........</div>
          </div>
          <div class="signature-box">
            <div>(  <?!= settings['ชื่อเจ้าอาวาส'] ?>  )</div>
            <div>ตำแหน่ง..........................................................</div>
            <div>ผู้ตรวจสอบบัญชี</div>
            <div class="signature-line">วันที่......../.................../...........</div>
          </div>
        </div>
      </div>
    </body>
    </html>
  `);

      printWindow.document.close();
      printWindow.focus();

      // รอให้เนื้อหาถูกโหลดก่อนพิมพ์
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }



    // ฟังก์ชัน Export เป็น Excel
    function exportBankAccountsToExcel() {
      showLoading();

      fetch(`${SCRIPT_URL}?action=getBankAccounts&sheetName=${encodeURIComponent(BANK_ACCOUNT_SHEET_NAME)}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const accounts = data.data;

            // สร้างข้อมูลสำหรับ Excel
            const excelData = [
              ['รายงานสรุปยอดเงินบัญชีธนาคาร'],
              [`วันที่ ${new Date().toLocaleDateString('th-TH')}`],
              [],
              ['รหัสบัญชี', 'ชื่อบัญชี', 'ธนาคาร', 'เลขที่บัญชี', 'ยอดฝาก', 'ยอดถอน', 'ยอดคงเหลือ']
            ];

            // เพิ่มข้อมูลบัญชี
            accounts.forEach(account => {
              excelData.push([
                account['รหัสบัญชีธนาคาร'],
                account['ชื่อบัญชี'],
                account['ชื่อธนาคาร'],
                account['เลขที่บัญชี'],
                parseFloat(account['ฝากทั้งหมด']) || 0,
                parseFloat(account['ถอนทั้งหมด']) || 0,
                parseFloat(account['คงเหลือ']) || 0
              ]);
            });

            // เพิ่มสรุปยอดรวม
            const totalDeposits = accounts.reduce((sum, acc) => sum + (parseFloat(acc['ฝากทั้งหมด']) || 0), 0);
            const totalWithdrawals = accounts.reduce((sum, acc) => sum + (parseFloat(acc['ถอนทั้งหมด']) || 0), 0);
            const totalBalance = accounts.reduce((sum, acc) => sum + (parseFloat(acc['คงเหลือ']) || 0), 0);

            excelData.push([], ['รวมทั้งหมด', '', '', '', totalDeposits, totalWithdrawals, totalBalance]);

            // สร้างไฟล์ Excel
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "บัญชีธนาคาร");

            // กำหนดความกว้างของคอลัมน์
            ws['!cols'] = [
              { wch: 15 }, // รหัสบัญชี
              { wch: 25 }, // ชื่อบัญชี
              { wch: 20 }, // ธนาคาร
              { wch: 15 }, // เลขที่บัญชี
              { wch: 15 }, // ยอดฝาก
              { wch: 15 }, // ยอดถอน
              { wch: 15 }  // ยอดคงเหลือ
            ];

            // Export ไฟล์
            XLSX.writeFile(wb, `สรุปบัญชีธนาคาร_${new Date().toISOString().slice(0, 10)}.xlsx`);
          } else {
            showError('ไม่สามารถโหลดข้อมูลบัญชีธนาคารได้');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error exporting bank accounts:', error);
          showError('เกิดข้อผิดพลาดในการส่งออกข้อมูล');
          hideLoading();
        });
    }



















    // ฟังก์ชันโหลดข้อมูลสรุปยอดเงินคงเหลือ
    function loadBalanceSummary() {
      showLoading();

      // 1. 获取银行账户数据
      fetch(`${SCRIPT_URL}?action=getBankAccounts&sheetName=${encodeURIComponent(BANK_ACCOUNT_SHEET_NAME)}`)
        .then(response => response.json())
        .then(bankData => {
          if (!bankData.success) {
            throw new Error('ไม่สามารถโหลดข้อมูลบัญชีธนาคารได้');
          }

          // 2. 计算现金余额
          const cashIncome = allData
            .filter(item => item.type === 'income')
            .reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

          const cashExpense = allData
            .filter(item => item.type === 'expense')
            .reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

          const cashOnHand = cashIncome - cashExpense;

          // 3. 处理银行账户数据
          const bankAccounts = bankData.data || [];
          const bankBalanceData = bankAccounts.map(account => ({
            'ธนาคาร': account['ชื่อธนาคาร'],
            'ชื่อบัญชี': account['ชื่อบัญชี'],
            'เลขที่บัญชี': account['เลขที่บัญชี'],
            'ยอดเงิน': parseFloat(account['คงเหลือ']) || 0
          }));

          // 4. 计算银行总余额
          const totalBankBalance = bankBalanceData.reduce((sum, account) => sum + account['ยอดเงิน'], 0);

          // 5. 显示结果
          displayDetailedBalanceSummary(cashOnHand, bankBalanceData, totalBankBalance);
          hideLoading();
        })
        .catch(error => {
          console.error('Error:', error);
          showError(error.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
          hideLoading();
        });
    }


    function displayDetailedBalanceSummary(cashOnHand, bankAccounts, totalBankBalance) {
      const now = new Date();
      const formattedDate = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;

      // 更新日期显示
      document.getElementById('balanceSummaryDate').textContent = formattedDate;

      // 1. 创建现金行
      let html = `
    <div class="bg-white rounded-lg shadow mb-6">
      <div class="p-4 border-b">
        <h3 class="font-semibold text-lg">เงินสดในมือ</h3>
      </div>
      <div class="p-4">
        <div class="flex justify-between items-center">
          <span>ยอดเงินสดคงเหลือ</span>
          <span class="font-bold text-blue-600">${formatCurrency(cashOnHand)} บาท</span>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow mb-6">
      <div class="p-4 border-b">
        <h3 class="font-semibold text-lg">ยอดเงินในบัญชีธนาคาร</h3>
      </div>
  `;

      // 2. 添加每个银行账户
      bankAccounts.forEach(account => {
        html += `
  <div class="bank-account p-4 border-b">
    <div class="flex justify-between items-center mb-1">
      <span class="bank-name font-medium">${account['ธนาคาร']}</span>
      <span class="account-balance font-bold ${account['ยอดเงิน'] >= 0 ? 'text-green-600' : 'text-red-600'}">
        ${formatCurrency(account['ยอดเงิน'])} บาท
      </span>
    </div>
    <div class="text-sm text-gray-600">
      <span class="account-name">${account['ชื่อบัญชี']}</span> 
      (<span class="account-number">${formatAccountNumber(account['เลขที่บัญชี'])}</span>)
    </div>
  </div>
`;
      });

      // 3. 添加银行总余额
      html += `
      <div class="p-4 bg-gray-50">
        <div class="flex justify-between items-center">
          <span class="font-semibold">รวมยอดเงินในบัญชีธนาคาร</span>
          <span class="font-bold text-purple-600">${formatCurrency(totalBankBalance)} บาท</span>
        </div>
      </div>
    </div>
    
    <!-- รวมยอดทั้งหมด -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="flex justify-between items-center">
        <span class="font-semibold text-lg">รวมเงินคงเหลือทั้งหมด</span>
        <span class="font-bold text-xl ${(cashOnHand + totalBankBalance) >= 0 ? 'text-green-600' : 'text-red-600'}">
          ${formatCurrency(cashOnHand + totalBankBalance)} บาท
        </span>
      </div>
    </div>
  `;

      // 4. 更新显示
      document.getElementById('balanceSummaryTable').innerHTML = html;

      // 5. 更新卡片数据
      document.getElementById('cashOnHandAmount').textContent = formatCurrency(cashOnHand) + ' บาท';
      document.getElementById('bankBalanceAmount').textContent = formatCurrency(totalBankBalance) + ' บาท';
      document.getElementById('totalBalanceAmount').textContent = formatCurrency(cashOnHand + totalBankBalance) + ' บาท';
    }


    function displayBalanceSummary(balanceData) {
      const tableBody = document.getElementById('balanceSummaryTable');
      const now = new Date();
      const formattedDate = `ณ วันที่ ${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;

      document.getElementById('balanceSummaryDate').textContent = formattedDate;

      // คำนวณยอดเงินสด
      const cashIncome = allData
        .filter(item => item.type === 'income')
        .reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

      const cashExpense = allData
        .filter(item => item.type === 'expense')
        .reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

      const cashOnHand = cashIncome - cashExpense;

      // ตรวจสอบข้อมูล balanceData
      if (!balanceData || !balanceData.success || !balanceData.data) {
        balanceData = { data: [] };
      }

      // กรองข้อมูลธนาคารและคำนวณยอดรวม
      const bankAccounts = balanceData.data.filter(item => item['รายการ'].includes('ธนาคาร'));
      const totalBankBalance = bankAccounts.reduce((sum, item) => sum + (parseFloat(item['จำนวนเงิน']) || 0), 0);

      // สร้างแถวตาราง
      let html = '';
      let totalBalance = cashOnHand;

      // เพิ่มแถวเงินสด
      html += `
    <tr class="hover:bg-blue-50">
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
          <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
            <i class="fas fa-wallet text-blue-600"></i>
          </div>
          <div class="ml-4">
            <div class="text-sm font-medium text-gray-900">เงินสดในมือ</div>
            <div class="text-sm text-gray-500">เงินสดที่อยู่ในมือทั้งหมด</div>
          </div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-right text-blue-600 font-bold">
        ${formatCurrency(cashOnHand)} บาท
      </td>
    </tr>
  `;

      // เพิ่มแถวธนาคารแต่ละบัญชี
      bankAccounts.forEach(account => {
        const amount = parseFloat(account['จำนวนเงิน']) || 0;
        totalBalance += amount;

        // แยกชื่อธนาคารและเลขที่บัญชี
        const accountInfo = account['รายการ'].split('-');
        const bankName = accountInfo[0].trim();
        const accountNumber = accountInfo[1] ? accountInfo[1].trim() : '';

        html += `
      <tr class="hover:bg-purple-50">
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="flex items-center">
            <div class="flex-shrink-0 h-10 w-10 bg-purple-100 rounded-full flex items-center justify-center">
              <i class="fas fa-university text-purple-600"></i>
            </div>
            <div class="ml-4">
              <div class="text-sm font-medium text-gray-900">${bankName}</div>
              <div class="text-sm text-gray-500">${accountNumber || 'ไม่ระบุเลขที่บัญชี'}</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-purple-600 font-bold">
          ${formatCurrency(amount)} บาท
        </td>
      </tr>
    `;
      });

      tableBody.innerHTML = html;

      // อัปเดตการ์ดสรุป
      document.getElementById('cashOnHandAmount').textContent = formatCurrency(cashOnHand) + ' บาท';
      document.getElementById('bankBalanceAmount').textContent = formatCurrency(totalBankBalance) + ' บาท';
      document.getElementById('totalBalanceAmount').textContent = formatCurrency(totalBalance) + ' บาท';
      document.getElementById('tableTotalBalance').textContent = formatCurrency(totalBalance) + ' บาท';

      // เพิ่ม animation เมื่อโหลดเสร็จ
      const cards = document.querySelectorAll('.balance-card');
      cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'all 0.5s ease ' + (index * 0.1) + 's';

        setTimeout(() => {
          card.style.opacity = '1';
          card.style.transform = 'translateY(0)';
        }, 100);
      });
    }




    // ฟังก์ชันพิมพ์รายงานสรุปยอดเงินคงเหลือ
    function printBalanceSummary() {
      const printWindow = window.open('', '_blank');
      const now = new Date();
      const formattedDate = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;

      // 1. เก็บข้อมูลจากหน้าเว็บ
      const cashOnHand = document.getElementById('cashOnHandAmount').textContent;
      const bankBalance = document.getElementById('bankBalanceAmount').textContent;
      const totalBalance = document.getElementById('totalBalanceAmount').textContent;

      // 2. เก็บข้อมูลบัญชีธนาคารแต่ละบัญชี
      const bankAccounts = [];
      document.querySelectorAll('#balanceSummaryTable .bank-account').forEach(account => {
        bankAccounts.push({
          bank: account.querySelector('.bank-name').textContent,
          accountName: account.querySelector('.account-name').textContent,
          accountNumber: account.querySelector('.account-number').textContent,
          balance: account.querySelector('.account-balance').textContent
        });
      });

      // 3. สร้าง HTML สำหรับพิมพ์
      printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>รายงานสรุปยอดเงินคงเหลือ</title>
      <style>
        body { 
          font-family: 'Sarabun', sans-serif;
          padding: 20px;
          color: #333;
        }
        .header {
          text-align: center;
          margin-bottom: 30px;
        }
        .header h1 {
          font-size: 22px;
          margin-bottom: 5px;
        }
        .header h2 {
          font-size: 18px;
          font-weight: normal;
          margin-bottom: 20px;
        }
        .section {
          margin-bottom: 25px;
        }
        .section-title {
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 10px;
          padding-bottom: 5px;
          border-bottom: 1px solid #ddd;
        }
        .account-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 15px;
        }
        .account-table th, 
        .account-table td {
          border: 1px solid #ddd;
          padding: 8px 12px;
          text-align: left;
        }
        .account-table th {
          background-color: #f5f5f5;
          font-weight: bold;
        }
        .text-right {
          text-align: right;
        }
        .total-row {
          font-weight: bold;
          background-color: #f9f9f9;
        }
        .signature-section {
          margin-top: 50px;
        }
        .signature-row {
          display: flex;
          justify-content: space-between;
          margin-top: 80px;
        }
        .signature-box {
          width: 45%;
          text-align: center;
        }
        .signature-line {
          border-top: 1px solid #333;
          width: 80%;
          margin: 0 auto;
          padding-top: 20px;
          margin-top: 60px;
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>รายงานสรุปยอดเงินคงเหลือ</h1>
        <h2>ณ วันที่ ${formattedDate}</h2>
      </div>
      
      <!-- เงินสดส่วน -->
      <div class="section">
        <div class="section-title">เงินสดในมือ</div>
        <table class="account-table">
          <tr>
            <td width="70%">ยอดเงินสดคงเหลือ</td>
            <td width="30%" class="text-right">${cashOnHand}</td>
          </tr>
        </table>
      </div>
      
      <!-- บัญชีธนาคารส่วน -->
      <div class="section">
        <div class="section-title">ยอดเงินในบัญชีธนาคาร</div>
        <table class="account-table">
          <thead>
            <tr>
              <th width="25%">ธนาคาร</th>
              <th width="30%">ชื่อบัญชี</th>
              <th width="20%">เลขที่บัญชี</th>
              <th width="25%" class="text-right">ยอดเงิน</th>
            </tr>
          </thead>
          <tbody>
  `);

      // เพิ่มข้อมูลแต่ละบัญชีธนาคาร
      bankAccounts.forEach(account => {
        printWindow.document.write(`
      <tr>
        <td>${account.bank}</td>
        <td>${account.accountName}</td>
        <td>${account.accountNumber}</td>
        <td class="text-right">${account.balance}</td>
      </tr>
    `);
      });

      // ปิดตารางและเพิ่มสรุป
      printWindow.document.write(`
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td colspan="3">รวมยอดเงินในบัญชีธนาคาร</td>
              <td class="text-right">${bankBalance}</td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <!-- รวมยอดทั้งหมด -->
      <div class="section">
        <table class="account-table">
          <tr class="total-row">
            <td colspan="3">รวมเงินคงเหลือทั้งหมด</td>
            <td class="text-right">${totalBalance}</td>
          </tr>
        </table>
      </div>
      
      <!-- ส่วนลายเซ็น -->
      <div class="signature-section">
        <div class="signature-row">
          <div class="signature-box">
            <div>(  <?!= settings['ชื่อผู้จัดทำบัญชี'] ?>  )</div>
            <div>ตำแหน่ง..........................................................</div>
            <div>ผู้จัดทำบัญชี</div>
            <div class="signature-line">วันที่......../................../...........</div>
          </div>
          <div class="signature-box">
            <div>(  <?!= settings['ชื่อเจ้าอาวาส'] ?>  )</div>
            <div>ตำแหน่ง..........................................................</div>
            <div>ผู้ตรวจสอบบัญชี</div>
            <div class="signature-line">วันที่......./................../............</div>
          </div>
        </div>
      </div>
    </body>
    </html>
  `);

      printWindow.document.close();
      printWindow.focus();

      // รอให้เนื้อหาถูกโหลดก่อนพิมพ์
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }



    // ฟังก์ชัน Export เป็น Excel สำหรับสรุปยอดเงินคงเหลือ
    function exportBalanceSummaryToExcel() {
      showLoading();

      // 1. เก็บข้อมูลจากหน้าเว็บ
      const cashOnHand = document.getElementById('cashOnHandAmount').textContent.replace(' บาท', '');
      const bankBalance = document.getElementById('bankBalanceAmount').textContent.replace(' บาท', '');
      const totalBalance = document.getElementById('totalBalanceAmount').textContent.replace(' บาท', '');

      // 2. เก็บข้อมูลบัญชีธนาคารแต่ละบัญชี
      const bankAccounts = [];
      document.querySelectorAll('#balanceSummaryTable .bank-account').forEach(account => {
        bankAccounts.push({
          bank: account.querySelector('.bank-name').textContent,
          accountName: account.querySelector('.account-name').textContent,
          accountNumber: account.querySelector('.account-number').textContent,
          balance: account.querySelector('.account-balance').textContent.replace(' บาท', '')
        });
      });

      // 3. สร้างข้อมูลสำหรับ Excel
      const excelData = [
        ['รายงานสรุปยอดเงินคงเหลือ'],
        [`วันที่ ${new Date().toLocaleDateString('th-TH')}`],
        [],
        ['เงินสดในมือ', '', '', cashOnHand],
        [],
        ['ยอดเงินในบัญชีธนาคาร'],
        ['ธนาคาร', 'ชื่อบัญชี', 'เลขที่บัญชี', 'ยอดเงิน']
      ];

      // เพิ่มข้อมูลแต่ละบัญชี
      bankAccounts.forEach(account => {
        excelData.push([
          account.bank,
          account.accountName,
          account.accountNumber,
          parseFloat(account.balance.replace(/,/g, ''))
        ]);
      });

      // เพิ่มสรุป
      excelData.push(
        [],
        ['รวมยอดเงินในบัญชีธนาคาร', '', '', parseFloat(bankBalance.replace(/,/g, ''))],
        [],
        ['รวมเงินคงเหลือทั้งหมด', '', '', parseFloat(totalBalance.replace(/,/g, ''))],
        [],
        [],
        ['รับรองข้อมูลตามนี้'],
        [],
        ['ผู้จัดทำบัญชี', '', 'ผู้ตรวจสอบบัญชี', ''],
        ['(  <?!= settings['ชื่อผู้จัดทำบัญชี'] ?>  )', '', '(  <?!= settings['ชื่อเจ้าอาวาส'] ?>  )', ''],
        ['ตำแหน่ง...................................', '', 'ตำแหน่ง...................................', ''],
        ['วันที่......../................./............', '', 'วันที่......../................./...........', '']
      );

      // 4. สร้างไฟล์ Excel
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "สรุปยอดเงินคงเหลือ");

      // กำหนดความกว้างของคอลัมน์
      ws['!cols'] = [
        { wch: 25 }, // ธนาคาร
        { wch: 30 }, // ชื่อบัญชี
        { wch: 20 }, // เลขที่บัญชี
        { wch: 15 }  // ยอดเงิน
      ];

      // 5. Export ไฟล์
      const fileName = `สรุปยอดเงินคงเหลือ_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      hideLoading();
    }



















    // เพิ่มฟังก์ชันโหลดรหัสการโอน
    function loadTransferCodes() {
      showLoading();
      fetch(`${SCRIPT_URL}?action=getTransferCodes`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            transferCodes = data.data;
            const dropdown = document.getElementById('transferCode');

            // ล้างตัวเลือกเก่า
            while (dropdown.options.length > 1) {
              dropdown.remove(1);
            }

            transferCodes.forEach(code => {
              const option = document.createElement('option');
              option.value = code.code;
              option.textContent = `${code.code} - ${code.description}`;
              dropdown.appendChild(option);
            });
          } else {
            showError('ไม่สามารถโหลดรหัสการโอนได้');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error loading transfer codes:', error);
          showError('เกิดข้อผิดพลาดในการโหลดรหัสการโอน');
          hideLoading();
        });
    }

    // เพิ่มฟังก์ชันส่งฟอร์มโอนเงิน
    function submitTransferForm() {
      const form = document.getElementById('transferForm');
      const formData = new FormData(form);
      const id = formData.get('id');

      // ตรวจสอบว่าเป็นการแก้ไขหรือเพิ่มใหม่
      const action = id ? 'updateTransferData' : 'addTransferData';

      // Create URL parameters
      const params = new URLSearchParams();
      params.append('action', action);

      // เพิ่มข้อมูลจากฟอร์ม
      for (const [key, value] of formData.entries()) {
        if (value) params.append(key, value);
      }

      showLoading();
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: params
      })
        .then(response => response.json())
        .then(data => {
          // ในฟังก์ชัน submitTransferForm()
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'สำเร็จ',
              text: id ? 'อัปเดตข้อมูลโอนเรียบร้อยแล้ว' : 'บันทึกข้อมูลโอนเรียบร้อยแล้ว',
              confirmButtonText: 'ตกลง',
              confirmButtonColor: '#4f46e5'
            });
            resetForm('transferForm'); // รีเซ็ตฟอร์มหลังบันทึกสำเร็จ
            loadTransferData(); // โหลดข้อมูลใหม่หลังอัปเดต

          } else {
            showError(data.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error submitting transfer form:', error);
          showError('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
          hideLoading();
        });
    }





    // เพิ่มฟังก์ชันโหลดข้อมูลโอน
    function loadTransferData() {
      showLoading();
      fetch(`${SCRIPT_URL}?action=getTransferData`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            transferData = data.data;
            applyTransferFilters();
          } else {
            showError('ไม่สามารถโหลดข้อมูลโอนได้');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error loading transfer data:', error);
          showError('เกิดข้อผิดพลาดในการโหลดข้อมูลโอน');
          hideLoading();
        });
    }

    // เพิ่มฟังก์ชันกรองข้อมูลโอน
    function applyTransferFilters() {
      const monthFilter = document.getElementById('transferFilterMonth').value;
      const yearFilter = document.getElementById('transferFilterYear').value;

      filteredTransferData = transferData.filter(item => {
        if (monthFilter !== 'all' && parseInt(item.month) !== parseInt(monthFilter)) return false;
        if (yearFilter !== 'all' && parseInt(item.year) !== parseInt(yearFilter)) return false;
        return true;
      });

      transferCurrentPage = 1;
      displayTransferData();
    }

    // เพิ่มฟังก์ชันแสดงข้อมูลโอน
    function displayTransferData() {
      const tableBody = document.getElementById('transferDataTable');
      tableBody.innerHTML = '';

      if (filteredTransferData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
      <td colspan="7" class="px-4 py-3 text-center text-gray-500">ไม่พบข้อมูล</td>
    `;
        tableBody.appendChild(row);

        updateTransferPagination(0, 0, 0);
        return;
      }

      const startIndex = (transferCurrentPage - 1) * transferRecordsPerPage;
      const endIndex = Math.min(startIndex + transferRecordsPerPage, filteredTransferData.length);
      const pageData = filteredTransferData.slice(startIndex, endIndex);

      pageData.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';

        const date = `${item.day} ${thaiMonths[parseInt(item.month) - 1]} ${item.year}`;
        const formattedAmount = parseFloat(item.amount).toLocaleString('th-TH', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });

        row.innerHTML = `
      <td class="px-4 py-3">${date}</td>
      <td class="px-4 py-3">${item.docNo || '-'}</td>
      <td class="px-4 py-3">${item.description}</td>
      <td class="px-4 py-3">${item.code || '-'}</td>
      <td class="px-4 py-3 text-right text-blue-600">${formattedAmount}</td>
      <td class="px-4 py-3 text-center">
        ${item.imageUrl ?
            `<button class="view-transfer-image text-blue-600 hover:text-blue-800" data-url="${item.imageUrl}">
            <i class="fas fa-image"></i>
          </button>` :
            '<span class="text-gray-400">-</span>'
          }
      </td>
      <td class="px-4 py-3 text-center">
        <button class="edit-transfer-item text-blue-600 hover:text-blue-800 mx-1" data-id="${item.id}">
          <i class="fas fa-edit"></i>
        </button>
        <button class="delete-transfer-item text-red-600 hover:text-red-800 mx-1" data-id="${item.id}">
          <i class="fas fa-trash-alt"></i>
        </button>
      </td>
    `;

        tableBody.appendChild(row);
      });

      updateTransferPagination(startIndex + 1, endIndex, filteredTransferData.length);

      // Add event listeners
      document.querySelectorAll('.view-transfer-image').forEach(button => {
        button.addEventListener('click', function () {
          const imageUrl = this.getAttribute('data-url');
          openImageModal(imageUrl);
        });
      });

      document.querySelectorAll('.edit-transfer-item').forEach(button => {
        button.addEventListener('click', function () {
          const id = this.getAttribute('data-id');
          editTransferItem(id);
        });
      });

      document.querySelectorAll('.delete-transfer-item').forEach(button => {
        button.addEventListener('click', function () {
          const id = this.getAttribute('data-id');
          openDeleteTransferModal(id);
        });
      });
    }

    // เพิ่มฟังก์ชันอัปเดต pagination ข้อมูลโอน
    function updateTransferPagination(start, end, total) {
      document.getElementById('transferStartRecord').textContent = total > 0 ? start : 0;
      document.getElementById('transferEndRecord').textContent = end;
      document.getElementById('transferTotalRecords').textContent = total;
      document.getElementById('transferCurrentPage').textContent = transferCurrentPage;

      const totalPages = Math.ceil(total / transferRecordsPerPage);
      document.getElementById('transferPrevPage').disabled = transferCurrentPage <= 1;
      document.getElementById('transferNextPage').disabled = transferCurrentPage >= totalPages;
    }

    // เพิ่มฟังก์ชันแก้ไขรายการโอน
    function editTransferItem(id) {
      const item = transferData.find(item => item.id === id);
      if (!item) return;

      // Switch to transfer tab
      document.getElementById('transferTab').click();

      // Fill form fields
      const form = document.getElementById('transferForm');
      form.querySelector('input[name="id"]').value = item.id;
      document.getElementById('transferDay').value = item.day;
      document.getElementById('transferMonth').value = item.month;
      document.getElementById('transferYear').value = item.year;
      document.getElementById('transferDocNo').value = item.docNo || '';
      document.getElementById('transferDescription').value = item.description || '';
      document.getElementById('transferCode').value = item.code || '';
      document.getElementById('transferAmount').value = item.amount || '';
      document.getElementById('transferImageUrl').value = item.imageUrl || '';

      // Update image preview
      const preview = document.getElementById('transferImagePreview');
      if (item.imageUrl) {
        preview.innerHTML = '';
        preview.style.backgroundImage = `url(${item.imageUrl})`;
      } else {
        preview.style.backgroundImage = '';
        preview.innerHTML = '<i class="fas fa-image text-gray-400 text-4xl"></i>';
      }

      // แสดงข้อความว่าเป็นการแก้ไข
      const submitButton = form.querySelector('button[type="submit"]');
      submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>อัปเดตข้อมูล';
    }


    // แก้ไขฟังก์ชันเปิด modal ลบข้อมูลโอน
    function openDeleteTransferModal(id) {
      openDeleteModal(id, null); // ส่ง type เป็น null สำหรับข้อมูลโอน
    }

    // เพิ่มฟังก์ชันลบรายการโอน
    // function deleteTransferItem() {
    //   if (!currentDeleteId) return;

    //   const params = new URLSearchParams();
    //   params.append('action', 'deleteTransferData');
    //   params.append('id', currentDeleteId);

    //   showLoading();
    //   fetch(SCRIPT_URL, {
    //     method: 'POST',
    //     body: params
    //   })
    //   .then(response => response.json())
    //   .then(data => {
    //     if (data.success) {
    //       Swal.fire({
    //         icon: 'success',
    //         title: 'สำเร็จ',
    //         text: 'ลบข้อมูลการโอนเรียบร้อยแล้ว',
    //         confirmButtonText: 'ตกลง',
    //         confirmButtonColor: '#4f46e5'
    //       });
    //       loadTransferData();
    //     } else {
    //       showError(data.message || 'เกิดข้อผิดพลาดในการลบข้อมูล');
    //     }
    //     closeDeleteModal();
    //     hideLoading();
    //   })
    //   .catch(error => {
    //     console.error('Error deleting transfer item:', error);
    //     showError('เกิดข้อผิดพลาดในการลบข้อมูล');
    //     closeDeleteModal();
    //     hideLoading();
    //   });
    // }


    // ในส่วน setupEventListeners() ให้เพิ่มฟังก์ชันนี้
    function setCurrentDateToTransferForm() {
      try {
        const now = new Date();
        const currentDay = now.getDate();
        const currentMonth = now.getMonth() + 1; // เดือนใน JavaScript เป็น 0-11
        const currentYear = now.getFullYear() + 543; // แปลงเป็น พ.ศ.

        // ตั้งค่ารายการโอน
        document.getElementById('transferDay').value = currentDay;
        document.getElementById('transferMonth').value = currentMonth;
        document.getElementById('transferYear').value = currentYear;

        // ตรวจสอบว่ามีวันที่ใน dropdown หรือไม่
        setTimeout(() => {
          const transferDaySelect = document.getElementById('transferDay');
          if (transferDaySelect && transferDaySelect.value === "" && transferDaySelect.options.length > currentDay) {
            transferDaySelect.selectedIndex = currentDay; // เลือกวันที่ปัจจุบัน
          }
        }, 100);
      } catch (error) {
        console.error('Error setting current date to transfer form:', error);
      }
    }
















    // ฟังก์ชันโหลดข้อมูลตัดโอน
    // ฟังก์ชันโหลดข้อมูลตัดโอน
    function loadWithdrawData() {
      showLoading();
      fetch(`${SCRIPT_URL}?action=getWithdrawData`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            withdrawData = data.data;

            // อัปเดต years สำหรับ dropdown กรอง
            data.data.forEach(item => {
              if (item.year) {
                years.add(parseInt(item.year));
              }
            });

            applyWithdrawFilters();
          } else {
            showError('ไม่สามารถโหลดข้อมูลตัดโอนได้');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error loading withdraw data:', error);
          showError('เกิดข้อผิดพลาดในการโหลดข้อมูลตัดโอน');
          hideLoading();
        });
    }

    // ฟังก์ชันกรองข้อมูลตัดโอน
    function applyWithdrawFilters() {
      const monthFilter = document.getElementById('withdrawFilterMonth').value;
      const yearFilter = document.getElementById('withdrawFilterYear').value;

      filteredWithdrawData = withdrawData.filter(item => {
        if (monthFilter !== 'all' && parseInt(item.month) !== parseInt(monthFilter)) return false;
        if (yearFilter !== 'all' && parseInt(item.year) !== parseInt(yearFilter)) return false;
        return true;
      });

      withdrawCurrentPage = 1;
      displayWithdrawData();
    }

    // ฟังก์ชันแสดงข้อมูลตัดโอน
    function displayWithdrawData() {
      const tableBody = document.getElementById('withdrawDataTable');
      tableBody.innerHTML = '';

      if (filteredWithdrawData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
      <td colspan="7" class="px-4 py-3 text-center text-gray-500">ไม่พบข้อมูล</td>
    `;
        tableBody.appendChild(row);

        updateWithdrawPagination(0, 0, 0);
        return;
      }

      const startIndex = (withdrawCurrentPage - 1) * withdrawRecordsPerPage;
      const endIndex = Math.min(startIndex + withdrawRecordsPerPage, filteredWithdrawData.length);
      const pageData = filteredWithdrawData.slice(startIndex, endIndex);

      pageData.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';

        const date = `${item.day} ${thaiMonths[parseInt(item.month) - 1]} ${item.year}`;
        const formattedAmount = parseFloat(item.amount).toLocaleString('th-TH', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });

        row.innerHTML = `
      <td class="px-4 py-3">${date}</td>
      <td class="px-4 py-3">${item.docNo || '-'}</td>
      <td class="px-4 py-3">${item.description}</td>
      <td class="px-4 py-3">${item.code || '-'}</td>
      <td class="px-4 py-3 text-right text-orange-600">${formattedAmount}</td>
      <td class="px-4 py-3 text-center">
        ${item.imageUrl ?
            `<button class="view-withdraw-image text-blue-600 hover:text-blue-800" data-url="${item.imageUrl}">
            <i class="fas fa-image"></i>
          </button>` :
            '<span class="text-gray-400">-</span>'
          }
      </td>
      <td class="px-4 py-3 text-center">
        <button class="edit-withdraw-item text-blue-600 hover:text-blue-800 mx-1" data-id="${item.id}">
          <i class="fas fa-edit"></i>
        </button>
        <button class="delete-withdraw-item text-red-600 hover:text-red-800 mx-1" data-id="${item.id}">
          <i class="fas fa-trash-alt"></i>
        </button>
      </td>
    `;

        tableBody.appendChild(row);
      });

      updateWithdrawPagination(startIndex + 1, endIndex, filteredWithdrawData.length);

      // Add event listeners
      document.querySelectorAll('.view-withdraw-image').forEach(button => {
        button.addEventListener('click', function () {
          const imageUrl = this.getAttribute('data-url');
          openImageModal(imageUrl);
        });
      });

      document.querySelectorAll('.edit-withdraw-item').forEach(button => {
        button.addEventListener('click', function () {
          const id = this.getAttribute('data-id');
          editWithdrawItem(id);
        });
      });

      document.querySelectorAll('.delete-withdraw-item').forEach(button => {
        button.addEventListener('click', function () {
          const id = this.getAttribute('data-id');
          openDeleteWithdrawModal(id);
        });
      });
    }

    // ฟังก์ชันอัปเดต pagination ข้อมูลตัดโอน
    function updateWithdrawPagination(start, end, total) {
      document.getElementById('withdrawStartRecord').textContent = total > 0 ? start : 0;
      document.getElementById('withdrawEndRecord').textContent = end;
      document.getElementById('withdrawTotalRecords').textContent = total;
      document.getElementById('withdrawCurrentPage').textContent = withdrawCurrentPage;

      const totalPages = Math.ceil(total / withdrawRecordsPerPage);
      document.getElementById('withdrawPrevPage').disabled = withdrawCurrentPage <= 1;
      document.getElementById('withdrawNextPage').disabled = withdrawCurrentPage >= totalPages;
    }

    // ฟังก์ชันส่งฟอร์มตัดโอน
    function submitWithdrawForm() {
      const form = document.getElementById('withdrawForm');
      const formData = new FormData(form);
      const id = formData.get('id');

      const action = id ? 'updateWithdrawData' : 'addWithdrawData';

      const params = new URLSearchParams();
      params.append('action', action);

      for (const [key, value] of formData.entries()) {
        if (value) params.append(key, value);
      }

      showLoading();
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: params
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'สำเร็จ',
              text: id ? 'อัปเดตข้อมูลตัดโอนเรียบร้อยแล้ว' : 'บันทึกข้อมูลตัดโอนเรียบร้อยแล้ว',
              confirmButtonText: 'ตกลง',
              confirmButtonColor: '#4f46e5'
            });
            resetForm('withdrawForm');
            loadWithdrawData();
          } else {
            showError(data.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error submitting withdraw form:', error);
          showError('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
          hideLoading();
        });
    }

    // ฟังก์ชันแก้ไขรายการตัดโอน
    function editWithdrawItem(id) {
      const item = withdrawData.find(item => item.id === id);
      if (!item) return;

      document.getElementById('withdrawTab').click();

      const form = document.getElementById('withdrawForm');
      form.querySelector('input[name="id"]').value = item.id;
      document.getElementById('withdrawDay').value = item.day;
      document.getElementById('withdrawMonth').value = item.month;
      document.getElementById('withdrawYear').value = item.year;
      document.getElementById('withdrawDocNo').value = item.docNo || '';
      document.getElementById('withdrawDescription').value = item.description || '';
      document.getElementById('withdrawCode').value = item.code || '';
      document.getElementById('withdrawAmount').value = item.amount || '';
      document.getElementById('withdrawImageUrl').value = item.imageUrl || '';

      const preview = document.getElementById('withdrawImagePreview');
      if (item.imageUrl) {
        preview.innerHTML = '';
        preview.style.backgroundImage = `url(${item.imageUrl})`;
      } else {
        preview.style.backgroundImage = '';
        preview.innerHTML = '<i class="fas fa-image text-gray-400 text-4xl"></i>';
      }

      const submitButton = form.querySelector('button[type="submit"]');
      submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>อัปเดตข้อมูล';
    }

    // ฟังก์ชันเปิด modal ลบข้อมูลตัดโอน
    // ฟังก์ชันเปิด modal ลบข้อมูลตัดโอน
    function openDeleteWithdrawModal(id) {
      currentDeleteId = id;
      currentDeleteType = null; // ตั้งค่าเป็น null สำหรับข้อมูลโอน/ตัดโอน
      document.getElementById('deleteModal').style.display = 'block';

      // ตั้งค่าข้อความใน modal
      const modalTitle = document.querySelector('#deleteModal h3');
      const modalMessage = document.querySelector('#deleteModal p');

      modalTitle.textContent = 'ยืนยันการลบข้อมูลการตัดโอน';
      modalMessage.textContent = 'คุณต้องการลบข้อมูลการตัดโอนจากบัญชีนี้ใช่หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้';
    }

    // ฟังก์ชันตั้งค่าวันที่ปัจจุบันให้ฟอร์มตัดโอน
    function setCurrentDateToWithdrawForm() {
      try {
        const now = new Date();
        const currentDay = now.getDate();
        const currentMonth = now.getMonth() + 1;
        const currentYear = now.getFullYear() + 543;

        document.getElementById('withdrawDay').value = currentDay;
        document.getElementById('withdrawMonth').value = currentMonth;
        document.getElementById('withdrawYear').value = currentYear;

        setTimeout(() => {
          const withdrawDaySelect = document.getElementById('withdrawDay');
          if (withdrawDaySelect && withdrawDaySelect.value === "" && withdrawDaySelect.options.length > currentDay) {
            withdrawDaySelect.selectedIndex = currentDay;
          }
        }, 100);
      } catch (error) {
        console.error('Error setting current date to withdraw form:', error);
      }
    }









    // ฟังก์ชันโหลดรหัสการตัดโอน
    function loadWithdrawCodes() {
      showLoading();
      fetch(`${SCRIPT_URL}?action=getWithdrawCodes`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            withdrawCodes = data.data;
            const dropdown = document.getElementById('withdrawCode');

            // ล้างตัวเลือกเก่า
            while (dropdown.options.length > 1) {
              dropdown.remove(1);
            }

            withdrawCodes.forEach(code => {
              const option = document.createElement('option');
              option.value = code.code;
              option.textContent = `${code.code} - ${code.description}`;
              dropdown.appendChild(option);
            });
          } else {
            showError('ไม่สามารถโหลดรหัสการตัดโอนได้');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error loading withdraw codes:', error);
          showError('เกิดข้อผิดพลาดในการโหลดรหัสการตัดโอน');
          hideLoading();
        });
    }

  </script>
</body>

</html>