<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js" integrity="sha512-pumBsjNRGGqkPzKHndZMaAG+bir374sORyzM3uulLV14lN5LyykqNk8eEeUlUkB3U0M4FApyaHraT65ihJhDpQ==" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>

<body>
    <div class="container-fluid">
        <div class="row g-3 mt-1">
            <div class="col-12">
                <label for="id">รหัส</label>
                <input type="text" name="id" id="id" class="form-control">
            </div>
            <div class="col-12">
                <button class="btn btn-primary w-100" id="search-btn">ค้นหาด้วยรหัส</button>
            </div>
        </div>
        <div class="row g-3 mt-3" id="result-div">
            <!-- contact -->
            <div class="col-12 result">
                <label for="contact">ชื่อผู้ติดต่อ</label>
                <input type="text" name="contact" id="contact" class="form-control">
            </div>
            <!-- remark -->
            <div class="col-12 result">
                <label for="remark">หมายเหตุ</label>
                <textarea type="text" name="remark" id="remark" class="form-control" rows="4"></textarea>
            </div>
            <!-- ระยะสัญญา -->
            <div class="col-12 result">
                <label for="waranty">ระยะสัญญา</label>
                <input type="text" name="waranty" id="waranty" class="form-control">
            </div>
            <div class="col-12 result">
                <button class="btn btn-warning w-100" id="update-btn">บันทึกอัพเดท</button>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <!-- alert -->
        <div class="col-12 alert alert-warning mt-3 text-center" role="alert" id="alert-1" style="display: none;"></div>
        <!-- alert2 -->
        <div class="col-12 alert alert-info mt-3 text-center" role="alert" id="alert-2" style="display: none;"></div>
        <!-- alert3 -->
        <div class="col-12 alert alert-success mt-3 text-center" role="alert" id="alert-3" style="display: none;"></div>
        <!-- alert4 -->
        <div class="col-12 alert alert-danger mt-3 text-center" role="alert" id="alert-4" style="display: none;"></div>
    </div>
    <script>
        $('#search-btn').click(function () {
            let btn = $(this)
            btn.attr('disabled', true)
            let id = $('#id').val()
            if (id.length < 4) {
                $('#alert-1').html('<i class="bi bi-x-circle-fill"></i> กรุณากรอกรหัสให้ถูกต้อง').slideDown(200)
                $('#result-div').slideUp(200)
                btn.attr('disabled', false)
                setTimeout(() => {
                    $('#alert-1').slideUp(200)
                }, 3000);
            } else {
                $('#alert-1').hide()
                // alert กำลังค้นหา
                $('#alert-2').html('<i class="bi bi-arrow-repeat"></i> กำลังค้นหา<br><div class="progress" role="progressbar" aria-label="Animated striped example" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"><div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 100%"></div></div>').slideDown(200)
                google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                    btn.attr('disabled', false)
                    if (res.status == 'success') {
                        $('#contact').val(res.contact).removeAttr('disabled')
                        $('#remark').val(res.remark).removeAttr('disabled')
                        $('#waranty').val(res.waranty).removeAttr('disabled')
                        $('#alert-2').slideUp(200, function () {
                            $('#alert-3').html('<i class="bi bi-check-circle-fill"></i> ค้นหาสำเร็จ').slideDown(200, function () {
                                $('#result-div').slideDown(200)
                            })
                        })

                        setTimeout(() => {
                            $('#alert-3').slideUp(200)
                        }, 3000);
                    } else if (res.status == 'notfound') {
                        $('#alert-2').slideUp(100, function () {
                            $('#alert-4').html('<i class="bi bi-x-circle-fill"></i> ไม่พบข้อมูล').slideDown(200, function () {
                                // $('#result-div').slideUp(200)
                            })
                        })
                        setTimeout(() => {
                            $('#alert-4').slideUp(200)
                        }, 1500);
                    }
                }).getVenderDetail(id)
            }
        })

        $('#update-btn').click(function () {
            let btn = $(this)
            btn.attr('disabled', true)
            let id = $('#id').val()
            let contact = $('#contact').val()
            let remark = $('#remark').val()
            let waranty = $('#waranty').val()
            if (id.length < 4) {
                $('#alert-1').html('<i class="bi bi-x-circle-fill"></i> กรุณากรอกรหัสให้ถูกต้อง').slideDown(200)
                $('#result-div').slideUp(200)
                btn.attr('disabled', false)
                setTimeout(() => {
                    $('#alert-1').slideUp(200)
                }, 3000);
            } else {
                $('#alert-1').hide()
                // alert กำลังค้นหา
                $('#alert-2').html('<i class="bi bi-arrow-repeat"></i> กำลังบันทึก<br><div class="progress" role="progressbar" aria-label="Animated striped example" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"><div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 100%"></div></div>').slideDown(200)
                let ids = id.split(' ')
                let count = 0
                ids.forEach(id =>{
                    google.script.run.withFailureHandler(e => console.log(e)).withSuccessHandler(res => {
                        count++
                        btn.attr('disabled', false)
                        if (res.status == 'success') {
                            if(count == ids.length){
                                $('#alert-2').slideUp(200, function () {
                                    $('#alert-3').html('<i class="bi bi-check-circle-fill"></i> บันทึกสำเร็จ').slideDown(200)
                                })
                                setTimeout(() => {
                                    $('#alert-3').slideUp(200)
                                }, 3000);
                            }
                        } else if (res.status == 'notfound') {
                            $('#alert-2').slideUp(100, function () {
                                $('#alert-4').html('<i class="bi bi-x-circle-fill"></i> ไม่พบข้อมูล').slideDown(200)
                            })
                            setTimeout(() => {
                                $('#alert-4').slideUp(200)
                            }, 3000);
                        }
                    }).updateVenderDetail({ id, contact, remark, waranty })
                })
                
            }
        })

        // detect enter
        $('#id').keypress(function (e) {
            if (e.which == 13) {
                $('#search-btn').click()
            }
        })
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
</body>

</html>